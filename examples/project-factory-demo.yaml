# SynergyMesh Project Factory 範例規格
# Project Factory Example Specification

apiVersion: factory.synergymesh.io/v1
kind: ProjectSpec
metadata:
  name: demo-payment-service
  description: "高安全性支付處理微服務 - Project Factory 完整示範"
  version: "1.0.0"
  author: "SynergyMesh Platform Team"
  created_at: "2025-12-12"

spec:
  # 專案類型與技術棧
  type: microservice
  language: python
  framework: fastapi

  # 架構模式
  architecture:
    pattern: clean-architecture
    layers:
      - presentation    # API層
      - application     # 應用邏輯層
      - domain          # 領域模型層
      - infrastructure  # 基礎設施層

  # 功能特性
  features:
    # API 配置
    api:
      rest: true
      graphql: false
      grpc: true
      websocket: false

    # 資料庫配置
    database:
      type: postgresql
      orm: sqlalchemy
      migrations: alembic
      connection_pool_size: 10

    # 快取配置
    cache:
      type: redis
      serializer: msgpack
      ttl_seconds: 3600

    # 訊息佇列配置
    messaging:
      type: kafka
      topics:
        - payment.initiated
        - payment.processing
        - payment.completed
        - payment.failed
        - payment.refunded

    # 可觀測性配置
    observability:
      logging: structured
      log_level: info
      metrics: prometheus
      tracing: opentelemetry
      health_checks: true
      readiness_checks: true
      liveness_checks: true

  # 交付物配置
  deliverables:
    # 源代碼
    source_code: true

    # 測試套件
    tests:
      unit: true
      integration: true
      e2e: true
      coverage_threshold: 85
      pytest_plugins:
        - pytest-cov
        - pytest-asyncio
        - pytest-mock

    # Docker 配置
    docker:
      multi_stage: true
      base_image: python:3.11-slim
      healthcheck: true
      healthcheck_interval: 30s
      expose_ports:
        - 8000
        - 9090  # Prometheus metrics

    # Kubernetes 配置
    kubernetes:
      deployment: true
      service: true
      ingress: true
      hpa: true  # 水平自動擴展
      network_policy: true
      configmap: true
      secret: true

      # 資源配置
      resources:
        requests:
          memory: "256Mi"
          cpu: "250m"
        limits:
          memory: "512Mi"
          cpu: "500m"

      # HPA 配置
      autoscaling:
        min_replicas: 2
        max_replicas: 10
        target_cpu_percent: 70
        target_memory_percent: 80

    # CI/CD 配置
    ci_cd:
      platform: github-actions
      stages:
        - lint          # 代碼風格檢查
        - test          # 單元測試 + 集成測試
        - security-scan # 安全漏洞掃描
        - build         # Docker 映像構建
        - deploy-dev    # 部署到開發環境
        - deploy-prod   # 部署到生產環境

      # 部署策略
      deployment_strategy: blue-green

      # 通知配置
      notifications:
        slack: true
        email: true

    # 文檔生成
    documentation:
      api_docs: openapi
      architecture: c4-model
      readme: comprehensive
      changelog: true
      contributing: true
      security: true

  # 治理配置
  governance:
    # 合規標準
    compliance:
      - ISO-42001          # AI 管理系統
      - NIST-AI-RMF        # AI 風險管理框架
      - PCI-DSS            # 支付卡行業資料安全標準
      - GDPR               # 歐盟資料保護條例

    # 安全等級
    security_level: high

    # 審計追蹤
    audit_trail: true

    # 軟體物料清單
    sbom: true
    sbom_format: spdx-2.3

    # 供應鏈安全
    provenance: slsa-level-3

    # 授權協議
    license: MIT

    # 代碼擁有者
    codeowners:
      - "@platform-team"
      - "@security-team"

    # 安全聯絡人
    security_contact: "security@synergymesh.io"

# 依賴配置
dependencies:
  python:
    # Web 框架
    - fastapi>=0.104.0
    - uvicorn[standard]>=0.24.0
    - pydantic>=2.5.0

    # 資料庫
    - sqlalchemy>=2.0.0
    - alembic>=1.13.0
    - asyncpg>=0.29.0

    # 快取
    - redis>=5.0.0
    - msgpack>=1.0.0

    # 訊息佇列
    - aiokafka>=0.10.0

    # 可觀測性
    - prometheus-client>=0.19.0
    - opentelemetry-api>=1.21.0
    - opentelemetry-sdk>=1.21.0
    - structlog>=23.2.0

    # 測試
    - pytest>=7.4.0
    - pytest-asyncio>=0.21.0
    - pytest-cov>=4.1.0
    - httpx>=0.25.0

# 環境變數配置
environment:
  development:
    DATABASE_URL: "postgresql://dev_user:dev_pass@localhost:5432/payment_dev"
    REDIS_URL: "redis://localhost:6379/0"
    KAFKA_BOOTSTRAP_SERVERS: "localhost:9092"
    LOG_LEVEL: "DEBUG"

  staging:
    DATABASE_URL: "postgresql://staging_user:staging_pass@db.staging:5432/payment_staging"
    REDIS_URL: "redis://cache.staging:6379/0"
    KAFKA_BOOTSTRAP_SERVERS: "kafka.staging:9092"
    LOG_LEVEL: "INFO"

  production:
    DATABASE_URL: "${DATABASE_URL}"  # 從 Secret 注入
    REDIS_URL: "${REDIS_URL}"        # 從 Secret 注入
    KAFKA_BOOTSTRAP_SERVERS: "${KAFKA_BOOTSTRAP_SERVERS}"  # 從 ConfigMap 注入
    LOG_LEVEL: "WARNING"

# 生成選項
generation_options:
  # 是否生成範例代碼
  include_examples: true

  # 是否生成 seed data
  include_seed_data: true

  # 是否生成性能測試
  include_performance_tests: false

  # 是否生成 API 用戶端
  generate_api_client: true

  # API 用戶端語言
  api_client_languages:
    - python
    - typescript

  # 是否生成 Postman collection
  generate_postman_collection: true

# 元數據
metadata:
  tags:
    - payment
    - microservice
    - high-security
    - fintech

  team: "Platform Team"
  slack_channel: "#payment-service"
  repository: "https://github.com/SynergyMesh-master/demo-payment-service"

  # 專案優先級
  priority: high

  # 預計流量
  expected_qps: 1000

  # 資料敏感度
  data_sensitivity: high
