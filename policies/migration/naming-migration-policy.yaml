# 命名迁移策略
# 定义命名治理迁移的原则、阶段和风险管理要求

apiVersion: governance.machinenativeops.io/v1alpha1
kind: MigrationPolicy
metadata:
  name: naming-migration-standard
  labels:
    category: migration
    module: naming-governance

spec:
  # 迁移原则
  principles:
    - name: "渐进式迁移"
      description: "分阶段、分批次进行，避免一次性大规模变更"
      required: true

    - name: "零停机"
      description: "迁移过程中业务不中断"
      required: true

    - name: "可回滚"
      description: "每个阶段都有明确的回滚方案"
      required: true

    - name: "充分测试"
      description: "在非生产环境充分验证后再到生产"
      required: true

    - name: "监控先行"
      description: "建立完善的监控和告警后再开始迁移"
      required: true

  # 必需的迁移阶段
  mandatoryStages:
    - id: "discovery"
      name: "资产发现与盘点"
      description: "扫描并盘点所有需要迁移的资源"
      minDuration: "3d"
      requiredDeliverables:
        - "资产清单 (asset-inventory.yaml)"
        - "依赖关系图 (dependency-graph.svg)"
        - "影响分析报告 (impact-analysis.md)"
      successCriteria:
        - "资产清单完整性 > 99%"
        - "所有关键依赖已识别"
        - "风险评估已完成"

    - id: "benchmark"
      name: "制定新命名 Benchmark"
      description: "定义新的命名规范和验证规则"
      minDuration: "1w"
      requiredDeliverables:
        - "命名规范文档"
        - "验证规则配置"
        - "迁移映射表"
      successCriteria:
        - "命名规范经治理委员会批准"
        - "验证规则测试通过"

    - id: "dry-run"
      name: "Dry-run 模拟验证"
      description: "在测试环境模拟执行迁移流程"
      minDuration: "3d"
      requiredDeliverables:
        - "Dry-run 报告"
        - "冲突列表"
        - "修复计划"
      successCriteria:
        - "无 critical 冲突"
        - "所有依赖正确映射"
        - "性能测试通过"

    - id: "staged-rename"
      name: "分阶段重命名"
      description: "按批次逐步重命名资源"
      minDuration: "1w"
      requiredDeliverables:
        - "每批次执行报告"
        - "监控数据"
        - "问题追踪"
      successCriteria:
        - "每批次成功率 > 95%"
        - "无服务中断"
        - "监控指标正常"

    - id: "cutover"
      name: "正式切换"
      description: "切换流量到新命名资源"
      minDuration: "1d"
      requiredDeliverables:
        - "切换执行报告"
        - "验证报告"
      successCriteria:
        - "流量切换成功"
        - "服务可用性 > 99.9%"
        - "无数据丢失"

    - id: "rollback-plan"
      name: "回滚预案"
      description: "准备完整的回滚方案"
      minDuration: "2d"
      requiredDeliverables:
        - "回滚流程文档"
        - "回滚脚本"
        - "回滚验证计划"
      successCriteria:
        - "回滚流程测试通过"
        - "回滚时间 < 30 分钟"

  # 风险分级
  riskLevels:
    critical:
      description: "影响核心业务，可能导致服务中断"
      examples:
        - "生产数据库重命名"
        - "核心 API 端点变更"
        - "支付服务迁移"
      approvalRequired:
        - "CTO"
        - "VP Engineering"
        - "Governance Board"
      testingRequired:
        - "完整回归测试"
        - "性能测试"
        - "灾难恢复演练"
      rollbackTime: "< 15 分钟"

    high:
      description: "影响重要功能，可能影响用户体验"
      examples:
        - "认证服务重命名"
        - "消息队列迁移"
      approvalRequired:
        - "Engineering Manager"
        - "SRE Lead"
      testingRequired:
        - "集成测试"
        - "负载测试"
      rollbackTime: "< 30 分钟"

    medium:
      description: "影响非核心功能"
      examples:
        - "日志服务重命名"
        - "监控配置更新"
      approvalRequired:
        - "Team Lead"
      testingRequired:
        - "功能测试"
      rollbackTime: "< 1 小时"

    low:
      description: "影响最小，可快速恢复"
      examples:
        - "开发环境资源"
        - "测试数据"
      approvalRequired:
        - "自动批准"
      testingRequired:
        - "基础验证"
      rollbackTime: "< 2 小时"

  # 迁移批次策略
  batchStrategy:
    sizing:
      maxResourcesPerBatch: 100
      maxNamespacesPerBatch: 5
      cooldownPeriod: "24h"

    ordering:
      - "先非生产后生产"
      - "先低依赖后高依赖"
      - "先小规模后大规模"

    validation:
      beforeBatch:
        - "健康检查"
        - "依赖验证"
        - "备份确认"
      afterBatch:
        - "功能验证"
        - "性能验证"
        - "监控确认"
      stabilizationPeriod: "2h"

  # 回滚策略
  rollback:
    automaticTriggers:
      - condition: "错误率 > 5%"
        duration: "5m"
      - condition: "可用性 < 99%"
        duration: "2m"
      - condition: "响应时间 > P99 2x"
        duration: "10m"

    manualTriggers:
      - "数据不一致"
      - "关键功能失效"
      - "安全问题发现"

    procedures:
      - step: 1
        name: "停止迁移"
        script: "tools/governance/bash/stop_migration.sh"
        timeout: "1m"

      - step: 2
        name: "恢复资源命名"
        script: "tools/governance/bash/restore_names.sh"
        timeout: "10m"

      - step: 3
        name: "恢复 DNS 配置"
        script: "tools/governance/bash/restore_dns.sh"
        timeout: "5m"

      - step: 4
        name: "恢复服务路由"
        script: "tools/governance/bash/restore_service.sh"
        timeout: "5m"

      - step: 5
        name: "验证回滚"
        script: "tools/governance/bash/verify_rollback.sh"
        timeout: "10m"

    testing:
      required: true
      frequency: "每月"
      environment: "staging"

  # 沟通要求
  communication:
    stakeholders:
      - role: "Engineering Teams"
        notificationTiming: "7 天前"
        channels: ["email", "slack"]

      - role: "Product Teams"
        notificationTiming: "3 天前"
        channels: ["email"]

      - role: "Customer Support"
        notificationTiming: "1 天前"
        channels: ["email", "training-session"]

      - role: "End Users"
        notificationTiming: "4 小时前"
        channels: ["status-page"]

    updates:
      during: "每 2 小时"
      postMigration: "24 小时后"

    escalation:
      - level: 1
        role: "SRE On-call"
        responseTime: "15 分钟"

      - level: 2
        role: "Engineering Manager"
        responseTime: "30 分钟"

      - level: 3
        role: "VP Engineering"
        responseTime: "1 小时"

  # 验收标准
  acceptance:
    mandatory:
      - "命名合规率 > 99%"
      - "服务可用性 > 99.9%"
      - "无数据丢失"
      - "性能指标在基线范围内"
      - "所有监控正常"

    optional:
      - "用户投诉 < 基线 10%"
      - "支持票数量无显著增加"

  # 文档要求
  documentation:
    required:
      - "迁移计划"
      - "风险评估"
      - "回滚方案"
      - "执行手册"
      - "验证清单"
      - "事后总结"

    templates:
      - "templates/playbooks/migration-discovery.template.yaml"
      - "templates/playbooks/migration-dryrun.template.yaml"
      - "templates/playbooks/migration-staged-rename.template.yaml"
      - "templates/playbooks/migration-rollback.template.yaml"

  # 工具要求
  tools:
    required:
      - name: "资产发现工具"
        path: "tools/governance/bash/discover_assets.sh"

      - name: "命名验证工具"
        path: "tools/governance/python/validate_naming.py"

      - name: "迁移执行工具"
        path: "tools/governance/python/execute_migration.py"

      - name: "回滚工具"
        path: "tools/governance/bash/rollback_migration.sh"

  # 审计要求
  audit:
    logging:
      enabled: true
      level: "detailed"
      retention: "1 年"

    tracking:
      - "所有迁移操作"
      - "批准记录"
      - "变更历史"
      - "回滚事件"

    reporting:
      frequency: "每阶段完成后"
      recipients:
        - "governance-team@example.com"
        - "audit-team@example.com"
