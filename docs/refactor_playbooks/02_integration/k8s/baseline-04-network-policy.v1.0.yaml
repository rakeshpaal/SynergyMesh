---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: baseline-default-deny-all
  namespace: intelligent-hyperautomation-baseline
  labels:
    baseline.level: L-A
    baseline.version: v1.0.0
    baseline.type: network-security
    baseline.dependency: namespace-governance,security-rbac,resource-management
  annotations:
    baseline.io/description: "網路策略基線 / Network Policy Foundation"
    baseline.io/purpose: "建立零信任網路架構與微分段 / Establish Zero Trust network architecture and microsegmentation"
    baseline.io/capability-scope: "ingress-control,egress-control,service-mesh-integration"
    baseline.io/conflict-priority: "850"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: baseline-allow-same-namespace
  namespace: intelligent-hyperautomation-baseline
  labels:
    baseline.component: intra-namespace-communication
  annotations:
    baseline.io/description: "允許同命名空間內通訊 / Allow intra-namespace communication"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector: {}
  egress:
    - to:
        - podSelector: {}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: baseline-allow-dns
  namespace: intelligent-hyperautomation-baseline
  labels:
    baseline.component: dns-resolution
  annotations:
    baseline.io/description: "允許 DNS 解析 / Allow DNS resolution"
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: baseline-api-gateway-ingress
  namespace: intelligent-hyperautomation-baseline
  labels:
    baseline.component: api-gateway
  annotations:
    baseline.io/description: "API 閘道入口控制 / API gateway ingress control"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: api-gateway
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: istio-system
        - podSelector:
            matchLabels:
              app: istio-ingressgateway
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8443
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: network-segmentation-policy
  namespace: intelligent-hyperautomation-baseline
  labels:
    baseline.component: network-segmentation
data:
  microsegmentation-rules.yaml: |
    version: v1.0.0
    segmentation_zones:
      dmz_zone:
        description: "DMZ 區域，面向外部流量 / DMZ zone for external-facing traffic"
        labels:
          network.zone: "dmz"
        allowed_ingress:
          - source: "internet"
            ports:
              - 80
              - 443
          - source: "cdn"
            ports:
              - 443
        allowed_egress:
          - destination: "application-zone"
            ports:
              - 8080
              - 9090
        monitoring:
          deep_packet_inspection: true
          threat_detection: true
      application_zone:
        description: "應用程式區域 / Application zone"
        labels:
          network.zone: "application"
        allowed_ingress:
          - source: "dmz-zone"
            ports:
              - 8080
              - 9090
          - source: "internal-services"
            authentication_required: true
        allowed_egress:
          - destination: "data-zone"
            ports:
              - 5432
              - 3306
              - 6379
          - destination: "external-apis"
            ports:
              - 443
            rate_limit: true
      data_zone:
        description: "資料區域，最高安全等級 / Data zone, highest security level"
        labels:
          network.zone: "data"
        allowed_ingress:
          - source: "application-zone"
            authentication_required: true
            encryption_required: true
            audit_all_connections: true
        allowed_egress:
          - destination: "backup-storage"
            ports:
              - 443
            encryption_required: true
        protection:
          ddos_mitigation: true
          waf_enabled: true
          rate_limiting: true
      management_zone:
        description: "管理區域，運維存取 / Management zone for operations access"
        labels:
          network.zone: "management"
        allowed_ingress:
          - source: "bastion-hosts"
            mfa_required: true
            source_ip_allowlist: true
        allowed_egress:
          - destination: "all-zones"
            ports:
              - 22
              - 3389
            session_recording: true
  service-mesh-policy.yaml: |
    version: v1.0.0
    service_mesh:
      provider: "istio"
      mtls_mode: "STRICT"
      traffic_management:
        circuit_breaking:
          enabled: true
          max_connections: 1000
          max_pending_requests: 1000
          max_requests_per_connection: 100
          consecutive_errors: 5
        retry_policy:
          attempts: 3
          per_try_timeout: "2s"
          retry_on: "5xx,reset,connect-failure,refused-stream"
        timeout:
          default: "10s"
          idle: "300s"
        load_balancing:
          algorithm: "LEAST_REQUEST"
          locality_lb_setting:
            enabled: true
            failover:
              - from: "us-east-1a"
                to: "us-east-1b"
      authorization_policies:
        default_action: "DENY"
        allow_rules:
          - name: "allow-frontend-to-backend"
            source:
              principals:
                - "cluster.local/ns/default/sa/frontend"
            destination:
              methods:
                - "GET"
                - "POST"
              paths:
                - "/api/v1/*"
          - name: "allow-backend-to-database"
            source:
              principals:
                - "cluster.local/ns/default/sa/backend"
            destination:
              ports:
                - "5432"
            when:
              - key: "request.auth.claims[iss]"
                values:
                  - "https://idp.example.com"
      observability:
        tracing:
          enabled: true
          sampling_rate: "1.0"
          zipkin_address: "zipkin.istio-system:9411"
        metrics:
          enabled: true
          prometheus_integration: true
        access_logging:
          enabled: true
          format: "json"
          providers:
            - "stdout"
            - "fluentd"
  ingress-gateway-config.yaml: |
    version: v1.0.0
    ingress_gateways:
      public_gateway:
        hosts:
          - "*.example.com"
        tls:
          mode: "SIMPLE"
          credential_name: "example-com-cert"
          min_protocol_version: "TLSV1_3"
          cipher_suites:
            - "ECDHE-RSA-AES256-GCM-SHA384"
            - "ECDHE-RSA-CHACHA20-POLY1305"
        rate_limiting:
          enabled: true
          requests_per_second: 1000
          burst: 2000
          key: "remote_address"
        waf:
          enabled: true
          ruleset: "owasp-crs-3.3"
          paranoia_level: 2
          blocking_mode: true
        cors:
          enabled: true
          allowed_origins:
            - "https://app.example.com"
          allowed_methods:
            - "GET"
            - "POST"
            - "PUT"
            - "DELETE"
          allowed_headers:
            - "content-type"
            - "authorization"
          max_age: "24h"
      private_gateway:
        hosts:
          - "*.internal.example.com"
        tls:
          mode: "MUTUAL"
          credential_name: "internal-mtls-cert"
          ca_certificates: "internal-ca-bundle"
        source_ip_allowlist:
          - "10.0.0.0/8"
          - "172.16.0.0/12"
        authentication:
          jwt:
            issuer: "https://internal-idp.example.com"
            audiences:
              - "internal-services"
            jwks_uri: "https://internal-idp.example.com/.well-known/jwks.json"
  egress-control-policy.yaml: |
    version: v1.0.0
    egress_policies:
      allow_external_apis:
        description: "允許存取外部 API / Allow access to external APIs"
        destinations:
          - host: "api.stripe.com"
            ports:
              - 443
            protocols:
              - "TLS"
          - host: "api.twilio.com"
            ports:
              - 443
          - host: "*.googleapis.com"
            ports:
              - 443
        monitoring:
          log_all_connections: true
          alert_on_new_destinations: true
      block_suspicious_destinations:
        description: "封鎖可疑目的地 / Block suspicious destinations"
        blocked_cidrs:
          - "0.0.0.0/8"
          - "10.0.0.0/8"
          - "169.254.0.0/16"
          - "192.168.0.0/16"
        blocked_ports:
          - 25
          - 445
          - 3389
        action: "reject"
        alert: "critical"
      database_egress:
        description: "資料庫出口控制 / Database egress control"
        source_labels:
          app.kubernetes.io/component: "backend"
        destinations:
          - host: "postgresql.data-zone.svc.cluster.local"
            ports:
              - 5432
          - host: "redis.data-zone.svc.cluster.local"
            ports:
              - 6379
        connection_pooling:
          enabled: true
          max_connections: 100
          idle_timeout: "300s"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: network-observability-config
  namespace: intelligent-hyperautomation-baseline
  labels:
    baseline.component: network-observability
data:
  flow-monitoring.yaml: |
    version: v1.0.0
    flow_monitoring:
      collector: "elastic-flow"
      sampling_rate: "1:100"
      export_interval_seconds: 60
      metrics:
        - "bytes_sent"
        - "bytes_received"
        - "packets_sent"
        - "packets_received"
        - "connection_duration"
        - "retransmits"
      aggregation:
        - "source_ip"
        - "destination_ip"
        - "source_port"
        - "destination_port"
        - "protocol"
    anomaly_detection:
      enabled: true
      baseline_learning_days: 7
      sensitivity: "medium"
      alert_thresholds:
        sudden_traffic_spike: "300"
        unusual_port_usage: true
        connection_to_suspicious_ip: true
        data_exfiltration_pattern: true
