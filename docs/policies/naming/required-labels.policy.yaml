apiVersion: machinenativeops.io/v2
examples:
- description: 合規的 Namespace
  expected: PASS
  resource:
    apiVersion: machinenativeops.io/v2
    kind: Namespace
    metadata:
      labels:
        app.kubernetes.io/managed-by: helm
        environment: prod
        team: frontend-team
        tenant: platform-team
      name: team-frontend-prod
- description: 缺少 environment 標籤
  expected: FAIL
  resource:
    apiVersion: machinenativeops.io/v2
    kind: Namespace
    metadata:
      labels:
        tenant: platform-team
      name: team-frontend-prod
  violation: LABEL-001
- description: environment 標籤值不合法
  expected: FAIL
  resource:
    apiVersion: machinenativeops.io/v2
    kind: Namespace
    metadata:
      labels:
        environment: production
        tenant: platform-team
      name: team-frontend-prod
  violation: environment label value invalid
- description: 合規的 Deployment
  expected: PASS
  resource:
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      labels:
        app.kubernetes.io/managed-by: helm
        app.kubernetes.io/name: frontend-api
        app.kubernetes.io/version: v1.2.3
        environment: prod
        team: frontend-team
      name: frontend-api
      namespace: team-frontend-prod
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: frontend-api
- description: 系統命名空間豁免
  expected: PASS
  reason: 系統命名空間在豁免列表中
  resource:
    apiVersion: machinenativeops.io/v2
    kind: Namespace
    metadata:
      name: kube-system
kind: LabelPolicy
maintenance:
  changelog: canonical/CHANGELOG.md
  contact: governance-team@example.com
  last_updated: '2025-01-15'
  next_review: '2025-04-15'
  owner: Platform Engineering Team
  version: v1.0
metadata:
  annotations:
    machinenativeops.io/description: 強制要求的標籤策略
    machinenativeops.io/generated: 'false'
    machinenativeops.io/source: canonical/machine-spec.yaml
  labels:
    machinenativeops.io/category: naming
    machinenativeops.io/enforcement: strict
    machinenativeops.io/module: canonical-naming
  name: required-labels-policy
spec:
  audit:
    enabled: true
    fields:
    - timestamp
    - resource_type
    - resource_name
    - namespace
    - missing_labels
    - invalid_labels
    - severity
    log_level: info
    retention: 90d
  auto_labeling:
    description: 自動為資源添加標籤
    enabled: false
    rules:
    - add_labels:
        environment: prod
      condition: namespace matches 'team-.*-prod'
    - add_labels:
        environment: staging
      condition: namespace matches 'team-.*-staging'
    - add_labels:
        environment: dev
      condition: namespace matches 'team-.*-dev'
  enforcement:
    by_environment:
      dev:
        enforce_critical: false
        enforce_high: false
        enforce_medium: false
      production:
        enforce_critical: true
        enforce_high: true
        enforce_medium: true
      staging:
        enforce_critical: true
        enforce_high: true
        enforce_medium: false
    by_severity:
      critical:
        action: deny
        notify: true
      high:
        action: warn
        notify: true
      low:
        action: log
        notify: false
      medium:
        action: log
        notify: false
    mode: enforce
  inheritance:
    description: 子資源自動繼承父資源的特定標籤
    enabled: true
    rules:
    - from: Namespace
      labels:
      - environment
      - tenant
      - team
      to:
      - Deployment
      - StatefulSet
      - DaemonSet
      - Service
      - Ingress
    - from: Deployment
      labels:
      - environment
      - app.kubernetes.io/name
      - app.kubernetes.io/version
      to:
      - Pod
  recommended_labels:
  - description: 成本中心代碼
    example: CC-1234
    key: cost-center
    validation:
      regex: ^CC-[0-9]{4}$
      type: regex
  - description: 資源擁有者（郵箱）
    example: team@example.com
    key: owner
    validation:
      regex: ^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$
      type: regex
  - description: 所屬項目
    example: ecommerce-platform
    key: project
    validation:
      regex: ^[a-z0-9-]{2,32}$
      type: regex
  reporting:
    prometheus:
      enabled: true
      metrics:
      - description: 標籤合規率
        name: label_compliance_rate
        type: gauge
      - description: 缺少標籤的資源數量
        name: missing_labels_count
        type: counter
    slack:
      channel: '#label-violations'
      enabled: true
      notify_on:
      - critical
      - high
  required_labels:
  - description: 部署環境標識（dev/test/staging/prod/learn）
    error_message: 缺少必需標籤 'environment' 或值不合法
    exemptions:
    - kube-system
    - kube-public
    - kube-node-lease
    - default
    key: environment
    remediation: "添加標籤:\n  environment: dev|test|staging|prod|learn\n"
    required_for:
    - Namespace
    - Deployment
    - StatefulSet
    - DaemonSet
    - Service
    severity: critical
    validation:
      allowed_values:
      - dev
      - test
      - staging
      - prod
      - learn
      regex: ^(dev|test|staging|prod|learn)$
      type: allow_list
  - description: 租戶標識，用於資源隔離和成本分配
    error_message: 缺少必需標籤 'tenant' 或格式不正確
    exemptions:
    - kube-system
    - kube-public
    - kube-node-lease
    - default
    key: tenant
    remediation: "添加標籤:\n  tenant: <your-tenant-name>\n格式要求: 2-32 字符，小寫字母、數字和破折號\n"
    required_for:
    - Namespace
    severity: critical
    validation:
      regex: ^[a-z0-9-]{2,32}$
      type: regex
  - description: 應用名稱（Kubernetes 推薦標籤）
    error_message: 缺少推薦標籤 'app.kubernetes.io/name'
    key: app.kubernetes.io/name
    remediation: "添加標籤:\n  app.kubernetes.io/name: <app-name>\n"
    required_for:
    - Deployment
    - StatefulSet
    - DaemonSet
    - Service
    severity: high
    validation:
      regex: ^[a-z0-9-]{2,63}$
      type: regex
  - description: 管理此資源的工具（helm/kubectl/terraform/argocd/flux）
    error_message: 缺少推薦標籤 'app.kubernetes.io/managed-by'
    key: app.kubernetes.io/managed-by
    remediation: "添加標籤:\n  app.kubernetes.io/managed-by: helm|kubectl|terraform|argocd|flux\n"
    required_for:
    - Namespace
    - Deployment
    - StatefulSet
    - Service
    severity: medium
    validation:
      allowed_values:
      - helm
      - kubectl
      - terraform
      - argocd
      - flux
      - kustomize
      regex: ^(helm|kubectl|terraform|argocd|flux|kustomize)$
      type: allow_list
  - description: 負責此資源的團隊
    error_message: 缺少推薦標籤 'team'
    key: team
    remediation: "添加標籤:\n  team: <team-name>\n"
    required_for:
    - Namespace
    - Deployment
    - StatefulSet
    severity: medium
    validation:
      regex: ^[a-z0-9-]{2,32}$
      type: regex
  - description: 應用版本（建議使用語義版本）
    error_message: 標籤 'app.kubernetes.io/version' 格式不正確
    key: app.kubernetes.io/version
    optional: true
    remediation: "添加標籤:\n  app.kubernetes.io/version: v1.2.3\n"
    required_for:
    - Deployment
    - StatefulSet
    severity: low
    validation:
      regex: ^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-z0-9-]+)?$
      type: regex
  - description: 應用組件類型（frontend/backend/database/cache）
    error_message: 標籤 'app.kubernetes.io/component' 值不在允許列表中
    key: app.kubernetes.io/component
    optional: true
    remediation: "添加標籤:\n  app.kubernetes.io/component: frontend|backend|database|...\n"
    required_for:
    - Deployment
    - StatefulSet
    severity: low
    validation:
      allowed_values:
      - frontend
      - backend
      - api
      - database
      - cache
      - queue
      - worker
      - scheduler
      regex: ^(frontend|backend|api|database|cache|queue|worker|scheduler)$
      type: allow_list
  scope:
    resourceTypes:
    - Namespace
    - Deployment
    - StatefulSet
    - DaemonSet
    - Service
    - Ingress
    - ConfigMap
    - Secret
    - PersistentVolumeClaim
    - HorizontalPodAutoscaler
  tooling:
    conftest:
      enabled: true
      policy_file: templates/conftest/labels.rego
    gatekeeper:
      constraint_template: policies/gatekeeper/required-labels-constraint.yaml
      enabled: true
    kyverno:
      enabled: false
      policy_file: policies/kyverno/label-policy.yaml
  validation_rules:
  - error_message: Namespace 缺少必需標籤
    id: LABEL-001
    name: Namespace Required Labels
    required_labels:
    - environment
    - tenant
    resource_type: Namespace
    severity: critical
  - error_message: Deployment 缺少必需標籤
    id: LABEL-002
    name: Deployment Required Labels
    required_labels:
    - environment
    - app.kubernetes.io/name
    - app.kubernetes.io/managed-by
    resource_type: Deployment
    severity: high
  - error_message: Service 缺少必需標籤
    id: LABEL-003
    name: Service Required Labels
    required_labels:
    - environment
    - app.kubernetes.io/name
    resource_type: Service
    severity: high
  - description: 驗證標籤值符合規定格式
    id: LABEL-004
    name: Label Value Validation
    resource_type: all
    severity: high
testing:
  commands:
  - command: conftest test manifests/ --policy templates/conftest/labels.rego
    description: 驗證標籤合規性
  - command: kubectl get namespaces -o json | jq '.items[] | select(.metadata.labels.environment
      == null) | .metadata.name'
    description: 查找缺少 environment 標籤的 Namespace
  - command: python tools/governance/python/check_required_labels.sh --all-namespaces
    description: 批量檢查標籤合規性
