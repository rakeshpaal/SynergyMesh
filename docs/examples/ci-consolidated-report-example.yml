name: Example CI with Consolidated Report
true:
  pull_request:
    branches:
    - main
    - develop
  push:
    branches:
    - main
    - develop
permissions:
  contents: read
  issues: write
  pull-requests: write
jobs:
  build:
    name: ðŸ—ï¸ å»ºç½®
    outputs:
      summary: ${{ steps.summary.outputs.text }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        cache: npm
        node-version: '20'
    - continue-on-error: true
      id: install
      name: Install dependencies
      run: npm ci
    - continue-on-error: true
      id: build
      name: Build project
      run: npm run build
    - id: summary
      if: always()
      name: Create summary
      run: "STATUS=\"success\"\nMESSAGE=\"å»ºç½®: é€šéŽ\"\n\nif [ \"${{ steps.install.outcome\
        \ }}\" != \"success\" ]; then\n  STATUS=\"failure\"\n  MESSAGE=\"ä¾è³´å®‰è£å¤±æ•—\"\n\
        elif [ \"${{ steps.build.outcome }}\" != \"success\" ]; then\n  STATUS=\"\
        failure\"\n  MESSAGE=\"å»ºç½®å¤±æ•—\"\nfi\n\necho \"text={\\\"status\\\":\\\"$STATUS\\\
        \",\\\"message\\\":\\\"$MESSAGE\\\"}\" >> $GITHUB_OUTPUT\n"
  lint:
    name: ðŸ” ä»£ç¢¼æª¢æŸ¥
    needs: build
    outputs:
      summary: ${{ steps.summary.outputs.text }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        cache: npm
        node-version: '20'
    - name: Install dependencies
      run: npm ci
    - continue-on-error: true
      id: lint
      name: Run linter
      run: npm run lint
    - id: summary
      if: always()
      name: Create summary
      run: "STATUS=\"success\"\nMESSAGE=\"Lint: é€šéŽ\"\n\nif [ \"${{ steps.lint.outcome\
        \ }}\" != \"success\" ]; then\n  STATUS=\"warning\"\n  MESSAGE=\"Lint æœ‰è­¦å‘Š\"\
        \nfi\n\necho \"text={\\\"status\\\":\\\"$STATUS\\\",\\\"message\\\":\\\"$MESSAGE\\\
        \"}\" >> $GITHUB_OUTPUT\n"
  report:
    if: always()
    name: ðŸ“Š æ•´åˆå ±å‘Š
    needs:
    - build
    - test
    - lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - id: prepare
      name: Prepare job summaries
      run: "# Build JSON with all job summaries\ncat > job-summaries.json <<EOF\n\
        {\n  \"build\": ${{ needs.build.outputs.summary || '{\"status\":\"unknown\"\
        ,\"message\":\"ç„¡æ‘˜è¦\"}' }},\n  \"test\": ${{ needs.test.outputs.summary ||\
        \ '{\"status\":\"unknown\",\"message\":\"ç„¡æ‘˜è¦\"}' }},\n  \"lint\": ${{ needs.lint.outputs.summary\
        \ || '{\"status\":\"unknown\",\"message\":\"ç„¡æ‘˜è¦\"}' }}\n}\nEOF\n\ncat job-summaries.json\n\
        \n# Determine overall status\nOVERALL_STATUS=\"success\"\nif [ \"${{ needs.build.result\
        \ }}\" == \"failure\" ] || \\\n   [ \"${{ needs.test.result }}\" == \"failure\"\
        \ ] || \\\n   [ \"${{ needs.lint.result }}\" == \"failure\" ]; then\n  OVERALL_STATUS=\"\
        failure\"\nelif [ \"${{ needs.lint.result }}\" == \"success\" ] && \\\n  \
        \   [ \"${{ needs.test.result }}\" == \"success\" ] && \\\n     [ \"${{ needs.build.result\
        \ }}\" == \"success\" ]; then\n  OVERALL_STATUS=\"success\"\nelse\n  OVERALL_STATUS=\"\
        warning\"\nfi\n\necho \"overall-status=$OVERALL_STATUS\" >> $GITHUB_OUTPUT\n\
        echo \"job-summaries=$(cat job-summaries.json | jq -c .)\" >> $GITHUB_OUTPUT\n"
    - if: github.event_name == 'pull_request'
      name: Call consolidated report workflow
      secrets:
        token: ${{ secrets.GITHUB_TOKEN }}
      uses: ./.github/workflows/ci-consolidated-report.yml
      with:
        ci-name: Example CI Pipeline
        commit-sha: ${{ github.sha }}
        job-summaries: ${{ steps.prepare.outputs.job-summaries }}
        overall-status: ${{ steps.prepare.outputs.overall-status }}
        pr-number: ${{ github.event.pull_request.number }}
        workflow-run-id: ${{ github.run_id }}
    - name: Summary
      run: 'echo "## ðŸ“Š CI åŸ·è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "- **Build**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY

        echo "- **Test**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY

        echo "- **Lint**: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "**Overall Status**: ${{ steps.prepare.outputs.overall-status }}" >>
        $GITHUB_STEP_SUMMARY

        '
  test:
    name: ðŸ§ª æ¸¬è©¦
    needs: build
    outputs:
      summary: ${{ steps.summary.outputs.text }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        cache: npm
        node-version: '20'
    - name: Install dependencies
      run: npm ci
    - continue-on-error: true
      id: test
      name: Run tests
      run: npm test
    - id: summary
      if: always()
      name: Create summary
      run: "STATUS=\"success\"\nMESSAGE=\"æ¸¬è©¦: é€šéŽ\"\n\nif [ \"${{ steps.test.outcome\
        \ }}\" != \"success\" ]; then\n  STATUS=\"failure\"\n  MESSAGE=\"æ¸¬è©¦å¤±æ•—\"\n\
        fi\n\necho \"text={\\\"status\\\":\\\"$STATUS\\\",\\\"message\\\":\\\"$MESSAGE\\\
        \"}\" >> $GITHUB_OUTPUT\n"
