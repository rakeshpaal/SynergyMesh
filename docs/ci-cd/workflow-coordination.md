# GitHub Workflows å”èª¿ç­–ç•¥

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æª”èªªæ˜ Unmanned Island ç³»çµ±çš„ GitHub Actions å·¥ä½œæµç¨‹æ¶æ§‹å’Œå”èª¿ç­–ç•¥ï¼Œä»¥å„ªåŒ– CI/CD æ•ˆç‡ä¸¦é™ä½æˆæœ¬ã€‚

## ğŸ¯ å·¥ä½œæµç¨‹å±¤ç´š

### ç¬¬ä¸€å±¤ï¼šåŸºç¤ CIï¼ˆå¿«é€Ÿåé¥‹ï¼‰

**å·¥ä½œæµç¨‹**: `monorepo-dispatch.yml`

**ç›®çš„**: ç‚ºæ¯å€‹æœå‹™è®Šæ›´æä¾›å¿«é€Ÿçš„åŸºæœ¬ CI æª¢æŸ¥

**è§¸ç™¼æ¢ä»¶**:
- æ¯æ¬¡ push æˆ– PR å½±éŸ¿ `mcp-servers/**` æˆ– `core/contract_service/contracts-L1/contracts/**`

**åŸ·è¡Œå…§å®¹**:
- âœ… Lint æª¢æŸ¥
- âœ… å‹åˆ¥æª¢æŸ¥
- âœ… å–®å…ƒæ¸¬è©¦
- âœ… å»ºç½®é©—è­‰
- â­ï¸ è·³é Docker å»ºç½®ï¼ˆæé«˜é€Ÿåº¦ï¼‰
- âœ… SBOM ç”Ÿæˆ

**åŸ·è¡Œæ™‚é–“**: ~5-8 åˆ†é˜

**ä½¿ç”¨å ´æ™¯**:
- é–‹ç™¼éç¨‹ä¸­çš„å¿«é€Ÿåé¥‹
- é©—è­‰åŸºæœ¬ä»£ç¢¼å“è³ª
- PR çš„åˆæ­¥æª¢æŸ¥

### ç¬¬äºŒå±¤ï¼šæ ¸å¿ƒæœå‹™ CIï¼ˆDocker é©—è­‰ï¼‰

**å·¥ä½œæµç¨‹**: `core-services-ci.yml`

**ç›®çš„**: åŒ…å« Docker å»ºç½®çš„å…¨é¢ CI æª¢æŸ¥

**è§¸ç™¼æ¢ä»¶**:
- push æˆ– PR å½±éŸ¿æ ¸å¿ƒæœå‹™è·¯å¾‘
- æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)

**åŸ·è¡Œå…§å®¹**:
- âœ… å®Œæ•´çš„ CI æª¢æŸ¥ï¼ˆlintã€testã€buildï¼‰
- âœ… Docker æ˜ åƒå»ºç½®
- âœ… Docker æ˜ åƒé©—è­‰
- â­ï¸ è·³éå®‰å…¨æƒæï¼ˆåœ¨ç¬¬ä¸‰å±¤åŸ·è¡Œï¼‰

**åŸ·è¡Œæ™‚é–“**: ~10-15 åˆ†é˜

**ä½¿ç”¨å ´æ™¯**:
- é©—è­‰ Docker å»ºç½®ä¸æœƒå¤±æ•—
- æª¢æŸ¥å®¹å™¨åŒ–é…ç½®
- åˆä½µå‰çš„ Docker ç›¸é—œè®Šæ›´é©—è­‰

### ç¬¬ä¸‰å±¤ï¼šå®Œæ•´æ•´åˆæ¸¬è©¦ï¼ˆå…¨é¢é©—è­‰ï¼‰

**å·¥ä½œæµç¨‹**: `integration-deployment.yml`

**ç›®çš„**: è·¨æ‰€æœ‰å±¤ç´šçš„å®Œæ•´ç³»çµ±æ•´åˆæ¸¬è©¦å’Œéƒ¨ç½²æº–å‚™é©—è­‰

**è§¸ç™¼æ¢ä»¶**:
- æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)
- PR æ¨™è¨˜ `ci:integration` æ¨™ç±¤
- Release åˆ†æ”¯çš„ push

**åŸ·è¡Œå…§å®¹**:
- âœ… æ‰€æœ‰å››å€‹å±¤ç´šçš„å®Œæ•´æ¸¬è©¦
  - Tier 1: Contracts L1 Service
  - Tier 2: MCP Servers
  - Tier 3: Auto-Fix Bot System
  - Tier 4: Dashboard
- âœ… Docker å»ºç½®ä¸¦åŸ·è¡Œå¥åº·æª¢æŸ¥
- âœ… å®‰å…¨æƒæ
- âœ… Docker Compose é©—è­‰
- âœ… ç”Ÿç”¢å°±ç·’å ±å‘Š
- âœ… äº’å‹•å¼å®¢æœæ•´åˆ

**åŸ·è¡Œæ™‚é–“**: ~25-35 åˆ†é˜

**ä½¿ç”¨å ´æ™¯**:
- åˆä½µåˆ° main å‰çš„æœ€çµ‚é©—è­‰
- Release æº–å‚™æª¢æŸ¥
- éƒ¨ç½²å‰çš„å®Œæ•´ç³»çµ±é©—è­‰

## ğŸ”„ å·¥ä½œæµç¨‹å”èª¿

```mermaid
graph TD
    A[ä»£ç¢¼è®Šæ›´] --> B{è®Šæ›´ç¯„åœ}
    B -->|åŸºæœ¬ä»£ç¢¼| C[monorepo-dispatch.yml]
    B -->|Dockerç›¸é—œ| D[core-services-ci.yml]
    B -->|å®Œæ•´æ•´åˆ| E[integration-deployment.yml]
    
    C --> F[å¿«é€Ÿåé¥‹ ~5min]
    D --> G[Dockeré©—è­‰ ~10min]
    E --> H[å®Œæ•´é©—è­‰ ~30min]
    
    F --> I{é€šé?}
    G --> I
    H --> I
    
    I -->|æ˜¯| J[åˆä½µ/éƒ¨ç½²]
    I -->|å¦| K[ä¿®å¾©å•é¡Œ]
    K --> A
```

## ğŸ“Š æˆæœ¬å„ªåŒ–ç­–ç•¥

### 1. è·¯å¾‘éæ¿¾

æ‰€æœ‰å·¥ä½œæµç¨‹ä½¿ç”¨ `paths` éæ¿¾å™¨ï¼Œåªåœ¨ç›¸é—œæ–‡ä»¶è®Šæ›´æ™‚åŸ·è¡Œï¼š

```yaml
on:
  push:
    paths:
      - 'mcp-servers/**'
      - 'core/contract_service/**'
```

### 2. ä¸¦ç™¼æ§åˆ¶

ä½¿ç”¨ `concurrency` é˜²æ­¢åŒä¸€åˆ†æ”¯çš„é‡è¤‡é‹è¡Œï¼š

```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```

### 3. è¶…æ™‚ä¿è­·

æ‰€æœ‰ä½œæ¥­è¨­ç½®åˆç†çš„ `timeout-minutes` é˜²æ­¢å¤±æ§æˆæœ¬ï¼š

```yaml
jobs:
  my-job:
    timeout-minutes: 10
```

### 4. æ¢ä»¶æ€§åŸ·è¡Œ

é‡é‡ç´šå·¥ä½œæµç¨‹ä½¿ç”¨å•Ÿå‹•é–˜é–€ (activation gate)ï¼š

```yaml
jobs:
  activation-gate:
    # æ±ºå®šæ˜¯å¦åŸ·è¡Œé‡é‡ç´šä½œæ¥­
  
  heavy-job:
    needs: activation-gate
    if: needs.activation-gate.outputs['run-heavy'] == 'true'
```

## ğŸ”§ å¯é‡ç”¨å·¥ä½œæµç¨‹

### `reusable-ci.yml`

çµ±ä¸€çš„ CI ç®¡é“ï¼Œæ”¯æ´ï¼š
- è‡ªå‹•æª¢æ¸¬å°ˆæ¡ˆçµæ§‹
- å¯é…ç½®çš„æ¸¬è©¦å’Œå»ºç½®
- è‡ªå®šç¾©è…³æœ¬åŸ·è¡Œ
- SBOM ç”Ÿæˆ
- å®‰å…¨æƒæ

**ä½¿ç”¨ç¯„ä¾‹**:
```yaml
jobs:
  ci:
    uses: ./.github/workflows/reusable-ci.yml
    with:
      working-directory: mcp-servers
      service-name: mcp-servers
      node-version: '18'
      custom-scripts: 'validate:deployment,validate:logic'
```

### `reusable-docker-build.yml`

çµ±ä¸€çš„ Docker å»ºç½®ç®¡é“ï¼Œæ”¯æ´ï¼š
- Docker æ˜ åƒå»ºç½®å’Œå¿«å–
- å¥åº·æª¢æŸ¥é©—è­‰
- å®‰å…¨æƒæ (Trivy)
- æ¨é€åˆ°è¨»å†Šè¡¨
- è‡ªå‹•æ¨™ç±¤ç”Ÿæˆ

**ä½¿ç”¨ç¯„ä¾‹**:
```yaml
jobs:
  docker:
    uses: ./.github/workflows/reusable-docker-build.yml
    with:
      service-name: contracts-l1
      context: core/contract_service/contracts-L1/contracts
      dockerfile: core/contract_service/contracts-L1/contracts/Dockerfile
      health-check-url: http://localhost:3000/healthz
      enable-security-scan: true
```

## ğŸ“ æœ€ä½³å¯¦è¸

### é–‹ç™¼éšæ®µ
1. ä½¿ç”¨ `monorepo-dispatch.yml` é€²è¡Œå¿«é€Ÿè¿­ä»£
2. æœ¬åœ°é‹è¡Œ lint å’Œ test é¿å… CI å¤±æ•—

### PR å¯©æŸ¥éšæ®µ
1. `monorepo-dispatch.yml` è‡ªå‹•é‹è¡Œæä¾›åŸºæœ¬é©—è­‰
2. å¦‚æœæ¶‰åŠ Docker è®Šæ›´ï¼Œ`core-services-ci.yml` æœƒè‡ªå‹•åŸ·è¡Œ
3. å¦‚éœ€å®Œæ•´é©—è­‰ï¼Œæ·»åŠ  `ci:integration` æ¨™ç±¤è§¸ç™¼å®Œæ•´æ¸¬è©¦

### åˆä½µå‰
1. ç¢ºä¿æ‰€æœ‰è‡ªå‹• CI æª¢æŸ¥é€šé
2. å°é‡å¤§è®Šæ›´é‹è¡Œå®Œæ•´æ•´åˆæ¸¬è©¦
3. æŸ¥çœ‹ç”Ÿç”¢å°±ç·’å ±å‘Š

### Release æº–å‚™
1. æ‰‹å‹•è§¸ç™¼ `integration-deployment.yml`
2. è¨­ç½® deploy-environment è¼¸å…¥åƒæ•¸
3. é©—è­‰æ‰€æœ‰å±¤ç´šçš„ç”Ÿç”¢å°±ç·’ç‹€æ…‹

## ğŸš¨ æ•…éšœæ’é™¤

### CI é‡è¤‡é‹è¡Œ
- æª¢æŸ¥æ˜¯å¦æœ‰å¤šå€‹å·¥ä½œæµç¨‹è¢«åŒä¸€è®Šæ›´è§¸ç™¼
- é©—è­‰è·¯å¾‘éæ¿¾å™¨é…ç½®æ­£ç¢º
- ç¢ºèª concurrency ç¾¤çµ„è¨­ç½®æ­£ç¢º

### åŸ·è¡Œæ™‚é–“éé•·
- æª¢æŸ¥æ˜¯å¦éœ€è¦ä½¿ç”¨æ›´è¼•é‡çš„å·¥ä½œæµç¨‹
- è€ƒæ…®è·³ééå¿…è¦çš„æ­¥é©Ÿï¼ˆå¦‚ Docker å»ºç½®ï¼‰
- ä½¿ç”¨è·¯å¾‘éæ¿¾å™¨é™åˆ¶è§¸ç™¼ç¯„åœ

### æˆæœ¬éé«˜
- å¯©æŸ¥è§¸ç™¼æ¢ä»¶ï¼Œç¢ºä¿ä¸æœƒéåº¦åŸ·è¡Œ
- ä½¿ç”¨å•Ÿå‹•é–˜é–€æ§åˆ¶é‡é‡ç´šå·¥ä½œæµç¨‹
- è¨­ç½®åˆç†çš„è¶…æ™‚é™åˆ¶
- å•Ÿç”¨ cancel-in-progress

## ğŸ“š ç›¸é—œæ–‡æª”

- [Stage 1 - åŸºç¤ CI](./stage-1-basic-ci.md) - ç¬¬ä¸€éšæ®µåŸºç¤ CI è‡ªå‹•è©•è«–æ©Ÿåˆ¶çš„å¯¦æ–½å’Œä½¿ç”¨
- [CI æ•…éšœæ’é™¤](../ci-troubleshooting.md) - CI/CD å¸¸è¦‹å•é¡Œè¨ºæ–·å’Œè§£æ±ºæ–¹æ¡ˆ
- [è‡ªä¸» CI åˆè¦æ€§](../autonomous-ci-compliance.md) - è‡ªä¸» CI ç³»çµ±çš„åˆè¦æ€§è¦æ±‚å’Œé©—è­‰
- [GitHub Actions æœ€ä½³å¯¦è¸](https://docs.github.com/en/actions/learn-github-actions/best-practices-for-github-actions) - GitHub å®˜æ–¹çš„ Actions æœ€ä½³å¯¦è¸æŒ‡å—

## ğŸ”„ ç¶­è­·æŒ‡å—

### æ·»åŠ æ–°æœå‹™æ™‚
1. åœ¨ `monorepo-dispatch.yml` æ·»åŠ è·¯å¾‘æª¢æ¸¬
2. åœ¨ `core-services-ci.yml` æ·»åŠ  Docker å»ºç½®ï¼ˆå¦‚éœ€è¦ï¼‰
3. åœ¨ `integration-deployment.yml` æ·»åŠ æ–°å±¤ç´šï¼ˆå¦‚éœ€è¦ï¼‰
4. ä½¿ç”¨ `reusable-ci.yml` å’Œ `reusable-docker-build.yml` é¿å…é‡è¤‡ä»£ç¢¼

### æ›´æ–°å¯é‡ç”¨å·¥ä½œæµç¨‹æ™‚
1. æ¸¬è©¦æ‰€æœ‰èª¿ç”¨è©²å·¥ä½œæµç¨‹çš„ä¸Šæ¸¸å·¥ä½œæµç¨‹
2. ä¿æŒå‘å¾Œç›¸å®¹æ€§æˆ–åŒæ™‚æ›´æ–°æ‰€æœ‰èª¿ç”¨æ–¹
3. æ›´æ–°æœ¬æ–‡æª”èªªæ˜è®Šæ›´

### æ€§èƒ½å„ªåŒ–
1. å®šæœŸå¯©æŸ¥å·¥ä½œæµç¨‹åŸ·è¡Œæ™‚é–“
2. è­˜åˆ¥ç“¶é ¸ä¸¦å„ªåŒ–
3. è€ƒæ…®å¢åŠ æ›´å¤šçš„è·¯å¾‘éæ¿¾å™¨
4. è©•ä¼°æ˜¯å¦éœ€è¦æ‹†åˆ†å¤§å‹å·¥ä½œæµç¨‹

---

**æœ€å¾Œæ›´æ–°**: 2025-12-07  
**ç¶­è­·è€…**: SynergyMesh DevOps Team
