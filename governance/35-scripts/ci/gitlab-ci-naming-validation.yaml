stages:
  - validate

variables:
  CONFTEST_VERSION: "0.49.1"
  REPORTS_DIR: "reports"

.install_conftest: &install_conftest
  - apk add --no-cache wget tar
  - wget -q https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz
  - tar xzf conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz
  - mv conftest /usr/local/bin/
  - conftest --version

validate-canonical-naming:
  stage: validate
  image: alpine:latest
  before_script:
    - *install_conftest
    - mkdir -p ${REPORTS_DIR}

  script:
    - echo "ðŸ” Validating canonical naming compliance..."
    - |
      find . \( -name "*.yaml" -o -name "*.yml" \) \
        ! -path "./node_modules/*" \
        ! -path "./.git/*" \
        ! -path "./vendor/*" \
        -print0 | \
      xargs -0 conftest test \
        --policy governance/23-policies/conftest/naming_policy.rego \
        --policy governance/23-policies/conftest/urn_validation.rego \
        --namespace main \
        --output table \
        --fail-on-warn=false || echo "âš ï¸  Validation completed with warnings"

    - echo "ðŸ“Š Generating compliance report..."
    - |
      find . \( -name "*.yaml" -o -name "*.yml" \) \
        ! -path "./node_modules/*" \
        ! -path "./.git/*" \
        ! -path "./vendor/*" \
        -print0 | \
      xargs -0 conftest test \
        --policy governance/23-policies/conftest/naming_policy.rego \
        --policy governance/23-policies/conftest/urn_validation.rego \
        --namespace main \
        --output json \
        > ${REPORTS_DIR}/naming-compliance-report.json || true

    - echo "âœ… Validation complete!"

  artifacts:
    when: always
    paths:
      - ${REPORTS_DIR}/
    expire_in: 30 days
    reports:
      junit: ${REPORTS_DIR}/conftest-junit.xml

  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

validate-naming-strict:
  stage: validate
  image: alpine:latest
  before_script:
    - *install_conftest

  script:
    - echo "ðŸ”’ Running strict naming validation (fail on warnings)..."
    - |
      find . \( -name "*.yaml" -o -name "*.yml" \) \
        ! -path "./node_modules/*" \
        ! -path "./.git/*" \
        ! -path "./vendor/*" \
        -print0 | \
      xargs -0 conftest test \
        --policy governance/23-policies/conftest/naming_policy.rego \
        --policy governance/23-policies/conftest/urn_validation.rego \
        --namespace main \
        --fail-on-warn

  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  allow_failure: false
