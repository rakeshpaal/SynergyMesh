name: Canonical Naming Validation

on:
  pull_request:
    paths:
      - '**.yaml'
      - '**.yml'
  push:
    branches:
      - main
      - develop

jobs:
  validate-naming:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Conftest
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v0.49.1/conftest_0.49.1_Linux_x86_64.tar.gz
          tar xzf conftest_0.49.1_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Find YAML files
        id: find-files
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          find . -name "*.yaml" -o -name "*.yml" | grep -v node_modules | grep -v .git >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate K8s manifests against naming policy
        run: |
          find . \( -name "*.yaml" -o -name "*.yml" \) \
            ! -path "./node_modules/*" \
            ! -path "./.git/*" \
            ! -path "./vendor/*" \
            -print0 | \
          xargs -0 conftest test \
            --policy governance/23-policies/conftest/naming_policy.rego \
            --policy governance/23-policies/conftest/urn_validation.rego \
            --namespace main \
            --output table \
            --fail-on-warn=false || echo "Validation completed with warnings"

      - name: Generate compliance report (JSON)
        if: always()
        run: |
          mkdir -p reports
          find . \( -name "*.yaml" -o -name "*.yml" \) \
            ! -path "./node_modules/*" \
            ! -path "./.git/*" \
            ! -path "./vendor/*" \
            -print0 | \
          xargs -0 conftest test \
            --policy governance/23-policies/conftest/naming_policy.rego \
            --policy governance/23-policies/conftest/urn_validation.rego \
            --namespace main \
            --output json \
            > reports/naming-compliance-report.json || true

      - name: Generate compliance report (HTML)
        if: always()
        run: |
          bash governance/35-scripts/validation/generate-compliance-report.sh

      - name: Upload compliance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: naming-compliance-reports
          path: reports/
          retention-days: 30

      - name: Comment PR with violations
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('reports/naming-compliance-report.json', 'utf8'));

            let comment = '## ðŸ” Canonical Naming Validation Results\\n\\n';

            const violations = report.filter(r => r.failures && r.failures.length > 0);

            if (violations.length === 0) {
              comment += 'âœ… All resources pass canonical naming validation!';
            } else {
              comment += `âŒ Found ${violations.length} file(s) with naming violations:\\n\\n`;

              violations.slice(0, 10).forEach(v => {
                comment += `### \`${v.filename}\`\\n\\n`;
                v.failures.forEach(f => {
                  comment += `- ${f.msg}\\n`;
                });
                comment += '\\n';
              });

              if (violations.length > 10) {
                comment += `\\n_...and ${violations.length - 10} more files with violations._\\n`;
              }

              comment += '\\nðŸ“– See [Canonical Naming Governance](governance/29-docs/canonical-naming-governance-report.md) for details.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
