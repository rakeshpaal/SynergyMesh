apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prod-myapp-netpol
  namespace: prod-myapp-service
  labels:
    environment: prod
    tenant: platform
    app.kubernetes.io/name: myapp
    app.kubernetes.io/managed-by: axiom-naming-controller
    security-tier: zero-trust
  annotations:
    axiom.io/canonical-urn: "urn:axiom:platform:myapp:env:prod:v1"
    axiom.io/governance-mode: strict
    axiom.io/security-policy: zero-trust
    axiom.io/description: "Zero-trust network policy for production MyApp"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: myapp
      environment: prod
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow traffic only from specific frontend service
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: frontend
          environment: prod
    ports:
    - protocol: TCP
      port: 8080
      endPort: 8080

  # Allow traffic from same namespace only
  - from:
    - namespaceSelector:
        matchLabels:
          tenant: platform
          environment: prod
    - podSelector:
        matchLabels:
          app.kubernetes.io/part-of: synergymesh
    ports:
    - protocol: TCP
      port: 8080

  egress:
  # Allow DNS (kube-dns/CoreDNS)
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    - podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

  # Allow HTTPS to specific external endpoints
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443

  # Allow connection to database in same tenant
  - to:
    - namespaceSelector:
        matchLabels:
          tenant: platform
          environment: prod
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: postgres
    ports:
    - protocol: TCP
      port: 5432

  # Deny all other traffic (implicit with no catch-all rule)
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prod-myapp-deny-all
  namespace: prod-myapp-service
  labels:
    environment: prod
    tenant: platform
    app.kubernetes.io/managed-by: axiom-naming-controller
    security-tier: zero-trust
  annotations:
    axiom.io/canonical-urn: "urn:axiom:platform:myapp:env:prod:v1"
    axiom.io/description: "Default deny-all policy as baseline"
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  # Empty ingress/egress = deny all (other policies will allow specific traffic)
