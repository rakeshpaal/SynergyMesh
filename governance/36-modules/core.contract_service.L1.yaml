# ═══════════════════════════════════════════════════════════════════════════════
#                    Module Specification: core.contract_service.L1
#                    模組規範：核心合約服務 L1
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define the role, capabilities, integrations, and operational
#          requirements for the Contract Service L1 module.
# 用途: 定義合約服務 L1 模組的角色、能力、整合點與營運要求。
#
# Version: 1.0.0
# Owner: @core-platform-team
# Last Updated: 2025-12-12
# ═══════════════════════════════════════════════════════════════════════════════

module: "core.contract_service.L1"
version: "1.0.0"
status: "active"

# ============================================================================
# Role Definition | 角色定義
# ============================================================================

role: "domain-service"
role_description: |
  Provides contract lifecycle management with signature verification and
  provenance attestation as the authoritative L1 contract service.

  作為核心合約服務，提供合約生命週期管理、簽名驗證與溯源證明。

# ============================================================================
# Capabilities | 能力
# ============================================================================

capabilities:
  # ─────────────────────────────────────────────────────────────────────────
  # Contract Lifecycle
  # ─────────────────────────────────────────────────────────────────────────
  - id: "create-contract"
    category: "write"
    description: "Create contracts with signature verification and provenance"
    apis:
      - "REST POST /api/v1/contracts"
      - "grpc.contracts.v1.ContractService/Create"
  - id: "get-contract"
    category: "read"
    description: "Retrieve contracts with full provenance trail"
    apis:
      - "REST GET /api/v1/contracts/{contract_id}"
      - "grpc.contracts.v1.ContractService/Get"
  - id: "verify-signature"
    category: "validate"
    description: "Re-verify contract signatures without mutating state"
    apis:
      - "REST POST /api/v1/contracts/{contract_id}/verify"
  - id: "list-contracts"
    category: "read"
    description: "Paginated listing with filtering and ordering"
    apis:
      - "REST GET /api/v1/contracts"

  # ─────────────────────────────────────────────────────────────────────────
  # Provenance & Compliance
  # ─────────────────────────────────────────────────────────────────────────
  - id: "attestation-generation"
    category: "governance"
    description: "Generate SLSA provenance for contract creation events"
    apis:
      - "slsa_provenance.attest(contract_id, metadata)"
  - id: "evidence-export"
    category: "governance"
    description: "Export signed provenance bundles for audit consumers"
    apis:
      - "REST GET /api/v1/contracts/{contract_id}/provenance"

# ============================================================================
# Interfaces | 介面
# ============================================================================

interfaces:
  inbound:
    - protocol: "http"
      path: "/api/v1/contracts"
      auth: "OIDC + service-to-service mTLS"
    - protocol: "grpc"
      service: "grpc.contracts.v1.ContractService"
      auth: "mTLS"
  outbound:
    - target: "core.slsa_provenance"
      contract: "governance/37-behavior-contracts/core.slsa_provenance.yaml"
      purpose: "Generate attestations and verify signatures"
    - target: "infrastructure.database"
      purpose: "Persist contracts and provenance references"

# ============================================================================
# Dependencies | 依賴
# ============================================================================

depends_on:
  required:
    - module: "core.slsa_provenance"
      reason: "Signature verification and provenance attestation"
    - module: "core.unified_integration"
      reason: "Service registration and configuration bootstrap"
    - module: "infrastructure.database"
      reason: "Transactional persistence"
  optional:
    - module: "core.monitoring_system"
      reason: "Metrics and alert delivery"

# ============================================================================
# Quality Gates | 品質門檻
# ============================================================================

testing:
  unit_tests:
    location: "core/contract_service/contracts-L1/tests/unit/"
    framework: "pytest"
    coverage_requirement: 85
  integration_tests:
    location: "tests/integration/contracts-L1/"
    framework: "pytest"
    coverage_requirement: 75
  contract_tests:
    location: "tests/contracts/contracts-L1/"
    framework: "schemathesis"
    coverage_requirement: 80

observability:
  metrics:
    - name: "contract_requests_total"
      type: "counter"
    - name: "contract_request_duration_seconds"
      type: "histogram"
    - name: "provenance_generation_failures_total"
      type: "counter"
  logs:
    level: "INFO"
    format: "json"
    retention: "30 days"
    correlation: "trace_id + contract_id"
  traces:
    enabled: true
    sample_rate: 0.2

# ============================================================================
# Compliance & Security | 合規與安全
# ============================================================================

security:
  threat_model: "docs/security/contract-service-threats.md"
  controls:
    - "All write paths require signature verification"
    - "Immutable audit log for contract mutations"
    - "Secrets managed via platform vault (no inline secrets)"
  compliance:
    - framework: "SLSA"
      level: "Level 3"
    - framework: "SOC 2"
      status: "in-scope"

# ============================================================================
# Documentation & Ownership | 文檔與責任歸屬
# ============================================================================

documentation:
  readme: "core/contract_service/contracts-L1/README.md"
  api_docs: "core/contract_service/contracts-L1/API.md"
  behavior_contract: "governance/37-behavior-contracts/core.contract_service.L1.yaml"
  ownership_entry: "governance/34-config/ownership-map.yaml#core.contract_service.L1"

owner: "@core-platform-team"
lifecycle: "active"
