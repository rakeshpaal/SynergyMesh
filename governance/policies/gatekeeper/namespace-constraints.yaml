apiVersion: machinenativeops.io/v2
kind: ConstraintTemplate
metadata:
  name: k8snamespacenamingcanonical
  annotations:
    machinenativeops.io/description: Validates namespace naming follows canonical
      patterns and has required labels
    machinenativeops.io/source: canonical/machine-spec.yaml
    machinenativeops.io/generated: 'false'
spec:
  crd:
    spec:
      names:
        kind: K8sNamespaceNamingCanonical
      validation:
        openAPIV3Schema:
          type: object
          properties:
            canonicalRegex:
              type: string
              description: 主命名正則表達式
            allowedEnvironments:
              type: array
              items:
                type: string
              description: 允許的環境列表
            requiredLabels:
              type: array
              items:
                type: string
              description: 必需的標籤列表
            requiredAnnotations:
              type: array
              items:
                type: string
              description: 必需的 annotation 列表
            reservedKeywords:
              type: array
              items:
                type: string
              description: 不可用於命名的保留關鍵字
            exemptions:
              type: array
              items:
                type: string
              description: 豁免資源列表
  targets:
  - target: admission.k8s.gatekeeper.sh
    rego: "package k8snamespacenamingcanonical\n\nimport future.keywords.contains\n\
      import future.keywords.if\nimport future.keywords.in\n\n##############################################\n\
      # 違規 1: 命名格式不符合 Canonical Pattern\n##############################################\n\
      violation[{\"msg\": msg, \"details\": details}] {\n  # 僅檢查 Namespace 資源\n  input.review.kind.kind\
      \ == \"Namespace\"\n\n  # 獲取 Namespace 名稱\n  name := input.review.object.metadata.name\n\
      \n  # 檢查是否豁免\n  not is_exempted(name)\n\n  # 驗證命名格式\n  not regex.match(input.parameters.canonicalRegex,\
      \ name)\n\n  msg := sprintf(\"Namespace '%v' does not match canonical naming\
      \ pattern\", [name])\n  details := {\n    \"expected_pattern\": input.parameters.canonicalRegex,\n\
      \    \"actual_name\": name,\n    \"violation_type\": \"naming_format\",\n  \
      \  \"severity\": \"critical\"\n  }\n}\n\n##############################################\n\
      # 違規 2: 缺少必需標籤\n##############################################\nviolation[{\"\
      msg\": msg, \"details\": details}] {\n  input.review.kind.kind == \"Namespace\"\
      \n  name := input.review.object.metadata.name\n  not is_exempted(name)\n\n \
      \ # 檢查每個必需標籤\n  required := input.parameters.requiredLabels[_]\n  labels :=\
      \ object.get(input.review.object.metadata, \"labels\", {})\n  not labels[required]\n\
      \n  msg := sprintf(\"Namespace '%v' is missing required label '%v'\", [name,\
      \ required])\n  details := {\n    \"missing_label\": required,\n    \"violation_type\"\
      : \"missing_label\",\n    \"severity\": \"critical\"\n  }\n}\n\n##############################################\n\
      # 違規 3: 環境標籤值不合法\n##############################################\nviolation[{\"\
      msg\": msg, \"details\": details}] {\n  input.review.kind.kind == \"Namespace\"\
      \n  name := input.review.object.metadata.name\n  not is_exempted(name)\n\n \
      \ # 檢查環境標籤\n  labels := object.get(input.review.object.metadata, \"labels\"\
      , {})\n  env := labels.environment\n\n  # 環境標籤存在但值不在允許列表中\n  env\n  not env_in_allowed_list(env)\n\
      \n  msg := sprintf(\"Namespace '%v' has invalid environment '%v', must be one\
      \ of %v\",\n                 [name, env, input.parameters.allowedEnvironments])\n\
      \  details := {\n    \"invalid_value\": env,\n    \"allowed_values\": input.parameters.allowedEnvironments,\n\
      \    \"violation_type\": \"invalid_label_value\",\n    \"severity\": \"critical\"\
      \n  }\n}\n\n##############################################\n# 違規 4: 缺少必需 Annotations\n\
      ##############################################\nviolation[{\"msg\": msg, \"\
      details\": details}] {\n  input.review.kind.kind == \"Namespace\"\n  name :=\
      \ input.review.object.metadata.name\n  not is_exempted(name)\n\n  # 檢查每個必需 annotation\n\
      \  required := input.parameters.requiredAnnotations[_]\n  annotations := object.get(input.review.object.metadata,\
      \ \"annotations\", {})\n  not annotations[required]\n\n  msg := sprintf(\"Namespace\
      \ '%v' is missing required annotation '%v'\", [name, required])\n  details :=\
      \ {\n    \"missing_annotation\": required,\n    \"violation_type\": \"missing_annotation\"\
      ,\n    \"severity\": \"high\"\n  }\n}\n\n##############################################\n\
      # 違規 5: 包含保留關鍵字\n##############################################\nviolation[{\"\
      msg\": msg, \"details\": details}] {\n  input.review.kind.kind == \"Namespace\"\
      \n  name := input.review.object.metadata.name\n\n  # 檢查保留關鍵字（即使豁免也檢查，除非是系統命名空間）\n\
      \  not is_system_namespace(name)\n\n  keyword := input.parameters.reservedKeywords[_]\n\
      \  contains(name, keyword)\n\n  msg := sprintf(\"Namespace '%v' contains reserved\
      \ keyword '%v'\", [name, keyword])\n  details := {\n    \"reserved_keyword\"\
      : keyword,\n    \"violation_type\": \"reserved_keyword\",\n    \"severity\"\
      : \"critical\"\n  }\n}\n\n##############################################\n#\
      \ 違規 6: 標籤值格式錯誤\n##############################################\nviolation[{\"\
      msg\": msg, \"details\": details}] {\n  input.review.kind.kind == \"Namespace\"\
      \n  name := input.review.object.metadata.name\n  not is_exempted(name)\n\n \
      \ labels := object.get(input.review.object.metadata, \"labels\", {})\n\n  #\
      \ 檢查 tenant 標籤格式\n  tenant := labels.tenant\n  tenant\n  not regex.match(\"\
      ^[a-z0-9-]{2,32}$\", tenant)\n\n  msg := sprintf(\"Namespace '%v' has invalid\
      \ tenant label format '%v'\", [name, tenant])\n  details := {\n    \"invalid_label\"\
      : \"tenant\",\n    \"invalid_value\": tenant,\n    \"expected_format\": \"^[a-z0-9-]{2,32}$\"\
      ,\n    \"violation_type\": \"invalid_label_format\",\n    \"severity\": \"high\"\
      \n  }\n}\n\n##############################################\n# 輔助函數\n##############################################\n\
      \n# 檢查資源是否豁免\nis_exempted(name) {\n  exemption := input.parameters.exemptions[_]\n\
      \  name == exemption\n}\n\n# 檢查資源是否豁免（支持通配符）\nis_exempted(name) {\n  exemption\
      \ := input.parameters.exemptions[_]\n  glob.match(exemption, [\"/\"], name)\n\
      }\n\n# 檢查是否為系統命名空間\nis_system_namespace(name) {\n  system_namespaces := [\"\
      kube-system\", \"kube-public\", \"kube-node-lease\", \"default\"]\n  name ==\
      \ system_namespaces[_]\n}\n\n# 檢查環境是否在允許列表中\nenv_in_allowed_list(env) {\n  allowed\
      \ := input.parameters.allowedEnvironments[_]\n  env == allowed\n}\n"
---
apiVersion: machinenativeops.io/v2
kind: K8sNamespaceNamingCanonical
metadata:
  name: namespace-naming-constraint
  annotations:
    machinenativeops.io/description: Enforces canonical naming and labeling for namespaces
    machinenativeops.io/enforcement: Production-ready enforcement
spec:
  enforcementAction: deny
  match:
    kinds:
    - apiGroups:
      - ''
      kinds:
      - Namespace
    excludedNamespaces: []
  parameters:
    canonicalRegex: ^(team|tenant|dev|test|staging|prod|learn)-[a-z0-9-]{1,56}[a-z0-9]$
    allowedEnvironments:
    - dev
    - test
    - staging
    - prod
    - learn
    requiredLabels:
    - environment
    - tenant
    requiredAnnotations:
    - machinenativeops.io/canonical-urn
    reservedKeywords:
    - core
    - internal
    - system
    - legacy
    - experimental
    - kube
    - kubernetes
    exemptions:
    - kube-system
    - kube-public
    - kube-node-lease
    - default
    - gatekeeper-system
    - cert-manager
    - ingress-nginx
    - monitoring
    - logging
    - legacy-*
---
apiVersion: machinenativeops.io/v2
kind: K8sNamespaceNamingCanonical
metadata:
  name: namespace-naming-constraint-dryrun
  annotations:
    machinenativeops.io/description: Dryrun mode for testing - reports violations
      but doesn't block
spec:
  enforcementAction: dryrun
  match:
    kinds:
    - apiGroups:
      - ''
      kinds:
      - Namespace
  parameters:
    canonicalRegex: ^(team|tenant|dev|test|staging|prod|learn)-[a-z0-9-]{1,56}[a-z0-9]$
    allowedEnvironments:
    - dev
    - test
    - staging
    - prod
    - learn
    requiredLabels:
    - environment
    - tenant
    requiredAnnotations:
    - machinenativeops.io/canonical-urn
    reservedKeywords:
    - core
    - internal
    - system
    - legacy
    - experimental
    exemptions:
    - kube-system
    - kube-public
    - kube-node-lease
    - default
---
apiVersion: machinenativeops.io/v2
kind: K8sNamespaceNamingCanonical
metadata:
  name: namespace-naming-constraint-warn
  annotations:
    machinenativeops.io/description: Warn mode for transition period - reports violations
      as warnings
spec:
  enforcementAction: warn
  match:
    kinds:
    - apiGroups:
      - ''
      kinds:
      - Namespace
  parameters:
    canonicalRegex: ^(team|tenant|dev|test|staging|prod|learn)-[a-z0-9-]{1,56}[a-z0-9]$
    allowedEnvironments:
    - dev
    - test
    - staging
    - prod
    - learn
    requiredLabels:
    - environment
    - tenant
    requiredAnnotations:
    - machinenativeops.io/canonical-urn
    reservedKeywords:
    - core
    - internal
    - system
    - legacy
    - experimental
    exemptions:
    - kube-system
    - kube-public
    - kube-node-lease
    - default
--- null
...
