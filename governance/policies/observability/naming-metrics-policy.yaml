apiVersion: machinenativeops.io/v2
kind: NamingObservability
metadata:
  labels:
    machinenativeops.io/category: observability
    machinenativeops.io/module: naming-governance
  name: naming-compliance-monitoring
spec:
  alerts:
  - annotations:
      description: '在环境 {{ $labels.env }}, 应用 {{ $labels.app }} 检测到命名规范违反。

        请于 5 分钟内检查并修正。

        违规资源: {{ $labels.resource_type }}

        '
      runbook_url: https://wiki.example.com/runbooks/naming-violation
      summary: 命名规范违反 (critical)
    expr: count(naming_compliance_violation_total{severity="critical"}) by (app, env)
      > 0
    for: 5m
    labels:
      category: governance
      component: naming
    name: NamingPolicyViolation
    severity: critical
  - annotations:
      description: '当前命名合规率为 {{ $value | humanizePercentage }}，

        低于 95% 的目标阈值。

        请检查并修复不合规资源。

        '
      summary: 命名合规率低于阈值
    expr: "(\n  sum(naming_compliance_good) /\n  (sum(naming_compliance_good) + sum(naming_compliance_bad))\n\
      ) * 100 < 95\n"
    for: 15m
    labels:
      category: governance
      component: naming
    name: NamingComplianceRateLow
    severity: warning
  - annotations:
      description: '过去 1 小时内检测到 {{ $value }} 个高严重性命名违规。

        可能存在批量配置错误或自动化问题。

        '
      summary: 命名违规率异常升高
    expr: 'rate(naming_violation_total{severity=~"critical|high"}[1h]) > 10

      '
    for: 10m
    name: HighNamingViolationRate
    severity: warning
  - annotations:
      description: '自动修复失败率为 {{ $value | humanizePercentage }}，

        超过 20% 阈值，需要检查自动化流程。

        '
      summary: 自动修复失败率过高
    expr: "(\n  rate(naming_remediation_failure[1h]) /\n  (rate(naming_remediation_success[1h])\
      \ + rate(naming_remediation_failure[1h]))\n) > 0.2\n"
    for: 30m
    name: RemediationFailureRate
    severity: warning
  dashboards:
  - name: Naming Compliance Overview
    panels:
    - targets:
      - expr: "(\n  sum(naming_compliance_good) /\n  (sum(naming_compliance_good)\
          \ + sum(naming_compliance_bad))\n) * 100\n"
        legendFormat: 合规率
      title: 命名合规率
      type: stat
    - targets:
      - expr: sum(naming_compliance_bad) by (environment)
        legendFormat: '{{ environment }}'
      title: 违规资源数量（按环境）
      type: graph
    - targets:
      - expr: sum(naming_violation_total) by (violation_type)
      title: 违规类型分布
      type: piechart
    - targets:
      - expr: "(\n  sum(rate(naming_remediation_success[1h])) /\n  (sum(rate(naming_remediation_success[1h]))\
          \ + sum(rate(naming_remediation_failure[1h])))\n) * 100\n"
      title: 自动修复成功率
      type: stat
    tags:
    - governance
    - naming
    - compliance
    uid: naming-compliance-overview
  metrics:
    naming_compliance_bad:
      help: Number of resources violating naming standards
      labels:
      - environment
      - resource_type
      - namespace
      - team
      - violation_type
      name: naming_compliance_bad
      required: true
      type: gauge
    naming_compliance_good:
      help: Number of resources compliant with naming standards
      labels:
      - environment
      - resource_type
      - namespace
      - team
      name: naming_compliance_good
      required: true
      type: gauge
    naming_compliance_rate:
      calculation: naming_compliance_good / (naming_compliance_good + naming_compliance_bad)
        * 100
      help: Naming compliance rate percentage
      name: naming_compliance_rate
      required: true
      type: gauge
    naming_remediation_failure:
      help: Failed naming remediations
      labels:
      - remediation_type
      - resource_type
      - error_type
      name: naming_remediation_failure
      required: false
      type: counter
    naming_remediation_success:
      help: Successful naming remediations
      labels:
      - remediation_type
      - resource_type
      name: naming_remediation_success
      required: false
      type: counter
    naming_violation_total:
      help: Total count of naming violations detected
      labels:
      - severity
      - resource_type
      - violation_type
      name: naming_violation_total
      required: true
      type: counter
  notifications:
  - channel: slack
    config:
      channel: '#governance-alerts'
      severity_levels:
      - critical
      - warning
      webhook_url: ${SLACK_WEBHOOK_URL}
    name: Slack 通知
  - channel: email
    config:
      recipients:
      - governance-team@example.com
      - sre-team@example.com
      severity_levels:
      - critical
    name: Email 通知
  - channel: pagerduty
    config:
      service_key: ${PAGERDUTY_SERVICE_KEY}
      severity_levels:
      - critical
    name: PagerDuty
  retention:
    logs: 90d
    metrics: 30d
    traces: 7d
  sla:
    auto_remediation_success_rate:
      description: 最小自动修复成功率 (%)
      min_rate: 95.0
    migration_failure_rate:
      description: 最大迁移失败率 (%)
      max_rate: 5.0
    naming_compliance_rate:
      alertThreshold: 95.0
      description: 命名合规率目标
      target: 99.9
    validation_failure_threshold:
      description: 单位时间内最大验证失败数
      max_count: 10
      timeWindow: 1h
