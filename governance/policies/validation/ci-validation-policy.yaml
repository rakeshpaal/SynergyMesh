apiVersion: machinenativeops.io/v2
kind: ValidationPolicy
metadata:
  labels:
    machinenativeops.io/category: validation
    machinenativeops.io/enforcement: strict
    machinenativeops.io/module: naming-governance
  name: naming-pr-validation
spec:
  audit:
    enabled: true
    includeSuccessful: false
    logLevel: info
    storage:
      index: governance-validation-logs
      retention: 90d
      type: elasticsearch
  cicd:
    githubActions:
      branches:
      - main
      - develop
      - release/*
      enabled: true
      paths:
      - manifests/**
      - terraform/**
      triggerOn:
      - pull_request
      - push
      workflow: .github/workflows/naming-validation.yml
    gitlabCI:
      enabled: false
      only:
      - merge_requests
      - main
      script:
      - conftest test manifests/
      - checkov -d terraform/
      stage: validate
    jenkins:
      enabled: false
      pipeline: Jenkinsfile.validation
      stages:
      - lint
      - validate
      - security-scan
  enforcement:
    description: 'enforce: 严格执行，违规则阻止 PR 合并

      warn: 警告但允许继续

      advisory: 仅记录，不阻止

      '
    exemptions:
    - approvedBy: governance-board
      expiresAt: '2025-12-31T23:59:59Z'
      reason: 历史遗留系统，已有迁移计划
      resource: legacy-app-*
    - approvedBy: platform-team
      expiresAt: 永久
      reason: 系统命名空间，特殊命名约定
      resource: '*/kube-system/*'
    failOn:
    - critical
    - high
    mode: enforce
    warnOn:
    - medium
  performance:
    cache:
      enabled: true
      ttl: 24h
    maxConcurrent: 5
    timeout: 10m
  reporting:
    destination:
      email:
        enabled: true
        notifyOn:
        - critical-issues
        recipients:
        - governance-team@example.com
        subject: 'Naming Validation Alert: {{ .pr_title }}'
      github:
        collapseSuccessful: true
        commentOn:
        - failure
        enabled: true
      slack:
        channel: '#pr-validation'
        enabled: true
        messageTemplate: ':x: Naming Validation Failed

          PR: {{ .pr_url }}

          Violations: {{ .violation_count }}

          Severity: {{ .highest_severity }}

          '
        notifyOn:
        - failure
        - critical-issues
        webhook: ${SLACK_WEBHOOK_URL}
      storage:
        bucket: governance-validation-reports
        path: naming-validation/{{ .date }}/{{ .pr_number }}
        retention: 90d
        type: s3
    format:
    - json
    - sarif
    - junit
    - html
  scope:
    environments:
    - production
    - staging
    - dev
    filePatterns:
    - '**/*.yaml'
    - '**/*.yml'
    - '**/*.tf'
    - '**/*.json'
    paths:
    - manifests/
    - terraform/
    - helm/
    - k8s/
    - .github/workflows/
    - .gitlab-ci.yml
    resourceTypes:
    - Deployment
    - StatefulSet
    - DaemonSet
    - Service
    - Ingress
    - ConfigMap
    - Secret
    - ServiceAccount
    - PersistentVolumeClaim
    - HorizontalPodAutoscaler
  tools:
    checkov:
      compactOutput: false
      enabled: true
      framework:
      - kubernetes
      - terraform
      - helm
      skipChecks:
      - CKV_K8S_1
      softFail: false
    conftest:
      data:
      - schemas/resource-name.schema.yaml
      enabled: true
      failOn:
      - critical
      - high
      namespace: main
      outputFormat: json
      policyPath: policies/conftest/
    custom:
    - args:
      - tools/governance/python/validate_naming.py
      - --strict
      - --format=json
      command: python
      name: Naming Pattern Validator
    - args:
      - tools/governance/bash/check_required_labels.sh
      command: bash
      name: Label Completeness Check
    kubeBench:
      configDir: ./cis-config
      enabled: true
      skipTests:
      - 1.1.1
      targets:
      - master
      - node
      - etcd
    kubeaudit:
      auditAll: true
      checks:
      - apparmor
      - capabilities
      - hostns
      - image
      - limits
      - mountds
      - netpols
      - nonroot
      - privesc
      - privileged
      - rootfs
      - seccomp
      enabled: true
    kubescape:
      enabled: true
      failOn: critical
      frameworks:
      - nsa
      - mitre
      - cis
      severityThreshold: medium
