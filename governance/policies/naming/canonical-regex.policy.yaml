apiVersion: machinenativeops.io/v2
examples:
- description: 驗證 team-frontend-prod 命名
  expected: PASS
  reason: 符合 team-domain-env 模式
  resource:
    apiVersion: machinenativeops.io/v2
    kind: Namespace
    metadata:
      name: team-frontend-prod
- description: 拒絕 Team-Frontend-Prod 命名
  expected: FAIL
  reason: 包含大寫字母，違反 VAL-002
  resource:
    apiVersion: machinenativeops.io/v2
    kind: Namespace
    metadata:
      name: Team-Frontend-Prod
- description: 拒絕 team_frontend_prod 命名
  expected: FAIL
  reason: 使用底線而非破折號，違反 VAL-002
  resource:
    apiVersion: machinenativeops.io/v2
    kind: Namespace
    metadata:
      name: team_frontend_prod
- description: 拒絕 team-core-prod 命名
  expected: FAIL
  reason: 包含保留關鍵字 'core'，違反 VAL-004
  resource:
    apiVersion: machinenativeops.io/v2
    kind: Namespace
    metadata:
      name: team-core-prod
- description: 驗證 tenant-payment-prod-uswest 命名
  expected: PASS
  reason: 符合 tenant-workload-env-region 模式
  resource:
    apiVersion: machinenativeops.io/v2
    kind: Namespace
    metadata:
      name: tenant-payment-prod-uswest
- description: 驗證 prod-api-v2 命名
  expected: PASS
  reason: 符合 env-app-version 模式
  resource:
    apiVersion: machinenativeops.io/v2
    kind: Namespace
    metadata:
      name: prod-api-v2
kind: NamingPolicy
maintenance:
  contact: governance-team@example.com
  last_updated: '2025-01-15'
  next_review: '2025-04-15'
  owner: Platform Engineering Team
  version: v1.0
metadata:
  annotations:
    machinenativeops.io/description: 命名正則表達式驗證策略
    machinenativeops.io/generated: 'false'
    machinenativeops.io/source: canonical/machine-spec.yaml
  labels:
    machinenativeops.io/category: naming
    machinenativeops.io/enforcement: strict
    machinenativeops.io/module: canonical-naming
  name: canonical-regex-policy
spec:
  audit:
    enabled: true
    fields:
    - timestamp
    - resource_type
    - resource_name
    - violation_rule
    - severity
    - action_taken
    log_violations: true
    retention: 90d
  canonical:
    constraints:
      allowed_chars: '[a-z0-9-]'
      case: lower
      end_with: '[a-z0-9]'
      max_length: 63
      min_length: 3
      no_consecutive_hyphens: true
      start_with: '[a-z0-9]'
    primary_regex: ^(team|tenant|dev|test|staging|prod|learn)-[a-z0-9-]{1,56}[a-z0-9]$
  enforcement:
    by_environment:
      dev:
        fail_on: []
        mode: warn
      production:
        fail_on:
        - critical
        - high
        mode: enforce
      staging:
        fail_on:
        - critical
        mode: enforce
    description: 'enforce: 嚴格執行，違規資源將被拒絕創建

      warn: 警告但允許創建

      advisory: 僅記錄，不阻止

      '
    mode: enforce
  exemptions:
  - approved_by: platform-team
    expires_at: permanent
    reason: Kubernetes 核心系統命名空間
    resource: kube-system
  - approved_by: platform-team
    expires_at: permanent
    reason: Kubernetes 公共命名空間
    resource: kube-public
  - approved_by: platform-team
    expires_at: permanent
    reason: Kubernetes 節點租約命名空間
    resource: kube-node-lease
  - approved_by: platform-team
    expires_at: permanent
    reason: Kubernetes 默認命名空間
    resource: default
  - approved_by: governance-board
    expires_at: '2025-12-31T23:59:59Z'
    reason: 歷史遺留系統，遷移計劃中
    resource: legacy-*
  patterns:
  - description: 團隊級命名空間模式
    examples:
      invalid:
      - Team-Frontend-Prod
      - team_frontend_prod
      - teamfrontendprod
      valid:
      - team-frontend-prod
      - team-backend-dev
      - team-data-staging
    id: team-domain-env
    regex: ^team-[a-z0-9-]+-(?:dev|test|staging|prod|learn)$
  - description: 多租戶跨區域部署模式
    examples:
      invalid:
      - tenant-payment-prod
      - tenant-payment-production-uswest
      valid:
      - tenant-payment-prod-uswest
      - tenant-auth-staging-eucentral
      - tenant-analytics-dev-apsouth
    id: tenant-workload-env-region
    regex: ^tenant-[a-z0-9-]+-(?:dev|test|staging|prod)-[a-z0-9-]+$
  - description: 環境-應用-版本模式（多版本共存）
    examples:
      invalid:
      - prod-api-2
      - prod-api-v2.0
      valid:
      - prod-api-v2
      - staging-frontend-v3
      - dev-backend-v1
    id: env-app-version
    regex: ^(?:dev|test|staging|prod)-[a-z0-9-]+-v[0-9]+$
  reporting:
    email:
      enabled: false
      recipients:
      - governance-team@example.com
    slack:
      channel: '#naming-violations'
      enabled: true
      notify_on:
      - critical
      - high
  reserved:
    error_message: '資源名稱不能包含保留關鍵字: {keyword}'
    keywords:
    - core
    - internal
    - system
    - legacy
    - experimental
    - kube
    - kubernetes
    - default
  scope:
    environments:
    - dev
    - test
    - staging
    - prod
    - learn
    resourceTypes:
    - Namespace
    - Deployment
    - StatefulSet
    - DaemonSet
    - Service
    - Ingress
    - ConfigMap
    - Secret
    - PersistentVolumeClaim
  tooling:
    cicd:
      github_actions:
        block_on_failure: true
        enabled: true
        workflow: .github/workflows/naming-validation.yml
    conftest:
      enabled: true
      namespace: main
      policy_file: templates/conftest/naming.rego
    gatekeeper:
      constraint_template: policies/gatekeeper/namespace-constraints.yaml
      enabled: true
      enforcement_action: deny
  validation:
  - description: 驗證資源名稱符合 canonical pattern
    error_message: 資源名稱不符合 Canonical 命名模式
    id: VAL-001
    name: Canonical Pattern Match
    remediation: 使用 team-{domain}-{env}、tenant-{workload}-{env}-{region} 或 env-{app}-{version}
      格式
    rule:
      pattern: ^(team|tenant|dev|test|staging|prod|learn)-[a-z0-9-]{1,56}[a-z0-9]$
      type: regex
    severity: critical
  - description: 驗證僅使用允許的字符
    error_message: 資源名稱只能包含小寫字母、數字和破折號
    id: VAL-002
    name: Character Constraint
    remediation: 移除大寫字母、底線和特殊字符
    rule:
      pattern: ^[a-z0-9-]+$
      type: regex
    severity: critical
  - description: 驗證名稱長度在允許範圍內
    error_message: 資源名稱長度必須在 3-63 字符之間
    id: VAL-003
    name: Length Constraint
    remediation: 縮短或延長資源名稱
    rule:
      max: 63
      min: 3
      type: length
    severity: high
  - description: 驗證不包含保留關鍵字
    error_message: 資源名稱包含保留關鍵字
    id: VAL-004
    name: Reserved Keyword Check
    remediation: 使用不同的命名
    rule:
      type: deny_list
      values:
      - core
      - internal
      - system
      - legacy
      - experimental
      - kube
      - kubernetes
      - default
    severity: critical
  - description: 驗證不包含連續破折號
    error_message: 資源名稱包含連續破折號
    id: VAL-005
    name: No Consecutive Hyphens
    remediation: 移除多餘的破折號
    rule:
      pattern: ^(?!.*--).*$
      type: regex
    severity: medium
testing:
  commands:
  - command: conftest test manifests/ --policy templates/conftest/
    description: 使用 Conftest 驗證 manifests
  - command: python tools/governance/python/validate_naming.py --spec canonical/machine-spec.yaml
      --resource manifests/
    description: 使用 Python 工具驗證
  - command: kubectl apply -f manifests/namespace.yaml --dry-run=server
    description: Gatekeeper Dry-run 測試
