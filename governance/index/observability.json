{
  "$schema": "./schemas/observability.schema.json",
  "version": "1.0.0",
  "timestamp": "2025-12-11T00:00:00Z",
  "metadata": {
    "name": "Observability & Metrics Registry",
    "description": "觀測與回饋層 - 定義所有維度的指標和觀測配置",
    "purpose": "讓 agent 能夠收集執行結果，形成閉環回饋"
  },
  "metrics_config": {
    "collection": {
      "interval": "60s",
      "buffer_size": 10000,
      "batch_size": 1000,
      "compression": "gzip"
    },
    "storage": {
      "backend": "prometheus",
      "retention": "30d",
      "aggregation_intervals": ["1m", "5m", "1h", "1d"]
    },
    "export": {
      "format": "openmetrics",
      "endpoints": ["/metrics", "/metrics/json"]
    }
  },
  "core_metrics": {
    "governance_health": {
      "id": "governance_health_score",
      "description": "整體治理健康分數 (0-100)",
      "type": "gauge",
      "unit": "percent",
      "target": 95,
      "alert_threshold": 80,
      "dimensions": ["all"]
    },
    "policy_compliance_rate": {
      "id": "policy_compliance_rate",
      "description": "策略合規率",
      "type": "gauge",
      "unit": "percent",
      "target": 99,
      "alert_threshold": 95,
      "dimensions": ["10-policy", "05-compliance"]
    },
    "agent_availability": {
      "id": "agent_availability",
      "description": "Agent 可用性",
      "type": "gauge",
      "unit": "percent",
      "target": 99.9,
      "alert_threshold": 99,
      "dimensions": ["30-agents"]
    },
    "automation_success_rate": {
      "id": "automation_success_rate",
      "description": "自動化成功率",
      "type": "gauge",
      "unit": "percent",
      "target": 98,
      "alert_threshold": 90,
      "dimensions": ["39-automation"]
    },
    "self_healing_mttr": {
      "id": "self_healing_mttr",
      "description": "自我修復平均恢復時間",
      "type": "histogram",
      "unit": "seconds",
      "target": 60,
      "alert_threshold": 300,
      "dimensions": ["40-self-healing"]
    },
    "audit_coverage": {
      "id": "audit_coverage",
      "description": "審計覆蓋率",
      "type": "gauge",
      "unit": "percent",
      "target": 100,
      "alert_threshold": 95,
      "dimensions": ["70-audit"]
    },
    "feedback_loop_latency": {
      "id": "feedback_loop_latency",
      "description": "回饋迴路延遲",
      "type": "histogram",
      "unit": "seconds",
      "target": 300,
      "alert_threshold": 600,
      "dimensions": ["80-feedback"]
    }
  },
  "dimension_metrics": [
    {
      "dimension": "10-policy",
      "metrics": [
        { "id": "policy_count", "type": "gauge", "description": "策略總數" },
        { "id": "policy_violations", "type": "counter", "description": "策略違規次數" },
        { "id": "policy_validation_time", "type": "histogram", "description": "策略驗證時間" },
        { "id": "policy_enforcement_rate", "type": "gauge", "description": "策略執行率" }
      ],
      "slo": {
        "availability": "99.9%",
        "latency_p99": "5s",
        "error_rate": "0.1%"
      }
    },
    {
      "dimension": "20-intent",
      "metrics": [
        { "id": "intent_received", "type": "counter", "description": "接收意圖數" },
        { "id": "intent_mapping_success", "type": "gauge", "description": "意圖映射成功率" },
        { "id": "intent_execution_time", "type": "histogram", "description": "意圖執行時間" }
      ],
      "slo": {
        "availability": "99.9%",
        "latency_p99": "10s",
        "error_rate": "0.5%"
      }
    },
    {
      "dimension": "30-agents",
      "metrics": [
        { "id": "agent_count", "type": "gauge", "description": "註冊 Agent 數" },
        { "id": "agent_active", "type": "gauge", "description": "活躍 Agent 數" },
        { "id": "agent_failures", "type": "counter", "description": "Agent 失敗次數" },
        { "id": "agent_resource_usage", "type": "gauge", "description": "Agent 資源使用率" }
      ],
      "slo": {
        "availability": "99.9%",
        "latency_p99": "30s",
        "error_rate": "0.1%"
      }
    },
    {
      "dimension": "39-automation",
      "metrics": [
        { "id": "automation_tasks_total", "type": "counter", "description": "自動化任務總數" },
        { "id": "automation_tasks_success", "type": "counter", "description": "成功任務數" },
        { "id": "automation_duration", "type": "histogram", "description": "自動化執行時間" },
        { "id": "engine_health", "type": "gauge", "description": "引擎健康狀態" }
      ],
      "slo": {
        "availability": "99%",
        "latency_p99": "60s",
        "error_rate": "2%"
      }
    },
    {
      "dimension": "40-self-healing",
      "metrics": [
        { "id": "healing_triggered", "type": "counter", "description": "修復觸發次數" },
        { "id": "healing_success", "type": "counter", "description": "修復成功次數" },
        { "id": "healing_time", "type": "histogram", "description": "修復時間" },
        { "id": "anomaly_detected", "type": "counter", "description": "異常檢測次數" }
      ],
      "slo": {
        "availability": "99.9%",
        "mttr": "60s",
        "success_rate": "95%"
      }
    },
    {
      "dimension": "60-contracts",
      "metrics": [
        { "id": "contract_count", "type": "gauge", "description": "契約總數" },
        { "id": "contract_violations", "type": "counter", "description": "契約違規次數" },
        { "id": "contract_validation_time", "type": "histogram", "description": "契約驗證時間" }
      ],
      "slo": {
        "availability": "99.9%",
        "latency_p99": "5s",
        "error_rate": "0.1%"
      }
    },
    {
      "dimension": "70-audit",
      "metrics": [
        { "id": "audit_events", "type": "counter", "description": "審計事件數" },
        { "id": "audit_findings", "type": "counter", "description": "審計發現數" },
        { "id": "evidence_collected", "type": "counter", "description": "證據收集數" },
        { "id": "audit_lag", "type": "gauge", "description": "審計延遲" }
      ],
      "slo": {
        "availability": "99.99%",
        "latency_p99": "10s",
        "data_loss": "0%"
      }
    },
    {
      "dimension": "80-feedback",
      "metrics": [
        { "id": "feedback_collected", "type": "counter", "description": "回饋收集數" },
        { "id": "recommendations_generated", "type": "counter", "description": "建議生成數" },
        { "id": "optimizations_applied", "type": "counter", "description": "優化應用數" },
        { "id": "feedback_loop_time", "type": "histogram", "description": "回饋迴路時間" }
      ],
      "slo": {
        "availability": "99%",
        "latency_p99": "300s",
        "optimization_rate": "80%"
      }
    }
  ],
  "alerting": {
    "channels": [
      { "id": "slack", "type": "slack", "webhook": "${SLACK_WEBHOOK}" },
      { "id": "pagerduty", "type": "pagerduty", "routing_key": "${PAGERDUTY_KEY}" },
      { "id": "email", "type": "email", "recipients": ["oncall@example.com"] }
    ],
    "severity_routing": {
      "critical": ["pagerduty", "slack"],
      "high": ["slack", "email"],
      "medium": ["slack"],
      "low": ["email"]
    },
    "rules": [
      {
        "id": "governance_health_critical",
        "condition": "governance_health_score < 70",
        "severity": "critical",
        "message": "Governance health score is critically low"
      },
      {
        "id": "policy_violations_spike",
        "condition": "rate(policy_violations[5m]) > 10",
        "severity": "high",
        "message": "Policy violations spike detected"
      },
      {
        "id": "agent_availability_low",
        "condition": "agent_availability < 99",
        "severity": "high",
        "message": "Agent availability below SLO"
      },
      {
        "id": "self_healing_failure",
        "condition": "healing_success / healing_triggered < 0.9",
        "severity": "critical",
        "message": "Self-healing success rate below threshold"
      }
    ]
  },
  "dashboards": {
    "governance_overview": {
      "id": "governance-overview",
      "title": "Governance Overview",
      "panels": [
        { "title": "Health Score", "metric": "governance_health_score", "type": "gauge" },
        { "title": "Policy Compliance", "metric": "policy_compliance_rate", "type": "gauge" },
        { "title": "Agent Status", "metric": "agent_availability", "type": "stat" },
        { "title": "Recent Violations", "metric": "policy_violations", "type": "timeseries" }
      ]
    },
    "execution_dashboard": {
      "id": "execution-dashboard",
      "title": "Execution & Automation",
      "panels": [
        { "title": "Automation Tasks", "metric": "automation_tasks_total", "type": "counter" },
        { "title": "Success Rate", "metric": "automation_success_rate", "type": "gauge" },
        { "title": "Self-Healing MTTR", "metric": "self_healing_mttr", "type": "histogram" },
        { "title": "Engine Health", "metric": "engine_health", "type": "heatmap" }
      ]
    },
    "feedback_dashboard": {
      "id": "feedback-dashboard",
      "title": "Feedback & Optimization",
      "panels": [
        { "title": "Feedback Volume", "metric": "feedback_collected", "type": "timeseries" },
        { "title": "Recommendations", "metric": "recommendations_generated", "type": "counter" },
        { "title": "Loop Latency", "metric": "feedback_loop_time", "type": "histogram" },
        { "title": "Optimization Impact", "metric": "optimizations_applied", "type": "stat" }
      ]
    }
  },
  "feedback_channels": {
    "description": "回饋收集渠道配置",
    "channels": [
      {
        "id": "metrics_feedback",
        "type": "metrics",
        "source": "prometheus",
        "interval": "60s",
        "dimensions": ["all"]
      },
      {
        "id": "event_feedback",
        "type": "events",
        "source": "event_bus",
        "filter": ["policy.violated", "agent.failed", "healing.failed"],
        "dimensions": ["10-policy", "30-agents", "40-self-healing"]
      },
      {
        "id": "audit_feedback",
        "type": "audit",
        "source": "70-audit",
        "interval": "300s",
        "dimensions": ["70-audit", "05-compliance"]
      },
      {
        "id": "user_feedback",
        "type": "survey",
        "source": "feedback_portal",
        "interval": "weekly",
        "dimensions": ["all"]
      }
    ]
  },
  "tracing": {
    "enabled": true,
    "standard": "opentelemetry",
    "sampling_rate": 0.1,
    "propagation": {
      "headers": ["X-Trace-ID", "X-Correlation-ID", "X-Request-ID"],
      "format": "w3c"
    },
    "export": {
      "backend": "jaeger",
      "endpoint": "${JAEGER_ENDPOINT}"
    }
  }
}
