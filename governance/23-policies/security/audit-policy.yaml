---
# Audit Policy / 審計策略
# Extracted from: baseline-02-security-rbac.v1.0.yaml
# Purpose: Define audit logging levels and retention policies

apiVersion: governance.synergymesh.io/v1
kind: Policy
metadata:
  name: audit-policy
  version: v1.0.0
  category: security-audit
  enforcement: mandatory
  priority: 950
  description: "Kubernetes 審計日誌策略 / Kubernetes audit logging policy"

spec:
  version: v1.0.0
  
  audit_levels:
    metadata:
      description: "記錄請求元數據 / Log request metadata"
      level: "Metadata"
      resources:
        - apiGroups: [""]
          resources:
            - "configmaps"
            - "endpoints"
            - "persistentvolumeclaims"
            - "pods"
            - "replicationcontrollers"
            - "services"
        - apiGroups: ["apps"]
          resources:
            - "daemonsets"
            - "replicasets"
      operations:
        - "get"
        - "list"
        - "watch"
    
    request:
      description: "記錄請求主體 / Log request body"
      level: "Request"
      resources:
        - apiGroups: [""]
          resources:
            - "secrets"
            - "serviceaccounts"
        - apiGroups: ["apps"]
          resources:
            - "deployments"
            - "statefulsets"
        - apiGroups: ["batch"]
          resources:
            - "jobs"
            - "cronjobs"
        - apiGroups: ["networking.k8s.io"]
          resources:
            - "networkpolicies"
            - "ingresses"
      operations:
        - "create"
        - "update"
        - "patch"
        - "delete"
    
    request_response:
      description: "記錄請求與回應 / Log request and response"
      level: "RequestResponse"
      resources:
        - apiGroups: ["rbac.authorization.k8s.io"]
          resources:
            - "roles"
            - "rolebindings"
            - "clusterroles"
            - "clusterrolebindings"
        - apiGroups: ["certificates.k8s.io"]
          resources:
            - "certificatesigningrequests"
        - apiGroups: ["authentication.k8s.io"]
          resources:
            - "tokenreviews"
        - apiGroups: ["authorization.k8s.io"]
          resources:
            - "subjectaccessreviews"
            - "selfsubjectaccessreviews"
      operations:
        - "create"
        - "update"
        - "patch"
        - "delete"
  
  omit_stages:
    # Don't log these stages to reduce noise
    - "RequestReceived"
  
  retention:
    log_rotation_days: 90
    archive_storage: "s3-compliant"
    archive_retention_years: 7
    encryption_at_rest: true
    encryption_algorithm: "AES-256-GCM"
    compression: true
    immutable_storage: true
  
  alerting:
    unauthorized_access:
      severity: "critical"
      notification:
        - "pagerduty"
        - "slack"
      conditions:
        - "status_code: 403"
        - "verb: create,update,delete"
        - "resource: secrets,rbac"
    
    privileged_escalation:
      severity: "high"
      notification:
        - "slack"
        - "email"
      conditions:
        - "verb: create,update"
        - "resource: clusterrolebindings"
        - "requesting_user: !cluster-admin"
    
    anomalous_behavior:
      severity: "medium"
      notification:
        - "email"
      conditions:
        - "request_rate: >100/minute"
        - "failed_auth_attempts: >10/hour"
        - "unusual_api_access_pattern: true"
    
    secret_access:
      severity: "high"
      notification:
        - "slack"
      conditions:
        - "resource: secrets"
        - "verb: get,list"
        - "user: !service-account"
    
    rbac_changes:
      severity: "high"
      notification:
        - "slack"
        - "email"
      conditions:
        - "resource: roles,rolebindings,clusterroles,clusterrolebindings"
        - "verb: create,update,delete"

  special_handling:
    sensitive_namespaces:
      - "kube-system"
      - "istio-system"
      - "cert-manager"
      - "vault"
      - "security"
    log_level: "RequestResponse"
    alert_all_changes: true
  
  exemptions:
    # System processes that generate high-volume logs
    users:
      - "system:kube-controller-manager"
      - "system:kube-scheduler"
      - "system:node-problem-detector"
    resources:
      - apiGroups: [""]
        resources:
          - "events"
        verbs:
          - "create"
          - "patch"
  
  integration:
    siem:
      enabled: true
      endpoint: "https://siem.example.com/api/v1/logs"
      format: "json"
      batch_size: 100
      flush_interval_seconds: 30
    
    compliance_platforms:
      - name: "SOC2"
        enabled: true
        export_schedule: "daily"
      - name: "ISO27001"
        enabled: true
        export_schedule: "weekly"

  performance:
    max_batch_size: 1000
    max_batch_wait_seconds: 30
    buffer_size_mb: 100
    async_processing: true
  
  related_policies:
    - rbac-role-matrix
    - zero-trust-principles
    - compliance-standards
  
  references:
    - description: "Kubernetes Audit Policy"
      url: "https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/"
    - description: "SOC 2 Audit Requirements"
      url: "https://www.aicpa.org/interestareas/frc/assuranceadvisoryservices/aicpasoc2report"
