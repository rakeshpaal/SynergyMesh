apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8snamingpattern
  annotations:
    metadata.gatekeeper.sh/title: "Naming Pattern"
    metadata.gatekeeper.sh/version: 1.0.0
    description: "Enforces canonical naming pattern on resources per governance spec"
spec:
  crd:
    spec:
      names:
        kind: K8sNamingPattern
      validation:
        openAPIV3Schema:
          type: object
          properties:
            pattern:
              type: string
              description: "Regex pattern for valid names"
            maxLength:
              type: integer
              description: "Maximum name length"
              default: 63
            message:
              type: string
              description: "Custom violation message"
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8snamingpattern

        # Violation if name doesn't match pattern
        violation[{"msg": msg}] {
          name := input.review.object.metadata.name
          pattern := input.parameters.pattern
          not re_match(pattern, name)
          def_msg := sprintf("Resource name '%v' does not match required pattern '%v'. Expected format: {env}-{component}-{suffix}", [name, pattern])
          msg := object.get(input.parameters, "message", def_msg)
        }

        # Violation if name exceeds max length
        violation[{"msg": msg}] {
          name := input.review.object.metadata.name
          max_length := object.get(input.parameters, "maxLength", 63)
          count(name) > max_length
          msg := sprintf("Resource name '%v' exceeds maximum length of %v characters (current: %v)", [name, max_length, count(name)])
        }

        # Violation if name contains consecutive hyphens
        violation[{"msg": msg}] {
          name := input.review.object.metadata.name
          contains(name, "--")
          msg := sprintf("Resource name '%v' contains forbidden consecutive hyphens '--'", [name])
        }

        # Violation if name starts or ends with hyphen
        violation[{"msg": msg}] {
          name := input.review.object.metadata.name
          startswith(name, "-")
          msg := sprintf("Resource name '%v' cannot start with a hyphen", [name])
        }

        violation[{"msg": msg}] {
          name := input.review.object.metadata.name
          endswith(name, "-")
          msg := sprintf("Resource name '%v' cannot end with a hyphen", [name])
        }
