# =============================================================================
# SynergyMesh Governance - Auto Comment Policies
# 81-auto-comment: Policy Definitions
# =============================================================================

apiVersion: governance.synergymesh.io/v2
kind: PolicyDefinition
metadata:
  id: "81-auto-comment-policies"
  name: "自動評論策略定義"
  name_en: "Auto Comment Policy Definitions"
  version: "1.0.0"
  dimension: "81-auto-comment"

# =============================================================================
# COMMENT GENERATION POLICIES
# =============================================================================
policies:
  comment_generation:
    id: "POL-81-001"
    name: "Comment Generation Policy"
    description: "定義自動評論生成的規則與限制"
    enforcement: required
    rules:
      - id: "CG-001"
        name: "Comment Size Limit"
        description: "評論大小限制"
        condition: "comment.size < 65536"
        action: "allow"

      - id: "CG-002"
        name: "Markdown Format Required"
        description: "評論必須為 Markdown 格式"
        condition: "comment.format == 'markdown'"
        action: "allow"

      - id: "CG-003"
        name: "Template Validation"
        description: "評論必須基於有效的模板"
        condition: "template.exists && template.valid"
        action: "allow"

  # =============================================================================
  # AUTO-FIX POLICIES
  # =============================================================================
  auto_fix:
    id: "POL-81-002"
    name: "Auto-Fix Policy"
    description: "定義自動修復操作的規則與限制"
    enforcement: required
    rules:
      - id: "AF-001"
        name: "Auto-Fix Error Types"
        description: "僅允許特定類型錯誤的自動修復"
        condition: "error.type in ['eslint', 'prettier', 'yamllint', 'markdownlint']"
        action: "allow_auto_fix"

      - id: "AF-002"
        name: "Protected Branch Protection"
        description: "禁止在受保護分支上執行自動修復"
        condition: "branch not in ['main', 'master', 'production']"
        action: "allow_auto_fix"

      - id: "AF-003"
        name: "Auto-Fix Commit Message"
        description: "自動修復提交必須包含標準化訊息"
        condition: "commit.message starts_with '[auto-fix]'"
        action: "allow"

      - id: "AF-004"
        name: "Manual Review Required"
        description: "特定錯誤類型需要人工審核"
        condition: "error.type in ['typescript_error', 'test_failure', 'security_vulnerability']"
        action: "require_manual_review"

  # =============================================================================
  # EVENT REGISTRY POLICIES
  # =============================================================================
  event_registry:
    id: "POL-81-003"
    name: "Event Registry Policy"
    description: "定義事件記錄的規則"
    enforcement: required
    rules:
      - id: "ER-001"
        name: "Event Record Required"
        description: "所有自動評論必須記錄到事件 registry"
        condition: "always"
        action: "write_event"

      - id: "ER-002"
        name: "Event Fields Required"
        description: "事件記錄必須包含所有必要欄位"
        condition: "event.id && event.type && event.timestamp && event.workflow && event.commit"
        action: "allow"

      - id: "ER-003"
        name: "Auto-Fix Event Tracking"
        description: "自動修復操作必須額外記錄 auto_fixed 欄位"
        condition: "auto_fix.performed"
        action: "add_auto_fixed_field"

  # =============================================================================
  # RATE LIMITING POLICIES
  # =============================================================================
  rate_limiting:
    id: "POL-81-004"
    name: "Rate Limiting Policy"
    description: "防止評論濫用的速率限制"
    enforcement: required
    rules:
      - id: "RL-001"
        name: "Per-PR Comment Limit"
        description: "每個 PR 的評論數量限制"
        condition: "pr.auto_comment_count < 10"
        window: "1h"
        action: "allow"

      - id: "RL-002"
        name: "Duplicate Comment Prevention"
        description: "防止重複評論"
        condition: "not comment.duplicate_exists"
        action: "allow"

  # =============================================================================
  # SECURITY POLICIES
  # =============================================================================
  security:
    id: "POL-81-005"
    name: "Security Policy"
    description: "安全相關的評論策略"
    enforcement: required
    rules:
      - id: "SEC-001"
        name: "Security Vulnerability Disclosure"
        description: "安全漏洞不得在公開評論中暴露詳細資訊"
        condition: "error.type == 'security_vulnerability'"
        action: "redact_sensitive_info"

      - id: "SEC-002"
        name: "Secrets Detection"
        description: "評論內容不得包含 secrets"
        condition: "not comment.contains_secrets"
        action: "allow"

# =============================================================================
# TEMPLATES CONFIGURATION
# =============================================================================
templates:
  ci_failure:
    path: "./templates/ci-failure.md"
    description: "CI 失敗評論模板"
    variables:
      - workflow
      - run_id
      - commit
      - error_message
      - fix_suggestions

  pr_review:
    path: "./templates/pr-review.md"
    description: "PR 審核評論模板"
    variables:
      - review_status
      - issues_found
      - recommendations

  issue_feedback:
    path: "./templates/issue-feedback.md"
    description: "Issue 反饋評論模板"
    variables:
      - issue_number
      - feedback_type
      - details

# =============================================================================
# ERROR PATTERNS
# =============================================================================
error_patterns:
  typescript:
    pattern: "error TS\\d+"
    category: "type_error"
    auto_fixable: false
    template: "ci-failure"

  eslint:
    pattern: "eslint.*error|error.*eslint"
    category: "lint_error"
    auto_fixable: true
    fix_command: "npx eslint --fix ."
    template: "ci-failure"

  prettier:
    pattern: "prettier.*error|Code style issues"
    category: "format_error"
    auto_fixable: true
    fix_command: "npx prettier --write ."
    template: "ci-failure"

  test_failure:
    pattern: "FAILED|FAIL|test.*failed"
    category: "test_error"
    auto_fixable: false
    template: "ci-failure"

  security:
    pattern: "vulnerability|CVE-\\d+|security"
    category: "security_error"
    auto_fixable: false
    template: "ci-failure"
    requires_review: true

# =============================================================================
# AUDIT CONFIGURATION
# =============================================================================
audit:
  enabled: true
  retention: "365d"
  log_level: "info"
  events_to_log:
    - "comment.generated"
    - "comment.posted"
    - "auto_fix.triggered"
    - "auto_fix.completed"
    - "policy.violated"
