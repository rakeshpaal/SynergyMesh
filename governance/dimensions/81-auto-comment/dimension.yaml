# =============================================================================
# SynergyMesh Governance - Dimension Module
# 81-auto-comment: Auto Comment Governance
# =============================================================================
# Machine-First Format: YAML
# Validation: JSON Schema Enforced
# =============================================================================

apiVersion: governance.synergymesh.io/v2
kind: DimensionModule
metadata:
  id: "81-auto-comment"
  name: "自動評論治理"
  name_en: "Auto Comment Governance"
  version: "1.0.0"
  created_at: "2025-12-12T00:00:00Z"
  updated_at: "2025-12-12T00:00:00Z"
  owner: governance-bot
  category: feedback
  tags: ["auto-comment", "ci-feedback", "automation", "governance-feedback"]

spec:
  description: "自動評論引擎、CI 失敗診斷、即時反饋與自動修復機制"

  # Schema reference
  schema:
    path: "./schema.json"
    format: json-schema
    validation: required

  # Policy reference
  policy:
    path: "./policy.rego"
    engine: opa
    enforcement: required

  # Dependencies
  dependencies:
    required: ["39-automation", "71-feedback-loops"]
    optional: ["40-self-healing", "50-monitoring"]

  # Interface definition
  interface:
    inputs:
      - name: workflow_context
        type: object
        required: true
        schema_ref: "#/definitions/workflow_context"
        description: "CI workflow 執行上下文（workflow name, run ID, commit SHA）"
      - name: ci_log
        type: string
        required: false
        schema_ref: "#/definitions/ci_log"
        description: "CI 執行日誌內容"
      - name: error_patterns
        type: array
        required: false
        schema_ref: "#/definitions/error_patterns"
        description: "錯誤模式定義列表"
    outputs:
      - name: comment
        type: object
        schema_ref: "#/definitions/comment"
        description: "生成的評論內容（Markdown 格式）"
      - name: auto_fix_result
        type: object
        schema_ref: "#/definitions/auto_fix_result"
        description: "自動修復結果（如適用）"
      - name: event_record
        type: object
        schema_ref: "#/definitions/event_record"
        description: "寫入 registry 的事件記錄"
    errors:
      - code: "E81001"
        name: "ValidationError"
        description: "Input validation failed"
      - code: "E81002"
        name: "PolicyViolation"
        description: "Policy check failed"
      - code: "E81003"
        name: "DependencyError"
        description: "Required dependency unavailable"
      - code: "E81004"
        name: "CommentGenerationError"
        description: "Failed to generate comment from CI log"
      - code: "E81005"
        name: "AutoFixError"
        description: "Auto-fix operation failed"

  # Behavior contracts
  behavior:
    invariants:
      - "All auto-comments must be auditable"
      - "Auto-fix operations require explicit policy approval"
      - "Events must be written to registry before comment posting"
      - "Comment templates must be validated before use"
    preconditions:
      - "Workflow context must be valid"
      - "CI log must be accessible (if provided)"
      - "Dependencies (39-automation, 71-feedback-loops) must be available"
    postconditions:
      - "Comment is generated in valid Markdown format"
      - "Event record is created in registry.json"
      - "Audit log is generated"
    side_effects:
      - "Generates comment file in output directory"
      - "Appends event to governance/events/registry.json"
      - "May trigger auto-fix operations"
      - "May create new commits (auto-fix)"

  # Lifecycle management
  lifecycle:
    states:
      - pending
      - initializing
      - active
      - degraded
      - maintenance
      - retiring
      - retired
    transitions:
      - from: pending
        to: initializing
        trigger: initialize
      - from: initializing
        to: active
        trigger: activation_complete
      - from: active
        to: degraded
        trigger: health_check_failed
      - from: degraded
        to: active
        trigger: recovery_complete
      - from: active
        to: maintenance
        trigger: maintenance_start
      - from: maintenance
        to: active
        trigger: maintenance_complete
      - from: active
        to: retiring
        trigger: deprecation_start
      - from: retiring
        to: retired
        trigger: retirement_complete

  # Event flow pattern (治理閉環)
  event_flow:
    id: "auto-comment-flow"
    chain:
      - "ci.failed"
      - "auto-comment.triggered"
      - "auto-comment.generated"
      - "auto-comment.posted"
      - "event.registered"
    on_auto_fix:
      - "auto-fix.triggered"
      - "auto-fix.completed"
      - "commit.created"
    closes_at: "feedback.collected"

  # Error classification (錯誤分類)
  error_classification:
    auto_fixable:
      - pattern: "eslint"
        fix_command: "npx eslint --fix ."
        description: "ESLint 格式錯誤"
      - pattern: "prettier"
        fix_command: "npx prettier --write ."
        description: "Prettier 格式錯誤"
      - pattern: "yamllint"
        fix_command: "npx yamllint --fix ."
        description: "YAML 格式錯誤"
      - pattern: "markdownlint"
        fix_command: "npx markdownlint --fix ."
        description: "Markdown 格式錯誤"
    manual_required:
      - pattern: "error TS\\d+"
        description: "TypeScript 型別錯誤"
      - pattern: "FAILED.*test"
        description: "測試失敗"
      - pattern: "security vulnerability"
        description: "安全漏洞"

  # Metrics
  metrics:
    - name: "auto_comment_total"
      type: counter
      description: "Total auto-comments generated"
    - name: "auto_comment_duration_seconds"
      type: histogram
      description: "Comment generation duration in seconds"
    - name: "auto_fix_total"
      type: counter
      description: "Total auto-fix operations"
    - name: "auto_fix_success_rate"
      type: gauge
      description: "Auto-fix success rate (0-1)"
    - name: "auto_comment_errors_total"
      type: counter
      description: "Total errors encountered"

  # Compliance
  compliance:
    frameworks:
      - NIST-AI-RMF
      - ISO-42001
      - DevOps
      - GitOps
    controls:
      - id: "AC-81-001"
        name: "Comment Audit Trail"
        description: "All auto-comments must be recorded in event registry"
      - id: "AC-81-002"
        name: "Auto-Fix Policy Gate"
        description: "Auto-fix operations require policy approval"
    audit_frequency: continuous
    qa_required: true

status: active
