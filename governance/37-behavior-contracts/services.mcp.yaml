# ═══════════════════════════════════════════════════════════════════════════════
#                    Behavior Contract: services.mcp
#                    行為契約：MCP 協議服務
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define expected behaviors for Model Context Protocol (MCP) services
# 用途: 定義模型上下文協議 (MCP) 服務的預期行為
#
# Version: 1.0.0
# Owner: @services-platform
# Last Updated: 2025-12-07
# ═══════════════════════════════════════════════════════════════════════════════

contract:
  module: "services.mcp"
  version: "1.0.0"
  status: "active"
  owner: "@services-platform"

  description: |
    MCP Services provide Model Context Protocol implementation for AI model integration,
    context management, and tool/resource exposure to AI systems.

    MCP 服務提供模型上下文協議實現，用於 AI 模型整合、上下文管理和向 AI 系統公開工具/資源。

# ============================================================================
# API Contracts | API 契約
# ============================================================================

api:
  base_path: "/api/v1/mcp"

  endpoints:
    # ─────────────────────────────────────────────────────────────────────────
    # Server Initialization
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Initialize MCP Server"
      method: POST
      path: "/servers/initialize"

      description: |
        Initialize MCP server with capabilities and configuration.
        使用能力和配置初始化 MCP 伺服器。

      input_schema:
        type: "object"
        required: ["server_name", "protocol_version"]
        properties:
          server_name: { type: "string" }
          protocol_version: { type: "string" }
          capabilities: { type: "object" }

      output_schema:
        type: "object"
        properties:
          server_id: { type: "string" }
          supported_tools: { type: "array" }
          supported_resources: { type: "array" }
          server_info: { type: "object" }

      guarantees:
        - "MCP protocol version validated"
        - "Capabilities registered"
        - "Server ID is unique"

      performance:
        response_time_p50: "< 100ms"
        response_time_p99: "< 300ms"

    # ─────────────────────────────────────────────────────────────────────────
    # Tool Invocation
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Invoke Tool"
      method: POST
      path: "/tools/invoke"

      description: |
        Execute MCP tool with provided arguments.
        使用提供的參數執行 MCP 工具。

      input_schema:
        type: "object"
        required: ["tool_name", "arguments"]
        properties:
          tool_name: { type: "string" }
          arguments: { type: "object" }
          context: { type: "object" }

      output_schema:
        type: "object"
        properties:
          result: { type: "object" }
          content: { type: "array" }
          is_error: { type: "boolean" }

      guarantees:
        - "Tool execution is sandboxed"
        - "Errors are structured"
        - "Context is preserved"

      performance:
        response_time_p50: "< 200ms"
        response_time_p99: "< 1s"

    # ─────────────────────────────────────────────────────────────────────────
    # Resource Access
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Read Resource"
      method: GET
      path: "/resources/{resource_uri}"

      description: "Access MCP resource by URI"

      output_schema:
        type: "object"
        properties:
          uri: { type: "string" }
          content: { type: "string" }
          mime_type: { type: "string" }
          metadata: { type: "object" }

      guarantees:
        - "Resource permissions checked"
        - "Content type validated"
        - "URI format validated"

      performance:
        response_time_p50: "< 50ms"
        response_time_p99: "< 200ms"

    # ─────────────────────────────────────────────────────────────────────────
    # Context Management
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Update Context"
      method: PUT
      path: "/context"

      description: |
        Update AI model context.
        更新 AI 模型上下文。

      input_schema:
        type: "object"
        required: ["context_id", "updates"]
        properties:
          context_id: { type: "string" }
          updates: { type: "object" }
          merge_strategy: { type: "string", enum: ["replace", "merge", "append"] }

      output_schema:
        type: "object"
        properties:
          context_id: { type: "string" }
          version: { type: "string" }
          size_bytes: { type: "integer" }

      guarantees:
        - "Context size limits enforced"
        - "Version tracking"
        - "Atomic updates"

    # ─────────────────────────────────────────────────────────────────────────
    # Prompt Management
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Get Prompt"
      method: GET
      path: "/prompts/{prompt_name}"

      description: "Retrieve MCP prompt template"

      output_schema:
        type: "object"
        properties:
          name: { type: "string" }
          description: { type: "string" }
          arguments: { type: "array" }
          messages: { type: "array" }

      guarantees:
        - "Prompt templates are validated"
        - "Arguments schema provided"

    # ─────────────────────────────────────────────────────────────────────────
    # List Available Tools
    # ─────────────────────────────────────────────────────────────────────────
    - name: "List Tools"
      method: GET
      path: "/tools"

      description: |
        List all available MCP tools and their capabilities.
        列出所有可用的 MCP 工具及其功能。

      input_schema:
        type: "object"
        properties:
          category: { type: "string" }
          search: { type: "string" }
          include_deprecated: { type: "boolean", default: false }

      output_schema:
        type: "object"
        properties:
          tools:
            type: "array"
            items:
              type: "object"
              properties:
                name: { type: "string" }
                description: { type: "string" }
                category: { type: "string" }
                input_schema: { type: "object" }
                output_schema: { type: "object" }
                deprecated: { type: "boolean" }
                version: { type: "string" }
          total_count: { type: "integer" }

      guarantees:
        - "All registered tools listed"
        - "Schema information complete"
        - "Deprecated tools filtered by default"

      performance:
        response_time_p50: "< 30ms"
        response_time_p99: "< 100ms"

# ============================================================================
# Event Contracts | 事件契約
# ============================================================================

events:
  - name: "mcp.server_initialized"
    description: "Emitted when MCP server initializes"

    payload_schema:
      type: "object"
      properties:
        server_id: { type: "string" }
        server_name: { type: "string" }
        capabilities: { type: "object" }
        timestamp: { type: "string", format: "date-time" }

    delivery_guarantee: "at-least-once"
    retention: "30 days"

    consumers:
      - "automation.monitoring"
      - "services.audit"

  - name: "mcp.tool_invoked"
    description: "Emitted when MCP tool is invoked"

    payload_schema:
      type: "object"
      properties:
        tool_name: { type: "string" }
        server_id: { type: "string" }
        duration_ms: { type: "number" }
        success: { type: "boolean" }
        timestamp: { type: "string", format: "date-time" }

    delivery_guarantee: "at-least-once"
    retention: "30 days"

    consumers:
      - "automation.monitoring"

  - name: "mcp.resource_accessed"
    description: "Emitted when MCP resource is accessed"

    payload_schema:
      type: "object"
      properties:
        resource_uri: { type: "string" }
        server_id: { type: "string" }
        access_granted: { type: "boolean" }
        timestamp: { type: "string", format: "date-time" }

    delivery_guarantee: "at-least-once"
    retention: "90 days"

    consumers:
      - "services.audit"
      - "services.security"

# ============================================================================
# Invariants | 不變條件
# ============================================================================

invariants:
  - name: "Protocol Compliance"
    description: "All interactions follow MCP specification"
    rule: "forall interaction: complies_with(interaction, MCP_spec)"
    enforcement: "pre-condition"

  - name: "Tool Sandboxing"
    description: "Tool executions are isolated"
    rule: "forall tool_exec: isolated(tool_exec)"
    enforcement: "runtime"

  - name: "Context Size Limit"
    description: "Context size within limits"
    rule: "forall context: context.size <= max_context_size"
    enforcement: "pre-condition"

  - name: "Resource Permission"
    description: "Resource access requires permission"
    rule: "forall access: has_permission(access.user, access.resource)"
    enforcement: "pre-condition"

# ============================================================================
# Failure Modes | 失敗模式
# ============================================================================

failure_modes:
  - scenario: "Tool Execution Failure"
    triggers:
      - "Tool timeout"
      - "Tool error"
    recovery:
      - "Return structured error"
      - "Log for debugging"
      - "Maintain server state"
    error_code: "ERR_TOOL_FAILED"

  - scenario: "Resource Not Found"
    triggers:
      - "Invalid URI"
      - "Resource deleted"
    recovery:
      - "Return 404 with suggestions"
      - "Log access attempt"
    error_code: "ERR_RESOURCE_NOT_FOUND"

  - scenario: "Context Overflow"
    triggers:
      - "Context size exceeds limit"
    recovery:
      - "Reject update"
      - "Suggest context pruning"
    error_code: "ERR_CONTEXT_OVERFLOW"

# ============================================================================
# Dependencies | 依賴關係
# ============================================================================

dependencies:
  required:
    - module: "core.safety_mechanisms"
      purpose: "Tool execution safety"
      failure_mode: "critical"

    - module: "infrastructure.message_queue"
      purpose: "Event publishing"
      failure_mode: "log-and-continue"

# ============================================================================
# MCP Protocol Compliance | MCP 協議合規
# ============================================================================

mcp_compliance:
  protocol_version: "2024-11-05"
  supported_features:
    - "tools"
    - "resources"
    - "prompts"
    - "context"

  limits:
    max_context_size: "1MB"
    max_tool_execution_time: "30s"
    max_concurrent_requests: 1000

# ============================================================================
# Monitoring & Observability | 監控與可觀測性
# ============================================================================

observability:
  metrics:
    - name: "mcp_servers_active"
      type: "gauge"
    - name: "mcp_tool_invocations_total"
      type: "counter"
      labels: ["tool_name", "server_id", "status"]
    - name: "mcp_tool_duration_seconds"
      type: "histogram"
    - name: "mcp_resource_accesses_total"
      type: "counter"
      labels: ["resource_type", "status"]
    - name: "mcp_context_size_bytes"
      type: "histogram"

  alerts:
    - condition: "mcp_tool_failure_rate > 10%"
      severity: "high"
    - condition: "mcp_tool_duration_seconds.p99 > 5s"
      severity: "warning"
    - condition: "mcp_context_overflow_total > 100/hour"
      severity: "warning"

# ============================================================================
# References | 參考
# ============================================================================

references:
  mcp_specification: "https://spec.modelcontextprotocol.io/"
  ownership_map: "governance/34-config/ownership-map.yaml#services.mcp"
  architecture_governance_matrix: "governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md"
