# ═══════════════════════════════════════════════════════════════════════════════
#                    Behavior Contract: core.slsa_provenance
#                    行為契約：SLSA 溯源認證
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define expected behaviors for SLSA provenance attestation module
# 用途: 定義 SLSA 溯源認證模組的預期行為
#
# Version: 1.0.0
# Owner: @security-team
# Last Updated: 2025-12-07
# ═══════════════════════════════════════════════════════════════════════════════

contract:
  module: "core.slsa_provenance"
  version: "1.0.0"
  status: "active"
  owner: "@security-team"

  description: |
    SLSA provenance module provides build attestation, provenance generation,
    and signature verification for supply chain security at SLSA Level 3.

    SLSA 溯源模組提供建置認證、溯源生成和簽名驗證，實現 SLSA Level 3
    供應鏈安全。

# ============================================================================
# API Contracts | API 契約
# ============================================================================

api:
  base_path: "/api/v1/provenance"

  endpoints:
    # ─────────────────────────────────────────────────────────────────────────
    # Generate Provenance Attestation
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Generate Provenance"
      method: POST
      path: "/attestations"

      description: |
        Generate SLSA provenance attestation for a build artifact.
        為建置產物生成 SLSA 溯源認證。

      input_schema:
        type: "object"
        required: ["artifact_uri", "builder", "materials"]
        properties:
          artifact_uri:
            type: "string"
            description: "URI of the artifact (e.g., container image)"
          artifact_digest:
            type: "object"
            properties:
              sha256: { type: "string" }
          builder:
            type: "object"
            properties:
              id: { type: "string" }
              version: { type: "string" }
          materials:
            type: "array"
            items:
              type: "object"
              properties:
                uri: { type: "string" }
                digest: { type: "object" }
          metadata:
            type: "object"

      output_schema:
        type: "object"
        properties:
          attestation_id: { type: "string" }
          provenance:
            type: "object"
            description: "SLSA provenance statement"
          signature:
            type: "string"
            description: "Sigstore signature"
          certificate:
            type: "string"
            description: "Signing certificate"
          created_at: { type: "string", format: "date-time" }

      guarantees:
        - "Provenance follows SLSA v1.0 spec"
        - "Signature uses Sigstore/Fulcio"
        - "Certificate includes transparency log entry"
        - "Attestation is immutable after creation"

      error_responses:
        - code: 400
          condition: "Invalid artifact URI or missing required fields"
          message: "ERR_INVALID_INPUT"
        - code: 500
          condition: "Sigstore signing failure"
          message: "ERR_SIGNING_FAILED"

      performance:
        response_time_p50: "< 200ms"
        response_time_p99: "< 1s"

    # ─────────────────────────────────────────────────────────────────────────
    # Verify Provenance
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Verify Provenance"
      method: POST
      path: "/attestations/verify"

      description: |
        Verify provenance attestation signature and certificate.
        驗證溯源認證簽名和證書。

      input_schema:
        type: "object"
        required: ["attestation_id", "artifact_digest"]
        properties:
          attestation_id: { type: "string" }
          artifact_digest:
            type: "object"
            properties:
              sha256: { type: "string" }

      output_schema:
        type: "object"
        properties:
          verified: { type: "boolean" }
          trust_level: { type: "string", enum: ["high", "medium", "low"] }
          certificate_valid: { type: "boolean" }
          transparency_log_verified: { type: "boolean" }
          verification_time: { type: "string", format: "date-time" }

      guarantees:
        - "Signature verification uses public Sigstore infrastructure"
        - "Certificate chain is validated"
        - "Transparency log entry is checked"
        - "Verification is deterministic"

      performance:
        response_time_p50: "< 100ms"
        response_time_p99: "< 500ms"

    # ─────────────────────────────────────────────────────────────────────────
    # Get Attestation
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Get Attestation"
      method: GET
      path: "/attestations/{attestation_id}"

      description: "Retrieve provenance attestation by ID"

      output_schema:
        type: "object"
        properties:
          attestation_id: { type: "string" }
          artifact_uri: { type: "string" }
          provenance: { type: "object" }
          signature: { type: "string" }
          certificate: { type: "string" }
          created_at: { type: "string", format: "date-time" }

      guarantees:
        - "Returns complete attestation bundle"
        - "Data is immutable"

      performance:
        response_time_p50: "< 50ms"
        response_time_p99: "< 200ms"
        cache_ttl: "indefinite"

# ============================================================================
# Event Contracts | 事件契約
# ============================================================================

events:
  - name: "provenance.generated"
    description: "Emitted when provenance attestation is generated"

    payload_schema:
      type: "object"
      required: ["attestation_id", "artifact_uri"]
      properties:
        attestation_id: { type: "string" }
        artifact_uri: { type: "string" }
        artifact_digest: { type: "object" }
        builder_id: { type: "string" }
        timestamp: { type: "string", format: "date-time" }

    delivery_guarantee: "at-least-once"
    ordering: "per-artifact"
    retention: "90 days"

    consumers:
      - "core.contract_service"
      - "services.audit"
      - "automation.monitoring"

  - name: "provenance.verification_failed"
    description: "Emitted when provenance verification fails"

    payload_schema:
      type: "object"
      properties:
        attestation_id: { type: "string" }
        artifact_uri: { type: "string" }
        failure_reason: { type: "string" }
        timestamp: { type: "string", format: "date-time" }

    delivery_guarantee: "at-least-once"
    retention: "30 days"

    consumers:
      - "services.security"
      - "ops.alerting"

# ============================================================================
# Invariants | 不變條件
# ============================================================================

invariants:
  - name: "Immutable Attestations"
    description: "Provenance attestations cannot be modified after creation"
    rule: "forall a in attestations: a.provenance is immutable"
    enforcement: "database-constraint"

  - name: "SLSA v1.0 Compliance"
    description: "All attestations follow SLSA v1.0 specification"
    rule: "forall a in attestations: validates_against(a.provenance, SLSA_v1_schema)"
    enforcement: "pre-condition"

  - name: "Sigstore Signatures"
    description: "All signatures use Sigstore infrastructure"
    rule: "forall a in attestations: a.signature.method = 'sigstore'"
    enforcement: "application-logic"

  - name: "Transparency Log Entry"
    description: "All attestations have transparency log entry"
    rule: "forall a in attestations: exists t in transparency_log where t.attestation_id = a.id"
    enforcement: "post-condition"

# ============================================================================
# Failure Modes | 失敗模式
# ============================================================================

failure_modes:
  - scenario: "Sigstore Service Unavailable"
    triggers:
      - "Sigstore API timeout"
      - "Network connectivity issues"
    recovery:
      - "Retry with exponential backoff"
      - "Cache signing requests for later"
      - "Alert security team"
      - "Return 503 with retry-after header"
    error_code: "ERR_SIGSTORE_UNAVAILABLE"
    degraded_mode: true

  - scenario: "Invalid Certificate Chain"
    triggers:
      - "Certificate expired"
      - "CA not trusted"
    recovery:
      - "Log security event"
      - "Return verification failure"
      - "Alert security team immediately"
    error_code: "ERR_INVALID_CERTIFICATE"

  - scenario: "Transparency Log Verification Failed"
    triggers:
      - "Log entry not found"
      - "Log entry mismatch"
    recovery:
      - "Mark attestation as untrusted"
      - "Alert security team"
      - "Return verification failure"
    error_code: "ERR_TRANSPARENCY_LOG_FAILED"

# ============================================================================
# Dependencies | 依賴關係
# ============================================================================

dependencies:
  required:
    - module: "external.sigstore"
      purpose: "Signature generation and verification"
      api_version: "cosign v2.x"
      failure_mode: "critical"

    - module: "infrastructure.database"
      purpose: "Store attestations"
      type: "PostgreSQL 14+"
      failure_mode: "critical"

  optional:
    - module: "services.audit"
      purpose: "Audit logging"
      failure_mode: "log-and-continue"

# ============================================================================
# Testing Requirements | 測試要求
# ============================================================================

testing:
  unit_tests:
    coverage_min: 85
    critical_paths:
      - "Attestation generation"
      - "Signature verification"
      - "Certificate validation"

  integration_tests:
    required:
      - "End-to-end attestation flow with Sigstore"
      - "Verification with real certificates"
      - "Transparency log integration"

  security_tests:
    required:
      - "Signature forgery attempts"
      - "Certificate tampering detection"
      - "Replay attack prevention"

# ============================================================================
# Security & Compliance | 安全與合規
# ============================================================================

security:
  slsa_level: 3

  security_controls:
    - "All signatures use ephemeral keys via Sigstore"
    - "Certificates include OIDC identity"
    - "Transparency log provides non-repudiation"
    - "No long-lived signing keys stored"

  compliance:
    - "SLSA Level 3"
    - "NIST 800-53"
    - "Supply Chain Security Best Practices"

# ============================================================================
# Monitoring & Observability | 監控與可觀測性
# ============================================================================

observability:
  metrics:
    - name: "provenance_generation_total"
      type: "counter"
      labels: ["status"]
    - name: "provenance_generation_duration_seconds"
      type: "histogram"
    - name: "provenance_verification_total"
      type: "counter"
      labels: ["result"]
    - name: "sigstore_api_errors"
      type: "counter"

  logs:
    level: "INFO"
    security_events: "WARN"
    structured: true
    retention: "90 days"

  alerts:
    - condition: "sigstore_api_errors > 10/hour"
      severity: "critical"
    - condition: "provenance_verification_failures > 5/hour"
      severity: "high"

# ============================================================================
# References | 參考
# ============================================================================

references:
  slsa_spec: "https://slsa.dev/spec/v1.0/"
  sigstore_docs: "https://docs.sigstore.dev/"
  ownership_map: "governance/34-config/ownership-map.yaml#core.slsa_provenance"
