# ═══════════════════════════════════════════════════════════════════════════════
#                    Behavior Contract: core.contract_service.L1
#                    行為契約：核心合約服務 L1
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define expected behaviors, APIs, events, and invariants for the
#          Contract Service L1 module
# 用途: 定義合約服務 L1 模組的預期行為、API、事件和不變條件
#
# Version: 1.0.0
# Owner: @core-platform-team
# Last Updated: 2025-12-07
# ═══════════════════════════════════════════════════════════════════════════════

contract:
  module: "core.contract_service.L1"
  version: "1.0.0"
  status: "active"
  owner: "@core-platform-team"

  description: |
    The Contract Service L1 provides contract lifecycle management,
    signature verification, and SLSA provenance attestation.

    合約服務 L1 提供合約生命週期管理、簽名驗證和 SLSA 溯源認證。

# ============================================================================
# API Contracts | API 契約
# ============================================================================

api:
  base_path: "/api/v1/contracts"

  endpoints:
    # ─────────────────────────────────────────────────────────────────────────
    # Create Contract
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Create Contract"
      method: POST
      path: "/contracts"

      description: |
        Create a new contract with signature verification and provenance attestation.
        創建新合約，包含簽名驗證和溯源認證。

      input_schema:
        type: "object"
        required: ["content", "signature", "metadata"]
        properties:
          content:
            type: "string"
            description: "Contract content in structured format"
          signature:
            type: "object"
            properties:
              algorithm: { type: "string", enum: ["RSA-SHA256", "ECDSA-SHA256"] }
              value: { type: "string" }
              public_key: { type: "string" }
          metadata:
            type: "object"
            properties:
              creator: { type: "string" }
              timestamp: { type: "string", format: "date-time" }
              tags: { type: "array", items: { type: "string" } }

      output_schema:
        type: "object"
        properties:
          contract_id:
            type: "string"
            description: "Unique contract identifier (UUID v4)"
          status: { type: "string", enum: ["created", "verified", "failed"] }
          provenance_url: { type: "string", format: "uri" }
          created_at: { type: "string", format: "date-time" }

      guarantees:
        - "Contract ID is globally unique (UUID v4)"
        - "Timestamp is monotonically increasing within single process"
        - "Signature is verified before storage"
        - "Provenance attestation is created and stored"
        - "Transaction is atomic (all-or-nothing)"

      error_responses:
        - code: 400
          condition: "Invalid signature or malformed input"
          message: "ERR_INVALID_SIGNATURE or ERR_MALFORMED_INPUT"
        - code: 409
          condition: "Contract with same content hash already exists"
          message: "ERR_DUPLICATE_CONTRACT"
        - code: 500
          condition: "Internal server error or database failure"
          message: "ERR_INTERNAL_ERROR"

      performance:
        response_time_p50: "< 100ms"
        response_time_p99: "< 500ms"
        throughput: "> 1000 req/s"

    # ─────────────────────────────────────────────────────────────────────────
    # Get Contract
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Get Contract"
      method: GET
      path: "/contracts/{contract_id}"

      description: |
        Retrieve a contract by its unique identifier.
        根據唯一識別碼檢索合約。

      input_schema:
        type: "object"
        properties:
          contract_id:
            type: "string"
            description: "Unique contract identifier"

      output_schema:
        type: "object"
        properties:
          contract_id: { type: "string" }
          content: { type: "string" }
          signature: { type: "object" }
          metadata: { type: "object" }
          provenance: { type: "object" }
          created_at: { type: "string", format: "date-time" }
          updated_at: { type: "string", format: "date-time" }

      guarantees:
        - "Returns consistent data for same contract_id"
        - "Includes full provenance chain"
        - "Signature is re-verifiable"

      error_responses:
        - code: 404
          condition: "Contract not found"
          message: "ERR_CONTRACT_NOT_FOUND"
        - code: 500
          condition: "Internal server error"
          message: "ERR_INTERNAL_ERROR"

      performance:
        response_time_p50: "< 50ms"
        response_time_p99: "< 200ms"
        cache_ttl: "5 minutes"

    # ─────────────────────────────────────────────────────────────────────────
    # Verify Contract Signature
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Verify Contract Signature"
      method: POST
      path: "/contracts/{contract_id}/verify"

      description: |
        Re-verify the signature of an existing contract.
        重新驗證現有合約的簽名。

      output_schema:
        type: "object"
        properties:
          contract_id: { type: "string" }
          valid: { type: "boolean" }
          verified_at: { type: "string", format: "date-time" }
          verification_details: { type: "object" }

      guarantees:
        - "Uses same algorithm as original verification"
        - "Result is deterministic for same contract"
        - "Does not modify contract state"

      performance:
        response_time_p50: "< 80ms"
        response_time_p99: "< 300ms"

    # ─────────────────────────────────────────────────────────────────────────
    # List Contracts
    # ─────────────────────────────────────────────────────────────────────────
    - name: "List Contracts"
      method: GET
      path: "/contracts"

      description: |
        List contracts with pagination and filtering.
        列出合約，支援分頁和篩選。

      input_schema:
        type: "object"
        properties:
          page: { type: "integer", minimum: 1, default: 1 }
          page_size: { type: "integer", minimum: 1, maximum: 100, default: 20 }
          filter: { type: "object" }
          sort: { type: "string", enum: ["created_at", "updated_at"] }

      output_schema:
        type: "object"
        properties:
          contracts: { type: "array", items: { type: "object" } }
          total_count: { type: "integer" }
          page: { type: "integer" }
          page_size: { type: "integer" }
          has_more: { type: "boolean" }

      guarantees:
        - "Results are ordered by specified sort field"
        - "Pagination is consistent during iteration"
        - "Total count reflects filter criteria"

      performance:
        response_time_p50: "< 150ms"
        response_time_p99: "< 800ms"

# ============================================================================
# Event Contracts | 事件契約
# ============================================================================

events:
  # ─────────────────────────────────────────────────────────────────────────
  # Contract Created Event
  # ─────────────────────────────────────────────────────────────────────────
  - name: "contract.created"
    description: "Emitted when a new contract is successfully created"

    payload_schema:
      type: "object"
      required: ["contract_id", "creator", "created_at"]
      properties:
        contract_id: { type: "string" }
        creator: { type: "string" }
        content_hash: { type: "string" }
        created_at: { type: "string", format: "date-time" }
        metadata: { type: "object" }

    delivery_guarantee: "at-least-once"
    ordering: "per-contract"
    retention: "30 days"

    consumers:
      - "services.billing"
      - "services.audit"
      - "automation.monitoring"

  # ─────────────────────────────────────────────────────────────────────────
  # Contract Verified Event
  # ─────────────────────────────────────────────────────────────────────────
  - name: "contract.verified"
    description: "Emitted when a contract signature is verified"

    payload_schema:
      type: "object"
      required: ["contract_id", "valid", "verified_at"]
      properties:
        contract_id: { type: "string" }
        valid: { type: "boolean" }
        verified_at: { type: "string", format: "date-time" }
        verification_method: { type: "string" }

    delivery_guarantee: "at-least-once"
    ordering: "per-contract"
    retention: "90 days"

    consumers:
      - "services.audit"
      - "core.slsa_provenance"

  # ─────────────────────────────────────────────────────────────────────────
  # Contract Error Event
  # ─────────────────────────────────────────────────────────────────────────
  - name: "contract.error"
    description: "Emitted when contract operation fails"

    payload_schema:
      type: "object"
      required: ["operation", "error_code", "timestamp"]
      properties:
        contract_id: { type: "string", nullable: true }
        operation: { type: "string" }
        error_code: { type: "string" }
        error_message: { type: "string" }
        timestamp: { type: "string", format: "date-time" }

    delivery_guarantee: "at-least-once"
    retention: "7 days"

    consumers:
      - "automation.monitoring"
      - "ops.alerting"

# ============================================================================
# Invariants | 不變條件
# ============================================================================

invariants:
  - name: "Signature Verification Required"
    description: "All contracts must have verified signatures before storage"
    rule: "forall c in contracts: c.signature.verified = true"
    enforcement: "pre-condition"

  - name: "Immutable Contract Content"
    description: "Contract content cannot be modified after creation"
    rule: "forall c in contracts: c.content is immutable"
    enforcement: "database-constraint"

  - name: "Unique Contract IDs"
    description: "Contract IDs must be globally unique"
    rule: "forall c1, c2 in contracts: c1.id != c2.id"
    enforcement: "database-constraint"

  - name: "Monotonic Timestamps"
    description: "Contract timestamps increase monotonically within process"
    rule: "forall c1, c2 in contracts where c1.created_at < c2.created_at: c1.id != c2.id"
    enforcement: "application-logic"

  - name: "Provenance Required"
    description: "All contracts must have associated provenance attestation"
    rule: "forall c in contracts: exists p in provenance where p.contract_id = c.id"
    enforcement: "post-condition"

  - name: "No Final Settlement Modification"
    description: "Contract service never modifies final settlement state"
    rule: "settlement.state is not writable by contract_service"
    enforcement: "access-control"

# ============================================================================
# Failure Modes | 失敗模式
# ============================================================================

failure_modes:
  - scenario: "Invalid Signature"
    triggers:
      - "Signature algorithm not supported"
      - "Public key format invalid"
      - "Signature verification fails"
    recovery:
      - "Return 400 error with details"
      - "Log security event"
      - "Do not store contract"
    error_code: "ERR_INVALID_SIGNATURE"

  - scenario: "Duplicate Contract"
    triggers:
      - "Contract with same content hash exists"
    recovery:
      - "Return 409 error with existing contract ID"
      - "Do not create new contract"
    error_code: "ERR_DUPLICATE_CONTRACT"

  - scenario: "Database Failure"
    triggers:
      - "Database connection lost"
      - "Transaction timeout"
      - "Storage capacity exceeded"
    recovery:
      - "Rollback transaction"
      - "Return 500 error"
      - "Alert operations team"
      - "Retry with exponential backoff"
    error_code: "ERR_DATABASE_FAILURE"

  - scenario: "Provenance Service Unavailable"
    triggers:
      - "SLSA provenance service down"
      - "Attestation generation fails"
    recovery:
      - "Store contract without provenance (degraded mode)"
      - "Queue provenance generation for retry"
      - "Log warning"
      - "Return success with warning flag"
    error_code: "WARN_PROVENANCE_DELAYED"
    degraded_mode: true

# ============================================================================
# Dependencies | 依賴關係
# ============================================================================

dependencies:
  required:
    - module: "core.slsa_provenance"
      purpose: "Generate provenance attestations"
      api_version: "1.x"
      failure_mode: "degraded"

    - module: "infrastructure.database"
      purpose: "Store contract data"
      type: "PostgreSQL 14+"
      failure_mode: "critical"

  optional:
    - module: "services.billing"
      purpose: "Trigger billing events"
      api_version: "1.x"
      failure_mode: "log-and-continue"

# ============================================================================
# Testing Requirements | 測試要求
# ============================================================================

testing:
  unit_tests:
    coverage_min: 85
    critical_paths:
      - "Signature verification logic"
      - "Contract ID generation"
      - "Transaction rollback"

  integration_tests:
    required:
      - "End-to-end contract creation"
      - "Signature verification flow"
      - "Provenance integration"
      - "Database transaction handling"

  performance_tests:
    scenarios:
      - name: "High throughput"
        rps: 1000
        duration: "5 minutes"
      - name: "Large payload"
        payload_size: "1MB"
        response_time_p99: "< 1s"

  chaos_tests:
    scenarios:
      - "Database failure during transaction"
      - "Provenance service unavailable"
      - "Network partition"

# ============================================================================
# Migration & Compatibility | 遷移與兼容性
# ============================================================================

compatibility:
  backward_compatible: true
  breaking_changes: []

  deprecated_features:
    - feature: "Legacy signature algorithm MD5"
      removed_in: "2.0.0"
      migration: "Use RSA-SHA256 or ECDSA-SHA256"

# ============================================================================
# Monitoring & Observability | 監控與可觀測性
# ============================================================================

observability:
  metrics:
    - name: "contract_create_total"
      type: "counter"
      labels: ["status"]
    - name: "contract_create_duration_seconds"
      type: "histogram"
      buckets: [0.01, 0.05, 0.1, 0.5, 1.0]
    - name: "signature_verification_total"
      type: "counter"
      labels: ["valid", "algorithm"]
    - name: "provenance_generation_errors"
      type: "counter"

  logs:
    level: "INFO"
    security_events: "WARN"
    structured: true
    retention: "30 days"

  traces:
    enabled: true
    sample_rate: 0.1
    critical_paths: 1.0

# ============================================================================
# References | 參考
# ============================================================================

references:
  architecture_governance_matrix: "governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md"
  ownership_map: "governance/34-config/ownership-map.yaml"
  api_documentation: "core/contract_service/contracts-L1/API.md"
  source_code: "core/contract_service/contracts-L1/"
