# ═══════════════════════════════════════════════════════════════════════════════
#                    Behavior Contract: automation.intelligent
#                    行為契約：智能自動化
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define expected behaviors for intelligent automation orchestration
# 用途: 定義智能自動化編排的預期行為
#
# Version: 1.0.0
# Owner: @automation-team
# Last Updated: 2025-12-07
# ═══════════════════════════════════════════════════════════════════════════════

contract:
  module: "automation.intelligent"
  version: "1.0.0"
  status: "active"
  owner: "@automation-team"

  description: |
    Intelligent automation provides AI-powered workflow orchestration, task automation,
    and adaptive process optimization across the SynergyMesh platform.

    智能自動化提供 AI 驅動的工作流編排、任務自動化和跨 SynergyMesh 平台的自適應流程優化。

# ============================================================================
# API Contracts | API 契約
# ============================================================================

api:
  base_path: "/api/v1/intelligent-automation"

  endpoints:
    # ─────────────────────────────────────────────────────────────────────────
    # Workflow Orchestration
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Create Workflow"
      method: POST
      path: "/workflows"

      description: |
        Create intelligent workflow with AI-powered optimization.
        創建具有 AI 優化的智能工作流。

      input_schema:
        type: "object"
        required: ["workflow_type", "tasks"]
        properties:
          workflow_type:
            type: "string"
            enum: ["sequential", "parallel", "conditional", "adaptive"]
          tasks: { type: "array" }
          optimization_goals: { type: "array" }
          constraints: { type: "object" }

      output_schema:
        type: "object"
        properties:
          workflow_id: { type: "string" }
          optimized_plan: { type: "object" }
          estimated_duration: { type: "number" }
          estimated_cost: { type: "number" }

      guarantees:
        - "Workflow validated before creation"
        - "Dependencies resolved"
        - "Optimization applied"

      performance:
        response_time_p50: "< 150ms"
        response_time_p99: "< 500ms"

    # ─────────────────────────────────────────────────────────────────────────
    # Execute Workflow
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Execute Workflow"
      method: POST
      path: "/workflows/{workflow_id}/execute"

      description: "Execute intelligent workflow with monitoring"

      input_schema:
        type: "object"
        properties:
          parameters: { type: "object" }
          priority: { type: "string", enum: ["low", "normal", "high"] }

      output_schema:
        type: "object"
        properties:
          execution_id: { type: "string" }
          status: { type: "string" }
          started_at: { type: "string", format: "date-time" }

      guarantees:
        - "Execution tracked end-to-end"
        - "Automatic retry on transient failures"
        - "Progress updates via events"

    # ─────────────────────────────────────────────────────────────────────────
    # Adaptive Optimization
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Optimize Workflow"
      method: POST
      path: "/workflows/{workflow_id}/optimize"

      description: |
        AI-powered workflow optimization based on historical data.
        基於歷史數據的 AI 驅動工作流優化。

      input_schema:
        type: "object"
        properties:
          optimization_criteria: { type: "array" }
          constraints: { type: "object" }

      output_schema:
        type: "object"
        properties:
          optimization_id: { type: "string" }
          improvements: { type: "array" }
          projected_gains: { type: "object" }

      guarantees:
        - "Optimization is non-destructive"
        - "Previous version preserved"
        - "Rollback available"

# ============================================================================
# Event Contracts | 事件契約
# ============================================================================

events:
  - name: "automation.workflow_started"
    description: "Emitted when workflow execution starts"

    payload_schema:
      type: "object"
      properties:
        workflow_id: { type: "string" }
        execution_id: { type: "string" }
        workflow_type: { type: "string" }
        timestamp: { type: "string", format: "date-time" }

    delivery_guarantee: "at-least-once"
    retention: "30 days"

    consumers:
      - "automation.monitoring"
      - "services.audit"

  - name: "automation.workflow_completed"
    description: "Emitted when workflow completes"

    payload_schema:
      type: "object"
      properties:
        execution_id: { type: "string" }
        duration_seconds: { type: "number" }
        tasks_completed: { type: "integer" }
        status: { type: "string" }
        timestamp: { type: "string", format: "date-time" }

    delivery_guarantee: "at-least-once"
    retention: "90 days"

  - name: "automation.optimization_applied"
    description: "Emitted when AI optimization is applied"

    payload_schema:
      type: "object"
      properties:
        workflow_id: { type: "string" }
        optimization_id: { type: "string" }
        improvements: { type: "array" }
        timestamp: { type: "string", format: "date-time" }

    delivery_guarantee: "at-least-once"
    retention: "90 days"

# ============================================================================
# Invariants | 不變條件
# ============================================================================

invariants:
  - name: "Task Dependency Integrity"
    description: "Task dependencies are acyclic"
    rule: "forall workflow: is_acyclic(workflow.task_graph)"
    enforcement: "pre-condition"

  - name: "Optimization Non-Destructive"
    description: "Optimization preserves workflow semantics"
    rule: "forall optimization: equivalent(original, optimized)"
    enforcement: "validation"

  - name: "Execution Idempotency"
    description: "Multiple executions with same input produce same result"
    rule: "execute(w, params) = execute(w, params)"
    enforcement: "application-logic"

# ============================================================================
# Failure Modes | 失敗模式
# ============================================================================

failure_modes:
  - scenario: "Task Failure"
    triggers:
      - "Individual task fails"
      - "Timeout exceeded"
    recovery:
      - "Retry with exponential backoff"
      - "Skip if non-critical"
      - "Rollback if critical"
    error_code: "ERR_TASK_FAILED"

  - scenario: "Resource Exhaustion"
    triggers:
      - "Too many concurrent workflows"
      - "Memory pressure"
    recovery:
      - "Queue workflows"
      - "Scale resources"
      - "Throttle new requests"
    error_code: "ERR_RESOURCE_EXHAUSTION"

# ============================================================================
# Dependencies | 依賴關係
# ============================================================================

dependencies:
  required:
    - module: "core.mind_matrix"
      purpose: "AI-powered optimization"
      failure_mode: "graceful-degradation"

    - module: "infrastructure.workflow_engine"
      purpose: "Workflow execution"
      failure_mode: "critical"

# ============================================================================
# Monitoring & Observability | 監控與可觀測性
# ============================================================================

observability:
  metrics:
    - name: "workflows_active"
      type: "gauge"
    - name: "workflows_total"
      type: "counter"
      labels: ["type", "status"]
    - name: "workflow_duration_seconds"
      type: "histogram"
    - name: "optimization_improvements_percent"
      type: "histogram"

  alerts:
    - condition: "workflow_failure_rate > 10%"
      severity: "high"
    - condition: "workflow_duration_seconds.p99 > threshold"
      severity: "warning"

# ============================================================================
# References | 參考
# ============================================================================

references:
  ownership_map: "governance/34-config/ownership-map.yaml#automation.intelligent"
  architecture_governance_matrix: "governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md"
