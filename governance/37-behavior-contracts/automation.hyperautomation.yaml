# ═══════════════════════════════════════════════════════════════════════════════
#                    Behavior Contract: automation.hyperautomation
#                    行為契約：超自動化治理
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define expected behaviors for hyperautomation governance and UAV/AD systems
# 用途: 定義超自動化治理和 UAV/AD 系統的預期行為
#
# Version: 1.0.0
# Owner: @automation-team
# Last Updated: 2025-12-07
# ═══════════════════════════════════════════════════════════════════════════════

contract:
  module: "automation.hyperautomation"
  version: "1.0.0"
  status: "active"
  owner: "@automation-team"
  
  description: |
    Hyperautomation provides intelligent automation governance, UAV/AD system safety validation,
    policy enforcement, and compliance checking for critical autonomous systems.
    
    超自動化提供智能自動化治理、UAV/AD 系統安全驗證、策略執行和關鍵自主系統的合規檢查。

# ============================================================================
# API Contracts | API 契約
# ============================================================================

api:
  base_path: "/api/v1/hyperautomation"
  
  endpoints:
    
    # ─────────────────────────────────────────────────────────────────────────
    # Policy Validation
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Validate Policy"
      method: POST
      path: "/policies/validate"
      
      description: |
        Validate resources against OPA/Rego and Gatekeeper policies.
        根據 OPA/Rego 和 Gatekeeper 策略驗證資源。
      
      input_schema:
        type: "object"
        required: ["resource", "policy_type"]
        properties:
          resource:
            type: "object"
            description: "Kubernetes resource manifest"
          policy_type:
            type: "string"
            enum: ["opa", "gatekeeper", "both"]
          policies:
            type: "array"
            items: { type: "string" }
          strict_mode: { type: "boolean", default: false }
      
      output_schema:
        type: "object"
        properties:
          validation_id: { type: "string" }
          valid: { type: "boolean" }
          violations: 
            type: "array"
            items:
              type: "object"
              properties:
                policy: { type: "string" }
                severity: { type: "string", enum: ["low", "medium", "high", "critical"] }
                message: { type: "string" }
                location: { type: "string" }
          warnings: { type: "array" }
          timestamp: { type: "string", format: "date-time" }
      
      guarantees:
        - "All applicable policies checked"
        - "Violations include remediation hints"
        - "Validation is deterministic"
        - "Policy evaluation is isolated"
      
      error_responses:
        - code: 400
          condition: "Invalid resource format"
          message: "ERR_INVALID_RESOURCE"
        - code: 404
          condition: "Policy not found"
          message: "ERR_POLICY_NOT_FOUND"
        - code: 500
          condition: "Policy evaluation error"
          message: "ERR_POLICY_EVALUATION_FAILED"
      
      performance:
        response_time_p50: "< 200ms"
        response_time_p99: "< 800ms"
        max_resource_size: "10MB"

    # ─────────────────────────────────────────────────────────────────────────
    # UAV System Registration
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Register UAV System"
      method: POST
      path: "/uav/register"
      
      description: |
        Register UAV/AD system with safety level and geo-fencing configuration.
        註冊 UAV/AD 系統，包含安全等級和地理圍欄配置。
      
      input_schema:
        type: "object"
        required: ["system_id", "system_type", "safety_level"]
        properties:
          system_id: { type: "string" }
          system_type: { type: "string", enum: ["uav", "ad"] }
          safety_level: 
            type: "string"
            enum: ["L0", "L1", "L2", "L3", "L4", "L5"]
            description: "Safety Integrity Level (L0=lowest, L5=highest)"
          risk_category: { type: "string", enum: ["low", "medium", "high"] }
          geo_fencing:
            type: "object"
            properties:
              enabled: { type: "boolean" }
              regions: 
                type: "array"
                items: { type: "string" }
                description: "Format: XX-RegionName (e.g., TW-Taipei)"
          metadata:
            type: "object"
            properties:
              team: { type: "string" }
              environment: { type: "string" }
              domain: { type: "string" }
      
      output_schema:
        type: "object"
        properties:
          registration_id: { type: "string" }
          system_id: { type: "string" }
          status: { type: "string", enum: ["registered", "pending_validation", "rejected"] }
          required_labels:
            type: "object"
            description: "Kubernetes labels required for this system"
          compliance_checklist: { type: "array" }
          registered_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "System ID is globally unique"
        - "Safety level validated against system type"
        - "Geo-fencing validated for UAV systems"
        - "Required labels generated"
      
      error_responses:
        - code: 400
          condition: "Invalid safety level or configuration"
          message: "ERR_INVALID_CONFIGURATION"
        - code: 409
          condition: "System ID already registered"
          message: "ERR_DUPLICATE_SYSTEM_ID"
      
      performance:
        response_time_p50: "< 100ms"
        response_time_p99: "< 300ms"

    # ─────────────────────────────────────────────────────────────────────────
    # Geo-Fencing Validation
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Validate Geo-Fencing"
      method: POST
      path: "/uav/geo-fencing/validate"
      
      description: |
        Validate geo-fencing configuration for UAV systems.
        驗證 UAV 系統的地理圍欄配置。
      
      input_schema:
        type: "object"
        required: ["system_id", "geo_fencing"]
        properties:
          system_id: { type: "string" }
          geo_fencing:
            type: "object"
            properties:
              enabled: { type: "boolean" }
              regions: { type: "array" }
              boundaries:
                type: "object"
                properties:
                  max_altitude: { type: "number" }
                  restricted_zones: { type: "array" }
      
      output_schema:
        type: "object"
        properties:
          validation_id: { type: "string" }
          valid: { type: "boolean" }
          validated_regions:
            type: "array"
            items:
              type: "object"
              properties:
                region: { type: "string" }
                valid: { type: "boolean" }
                issues: { type: "array" }
          recommendations: { type: "array" }
      
      guarantees:
        - "All regions validated against allowed format"
        - "Restricted zones checked"
        - "Altitude limits validated"
      
      performance:
        response_time_p50: "< 150ms"
        response_time_p99: "< 400ms"

    # ─────────────────────────────────────────────────────────────────────────
    # SBOM Generation
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Generate SBOM"
      method: POST
      path: "/sbom/generate"
      
      description: |
        Generate Software Bill of Materials (SBOM) for deployment.
        為部署生成軟體材料清單 (SBOM)。
      
      input_schema:
        type: "object"
        required: ["target", "format"]
        properties:
          target:
            type: "string"
            description: "Path or identifier of deployment"
          format:
            type: "string"
            enum: ["cyclonedx-json", "spdx-json", "syft-json"]
          include_dependencies: { type: "boolean", default: true }
          hash_algorithms:
            type: "array"
            items: { type: "string", enum: ["sha256", "sha3-512", "blake3"] }
            default: ["sha256", "sha3-512"]
      
      output_schema:
        type: "object"
        properties:
          sbom_id: { type: "string" }
          sbom_url: { type: "string", format: "uri" }
          format: { type: "string" }
          component_count: { type: "integer" }
          hashes:
            type: "object"
            description: "SBOM file hashes"
          signature:
            type: "object"
            properties:
              algorithm: { type: "string" }
              value: { type: "string" }
              public_key_url: { type: "string" }
          generated_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "SBOM includes all dependencies"
        - "Dual-hash verification (SHA3-512 + BLAKE3)"
        - "Signature verifiable with public key"
        - "SBOM format compliant with standard"
      
      performance:
        response_time_p50: "< 2s"
        response_time_p99: "< 10s"

    # ─────────────────────────────────────────────────────────────────────────
    # Contract Verification
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Verify File Contract"
      method: POST
      path: "/contracts/verify"
      
      description: |
        Verify file contracts with hash validation.
        驗證文件契約與雜湊值。
      
      input_schema:
        type: "object"
        required: ["contract_file", "files"]
        properties:
          contract_file:
            type: "string"
            description: "Path to file-contract.json"
          files:
            type: "array"
            items:
              type: "object"
              properties:
                path: { type: "string" }
                content: { type: "string" }
          strict: { type: "boolean", default: false }
      
      output_schema:
        type: "object"
        properties:
          verification_id: { type: "string" }
          contract_valid: { type: "boolean" }
          files_verified:
            type: "array"
            items:
              type: "object"
              properties:
                file: { type: "string" }
                hash_match: { type: "boolean" }
                expected_hash: { type: "string" }
                actual_hash: { type: "string" }
                algorithm: { type: "string" }
          mismatches: { type: "array" }
          missing_files: { type: "array" }
      
      guarantees:
        - "All files in contract verified"
        - "Multiple hash algorithms supported"
        - "Verification is deterministic"
      
      performance:
        response_time_p50: "< 300ms"
        response_time_p99: "< 1s"

    # ─────────────────────────────────────────────────────────────────────────
    # Safety Level Assessment
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Assess Safety Level"
      method: POST
      path: "/safety/assess"
      
      description: |
        Assess and recommend safety level for system based on risk analysis.
        根據風險分析評估並推薦系統安全等級。
      
      input_schema:
        type: "object"
        required: ["system_type", "risk_factors"]
        properties:
          system_type: { type: "string", enum: ["uav", "ad", "general"] }
          risk_factors:
            type: "object"
            properties:
              operational_domain: { type: "string" }
              payload_type: { type: "string" }
              max_speed: { type: "number" }
              autonomous_capability: { type: "string" }
              human_interaction: { type: "string" }
          current_safety_level: { type: "string" }
      
      output_schema:
        type: "object"
        properties:
          assessment_id: { type: "string" }
          recommended_safety_level: { type: "string" }
          risk_score: { type: "number", minimum: 0, maximum: 100 }
          risk_category: { type: "string", enum: ["low", "medium", "high"] }
          requirements:
            type: "array"
            items:
              type: "object"
              properties:
                requirement: { type: "string" }
                mandatory: { type: "boolean" }
                rationale: { type: "string" }
          compliance_gaps: { type: "array" }
      
      guarantees:
        - "Assessment based on industry standards"
        - "Risk score calculated consistently"
        - "Recommendations include rationale"
      
      performance:
        response_time_p50: "< 200ms"
        response_time_p99: "< 600ms"

    # ─────────────────────────────────────────────────────────────────────────
    # Emergency Stop Status
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Get Emergency Stop Status"
      method: GET
      path: "/uav/{system_id}/emergency-stop"
      
      description: |
        Get current emergency stop status for UAV system.
        獲取 UAV 系統的當前緊急停止狀態。
      
      input_schema:
        type: "object"
        properties:
          system_id: { type: "string" }
      
      output_schema:
        type: "object"
        properties:
          system_id: { type: "string" }
          emergency_stop_enabled: { type: "boolean" }
          last_updated: { type: "string", format: "date-time" }
          trigger_history:
            type: "array"
            items:
              type: "object"
              properties:
                timestamp: { type: "string", format: "date-time" }
                reason: { type: "string" }
                triggered_by: { type: "string" }
      
      guarantees:
        - "Real-time status"
        - "Complete trigger history"
      
      performance:
        response_time_p50: "< 50ms"
        response_time_p99: "< 150ms"

# ============================================================================
# Event Contracts | 事件契約
# ============================================================================

events:
  
  - name: "hyperautomation.policy_violation"
    description: "Emitted when policy violation detected"
    
    payload_schema:
      type: "object"
      required: ["violation_id", "policy", "severity", "resource"]
      properties:
        violation_id: { type: "string" }
        policy: { type: "string" }
        severity: { type: "string", enum: ["low", "medium", "high", "critical"] }
        resource:
          type: "object"
          properties:
            kind: { type: "string" }
            name: { type: "string" }
            namespace: { type: "string" }
        message: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    ordering: "per-resource"
    retention: "180 days"
    
    consumers:
      - "ops.alerting"
      - "services.governance"
      - "services.audit"

  - name: "hyperautomation.uav_registered"
    description: "Emitted when UAV/AD system is registered"
    
    payload_schema:
      type: "object"
      properties:
        registration_id: { type: "string" }
        system_id: { type: "string" }
        system_type: { type: "string" }
        safety_level: { type: "string" }
        geo_fencing_enabled: { type: "boolean" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "365 days"
    
    consumers:
      - "services.audit"
      - "automation.monitoring"

  - name: "hyperautomation.sbom_generated"
    description: "Emitted when SBOM is generated"
    
    payload_schema:
      type: "object"
      properties:
        sbom_id: { type: "string" }
        target: { type: "string" }
        format: { type: "string" }
        component_count: { type: "integer" }
        hashes: { type: "object" }
        signed: { type: "boolean" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "730 days"
    
    consumers:
      - "services.audit"
      - "core.slsa_provenance"

  - name: "hyperautomation.emergency_stop_triggered"
    description: "Emitted when emergency stop is triggered"
    
    payload_schema:
      type: "object"
      required: ["system_id", "reason", "triggered_by"]
      properties:
        system_id: { type: "string" }
        reason: { type: "string" }
        triggered_by: { type: "string" }
        auto_triggered: { type: "boolean" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "exactly-once"
    ordering: "strict"
    retention: "1825 days"
    priority: "high"
    
    consumers:
      - "ops.alerting"
      - "services.audit"
      - "automation.monitoring"

# ============================================================================
# Invariants | 不變條件
# ============================================================================

invariants:
  
  - name: "Safety Level Ordering"
    description: "Safety levels follow strict ordering (L0 < L1 < ... < L5)"
    rule: "forall level: L0 < L1 < L2 < L3 < L4 < L5"
    enforcement: "validation"
    
  - name: "UAV Geo-Fencing Required"
    description: "UAV systems must have geo-fencing configured"
    rule: "forall uav in uav_systems: uav.geo_fencing.enabled = true"
    enforcement: "pre-condition"
    
  - name: "Policy Validation Determinism"
    description: "Same resource and policy produces same validation result"
    rule: "validate(resource, policy) = validate(resource, policy)"
    enforcement: "application-logic"
    
  - name: "SBOM Dual-Hash"
    description: "All SBOMs must include both SHA3-512 and BLAKE3 hashes"
    rule: "forall sbom: has_hash(sbom, 'sha3-512') AND has_hash(sbom, 'blake3')"
    enforcement: "validation"
    
  - name: "Emergency Stop Immutable History"
    description: "Emergency stop trigger history cannot be modified"
    rule: "forall trigger in history: trigger is immutable"
    enforcement: "database-constraint"
    
  - name: "High-Risk Systems Require L4+"
    description: "High-risk systems must have safety level L4 or L5"
    rule: "forall system where risk_category='high': safety_level >= L4"
    enforcement: "validation"

# ============================================================================
# Failure Modes | 失敗模式
# ============================================================================

failure_modes:
  
  - scenario: "Policy Evaluation Timeout"
    triggers:
      - "Complex policy with large resource"
      - "Policy engine overload"
    recovery:
      - "Return partial validation"
      - "Mark as timeout warning"
      - "Queue for async re-evaluation"
    error_code: "WARN_POLICY_TIMEOUT"
    
  - scenario: "Invalid Geo-Fencing Region"
    triggers:
      - "Region format incorrect"
      - "Region not in allowed list"
    recovery:
      - "Return 400 error with format guidance"
      - "Suggest valid regions"
      - "Do not register system"
    error_code: "ERR_INVALID_REGION"
    
  - scenario: "SBOM Generation Failure"
    triggers:
      - "Target not accessible"
      - "Dependency resolution fails"
    recovery:
      - "Return error with diagnostic info"
      - "Log failure for investigation"
      - "Do not proceed with deployment"
    error_code: "ERR_SBOM_GENERATION_FAILED"
    critical: true
    
  - scenario: "Emergency Stop Communication Failure"
    triggers:
      - "Network partition"
      - "UAV system unreachable"
    recovery:
      - "Retry with exponential backoff"
      - "Escalate to high-priority alert"
      - "Log all attempts"
      - "Assume stop triggered (fail-safe)"
    error_code: "ERR_EMERGENCY_STOP_COMM_FAILURE"
    critical: true

# ============================================================================
# Dependencies | 依賴關係
# ============================================================================

dependencies:
  
  required:
    - module: "governance.policies"
      purpose: "OPA/Rego policy definitions"
      failure_mode: "use-cached"
    
    - module: "core.slsa_provenance"
      purpose: "SBOM signing and attestation"
      failure_mode: "critical"
    
    - module: "infrastructure.policy_engine"
      purpose: "Policy evaluation (OPA/Gatekeeper)"
      type: "OPA 0.60+"
      failure_mode: "critical"
  
  optional:
    - module: "services.audit"
      purpose: "Event audit logging"
      failure_mode: "log-and-continue"

# ============================================================================
# Testing Requirements | 測試要求
# ============================================================================

testing:
  unit_tests:
    coverage_min: 80
    critical_paths:
      - "Policy validation logic"
      - "Safety level assessment"
      - "Geo-fencing validation"
      - "Hash computation"
  
  integration_tests:
    required:
      - "End-to-end policy validation"
      - "UAV system registration flow"
      - "SBOM generation and signing"
      - "Emergency stop trigger"
  
  compliance_tests:
    scenarios:
      - name: "UAV without geo-fencing rejected"
        expected: "Registration fails"
      - name: "High-risk with L3 rejected"
        expected: "Validation fails"
      - name: "SBOM without dual-hash rejected"
        expected: "Generation fails"
  
  chaos_tests:
    scenarios:
      - "Policy engine unavailable"
      - "SBOM signing service down"
      - "Emergency stop communication failure"

# ============================================================================
# Monitoring & Observability | 監控與可觀測性
# ============================================================================

observability:
  metrics:
    - name: "policy_validations_total"
      type: "counter"
      labels: ["policy_type", "result"]
    - name: "policy_validation_duration_seconds"
      type: "histogram"
      buckets: [0.1, 0.5, 1.0, 2.0, 5.0]
    - name: "uav_systems_registered"
      type: "gauge"
      labels: ["system_type", "safety_level"]
    - name: "policy_violations_total"
      type: "counter"
      labels: ["policy", "severity"]
    - name: "sbom_generations_total"
      type: "counter"
      labels: ["format", "status"]
    - name: "emergency_stops_total"
      type: "counter"
      labels: ["system_type", "reason"]
    - name: "geo_fencing_validations_total"
      type: "counter"
      labels: ["valid"]
  
  logs:
    level: "INFO"
    security_events: "WARN"
    emergency_stops: "CRITICAL"
    structured: true
    retention: "365 days"
  
  traces:
    enabled: true
    sample_rate: 0.1
    critical_paths: 1.0
  
  alerts:
    - condition: "policy_violations_total{severity='critical'} > 0"
      severity: "critical"
      action: "Page on-call"
    - condition: "emergency_stops_total > 5 in 1h"
      severity: "high"
      action: "Alert safety team"
    - condition: "policy_validation_duration_seconds.p99 > 5s"
      severity: "warning"
      action: "Investigate performance"

# ============================================================================
# Security & Compliance | 安全與合規
# ============================================================================

security:
  authentication:
    required: true
    methods: ["oauth2", "api_key"]
  
  authorization:
    rbac_required: true
    roles:
      - "policy-validator"
      - "uav-administrator"
      - "sbom-generator"
      - "emergency-operator"
  
  audit:
    enabled: true
    retention: "1825 days"
    immutable: true
    events:
      - "policy_violation"
      - "uav_registered"
      - "emergency_stop_triggered"
      - "safety_level_changed"
  
  encryption:
    at_rest: true
    in_transit: true
    algorithm: "AES-256-GCM"

# ============================================================================
# References | 參考
# ============================================================================

references:
  ownership_map: "governance/34-config/ownership-map.yaml#automation.hyperautomation"
  architecture_governance_matrix: "governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md"
  source_code: "automation/hyperautomation/"
  documentation: "automation/hyperautomation/README.md"
  policies: "automation/hyperautomation/policies/"
  contracts: "automation/hyperautomation/contracts/"
