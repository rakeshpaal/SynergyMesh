# ═══════════════════════════════════════════════════════════════════════════════
#                    Behavior Contract: core.unified_integration
#                    行為契約：核心統一整合層
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define expected behaviors for unified integration orchestrator
# 用途: 定義統一整合編排器的預期行為
#
# Version: 1.0.0
# Owner: @core-platform-team
# Last Updated: 2025-12-07
# ═══════════════════════════════════════════════════════════════════════════════

contract:
  module: "core.unified_integration"
  version: "1.0.0"
  status: "active"
  owner: "@core-platform-team"
  
  description: |
    Unified integration layer orchestrates system bootstrap, service discovery,
    configuration management, and cognitive processing.
    
    統一整合層編排系統啟動、服務發現、配置管理和認知處理。

# ============================================================================
# API Contracts | API 契約
# ============================================================================

api:
  base_path: "/api/v1/integration"
  
  endpoints:
    
    # ─────────────────────────────────────────────────────────────────────────
    # System Bootstrap
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Bootstrap System"
      method: POST
      path: "/bootstrap"
      
      description: |
        Initialize and bootstrap the entire SynergyMesh system.
        初始化並啟動整個 SynergyMesh 系統。
      
      input_schema:
        type: "object"
        properties:
          environment: { type: "string", enum: ["development", "staging", "production"] }
          skip_phases: { type: "array", items: { type: "string" } }
      
      output_schema:
        type: "object"
        properties:
          bootstrap_id: { type: "string" }
          status: { type: "string", enum: ["success", "partial", "failed"] }
          phases_completed: { type: "array" }
          services_started: { type: "integer" }
          bootstrap_time_seconds: { type: "number" }
      
      guarantees:
        - "Bootstrap is idempotent"
        - "Phases execute in defined order"
        - "Failed phases are reported"
        - "System state is consistent after bootstrap"
      
      error_responses:
        - code: 409
          condition: "System already bootstrapped"
          message: "ERR_ALREADY_BOOTSTRAPPED"
        - code: 500
          condition: "Critical phase failed"
          message: "ERR_BOOTSTRAP_FAILED"
      
      performance:
        response_time_p99: "< 5s"
        bootstrap_time_target: "< 10s"

    # ─────────────────────────────────────────────────────────────────────────
    # Service Registration
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Register Service"
      method: POST
      path: "/services"
      
      description: |
        Register a service in the service registry.
        在服務註冊表中註冊服務。
      
      input_schema:
        type: "object"
        required: ["service_id", "endpoint", "health_check"]
        properties:
          service_id: { type: "string" }
          service_name: { type: "string" }
          endpoint: { type: "string", format: "uri" }
          health_check: { type: "string", format: "uri" }
          metadata: { type: "object" }
          dependencies: { type: "array", items: { type: "string" } }
      
      output_schema:
        type: "object"
        properties:
          registration_id: { type: "string" }
          status: { type: "string" }
          registered_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "Service ID is unique within registry"
        - "Health check is validated before registration"
        - "Dependencies are verified"
      
      performance:
        response_time_p50: "< 50ms"
        response_time_p99: "< 200ms"

    # ─────────────────────────────────────────────────────────────────────────
    # Service Discovery
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Discover Service"
      method: GET
      path: "/services/{service_id}"
      
      description: "Discover service endpoint and metadata"
      
      output_schema:
        type: "object"
        properties:
          service_id: { type: "string" }
          endpoint: { type: "string" }
          health_status: { type: "string", enum: ["healthy", "degraded", "unhealthy"] }
          metadata: { type: "object" }
          last_health_check: { type: "string", format: "date-time" }
      
      guarantees:
        - "Returns most recent health status"
        - "Cache coherence < 5 seconds"
        - "Health status is validated"
      
      performance:
        response_time_p50: "< 10ms"
        response_time_p99: "< 50ms"
        cache_ttl: "5 seconds"

    # ─────────────────────────────────────────────────────────────────────────
    # Configuration Management
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Get Configuration"
      method: GET
      path: "/config/{key}"
      
      description: "Retrieve configuration value"
      
      output_schema:
        type: "object"
        properties:
          key: { type: "string" }
          value: { }
          version: { type: "string" }
          last_updated: { type: "string", format: "date-time" }
      
      guarantees:
        - "Configuration is validated against schema"
        - "Version tracking for all changes"
        - "Audit trail maintained"
      
      performance:
        response_time_p50: "< 20ms"
        response_time_p99: "< 100ms"

    - name: "Set Configuration"
      method: PUT
      path: "/config/{key}"
      
      description: "Update configuration value"
      
      input_schema:
        type: "object"
        required: ["value"]
        properties:
          value: { }
          validate_only: { type: "boolean" }
      
      output_schema:
        type: "object"
        properties:
          key: { type: "string" }
          version: { type: "string" }
          updated_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "Schema validation before update"
        - "Atomic update (all-or-nothing)"
        - "Previous value preserved in history"
        - "Drift detection triggered"

    # ─────────────────────────────────────────────────────────────────────────
    # Event Publishing
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Publish Event"
      method: POST
      path: "/events"
      
      description: "Publish event to integration bus"
      
      input_schema:
        type: "object"
        required: ["event_type", "payload"]
        properties:
          event_type: { type: "string" }
          payload: { type: "object" }
          routing_key: { type: "string" }
      
      output_schema:
        type: "object"
        properties:
          event_id: { type: "string" }
          published_at: { type: "string", format: "date-time" }
          subscribers_notified: { type: "integer" }
      
      guarantees:
        - "At-least-once delivery"
        - "Event ordering per routing key"
        - "Publish confirmation"

    # ─────────────────────────────────────────────────────────────────────────
    # Workflow Orchestration
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Execute Workflow"
      method: POST
      path: "/workflows/execute"
      
      description: |
        Execute coordinated workflow across multiple services.
        跨多個服務執行協調的工作流。
      
      input_schema:
        type: "object"
        required: ["workflow_definition", "parameters"]
        properties:
          workflow_definition:
            type: "object"
            properties:
              workflow_id: { type: "string" }
              steps: { type: "array" }
              error_handling: { type: "string", enum: ["fail-fast", "continue", "retry"] }
          parameters: { type: "object" }
          async: { type: "boolean", default: false }
          timeout_seconds: { type: "integer", default: 300 }
      
      output_schema:
        type: "object"
        properties:
          execution_id: { type: "string" }
          status: { type: "string", enum: ["running", "completed", "failed", "timeout"] }
          steps_completed: { type: "integer" }
          results: { type: "object" }
          duration_seconds: { type: "number" }
      
      guarantees:
        - "Steps execute in defined order"
        - "Dependency resolution automatic"
        - "Rollback on failure if configured"
        - "Progress trackable via execution_id"
      
      performance:
        response_time_p50: "< 500ms"
        response_time_p99: "< 2s"

    # ─────────────────────────────────────────────────────────────────────────
    # Dependency Resolution
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Resolve Dependencies"
      method: POST
      path: "/dependencies/resolve"
      
      description: |
        Resolve service dependencies and determine startup order.
        解析服務依賴並確定啟動順序。
      
      input_schema:
        type: "object"
        required: ["service_graph"]
        properties:
          service_graph:
            type: "object"
            description: "Service dependency graph"
          check_health: { type: "boolean", default: true }
      
      output_schema:
        type: "object"
        properties:
          resolution_id: { type: "string" }
          startup_order: 
            type: "array"
            items: { type: "string" }
            description: "Ordered list of services"
          circular_dependencies: { type: "array" }
          missing_dependencies: { type: "array" }
          resolution_time_ms: { type: "number" }
      
      guarantees:
        - "Circular dependencies detected"
        - "Missing dependencies reported"
        - "Topological sort applied"
        - "Resolution is deterministic"
      
      error_responses:
        - code: 400
          condition: "Invalid service graph"
          message: "ERR_INVALID_GRAPH"
        - code: 409
          condition: "Circular dependency detected"
          message: "ERR_CIRCULAR_DEPENDENCY"
      
      performance:
        response_time_p50: "< 100ms"
        response_time_p99: "< 500ms"

    # ─────────────────────────────────────────────────────────────────────────
    # System Health Check
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Check System Health"
      method: GET
      path: "/health/system"
      
      description: |
        Comprehensive system health check across all services.
        跨所有服務的全面系統健康檢查。
      
      input_schema:
        type: "object"
        properties:
          include_metrics: { type: "boolean", default: false }
          timeout_seconds: { type: "integer", default: 10 }
      
      output_schema:
        type: "object"
        properties:
          overall_status: { type: "string", enum: ["healthy", "degraded", "unhealthy"] }
          services:
            type: "array"
            items:
              type: "object"
              properties:
                service_id: { type: "string" }
                status: { type: "string" }
                response_time_ms: { type: "number" }
                last_check: { type: "string", format: "date-time" }
          metrics:
            type: "object"
            properties:
              total_services: { type: "integer" }
              healthy_count: { type: "integer" }
              degraded_count: { type: "integer" }
              unhealthy_count: { type: "integer" }
          checked_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "All registered services checked"
        - "Health status cached appropriately"
        - "Timeout prevents hanging"
        - "Metrics updated atomically"
      
      performance:
        response_time_p50: "< 200ms"
        response_time_p99: "< 1s"
        cache_ttl: "10 seconds"

# ============================================================================
# Event Contracts | 事件契約
# ============================================================================

events:
  
  - name: "integration.system_bootstrapped"
    description: "Emitted when system bootstrap completes"
    
    payload_schema:
      type: "object"
      properties:
        bootstrap_id: { type: "string" }
        environment: { type: "string" }
        phases_completed: { type: "array" }
        services_count: { type: "integer" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    ordering: "global"
    retention: "30 days"
    
    consumers:
      - "automation.monitoring"
      - "services.audit"

  - name: "integration.service_registered"
    description: "Emitted when new service registers"
    
    payload_schema:
      type: "object"
      properties:
        service_id: { type: "string" }
        service_name: { type: "string" }
        endpoint: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "30 days"
    
    consumers:
      - "automation.monitoring"
      - "services.gateway"

  - name: "integration.config_changed"
    description: "Emitted when configuration changes"
    
    payload_schema:
      type: "object"
      properties:
        key: { type: "string" }
        old_version: { type: "string" }
        new_version: { type: "string" }
        changed_by: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "90 days"
    
    consumers:
      - "services.audit"
      - "automation.monitoring"
      - "affected_services"

  - name: "integration.health_degraded"
    description: "Emitted when service health degrades"
    
    payload_schema:
      type: "object"
      properties:
        service_id: { type: "string" }
        previous_status: { type: "string" }
        current_status: { type: "string" }
        reason: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "30 days"
    
    consumers:
      - "ops.alerting"
      - "automation.monitoring"

# ============================================================================
# Invariants | 不變條件
# ============================================================================

invariants:
  
  - name: "Bootstrap Idempotency"
    description: "Multiple bootstrap calls have same effect as one"
    rule: "bootstrap(s) = bootstrap(bootstrap(s))"
    enforcement: "application-logic"
    
  - name: "Service Uniqueness"
    description: "Service IDs are unique in registry"
    rule: "forall s1, s2 in services: s1.id = s2.id implies s1 = s2"
    enforcement: "database-constraint"
    
  - name: "Dependency Resolution"
    description: "Service dependencies must be satisfied"
    rule: "registered(s) implies forall d in s.dependencies: registered(d)"
    enforcement: "pre-condition"
    
  - name: "Configuration Schema Compliance"
    description: "All config values match their schema"
    rule: "forall c in configs: validates(c.value, c.schema)"
    enforcement: "pre-condition"
    
  - name: "Event Ordering Per Key"
    description: "Events with same routing key are ordered"
    rule: "forall e1, e2 where e1.key = e2.key and e1.time < e2.time: delivered(e1) before delivered(e2)"
    enforcement: "messaging-layer"

# ============================================================================
# Failure Modes | 失敗模式
# ============================================================================

failure_modes:
  
  - scenario: "Bootstrap Phase Failure"
    triggers:
      - "Critical phase times out"
      - "Dependency not available"
    recovery:
      - "Roll back completed phases"
      - "Report failed phase"
      - "Maintain system in safe state"
    error_code: "ERR_BOOTSTRAP_PHASE_FAILED"
    
  - scenario: "Service Registry Unavailable"
    triggers:
      - "Redis connection lost"
      - "Cache corruption"
    recovery:
      - "Use last-known-good cache"
      - "Alert operations team"
      - "Attempt reconnection"
    error_code: "ERR_REGISTRY_UNAVAILABLE"
    degraded_mode: true
    
  - scenario: "Configuration Drift Detected"
    triggers:
      - "Config differs from expected"
      - "Schema validation fails"
    recovery:
      - "Alert configuration team"
      - "Log drift details"
      - "Optionally auto-correct"
    error_code: "WARN_CONFIG_DRIFT"

# ============================================================================
# Dependencies | 依賴關係
# ============================================================================

dependencies:
  
  required:
    - module: "infrastructure.redis"
      purpose: "Service registry cache"
      failure_mode: "critical"
    
    - module: "governance.policies"
      purpose: "Configuration schemas"
      failure_mode: "use-cached"
  
  optional:
    - module: "core.monitoring_system"
      purpose: "Health monitoring"
      failure_mode: "log-and-continue"

# ============================================================================
# Performance Characteristics | 性能特徵
# ============================================================================

performance:
  bootstrap:
    target_time: "< 10s"
    max_time: "< 30s"
    
  service_discovery:
    p50: "< 10ms"
    p99: "< 50ms"
    throughput: "> 10000 req/s"
    
  configuration_access:
    p50: "< 20ms"
    p99: "< 100ms"
    cache_hit_rate: "> 95%"

# ============================================================================
# Monitoring & Observability | 監控與可觀測性
# ============================================================================

observability:
  metrics:
    - name: "bootstrap_duration_seconds"
      type: "histogram"
    - name: "services_registered_total"
      type: "gauge"
    - name: "service_discovery_latency_seconds"
      type: "histogram"
    - name: "config_reads_total"
      type: "counter"
    - name: "config_writes_total"
      type: "counter"
    - name: "events_published_total"
      type: "counter"
      labels: ["event_type"]
  
  alerts:
    - condition: "bootstrap_duration_seconds > 30"
      severity: "high"
    - condition: "service_discovery_latency_seconds.p99 > 100ms"
      severity: "warning"

# ============================================================================
# References | 參考
# ============================================================================

references:
  module_spec: "governance/36-modules/core.unified_integration.yaml"
  ownership_map: "governance/34-config/ownership-map.yaml#core.unified_integration"
