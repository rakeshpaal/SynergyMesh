# ═══════════════════════════════════════════════════════════════════════════════
#                    Behavior Contract: automation.autonomous
#                    行為契約：自主系統
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define expected behaviors for autonomous systems (UAV/Drone operations)
# 用途: 定義自主系統（無人機操作）的預期行為
#
# Version: 1.0.0
# Owner: @automation-team
# Last Updated: 2025-12-07
# ═══════════════════════════════════════════════════════════════════════════════

contract:
  module: "automation.autonomous"
  version: "1.0.0"
  status: "active"
  owner: "@automation-team"
  
  description: |
    Autonomous systems module provides UAV/drone control, mission planning,
    path navigation, and safety monitoring for autonomous operations.
    
    自主系統模組提供無人機控制、任務規劃、路徑導航和自主操作的安全監控。

# ============================================================================
# API Contracts | API 契約
# ============================================================================

api:
  base_path: "/api/v1/autonomous"
  
  endpoints:
    
    # ─────────────────────────────────────────────────────────────────────────
    # Mission Planning
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Create Mission"
      method: POST
      path: "/missions"
      
      description: |
        Create and validate a new autonomous mission.
        創建並驗證新的自主任務。
      
      input_schema:
        type: "object"
        required: ["mission_type", "waypoints", "constraints"]
        properties:
          mission_type:
            type: "string"
            enum: ["surveillance", "delivery", "inspection", "mapping"]
          waypoints:
            type: "array"
            items:
              type: "object"
              properties:
                latitude: { type: "number" }
                longitude: { type: "number" }
                altitude: { type: "number" }
                action: { type: "string" }
          constraints:
            type: "object"
            properties:
              max_altitude: { type: "number" }
              no_fly_zones: { type: "array" }
              weather_limits: { type: "object" }
              battery_reserve: { type: "number" }
          metadata:
            type: "object"
      
      output_schema:
        type: "object"
        properties:
          mission_id: { type: "string" }
          status: { type: "string", enum: ["validated", "invalid", "pending_approval"] }
          validation_result:
            type: "object"
            properties:
              safety_check: { type: "boolean" }
              path_feasible: { type: "boolean" }
              regulatory_compliant: { type: "boolean" }
          estimated_duration_seconds: { type: "number" }
          created_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "All waypoints validated for safety"
        - "No-fly zones checked"
        - "Battery capacity verified"
        - "Regulatory compliance validated"
        - "Mission ID is unique"
      
      error_responses:
        - code: 400
          condition: "Invalid waypoints or constraints"
          message: "ERR_INVALID_MISSION"
        - code: 403
          condition: "Mission violates safety constraints"
          message: "ERR_SAFETY_VIOLATION"
        - code: 409
          condition: "Airspace conflict detected"
          message: "ERR_AIRSPACE_CONFLICT"
      
      performance:
        response_time_p50: "< 200ms"
        response_time_p99: "< 1s"

    # ─────────────────────────────────────────────────────────────────────────
    # Mission Execution
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Execute Mission"
      method: POST
      path: "/missions/{mission_id}/execute"
      
      description: |
        Start execution of an approved mission.
        開始執行已批准的任務。
      
      input_schema:
        type: "object"
        properties:
          drone_id: { type: "string" }
          pre_flight_check: { type: "boolean" }
      
      output_schema:
        type: "object"
        properties:
          execution_id: { type: "string" }
          status: { type: "string", enum: ["started", "rejected"] }
          drone_assigned: { type: "string" }
          started_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "Pre-flight safety checks completed"
        - "Drone availability verified"
        - "Emergency abort capability enabled"
        - "Real-time telemetry started"
      
      error_responses:
        - code: 404
          condition: "Mission not found"
          message: "ERR_MISSION_NOT_FOUND"
        - code: 409
          condition: "Mission already executing"
          message: "ERR_MISSION_ACTIVE"
        - code: 503
          condition: "No available drones"
          message: "ERR_NO_DRONES_AVAILABLE"

    # ─────────────────────────────────────────────────────────────────────────
    # Emergency Abort
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Emergency Abort"
      method: POST
      path: "/missions/{mission_id}/abort"
      
      description: |
        Emergency abort of active mission with safe landing.
        緊急中止活動任務並安全降落。
      
      input_schema:
        type: "object"
        required: ["reason"]
        properties:
          reason: { type: "string" }
          return_to_home: { type: "boolean", default: true }
      
      output_schema:
        type: "object"
        properties:
          abort_id: { type: "string" }
          status: { type: "string" }
          landing_site:
            type: "object"
            properties:
              latitude: { type: "number" }
              longitude: { type: "number" }
          abort_initiated_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "Abort command sent immediately"
        - "Safe landing procedure initiated"
        - "All systems notified"
        - "Incident logged for review"
      
      performance:
        response_time_p50: "< 50ms"
        response_time_p99: "< 100ms"
        critical_path: true

    # ─────────────────────────────────────────────────────────────────────────
    # Real-time Telemetry
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Get Telemetry"
      method: GET
      path: "/missions/{mission_id}/telemetry"
      
      description: "Get real-time telemetry for active mission"
      
      output_schema:
        type: "object"
        properties:
          mission_id: { type: "string" }
          drone_id: { type: "string" }
          position:
            type: "object"
            properties:
              latitude: { type: "number" }
              longitude: { type: "number" }
              altitude: { type: "number" }
          speed: { type: "number" }
          heading: { type: "number" }
          battery_level: { type: "number" }
          signal_strength: { type: "number" }
          status: { type: "string" }
          timestamp: { type: "string", format: "date-time" }
      
      guarantees:
        - "Telemetry freshness < 1 second"
        - "Position accuracy within GPS limits"
        - "Battery level accurate"
      
      performance:
        response_time_p50: "< 30ms"
        response_time_p99: "< 100ms"
        update_frequency: "1 Hz minimum"

    # ─────────────────────────────────────────────────────────────────────────
    # Safety Zone Monitoring
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Update Safety Zones"
      method: PUT
      path: "/safety-zones"
      
      description: |
        Update no-fly zones and safety boundaries.
        更新禁飛區和安全邊界。
      
      input_schema:
        type: "object"
        properties:
          no_fly_zones:
            type: "array"
            items:
              type: "object"
              properties:
                zone_id: { type: "string" }
                geometry: { type: "object" }
                active_from: { type: "string", format: "date-time" }
                active_until: { type: "string", format: "date-time" }
      
      output_schema:
        type: "object"
        properties:
          updated: { type: "boolean" }
          active_missions_affected: { type: "integer" }
          zones_count: { type: "integer" }
      
      guarantees:
        - "Active missions checked against new zones"
        - "Conflicts trigger alerts"
        - "Zone updates atomic"

    # ─────────────────────────────────────────────────────────────────────────
    # Path Planning
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Plan Path"
      method: POST
      path: "/missions/{mission_id}/path"
      
      description: |
        Generate optimal path for autonomous mission with obstacle avoidance.
        為自主任務生成避障的最優路徑。
      
      input_schema:
        type: "object"
        required: ["start_point", "end_point"]
        properties:
          mission_id: { type: "string" }
          start_point:
            type: "object"
            properties:
              latitude: { type: "number" }
              longitude: { type: "number" }
              altitude: { type: "number" }
          end_point:
            type: "object"
            properties:
              latitude: { type: "number" }
              longitude: { type: "number" }
              altitude: { type: "number" }
          waypoints: { type: "array" }
          avoid_zones: { type: "array" }
          optimization_goal: { type: "string", enum: ["shortest", "fastest", "safest", "energy-efficient"], default: "safest" }
      
      output_schema:
        type: "object"
        properties:
          path_id: { type: "string" }
          waypoints:
            type: "array"
            items:
              type: "object"
              properties:
                latitude: { type: "number" }
                longitude: { type: "number" }
                altitude: { type: "number" }
                eta: { type: "string", format: "date-time" }
          total_distance_km: { type: "number" }
          estimated_duration_seconds: { type: "number" }
          energy_consumption_estimate: { type: "number" }
          safety_score: { type: "number", minimum: 0, maximum: 100 }
      
      guarantees:
        - "Path avoids all no-fly zones"
        - "Path is collision-free"
        - "Optimization goal respected"
        - "Path is executable within vehicle constraints"
      
      error_responses:
        - code: 400
          condition: "No valid path exists"
          message: "ERR_NO_VALID_PATH"
        - code: 404
          condition: "Mission not found"
          message: "ERR_MISSION_NOT_FOUND"
      
      performance:
        response_time_p50: "< 500ms"
        response_time_p99: "< 2s"

    # ─────────────────────────────────────────────────────────────────────────
    # Mission Monitoring
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Get Mission Status"
      method: GET
      path: "/missions/{mission_id}/status"
      
      description: |
        Get detailed status and progress of autonomous mission.
        獲取自主任務的詳細狀態和進度。
      
      input_schema:
        type: "object"
        properties:
          mission_id: { type: "string" }
          include_telemetry: { type: "boolean", default: true }
          include_logs: { type: "boolean", default: false }
      
      output_schema:
        type: "object"
        properties:
          mission_id: { type: "string" }
          status: { type: "string", enum: ["planned", "in_progress", "paused", "completed", "aborted", "failed"] }
          progress_percent: { type: "number", minimum: 0, maximum: 100 }
          current_waypoint: { type: "integer" }
          total_waypoints: { type: "integer" }
          elapsed_time_seconds: { type: "number" }
          estimated_remaining_seconds: { type: "number" }
          telemetry: { type: "object" }
          events:
            type: "array"
            items:
              type: "object"
              properties:
                event_type: { type: "string" }
                timestamp: { type: "string", format: "date-time" }
                description: { type: "string" }
          logs: { type: "array" }
      
      guarantees:
        - "Status reflects real-time state"
        - "Progress calculation accurate"
        - "Events ordered chronologically"
      
      performance:
        response_time_p50: "< 50ms"
        response_time_p99: "< 200ms"

# ============================================================================
# Event Contracts | 事件契約
# ============================================================================

events:
  
  - name: "autonomous.mission_started"
    description: "Emitted when mission execution starts"
    
    payload_schema:
      type: "object"
      required: ["mission_id", "execution_id", "drone_id"]
      properties:
        mission_id: { type: "string" }
        execution_id: { type: "string" }
        drone_id: { type: "string" }
        mission_type: { type: "string" }
        waypoint_count: { type: "integer" }
        started_at: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    ordering: "per-mission"
    retention: "90 days"
    
    consumers:
      - "services.audit"
      - "automation.monitoring"
      - "ops.mission_control"

  - name: "autonomous.mission_completed"
    description: "Emitted when mission completes successfully"
    
    payload_schema:
      type: "object"
      properties:
        mission_id: { type: "string" }
        execution_id: { type: "string" }
        duration_seconds: { type: "number" }
        waypoints_achieved: { type: "integer" }
        completed_at: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "90 days"
    
    consumers:
      - "services.audit"
      - "ops.mission_control"

  - name: "autonomous.emergency_abort"
    description: "Emitted when mission is emergency aborted"
    
    payload_schema:
      type: "object"
      properties:
        mission_id: { type: "string" }
        drone_id: { type: "string" }
        abort_reason: { type: "string" }
        position_at_abort:
          type: "object"
          properties:
            latitude: { type: "number" }
            longitude: { type: "number" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "180 days"
    
    consumers:
      - "ops.alerting"
      - "services.incident_management"
      - "services.audit"

  - name: "autonomous.safety_violation"
    description: "Emitted when safety constraint is violated"
    
    payload_schema:
      type: "object"
      properties:
        mission_id: { type: "string" }
        violation_type: { type: "string" }
        severity: { type: "string", enum: ["low", "medium", "high", "critical"] }
        description: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "180 days"
    
    consumers:
      - "core.safety_mechanisms"
      - "ops.alerting"
      - "services.incident_management"

  - name: "autonomous.geofence_breach"
    description: "Emitted when drone breaches geofence"
    
    payload_schema:
      type: "object"
      properties:
        drone_id: { type: "string" }
        mission_id: { type: "string" }
        position:
          type: "object"
          properties:
            latitude: { type: "number" }
            longitude: { type: "number" }
        zone_violated: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "180 days"
    
    consumers:
      - "ops.alerting"
      - "core.safety_mechanisms"
      - "services.regulatory_compliance"

# ============================================================================
# Invariants | 不變條件
# ============================================================================

invariants:
  
  - name: "Safety-First Operation"
    description: "Safety constraints always enforced"
    rule: "forall mission: validated(mission.safety_constraints)"
    enforcement: "pre-condition"
    
  - name: "No-Fly Zone Compliance"
    description: "Drones never enter no-fly zones"
    rule: "forall position: not intersects(position, no_fly_zones)"
    enforcement: "runtime-check"
    
  - name: "Battery Reserve Required"
    description: "Minimum battery reserve maintained for return"
    rule: "forall mission: battery_level >= return_to_home_reserve + safety_margin"
    enforcement: "pre-condition + runtime-check"
    
  - name: "Emergency Abort Always Available"
    description: "Abort capability never disabled during flight"
    rule: "forall active_mission: abort_available(mission)"
    enforcement: "application-logic"
    
  - name: "Telemetry Freshness"
    description: "Telemetry data must be recent (with 1s safety margin beyond guarantee)"
    rule: "forall telemetry: now() - telemetry.timestamp < 2 seconds"
    enforcement: "runtime-check"
    note: "Guarantee is < 1s freshness; 2s threshold includes safety margin for alerts"
    
  - name: "Single Active Mission Per Drone"
    description: "One drone cannot execute multiple missions simultaneously"
    rule: "forall drone: count(active_missions(drone)) <= 1"
    enforcement: "database-constraint"
    
  - name: "Mission Immutability During Execution"
    description: "Mission parameters cannot change during flight"
    rule: "forall executing_mission: mission.params is immutable"
    enforcement: "application-logic"

# ============================================================================
# Failure Modes | 失敗模式
# ============================================================================

failure_modes:
  
  - scenario: "Communication Loss"
    triggers:
      - "Telemetry timeout > 5 seconds"
      - "Command acknowledgment failure"
    recovery:
      - "Activate autonomous return-to-home"
      - "Alert mission control"
      - "Log last known position"
      - "Continue monitoring for reconnection"
    error_code: "ERR_COMM_LOSS"
    fail_safe: "return-to-home"
    
  - scenario: "Low Battery Emergency"
    triggers:
      - "Battery < critical threshold"
      - "Insufficient power for return"
    recovery:
      - "Immediate emergency landing at nearest safe site"
      - "Alert mission control"
      - "Broadcast emergency beacon"
    error_code: "ERR_BATTERY_CRITICAL"
    fail_safe: "emergency-landing"
    
  - scenario: "Geofence Breach"
    triggers:
      - "Drone position outside allowed area"
      - "Approaching no-fly zone"
    recovery:
      - "Immediate course correction"
      - "Alert mission control"
      - "Log incident"
      - "If correction fails, abort mission"
    error_code: "ERR_GEOFENCE_BREACH"
    fail_safe: "course-correction-or-abort"
    
  - scenario: "Weather Deterioration"
    triggers:
      - "Wind speed exceeds limits"
      - "Visibility drops below minimum"
    recovery:
      - "Assess mission continuation"
      - "If unsafe, initiate abort"
      - "Return to home or emergency landing"
    error_code: "ERR_WEATHER_UNSAFE"
    fail_safe: "abort-and-return"
    
  - scenario: "Sensor Failure"
    triggers:
      - "GPS signal loss"
      - "Altimeter malfunction"
      - "IMU drift"
    recovery:
      - "Switch to backup sensors"
      - "Reduce speed and altitude"
      - "If critical sensor fails, emergency landing"
    error_code: "ERR_SENSOR_FAILURE"
    fail_safe: "emergency-landing"
    
  - scenario: "Obstacle Detected"
    triggers:
      - "Collision avoidance system alert"
      - "Unexpected obstacle in path"
    recovery:
      - "Immediate hover"
      - "Calculate alternate path"
      - "If no safe path, abort mission"
    error_code: "WARN_OBSTACLE_DETECTED"
    fail_safe: "hover-and-assess"

# ============================================================================
# Dependencies | 依賴關係
# ============================================================================

dependencies:
  
  required:
    - module: "core.safety_mechanisms"
      purpose: "Runtime safety validation"
      failure_mode: "critical"
    
    - module: "services.weather"
      purpose: "Weather data for mission planning"
      failure_mode: "use-cached"
    
    - module: "services.airspace"
      purpose: "No-fly zone data"
      failure_mode: "critical"
  
  optional:
    - module: "services.audit"
      purpose: "Mission logging"
      failure_mode: "log-and-continue"

# ============================================================================
# Safety Requirements | 安全要求
# ============================================================================

safety:
  safety_critical: true
  certification: "ISO 21384 (UAV Safety)"
  
  safety_controls:
    - "Geofence enforcement with 10m buffer"
    - "Battery reserve calculation with 20% margin"
    - "Redundant communication channels"
    - "Automatic return-to-home on failure"
    - "Emergency abort capability"
    - "Real-time collision avoidance"
  
  risk_mitigation:
    - "Pre-flight safety checks mandatory"
    - "Weather conditions validated"
    - "No-fly zones checked continuously"
    - "Operator override capability"
    - "Kill switch available"
  
  compliance:
    - "FAA Part 107 (US)"
    - "EASA regulations (EU)"
    - "Local aviation authority rules"

# ============================================================================
# Testing Requirements | 測試要求
# ============================================================================

testing:
  unit_tests:
    coverage_min: 85
    critical_paths:
      - "Emergency abort logic"
      - "Geofence validation"
      - "Battery reserve calculation"
      - "Safety constraint checking"
  
  integration_tests:
    required:
      - "End-to-end mission execution"
      - "Emergency abort scenarios"
      - "Geofence breach handling"
      - "Communication loss recovery"
  
  simulation_tests:
    required:
      - "Mission planning validation"
      - "Path optimization"
      - "Obstacle avoidance"
      - "Weather impact scenarios"
  
  hardware_tests:
    required:
      - "Real drone communication"
      - "GPS accuracy validation"
      - "Sensor integration"

# ============================================================================
# Monitoring & Observability | 監控與可觀測性
# ============================================================================

observability:
  metrics:
    - name: "missions_active"
      type: "gauge"
    - name: "missions_total"
      type: "counter"
      labels: ["status", "mission_type"]
    - name: "mission_duration_seconds"
      type: "histogram"
    - name: "emergency_aborts_total"
      type: "counter"
      labels: ["reason"]
    - name: "safety_violations_total"
      type: "counter"
      labels: ["type", "severity"]
    - name: "geofence_breaches_total"
      type: "counter"
    - name: "telemetry_latency_seconds"
      type: "histogram"
  
  logs:
    level: "INFO"
    safety_events: "WARN"
    all_aborts: "ERROR"
    structured: true
    retention: "180 days"
  
  traces:
    enabled: true
    sample_rate: 0.1  # 10% for routine operations
    critical_operation_sample_rate: 1.0  # 100% for emergency/safety events
  
  alerts:
    - condition: "missions_active = 0 AND expected > 0"
      severity: "warning"
    - condition: "emergency_aborts_total > 2/hour"
      severity: "critical"
    - condition: "safety_violations_total > 10/hour"
      severity: "high"
    - condition: "geofence_breaches_total > 0"
      severity: "critical"
    - condition: "telemetry_latency_seconds.p99 > 2s"
      severity: "warning"

# ============================================================================
# Operational Procedures | 操作程序
# ============================================================================

operations:
  pre_flight_checklist:
    - "Verify drone battery level"
    - "Check weather conditions"
    - "Validate no-fly zones"
    - "Test communication link"
    - "Confirm emergency procedures"
  
  post_flight_review:
    - "Download flight logs"
    - "Review safety incidents"
    - "Check drone condition"
    - "Update maintenance records"
  
  incident_response:
    - "Immediate: Secure drone and area"
    - "Document incident details"
    - "Notify relevant authorities"
    - "Conduct root cause analysis"
    - "Update safety procedures"

# ============================================================================
# References | 參考
# ============================================================================

references:
  architecture_governance_matrix: "governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md"
  ownership_map: "governance/34-config/ownership-map.yaml#automation.autonomous"
  safety_mechanisms: "governance/37-behavior-contracts/core.safety_mechanisms.yaml"
  regulatory_docs: "docs/autonomous/regulatory-compliance.md"
