# SynergyMesh Audit Event Format
# 審計事件格式定義
#
# This file defines the standard format for audit events in the SynergyMesh platform.
# 本檔案定義 SynergyMesh 平台的審計事件標準格式。

$schema: "https://schema.synergymesh.io/audit-format/v1"
version: "1.0.0"
metadata:
  name: "audit-format"
  description: "審計事件格式定義，支援不可變日誌與完整性鏈"
  owner: "platform-governance"
  created: "2025-11-30"

# =============================================================================
# 事件結構
# Event Structure
# =============================================================================
eventSchema:
  required:
    - eventId         # UUID 唯一識別符
    - timestamp       # ISO 8601 時間戳
    - action          # 動作類型
    - subject         # 主題（被操作的對象）
    - actor           # 執行者
  
  optional:
    - repository      # 倉庫名稱
    - commit          # Git commit SHA
    - workflow        # 工作流名稱
    - runId           # 工作流運行 ID
    - details         # 詳細資訊（自由格式物件）
    - integrity       # 完整性資訊
    - previousHash    # 前一事件的 hash（用於鏈式驗證）

# =============================================================================
# 動作類型
# Action Types
# =============================================================================
actionTypes:
  # 驗證相關
  validation:
    - "validation.started"
    - "validation.passed"
    - "validation.failed"
    - "validation.skipped"
  
  # 策略相關
  policy:
    - "policy.evaluated"
    - "policy.passed"
    - "policy.denied"
    - "policy.exception"
  
  # 自動修復相關
  autofix:
    - "autofix.triggered"
    - "autofix.completed"
    - "autofix.failed"
    - "autofix.pr_created"
  
  # 供應鏈相關
  supplyChain:
    - "sbom.generated"
    - "sbom.validated"
    - "provenance.generated"
    - "provenance.injected"
    - "signature.created"
    - "signature.verified"
    - "signature.failed"
  
  # 索引相關
  index:
    - "index.scanned"
    - "index.generated"
    - "index.updated"
    - "index.validated"
  
  # 系統相關
  system:
    - "pipeline.started"
    - "pipeline.completed"
    - "pipeline.failed"
    - "config.changed"
    - "secret.accessed"

# =============================================================================
# 完整性配置
# Integrity Configuration
# =============================================================================
integrity:
  algorithm: "sha256"
  
  # 鏈式事件：每個事件包含前一事件的 hash
  chainedEvents: true
  
  # 需要計算 hash 的欄位
  hashFields:
    - "eventId"
    - "timestamp"
    - "action"
    - "subject"
    - "actor"
    - "details"
  
  # 驗證規則
  verification:
    checkPreviousHash: true
    allowGaps: false
    alertOnTampering: true

# =============================================================================
# 輸出配置
# Output Configuration
# =============================================================================
output:
  # 主要輸出：JSON Lines 格式（每行一個事件）
  primary:
    format: "jsonl"
    path: "governance/audit/events.jsonl"
    encoding: "utf-8"
  
  # 輪換配置
  rotation:
    maxSize: "10MB"
    maxAge: "90d"
    compress: true
    archivePath: "governance/audit/archive/"
  
  # 備份配置
  backup:
    enabled: true
    frequency: "daily"
    retention: "1y"

# =============================================================================
# 範例事件
# Example Events
# =============================================================================
examples:
  validationPassed:
    eventId: "550e8400-e29b-41d4-a716-446655440000"
    timestamp: "2025-11-30T09:00:00.000Z"
    action: "validation.passed"
    subject: "docs/knowledge_index.yaml"
    actor: "github-actions[bot]"
    repository: "Unmanned-Island-admin/SynergyMesh"
    commit: "abc123def456"
    workflow: "Governance Pipeline"
    runId: "12345678"
    details:
      stage: "schema"
      duration_ms: 1234
      items_validated: 30
    integrity:
      algorithm: "sha256"
      value: "a1b2c3d4e5f6..."
  
  autofixTriggered:
    eventId: "660e8400-e29b-41d4-a716-446655440001"
    timestamp: "2025-11-30T09:05:00.000Z"
    action: "autofix.triggered"
    subject: "governance/23-policies/base-policy.yaml"
    actor: "platform-governance"
    details:
      trigger: "schema_validation_failed"
      error: "Missing required field: version"
      branch: "autofix/fix-policy-schema"
    integrity:
      algorithm: "sha256"
      value: "b2c3d4e5f6g7..."
    previousHash: "a1b2c3d4e5f6..."
