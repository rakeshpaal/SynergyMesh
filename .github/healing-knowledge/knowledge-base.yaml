auto_fix_config:
  allowed_patterns:
  - WF001
  - NPM001
  - NPM002
  cooldown_minutes: 30
  enabled: true
  manual_required:
  - PERM001
  - BUILD001
  - BUILD002
  - TEST001
  max_attempts: 3
  notifications:
    create_issue: true
    issue_labels:
    - ci-failure
    - auto-detected
    mention_maintainers: false
fix_history:
- commit: pending
  date: '2025-12-04'
  description: 修復 hashFiles() 在 job 層級的使用問題
  file: .github/workflows/02-test.yml
  issue_id: WF001
  status: fixed
last_updated: '2025-12-04'
patterns:
- auto_fixable: true
  description: hashFiles() 函數在 job 層級的 if 條件中使用會導致 startup_failure
  detection_regex: ^\s+if:.*hashFiles.*(?<!steps\.)
  error_signature:
  - startup_failure
  - workflow file issue
  example_fix: "# 錯誤用法：\njobs:\n  test:\n    if: ${{ hashFiles('**/*.ts') != '' }}\
    \  # ❌ 這會導致 startup_failure\n    \n# 正確用法：\njobs:\n  detect:\n    outputs:\n \
    \     typescript: ${{ steps.filter.outputs.typescript }}\n    steps:\n      -\
    \ uses: dorny/paths-filter@v3\n        id: filter\n        with:\n          filters:\
    \ |\n            typescript:\n              - '**/*.ts'\n  test:\n    needs: detect\n\
    \    if: ${{ needs.detect.outputs.typescript == 'true' }}  # ✅\n"
  fix_strategy: '將 hashFiles() 條件移到 step 層級，或使用 paths-filter action：

    1. 使用 dorny/paths-filter@v3 在獨立 job 中檢測變更

    2. 將結果作為 output 傳遞給其他 jobs

    3. 在 jobs 的 if 條件中使用 needs.detect.outputs.xxx

    '
  id: WF001
  name: hashFiles in job-level if
  references:
  - https://docs.github.com/en/actions/learn-github-actions/expressions#hashfiles
  - https://github.com/dorny/paths-filter
  severity: critical
- auto_fixable: true
  commands:
  - rm -rf node_modules package-lock.json
  - npm install
  - git add package-lock.json
  description: NPM 安裝失敗，通常由於 lock file 不一致或 registry 問題
  error_signature:
  - npm ERR!
  - ENOENT
  - package-lock.json
  fix_strategy: '1. 刪除 node_modules 和 package-lock.json

    2. 重新執行 npm install

    3. 提交更新後的 package-lock.json

    '
  id: NPM001
  name: npm install failure
  severity: high
- auto_fixable: true
  commands:
  - npm cache clean --force
  - npm install
  description: NPM 緩存損壞或不一致
  error_signature:
  - npm WARN
  - cache
  - integrity
  fix_strategy: '清除 NPM 緩存並重新安裝

    '
  id: NPM002
  name: npm cache issue
  severity: medium
- auto_fixable: false
  description: GITHUB_TOKEN 權限不足
  error_signature:
  - permission denied
  - Resource not accessible
  - '403'
  fix_strategy: "在 workflow 中添加正確的 permissions：\n```yaml\npermissions:\n  contents:\
    \ write\n  pull-requests: write\n  issues: write\n```\n"
  id: PERM001
  manual_steps:
  - 檢查 workflow 的 permissions 設定
  - 確認 repository 的 Actions 設定允許所需權限
  - 考慮使用 PAT (Personal Access Token) 如果需要更高權限
  name: GitHub Token permission
  severity: high
- auto_fixable: false
  description: TypeScript 編譯錯誤
  diagnostics:
  - npx tsc --noEmit
  - npm run lint
  error_signature:
  - error TS
  - Cannot find module
  - Type error
  fix_strategy: '1. 檢查 TypeScript 錯誤訊息

    2. 修復型別錯誤

    3. 確保所有 dependencies 已安裝

    '
  id: BUILD001
  name: TypeScript compilation error
  severity: high
- auto_fixable: false
  description: Rust 編譯錯誤
  diagnostics:
  - cargo check
  - cargo clippy
  error_signature:
  - error[E
  - cargo build
  - cannot find
  fix_strategy: '1. 檢查 Rust 編譯錯誤

    2. 執行 cargo clippy 檢查

    3. 確保 Cargo.lock 是最新的

    '
  id: BUILD002
  name: Rust compilation error
  severity: high
- auto_fixable: false
  description: 測試失敗
  error_signature:
  - FAILED
  - AssertionError
  - Expected
  fix_strategy: '1. 查看失敗的測試案例

    2. 檢查測試邏輯和數據

    3. 確認是否為環境問題

    '
  id: TEST001
  investigation_steps:
  - 查看測試輸出日誌
  - 本地重現問題
  - 檢查最近的程式碼變更
  name: Test failure
  severity: medium
- auto_fixable: false
  description: Job 執行超時
  error_signature:
  - timeout
  - cancelled
  - exceeded
  example_fix: "jobs:\n  build:\n    timeout-minutes: 60  # 預設是 360 分鐘\n    steps:\n\
    \      - name: Long running step\n        timeout-minutes: 30\n"
  fix_strategy: '1. 增加 timeout-minutes 設定

    2. 優化長時間運行的步驟

    3. 考慮拆分為多個 jobs

    '
  id: TIMEOUT001
  name: Job timeout
  severity: medium
preventive_measures:
- description: 在 PR 中自動檢查 workflow 語法
  implementation: '使用 actionlint 在 CI 中驗證 workflow 檔案

    '
  name: Workflow 語法檢查
  tools:
  - actionlint
  - yamllint
- description: 確保依賴版本鎖定
  implementation: '- 提交 package-lock.json

    - 使用 npm ci 而非 npm install

    - 定期更新依賴

    '
  name: 依賴鎖定
- description: 監控測試覆蓋率變化
  implementation: '- 設定覆蓋率閾值

    - 在 PR 中顯示覆蓋率報告

    - 防止覆蓋率下降

    '
  name: 測試覆蓋率監控
version: 1.0.0
