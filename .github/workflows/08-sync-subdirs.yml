name: 08-sync-subdirs

on:
  push:
    branches: [main]
    paths:
      - "templates/**"
      - "island.bootstrap.stage0.yaml"
      - "config/sync-refactor-config.yaml"
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

# Cost protection: prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    timeout-minutes: 10 # Prevent runaway costs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure python dependencies
        run: pip install pyyaml

      - name: Materialize scaffold from manifest
        run: python tools/bootstrap_from_manifest.py island.bootstrap.stage0.yaml --apply --steps scaffold.directories materialize.templates

      - name: Validate YAML syntax
        run: |
          echo "Validating YAML files..."
          yaml_files=$(git diff --name-only --diff-filter=ACM | grep -E '\.(yaml|yml)$' || true)
          if [ -n "$yaml_files" ]; then
            for file in $yaml_files; do
              [ -f "$file" ] && python3 -c "import yaml; yaml.safe_load(open('$file'))" && echo "âœ“ OK: $file" || exit 1
            done
          else
            echo "No YAML files to validate"
          fi

      - name: Commit sync changes
        run: |
          if git status --short | grep -q '.'; then
            git config user.name "island-sync-bot"
            git config user.email "sync-bot@island-ai.io"
            git commit -am "chore: sync scaffold from manifest"
            git push
          else
            echo "No changes detected"
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}
