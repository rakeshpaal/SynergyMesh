name: Reusable Validation Workflow

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Purpose: Reusable workflow for common validation steps
# ç›®çš„: é€šç”¨é©—è­‰æ­¥é©Ÿçš„å¯é‡ç”¨å·¥ä½œæµç¨‹
#
# Usage: Call from other workflows for consistent validation
# ä½¿ç”¨: å¾žå…¶ä»–å·¥ä½œæµç¨‹èª¿ç”¨ä»¥ç¢ºä¿ä¸€è‡´çš„é©—è­‰
#
# Example:
#   jobs:
#     validate:
#       uses: ./.github/workflows/reusable-validation.yml
#       with:
#         validate-yaml: true
#         validate-python: true
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_call:
    inputs:
      # Validation Flags
      validate-yaml:
        description: "Validate YAML files"
        required: false
        type: boolean
        default: true

      validate-json:
        description: "Validate JSON files"
        required: false
        type: boolean
        default: true

      validate-markdown:
        description: "Validate Markdown files"
        required: false
        type: boolean
        default: false

      validate-python:
        description: "Lint and type-check Python code"
        required: false
        type: boolean
        default: false

      validate-typescript:
        description: "Lint and type-check TypeScript code"
        required: false
        type: boolean
        default: false

      # Configuration
      fail-on-error:
        description: "Fail workflow on validation errors"
        required: false
        type: boolean
        default: true

      changed-files-only:
        description: "Only validate changed files"
        required: false
        type: boolean
        default: true

jobs:
  validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Get Changed Files
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Get changed files
        if: inputs.changed-files-only
        id: changed-files
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.sha }}
        run: |
          if [ "$EVENT_NAME" == "pull_request" ]; then
            echo "files=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | tr '\n' ' ')" >> $GITHUB_OUTPUT
          else
            echo "files=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # YAML Validation
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Setup Python for validation
        if: inputs.validate-yaml || inputs.validate-json || inputs.validate-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate YAML syntax
        if: inputs.validate-yaml
        env:
          CHANGED_FILES_ONLY: ${{ inputs.changed-files-only }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        run: |
          echo "## ðŸ“„ YAML Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CHANGED_FILES_ONLY" == "true" ]; then
            yaml_files=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep -E '\.(yaml|yml)$' || true)
          else
            yaml_files=$(find . -type f \( -name "*.yaml" -o -name "*.yml" \) ! -path "*/node_modules/*" ! -path "*/.git/*" || true)
          fi

          if [ -z "$yaml_files" ]; then
            echo "No YAML files to validate" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          validation_failed=0
          for file in $yaml_files; do
            if [ -f "$file" ]; then
              if python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                echo "âœ… \`$file\`" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ \`$file\` - Syntax error" >> $GITHUB_STEP_SUMMARY
                validation_failed=1
              fi
            fi
          done

          if [ $validation_failed -eq 1 ] && [ "${{ inputs.fail-on-error }}" == "true" ]; then
            exit 1
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # JSON Validation
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Validate JSON syntax
        if: inputs.validate-json
        env:
          CHANGED_FILES_ONLY: ${{ inputs.changed-files-only }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        run: |
          echo "## ðŸ“‹ JSON Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CHANGED_FILES_ONLY" == "true" ]; then
            json_files=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep -E '\.json$' || true)
          else
            json_files=$(find . -type f -name "*.json" ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/dist/*" || true)
          fi

          if [ -z "$json_files" ]; then
            echo "No JSON files to validate" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          validation_failed=0
          for file in $json_files; do
            if [ -f "$file" ]; then
              if python3 -c "import json; json.load(open('$file'))" 2>/dev/null; then
                echo "âœ… \`$file\`" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ \`$file\` - Syntax error" >> $GITHUB_STEP_SUMMARY
                validation_failed=1
              fi
            fi
          done

          if [ $validation_failed -eq 1 ] && [ "${{ inputs.fail-on-error }}" == "true" ]; then
            exit 1
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Markdown Validation
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Setup Node.js for Markdown
        if: inputs.validate-markdown
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install markdownlint
        if: inputs.validate-markdown
        run: npm install -g markdownlint-cli

      - name: Validate Markdown
        if: inputs.validate-markdown
        env:
          CHANGED_FILES_ONLY: ${{ inputs.changed-files-only }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        run: |
          echo "## ðŸ“ Markdown Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CHANGED_FILES_ONLY" == "true" ]; then
            md_files=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep -E '\.md$' || true)
          else
            md_files=$(find . -type f -name "*.md" ! -path "*/node_modules/*" ! -path "*/.git/*" || true)
          fi

          if [ -z "$md_files" ]; then
            echo "No Markdown files to validate" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          if [ -f ".markdownlint.json" ]; then
            config_option="--config .markdownlint.json"
          else
            config_option=""
          fi

          if markdownlint $config_option $md_files; then
            echo "âœ… All Markdown files passed validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some Markdown files have issues" >> $GITHUB_STEP_SUMMARY
            if [ "${{ inputs.fail-on-error }}" == "true" ]; then
              exit 1
            fi
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Python Validation
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Install Python linting tools
        if: inputs.validate-python
        run: |
          pip install ruff black mypy

      - name: Validate Python code
        if: inputs.validate-python
        env:
          CHANGED_FILES_ONLY: ${{ inputs.changed-files-only }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        run: |
          echo "## ðŸ Python Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CHANGED_FILES_ONLY" == "true" ]; then
            py_files=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep -E '\.py$' || true)
          else
            py_files=$(find . -type f -name "*.py" ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/venv/*" ! -path "*/.venv/*" || true)
          fi

          if [ -z "$py_files" ]; then
            echo "No Python files to validate" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          validation_failed=0

          # Ruff linting
          echo "### Linting (ruff)" >> $GITHUB_STEP_SUMMARY
          if ruff check $py_files 2>&1 | tee /tmp/ruff.log; then
            echo "âœ… Ruff: No issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Ruff: Issues found" >> $GITHUB_STEP_SUMMARY
            validation_failed=1
          fi

          # Black formatting check
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Formatting (black)" >> $GITHUB_STEP_SUMMARY
          if black --check $py_files 2>&1 | tee /tmp/black.log; then
            echo "âœ… Black: All files formatted correctly" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Black: Some files need formatting" >> $GITHUB_STEP_SUMMARY
            # Don't fail on formatting, just warn
          fi

          if [ $validation_failed -eq 1 ] && [ "${{ inputs.fail-on-error }}" == "true" ]; then
            exit 1
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # TypeScript Validation
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Setup Node.js for TypeScript
        if: inputs.validate-typescript
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Validate TypeScript code
        if: inputs.validate-typescript
        run: |
          echo "## ðŸ“˜ TypeScript Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if TypeScript project exists
          if [ ! -f "tsconfig.json" ] && [ ! -f "package.json" ]; then
            echo "âš ï¸ No TypeScript project configuration found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Install dependencies if needed
          if [ -f "package.json" ]; then
            npm ci --silent || npm install --silent
          fi

          validation_failed=0

          # ESLint
          if [ -f ".eslintrc.yaml" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            echo "### Linting (eslint)" >> $GITHUB_STEP_SUMMARY
            if npm run lint 2>&1 | tee /tmp/eslint.log; then
              echo "âœ… ESLint: No issues found" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ ESLint: Issues found" >> $GITHUB_STEP_SUMMARY
              validation_failed=1
            fi
          fi

          # TypeScript compiler
          if [ -f "tsconfig.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Type Checking (tsc)" >> $GITHUB_STEP_SUMMARY
            if npx tsc --noEmit 2>&1 | tee /tmp/tsc.log; then
              echo "âœ… TypeScript: No type errors" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ TypeScript: Type errors found" >> $GITHUB_STEP_SUMMARY
              validation_failed=1
            fi
          fi

          if [ $validation_failed -eq 1 ] && [ "${{ inputs.fail-on-error }}" == "true" ]; then
            exit 1
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Summary
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Validation Summary
        if: always()
        env:
          VALIDATE_YAML: ${{ inputs.validate-yaml }}
          VALIDATE_JSON: ${{ inputs.validate-json }}
          VALIDATE_MARKDOWN: ${{ inputs.validate-markdown }}
          VALIDATE_PYTHON: ${{ inputs.validate-python }}
          VALIDATE_TYPESCRIPT: ${{ inputs.validate-typescript }}
          CHANGED_FILES_ONLY: ${{ inputs.changed-files-only }}
          FAIL_ON_ERROR: ${{ inputs.fail-on-error }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- YAML: $VALIDATE_YAML" >> $GITHUB_STEP_SUMMARY
          echo "- JSON: $VALIDATE_JSON" >> $GITHUB_STEP_SUMMARY
          echo "- Markdown: $VALIDATE_MARKDOWN" >> $GITHUB_STEP_SUMMARY
          echo "- Python: $VALIDATE_PYTHON" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript: $VALIDATE_TYPESCRIPT" >> $GITHUB_STEP_SUMMARY
          echo "- Changed files only: $CHANGED_FILES_ONLY" >> $GITHUB_STEP_SUMMARY
          echo "- Fail on error: $FAIL_ON_ERROR" >> $GITHUB_STEP_SUMMARY
