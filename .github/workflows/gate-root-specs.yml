name: Gate - Root Specifications Validation

on:
  pull_request:
    paths:
      - 'root.*.yaml'
      - 'root.*.map'
      - 'root.*.sh'
      - 'root.specs.*.yaml'
      - 'root.registry.*.yaml'
  push:
    branches:
      - main
    paths:
      - 'root.*.yaml'
      - 'root.*.map'
      - 'root.*.sh'

jobs:
  validate-root-specs:
    name: Validate Root Layer Specifications
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: üîç Run Naming Validation
        id: naming
        run: |
          echo "## üî§ Naming Specification Validation" >> $GITHUB_STEP_SUMMARY
          
          # Check file naming patterns
          echo "### File Naming Patterns" >> $GITHUB_STEP_SUMMARY
          
          INVALID_FILES=0
          for file in root.*.yaml root.*.map root.*.sh; do
            if [ -f "$file" ]; then
              # Check for uppercase letters
              if echo "$file" | grep -q '[A-Z]'; then
                echo "‚ùå File contains uppercase: $file" >> $GITHUB_STEP_SUMMARY
                INVALID_FILES=$((INVALID_FILES + 1))
              fi
              
              # Check for spaces
              if echo "$file" | grep -q ' '; then
                echo "‚ùå File contains spaces: $file" >> $GITHUB_STEP_SUMMARY
                INVALID_FILES=$((INVALID_FILES + 1))
              fi
              
              # Check for .yml extension
              if echo "$file" | grep -q '\.yml$'; then
                echo "‚ùå File uses .yml instead of .yaml: $file" >> $GITHUB_STEP_SUMMARY
                INVALID_FILES=$((INVALID_FILES + 1))
              fi
            fi
          done
          
          if [ $INVALID_FILES -eq 0 ]; then
            echo "‚úÖ All files pass naming validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Found $INVALID_FILES files with naming violations" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: üîó Run Reference Validation
        id: references
        run: |
          echo "## üîó Reference Specification Validation" >> $GITHUB_STEP_SUMMARY
          
          # Check URN format
          echo "### URN Format Validation" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "root.registry.urns.yaml" ]; then
            INVALID_URNS=$(grep -E "urn:" root.registry.urns.yaml | grep -v "^urn:machinenativeops:" | wc -l)
            
            if [ $INVALID_URNS -eq 0 ]; then
              echo "‚úÖ All URNs use correct namespace" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå Found $INVALID_URNS URNs with incorrect namespace" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "‚ö†Ô∏è URN registry not found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üó∫Ô∏è Run Mapping Validation
        id: mapping
        run: |
          echo "## üó∫Ô∏è Mapping Specification Validation" >> $GITHUB_STEP_SUMMARY
          
          # Check module name consistency
          echo "### Module Name Consistency" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "root.registry.modules.yaml" ]; then
            echo "‚úÖ Module registry found" >> $GITHUB_STEP_SUMMARY
            
            # Extract module names and check for duplicates
            MODULE_COUNT=$(grep -E "^\s+- id:" root.registry.modules.yaml | wc -l)
            UNIQUE_COUNT=$(grep -E "^\s+- id:" root.registry.modules.yaml | sort -u | wc -l)
            
            if [ $MODULE_COUNT -eq $UNIQUE_COUNT ]; then
              echo "‚úÖ No duplicate module IDs found ($MODULE_COUNT modules)" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå Duplicate module IDs detected" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "‚ö†Ô∏è Module registry not found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üß† Run Logic Validation
        id: logic
        run: |
          echo "## üß† Logic Specification Validation" >> $GITHUB_STEP_SUMMARY
          
          # Check for basic YAML syntax
          echo "### YAML Syntax Validation" >> $GITHUB_STEP_SUMMARY
          
          SYNTAX_ERRORS=0
          for file in root.*.yaml; do
            if [ -f "$file" ]; then
              if ! python -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                echo "‚ùå YAML syntax error in: $file" >> $GITHUB_STEP_SUMMARY
                SYNTAX_ERRORS=$((SYNTAX_ERRORS + 1))
              fi
            fi
          done
          
          if [ $SYNTAX_ERRORS -eq 0 ]; then
            echo "‚úÖ All YAML files have valid syntax" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Found $SYNTAX_ERRORS files with syntax errors" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: üåê Run Context Validation
        id: context
        run: |
          echo "## üåê Context Specification Validation" >> $GITHUB_STEP_SUMMARY
          
          # Check apiVersion consistency
          echo "### API Version Consistency" >> $GITHUB_STEP_SUMMARY
          
          API_VERSIONS=$(grep -h "^apiVersion:" root.*.yaml 2>/dev/null | sort -u | wc -l)
          
          if [ $API_VERSIONS -le 2 ]; then
            echo "‚úÖ API versions are consistent ($API_VERSIONS unique versions)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Multiple API versions detected ($API_VERSIONS versions)" >> $GITHUB_STEP_SUMMARY
            grep -h "^apiVersion:" root.*.yaml | sort -u >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üêç Run Python Validator
        id: python-validator
        run: |
          echo "## üêç Python Validator Results" >> $GITHUB_STEP_SUMMARY
          
          chmod +x scripts/validation/validate-root-specs.py
          
          if python scripts/validation/validate-root-specs.py; then
            echo "‚úÖ Python validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Python validation failed" >> $GITHUB_STEP_SUMMARY
            cat root-specs-validation-report.md >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: üìä Generate Summary
        if: always()
        run: |
          echo "## üìä Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.naming.outcome }}" == "success" ] && \
             [ "${{ steps.references.outcome }}" == "success" ] && \
             [ "${{ steps.mapping.outcome }}" == "success" ] && \
             [ "${{ steps.logic.outcome }}" == "success" ] && \
             [ "${{ steps.context.outcome }}" == "success" ] && \
             [ "${{ steps.python-validator.outcome }}" == "success" ]; then
            echo "### ‚úÖ All Validations Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The root layer specifications are compliant with all defined rules." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the errors above and fix the violations before merging." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Failed Checks:" >> $GITHUB_STEP_SUMMARY
            [ "${{ steps.naming.outcome }}" != "success" ] && echo "- ‚ùå Naming Validation" >> $GITHUB_STEP_SUMMARY
            [ "${{ steps.references.outcome }}" != "success" ] && echo "- ‚ùå Reference Validation" >> $GITHUB_STEP_SUMMARY
            [ "${{ steps.mapping.outcome }}" != "success" ] && echo "- ‚ùå Mapping Validation" >> $GITHUB_STEP_SUMMARY
            [ "${{ steps.logic.outcome }}" != "success" ] && echo "- ‚ùå Logic Validation" >> $GITHUB_STEP_SUMMARY
            [ "${{ steps.context.outcome }}" != "success" ] && echo "- ‚ùå Context Validation" >> $GITHUB_STEP_SUMMARY
            [ "${{ steps.python-validator.outcome }}" != "success" ] && echo "- ‚ùå Python Validator" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '## ‚ùå Root Specifications Validation Failed\n\n';
            
            if (fs.existsSync('root-specs-validation-report.md')) {
              report += fs.readFileSync('root-specs-validation-report.md', 'utf8');
            } else {
              report += 'Please check the workflow logs for details.\n';
            }
            
            report += '\n---\n';
            report += '**Action Required:** Please fix the violations and push the changes.\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
      
      - name: üì§ Upload Validation Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: root-specs-validation-report
          path: root-specs-validation-report.md
          retention-days: 30
      
      - name: ‚ùå Fail if Validation Failed
        if: |
          steps.naming.outcome != 'success' ||
          steps.references.outcome != 'success' ||
          steps.mapping.outcome != 'success' ||
          steps.logic.outcome != 'success' ||
          steps.context.outcome != 'success' ||
          steps.python-validator.outcome != 'success'
        run: |
          echo "‚ùå Root specifications validation failed!"
          echo "Please review the errors and fix the violations."
          exit 1