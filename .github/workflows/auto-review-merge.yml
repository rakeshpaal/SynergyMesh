---
name: è‡ªå‹•å¯©æ ¸èˆ‡åˆä½µ

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      pr-number:
        description: "PR ç·¨è™Ÿï¼ˆæ‰‹å‹•è§¸ç™¼æ™‚ä½¿ç”¨ï¼‰"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-review:
    name: ðŸ” è‡ªå‹•å¯©æ ¸
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    outputs:
      review-status: ${{ steps.review.outputs.status }}

    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: ðŸ” æª¢æŸ¥ PR ç‹€æ…‹
        id: pr-check
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.inputs?.['pr-number'];

            if (!prNumber) {
              console.log('ç„¡ PR ç·¨è™Ÿï¼Œè·³éŽå¯©æ ¸');
              return { skip: true };
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            console.log(`PR #${prNumber}: ${pr.title}`);
            console.log(`ç‹€æ…‹: ${pr.state}, å¯åˆä½µ: ${pr.mergeable}`);

            return {
              number: prNumber,
              title: pr.title,
              state: pr.state,
              mergeable: pr.mergeable,
              author: pr.user.login
            };

      - name: ðŸ“Š åŸ·è¡Œè‡ªå‹•å¯©æ ¸
        id: review
        run: |
          echo "ðŸ” åŸ·è¡Œè‡ªå‹•å¯©æ ¸æª¢æŸ¥..."
          echo ""
          echo "âœ… ä»£ç¢¼æª¢å‡ºæˆåŠŸ"
          echo "âœ… PR ç‹€æ…‹æª¢æŸ¥å®Œæˆ"
          echo ""
          echo "status=passed" >> $GITHUB_OUTPUT

  auto-merge:
    name: ðŸ”€ è‡ªå‹•åˆä½µ
    runs-on: ubuntu-latest
    needs: [auto-review]
    if: |
      always() &&
      (needs.auto-review.outputs.review-status == 'passed' || github.event_name == 'pull_request_review')

    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: ðŸ”€ æª¢æŸ¥ä¸¦åŸ·è¡Œè‡ªå‹•åˆä½µ
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.inputs?.['pr-number'];

            if (!prNumber) {
              console.log('ç„¡ PR ç·¨è™Ÿï¼Œè·³éŽåˆä½µ');
              return;
            }

            // ç²å– PR è³‡è¨Š
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // æª¢æŸ¥æ¨™ç±¤
            const hasAutoMergeLabel = pr.labels.some(label => 
              label.name === 'auto-merge' || label.name === 'automerge'
            );

            if (!hasAutoMergeLabel) {
              console.log('PR æ²’æœ‰ auto-merge æ¨™ç±¤ï¼Œè·³éŽè‡ªå‹•åˆä½µ');
              return;
            }

            // æª¢æŸ¥æ‰€æœ‰ CI æ˜¯å¦é€šéŽï¼ˆåŒ…å« check runs å’Œ status checksï¼‰
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            const allCheckRunsPassed = checks.check_runs.every(check => 
              check.status === 'completed' && 
              (check.conclusion === 'success' || check.conclusion === 'skipped')
            );

            const statusPassed = statuses.state === 'success' || statuses.state === 'pending' && statuses.statuses.length === 0;

            if (!allCheckRunsPassed || !statusPassed) {
              console.log('CI æª¢æŸ¥å°šæœªå…¨éƒ¨é€šéŽï¼Œè·³éŽè‡ªå‹•åˆä½µ');
              return;
            }

            // æª¢æŸ¥å¯©æ ¸ç‹€æ…‹ï¼ˆå–æ¯ä½å¯©æ ¸è€…æœ€æ–°çš„å¯©æ ¸çµæžœï¼‰
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // å–æ¯ä½å¯©æ ¸è€…æœ€æ–°çš„å¯©æ ¸ç‹€æ…‹
            const latestReviewByUser = new Map();
            for (const review of reviews) {
              if (review.state === 'APPROVED' || review.state === 'CHANGES_REQUESTED') {
                const existing = latestReviewByUser.get(review.user.login);
                if (!existing || new Date(review.submitted_at) > new Date(existing.submitted_at)) {
                  latestReviewByUser.set(review.user.login, review);
                }
              }
            }

            const hasApproval = Array.from(latestReviewByUser.values()).some(review => review.state === 'APPROVED');
            const hasChangesRequested = Array.from(latestReviewByUser.values()).some(review => review.state === 'CHANGES_REQUESTED');

            if (!hasApproval || hasChangesRequested) {
              console.log('PR å°šæœªç²å¾—æ‰¹å‡†ï¼Œè·³éŽè‡ªå‹•åˆä½µ');
              return;
            }

            // åŸ·è¡Œåˆä½µ
            console.log(`å˜—è©¦åˆä½µ PR #${prNumber}...`);

            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              
              console.log(`âœ… PR #${prNumber} å·²æˆåŠŸåˆä½µ`);
            } catch (error) {
              console.log(`âŒ åˆä½µå¤±æ•—: ${error.message}`);
            }

      - name: ðŸ“Š ç”Ÿæˆæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ”€ è‡ªå‹•å¯©æ ¸èˆ‡åˆä½µå ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| è‡ªå‹•å¯©æ ¸ | ${{ needs.auto-review.outputs.review-status == 'passed' && 'âœ… é€šéŽ' || 'â­ï¸ è·³éŽ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è‡ªå‹•åˆä½µ | å·²æª¢æŸ¥ |" >> $GITHUB_STEP_SUMMARY
