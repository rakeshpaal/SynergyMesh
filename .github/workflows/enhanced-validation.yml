name: ğŸ§  Enhanced Validation with Knowledge Graph

permissions:
  contents: read

on:
  workflow_call:
  pull_request:
    paths:
      - root.*.yaml
      - root.*.map
      - root.*.sh
      - root.specs.*.yaml
      - root.registry.*.yaml
      - controlplane/baseline/**/*.yaml
      - controlplane/baseline/**/*.map
      - controlplane/baseline/**/*.sh
      - workspace/config/**/*.{yaml,yml}
      - controlplane/governance/docs/**/*.md
  push:
    branches: [main]
    paths:
      - root.*.yaml
      - root.*.map
      - root.*.sh
      - controlplane/baseline/**/*.yaml
      - controlplane/baseline/**/*.map
      - controlplane/baseline/**/*.sh

jobs:
  enhanced-validation:
    name: Enhanced Validation + Knowledge Graph
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run original validation
        run: python controlplane/baseline/validation/validate-root-specs.py

      - name: Run enhanced validation with knowledge graph
        run: python controlplane/baseline/validation/enhanced_validator.py

      - name: Run enhanced memory synchronization
        run: python workspace/src/scripts/automation/enhanced_memory_sync.py

      - name: Generate knowledge graph visualization
        run: python workspace/src/scripts/automation/knowledge_graph_visualizer.py

      - name: Upload enhanced validation artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: enhanced-validation-report
          path: |
            controlplane/overlay/evidence/validation/validation.report.md
            controlplane/overlay/evidence/validation/validation.report.json
            controlplane/overlay/evidence/validation/enhanced_validation_report.md
            controlplane/overlay/evidence/validation/enhanced_validation_results.json
            workspace/docs/visualizations/
            workspace/docs/knowledge_graph.json
            workspace/docs/memory_index.json

      - name: Comment enhanced validation result on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'controlplane/overlay/evidence/validation/enhanced_validation_report.md';
            const SUMMARY_CHAR_LIMIT = 15000;
            
            let summary = fs.existsSync(reportPath)
              ? fs.readFileSync(reportPath, 'utf8')
              : 'Enhanced validation report not found.';
            
            if (summary.length > SUMMARY_CHAR_LIMIT) {
              summary = `${summary.slice(0, SUMMARY_CHAR_LIMIT)}\n...(truncated, see workflow artifact for full report)`;
            }
            
            // çŸ¥è­˜åœ–è­œçµ±è¨ˆ
            let kgStats = '';
            const kgPath = 'workspace/docs/knowledge_graph.json';
            if (fs.existsSync(kgPath)) {
              try {
                const kg = JSON.parse(fs.readFileSync(kgPath, 'utf8'));
                const entityCount = Object.keys(kg.entities || {}).length;
                const relationshipCount = (kg.relationships || []).length;
                kgStats = `\n\n### ğŸ§  çŸ¥è­˜åœ–è­œçµ±è¨ˆ\n- å¯¦é«”ç¸½æ•¸: ${entityCount}\n- é—œä¿‚ç¸½æ•¸: ${relationshipCount}\n- æœ€å¾Œæ›´æ–°: ${kg.last_updated || 'æœªçŸ¥'}`;
              } catch (e) {
                kgStats = '\n\n### ğŸ§  çŸ¥è­˜åœ–è­œçµ±è¨ˆ\nç„¡æ³•è§£æçŸ¥è­˜åœ–è­œæ•¸æ“š';
              }
            }
            
            const status = '${{ job.status }}';
            const body = [
              `## ğŸ§  Enhanced Validation + Knowledge Graph - ${status.toUpperCase()}`,
              '',
              '### ğŸ“Š å¢å¼·é©—è­‰æ‘˜è¦',
              summary,
              kgStats,
              '',
              '### ğŸ”§ ä¿®å¾©å»ºè­°',
              '- è«‹æ ¹æ“šå ±å‘Šä¸­çš„å»ºè­°ä¿®å¾©ç™¼ç¾çš„å•é¡Œ',
              '- è‡ªå‹•å¯ä¿®å¾©çš„å•é¡Œå·²æ¨™æ³¨ï¼Œå¯ä»¥æ‰‹å‹•æ‡‰ç”¨ä¿®å¾©',
              '- çŸ¥è­˜åœ–è­œå¯è¦–åŒ–å·²ç”Ÿæˆï¼Œå¯åœ¨artifactsä¸­æŸ¥çœ‹',
              '',
              '### ğŸ“‹ ç›¸é—œæ–‡ä»¶',
              '- é©—è­‰å ±å‘Š: `enhanced_validation_report.md`',
              '- çŸ¥è­˜åœ–è­œæ•¸æ“š: `knowledge_graph.json`',
              '- å¯è¦–åŒ–ç•Œé¢: `visualizations/knowledge_graph.html`',
              '',
              '---',
              '*æ­¤å ±å‘Šç”±å¢å¼·é©—è­‰ç³»çµ±è‡ªå‹•ç”Ÿæˆ*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
