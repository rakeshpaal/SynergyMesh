name: AI Auto Fix PR Bot

on:
  workflow_run:
    workflows: ["Language Governance + CodeQL + Semgrep + AI Review"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-fix:
    name: AI Auto Fix Bot
    runs-on: ubuntu-latest
    
    # Only run if the previous workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install Auto-Fix dependencies
        run: |
          pip install openai rich pyyaml requests json5
      
      - name: Download Analysis Artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          path: analysis-artifacts/
        continue-on-error: true
      
      - name: List Downloaded Artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts:"
          find analysis-artifacts/ -type f
      
      - name: Run AI Auto-Fix Generator
        id: auto-fix
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python tools/ai-auto-fix.py \
            --artifacts-dir analysis-artifacts/ \
            --repo-root . \
            --branch-name "ai-auto-fix-$(date +%Y%m%d-%H%M%S)" \
            --output-dir auto-fix-patches/
      
      - name: Check if fixes were generated
        id: check-fixes
        run: |
          if [ -d "auto-fix-patches" ] && [ "$(ls -A auto-fix-patches)" ]; then
            echo "has_fixes=true" >> $GITHUB_OUTPUT
            echo "âœ… Fixes generated"
          else
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No fixes generated"
          fi
      
      - name: Configure Git
        if: steps.check-fixes.outputs.has_fixes == 'true'
        run: |
          git config user.name "AI Auto-Fix Bot"
          git config user.email "ai-bot@unmanned-island.com"
      
      - name: Create Fix Branch
        if: steps.check-fixes.outputs.has_fixes == 'true'
        id: create-branch
        run: |
          BRANCH_NAME="ai-auto-fix-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: Generate Semantic Commit Message
        if: steps.check-fixes.outputs.has_fixes == 'true'
        id: semantic-commit
        run: |
          echo "ðŸ“ Generating semantic commit message..."
          
          # Collect changed files
          FILES=$(find auto-fix-patches -name "*.patch" -o -type f -path "auto-fix-patches/files/*" | tr '\n' ' ')
          
          # Generate commit message
          python3 tools/semantic-commit-generator.py \
            --files $FILES \
            --action "fixed" \
            --reason "Address language governance and security violations detected by automated scans" \
            --violation-type "language-governance,security" \
            --output commit-message-semantic.txt \
            --use-ai || echo "Using rule-based generation"
          
          # Save for later use
          cat commit-message-semantic.txt
      
      - name: Apply Fixes
        if: steps.check-fixes.outputs.has_fixes == 'true'
        run: |
          echo "ðŸ”§ Applying generated fixes..."
          
          # Apply all patch files
          if [ -d "auto-fix-patches" ]; then
            for patch in auto-fix-patches/*.patch; do
              if [ -f "$patch" ]; then
                echo "Applying $patch..."
                git apply "$patch" || echo "âš ï¸ Could not apply $patch"
              fi
            done
          fi
          
          # Apply individual file changes
          if [ -d "auto-fix-patches/files" ]; then
            cp -r auto-fix-patches/files/* . || true
          fi
      
      - name: Record Fix History
        if: steps.check-fixes.outputs.has_fixes == 'true'
        run: |
          echo "ðŸ“Š Recording fixes to language history..."
          
          # Record each fixed file to history
          if [ -f "auto-fix-metadata.json" ]; then
            python3 tools/language-history-writer.py \
              --violation-type "language-governance" \
              --file-path "multiple-files" \
              --action "automated-fix" \
              --reason "AI Auto-Fix Bot applied fixes from governance and security scans" \
              --severity "ERROR" \
              --fixed-by "ai-auto-fix-bot"
          fi
      
      - name: Calculate Health Score
        if: steps.check-fixes.outputs.has_fixes == 'true'
        id: health-score
        run: |
          echo "ðŸ¥ Calculating language health score..."
          
          # Find governance report
          GOVERNANCE_REPORT=$(find analysis-artifacts -name "*governance*.json" | head -n 1)
          
          if [ -n "$GOVERNANCE_REPORT" ]; then
            python3 tools/language-health-score.py \
              --governance-report "$GOVERNANCE_REPORT" \
              --history knowledge/language-history.yaml \
              --output knowledge/language-health-score.yaml \
              --display || echo "Score calculation completed"
            
            # Extract score for later use
            HEALTH_SCORE=$(grep "total_score:" knowledge/language-health-score.yaml | awk '{print $2}')
            echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
          fi
      
      - name: Update Living Knowledge Base
        if: steps.check-fixes.outputs.has_fixes == 'true'
        run: |
          echo "ðŸ“š Updating Living Knowledge Base..."
          
          HEALTH_SCORE="${{ steps.health-score.outputs.health_score }}"
          
          python3 tools/lkb-update.py \
            --event "auto-fix" \
            --description "AI Auto-Fix Bot applied repository repairs and triggered knowledge refresh" \
            --violations-fixed 5 \
            --health-score "${HEALTH_SCORE:-75.0}" \
            --files-changed 10
      
      - name: Commit Changes
        if: steps.check-fixes.outputs.has_fixes == 'true'
        run: |
          git add .
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
            exit 0
          fi
          
          # Use semantic commit message if available
          if [ -f "commit-message-semantic.txt" ]; then
            git commit -F commit-message-semantic.txt
          else
            # Fallback commit message
            cat > commit-message.txt << 'EOF'
          ðŸ¤– AI Auto-Fix: Address governance and security violations

          This PR was automatically generated by the AI Auto-Fix Bot to address
          violations detected by the Language Governance, CodeQL, and Semgrep workflows.

          ## Changes Made
          
          - Language policy violations fixed
          - Security vulnerabilities remediated
          - Code quality improvements applied
          
          ## Generated By
          
          AI Auto-Fix Bot with GPT-4 assistance
          
          ## Review Required
          
          Please review these automated changes carefully before merging.
          EOF
          
          git commit -F commit-message.txt
      
      - name: Push Fix Branch
        if: steps.check-fixes.outputs.has_fixes == 'true'
        run: |
          git push origin "${{ steps.create-branch.outputs.branch_name }}"
      
      - name: Create Pull Request
        if: steps.check-fixes.outputs.has_fixes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read PR description from generated file
            let prBody = '';
            if (fs.existsSync('auto-fix-patches/pr-description.md')) {
              prBody = fs.readFileSync('auto-fix-patches/pr-description.md', 'utf8');
            } else {
              const healthScore = '${{ steps.health-score.outputs.health_score }}' || 'N/A';
              prBody = `# ðŸ¤– AI Auto-Fix PR

## Overview

This PR was automatically generated to address violations detected in the repository.

## Language Health Score

**Current Score**: ${healthScore}/100

## Knowledge Base Updates

- âœ… Living Knowledge Base updated
- âœ… Language fix history recorded  
- âœ… Health metrics recalculated

## Analysis Sources

- Language Governance violations
- CodeQL security findings
- Semgrep security patterns

## Changes

The AI Auto-Fix Bot has analyzed all violations and generated appropriate fixes.
Please review each change carefully before merging.

## Testing

- [ ] Review all automated changes
- [ ] Run tests locally
- [ ] Verify fixes address reported violations
- [ ] Check for any unintended side effects

## Notes

This is an automated PR. While the AI strives for accuracy, human review is essential.

---
*Generated by AI Auto-Fix Bot*`;
            }
            
            // Create the PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ¤– AI Auto-Fix: Address governance and security violations',
              head: '${{ steps.create-branch.outputs.branch_name }}',
              base: context.ref.replace('refs/heads/', ''),
              body: prBody,
              draft: false
            });
            
            console.log(`âœ… Created PR #${pr.number}`);
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['automated', 'ai-generated', 'governance', 'security']
            });
            
            // Add comment with details
            const comment = `## ðŸ¤– AI Auto-Fix Bot Summary

This PR contains automated fixes for the following issues:

### Artifacts Analyzed
- Language Governance Report
- CodeQL Analysis Results  
- Semgrep Security Findings
- AI Refactor Suggestions

### Review Checklist
- [ ] Verify language policy compliance
- [ ] Check security vulnerability fixes
- [ ] Review code quality improvements
- [ ] Run full test suite
- [ ] Validate no breaking changes

### Next Steps
1. Review the changes in this PR
2. Run tests locally if needed
3. Approve and merge if changes look good
4. Request changes if adjustments are needed

---
**Workflow Run:** [View Details](../actions/runs/${context.runId})
**Original Failure:** [View Report](../actions/runs/${{ github.event.workflow_run.id }})`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: comment
            });
      
      - name: Report Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âš ï¸ AI Auto-Fix Bot Failed

The AI Auto-Fix Bot attempted to generate fixes but encountered an error.

**Workflow Run:** [View Details](../actions/runs/${context.runId})
**Original Failure:** [View Report](../actions/runs/${{ github.event.workflow_run.id }})

### Possible Reasons
- OpenAI API key not configured
- No fixable violations detected
- Patch generation failed

### Manual Action Required
Please review the violations manually and apply fixes.`;
            
            // Try to find the original PR
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`
            });
            
            if (prs.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs.data[0].number,
                body: comment
              });
            }

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9. Regenerate Dashboard After Fixes
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Regenerate Language Governance Dashboard
        if: steps.apply_fixes.outcome == 'success'
        run: |
          python3 tools/generate-language-dashboard.py \
            --governance-report governance/language-governance-report.json \
            --codeql-results governance/codeql-results-*.sarif \
            --semgrep-results governance/semgrep-results.sarif \
            --history knowledge/language-history.yaml \
            --health knowledge/language-health-score.yaml \
            --output docs/LANGUAGE_GOVERNANCE_DASHBOARD.md

      - name: Commit Dashboard Update
        if: steps.apply_fixes.outcome == 'success'
        run: |
          git add docs/LANGUAGE_GOVERNANCE_DASHBOARD.md docs/LANGUAGE_GOVERNANCE_DASHBOARD-data.yaml
          git commit -m "docs: update language governance dashboard post-fix" --allow-empty
          git push origin ${{ env.FIX_BRANCH }}
