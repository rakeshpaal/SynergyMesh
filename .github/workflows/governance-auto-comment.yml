# =============================================================================
# SynergyMesh Governance - Auto Comment Workflow
# æ²»ç†ç¶­åº¦ï¼š81-auto-comment
# =============================================================================
# åŠŸèƒ½ï¼š
# - ç›£è½ CI Pipeline å¤±æ•—äº‹ä»¶
# - è‡ªå‹•ç”Ÿæˆç²¾æº–è©•è«–
# - åŸ·è¡Œå¯è‡ªå‹•ä¿®å¾©çš„éŒ¯èª¤ä¿®å¾©
# - å¯«å…¥äº‹ä»¶ registryï¼Œå½¢æˆæ²»ç†é–‰ç’°
# =============================================================================

name: Governance Auto Comment Engine

on:
  workflow_run:
    workflows:
      - "CI Pipeline"
      - "Core Services CI"
      - "Integration & Deployment"
      - "Python Validation"
      - "ESLint"
    types:
      - completed

  # å…è¨±æ‰‹å‹•è§¸ç™¼æ¸¬è©¦
  workflow_dispatch:
    inputs:
      test_mode:
        description: "æ¸¬è©¦æ¨¡å¼ï¼ˆä¸å¯¦éš›ç™¼å¸ƒè©•è«–ï¼‰"
        required: false
        type: boolean
        default: true
      mock_failure:
        description: "æ¨¡æ“¬å¤±æ•—é¡žåž‹"
        required: false
        type: choice
        options:
          - "none"
          - "typescript"
          - "eslint"
          - "prettier"
          - "test_failure"
        default: "none"

env:
  NODE_VERSION: "20"
  DIMENSION_PATH: "governance/dimensions/81-auto-comment"

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ===========================================================================
  # éšŽæ®µ 1ï¼šæª¢æŸ¥æ˜¯å¦éœ€è¦è§¸ç™¼
  # ===========================================================================
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      workflow_name: ${{ steps.check.outputs.workflow_name }}
      workflow_conclusion: ${{ steps.check.outputs.workflow_conclusion }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      head_sha: ${{ steps.check.outputs.head_sha }}
      head_branch: ${{ steps.check.outputs.head_branch }}

    steps:
      - name: Check trigger conditions
        id: check
        run: |
          # workflow_dispatch ç¸½æ˜¯åŸ·è¡Œ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "workflow_name=Manual Test" >> $GITHUB_OUTPUT
            echo "workflow_conclusion=${{ inputs.mock_failure != 'none' && 'failure' || 'success' }}" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "head_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "head_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # workflow_run äº‹ä»¶
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "workflow_conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
          echo "head_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          echo "head_branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT

          # åªåœ¨å¤±æ•—æ™‚åŸ·è¡Œ
          if [ "$CONCLUSION" = "failure" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

          # ç²å– PR ç·¨è™Ÿ
          PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

  # ===========================================================================
  # éšŽæ®µ 2ï¼šç”Ÿæˆè‡ªå‹•è©•è«–
  # ===========================================================================
  generate-comment:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      event_id: ${{ steps.generate.outputs.event_id }}
      auto_fixed: ${{ steps.generate.outputs.auto_fixed }}
      error_type: ${{ steps.generate.outputs.error_type }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.head_sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: |
          npm install -g typescript ts-node
          npm install minimist @types/node

      - name: Download CI logs (if available)
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: ci-logs
          path: artifacts/logs/
        continue-on-error: true

      - name: Generate mock CI log (test mode)
        if: inputs.mock_failure != 'none'
        run: |
          mkdir -p artifacts/logs
          case "${{ inputs.mock_failure }}" in
            typescript)
              echo "error TS2345: Argument of type 'string' is not assignable to parameter of type 'number'." > artifacts/logs/ci.log
              ;;
            eslint)
              echo "5 problems (3 errors, 2 warnings)" > artifacts/logs/ci.log
              echo "eslint error: Unexpected console statement" >> artifacts/logs/ci.log
              ;;
            prettier)
              echo "Code style issues found. Forgot to run Prettier?" > artifacts/logs/ci.log
              ;;
            test_failure)
              echo "FAILED tests/unit/example.test.ts" > artifacts/logs/ci.log
              echo "Expected: true" >> artifacts/logs/ci.log
              echo "Received: false" >> artifacts/logs/ci.log
              ;;
          esac

      - name: Generate auto-comment
        id: generate
        run: |
          cd ${{ env.DIMENSION_PATH }}/scripts

          # åŸ·è¡Œè©•è«–ç”Ÿæˆè…³æœ¬
          npx ts-node generate-comment.ts \
            --workflow "${{ needs.check-trigger.outputs.workflow_name }}" \
            --run-id "${{ github.event.workflow_run.id || github.run_id }}" \
            --commit "${{ needs.check-trigger.outputs.head_sha }}" \
            --branch "${{ needs.check-trigger.outputs.head_branch }}" \
            --pr-number "${{ needs.check-trigger.outputs.pr_number }}"

          # è®€å–ç”Ÿæˆçš„äº‹ä»¶è³‡è¨Š
          if [ -f "../output/event.json" ]; then
            EVENT_ID=$(jq -r '.id' ../output/event.json)
            AUTO_FIXED=$(jq -r '.auto_fixed' ../output/event.json)
            ERROR_TYPE=$(jq -r '.error_type' ../output/event.json)

            echo "event_id=$EVENT_ID" >> $GITHUB_OUTPUT
            echo "auto_fixed=$AUTO_FIXED" >> $GITHUB_OUTPUT
            echo "error_type=$ERROR_TYPE" >> $GITHUB_OUTPUT
          fi

      - name: Upload comment artifact
        uses: actions/upload-artifact@v4
        with:
          name: auto-comment-output
          path: ${{ env.DIMENSION_PATH }}/output/
          retention-days: 7

  # ===========================================================================
  # éšŽæ®µ 3ï¼šç™¼å¸ƒè©•è«–åˆ° PR/Issue
  # ===========================================================================
  post-comment:
    needs: [check-trigger, generate-comment]
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      needs.check-trigger.outputs.pr_number != '' &&
      inputs.test_mode != true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download comment artifact
        uses: actions/download-artifact@v4
        with:
          name: auto-comment-output
          path: ${{ env.DIMENSION_PATH }}/output/

      - name: Post comment to PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ needs.check-trigger.outputs.pr_number }}
          body-path: ${{ env.DIMENSION_PATH }}/output/comment.md

      - name: Add labels based on error type
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-trigger.outputs.pr_number }};
            const errorType = "${{ needs.generate-comment.outputs.error_type }}";
            const autoFixed = "${{ needs.generate-comment.outputs.auto_fixed }}" === "true";

            const labels = ["ci-failed"];

            if (errorType === "typescript") {
              labels.push("type-error");
            } else if (errorType === "eslint" || errorType === "prettier") {
              labels.push("lint-error");
            } else if (errorType === "test_failure") {
              labels.push("test-failure");
            } else if (errorType === "security") {
              labels.push("security");
            }

            if (autoFixed) {
              labels.push("auto-fixed");
            }

            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: labels
              });
              console.log(`Added labels: ${labels.join(", ")}`);
            } catch (error) {
              console.log(`Failed to add labels: ${error.message}`);
            }

  # ===========================================================================
  # éšŽæ®µ 4ï¼šæ›´æ–°äº‹ä»¶ Registry
  # ===========================================================================
  update-registry:
    needs: [check-trigger, generate-comment]
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.head_branch }}
          fetch-depth: 0

      - name: Download comment artifact
        uses: actions/download-artifact@v4
        with:
          name: auto-comment-output
          path: ${{ env.DIMENSION_PATH }}/output/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Update events registry
        run: |
          cd ${{ env.DIMENSION_PATH }}/scripts

          node update-registry.js --from-file

      - name: Commit registry update
        if: inputs.test_mode != true
        run: |
          git config --local user.email "governance-bot@synergymesh.io"
          git config --local user.name "Governance Bot"

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if git diff --quiet governance/index/events/registry.json; then
            echo "No changes to registry"
            exit 0
          fi

          git add governance/index/events/registry.json
          git commit -m "[81-auto-comment] Update events registry

          Event ID: ${{ needs.generate-comment.outputs.event_id }}
          Error Type: ${{ needs.generate-comment.outputs.error_type }}
          Auto-Fixed: ${{ needs.generate-comment.outputs.auto_fixed }}"

          git push

  # ===========================================================================
  # éšŽæ®µ 5ï¼šè‡ªå‹•ä¿®å¾©æäº¤ï¼ˆå¦‚é©ç”¨ï¼‰
  # ===========================================================================
  auto-fix-commit:
    needs: [check-trigger, generate-comment]
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      needs.generate-comment.outputs.auto_fixed == 'true' &&
      inputs.test_mode != true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Push auto-fix changes
        run: |
          git config --local user.email "governance-bot@synergymesh.io"
          git config --local user.name "Governance Bot"

          # æª¢æŸ¥æ˜¯å¦æœ‰è‡ªå‹•ä¿®å¾©ç”¢ç”Ÿçš„è®Šæ›´
          if git status --porcelain | grep -q .; then
            git add .
            git commit -m "[auto-fix] è‡ªå‹•ä¿®å¾© ${{ needs.generate-comment.outputs.error_type }} éŒ¯èª¤

            æ²»ç†ç¶­åº¦ï¼š81-auto-comment
            äº‹ä»¶ IDï¼š${{ needs.generate-comment.outputs.event_id }}
            ä¿®å¾©é¡žåž‹ï¼š${{ needs.generate-comment.outputs.error_type }}"

            git push
            echo "Auto-fix changes committed and pushed"
          else
            echo "No auto-fix changes to commit"
          fi

  # ===========================================================================
  # éšŽæ®µ 6ï¼šç”Ÿæˆæ‘˜è¦å ±å‘Š
  # ===========================================================================
  summary:
    needs: [check-trigger, generate-comment, post-comment, update-registry]
    if: always() && needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Generate workflow summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ¤– Governance Auto-Comment Engine Report

          ### åŸ·è¡Œè³‡è¨Š
          | é …ç›® | å€¼ |
          |------|-----|
          | è§¸ç™¼ Workflow | ${{ needs.check-trigger.outputs.workflow_name }} |
          | çµæžœ | ${{ needs.check-trigger.outputs.workflow_conclusion }} |
          | Commit | \`${{ needs.check-trigger.outputs.head_sha }}\` |
          | åˆ†æ”¯ | ${{ needs.check-trigger.outputs.head_branch }} |
          | PR ç·¨è™Ÿ | ${{ needs.check-trigger.outputs.pr_number || 'N/A' }} |

          ### è™•ç†çµæžœ
          | é …ç›® | å€¼ |
          |------|-----|
          | äº‹ä»¶ ID | \`$EVENT_ID\` |
          | éŒ¯èª¤é¡žåž‹ | ${{ needs.generate-comment.outputs.error_type }} |
          | è‡ªå‹•ä¿®å¾© | ${{ needs.generate-comment.outputs.auto_fixed }} |

          ### æ²»ç†è¿½è¹¤
          - **ç¶­åº¦**ï¼š81-auto-comment
          - **ä¾è³´ç¶­åº¦**ï¼š39-automation, 71-feedback-loops
          - **äº‹ä»¶ Registry**ï¼š\`governance/index/events/registry.json\`
          - **ç­–ç•¥**ï¼šPOL-81-001 (Comment Generation), POL-81-002 (Auto-Fix)

          ---
          *æ­¤å ±å‘Šç”± Governance Auto-Comment Engine (81-auto-comment) è‡ªå‹•ç”Ÿæˆ*
          EOF
