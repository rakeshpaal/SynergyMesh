# =============================================================================
# æ©Ÿå™¨è‡ªä¸» AIå¹³å° - ç¬¬ä¸€é˜¶æ®µç¯å¢ƒå‡†å¤‡
# Stage 1: Environment Preparation & Validation
# =============================================================================
name: "Stage 1 - Environment Preparation"

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*.sh"
      - "**/*.py"
      - "config/**"
      - "scripts/**"
  push:
    branches: [main, develop]

env:
  PLATFORM_VERSION: "v1.0.0"
  DEPLOYER_SCRIPT: "scripts/deployment/comprehensive-deploy.sh"
  VALIDATION_TIMEOUT: 600 # seconds
  VALIDATION_DIRS: "config src docs scripts tools"
  CONFIG_VALIDATION_FILES: "config/dependencies.yaml config/unified-config-index.yaml config/brand-mapping.yaml"

jobs:
  # =============================================================================
  # ç¯å¢ƒæ£€æµ‹ä¸éªŒè¯
  # =============================================================================
  environment-detection:
    name: "ç¯å¢ƒæ£€æµ‹ä¸ç³»ç»ŸéªŒè¯"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      os-type: ${{ steps.os-detection.outputs.os-type }}
      arch-type: ${{ steps.arch-detection.outputs.arch-type }}
      tools-available: ${{ steps.tool-check.outputs.available }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ”¶é›†æ ¡éªŒç›®å½•
        run: |
          set -euo pipefail
          mapfile -t existing_dirs < <(for dir in $VALIDATION_DIRS; do [ -d "$dir" ] && echo "$dir"; done)
          if [ ${#existing_dirs[@]} -eq 0 ]; then
            echo "VALIDATION_DIRS_RESOLVED=" >> $GITHUB_ENV
            echo "â„¹ï¸ æœªæ‰¾åˆ°å¯ç”¨çš„æ ¡éªŒç›®å½•"
          else
            echo "VALIDATION_DIRS_RESOLVED=${existing_dirs[*]}" >> $GITHUB_ENV
          fi

      - name: æ“ä½œç³»ç»Ÿæ£€æµ‹
        id: os-detection
        run: |
          echo "æ£€æµ‹æ“ä½œç³»ç»Ÿç¯å¢ƒ..."
          OS_TYPE=$(uname -s | tr '[:upper:]' '[:lower:]')
          echo "os-type=$OS_TYPE" >> $GITHUB_OUTPUT
          echo "âœ… æ“ä½œç³»ç»Ÿ: $OS_TYPE"

      - name: æ¶æ„æ£€æµ‹
        id: arch-detection
        run: |
          echo "æ£€æµ‹ç³»ç»Ÿæ¶æ„..."
          ARCH_TYPE=$(uname -m)
          echo "arch-type=$ARCH_TYPE" >> $GITHUB_OUTPUT
          echo "âœ… ç³»ç»Ÿæ¶æ„: $ARCH_TYPE"

      - name: åŸºç¡€å·¥å…·æ£€æŸ¥
        id: tool-check
        run: |
          echo "éªŒè¯å¿…éœ€å·¥å…·å¯ç”¨æ€§..."
          REQUIRED_TOOLS=("curl" "git" "jq" "python3" "docker" "kubectl")
          MISSING_TOOLS=()
          for tool in "${REQUIRED_TOOLS[@]}"; do
            if command -v $tool &> /dev/null; then
              echo "âœ… $tool å¯ç”¨"
            else
              echo "âŒ $tool ç¼ºå¤±"
              MISSING_TOOLS+=("$tool")
            fi
          done
          if [ ${#MISSING_TOOLS[@]} -eq 0 ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰€æœ‰å¿…éœ€å·¥å…·å¯ç”¨"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "âŒ ç¼ºå¤±å·¥å…·: ${MISSING_TOOLS[*]}"
            exit 1
          fi

      - name: ç¯å¢ƒå˜é‡éªŒè¯
        run: |
          echo "éªŒè¯ç¯å¢ƒå˜é‡é…ç½®..."
          REQUIRED_VARS=("PLATFORM_VERSION" "DEPLOYER_SCRIPT")
          for var in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!var}" ]; then
              echo "âŒ ç¯å¢ƒå˜é‡ $var æœªè®¾ç½®"
              exit 1
            else
              echo "âœ… $var=${!var}"
            fi
          done

  # =============================================================================
  # è„šæœ¬è¯­æ³•éªŒè¯
  # =============================================================================
  script-validation:
    name: "éƒ¨ç½²è„šæœ¬è¯­æ³•éªŒè¯"
    runs-on: ubuntu-latest
    needs: environment-detection
    timeout-minutes: 10
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Shellè„šæœ¬è¯­æ³•æ£€æŸ¥
        run: |
          set -euo pipefail
          echo "éªŒè¯Shellè„šæœ¬è¯­æ³•..."
          mapfile -t shell_files < <(find . -name "*.sh" -type f)
          if [ ${#shell_files[@]} -eq 0 ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° Shell è„šæœ¬"
          else
            for script in "${shell_files[@]}"; do
              echo "æ£€æŸ¥è„šæœ¬: $script"
              if bash -n "$script"; then
                echo "âœ… $script è¯­æ³•æ­£ç¡®"
              else
                echo "âŒ $script è¯­æ³•é”™è¯¯"
                exit 1
              fi
            done
          fi

      - name: Pythonè„šæœ¬è¯­æ³•æ£€æŸ¥
        run: |
          set -euo pipefail
          echo "éªŒè¯Pythonè„šæœ¬è¯­æ³•..."
          mapfile -t python_files < <(find . -name "*.py" -type f)
          if [ ${#python_files[@]} -eq 0 ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° Python è„šæœ¬"
          else
            for script in "${python_files[@]}"; do
              echo "æ£€æŸ¥è„šæœ¬: $script"
              if python3 -m py_compile "$script"; then
                echo "âœ… $script è¯­æ³•æ­£ç¡®"
              else
                echo "âŒ $script è¯­æ³•é”™è¯¯"
                exit 1
              fi
            done
          fi

      - name: éƒ¨ç½²è„šæœ¬åŠŸèƒ½éªŒè¯
        run: |
          set -euo pipefail
          echo "éªŒè¯ä¸»éƒ¨ç½²è„šæœ¬åŠŸèƒ½..."
          if [ -f "$DEPLOYER_SCRIPT" ]; then
            echo "âœ… æ‰¾åˆ°éƒ¨ç½²è„šæœ¬: $DEPLOYER_SCRIPT"
            chmod +x "$DEPLOYER_SCRIPT"
            if bash -n "$DEPLOYER_SCRIPT"; then
              echo "âœ… éƒ¨ç½²è„šæœ¬è¯­æ³•æ­£ç¡®"
            else
              echo "âŒ éƒ¨ç½²è„šæœ¬è¯­æ³•é”™è¯¯"
              exit 1
            fi
          else
            echo "âŒ éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨: $DEPLOYER_SCRIPT"
            exit 1
          fi

  # =============================================================================
  # é…ç½®éªŒè¯
  # =============================================================================
  config-validation:
    name: "é…ç½®æ–‡ä»¶éªŒè¯"
    runs-on: ubuntu-latest
    needs: environment-detection
    timeout-minutes: 8
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: YAMLé…ç½®è¯­æ³•æ£€æŸ¥
        run: |
          set -euo pipefail
          echo "éªŒè¯YAMLé…ç½®æ–‡ä»¶..."
          pip install "yamllint==1.35.1"
          if [ -z "${VALIDATION_DIRS_RESOLVED:-}" ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° YAML æœç´¢ç›®å½•"
            yaml_files=()
          else
            mapfile -t yaml_files < <(find ${VALIDATION_DIRS_RESOLVED} -type f \( -name "*.yaml" -o -name "*.yml" \))
          fi
          if [ ${#yaml_files[@]} -eq 0 ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° YAML é…ç½®æ–‡ä»¶"
          else
            for file in "${yaml_files[@]}"; do
              echo "æ£€æŸ¥æ–‡ä»¶: $file"
              if yamllint "$file"; then
                echo "âœ… $file YAMLè¯­æ³•æ­£ç¡®"
              else
                echo "âŒ $file YAMLè¯­æ³•é”™è¯¯"
                exit 1
              fi
            done
          fi

      - name: JSONé…ç½®è¯­æ³•æ£€æŸ¥
        run: |
          set -euo pipefail
          echo "éªŒè¯JSONé…ç½®æ–‡ä»¶..."
          if [ -z "${VALIDATION_DIRS_RESOLVED:-}" ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° JSON æœç´¢ç›®å½•"
            json_files=()
          else
            mapfile -t json_files < <(find ${VALIDATION_DIRS_RESOLVED} -type f -name "*.json")
          fi
          if [ ${#json_files[@]} -eq 0 ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° JSON é…ç½®æ–‡ä»¶"
          else
            for file in "${json_files[@]}"; do
              echo "æ£€æŸ¥æ–‡ä»¶: $file"
              if jq empty "$file" 2>/dev/null; then
                echo "âœ… $file JSONè¯­æ³•æ­£ç¡®"
              else
                echo "âŒ $file JSONè¯­æ³•é”™è¯¯"
                exit 1
              fi
            done
          fi

      - name: ç¯å¢ƒé…ç½®éªŒè¯
        run: |
          set -euo pipefail
          echo "éªŒè¯ç¯å¢ƒç‰¹å®šé…ç½®..."
          CONFIG_FILES=(${CONFIG_VALIDATION_FILES})
          for config in "${CONFIG_FILES[@]}"; do
            if [ -f "$config" ]; then
              echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $config"
            else
              echo "âš ï¸ é…ç½®æ–‡ä»¶ç¼ºå¤±: $config"
            fi
          done

  # =============================================================================
  # æœ€ç»ˆç¯å¢ƒéªŒè¯æŠ¥å‘Š
  # =============================================================================
  environment-report:
    name: "ç¯å¢ƒéªŒè¯æŠ¥å‘Š"
    runs-on: ubuntu-latest
    needs: [environment-detection, script-validation, config-validation]
    if: always()
    steps:
      - name: ç”Ÿæˆç¯å¢ƒæŠ¥å‘Š
        run: |
          REPORT_FILE="environment-report.txt"
          echo "==========================================" | tee "$REPORT_FILE"
          echo " ç¯å¢ƒéªŒè¯æŠ¥å‘Š" | tee -a "$REPORT_FILE"
          echo "==========================================" | tee -a "$REPORT_FILE"
          echo "" | tee -a "$REPORT_FILE"
          echo "ğŸ“‹ ç¯å¢ƒæ£€æµ‹ç»“æœ:" | tee -a "$REPORT_FILE"
          echo " æ“ä½œç³»ç»Ÿ: ${{ needs.environment-detection.outputs.os-type }}" | tee -a "$REPORT_FILE"
          echo " ç³»ç»Ÿæ¶æ„: ${{ needs.environment-detection.outputs.arch-type }}" | tee -a "$REPORT_FILE"
          echo " å·¥å…·å¯ç”¨æ€§: ${{ needs.environment-detection.outputs.tools-available }}" | tee -a "$REPORT_FILE"
          echo "" | tee -a "$REPORT_FILE"
          echo "ğŸ“œ è„šæœ¬éªŒè¯ç»“æœ:" | tee -a "$REPORT_FILE"
          echo " çŠ¶æ€: ${{ needs.script-validation.result }}" | tee -a "$REPORT_FILE"
          echo "" | tee -a "$REPORT_FILE"
          echo "âš™ï¸ é…ç½®éªŒè¯ç»“æœ:" | tee -a "$REPORT_FILE"
          echo " çŠ¶æ€: ${{ needs.config-validation.result }}" | tee -a "$REPORT_FILE"
          echo "" | tee -a "$REPORT_FILE"
          echo "==========================================" | tee -a "$REPORT_FILE"
          if [ "${{ needs.environment-detection.result }}" = "success" ] && \
             [ "${{ needs.script-validation.result }}" = "success" ] && \
             [ "${{ needs.config-validation.result }}" = "success" ]; then
            echo "ğŸ‰ ç¯å¢ƒéªŒè¯å…¨éƒ¨é€šè¿‡" | tee -a "$REPORT_FILE"
            echo "report-status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç¯å¢ƒéªŒè¯å¤±è´¥" | tee -a "$REPORT_FILE"
            echo "report-status=failure" >> $GITHUB_OUTPUT
          fi

      - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: environment-validation-report
          path: environment-report.txt
          retention-days: 7
