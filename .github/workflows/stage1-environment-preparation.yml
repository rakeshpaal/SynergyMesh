name: Stage 1 - Environment Preparation
true:
  pull_request:
    branches:
    - main
    - develop
    paths:
    - '**/*.sh'
    - '**/*.py'
    - config/**
    - scripts/**
  push:
    branches:
    - main
    - develop
permissions:
  contents: read
env:
  CONFIG_VALIDATION_FILES: config/dependencies.yaml config/unified-config-index.yaml
    config/brand-mapping.yaml
  DEPLOYER_SCRIPT: scripts/deployment/comprehensive-deploy.sh
  PLATFORM_VERSION: v1.0.0
  VALIDATION_DIRS: config src docs scripts tools
jobs:
  config-validation:
    name: é…ç½®æ–‡ä»¶éªŒè¯
    needs: environment-detection
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - id: collect-dirs
      name: æ”¶é›†é…ç½®ç›®å½•
      run: "set -euo pipefail\necho \"æ”¶é›†ç”¨äºé…ç½®éªŒè¯çš„ç›®å½•...\"\nCANDIDATE_DIRS=($VALIDATION_DIRS)\n\
        EXISTING_DIRS=()\nfor d in \"${CANDIDATE_DIRS[@]}\"; do\n  if [ -d \"$d\"\
        \ ]; then\n    EXISTING_DIRS+=(\"$d\")\n  fi\ndone\nif [ ${#EXISTING_DIRS[@]}\
        \ -eq 0 ]; then\n  echo \"dirs=\" >> \"$GITHUB_OUTPUT\"\n  echo \"â„¹ï¸ æœªæ‰¾åˆ°å¯ç”¨çš„æ ¡éªŒç›®å½•\"\
        \nelse\n  printf -v joined ' %s' \"${EXISTING_DIRS[@]}\"\n  joined=${joined:1}\n\
        \  echo \"dirs=$joined\" >> \"$GITHUB_OUTPUT\"\n  echo \"å°†éªŒè¯ä»¥ä¸‹ç›®å½•: $joined\"\
        \nfi\n"
    - env:
        VALIDATION_DIRS_RESOLVED: ${{ steps.collect-dirs.outputs.dirs }}
      name: YAMLé…ç½®è¯­æ³•æ£€æŸ¥
      run: "set -euo pipefail\necho \"éªŒè¯YAMLé…ç½®æ–‡ä»¶...\"\npip install --user \"yamllint==1.35.1\"\
        \nexport PATH=\"$HOME/.local/bin:$PATH\"\nread -r -a VALIDATION_DIRS_ARRAY\
        \ <<< \"${VALIDATION_DIRS_RESOLVED:-}\"\nif [ ${#VALIDATION_DIRS_ARRAY[@]}\
        \ -eq 0 ]; then\n  echo \"â„¹ï¸ æœªæ‰¾åˆ° YAML æœç´¢ç›®å½•\"\n  yaml_files=()\nelse\n  mapfile\
        \ -t yaml_files < <(find \"${VALIDATION_DIRS_ARRAY[@]}\" -type f \\( -name\
        \ \"*.yaml\" -o -name \"*.yml\" \\))\nfi\nif [ ${#yaml_files[@]} -eq 0 ];\
        \ then\n  echo \"â„¹ï¸ æœªæ‰¾åˆ° YAML é…ç½®æ–‡ä»¶\"\nelse\n  for file in \"${yaml_files[@]}\"\
        ; do\n    echo \"æ£€æŸ¥æ–‡ä»¶: $file\"\n    if yamllint \"$file\"; then\n      echo\
        \ \"âœ… $file YAMLè¯­æ³•æ­£ç¡®\"\n    else\n      echo \"âŒ $file YAMLè¯­æ³•é”™è¯¯\"\n      exit\
        \ 1\n    fi\n  done\nfi\n"
    - env:
        VALIDATION_DIRS_RESOLVED: ${{ steps.collect-dirs.outputs.dirs }}
      name: JSONé…ç½®è¯­æ³•æ£€æŸ¥
      run: "set -euo pipefail\necho \"éªŒè¯JSONé…ç½®æ–‡ä»¶...\"\nread -r -a VALIDATION_DIRS_ARRAY\
        \ <<< \"${VALIDATION_DIRS_RESOLVED:-}\"\nif [ ${#VALIDATION_DIRS_ARRAY[@]}\
        \ -eq 0 ]; then\n  echo \"â„¹ï¸ æœªæ‰¾åˆ° JSON æœç´¢ç›®å½•\"\n  json_files=()\nelse\n  mapfile\
        \ -t json_files < <(find \"${VALIDATION_DIRS_ARRAY[@]}\" -type f -name \"\
        *.json\")\nfi\nif [ ${#json_files[@]} -eq 0 ]; then\n  echo \"â„¹ï¸ æœªæ‰¾åˆ° JSON\
        \ é…ç½®æ–‡ä»¶\"\nelse\n  for file in \"${json_files[@]}\"; do\n    echo \"æ£€æŸ¥æ–‡ä»¶: $file\"\
        \n    if jq empty \"$file\" 2>/dev/null; then\n      echo \"âœ… $file JSONè¯­æ³•æ­£ç¡®\"\
        \n    else\n      echo \"âŒ $file JSONè¯­æ³•é”™è¯¯\"\n      exit 1\n    fi\n  done\n\
        fi\n"
    - name: ç¯å¢ƒé…ç½®éªŒè¯
      run: "set -euo pipefail\necho \"éªŒè¯ç¯å¢ƒç‰¹å®šé…ç½®...\"\nread -r -a CONFIG_FILES <<< \"\
        ${CONFIG_VALIDATION_FILES}\"\nmissing_required=0\nfor config in \"${CONFIG_FILES[@]}\"\
        ; do\n  if [ -f \"$config\" ]; then\n    echo \"âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $config\"\n  else\n\
        \    echo \"âŒ é…ç½®æ–‡ä»¶ç¼ºå¤±: $config\"\n    missing_required=1\n  fi\ndone\nif [\
        \ \"$missing_required\" -ne 0 ]; then\n  echo \"âŒ éƒ¨åˆ†å¿…éœ€çš„ç¯å¢ƒé…ç½®æ–‡ä»¶ç¼ºå¤±ï¼Œç¯å¢ƒé…ç½®éªŒè¯å¤±è´¥\"\
        \n  exit 1\nfi\n"
    timeout-minutes: 8
  environment-detection:
    name: ç¯å¢ƒæ£€æµ‹ä¸ç³»ç»ŸéªŒè¯
    outputs:
      arch-type: ${{ steps.arch-detection.outputs.arch-type }}
      os-type: ${{ steps.os-detection.outputs.os-type }}
      tools-available: ${{ steps.tool-check.outputs.available }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: æ”¶é›†æ ¡éªŒç›®å½•
        id: collect-dirs
        run: |
          set -euo pipefail
          mapfile -t existing_dirs < <(for dir in $VALIDATION_DIRS; do [ -d "$dir" ] && echo "$dir"; done)
          if [ ${#existing_dirs[@]} -eq 0 ]; then
            echo "dirs=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æœªæ‰¾åˆ°å¯ç”¨çš„æ ¡éªŒç›®å½•"
          else
            echo "dirs=${existing_dirs[*]}" >> $GITHUB_OUTPUT
          fi

      - name: æ“ä½œç³»ç»Ÿæ£€æµ‹
        id: os-detection
        run: |
          echo "æ£€æµ‹æ“ä½œç³»ç»Ÿç¯å¢ƒ..."
          OS_TYPE=$(uname -s | tr '[:upper:]' '[:lower:]')
          echo "os-type=$OS_TYPE" >> $GITHUB_OUTPUT
          echo "âœ… æ“ä½œç³»ç»Ÿ: $OS_TYPE"

      - name: æ¶æ„æ£€æµ‹
        id: arch-detection
        run: |
          echo "æ£€æµ‹ç³»ç»Ÿæ¶æ„..."
          ARCH_TYPE=$(uname -m)
          echo "arch-type=$ARCH_TYPE" >> $GITHUB_OUTPUT
          echo "âœ… ç³»ç»Ÿæ¶æ„: $ARCH_TYPE"

      - name: åŸºç¡€å·¥å…·æ£€æŸ¥
        id: tool-check
        run: |
          echo "éªŒè¯å¿…éœ€å·¥å…·å¯ç”¨æ€§..."
          REQUIRED_TOOLS=("curl" "git" "jq" "python3" "docker" "kubectl")
          MISSING_TOOLS=()
          for tool in "${REQUIRED_TOOLS[@]}"; do
            if command -v $tool &> /dev/null; then
              echo "âœ… $tool å¯ç”¨"
            else
              echo "âŒ $tool ç¼ºå¤±"
              MISSING_TOOLS+=("$tool")
            fi
          done
          if [ ${#MISSING_TOOLS[@]} -eq 0 ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰€æœ‰å¿…éœ€å·¥å…·å¯ç”¨"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "âŒ ç¼ºå¤±å·¥å…·: ${MISSING_TOOLS[*]}"
            exit 1
          fi

      - name: ç¯å¢ƒå˜é‡éªŒè¯
        run: |
          echo "éªŒè¯ç¯å¢ƒå˜é‡é…ç½®..."
          REQUIRED_VARS=("PLATFORM_VERSION" "DEPLOYER_SCRIPT")
          for var in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!var}" ]; then
              echo "âŒ ç¯å¢ƒå˜é‡ $var æœªè®¾ç½®"
              exit 1
            else
              echo "âœ… $var=${!var}"
            fi
          done

  # =============================================================================
  # è„šæœ¬è¯­æ³•éªŒè¯
  # =============================================================================
  script-validation:
    name: "éƒ¨ç½²è„šæœ¬è¯­æ³•éªŒè¯"
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: Shellè„šæœ¬è¯­æ³•æ£€æŸ¥
        run: |
          set -euo pipefail
          echo "éªŒè¯Shellè„šæœ¬è¯­æ³•..."
          mapfile -t shell_files < <(find . -name "*.sh" -type f)
          if [ ${#shell_files[@]} -eq 0 ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° Shell è„šæœ¬"
          else
            for script in "${shell_files[@]}"; do
              echo "æ£€æŸ¥è„šæœ¬: $script"
              if bash -n "$script"; then
                echo "âœ… $script è¯­æ³•æ­£ç¡®"
              else
                echo "âŒ $script è¯­æ³•é”™è¯¯"
                exit 1
              fi
            done
          fi

      - name: Pythonè„šæœ¬è¯­æ³•æ£€æŸ¥
        run: |
          set -euo pipefail
          echo "éªŒè¯Pythonè„šæœ¬è¯­æ³•..."
          mapfile -t python_files < <(find . -name "*.py" -type f)
          if [ ${#python_files[@]} -eq 0 ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° Python è„šæœ¬"
          else
            for script in "${python_files[@]}"; do
              echo "æ£€æŸ¥è„šæœ¬: $script"
              if python3 -m py_compile "$script"; then
                echo "âœ… $script è¯­æ³•æ­£ç¡®"
              else
                echo "âŒ $script è¯­æ³•é”™è¯¯"
                exit 1
              fi
            done
          fi

      - name: éƒ¨ç½²è„šæœ¬åŠŸèƒ½éªŒè¯
        run: |
          set -euo pipefail
          echo "éªŒè¯ä¸»éƒ¨ç½²è„šæœ¬åŠŸèƒ½..."
          if [ -f "$DEPLOYER_SCRIPT" ]; then
            echo "âœ… æ‰¾åˆ°éƒ¨ç½²è„šæœ¬: $DEPLOYER_SCRIPT"
            chmod +x "$DEPLOYER_SCRIPT"
            if bash -n "$DEPLOYER_SCRIPT"; then
              echo "âœ… éƒ¨ç½²è„šæœ¬è¯­æ³•æ­£ç¡®"
            else
              echo "âŒ éƒ¨ç½²è„šæœ¬è¯­æ³•é”™è¯¯"
              exit 1
            fi
          else
            echo "âŒ éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨: $DEPLOYER_SCRIPT"
            exit 1
          fi

  # =============================================================================
  # é…ç½®éªŒè¯
  # =============================================================================
  config-validation:
    name: "é…ç½®æ–‡ä»¶éªŒè¯"
    - name: æ£€å‡ºä»£ç 
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - id: collect-dirs
      name: æ”¶é›†æ ¡éªŒç›®å½•
      run: "set -euo pipefail\nmapfile -t existing_dirs < <(for dir in $VALIDATION_DIRS;\
        \ do [ -d \"$dir\" ] && echo \"$dir\"; done)\nif [ ${#existing_dirs[@]} -eq\
        \ 0 ]; then\n  echo \"dirs=\" >> $GITHUB_OUTPUT\n  echo \"â„¹ï¸ æœªæ‰¾åˆ°å¯ç”¨çš„æ ¡éªŒç›®å½•\"\n\
        else\n  echo \"dirs=${existing_dirs[*]}\" >> $GITHUB_OUTPUT\nfi\n"
    - id: os-detection
      name: æ“ä½œç³»ç»Ÿæ£€æµ‹
      run: 'echo "æ£€æµ‹æ“ä½œç³»ç»Ÿç¯å¢ƒ..."

        OS_TYPE=$(uname -s | tr ''[:upper:]'' ''[:lower:]'')

        echo "os-type=$OS_TYPE" >> $GITHUB_OUTPUT

        echo "âœ… æ“ä½œç³»ç»Ÿ: $OS_TYPE"

        '
    - id: arch-detection
      name: æ¶æ„æ£€æµ‹
      run: 'echo "æ£€æµ‹ç³»ç»Ÿæ¶æ„..."

        ARCH_TYPE=$(uname -m)

        echo "arch-type=$ARCH_TYPE" >> $GITHUB_OUTPUT

        echo "âœ… ç³»ç»Ÿæ¶æ„: $ARCH_TYPE"

        '
    - id: tool-check
      name: åŸºç¡€å·¥å…·æ£€æŸ¥
      run: "echo \"éªŒè¯å¿…éœ€å·¥å…·å¯ç”¨æ€§...\"\nREQUIRED_TOOLS=(\"curl\" \"git\" \"jq\" \"python3\"\
        \ \"docker\" \"kubectl\")\nMISSING_TOOLS=()\nfor tool in \"${REQUIRED_TOOLS[@]}\"\
        ; do\n  if command -v $tool &> /dev/null; then\n    echo \"âœ… $tool å¯ç”¨\"\n\
        \  else\n    echo \"âŒ $tool ç¼ºå¤±\"\n    MISSING_TOOLS+=(\"$tool\")\n  fi\ndone\n\
        if [ ${#MISSING_TOOLS[@]} -eq 0 ]; then\n  echo \"available=true\" >> $GITHUB_OUTPUT\n\
        \  echo \"âœ… æ‰€æœ‰å¿…éœ€å·¥å…·å¯ç”¨\"\nelse\n  echo \"available=false\" >> $GITHUB_OUTPUT\n\
        \  echo \"âŒ ç¼ºå¤±å·¥å…·: ${MISSING_TOOLS[*]}\"\n  exit 1\nfi\n"
    - name: ç¯å¢ƒå˜é‡éªŒè¯
      run: "echo \"éªŒè¯ç¯å¢ƒå˜é‡é…ç½®...\"\nREQUIRED_VARS=(\"PLATFORM_VERSION\" \"DEPLOYER_SCRIPT\"\
        )\nfor var in \"${REQUIRED_VARS[@]}\"; do\n  if [ -z \"${!var}\" ]; then\n\
        \    echo \"âŒ ç¯å¢ƒå˜é‡ $var æœªè®¾ç½®\"\n    exit 1\n  else\n    echo \"âœ… $var=${!var}\"\
        \n  fi\ndone\n"
    timeout-minutes: 15
  environment-report:
    if: always()
    name: ç¯å¢ƒéªŒè¯æŠ¥å‘Š
    needs:
    - environment-detection
    - script-validation
    - config-validation
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: æ”¶é›†é…ç½®ç›®å½•
        id: collect-dirs
        run: |
          set -euo pipefail
          echo "æ”¶é›†ç”¨äºé…ç½®éªŒè¯çš„ç›®å½•..."
          CANDIDATE_DIRS=($VALIDATION_DIRS)
          EXISTING_DIRS=()
          for d in "${CANDIDATE_DIRS[@]}"; do
            if [ -d "$d" ]; then
              EXISTING_DIRS+=("$d")
            fi
          done
          if [ ${#EXISTING_DIRS[@]} -eq 0 ]; then
            echo "dirs=" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ æœªæ‰¾åˆ°å¯ç”¨çš„æ ¡éªŒç›®å½•"
          else
            printf -v joined ' %s' "${EXISTING_DIRS[@]}"
            joined=${joined:1}
            echo "dirs=$joined" >> "$GITHUB_OUTPUT"
            echo "å°†éªŒè¯ä»¥ä¸‹ç›®å½•: $joined"
          fi

      - name: YAMLé…ç½®è¯­æ³•æ£€æŸ¥
        env:
          VALIDATION_DIRS_RESOLVED: ${{ steps.collect-dirs.outputs.dirs }}
        run: |
          set -euo pipefail
          echo "éªŒè¯YAMLé…ç½®æ–‡ä»¶..."
          pip install --user "yamllint==1.35.1"
          export PATH="$HOME/.local/bin:$PATH"
          read -r -a VALIDATION_DIRS_ARRAY <<< "${VALIDATION_DIRS_RESOLVED:-}"
          if [ ${#VALIDATION_DIRS_ARRAY[@]} -eq 0 ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° YAML æœç´¢ç›®å½•"
            yaml_files=()
          else
            mapfile -t yaml_files < <(find "${VALIDATION_DIRS_ARRAY[@]}" -type f \( -name "*.yaml" -o -name "*.yml" \))
          fi
          if [ ${#yaml_files[@]} -eq 0 ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° YAML é…ç½®æ–‡ä»¶"
          else
            for file in "${yaml_files[@]}"; do
              echo "æ£€æŸ¥æ–‡ä»¶: $file"
              if yamllint "$file"; then
                echo "âœ… $file YAMLè¯­æ³•æ­£ç¡®"
              else
                echo "âŒ $file YAMLè¯­æ³•é”™è¯¯"
                exit 1
              fi
            done
          fi

      - name: JSONé…ç½®è¯­æ³•æ£€æŸ¥
        env:
          VALIDATION_DIRS_RESOLVED: ${{ steps.collect-dirs.outputs.dirs }}
        run: |
          set -euo pipefail
          echo "éªŒè¯JSONé…ç½®æ–‡ä»¶..."
          read -r -a VALIDATION_DIRS_ARRAY <<< "${VALIDATION_DIRS_RESOLVED:-}"
          if [ ${#VALIDATION_DIRS_ARRAY[@]} -eq 0 ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° JSON æœç´¢ç›®å½•"
            json_files=()
          else
            mapfile -t json_files < <(find "${VALIDATION_DIRS_ARRAY[@]}" -type f -name "*.json")
          fi
          if [ ${#json_files[@]} -eq 0 ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° JSON é…ç½®æ–‡ä»¶"
          else
            for file in "${json_files[@]}"; do
              echo "æ£€æŸ¥æ–‡ä»¶: $file"
              if jq empty "$file" 2>/dev/null; then
                echo "âœ… $file JSONè¯­æ³•æ­£ç¡®"
              else
                echo "âŒ $file JSONè¯­æ³•é”™è¯¯"
                exit 1
              fi
            done
          fi

      - name: ç¯å¢ƒé…ç½®éªŒè¯
        run: |
          set -euo pipefail
          echo "éªŒè¯ç¯å¢ƒç‰¹å®šé…ç½®..."
          read -r -a CONFIG_FILES <<< "${CONFIG_VALIDATION_FILES}"
          missing_required=0
          for config in "${CONFIG_FILES[@]}"; do
            if [ -f "$config" ]; then
              echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $config"
            else
              echo "âŒ é…ç½®æ–‡ä»¶ç¼ºå¤±: $config"
              missing_required=1
            fi
          done
          if [ "$missing_required" -ne 0 ]; then
            echo "âŒ éƒ¨åˆ†å¿…éœ€çš„ç¯å¢ƒé…ç½®æ–‡ä»¶ç¼ºå¤±ï¼Œç¯å¢ƒé…ç½®éªŒè¯å¤±è´¥"
            exit 1
          fi

  # =============================================================================
  # æœ€ç»ˆç¯å¢ƒéªŒè¯æŠ¥å‘Š
  # =============================================================================
  environment-report:
    name: "ç¯å¢ƒéªŒè¯æŠ¥å‘Š"
    - name: ç”Ÿæˆç¯å¢ƒæŠ¥å‘Š
      run: "REPORT_FILE=\"environment-report.txt\"\necho \"==========================================\"\
        \ | tee \"$REPORT_FILE\"\necho \" ç¯å¢ƒéªŒè¯æŠ¥å‘Š\" | tee -a \"$REPORT_FILE\"\necho\
        \ \"==========================================\" | tee -a \"$REPORT_FILE\"\
        \necho \"\" | tee -a \"$REPORT_FILE\"\necho \"\U0001F4CB ç¯å¢ƒæ£€æµ‹ç»“æœ:\" | tee -a\
        \ \"$REPORT_FILE\"\necho \" æ“ä½œç³»ç»Ÿ: ${{ needs.environment-detection.outputs.os-type\
        \ }}\" | tee -a \"$REPORT_FILE\"\necho \" ç³»ç»Ÿæ¶æ„: ${{ needs.environment-detection.outputs.arch-type\
        \ }}\" | tee -a \"$REPORT_FILE\"\necho \" å·¥å…·å¯ç”¨æ€§: ${{ needs.environment-detection.outputs.tools-available\
        \ }}\" | tee -a \"$REPORT_FILE\"\necho \"\" | tee -a \"$REPORT_FILE\"\necho\
        \ \"\U0001F4DC è„šæœ¬éªŒè¯ç»“æœ:\" | tee -a \"$REPORT_FILE\"\necho \" çŠ¶æ€: ${{ needs.script-validation.result\
        \ }}\" | tee -a \"$REPORT_FILE\"\necho \"\" | tee -a \"$REPORT_FILE\"\necho\
        \ \"âš™ï¸ é…ç½®éªŒè¯ç»“æœ:\" | tee -a \"$REPORT_FILE\"\necho \" çŠ¶æ€: ${{ needs.config-validation.result\
        \ }}\" | tee -a \"$REPORT_FILE\"\necho \"\" | tee -a \"$REPORT_FILE\"\necho\
        \ \"==========================================\" | tee -a \"$REPORT_FILE\"\
        \nif [ \"${{ needs.environment-detection.result }}\" = \"success\" ] && \\\
        \n   [ \"${{ needs.script-validation.result }}\" = \"success\" ] && \\\n \
        \  [ \"${{ needs.config-validation.result }}\" = \"success\" ]; then\n  echo\
        \ \"\U0001F389 ç¯å¢ƒéªŒè¯å…¨éƒ¨é€šè¿‡\" | tee -a \"$REPORT_FILE\"\nelse\n  echo \"âŒ ç¯å¢ƒéªŒè¯å¤±è´¥\"\
        \ | tee -a \"$REPORT_FILE\"\nfi\n"
    - if: always()
      name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: environment-validation-report
        path: environment-report.txt
        retention-days: 7
  script-validation:
    name: éƒ¨ç½²è„šæœ¬è¯­æ³•éªŒè¯
    needs: environment-detection
    runs-on: ubuntu-latest
    steps:
      - name: ç”Ÿæˆç¯å¢ƒæŠ¥å‘Š
        run: |
          REPORT_FILE="environment-report.txt"
          echo "==========================================" | tee "$REPORT_FILE"
          echo " ç¯å¢ƒéªŒè¯æŠ¥å‘Š" | tee -a "$REPORT_FILE"
          echo "==========================================" | tee -a "$REPORT_FILE"
          echo "" | tee -a "$REPORT_FILE"
          echo "ğŸ“‹ ç¯å¢ƒæ£€æµ‹ç»“æœ:" | tee -a "$REPORT_FILE"
          echo " æ“ä½œç³»ç»Ÿ: ${{ needs.environment-detection.outputs.os-type }}" | tee -a "$REPORT_FILE"
          echo " ç³»ç»Ÿæ¶æ„: ${{ needs.environment-detection.outputs.arch-type }}" | tee -a "$REPORT_FILE"
          echo " å·¥å…·å¯ç”¨æ€§: ${{ needs.environment-detection.outputs.tools-available }}" | tee -a "$REPORT_FILE"
          echo "" | tee -a "$REPORT_FILE"
          echo "ğŸ“œ è„šæœ¬éªŒè¯ç»“æœ:" | tee -a "$REPORT_FILE"
          echo " çŠ¶æ€: ${{ needs.script-validation.result }}" | tee -a "$REPORT_FILE"
          echo "" | tee -a "$REPORT_FILE"
          echo "âš™ï¸ é…ç½®éªŒè¯ç»“æœ:" | tee -a "$REPORT_FILE"
          echo " çŠ¶æ€: ${{ needs.config-validation.result }}" | tee -a "$REPORT_FILE"
          echo "" | tee -a "$REPORT_FILE"
          echo "==========================================" | tee -a "$REPORT_FILE"
          if [ "${{ needs.environment-detection.result }}" = "success" ] && \
             [ "${{ needs.script-validation.result }}" = "success" ] && \
             [ "${{ needs.config-validation.result }}" = "success" ]; then
            echo "ğŸ‰ ç¯å¢ƒéªŒè¯å…¨éƒ¨é€šè¿‡" | tee -a "$REPORT_FILE"
          else
            echo "âŒ ç¯å¢ƒéªŒè¯å¤±è´¥" | tee -a "$REPORT_FILE"
          fi

      - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        if: always()
        with:
          name: environment-validation-report
          path: environment-report.txt
          retention-days: 7
    - name: æ£€å‡ºä»£ç 
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: Shellè„šæœ¬è¯­æ³•æ£€æŸ¥
      run: "set -euo pipefail\necho \"éªŒè¯Shellè„šæœ¬è¯­æ³•...\"\nmapfile -t shell_files < <(find\
        \ . -name \"*.sh\" -type f)\nif [ ${#shell_files[@]} -eq 0 ]; then\n  echo\
        \ \"â„¹ï¸ æœªæ‰¾åˆ° Shell è„šæœ¬\"\nelse\n  for script in \"${shell_files[@]}\"; do\n \
        \   echo \"æ£€æŸ¥è„šæœ¬: $script\"\n    if bash -n \"$script\"; then\n      echo \"\
        âœ… $script è¯­æ³•æ­£ç¡®\"\n    else\n      echo \"âŒ $script è¯­æ³•é”™è¯¯\"\n      exit 1\n\
        \    fi\n  done\nfi\n"
    - name: Pythonè„šæœ¬è¯­æ³•æ£€æŸ¥
      run: "set -euo pipefail\necho \"éªŒè¯Pythonè„šæœ¬è¯­æ³•...\"\nmapfile -t python_files <\
        \ <(find . -name \"*.py\" -type f)\nif [ ${#python_files[@]} -eq 0 ]; then\n\
        \  echo \"â„¹ï¸ æœªæ‰¾åˆ° Python è„šæœ¬\"\nelse\n  for script in \"${python_files[@]}\"\
        ; do\n    echo \"æ£€æŸ¥è„šæœ¬: $script\"\n    if python3 -m py_compile \"$script\"\
        ; then\n      echo \"âœ… $script è¯­æ³•æ­£ç¡®\"\n    else\n      echo \"âŒ $script è¯­æ³•é”™è¯¯\"\
        \n      exit 1\n    fi\n  done\nfi\n"
    - name: éƒ¨ç½²è„šæœ¬åŠŸèƒ½éªŒè¯
      run: "set -euo pipefail\necho \"éªŒè¯ä¸»éƒ¨ç½²è„šæœ¬åŠŸèƒ½...\"\nif [ -f \"$DEPLOYER_SCRIPT\"\
        \ ]; then\n  echo \"âœ… æ‰¾åˆ°éƒ¨ç½²è„šæœ¬: $DEPLOYER_SCRIPT\"\n  chmod +x \"$DEPLOYER_SCRIPT\"\
        \n  if bash -n \"$DEPLOYER_SCRIPT\"; then\n    echo \"âœ… éƒ¨ç½²è„šæœ¬è¯­æ³•æ­£ç¡®\"\n  else\n\
        \    echo \"âŒ éƒ¨ç½²è„šæœ¬è¯­æ³•é”™è¯¯\"\n    exit 1\n  fi\nelse\n  echo \"âŒ éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨: $DEPLOYER_SCRIPT\"\
        \n  exit 1\nfi\n"
    timeout-minutes: 10
