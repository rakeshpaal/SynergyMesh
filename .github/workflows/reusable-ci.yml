---
name: Reusable CI Pipeline

on:
  workflow_call:
    inputs:
      working-directory:
        description: "Working directory for the project"
        required: true
        type: string
      service-name:
        description: "Service name for identification"
        required: true
        type: string
      node-version:
        description: "Node.js version"
        required: false
        type: string
        default: "18"
      enable-docker-build:
        description: "Enable Docker image build"
        required: false
        type: boolean
        default: false
      enable-sbom:
        description: "Enable SBOM generation"
        required: false
        type: boolean
        default: true
      enable-security-scan:
        description: "Enable security scanning"
        required: false
        type: boolean
        default: true
      enable-coverage-upload:
        description: "Enable coverage upload as artifact"
        required: false
        type: boolean
        default: false
      coverage-path:
        description: "Path to coverage folder (relative to working-directory)"
        required: false
        type: string
        default: "coverage/"
      custom-scripts:
        description: "Comma-separated list of custom npm scripts to run after standard CI steps"
        required: false
        type: string
        default: ""
    outputs:
      result:
        description: "CI pipeline result"
        value: ${{ jobs.ci-pipeline.result }}
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false
      COSIGN_PRIVATE_KEY:
        required: false
      COSIGN_PASSWORD:
        required: false

# Reusable workflow æ¬Šé™èªªæ˜ï¼š
# ç•¶æ­¤ workflow è¢«èª¿ç”¨æ™‚ï¼Œæ¬Šé™ç”±èª¿ç”¨æ–¹ workflow çš„é ‚å±¤ permissions æ±ºå®š
# ä¸å¯åœ¨ reusable workflow çš„ jobs ä¸­è¨­å®š permissionsï¼Œå¦å‰‡æœƒå°è‡´ startup_failure
# åƒè€ƒ: https://docs.github.com/en/actions/using-workflows/reusing-workflows#supported-keywords-for-jobs-that-call-a-reusable-workflow

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest
    # æ³¨æ„ï¼šä¸åœ¨æ­¤è™•è¨­å®š permissionsï¼Œç”±èª¿ç”¨æ–¹ workflow ç¹¼æ‰¿

    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: ğŸ” æª¢æŸ¥å°ˆæ¡ˆçµæ§‹
        id: check-structure
        run: |
          echo "service=${{ inputs.service-name }}" >> $GITHUB_OUTPUT
          echo "working_dir=${{ inputs.working-directory }}" >> $GITHUB_OUTPUT

          # æª¢æŸ¥å¿…è¦æª”æ¡ˆ
          if [ -f "package.json" ]; then
            echo "has_package_json=true" >> $GITHUB_OUTPUT
          else
            echo "has_package_json=false" >> $GITHUB_OUTPUT
          fi

          if [ -f "Dockerfile" ]; then
            echo "has_dockerfile=true" >> $GITHUB_OUTPUT
          else
            echo "has_dockerfile=false" >> $GITHUB_OUTPUT
          fi

          # æª¢æŸ¥ package-lock.json ä½ç½®ï¼ˆæ”¯æ´ monorepo/workspaceï¼‰
          # æ³¨æ„ï¼šcache-dependency-path éœ€è¦å¾ repository root é–‹å§‹çš„è·¯å¾‘
          if [ -f "package-lock.json" ]; then
            # å·¥ä½œç›®éŒ„ä¸­æœ‰ package-lock.json
            echo "lock_file_path=${{ inputs.working-directory }}/package-lock.json" >> $GITHUB_OUTPUT
          elif [ -f "${{ github.workspace }}/package-lock.json" ]; then
            # ä½¿ç”¨ root ç›®éŒ„çš„ package-lock.jsonï¼ˆé©ç”¨æ–¼ monorepo/workspaceï¼‰
            echo "lock_file_path=package-lock.json" >> $GITHUB_OUTPUT
          else
            # æ²’æœ‰æ‰¾åˆ° package-lock.jsonï¼Œåœç”¨å¿«å–
            echo "lock_file_path=" >> $GITHUB_OUTPUT
          fi

      - name: ğŸŸ¢ Setup Node.js
        if: steps.check-structure.outputs.has_package_json == 'true'
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ steps.check-structure.outputs.lock_file_path != '' && 'npm' || '' }}
          cache-dependency-path: ${{ steps.check-structure.outputs.lock_file_path }}

      - name: ğŸ“¦ Install dependencies
        if: steps.check-structure.outputs.has_package_json == 'true'
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: ğŸ” Lint check
        if: steps.check-structure.outputs.has_package_json == 'true'
        run: |
          if npm run | grep -q "lint"; then
            npm run lint
          else
            echo "âš ï¸ ç•¥é lint (ç„¡å°æ‡‰ script)"
          fi

      - name: ğŸ”¬ Type check
        if: steps.check-structure.outputs.has_package_json == 'true'
        run: |
          if npm run | grep -q "typecheck\|type-check"; then
            npm run typecheck || npm run type-check || true
          else
            echo "âš ï¸ ç•¥é typecheck (ç„¡å°æ‡‰ script)"
          fi

      - name: ğŸ§ª Unit tests
        if: steps.check-structure.outputs.has_package_json == 'true'
        run: |
          if npm run | grep -q "test"; then
            # Check if the test script uses Node.js native test runner
            test_script=$(node -p "require('./package.json').scripts?.test || ''" 2>/dev/null || echo "")
            if [ -z "$test_script" ]; then
              echo "âš ï¸ Unable to parse test script from package.json"
              npm test
            elif echo "$test_script" | grep -q "node --test"; then
              # Node.js native test runner doesn't support --ci or --coverage
              echo "ğŸ” Detected Node.js native test runner, running without extra flags"
              npm test
            else
              # Jest or other test runners support these flags
              npm test -- --ci --coverage
            fi
          else
            echo "âš ï¸ ç•¥é tests (ç„¡å°æ‡‰ script)"
          fi

      - name: ğŸ—ï¸ Build
        if: steps.check-structure.outputs.has_package_json == 'true'
        run: |
          if npm run | grep -q "build"; then
            npm run build
          else
            echo "âš ï¸ ç•¥é build (ç„¡å°æ‡‰ script)"
          fi

      - name: ğŸ“‹ Generate SBOM
        if: inputs.enable-sbom == true && steps.check-structure.outputs.has_package_json == 'true'
        run: |
          npx @cyclonedx/cyclonedx-npm --output-file sbom.json || echo "âš ï¸ SBOM ç”Ÿæˆå¤±æ•—"

      - name: ğŸ”’ Security scan
        if: inputs.enable-security-scan == true && steps.check-structure.outputs.has_package_json == 'true'
        run: |
          npm audit --audit-level=moderate || echo "âš ï¸ ç™¼ç¾å®‰å…¨æ¼æ´"

      - name: ğŸ”§ Run custom scripts
        if: inputs.custom-scripts != '' && steps.check-structure.outputs.has_package_json == 'true'
        run: |
          IFS=',' read -ra SCRIPTS <<< "${{ inputs.custom-scripts }}"
          for script in "${SCRIPTS[@]}"; do
            script=$(echo "$script" | xargs)  # trim whitespace
            if [ -n "$script" ]; then
              # Validate script name contains only allowed characters (alphanumeric, hyphens, colons, underscores)
              if [[ ! "$script" =~ ^[a-zA-Z0-9:_-]+$ ]]; then
                echo "âŒ Invalid script name: $script (only alphanumeric, hyphens, colons, and underscores allowed)"
                exit 1
              fi
              echo "ğŸ”§ Running: npm run $script"
              npm run "$script"
            fi
          done

      - name: ğŸ“Š Upload coverage
        if: inputs.enable-coverage-upload == true && always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: ${{ inputs.service-name }}-coverage
          path: ${{ inputs.working-directory }}/${{ inputs.coverage-path }}
          retention-days: 7

      - name: ğŸ³ Build Docker image
        if: inputs.enable-docker-build == true && steps.check-structure.outputs.has_dockerfile == 'true'
        run: |
          docker build -t ${{ inputs.service-name }}:${{ github.sha }} .

      - name: âœ… CI Pipeline complete
        run: |
          echo "âœ… ${{ inputs.service-name }} CI å®Œæˆ"
          echo "ğŸ“ Working directory: ${{ inputs.working-directory }}"
