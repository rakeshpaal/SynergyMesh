# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    ğŸ¤– Autonomous CI Guardian
#                    è‡ªå‹•é§•é§›ç´š CI/CD å®ˆè­·è€…
#                    Version: 1.0.0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# è·è²¬ï¼š
# - é æ¸¬æ€§æ•…éšœæª¢æ¸¬ (Predictive Failure Detection)
# - è‡ªå‹•ä¿®å¾© (Auto Remediation)
# - é¢¨éšªè©•ä¼° (Risk Assessment)
# - å¯©è¨ˆæ—¥èªŒ (Audit Logging)
# - åˆè¦æ€§è¿½è¹¤ (Compliance Tracking)
#
# ç›¸é—œæ–‡æª”ï¼š
# - docs/autonomous-ci-compliance.md
# - config/ci-comprehensive-solution.yaml
# - config/ci-error-handler.yaml

name: ğŸ¤– Autonomous CI Guardian

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      risk_level:
        description: 'Override risk level for testing'
        required: false
        type: choice
        options:
          - LOW
          - MEDIUM
          - HIGH
          - CRITICAL
      skip_remediation:
        description: 'Skip auto-remediation'
        required: false
        type: boolean
        default: false

# Workflow-level permissions (required for reusable workflows)
permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read
  checks: write

# Concurrency control to avoid conflicts
concurrency:
  group: autonomous-ci-${{ github.ref }}
  cancel-in-progress: false  # Keep for audit trail

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #                        é æ¸¬æ€§æ•…éšœæª¢æ¸¬
  #                        Predictive Failure Detection
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  predictive-failure-detection:
    name: ğŸ” Predictive Failure Detection
    runs-on: ubuntu-latest
    outputs:
      risk_level: ${{ steps.risk_assessment.outputs.level }}
      proceed: ${{ steps.risk_assessment.outputs.proceed }}
      predicted_failures: ${{ steps.failure_analysis.outputs.predictions }}
      critical_vulns: ${{ steps.security_scan.outputs.critical_count }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci || npm install --legacy-peer-deps
          if [ -f requirements-workflow.txt ]; then
            pip install -r requirements-workflow.txt
          else
            echo "No requirements file found"
          fi
      
      - name: ğŸ” Analyze Code Changes
        id: failure_analysis
        run: |
          echo "Analyzing code changes for potential failures..."
          
          # Initialize predictions with defaults
          PREDICTIONS='{
            "patterns": {
              "security": 0,
              "docker": 0,
              "test": 0,
              "performance": 0,
              "memory": 0
            },
            "risk_score": 0.0,
            "high_risk_areas": []
          }'
          
          # Analyze changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD || echo "")
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Pattern detection
          SECURITY_CHANGES=$(echo "$CHANGED_FILES" | grep -iE "(security|auth|crypto|token)" | wc -l || echo 0)
          DOCKER_CHANGES=$(echo "$CHANGED_FILES" | grep -iE "(dockerfile|docker-compose)" | wc -l || echo 0)
          TEST_CHANGES=$(echo "$CHANGED_FILES" | grep -iE "\.test\.|\.spec\." | wc -l || echo 0)
          PERF_CHANGES=$(echo "$CHANGED_FILES" | grep -iE "(performance|benchmark)" | wc -l || echo 0)
          MEMORY_CHANGES=$(echo "$CHANGED_FILES" | grep -iE "(memory|heap|buffer)" | wc -l || echo 0)
          
          # Calculate risk score (0.0 to 1.0) using awk instead of bc
          TOTAL_CHANGES=$(echo "$CHANGED_FILES" | wc -l || echo 1)
          RISK_SCORE=$(awk "BEGIN {printf \"%.2f\", ($SECURITY_CHANGES * 3 + $DOCKER_CHANGES * 2 + $TEST_CHANGES * 1.5 + $PERF_CHANGES * 1.5 + $MEMORY_CHANGES * 2) / ($TOTAL_CHANGES * 10)}" || echo "0.0")
          
          # Build predictions JSON
          PREDICTIONS=$(cat <<EOF
          {
            "patterns": {
              "security": $SECURITY_CHANGES,
              "docker": $DOCKER_CHANGES,
              "test": $TEST_CHANGES,
              "performance": $PERF_CHANGES,
              "memory": $MEMORY_CHANGES
            },
            "risk_score": $RISK_SCORE,
            "high_risk_areas": []
          }
          EOF
          )
          
          echo "predictions=$PREDICTIONS" >> $GITHUB_OUTPUT
          echo "PREDICTED_FAILURES=$PREDICTIONS" >> $GITHUB_ENV
      
      - name: ğŸ›¡ï¸ Quick Security Scan
        id: security_scan
        run: |
          echo "Running quick security scan..."
          
          # npm audit
          if [ -f "package.json" ]; then
            AUDIT_OUTPUT=$(npm audit --json || true)
            CRITICAL_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.critical // 0' || echo 0)
            HIGH_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.high // 0' || echo 0)
          else
            CRITICAL_COUNT=0
            HIGH_COUNT=0
          fi
          
          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "CRITICAL_VULNS=$CRITICAL_COUNT" >> $GITHUB_ENV
          
          echo "Security scan complete:"
          echo "  Critical: $CRITICAL_COUNT"
          echo "  High: $HIGH_COUNT"
      
      - name: ğŸ“Š Risk Assessment
        id: risk_assessment
        run: |
          echo "Performing risk assessment..."
          
          # Use manual override if provided
          if [ "${{ github.event.inputs.risk_level }}" != "" ]; then
            echo "Using manual risk level: ${{ github.event.inputs.risk_level }}"
            LEVEL="${{ github.event.inputs.risk_level }}"
            PROCEED="true"
          else
            # Run risk assessment script
            RESULT=$(python3 .github/scripts/risk_assessment.py || echo '{"level":"LOW","proceed":"true","details":{}}')
            LEVEL=$(echo "$RESULT" | jq -r '.level')
            PROCEED=$(echo "$RESULT" | jq -r '.proceed')
          fi
          
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "proceed=$PROCEED" >> $GITHUB_OUTPUT
          
          echo "Risk Assessment Result:"
          echo "  Level: $LEVEL"
          echo "  Proceed: $PROCEED"
      
      - name: ğŸ“ Generate Audit Log
        run: |
          echo "Generating audit log..."
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          AUDIT_LOG=$(cat <<EOF
          {
            "change_id": "CHG-${{ github.run_id }}",
            "timestamp": "$TIMESTAMP",
            "actor": "${{ github.actor }}",
            "action": "CI_ANALYSIS",
            "environment": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "risk_assessment": {
              "level": "${{ steps.risk_assessment.outputs.level }}",
              "proceed": "${{ steps.risk_assessment.outputs.proceed }}"
            },
            "workflow_run": "${{ github.run_id }}",
            "event_type": "${{ github.event_name }}"
          }
          EOF
          )
          
          echo "$AUDIT_LOG" | tee audit-log.json
          
          # Archive audit log
          mkdir -p .github/audit-logs
          echo "$AUDIT_LOG" > ".github/audit-logs/audit-${{ github.run_id }}.json"
      
      - name: ğŸ“¤ Upload Audit Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audit-logs
          path: .github/audit-logs/
          retention-days: 90

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #                        è‡ªå‹•ä¿®å¾©
  #                        Auto Remediation
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  auto-remediation:
    name: ğŸ”§ Auto Remediation
    runs-on: ubuntu-latest
    needs: predictive-failure-detection
    if: ${{ needs.predictive-failure-detection.outputs.proceed == 'true' && github.event.inputs.skip_remediation != 'true' }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci || npm install --legacy-peer-deps
      
      - name: ğŸ” Run Linters
        id: lint
        continue-on-error: true
        run: |
          echo "Running linters..."
          npm run lint 2>&1 | tee lint-output.txt
          LINT_EXIT=$?
          
          if [ $LINT_EXIT -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "Attempting auto-fix..."
            if npm run lint -- --fix 2>&1 | tee -a lint-output.txt; then
              echo "status=fixed" >> $GITHUB_OUTPUT
            else
              echo "status=failure" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: ğŸ§ª Run Tests
        id: test
        continue-on-error: true
        run: |
          echo "Running tests..."
          npm test 2>&1 | tee test-output.txt
          TEST_EXIT=$?
          
          if [ $TEST_EXIT -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ—ï¸ Build
        id: build
        continue-on-error: true
        run: |
          echo "Building project..."
          npm run build 2>&1 | tee build-output.txt
          BUILD_EXIT=$?
          
          if [ $BUILD_EXIT -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“Š Remediation Summary
        id: remediation_summary
        run: |
          echo "Generating remediation summary..."
          
          LINT_STATUS="${{ steps.lint.outputs.status }}"
          TEST_STATUS="${{ steps.test.outputs.status }}"
          BUILD_STATUS="${{ steps.build.outputs.status }}"
          
          # Determine overall status
          if [ "$LINT_STATUS" = "success" ] && [ "$TEST_STATUS" = "success" ] && [ "$BUILD_STATUS" = "success" ]; then
            OVERALL_STATUS="success"
          elif [ "$LINT_STATUS" = "fixed" ]; then
            OVERALL_STATUS="warning"
          else
            OVERALL_STATUS="failure"
          fi
          
          echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          
          # Build job summaries
          JOB_SUMMARIES=$(cat <<EOF
          {
            "lint": {
              "status": "$LINT_STATUS",
              "message": "Lint check $([ "$LINT_STATUS" = "success" ] && echo "passed" || echo "failed")"
            },
            "test": {
              "status": "$TEST_STATUS",
              "message": "Tests $([ "$TEST_STATUS" = "success" ] && echo "passed" || echo "failed")"
            },
            "build": {
              "status": "$BUILD_STATUS",
              "message": "Build $([ "$BUILD_STATUS" = "success" ] && echo "passed" || echo "failed")"
            }
          }
          EOF
          )
          
          echo "JOB_SUMMARIES=$JOB_SUMMARIES" >> $GITHUB_ENV
          echo "OVERALL_STATUS=$OVERALL_STATUS" >> $GITHUB_ENV
          echo "CI_NAME=Autonomous CI Guardian" >> $GITHUB_ENV
          echo "WORKFLOW_RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
      
      - name: ğŸ’¬ Generate CI Comment
        if: github.event_name == 'pull_request'
        run: |
          echo "Generating CI comment..."
          python3 .github/scripts/generate-consolidated-comment.py
          
          if [ -f "comment_body.md" ]; then
            echo "Comment generated successfully"
            cat comment_body.md
          fi
      
      - name: ğŸ“¤ Upload Remediation Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: remediation-results
          path: |
            lint-output.txt
            test-output.txt
            build-output.txt
            comment_body.md
          retention-days: 30
      
      - name: ğŸ“ Post PR Comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read comment body if exists
            let commentBody = '## ğŸ¤– Autonomous CI Guardian Report\n\nAnalysis in progress...';
            try {
              commentBody = fs.readFileSync('comment_body.md', 'utf8');
            } catch (e) {
              console.log('Comment file not found, using default');
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.body.includes('CI_REPORT:autonomous-ci-guardian')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              console.log('Created new comment');
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #                        åˆè¦æ€§å ±å‘Š
  #                        Compliance Reporting
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  compliance-reporting:
    name: ğŸ“‹ Compliance Reporting
    runs-on: ubuntu-latest
    needs: [predictive-failure-detection, auto-remediation]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: ğŸ“Š Generate Compliance Report
        run: |
          echo "Generating compliance report..."
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          RISK_LEVEL="${{ needs.predictive-failure-detection.outputs.risk_level }}"
          
          COMPLIANCE_REPORT=$(cat <<EOF
          # ğŸ›¡ï¸ Autonomous CI Guardian - Compliance Report
          
          **Workflow Run**: ${{ github.run_id }}
          **Timestamp**: $TIMESTAMP
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}
          **Actor**: ${{ github.actor }}
          **Event**: ${{ github.event_name }}
          
          ## Risk Assessment
          - **Risk Level**: $RISK_LEVEL
          - **Proceed**: ${{ needs.predictive-failure-detection.outputs.proceed }}
          
          ## Remediation Status
          - **Overall**: ${{ needs.auto-remediation.result }}
          
          ## Audit Trail
          - Full audit logs archived for 90 days
          - Change ID: CHG-${{ github.run_id }}
          
          ## Compliance
          - âœ… Change tracking: Complete
          - âœ… Risk assessment: Complete
          - âœ… Audit logging: Complete
          - âœ… Remediation attempted: ${{ needs.auto-remediation.result != 'skipped' }}
          
          ## Documentation
          - [Autonomous CI Compliance](docs/autonomous-ci-compliance.md)
          - [CI Comprehensive Solution](config/ci-comprehensive-solution.yaml)
          
          ---
          _Generated by Autonomous CI Guardian v1.0.0_
          EOF
          )
          
          echo "$COMPLIANCE_REPORT" | tee compliance-report.md
      
      - name: ğŸ“¤ Upload Compliance Report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: compliance-report.md
          retention-days: 90
      
      - name: ğŸ“Š Workflow Summary
        run: |
          cat compliance-report.md >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #                        é€šçŸ¥èˆ‡å‘Šè­¦
  #                        Notifications & Alerting
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notifications:
    name: ğŸ”” Notifications
    runs-on: ubuntu-latest
    needs: [predictive-failure-detection, auto-remediation]
    if: always() && (needs.predictive-failure-detection.outputs.risk_level == 'HIGH' || needs.predictive-failure-detection.outputs.risk_level == 'CRITICAL')
    
    steps:
      - name: ğŸ”” High Risk Alert
        run: |
          echo "::warning::High risk deployment detected!"
          echo "Risk Level: ${{ needs.predictive-failure-detection.outputs.risk_level }}"
          echo "Manual review may be required before deployment."
