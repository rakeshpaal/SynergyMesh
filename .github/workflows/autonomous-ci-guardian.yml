# =============================================================================
# ğŸ¤– Autonomous CI Guardian
# è‡ªä¸» CI å®ˆè­·è€… - é æ¸¬æ€§å¤±æ•—æª¢æ¸¬èˆ‡è‡ªå‹•ä¿®å¾©
# =============================================================================
name: "ğŸ¤– Autonomous CI Guardian"

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

# Cost protection: prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  FAILURE_THRESHOLD: 3
  DETECTION_WINDOW: "24h"

jobs:
  # =============================================================================
  # é æ¸¬æ€§å¤±æ•—æª¢æ¸¬ (Predictive Failure Detection)
  # =============================================================================
  predictive-failure-detection:
    name: "é æ¸¬æ€§å¤±æ•—æª¢æ¸¬"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    outputs:
      failure-risk: ${{ steps.analyze.outputs.risk-level }}
      patterns-detected: ${{ steps.analyze.outputs.patterns }}

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for pattern analysis

      - name: è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£åˆ†æå·¥å…·
        run: |
          pip install --user pyyaml requests

      - name: åˆ†ææ­·å²å¤±æ•—æ¨¡å¼
        id: analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "ğŸ” åˆ†æ CI æ­·å²å¤±æ•—æ¨¡å¼..."

          # Get changed files in this PR
          echo "ğŸ“ æª¢æ¸¬è®Šæ›´çš„æª”æ¡ˆ..."
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

          # Count changed files by type
          CHANGED_COUNT=$(wc -l < changed_files.txt)
          echo "è®Šæ›´æª”æ¡ˆæ•¸é‡: $CHANGED_COUNT"

          # Analyze file patterns
          YAML_CHANGES=$(grep -c '\.ya\?ml$' changed_files.txt || true)
          PYTHON_CHANGES=$(grep -c '\.py$' changed_files.txt || true)
          SCRIPT_CHANGES=$(grep -c '\.sh$' changed_files.txt || true)
          CONFIG_CHANGES=$(grep -c '^config/' changed_files.txt || true)
          WORKFLOW_CHANGES=$(grep -c '\.github/workflows/' changed_files.txt || true)

          echo "ğŸ“Š è®Šæ›´çµ±è¨ˆ:"
          echo "  YAML æª”æ¡ˆ: $YAML_CHANGES"
          echo "  Python æª”æ¡ˆ: $PYTHON_CHANGES"
          echo "  Shell è…³æœ¬: $SCRIPT_CHANGES"
          echo "  é…ç½®æª”æ¡ˆ: $CONFIG_CHANGES"
          echo "  å·¥ä½œæµç¨‹: $WORKFLOW_CHANGES"

          # Calculate risk level
          RISK_SCORE=0
          PATTERNS=""

          if [ "$YAML_CHANGES" -gt 5 ]; then
            RISK_SCORE=$((RISK_SCORE + 2))
            PATTERNS="${PATTERNS}large-yaml-changes,"
            echo "âš ï¸  å¤§é‡ YAML è®Šæ›´æª¢æ¸¬åˆ° (é¢¨éšª +2)"
          fi

          if [ "$WORKFLOW_CHANGES" -gt 0 ]; then
            RISK_SCORE=$((RISK_SCORE + 3))
            PATTERNS="${PATTERNS}workflow-changes,"
            echo "âš ï¸  å·¥ä½œæµç¨‹è®Šæ›´æª¢æ¸¬åˆ° (é¢¨éšª +3)"
          fi

          if [ "$CONFIG_CHANGES" -gt 3 ]; then
            RISK_SCORE=$((RISK_SCORE + 2))
            PATTERNS="${PATTERNS}config-changes,"
            echo "âš ï¸  é…ç½®æª”æ¡ˆè®Šæ›´æª¢æ¸¬åˆ° (é¢¨éšª +2)"
          fi

          if [ "$CHANGED_COUNT" -gt 20 ]; then
            RISK_SCORE=$((RISK_SCORE + 1))
            PATTERNS="${PATTERNS}large-changeset,"
            echo "â„¹ï¸  å¤§å‹è®Šæ›´é›†æª¢æ¸¬åˆ° (é¢¨éšª +1)"
          fi

          # Determine risk level
          RISK_LEVEL="low"
          if [ "$RISK_SCORE" -ge 5 ]; then
            RISK_LEVEL="high"
          elif [ "$RISK_SCORE" -ge 3 ]; then
            RISK_LEVEL="medium"
          fi

          echo "risk-level=$RISK_LEVEL" >> $GITHUB_OUTPUT
          echo "patterns=${PATTERNS%,}" >> $GITHUB_OUTPUT
          echo "risk-score=$RISK_SCORE" >> $GITHUB_OUTPUT

          echo ""
          echo "ğŸ“Š å¤±æ•—é¢¨éšªè©•ä¼°çµæœ:"
          echo "  é¢¨éšªç­‰ç´š: $RISK_LEVEL"
          echo "  é¢¨éšªåˆ†æ•¸: $RISK_SCORE"
          echo "  æª¢æ¸¬åˆ°çš„æ¨¡å¼: ${PATTERNS%,}"

      - name: ç”Ÿæˆé¢¨éšªå ±å‘Š
        run: |
          set -euo pipefail

          RISK_LEVEL="${{ steps.analyze.outputs.risk-level }}"
          PATTERNS="${{ steps.analyze.outputs.patterns }}"

          cat > risk-report.md << 'EOF'
          ## ğŸ” é æ¸¬æ€§å¤±æ•—æª¢æ¸¬å ±å‘Š

          **é¢¨éšªç­‰ç´š**: ${{ steps.analyze.outputs.risk-level }}
          **é¢¨éšªåˆ†æ•¸**: ${{ steps.analyze.outputs.risk-score }}
          **æª¢æ¸¬æ¨¡å¼**: ${{ steps.analyze.outputs.patterns }}

          ### å»ºè­°æªæ–½

          EOF

          if [ "$RISK_LEVEL" = "high" ]; then
            cat >> risk-report.md << 'EOF'
          - âš ï¸  **é«˜é¢¨éšªè®Šæ›´æª¢æ¸¬åˆ°**
          - å»ºè­°é€²è¡Œé¡å¤–çš„äººå·¥å¯©æŸ¥
          - å»ºè­°åœ¨åˆä½µå‰é€²è¡Œæ›´å…¨é¢çš„æ¸¬è©¦
          - è€ƒæ…®åˆ†æ‰¹æ¬¡æäº¤è®Šæ›´ä»¥é™ä½é¢¨éšª
          EOF
          elif [ "$RISK_LEVEL" = "medium" ]; then
            cat >> risk-report.md << 'EOF'
          - â„¹ï¸  **ä¸­ç­‰é¢¨éšªè®Šæ›´æª¢æ¸¬åˆ°**
          - å»ºè­°ä»”ç´°æª¢æŸ¥æ‰€æœ‰æ¸¬è©¦çµæœ
          - ç¢ºä¿æ–‡æª”å·²æ›´æ–°
          EOF
          else
            cat >> risk-report.md << 'EOF'
          - âœ… **ä½é¢¨éšªè®Šæ›´**
          - æ¨™æº–å¯©æŸ¥æµç¨‹å³å¯
          EOF
          fi

          echo ""
          cat risk-report.md

      - name: ä¸Šå‚³é¢¨éšªå ±å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: predictive-failure-report
          path: risk-report.md
          retention-days: 30

  # =============================================================================
  # è‡ªå‹•ä¿®å¾© (Auto-Remediation)
  # =============================================================================
  auto-remediation:
    name: "è‡ªå‹•ä¿®å¾©ç³»çµ±"
    runs-on: ubuntu-latest
    needs: predictive-failure-detection
    if: github.event_name == 'pull_request'
    timeout-minutes: 15
    outputs:
      issues-found: ${{ steps.detect.outputs.issues-found }}
      issues-fixed: ${{ steps.detect.outputs.issues-fixed }}

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£ä¿®å¾©å·¥å…·
        run: |
          pip install --user pyyaml yamllint

      - name: æª¢æ¸¬å¸¸è¦‹å•é¡Œ
        env:
          PATH: ${{ env.PATH }}:$HOME/.local/bin
        id: detect
        run: |
          set -euo pipefail

          echo "ğŸ” æª¢æ¸¬å¸¸è¦‹ CI å¤±æ•—åŸå› ..."

          ISSUES_FOUND=0
          ISSUES_FIXED=0

          # Check for YAML syntax issues
          echo "æª¢æŸ¥ YAML èªæ³•å•é¡Œ..."
          mapfile -t yaml_files < <(find . -type f \( -name "*.yaml" -o -name "*.yml" \) \
            ! -path "*/node_modules/*" ! -path "*/.git/*")

          YAML_ISSUES=0
          if [ ${#yaml_files[@]} -gt 0 ]; then
            for file in "${yaml_files[@]}"; do
              if ! "$HOME/.local/bin/yamllint" -f parsable "$file" > /dev/null 2>&1; then
                echo "âš ï¸  YAML å•é¡Œæª¢æ¸¬åˆ°: $file"
                YAML_ISSUES=$((YAML_ISSUES + 1))
              fi
            done
          fi

          if [ "$YAML_ISSUES" -gt 0 ]; then
            ISSUES_FOUND=$((ISSUES_FOUND + YAML_ISSUES))
            echo "yaml-issues=$YAML_ISSUES" >> $GITHUB_OUTPUT
          fi

          # Check for common script issues
          echo "æª¢æŸ¥ Shell è…³æœ¬å•é¡Œ..."
          mapfile -t shell_files < <(find . -type f -name "*.sh" ! -path "*/node_modules/*" ! -path "*/.git/*")

          SCRIPT_ISSUES=0
          if [ ${#shell_files[@]} -gt 0 ]; then
            for script in "${shell_files[@]}"; do
              if [ -f "$script" ] && ! bash -n "$script" > /dev/null 2>&1; then
                echo "âš ï¸  Shell è…³æœ¬å•é¡Œæª¢æ¸¬åˆ°: $script"
                SCRIPT_ISSUES=$((SCRIPT_ISSUES + 1))
              fi
            done
          fi

          if [ "$SCRIPT_ISSUES" -gt 0 ]; then
            ISSUES_FOUND=$((ISSUES_FOUND + SCRIPT_ISSUES))
            echo "script-issues=$SCRIPT_ISSUES" >> $GITHUB_OUTPUT
          fi

          # Check for Python syntax issues
          echo "æª¢æŸ¥ Python èªæ³•å•é¡Œ..."
          mapfile -t python_files < <(find . -type f -name "*.py" \
            ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/__pycache__/*")

          PYTHON_ISSUES=0
          if [ ${#python_files[@]} -gt 0 ]; then
            for pyfile in "${python_files[@]}"; do
              if [ -f "$pyfile" ] && ! python3 -m py_compile "$pyfile" > /dev/null 2>&1; then
                echo "âš ï¸  Python èªæ³•å•é¡Œæª¢æ¸¬åˆ°: $pyfile"
                PYTHON_ISSUES=$((PYTHON_ISSUES + 1))
              fi
            done
          fi

          if [ "$PYTHON_ISSUES" -gt 0 ]; then
            ISSUES_FOUND=$((ISSUES_FOUND + PYTHON_ISSUES))
            echo "python-issues=$PYTHON_ISSUES" >> $GITHUB_OUTPUT
          fi

          echo "issues-found=$ISSUES_FOUND" >> $GITHUB_OUTPUT
          echo "issues-fixed=$ISSUES_FIXED" >> $GITHUB_OUTPUT

          echo ""
          echo "ğŸ“Š æª¢æ¸¬çµæœæ‘˜è¦:"
          echo "  YAML å•é¡Œ: $YAML_ISSUES"
          echo "  Shell è…³æœ¬å•é¡Œ: $SCRIPT_ISSUES"
          echo "  Python å•é¡Œ: $PYTHON_ISSUES"
          echo "  ç¸½å•é¡Œæ•¸: $ISSUES_FOUND"

      - name: å˜—è©¦è‡ªå‹•ä¿®å¾©
        if: steps.detect.outputs.issues-found > 0
        run: |
          set -euo pipefail

          echo "ğŸ”§ å˜—è©¦è‡ªå‹•ä¿®å¾©æª¢æ¸¬åˆ°çš„å•é¡Œ..."

          # Note: Actual auto-fix logic would go here
          # For now, we report issues that need manual attention

          echo "â„¹ï¸  æª¢æ¸¬åˆ° ${{ steps.detect.outputs.issues-found }} å€‹å•é¡Œ"
          echo "â„¹ï¸  é€™äº›å•é¡Œéœ€è¦äººå·¥å¯©æŸ¥å’Œä¿®å¾©"
          echo ""
          echo "ğŸ“‹ å»ºè­°çš„ä¿®å¾©æ­¥é©Ÿ:"

          if [ "${{ steps.detect.outputs.yaml-issues }}" != "" ]; then
            echo "1. é‹è¡Œ 'yamllint' æª¢æŸ¥ YAML èªæ³•"
            echo "   ä¿®å¾©å ±å‘Šçš„èªæ³•éŒ¯èª¤"
          fi

          if [ "${{ steps.detect.outputs.script-issues }}" != "" ]; then
            echo "2. ä½¿ç”¨ 'bash -n' é©—è­‰ Shell è…³æœ¬èªæ³•"
            echo "   ä¿®å¾©å ±å‘Šçš„è…³æœ¬éŒ¯èª¤"
          fi

          if [ "${{ steps.detect.outputs.python-issues }}" != "" ]; then
            echo "3. ä½¿ç”¨ 'python3 -m py_compile' æª¢æŸ¥ Python èªæ³•"
            echo "   ä¿®å¾©å ±å‘Šçš„ Python éŒ¯èª¤"
          fi

      - name: ç”Ÿæˆä¿®å¾©å ±å‘Š
        if: always()
        run: |
          set -euo pipefail

          cat > remediation-report.md << 'EOF'
          ## ğŸ”§ è‡ªå‹•ä¿®å¾©å ±å‘Š

          **æª¢æ¸¬åˆ°çš„å•é¡Œ**: ${{ steps.detect.outputs.issues-found || 0 }}
          **å·²ä¿®å¾©çš„å•é¡Œ**: ${{ steps.detect.outputs.issues-fixed || 0 }}

          ### æª¢æ¸¬è©³æƒ…

          - YAML å•é¡Œ: ${{ steps.detect.outputs.yaml-issues || 0 }}
          - Shell è…³æœ¬å•é¡Œ: ${{ steps.detect.outputs.script-issues || 0 }}
          - Python å•é¡Œ: ${{ steps.detect.outputs.python-issues || 0 }}

          ### ç‹€æ…‹

          EOF

          if [ "${{ steps.detect.outputs.issues-found }}" = "0" ]; then
            echo "âœ… æœªæª¢æ¸¬åˆ°å•é¡Œï¼Œä»£ç¢¼è³ªé‡è‰¯å¥½" >> remediation-report.md
          else
            echo "âš ï¸  æª¢æ¸¬åˆ°å•é¡Œéœ€è¦ä¿®å¾©" >> remediation-report.md
            echo "" >> remediation-report.md
            echo "è«‹æŸ¥çœ‹ä¸Šæ–¹çš„æ­¥é©Ÿè¼¸å‡ºä»¥ç²å–è©³ç´°ä¿¡æ¯ã€‚" >> remediation-report.md
          fi

          echo ""
          cat remediation-report.md

      - name: ä¸Šå‚³ä¿®å¾©å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auto-remediation-report
          path: remediation-report.md
          retention-days: 30

  # =============================================================================
  # æœ€çµ‚å ±å‘Š (Final Report)
  # =============================================================================
  guardian-report:
    name: "Guardian æœ€çµ‚å ±å‘Š"
    runs-on: ubuntu-latest
    needs: [predictive-failure-detection, auto-remediation]
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: ä¸‹è¼‰å ±å‘Š
        uses: actions/download-artifact@v4
        with:
          pattern: "*-report"
          merge-multiple: true

      - name: ç”Ÿæˆç¶œåˆå ±å‘Š
        run: |
          set -euo pipefail

          echo "# ğŸ¤– Autonomous CI Guardian - ç¶œåˆå ±å‘Š"
          echo ""
          echo "**PR**: #${{ github.event.pull_request.number }}"
          echo "**åˆ†æ”¯**: ${{ github.head_ref }}"
          echo "**æäº¤**: ${{ github.sha }}"
          echo ""

          if [ -f "risk-report.md" ]; then
            echo "---"
            cat risk-report.md
            echo ""
          fi

          if [ -f "remediation-report.md" ]; then
            echo "---"
            cat remediation-report.md
            echo ""
          fi

          echo "---"
          echo ""
          echo "### å·¥ä½œæµç¨‹ç‹€æ…‹"
          echo ""
          echo "- é æ¸¬æ€§å¤±æ•—æª¢æ¸¬: ${{ needs.predictive-failure-detection.result }}"
          echo "- è‡ªå‹•ä¿®å¾©: ${{ needs.auto-remediation.result }}"
          echo ""

          if [ "${{ needs.predictive-failure-detection.result }}" = "success" ] && \
             [ "${{ needs.auto-remediation.result }}" = "success" ]; then
            echo "âœ… **æ‰€æœ‰ Guardian æª¢æŸ¥é€šé**"
          else
            echo "âš ï¸  **éƒ¨åˆ† Guardian æª¢æŸ¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹è©³æƒ…**"
          fi

      - name: è©•è«– PRï¼ˆå¦‚æœæœ‰å•é¡Œï¼‰
        if: needs.auto-remediation.outputs.issues-found > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ğŸ¤– Autonomous CI Guardian Report\n\n';

            if (fs.existsSync('risk-report.md')) {
              comment += fs.readFileSync('risk-report.md', 'utf8') + '\n\n';
            }

            if (fs.existsSync('remediation-report.md')) {
              comment += fs.readFileSync('remediation-report.md', 'utf8') + '\n\n';
            }

            comment += '---\n';
            comment += '*æ­¤å ±å‘Šç”± Autonomous CI Guardian è‡ªå‹•ç”Ÿæˆ*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
