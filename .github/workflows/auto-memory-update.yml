name: Auto Memory Update

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  update-memory:
    name: Update Project Memory
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml gitpython
      
      - name: ğŸ” Analyze Changes
        id: analyze
        run: |
          python << 'EOF'
          import os
          import json
          import subprocess
          from datetime import datetime
          
          def get_git_diff():
              """ç²å–æœ€è¿‘çš„è®Šæ›´"""
              try:
                  # ç²å–æœ€è¿‘å…©æ¬¡ commit çš„å·®ç•°
                  result = subprocess.run(
                      ['git', 'diff', 'HEAD~1', 'HEAD', '--name-status'],
                      capture_output=True,
                      text=True
                  )
                  return result.stdout
              except Exception as e:
                  print(f"Error getting git diff: {e}")
                  return ""
          
          def analyze_changes(diff_output):
              """åˆ†æè®Šæ›´å…§å®¹"""
              changes = {
                  'added': [],
                  'modified': [],
                  'deleted': [],
                  'root_files': [],
                  'spec_files': [],
                  'registry_files': [],
                  'workflow_files': [],
                  'doc_files': [],
                  'memory_files': []
              }
              
              for line in diff_output.split('\n'):
                  if not line.strip():
                      continue
                  
                  parts = line.split('\t')
                  if len(parts) < 2:
                      continue
                  
                  status = parts[0]
                  filepath = parts[1]
                  
                  # åˆ†é¡è®Šæ›´
                  if status.startswith('A'):
                      changes['added'].append(filepath)
                  elif status.startswith('M'):
                      changes['modified'].append(filepath)
                  elif status.startswith('D'):
                      changes['deleted'].append(filepath)
                  
                  # åˆ†é¡æª”æ¡ˆé¡å‹
                  if filepath.startswith('root.') and not filepath.startswith('root.specs.') and not filepath.startswith('root.registry.'):
                      changes['root_files'].append(filepath)
                  elif filepath.startswith('root.specs.'):
                      changes['spec_files'].append(filepath)
                  elif filepath.startswith('root.registry.'):
                      changes['registry_files'].append(filepath)
                  elif filepath.startswith('.github/workflows/'):
                      changes['workflow_files'].append(filepath)
                  elif filepath.endswith('.md') and filepath.upper() in ['README.MD', 'ARCHITECTURE.MD', 'PROJECT_MEMORY.MD', 'CONVERSATION_LOG.MD']:
                      changes['doc_files'].append(filepath)
                  elif filepath in ['PROJECT_MEMORY.md', 'CONVERSATION_LOG.md', 'ARCHITECTURE.md', 'ACCEPTANCE_CHECKLIST.md']:
                      changes['memory_files'].append(filepath)
              
              return changes
          
          def get_commit_info():
              """ç²å– commit è³‡è¨Š"""
              try:
                  message = subprocess.run(
                      ['git', 'log', '-1', '--pretty=%B'],
                      capture_output=True,
                      text=True
                  ).stdout.strip()
                  
                  author = subprocess.run(
                      ['git', 'log', '-1', '--pretty=%an'],
                      capture_output=True,
                      text=True
                  ).stdout.strip()
                  
                  sha = subprocess.run(
                      ['git', 'log', '-1', '--pretty=%H'],
                      capture_output=True,
                      text=True
                  ).stdout.strip()
                  
                  return {
                      'message': message,
                      'author': author,
                      'sha': sha[:8],
                      'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                  }
              except Exception as e:
                  print(f"Error getting commit info: {e}")
                  return {}
          
          # ä¸»é‚è¼¯
          diff = get_git_diff()
          changes = analyze_changes(diff)
          commit_info = get_commit_info()
          
          # è¼¸å‡ºçµæœ
          output = {
              'changes': changes,
              'commit': commit_info,
              'has_changes': len(changes['added']) + len(changes['modified']) + len(changes['deleted']) > 0
          }
          
          print(json.dumps(output, indent=2))
          
          # è¨­å®š GitHub Actions è¼¸å‡º
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"has_changes={str(output['has_changes']).lower()}\n")
              f.write(f"added_count={len(changes['added'])}\n")
              f.write(f"modified_count={len(changes['modified'])}\n")
              f.write(f"deleted_count={len(changes['deleted'])}\n")
              f.write(f"commit_sha={commit_info.get('sha', 'unknown')}\n")
          
          # ä¿å­˜è©³ç´°è³‡è¨Šåˆ°æª”æ¡ˆ
          with open('changes_analysis.json', 'w') as f:
              json.dump(output, f, indent=2)
          
          EOF
      
      - name: ğŸ“ Update PROJECT_MEMORY.md
        if: steps.analyze.outputs.has_changes == 'true'
        run: |
          python << 'EOF'
          import json
          import re
          from datetime import datetime
          
          # è®€å–è®Šæ›´åˆ†æ
          with open('changes_analysis.json', 'r') as f:
              analysis = json.load(f)
          
          changes = analysis['changes']
          commit = analysis['commit']
          
          # è®€å–ç¾æœ‰çš„ PROJECT_MEMORY.md
          try:
              with open('PROJECT_MEMORY.md', 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print("PROJECT_MEMORY.md not found, skipping update")
              exit(0)
          
          # ç”Ÿæˆæ›´æ–°æ‘˜è¦
          summary = f"""
### è‡ªå‹•æ›´æ–° - {commit['timestamp']}

**Commit**: {commit['sha']}  
**Author**: {commit['author']}  
**Message**: {commit['message']}

**è®Šæ›´çµ±è¨ˆ**:
- æ–°å¢æª”æ¡ˆ: {len(changes['added'])}
- ä¿®æ”¹æª”æ¡ˆ: {len(changes['modified'])}
- åˆªé™¤æª”æ¡ˆ: {len(changes['deleted'])}

**æª”æ¡ˆé¡å‹åˆ†å¸ƒ**:
- Root é…ç½®: {len(changes['root_files'])}
- è¦ç¯„æª”æ¡ˆ: {len(changes['spec_files'])}
- è¨»å†Šè¡¨: {len(changes['registry_files'])}
- å·¥ä½œæµ: {len(changes['workflow_files'])}
- æ–‡æª”: {len(changes['doc_files'])}
"""
          
          # æ›´æ–°ã€Œè‡ªå‹•æ›´æ–°è¨˜éŒ„ã€å€å¡Š
          update_section_pattern = r'(## ğŸ”„ è‡ªå‹•æ›´æ–°è¨˜éŒ„.*?### æœ€è¿‘æ›´æ–°\n)(.*?)(\n### çµ±è¨ˆè³‡è¨Š)'
          
          def update_recent_updates(match):
              header = match.group(1)
              old_updates = match.group(2)
              footer = match.group(3)
              
              # ä¿ç•™æœ€è¿‘ 10 æ¢è¨˜éŒ„
              updates = old_updates.strip().split('\n')
              updates = [u for u in updates if u.strip().startswith('-')][:9]
              
              # æ·»åŠ æ–°è¨˜éŒ„
              new_entry = f"- **{commit['timestamp']}** - {commit['message']}"
              updates.insert(0, new_entry)
              
              return header + '\n'.join(updates) + '\n' + footer
          
          content = re.sub(update_section_pattern, update_recent_updates, content, flags=re.DOTALL)
          
          # æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
          content = re.sub(
              r'> \*\*æœ€å¾Œæ›´æ–°\*\*:.*',
              f'> **æœ€å¾Œæ›´æ–°**: {commit["timestamp"]}',
              content
          )
          
          # å¯«å›æª”æ¡ˆ
          with open('PROJECT_MEMORY.md', 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("âœ… PROJECT_MEMORY.md updated successfully")
          EOF
      
      - name: ğŸ“ Update CONVERSATION_LOG.md
        if: steps.analyze.outputs.has_changes == 'true'
        run: |
          python << 'EOF'
          import json
          import re
          from datetime import datetime
          
          # è®€å–è®Šæ›´åˆ†æ
          with open('changes_analysis.json', 'r') as f:
              analysis = json.load(f)
          
          changes = analysis['changes']
          commit = analysis['commit']
          
          # è®€å–ç¾æœ‰çš„ CONVERSATION_LOG.md
          try:
              with open('CONVERSATION_LOG.md', 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print("CONVERSATION_LOG.md not found, skipping update")
              exit(0)
          
          # ç”Ÿæˆå°è©±è¨˜éŒ„æ¢ç›®
          log_entry = f"""
---

### è‡ªå‹•è¨˜éŒ„ - {commit['timestamp']}

#### Commit è³‡è¨Š
- **SHA**: {commit['sha']}
- **Author**: {commit['author']}
- **Message**: {commit['message']}
- **Timestamp**: {commit['timestamp']}

#### è®Šæ›´æ‘˜è¦
- **æ–°å¢**: {len(changes['added'])} å€‹æª”æ¡ˆ
- **ä¿®æ”¹**: {len(changes['modified'])} å€‹æª”æ¡ˆ
- **åˆªé™¤**: {len(changes['deleted'])} å€‹æª”æ¡ˆ

#### æª”æ¡ˆæ¸…å–®
"""
          
          if changes['added']:
              log_entry += "\n**æ–°å¢æª”æ¡ˆ**:\n"
              for f in changes['added'][:10]:  # æœ€å¤šé¡¯ç¤º 10 å€‹
                  log_entry += f"- {f}\n"
          
          if changes['modified']:
              log_entry += "\n**ä¿®æ”¹æª”æ¡ˆ**:\n"
              for f in changes['modified'][:10]:
                  log_entry += f"- {f}\n"
          
          if changes['deleted']:
              log_entry += "\n**åˆªé™¤æª”æ¡ˆ**:\n"
              for f in changes['deleted'][:10]:
                  log_entry += f"- {f}\n"
          
          # åœ¨ã€Œè‡ªå‹•æ›´æ–°è¨˜éŒ„ã€å€å¡Šå‰æ’å…¥
          insert_position = content.find('## ğŸ”„ è‡ªå‹•æ›´æ–°è¨˜éŒ„')
          if insert_position > 0:
              content = content[:insert_position] + log_entry + '\n' + content[insert_position:]
          else:
              # å¦‚æœæ‰¾ä¸åˆ°å€å¡Šï¼Œæ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾
              content += '\n' + log_entry
          
          # å¯«å›æª”æ¡ˆ
          with open('CONVERSATION_LOG.md', 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("âœ… CONVERSATION_LOG.md updated successfully")
          EOF
      
      - name: ğŸ“ Update ARCHITECTURE.md
        if: steps.analyze.outputs.has_changes == 'true'
        run: |
          python << 'EOF'
          import json
          import re
          from datetime import datetime
          
          # è®€å–è®Šæ›´åˆ†æ
          with open('changes_analysis.json', 'r') as f:
              analysis = json.load(f)
          
          commit = analysis['commit']
          
          # è®€å–ç¾æœ‰çš„ ARCHITECTURE.md
          try:
              with open('ARCHITECTURE.md', 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print("ARCHITECTURE.md not found, skipping update")
              exit(0)
          
          # æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
          content = re.sub(
              r'> \*\*æœ€å¾Œæ›´æ–°\*\*:.*',
              f'> **æœ€å¾Œæ›´æ–°**: {commit["timestamp"]}',
              content
          )
          
          # æ›´æ–°ç‰ˆæœ¬æ­·å²
          version_pattern = r'(## ğŸ”„ ç‰ˆæœ¬æ­·å².*?### v1\.0\.0.*?)(\n### v1\.1\.0)'
          
          def update_version_history(match):
              v1_section = match.group(1)
              v1_1_header = match.group(2)
              
              # åœ¨ v1.0.0 å€å¡Šæ·»åŠ æ›´æ–°è¨˜éŒ„
              update_note = f"\n- ğŸ”„ è‡ªå‹•æ›´æ–° ({commit['timestamp']}): {commit['message']}"
              
              return v1_section + update_note + v1_1_header
          
          if re.search(version_pattern, content, flags=re.DOTALL):
              content = re.sub(version_pattern, update_version_history, content, flags=re.DOTALL)
          
          # å¯«å›æª”æ¡ˆ
          with open('ARCHITECTURE.md', 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("âœ… ARCHITECTURE.md updated successfully")
          EOF
      
      - name: ğŸ“Š Generate Update Summary
        if: steps.analyze.outputs.has_changes == 'true'
        run: |
          echo "## ğŸ”„ Memory Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ steps.analyze.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes" >> $GITHUB_STEP_SUMMARY
          echo "- Added: ${{ steps.analyze.outputs.added_count }} files" >> $GITHUB_STEP_SUMMARY
          echo "- Modified: ${{ steps.analyze.outputs.modified_count }} files" >> $GITHUB_STEP_SUMMARY
          echo "- Deleted: ${{ steps.analyze.outputs.deleted_count }} files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Files" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PROJECT_MEMORY.md" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CONVERSATION_LOG.md" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ARCHITECTURE.md" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ’¾ Commit Memory Updates
        if: steps.analyze.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if [[ -n $(git status --porcelain) ]]; then
            git add PROJECT_MEMORY.md CONVERSATION_LOG.md ARCHITECTURE.md
            git commit -m "chore: Auto-update project memory [skip ci]

            - Updated PROJECT_MEMORY.md with latest changes
            - Updated CONVERSATION_LOG.md with commit log
            - Updated ARCHITECTURE.md timestamp
            
            Triggered by: ${{ steps.analyze.outputs.commit_sha }}"
            
            git push
            echo "âœ… Memory files committed and pushed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
      
      - name: ğŸ“¢ Notify Completion
        if: steps.analyze.outputs.has_changes == 'true'
        run: |
          echo "ğŸ‰ Memory update completed successfully!"
          echo "ğŸ“ Updated files:"
          echo "  - PROJECT_MEMORY.md"
          echo "  - CONVERSATION_LOG.md"
          echo "  - ARCHITECTURE.md"