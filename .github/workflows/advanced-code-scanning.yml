name: ğŸ” Advanced Code Scanning - é«˜éšä»£ç¢¼æƒæç³»çµ±

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨ 2:00 UTC åŸ·è¡Œ
  workflow_dispatch:
    inputs:
      run_auto_fix:
        description: 'åŸ·è¡Œè‡ªå‹•ä¿®å¾©'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read
  security-events: write

env:
  AGENT_CONTRACT_ENFORCEMENT: true
  PYTHON_VERSION: '3.11'

jobs:
  advanced-scan:
    name: ğŸ” åŸ·è¡Œé«˜éšæ·±åº¦æƒæ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºå„²å­˜åº«
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2
      with:
        fetch-depth: 0

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ å®‰è£æƒæå·¥å…·
      run: |
        python -m pip install --upgrade pip
        if [ -f ".github/code-scanning/requirements.txt" ]; then
          pip install -r .github/code-scanning/requirements.txt
        else
          pip install bandit
        fi

    - name: ğŸ” åŸ·è¡Œé«˜éšæ·±åº¦æƒæ
      id: scan
      run: |
        echo "ğŸ” é–‹å§‹é«˜éšæ·±åº¦æƒæ..."
        python .github/code-scanning/tools/advanced_scanner.py \
          --repo ${{ github.workspace }} \
          --output-dir ${{ github.workspace }}/.github/code-scanning/reports
        
        # ç²å–æœ€æ–°æƒæçµæœ
        SCAN_REPORT=$(ls -t ${{ github.workspace }}/.github/code-scanning/reports/scan-results-*.json | head -n 1)
        
        if [ -f "$SCAN_REPORT" ]; then
          echo "ğŸ“Š æƒæå®Œæˆï¼Œåˆ†æçµæœ..."
          
          # æå–æŒ‡æ¨™
          TOTAL=$(jq -r '.summary.total_findings' "$SCAN_REPORT")
          CRITICAL=$(jq -r '.summary.critical' "$SCAN_REPORT")
          HIGH=$(jq -r '.summary.high' "$SCAN_REPORT")
          MEDIUM=$(jq -r '.summary.medium' "$SCAN_REPORT")
          LOW=$(jq -r '.summary.low' "$SCAN_REPORT")
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "scan_report=$SCAN_REPORT" >> $GITHUB_OUTPUT
          
          # åˆ¤æ–·æ˜¯å¦å¤±æ•—
          if [[ "$CRITICAL" -gt 0 ]] || [[ "$HIGH" -gt 0 ]]; then
            echo "status=FAIL" >> $GITHUB_OUTPUT
          else
            echo "status=PASS" >> $GITHUB_OUTPUT
          fi
        fi

    - name: ğŸ¯ åŸ·è¡Œæ ¹å› åˆ†æ
      id: root_cause
      if: steps.scan.outputs.scan_report != ''
      run: |
        echo "ğŸ¯ é–‹å§‹æ ¹å› åˆ†æ..."
        python .github/code-scanning/tools/root_cause_analyzer.py \
          "${{ steps.scan.outputs.scan_report }}" \
          "root-cause-analysis.json"
        
        echo "âœ… æ ¹å› åˆ†æå®Œæˆ"

    - name: ğŸ”§ åŸ·è¡Œè‡ªå‹•ä¿®å¾©
      id: auto_fix
      if: |
        steps.scan.outputs.scan_report != '' &&
        (github.event.inputs.run_auto_fix == 'true' || github.event_name == 'push')
      run: |
        echo "ğŸ”§ é–‹å§‹è‡ªå‹•ä¿®å¾©..."
        python .github/code-scanning/tools/auto_fixer.py \
          "${{ steps.scan.outputs.scan_report }}"
        
        echo "âœ… è‡ªå‹•ä¿®å¾©å®Œæˆ"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ä¿®å¾©
        FIX_REPORT=$(ls -t ${{ github.workspace }}/.github/code-scanning/reports/fix-report-*.json | head -n 1)
        if [ -f "$FIX_REPORT" ]; then
          FIXED=$(jq -r '.summary.fixed' "$FIX_REPORT")
          MANUAL=$(jq -r '.summary.manual_review_required' "$FIX_REPORT")
          
          echo "fixed=$FIXED" >> $GITHUB_OUTPUT
          echo "manual_review=$MANUAL" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“¤ ä¸Šå‚³æƒæå ±å‘Š
      if: always()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: advanced-scan-reports
        path: |
          .github/code-scanning/reports/*.json
          root-cause-analysis.json
        if-no-files-found: warn
        retention-days: 30

    - name: ğŸ“Š ç”Ÿæˆæƒææ‘˜è¦
      if: always()
      run: |
        echo "## ğŸ” é«˜éšä»£ç¢¼æƒæå ±å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ æƒæçµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| æŒ‡æ¨™ | æ•¸å€¼ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”´ é—œéµ | ${{ steps.scan.outputs.critical || 0 }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŸ  é«˜ | ${{ steps.scan.outputs.high || 0 }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŸ¡ ä¸­ | ${{ steps.scan.outputs.medium || 0 }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŸ¢ ä½ | ${{ steps.scan.outputs.low || 0 }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“Š ç¸½è¨ˆ | ${{ steps.scan.outputs.total || 0 }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.scan.outputs.status }}" = "FAIL" ]; then
          echo "### âŒ æƒæç‹€æ…‹: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ ç™¼ç¾é—œéµæˆ–é«˜åš´é‡æ€§å•é¡Œï¼Œè«‹æŸ¥çœ‹è©³ç´°å ±å‘Šä¸¦ä¿®å¾©ã€‚" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "### âœ… æƒæç‹€æ…‹: é€šé" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ æ‰€æœ‰é—œéµå’Œé«˜å„ªå…ˆç´šå•é¡Œå·²é€šéæª¢æŸ¥ï¼" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ“‹ æŸ¥çœ‹æ ¹å› åˆ†æ
      if: always() && hashFiles('root-cause-analysis.json') != ''
      run: |
        echo "### ğŸ¯ æ ¹å› åˆ†ææ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        RISK_LEVEL=$(jq -r '.risk_assessment.risk_level' root-cause-analysis.json)
        RISK_SCORE=$(jq -r '.risk_assessment.total_risk_score' root-cause-analysis.json)
        ROOT_CAUSES=$(jq -r '.root_causes | length' root-cause-analysis.json)
        
        echo "| æŒ‡æ¨™ | æ•¸å€¼ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| é¢¨éšªè©•åˆ† | $RISK_SCORE |" >> $GITHUB_STEP_SUMMARY
        echo "| é¢¨éšªç­‰ç´š | **$RISK_LEVEL** |" >> $GITHUB_STEP_SUMMARY
        echo "| è­˜åˆ¥æ ¹å›  | $ROOT_CAUSES |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ”§ æŸ¥çœ‹ä¿®å¾©å ±å‘Š
      if: always() && steps.auto_fix.outputs.fixed != ''
      run: |
        echo "### ğŸ”§ è‡ªå‹•ä¿®å¾©æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| æŒ‡æ¨™ | æ•¸å€¼ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| âœ… å·²ä¿®å¾© | ${{ steps.auto_fix.outputs.fixed }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ‘ï¸ éœ€è¦å¯©æŸ¥ | ${{ steps.auto_fix.outputs.manual_review || 0 }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

  security-scan-legacy:
    name: ğŸ›¡ï¸ Legacy Security Scan (Bandit)
    runs-on: ubuntu-latest
    needs: advanced-scan
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºå„²å­˜åº«
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ å®‰è£ Bandit
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml]

    - name: ğŸ åŸ·è¡Œ Bandit æƒæ
      run: |
        TARGETS=""
        for dir in controlplane workspace; do
          if [ -d "$dir" ]; then
            TARGETS="$TARGETS $dir"
          fi
        done
        
        if [ -z "$TARGETS" ]; then
          echo "æ²’æœ‰æ‰¾åˆ°ç›®éŒ„ï¼Œè·³é Bandit æƒæ"
          exit 0
        fi
        
        python_files=$(find $TARGETS -name "*.py" -type f | wc -l)
        if [ "$python_files" -eq 0 ]; then
          echo "æ²’æœ‰æ‰¾åˆ° Python æ–‡ä»¶ï¼Œè·³é Bandit æƒæ"
          exit 0
        fi
        
        bandit -q -r $TARGETS || true