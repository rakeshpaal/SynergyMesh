name: ğŸš€ CD Pipeline
true:
  push:
    branches:
    - main
  workflow_dispatch:
    inputs:
      environment:
        default: staging
        description: Target environment
        options:
        - staging
        - production
        required: true
        type: choice
      force_deploy:
        default: false
        description: Force deployment (skip checks)
        required: false
        type: boolean
concurrency:
  cancel-in-progress: false
  group: ${{ github.workflow }}-${{ github.ref }}
permissions:
  contents: read
  deployments: write
  issues: write
  packages: write
  pull-requests: write
env:
  DOCKER_REGISTRY: ghcr.io
  HELM_CHART_PATH: helm/machinenativeops
  IMAGE_NAME: machinenativeops
  KUBERNETES_NAMESPACE: machinenativeops
jobs:
  # =============================================================================
  # éƒ¨ç½²å‰æª¢æŸ¥
  # =============================================================================
  pre-deploy-checks:
    name: "ğŸ” Pre-Deployment Checks"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      deploy-approved: ${{ steps.check.outputs.approved }}
      risk-level: ${{ steps.check.outputs.risk-level }}
    
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599
        with:
          fetch-depth: 0

      - name: "è¨­ç½® Python ç’°å¢ƒ"
        uses: 82c7e631bb3cdc910f68e0081d534527d238d7a7
        with:
          python-version: "3.11"

      - name: "å®‰è£æª¢æŸ¥å·¥å…·"
        run: |
          pip install --user requests pyyaml

      - name: "éƒ¨ç½²é¢¨éšªè©•ä¼°"
        id: check
        run: |
          echo "ğŸ” åŸ·è¡Œéƒ¨ç½²å‰æª¢æŸ¥..."
          
          # æª¢æŸ¥æ˜¯å¦ç‚ºå¼·åˆ¶éƒ¨ç½²
          if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "risk-level=forced" >> $GITHUB_OUTPUT
            echo "âš ï¸ å¼·åˆ¶éƒ¨ç½²æ¨¡å¼ï¼Œè·³éå®‰å…¨æª¢æŸ¥"
            exit 0
          fi
          
          # æª¢æŸ¥æœ€è¿‘çš„CIç‹€æ…‹
          CI_STATUS=$(gh run list --workflow="CI Pipeline" --branch=${{ github.ref_name }} --limit=1 --json conclusion --jq '.[0].conclusion' || echo "unknown")
          
          if [ "$CI_STATUS" != "success" ]; then
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "risk-level=high" >> $GITHUB_OUTPUT
            echo "âŒ CIæª¢æŸ¥æœªé€šéï¼Œæ‹’çµ•éƒ¨ç½²"
            exit 1
          fi
          
          # æª¢æŸ¥è®Šæ›´ç¯„åœ
          COMMITS_SINCE_MAIN=$(git rev-list --count origin/main..HEAD)
          if [ "$COMMITS_SINCE_MAIN" -gt 10 ]; then
            echo "risk-level=medium" >> $GITHUB_OUTPUT
          else
            echo "risk-level=low" >> $GITHUB_OUTPUT
          fi
          
          # æª¢æŸ¥æ˜¯å¦æœ‰éƒ¨ç½²é˜»å¡æ–‡ä»¶
          if [ -f "DEPLOY_BLOCK" ]; then
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "risk-level=blocked" >> $GITHUB_OUTPUT
            echo "âŒ ç™¼ç¾éƒ¨ç½²é˜»å¡æ–‡ä»¶ï¼Œæ‹’çµ•éƒ¨ç½²"
            exit 1
          fi
          
          echo "approved=true" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²å‰æª¢æŸ¥é€šé"

      - name: "ç”Ÿæˆæª¢æŸ¥å ±å‘Š"
        run: |
          echo "# ğŸ” Pre-Deployment Check Report" > pre-deploy-report.md
          echo "" >> pre-deploy-report.md
          echo "**æª¢æŸ¥æ™‚é–“**: $(date)" >> pre-deploy-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> pre-deploy-report.md
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> pre-deploy-report.md
          echo "**é¢¨éšªç­‰ç´š**: ${{ steps.check.outputs.risk-level }}" >> pre-deploy-report.md
          echo "" >> pre-deploy-report.md
          
          if [ "${{ steps.check.outputs.approved }}" = "true" ]; then
            echo "## âœ… æª¢æŸ¥çµæœ: é€šé" >> pre-deploy-report.md
            echo "ğŸ‰ éƒ¨ç½²å·²ç²æ‰¹å‡†" >> pre-deploy-report.md
          else
            echo "## âŒ æª¢æŸ¥çµæœ: æ‹’çµ•" >> pre-deploy-report.md
            echo "âš ï¸ éƒ¨ç½²å·²è¢«æ‹’çµ•" >> pre-deploy-report.md
          fi
          
          cat pre-deploy-report.md

      - name: "ä¸Šå‚³æª¢æŸ¥å ±å‘Š"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: pre-deploy-check-report
          path: pre-deploy-report.md
          retention-days: 7

  # =============================================================================
  # Docker æ§‹å»ºèˆ‡æ¨é€
  # =============================================================================
  build-and-push:
    if: needs.pre-deploy-checks.outputs.deploy-approved == 'true'
    name: ğŸ³ Build & Push Docker Image
    needs: pre-deploy-checks
    outputs:
      image-digest: ${{ steps.push.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: "è¨­ç½® Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ç™»éŒ„å®¹å™¨è¨»å†Šè¡¨"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "æå–å…ƒæ•¸æ“š"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: "æ§‹å»ºä¸¦æ¨é€ Docker é¡åƒ"
        id: push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.meta.outputs.version }}

      - name: "ç”Ÿæˆé¡åƒä¿¡æ¯"
        run: |
          echo "# ğŸ³ Docker Image Information" > docker-info.md
          echo "" >> docker-info.md
          echo "**æ§‹å»ºæ™‚é–“**: $(date)" >> docker-info.md
          echo "**æäº¤**: ${{ github.sha }}" >> docker-info.md
          echo "**é¡åƒæ¨™ç±¤**: ${{ steps.meta.outputs.tags }}" >> docker-info.md
          echo "**é¡åƒæ‘˜è¦**: ${{ steps.push.outputs.digest }}" >> docker-info.md
          echo "**å¹³å°**: linux/amd64, linux/arm64" >> docker-info.md
          echo "" >> docker-info.md
          echo "## ğŸ“¦ é¡åƒä¿¡æ¯" >> docker-info.md
          echo "- Registry: ${{ env.DOCKER_REGISTRY }}" >> docker-info.md
          echo "- Repository: ${{ github.repository }}/${{ env.IMAGE_NAME }}" >> docker-info.md
          echo "- Tags: ${{ steps.meta.outputs.tags }}" >> docker-info.md
          
          cat docker-info.md

      - name: "ä¸Šå‚³é¡åƒä¿¡æ¯"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: docker-image-info
          path: docker-info.md
          retention-days: 7

  # =============================================================================
  # å®‰å…¨æƒæ
  # =============================================================================
  security-scan:
    name: "ğŸ”’ Security Scan"
    runs-on: ubuntu-latest
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: "é‹è¡Œ Trivy æ¼æ´æƒæ"
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-and-push.outputs.image-tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: "ä¸Šå‚³ Trivy æƒæçµæœåˆ° GitHub Security"
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: "ç”Ÿæˆå®‰å…¨æƒæå ±å‘Š"
        run: |
          echo "# ğŸ”’ Container Security Scan Report" > container-security-report.md
          echo "" >> container-security-report.md
          echo "**æƒææ™‚é–“**: $(date)" >> container-security-report.md
          echo "**é¡åƒ**: ${{ needs.build-and-push.outputs.image-tag }}" >> container-security-report.md
          echo "" >> container-security-report.md
          
          if [ -f "trivy-results.sarif" ]; then
            echo "## âœ… å®‰å…¨æƒæå®Œæˆ" >> container-security-report.md
            echo "ğŸ“‹ æƒæçµæœå·²ä¸Šå‚³åˆ° GitHub Security" >> container-security-report.md
          else
            echo "## âŒ å®‰å…¨æƒæå¤±æ•—" >> container-security-report.md
            echo "âš ï¸ ç„¡æ³•ç”Ÿæˆæƒæçµæœ" >> container-security-report.md
          fi
          
          cat container-security-report.md

      - name: "ä¸Šå‚³å®‰å…¨æƒæå ±å‘Š"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: container-security-report
          path: container-security-report.md
          retention-days: 7

  # =============================================================================
  # æ€§èƒ½åŸºæº–æ¸¬è©¦
  # =============================================================================
  performance-tests:
    name: "âš¡ Performance Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-and-push
    if: needs.build-and-push.result == 'success'
    
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: "è¨­ç½® Node.js ç’°å¢ƒ"
        uses: 1e60f620b9541d16bece96c5465dc8ee9832be0b
        with:
          node-version: "20"

      - name: "å®‰è£æ€§èƒ½æ¸¬è©¦å·¥å…·"
        run: |
          npm install -g k6 artillery

      - name: "éƒ¨ç½²æ¸¬è©¦ç’°å¢ƒ"
        run: |
          echo "ğŸš€ éƒ¨ç½²æ¸¬è©¦ç’°å¢ƒ..."
          # ä½¿ç”¨æ§‹å»ºçš„é¡åƒéƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
          docker-compose -f docker-compose.test.yml up -d
          sleep 30  # ç­‰å¾…æœå‹™å•Ÿå‹•

      - name: "åŸ·è¡Œæ€§èƒ½æ¸¬è©¦"
        run: |
          echo "âš¡ åŸ·è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦..."
          
          # K6 è² è¼‰æ¸¬è©¦
          if [ -f "tests/performance/load-test.js" ]; then
            k6 run --out json=load-test-results.json tests/performance/load-test.js || echo "âš ï¸ K6 æ¸¬è©¦å®Œæˆ"
          fi
          
          # Artillery HTTP æ¸¬è©¦
          if [ -f "tests/performance/artillery-config.yml" ]; then
            artillery run tests/performance/artillery-config.yml --output artillery-results.json || echo "âš ï¸ Artillery æ¸¬è©¦å®Œæˆ"
          fi

      - name: "ç”Ÿæˆæ€§èƒ½æ¸¬è©¦å ±å‘Š"
        run: |
          echo "# âš¡ Performance Test Report" > performance-test-report.md
          echo "" >> performance-test-report.md
          echo "**æ¸¬è©¦æ™‚é–“**: $(date)" >> performance-test-report.md
          echo "**é¡åƒ**: ${{ needs.build-and-push.outputs.image-tag }}" >> performance-test-report.md
          echo "" >> performance-test-report.md
          
          echo "## ğŸ“Š æ€§èƒ½æ¸¬è©¦çµæœ" >> performance-test-report.md
          echo "âœ… æ€§èƒ½åŸºæº–æ¸¬è©¦å·²å®Œæˆ" >> performance-test-report.md
          echo "" >> performance-test-report.md
          
          echo "### ğŸ“‹ æ¸¬è©¦é …ç›®" >> performance-test-report.md
          echo "- è² è¼‰æ¸¬è©¦ (K6)" >> performance-test-report.md
          echo "- HTTP å£“åŠ›æ¸¬è©¦ (Artillery)" >> performance-test-report.md
          
          cat performance-test-report.md

      - name: "æ¸…ç†æ¸¬è©¦ç’°å¢ƒ"
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down -v

      - name: "ä¸Šå‚³æ€§èƒ½æ¸¬è©¦å ±å‘Š"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: performance-test-report
          path: |
            performance-test-report.md
            load-test-results.json
            artillery-results.json
          retention-days: 7

  # =============================================================================
  # éƒ¨ç½²åˆ°ç’°å¢ƒ
  # =============================================================================
    - name: æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: è¨­ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: ç™»éŒ„å®¹å™¨è¨»å†Šè¡¨
      uses: docker/login-action@v3
      with:
        password: ${{ secrets.GITHUB_TOKEN }}
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ github.actor }}
    - id: meta
      name: æå–å…ƒæ•¸æ“š
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME
          }}
        tags: 'type=ref,event=branch

          type=ref,event=pr

          type=sha,prefix={{branch}}-

          type=raw,value=latest,enable={{is_default_branch}}

          type=semver,pattern={{version}}

          type=semver,pattern={{major}}.{{minor}}

          '
    - id: push
      name: æ§‹å»ºä¸¦æ¨é€ Docker é¡åƒ
      uses: docker/build-push-action@v5
      with:
        build-args: 'BUILD_DATE=$(date -u +''%Y-%m-%dT%H:%M:%SZ'')

          VCS_REF=${{ github.sha }}

          VERSION=${{ steps.meta.outputs.version }}

          '
        cache-from: type=gha
        cache-to: type=gha,mode=max
        context: .
        file: ./Dockerfile
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
    - name: ç”Ÿæˆé¡åƒä¿¡æ¯
      run: 'echo "# ğŸ³ Docker Image Information" > docker-info.md

        echo "" >> docker-info.md

        echo "**æ§‹å»ºæ™‚é–“**: $(date)" >> docker-info.md

        echo "**æäº¤**: ${{ github.sha }}" >> docker-info.md

        echo "**é¡åƒæ¨™ç±¤**: ${{ steps.meta.outputs.tags }}" >> docker-info.md

        echo "**é¡åƒæ‘˜è¦**: ${{ steps.push.outputs.digest }}" >> docker-info.md

        echo "**å¹³å°**: linux/amd64, linux/arm64" >> docker-info.md

        echo "" >> docker-info.md

        echo "## ğŸ“¦ é¡åƒä¿¡æ¯" >> docker-info.md

        echo "- Registry: ${{ env.DOCKER_REGISTRY }}" >> docker-info.md

        echo "- Repository: ${{ github.repository }}/${{ env.IMAGE_NAME }}" >> docker-info.md

        echo "- Tags: ${{ steps.meta.outputs.tags }}" >> docker-info.md


        cat docker-info.md

        '
    - name: ä¸Šå‚³é¡åƒä¿¡æ¯
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: docker-image-info
        path: docker-info.md
        retention-days: 7
    timeout-minutes: 30
  deploy:
    environment:
      name: ${{ matrix.environment }}
      url: ${{ matrix.environment == 'production' && 'https://prod.machinenativeops.com'
        || 'https://staging.machinenativeops.com' }}
    if: "always() && \nneeds.pre-deploy-checks.outputs.deploy-approved == 'true' &&\n\
      needs.build-and-push.result == 'success' &&\nneeds.security-scan.result == 'success'\n"
    name: ğŸš€ Deploy to Environment
    needs:
    - pre-deploy-checks
    - build-and-push
    - security-scan
    - performance-tests
    runs-on: ubuntu-latest
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: è¨­ç½® Kubernetes
      uses: azure/setup-kubectl@v3
      with:
        version: v1.28.0
    - name: è¨­ç½® Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.13.0
    - name: é…ç½® Kubeconfig
      run: "echo \"\U0001F527 é…ç½® Kubernetes...\"\nmkdir -p $HOME/.kube\n\nif [ \"\
        ${{ matrix.environment }}\" = \"production\" ]; then\n  echo \"${{ secrets.KUBECONFIG_PROD\
        \ }}\" | base64 -d > $HOME/.kube/config\nelse\n  echo \"${{ secrets.KUBECONFIG_STAGING\
        \ }}\" | base64 -d > $HOME/.kube/config\nfi\n\nkubectl cluster-info\n"
    - name: éƒ¨ç½²æ‡‰ç”¨
      run: "echo \"\U0001F680 éƒ¨ç½²åˆ° ${{ matrix.environment }} ç’°å¢ƒ...\"\n\n# æ›´æ–° Helm values\n\
        if [ -d \"$HELM_CHART_PATH\" ]; then\n  helm upgrade --install machinenativeops\
        \ $HELM_CHART_PATH \\\n    --namespace ${{ env.KUBERNETES_NAMESPACE }} \\\n\
        \    --create-namespace \\\n    --set image.tag=${{ needs.build-and-push.outputs.image-tag\
        \ }} \\\n    --set environment=${{ matrix.environment }} \\\n    --wait \\\
        \n    --timeout=10m\nelse\n  echo \"âš ï¸ Helm chart æœªæ‰¾åˆ°ï¼Œä½¿ç”¨ kubectl éƒ¨ç½²\"\n  #\
        \ å‚™ç”¨çš„ kubectl éƒ¨ç½²é‚è¼¯\n  kubectl apply -f k8s/ -n ${{ env.KUBERNETES_NAMESPACE\
        \ }}\nfi\n"
    - name: é©—è­‰éƒ¨ç½²
      run: 'echo "âœ… é©—è­‰éƒ¨ç½²ç‹€æ…‹..."


        # æª¢æŸ¥ Pod ç‹€æ…‹

        kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }}


        # æª¢æŸ¥æœå‹™ç‹€æ…‹

        kubectl get services -n ${{ env.KUBERNETES_NAMESPACE }}


        # ç­‰å¾…éƒ¨ç½²å®Œæˆ

        kubectl rollout status deployment/machinenativeops -n ${{ env.KUBERNETES_NAMESPACE
        }} --timeout=5m

        '
    - name: å¥åº·æª¢æŸ¥
      run: "echo \"\U0001F3E5 åŸ·è¡Œå¥åº·æª¢æŸ¥...\"\n\n# ç²å–æ‡‰ç”¨ URL\nAPP_URL=$(kubectl get ingress\
        \ machinenativeops -n ${{ env.KUBERNETES_NAMESPACE }} -o jsonpath='{.spec.rules[0].host}')\n\
        \n# åŸ·è¡Œå¥åº·æª¢æŸ¥\nfor i in {1..10}; do\n  if curl -f \"https://$APP_URL/health\"\
        \ > /dev/null 2>&1; then\n    echo \"âœ… å¥åº·æª¢æŸ¥é€šé\"\n    break\n  else\n    echo\
        \ \"â³ ç­‰å¾…æ‡‰ç”¨å•Ÿå‹•... ($i/10)\"\n    sleep 30\n  fi\ndone\n"
    - name: ç”Ÿæˆéƒ¨ç½²å ±å‘Š
      run: 'echo "# ğŸš€ Deployment Report" > deployment-report.md

        echo "" >> deployment-report.md

        echo "**éƒ¨ç½²æ™‚é–“**: $(date)" >> deployment-report.md

        echo "**ç’°å¢ƒ**: ${{ matrix.environment }}" >> deployment-report.md

        echo "**æäº¤**: ${{ github.sha }}" >> deployment-report.md

        echo "**é¡åƒ**: ${{ needs.build-and-push.outputs.image-tag }}" >> deployment-report.md

        echo "" >> deployment-report.md


        echo "## âœ… éƒ¨ç½²ç‹€æ…‹" >> deployment-report.md

        echo "ğŸ‰ æ‡‰ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ° ${{ matrix.environment }} ç’°å¢ƒ" >> deployment-report.md

        echo "" >> deployment-report.md


        echo "## ğŸ“Š éƒ¨ç½²ä¿¡æ¯" >> deployment-report.md

        echo "- Kubernetes Namespace: ${{ env.KUBERNETES_NAMESPACE }}" >> deployment-report.md

        echo "- Docker Image: ${{ needs.build-and-push.outputs.image-tag }}" >> deployment-report.md

        echo "- Deployment Strategy: Rolling Update" >> deployment-report.md


        cat deployment-report.md

        '
    - name: ä¸Šå‚³éƒ¨ç½²å ±å‘Š
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: deployment-report-${{ matrix.environment }}
        path: deployment-report.md
        retention-days: 30
    strategy:
      matrix:
        environment:
        - ${{ github.event.inputs.environment || 'staging' }}
    timeout-minutes: 45
  performance-tests:
    if: needs.build-and-push.result == 'success'
    name: âš¡ Performance Tests
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: "è¨­ç½® Kubernetes"
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: "è¨­ç½® Helm"
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: "é…ç½® Kubeconfig"
        run: |
          echo "ğŸ”§ é…ç½® Kubernetes..."
          mkdir -p $HOME/.kube
          
          if [ "${{ matrix.environment }}" = "production" ]; then
            echo "${{ secrets.KUBECONFIG_PROD }}" | base64 -d > $HOME/.kube/config
          else
            echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
          fi
          
          kubectl cluster-info

      - name: "éƒ¨ç½²æ‡‰ç”¨"
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ° ${{ matrix.environment }} ç’°å¢ƒ..."
          
          # æ›´æ–° Helm values
          if [ -d "$HELM_CHART_PATH" ]; then
            helm upgrade --install machinenativeops $HELM_CHART_PATH \
              --namespace ${{ env.KUBERNETES_NAMESPACE }} \
              --create-namespace \
              --set image.tag=${{ needs.build-and-push.outputs.image-tag }} \
              --set environment=${{ matrix.environment }} \
              --wait \
              --timeout=10m
          else
            echo "âš ï¸ Helm chart æœªæ‰¾åˆ°ï¼Œä½¿ç”¨ kubectl éƒ¨ç½²"
            # å‚™ç”¨çš„ kubectl éƒ¨ç½²é‚è¼¯
            kubectl apply -f k8s/ -n ${{ env.KUBERNETES_NAMESPACE }}
          fi

      - name: "é©—è­‰éƒ¨ç½²"
        run: |
          echo "âœ… é©—è­‰éƒ¨ç½²ç‹€æ…‹..."
          
          # æª¢æŸ¥ Pod ç‹€æ…‹
          kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }}
          
          # æª¢æŸ¥æœå‹™ç‹€æ…‹
          kubectl get services -n ${{ env.KUBERNETES_NAMESPACE }}
          
          # ç­‰å¾…éƒ¨ç½²å®Œæˆ
          kubectl rollout status deployment/machinenativeops -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m

      - name: "å¥åº·æª¢æŸ¥"
        run: |
          echo "ğŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥..."
          
          # ç²å–æ‡‰ç”¨ URL
          APP_URL=$(kubectl get ingress machinenativeops -n ${{ env.KUBERNETES_NAMESPACE }} -o jsonpath='{.spec.rules[0].host}')
          
          # åŸ·è¡Œå¥åº·æª¢æŸ¥
          for i in {1..10}; do
            if curl -f "https://$APP_URL/health" > /dev/null 2>&1; then
              echo "âœ… å¥åº·æª¢æŸ¥é€šé"
              break
            else
              echo "â³ ç­‰å¾…æ‡‰ç”¨å•Ÿå‹•... ($i/10)"
              sleep 30
            fi
          done

      - name: "ç”Ÿæˆéƒ¨ç½²å ±å‘Š"
        run: |
          echo "# ğŸš€ Deployment Report" > deployment-report.md
          echo "" >> deployment-report.md
          echo "**éƒ¨ç½²æ™‚é–“**: $(date)" >> deployment-report.md
          echo "**ç’°å¢ƒ**: ${{ matrix.environment }}" >> deployment-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> deployment-report.md
          echo "**é¡åƒ**: ${{ needs.build-and-push.outputs.image-tag }}" >> deployment-report.md
          echo "" >> deployment-report.md
          
          echo "## âœ… éƒ¨ç½²ç‹€æ…‹" >> deployment-report.md
          echo "ğŸ‰ æ‡‰ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ° ${{ matrix.environment }} ç’°å¢ƒ" >> deployment-report.md
          echo "" >> deployment-report.md
          
          echo "## ğŸ“Š éƒ¨ç½²ä¿¡æ¯" >> deployment-report.md
          echo "- Kubernetes Namespace: ${{ env.KUBERNETES_NAMESPACE }}" >> deployment-report.md
          echo "- Docker Image: ${{ needs.build-and-push.outputs.image-tag }}" >> deployment-report.md
          echo "- Deployment Strategy: Rolling Update" >> deployment-report.md
          
          cat deployment-report.md

      - name: "ä¸Šå‚³éƒ¨ç½²å ±å‘Š"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: deployment-report-${{ matrix.environment }}
          path: deployment-report.md
          retention-days: 30

  # =============================================================================
  # éƒ¨ç½²å¾Œé€šçŸ¥
  # =============================================================================
    - name: æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: è¨­ç½® Node.js ç’°å¢ƒ
      uses: 1e60f620b9541d16bece96c5465dc8ee9832be0b
      with:
        node-version: '20'
    - name: å®‰è£æ€§èƒ½æ¸¬è©¦å·¥å…·
      run: 'npm install -g k6 artillery

        '
    - name: éƒ¨ç½²æ¸¬è©¦ç’°å¢ƒ
      run: 'echo "ğŸš€ éƒ¨ç½²æ¸¬è©¦ç’°å¢ƒ..."

        # ä½¿ç”¨æ§‹å»ºçš„é¡åƒéƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ

        docker-compose -f docker-compose.test.yml up -d

        sleep 30  # ç­‰å¾…æœå‹™å•Ÿå‹•

        '
    - name: åŸ·è¡Œæ€§èƒ½æ¸¬è©¦
      run: "echo \"âš¡ åŸ·è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦...\"\n\n# K6 è² è¼‰æ¸¬è©¦\nif [ -f \"tests/performance/load-test.js\"\
        \ ]; then\n  k6 run --out json=load-test-results.json tests/performance/load-test.js\
        \ || echo \"âš ï¸ K6 æ¸¬è©¦å®Œæˆ\"\nfi\n\n# Artillery HTTP æ¸¬è©¦\nif [ -f \"tests/performance/artillery-config.yml\"\
        \ ]; then\n  artillery run tests/performance/artillery-config.yml --output\
        \ artillery-results.json || echo \"âš ï¸ Artillery æ¸¬è©¦å®Œæˆ\"\nfi\n"
    - name: ç”Ÿæˆæ€§èƒ½æ¸¬è©¦å ±å‘Š
      run: 'echo "# âš¡ Performance Test Report" > performance-test-report.md

        echo "" >> performance-test-report.md

        echo "**æ¸¬è©¦æ™‚é–“**: $(date)" >> performance-test-report.md

        echo "**é¡åƒ**: ${{ needs.build-and-push.outputs.image-tag }}" >> performance-test-report.md

        echo "" >> performance-test-report.md


        echo "## ğŸ“Š æ€§èƒ½æ¸¬è©¦çµæœ" >> performance-test-report.md

        echo "âœ… æ€§èƒ½åŸºæº–æ¸¬è©¦å·²å®Œæˆ" >> performance-test-report.md

        echo "" >> performance-test-report.md


        echo "### ğŸ“‹ æ¸¬è©¦é …ç›®" >> performance-test-report.md

        echo "- è² è¼‰æ¸¬è©¦ (K6)" >> performance-test-report.md

        echo "- HTTP å£“åŠ›æ¸¬è©¦ (Artillery)" >> performance-test-report.md


        cat performance-test-report.md

        '
    - if: always()
      name: æ¸…ç†æ¸¬è©¦ç’°å¢ƒ
      run: 'docker-compose -f docker-compose.test.yml down -v

        '
    - name: ä¸Šå‚³æ€§èƒ½æ¸¬è©¦å ±å‘Š
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: performance-test-report
        path: 'performance-test-report.md

          load-test-results.json

          artillery-results.json

          '
        retention-days: 7
    timeout-minutes: 30
  post-deploy-notification:
    if: always()
    name: ğŸ“¢ Post-Deployment Notification
    needs:
    - pre-deploy-checks
    - build-and-push
    - security-scan
    - performance-tests
    - deploy
    runs-on: ubuntu-latest
    steps:
      - name: "ä¸‹è¼‰æ‰€æœ‰å ±å‘Š"
        uses: 6b208ae046db98c579e8a328f74b955651f427c0
        with:
          merge-multiple: true

      - name: "ç”Ÿæˆéƒ¨ç½²ç¸½çµ"
        run: |
          echo "# ğŸš€ Deployment Summary" > deployment-summary.md
          echo "" >> deployment-summary.md
          echo "**éƒ¨ç½²æ™‚é–“**: $(date)" >> deployment-summary.md
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> deployment-summary.md
          echo "**æäº¤**: ${{ github.sha }}" >> deployment-summary.md
          echo "**è§¸ç™¼è€…**: ${{ github.actor }}" >> deployment-summary.md
          echo "" >> deployment-summary.md
          
          echo "## ğŸ“Š éƒ¨ç½²ç‹€æ…‹" >> deployment-summary.md
          echo "- ğŸ” éƒ¨ç½²å‰æª¢æŸ¥: ${{ needs.pre-deploy-checks.result }}" >> deployment-summary.md
          echo "- ğŸ³ æ§‹å»ºèˆ‡æ¨é€: ${{ needs.build-and-push.result }}" >> deployment-summary.md
          echo "- ğŸ”’ å®‰å…¨æƒæ: ${{ needs.security-scan.result }}" >> deployment-summary.md
          echo "- âš¡ æ€§èƒ½æ¸¬è©¦: ${{ needs.performance-tests.result }}" >> deployment-summary.md
          echo "- ğŸš€ éƒ¨ç½²: ${{ needs.deploy.result }}" >> deployment-summary.md
          echo "" >> deployment-summary.md
          
          # åˆ¤æ–·æ•´é«”ç‹€æ…‹
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "## âœ… éƒ¨ç½²æˆåŠŸ" >> deployment-summary.md
            echo "ğŸ‰ æ‡‰ç”¨å·²æˆåŠŸéƒ¨ç½²ï¼" >> deployment-summary.md
          else
            echo "## âŒ éƒ¨ç½²å¤±æ•—" >> deployment-summary.md
            echo "âš ï¸ éƒ¨ç½²éç¨‹ä¸­é‡åˆ°å•é¡Œï¼Œè«‹æª¢æŸ¥è©³ç´°æ—¥èªŒã€‚" >> deployment-summary.md
          fi
          
          cat deployment-summary.md

      - name: "ç™¼é€é€šçŸ¥"
        if: always()
        uses: 60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const fs = require('fs');
            
            if (fs.existsSync('deployment-summary.md')) {
              const summary = fs.readFileSync('deployment-summary.md', 'utf8');
              
              // å‰µå»º deployment status
              if ('${{ needs.deploy.result }}' === 'success') {
                await github.rest.repos.createDeploymentStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: context.payload.deployment?.id || 1,
                  state: 'success',
                  environment: '${{ github.event.inputs.environment || "staging" }}',
                  log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                });
              }
              
              // åœ¨ç›¸é—œçš„ issue æˆ– PR ä¸­è©•è«–
              if (context.payload.pull_request) {
                await github.rest.issues.createComment({
                  issue_number: context.payload.pull_request.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: summary
                });
              }
            }

      - name: "ä¸Šå‚³éƒ¨ç½²ç¸½çµ"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: deployment-summary
          path: deployment-summary.md
          retention-days: 30
    - name: ä¸‹è¼‰æ‰€æœ‰å ±å‘Š
      uses: 6b208ae046db98c579e8a328f74b955651f427c0
      with:
        merge-multiple: true
    - name: ç”Ÿæˆéƒ¨ç½²ç¸½çµ
      run: "echo \"# \U0001F680 Deployment Summary\" > deployment-summary.md\necho\
        \ \"\" >> deployment-summary.md\necho \"**éƒ¨ç½²æ™‚é–“**: $(date)\" >> deployment-summary.md\n\
        echo \"**åˆ†æ”¯**: ${{ github.ref_name }}\" >> deployment-summary.md\necho \"\
        **æäº¤**: ${{ github.sha }}\" >> deployment-summary.md\necho \"**è§¸ç™¼è€…**: ${{\
        \ github.actor }}\" >> deployment-summary.md\necho \"\" >> deployment-summary.md\n\
        \necho \"## \U0001F4CA éƒ¨ç½²ç‹€æ…‹\" >> deployment-summary.md\necho \"- \U0001F50D\
        \ éƒ¨ç½²å‰æª¢æŸ¥: ${{ needs.pre-deploy-checks.result }}\" >> deployment-summary.md\n\
        echo \"- \U0001F433 æ§‹å»ºèˆ‡æ¨é€: ${{ needs.build-and-push.result }}\" >> deployment-summary.md\n\
        echo \"- \U0001F512 å®‰å…¨æƒæ: ${{ needs.security-scan.result }}\" >> deployment-summary.md\n\
        echo \"- âš¡ æ€§èƒ½æ¸¬è©¦: ${{ needs.performance-tests.result }}\" >> deployment-summary.md\n\
        echo \"- \U0001F680 éƒ¨ç½²: ${{ needs.deploy.result }}\" >> deployment-summary.md\n\
        echo \"\" >> deployment-summary.md\n\n# åˆ¤æ–·æ•´é«”ç‹€æ…‹\nif [ \"${{ needs.deploy.result\
        \ }}\" = \"success\" ]; then\n  echo \"## âœ… éƒ¨ç½²æˆåŠŸ\" >> deployment-summary.md\n\
        \  echo \"\U0001F389 æ‡‰ç”¨å·²æˆåŠŸéƒ¨ç½²ï¼\" >> deployment-summary.md\nelse\n  echo \"\
        ## âŒ éƒ¨ç½²å¤±æ•—\" >> deployment-summary.md\n  echo \"âš ï¸ éƒ¨ç½²éç¨‹ä¸­é‡åˆ°å•é¡Œï¼Œè«‹æª¢æŸ¥è©³ç´°æ—¥èªŒã€‚\" >>\
        \ deployment-summary.md\nfi\n\ncat deployment-summary.md\n"
    - if: always()
      name: ç™¼é€é€šçŸ¥
      uses: 60a0d83039c74a4aee543508d2ffcb1c3799cdea
      with:
        script: "const fs = require('fs');\n\nif (fs.existsSync('deployment-summary.md'))\
          \ {\n  const summary = fs.readFileSync('deployment-summary.md', 'utf8');\n\
          \  \n  // å‰µå»º deployment status\n  if ('${{ needs.deploy.result }}' === 'success')\
          \ {\n    await github.rest.repos.createDeploymentStatus({\n      owner:\
          \ context.repo.owner,\n      repo: context.repo.repo,\n      deployment_id:\
          \ context.payload.deployment?.id || 1,\n      state: 'success',\n      environment:\
          \ '${{ github.event.inputs.environment || \"staging\" }}',\n      log_url:\
          \ `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`\n\
          \    });\n  }\n  \n  // åœ¨ç›¸é—œçš„ issue æˆ– PR ä¸­è©•è«–\n  if (context.payload.pull_request)\
          \ {\n    await github.rest.issues.createComment({\n      issue_number: context.payload.pull_request.number,\n\
          \      owner: context.repo.owner,\n      repo: context.repo.repo,\n    \
          \  body: summary\n    });\n  }\n}\n"
    - name: ä¸Šå‚³éƒ¨ç½²ç¸½çµ
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: deployment-summary
        path: deployment-summary.md
        retention-days: 30
  pre-deploy-checks:
    name: ğŸ” Pre-Deployment Checks
    outputs:
      deploy-approved: ${{ steps.check.outputs.approved }}
      risk-level: ${{ steps.check.outputs.risk-level }}
    runs-on: ubuntu-latest
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
      with:
        fetch-depth: 0
    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: 82c7e631bb3cdc910f68e0081d534527d238d7a7
      with:
        python-version: '3.11'
    - name: å®‰è£æª¢æŸ¥å·¥å…·
      run: 'pip install --user requests pyyaml

        '
    - id: check
      name: éƒ¨ç½²é¢¨éšªè©•ä¼°
      run: "echo \"\U0001F50D åŸ·è¡Œéƒ¨ç½²å‰æª¢æŸ¥...\"\n\n# æª¢æŸ¥æ˜¯å¦ç‚ºå¼·åˆ¶éƒ¨ç½²\nif [ \"${{ github.event.inputs.force_deploy\
        \ }}\" = \"true\" ]; then\n  echo \"approved=true\" >> $GITHUB_OUTPUT\n  echo\
        \ \"risk-level=forced\" >> $GITHUB_OUTPUT\n  echo \"âš ï¸ å¼·åˆ¶éƒ¨ç½²æ¨¡å¼ï¼Œè·³éå®‰å…¨æª¢æŸ¥\"\n \
        \ exit 0\nfi\n\n# æª¢æŸ¥æœ€è¿‘çš„CIç‹€æ…‹\nCI_STATUS=$(gh run list --workflow=\"CI Pipeline\"\
        \ --branch=${{ github.ref_name }} --limit=1 --json conclusion --jq '.[0].conclusion'\
        \ || echo \"unknown\")\n\nif [ \"$CI_STATUS\" != \"success\" ]; then\n  echo\
        \ \"approved=false\" >> $GITHUB_OUTPUT\n  echo \"risk-level=high\" >> $GITHUB_OUTPUT\n\
        \  echo \"âŒ CIæª¢æŸ¥æœªé€šéï¼Œæ‹’çµ•éƒ¨ç½²\"\n  exit 1\nfi\n\n# æª¢æŸ¥è®Šæ›´ç¯„åœ\nCOMMITS_SINCE_MAIN=$(git\
        \ rev-list --count origin/main..HEAD)\nif [ \"$COMMITS_SINCE_MAIN\" -gt 10\
        \ ]; then\n  echo \"risk-level=medium\" >> $GITHUB_OUTPUT\nelse\n  echo \"\
        risk-level=low\" >> $GITHUB_OUTPUT\nfi\n\n# æª¢æŸ¥æ˜¯å¦æœ‰éƒ¨ç½²é˜»å¡æ–‡ä»¶\nif [ -f \"DEPLOY_BLOCK\"\
        \ ]; then\n  echo \"approved=false\" >> $GITHUB_OUTPUT\n  echo \"risk-level=blocked\"\
        \ >> $GITHUB_OUTPUT\n  echo \"âŒ ç™¼ç¾éƒ¨ç½²é˜»å¡æ–‡ä»¶ï¼Œæ‹’çµ•éƒ¨ç½²\"\n  exit 1\nfi\n\necho \"approved=true\"\
        \ >> $GITHUB_OUTPUT\necho \"âœ… éƒ¨ç½²å‰æª¢æŸ¥é€šé\"\n"
    - name: ç”Ÿæˆæª¢æŸ¥å ±å‘Š
      run: "echo \"# \U0001F50D Pre-Deployment Check Report\" > pre-deploy-report.md\n\
        echo \"\" >> pre-deploy-report.md\necho \"**æª¢æŸ¥æ™‚é–“**: $(date)\" >> pre-deploy-report.md\n\
        echo \"**æäº¤**: ${{ github.sha }}\" >> pre-deploy-report.md\necho \"**åˆ†æ”¯**:\
        \ ${{ github.ref_name }}\" >> pre-deploy-report.md\necho \"**é¢¨éšªç­‰ç´š**: ${{ steps.check.outputs.risk-level\
        \ }}\" >> pre-deploy-report.md\necho \"\" >> pre-deploy-report.md\n\nif [\
        \ \"${{ steps.check.outputs.approved }}\" = \"true\" ]; then\n  echo \"##\
        \ âœ… æª¢æŸ¥çµæœ: é€šé\" >> pre-deploy-report.md\n  echo \"\U0001F389 éƒ¨ç½²å·²ç²æ‰¹å‡†\" >> pre-deploy-report.md\n\
        else\n  echo \"## âŒ æª¢æŸ¥çµæœ: æ‹’çµ•\" >> pre-deploy-report.md\n  echo \"âš ï¸ éƒ¨ç½²å·²è¢«æ‹’çµ•\"\
        \ >> pre-deploy-report.md\nfi\n\ncat pre-deploy-report.md\n"
    - name: ä¸Šå‚³æª¢æŸ¥å ±å‘Š
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: pre-deploy-check-report
        path: pre-deploy-report.md
        retention-days: 7
    timeout-minutes: 15
  security-scan:
    if: needs.build-and-push.result == 'success'
    name: ğŸ”’ Security Scan
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: é‹è¡Œ Trivy æ¼æ´æƒæ
      uses: aquasecurity/trivy-action@master
      with:
        format: sarif
        image-ref: ${{ needs.build-and-push.outputs.image-tag }}
        output: trivy-results.sarif
    - name: ä¸Šå‚³ Trivy æƒæçµæœåˆ° GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-results.sarif
    - name: ç”Ÿæˆå®‰å…¨æƒæå ±å‘Š
      run: "echo \"# \U0001F512 Container Security Scan Report\" > container-security-report.md\n\
        echo \"\" >> container-security-report.md\necho \"**æƒææ™‚é–“**: $(date)\" >> container-security-report.md\n\
        echo \"**é¡åƒ**: ${{ needs.build-and-push.outputs.image-tag }}\" >> container-security-report.md\n\
        echo \"\" >> container-security-report.md\n\nif [ -f \"trivy-results.sarif\"\
        \ ]; then\n  echo \"## âœ… å®‰å…¨æƒæå®Œæˆ\" >> container-security-report.md\n  echo\
        \ \"\U0001F4CB æƒæçµæœå·²ä¸Šå‚³åˆ° GitHub Security\" >> container-security-report.md\n\
        else\n  echo \"## âŒ å®‰å…¨æƒæå¤±æ•—\" >> container-security-report.md\n  echo \"âš ï¸\
        \ ç„¡æ³•ç”Ÿæˆæƒæçµæœ\" >> container-security-report.md\nfi\n\ncat container-security-report.md\n"
    - name: ä¸Šå‚³å®‰å…¨æƒæå ±å‘Š
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: container-security-report
        path: container-security-report.md
        retention-days: 7
    timeout-minutes: 20
