name: ğŸ›ï¸ Controlplane Integration Demo

on:
  pull_request:
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '**/*.py'
      - '**/*.sh'
      - 'controlplane/**'
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  # Job 1: ä½¿ç”¨ controlplane é©—è­‰æ–‡ä»¶å‘½å
  validate-naming:
    name: Validate File Naming (using controlplane)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Load controlplane library
        run: |
          source lib/controlplane.sh
          cp_show_status

      - name: Validate file naming conventions
        run: |
          source lib/controlplane.sh
          
          echo "ğŸ” Validating file naming conventions..."
          
          # ç²å–æ‰€æœ‰ YAML æ–‡ä»¶
          files=$(find . -name "*.yaml" -o -name "*.yml" | grep -v ".git" | grep -v "node_modules" || true)
          
          total=0
          invalid=0
          
          while IFS= read -r file; do
            if [[ -z "$file" ]]; then continue; fi
            
            filename=$(basename "$file")
            total=$((total + 1))
            
            if ! cp_validate_name "$filename" "file" 2>/dev/null; then
              invalid=$((invalid + 1))
              echo "âŒ Invalid: $file"
            fi
          done <<< "$files"
          
          echo ""
          echo "Results: $((total - invalid))/$total files valid"
          
          if [[ $invalid -gt 0 ]]; then
            echo "::warning::Found $invalid files with invalid names"
          fi

  # Job 2: ä½¿ç”¨ controlplane CLI å·¥å…·
  use-cli-tools:
    name: Use Controlplane CLI Tools
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Test cp-cli tool
        run: |
          chmod +x bin/cp-cli
          
          echo "ğŸ“Š Controlplane Status:"
          ./bin/cp-cli status
          
          echo ""
          echo "ğŸ“‹ List Modules:"
          ./bin/cp-cli list modules || echo "No modules found"
          
          echo ""
          echo "ğŸ“‹ List Namespaces:"
          ./bin/cp-cli list namespaces || echo "No namespaces found"
          
          echo ""
          echo "ğŸ” Check Name Examples:"
          ./bin/cp-cli check-name "my-file.yaml" --type file && echo "âœ… Valid" || echo "âŒ Invalid"
          ./bin/cp-cli check-name "MyFile.yaml" --type file && echo "âœ… Valid" || echo "âŒ Invalid"

      - name: Synthesize active view
        run: |
          ./bin/cp-cli synthesize
          ls -la controlplane/active/

  # Job 3: ä½¿ç”¨ Python é…ç½®åº«
  use-python-library:
    name: Use Python Configuration Library
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Test Python library
        run: |
          python3 << 'EOF'
          import sys
          sys.path.insert(0, 'lib')
          
          from controlplane import ControlplaneConfig
          
          print("ğŸ Testing Python Controlplane Library")
          print("=" * 60)
          
          config = ControlplaneConfig()
          
          # æ¸¬è©¦ç²å–é…ç½®
          print("\n1. Get root config:")
          root_config = config.get_baseline_config("root.config.yaml")
          print(f"   Name: {root_config.get('metadata', {}).get('name')}")
          
          # æ¸¬è©¦å‘½åé©—è­‰
          print("\n2. Validate names:")
          test_cases = [
              ("my-file.yaml", "file"),
              ("MyFile.yaml", "file"),
              ("my-namespace", "namespace"),
              ("my.namespace", "namespace")
          ]
          
          for name, name_type in test_cases:
              is_valid, error = config.validate_name(name, name_type)
              status = "âœ…" if is_valid else "âŒ"
              print(f"   {status} {name} ({name_type})")
          
          # æ¸¬è©¦ç²å–å‘½åè¦å‰‡
          print("\n3. Get naming rules:")
          naming_rules = config.get_naming_rules()
          print(f"   Rules loaded: {len(naming_rules)} keys")
          
          print("\nâœ… Python library test completed")
          EOF

  # Job 4: å®Œæ•´çš„ controlplane é©—è­‰
  full-validation:
    name: Full Controlplane Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run controlplane validation
        run: |
          python3 controlplane/baseline/validation/validate-root-specs.py

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: controlplane-validation-report
          path: |
            controlplane/overlay/evidence/validation/validation.report.md
            controlplane/overlay/evidence/validation/validation.report.json

      - name: Comment validation result
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'controlplane/overlay/evidence/validation/validation.report.md';
            
            let summary = 'âš ï¸ Validation report not found';
            if (fs.existsSync(reportPath)) {
              summary = fs.readFileSync(reportPath, 'utf8');
              if (summary.length > 12000) {
                summary = summary.slice(0, 12000) + '\n\n...(truncated, see artifact for full report)';
              }
            }
            
            const body = `## ğŸ›ï¸ Controlplane Validation Results
            
This PR has been validated using the controlplane configuration system.

### Validation Report

\`\`\`markdown
${summary}
\`\`\`

### What is Controlplane?

Controlplane is our configuration governance system that ensures:
- âœ… File naming conventions are followed
- âœ… Configuration consistency across the repository
- âœ… Namespace and module registry compliance
- âœ… Integration rules are respected

### Tools Used

- **cp-cli**: Command-line interface for controlplane
- **controlplane.py**: Python configuration library
- **controlplane.sh**: Shell configuration library
- **validate-root-specs.py**: Full validation system

---
*This validation was performed automatically using controlplane integration.*
`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  # Job 5: å±•ç¤ºå¯¦éš›æ‡‰ç”¨æ¡ˆä¾‹
  practical-usage:
    name: Practical Usage Examples
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Example 1 - Validate new file before creation
        run: |
          source lib/controlplane.sh
          
          echo "ğŸ“ Example 1: Validate file name before creation"
          
          new_file="my-new-config.yaml"
          if cp_validate_name "$new_file" "file"; then
            echo "âœ… File name is valid, safe to create: $new_file"
          else
            echo "âŒ File name is invalid, please rename"
            exit 1
          fi

      - name: Example 2 - Read configuration in script
        run: |
          python3 << 'EOF'
          import sys
          sys.path.insert(0, 'lib')
          from controlplane import get_config
          
          print("ğŸ“– Example 2: Read configuration in script")
          
          config = get_config()
          
          # ç²å–æ²»ç†ç­–ç•¥
          governance = config.get_governance_policy()
          print(f"âœ… Governance policy loaded")
          
          # ç²å–å‘½åè¦å‰‡
          naming = config.get_naming_rules()
          print(f"âœ… Naming rules loaded")
          
          # æª¢æŸ¥æ˜¯å¦ä¸å¯è®Š
          is_immutable = config.is_baseline_immutable()
          print(f"âœ… Baseline immutable: {is_immutable}")
          EOF

      - name: Example 3 - Use in automation script
        run: |
          source lib/controlplane.sh
          
          echo "ğŸ¤– Example 3: Use in automation script"
          
          # å°å‡ºç’°å¢ƒè®Šé‡
          cp_export_env
          
          # ä½¿ç”¨ç’°å¢ƒè®Šé‡
          echo "âœ… Config path: $CP_BASELINE_CONFIG"
          echo "âœ… Specs path: $CP_BASELINE_SPECS"
          echo "âœ… Registries path: $CP_BASELINE_REGISTRIES"
          
          # åˆ—å‡ºé…ç½®æ–‡ä»¶
          echo ""
          echo "Available configs:"
          ls -1 "$CP_BASELINE_CONFIG"/*.yaml | head -5