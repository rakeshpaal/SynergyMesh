name: üéõÔ∏è Controlplane Integration Demo

on:
  pull_request:
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '**/*.py'
      - '**/*.sh'
      - 'controlplane/**'
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-naming:
    name: Validate File Naming (using controlplane)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Load controlplane library
        run: |
          if [ -f "lib/controlplane.sh" ]; then
            source lib/controlplane.sh
            cp_show_status
          else
            echo "Controlplane library not found, skipping"
          fi

      - name: Validate file naming conventions
        run: |
          if [ -f "lib/controlplane.sh" ]; then
            source lib/controlplane.sh
            
            echo "üîç Validating file naming conventions..."
            
            files=$(find . -name "*.yaml" -o -name "*.yml" | grep -v ".git" | grep -v "node_modules" || true)
            
            total=0
            invalid=0
            
            while IFS= read -r file; do
              if [[ -z "$file" ]]; then continue; fi
              
              filename=$(basename "$file")
              total=$((total + 1))
              
              if ! cp_validate_name "$filename" "file" 2>/dev/null; then
                invalid=$((invalid + 1))
                echo "‚ùå Invalid: $file"
              fi
            done <<< "$files"
            
            echo ""
            echo "Results: $((total - invalid))/$total files valid"
            
            if [[ $invalid -gt 0 ]]; then
              echo "::warning::Found $invalid files with invalid names"
            fi
          else
            echo "Controlplane library not found, skipping validation"
          fi

  use-cli-tools:
    name: Use Controlplane CLI Tools
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Test cp-cli tool
        run: |
          if [ -f "bin/cp-cli" ]; then
            chmod +x bin/cp-cli
            
            echo "üìä Controlplane Status:"
            ./bin/cp-cli status || echo "Status check failed"
            
            echo ""
            echo "üìã List Modules:"
            ./bin/cp-cli list modules || echo "No modules found"
            
            echo ""
            echo "üìã List Namespaces:"
            ./bin/cp-cli list namespaces || echo "No namespaces found"
            
            echo ""
            echo "üîç Check Name Examples:"
            ./bin/cp-cli check-name "my-file.yaml" --type file && echo "‚úÖ Valid" || echo "‚ùå Invalid"
            ./bin/cp-cli check-name "MyFile.yaml" --type file && echo "‚úÖ Valid" || echo "‚ùå Invalid"
          else
            echo "cp-cli tool not found, skipping"
          fi

      - name: Synthesize active view
        run: |
          if [ -f "bin/cp-cli" ]; then
            ./bin/cp-cli synthesize || echo "Synthesis failed"
            ls -la controlplane/active/ || echo "Active directory not found"
          else
            echo "cp-cli tool not found, skipping"
          fi

  use-python-library:
    name: Use Python Configuration Library
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Test Python library
        run: |
          if [ -f "lib/controlplane.py" ]; then
            python3 lib/controlplane.py || echo "Python library test failed"
          else
            echo "Python library not found, skipping"
          fi

  full-validation:
    name: Full Controlplane Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run controlplane validation
        run: |
          if [ -f "controlplane/baseline/validation/validate-root-specs.py" ]; then
            python3 controlplane/baseline/validation/validate-root-specs.py
          else
            echo "Validation script not found, skipping"
          fi

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: controlplane-validation-report
          path: |
            controlplane/overlay/evidence/validation/validation.report.md
            controlplane/overlay/evidence/validation/validation.report.json