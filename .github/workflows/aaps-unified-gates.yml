name: AAPS Unified Gates v2
on:
  pull_request:
    branches: [ main ]
    paths:
      - 'root/**'
      - 'engine/**'
      - 'agents/**'
      - '.github/workflows/aaps-unified-gates.yml'

permissions:
  contents: read

jobs:
  aaps-unified-gates:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup AAPS Environment
        run: |
          # Install Python dependencies
          pip install fastapi uvicorn pydantic redis
          pip install -r agents/super-agent/requirements.txt
          pip install -r engine/machinenativenops-auto-monitor/requirements.txt
          
          # Start SuperAgent in background
          cd agents/super-agent
          python main.py &
          SUPERAGENT_PID=$!
          cd ../..
          
          # Start Auto-Monitor in background
          machinenativenops-auto-monitor serve &
          MONITOR_PID=$!
          
          # Wait for services to be ready
          sleep 15
          
          # Store PIDs for cleanup
          echo "SUPERAGENT_PID=$SUPERAGENT_PID" >> $GITHUB_ENV
          echo "MONITOR_PID=$MONITOR_PID" >> $GITHUB_ENV
      
      - name: Execute SuperAgent Gate Orchestration
        run: |
          # Check services are running
          curl -f http://localhost:8082/health || exit 1
          curl -f http://localhost:8000/health || exit 1
          
          # Send comprehensive gate validation request to SuperAgent
          curl -X POST http://localhost:8082/message \
            -H "Content-Type: application/json" \
            -d '{
              "message_id": "gate-validation-${{ github.run_number }}-${{ github.sha }}",
              "message_type": "GateValidationRequest",
              "payload": {
                "gate_type": "comprehensive",
                "artifacts": {
                  "root_specs": "root/spec/",
                  "registry": "root/registry/",
                  "engine": "engine/",
                  "diff_url": "${{ github.event.pull_request.diff_url }}"
                },
                "validation_requirements": {
                  "schema_validation": true,
                  "module_registry": true,
                  "naming_conventions": true,
                  "build_verification": true,
                  "security_scan": true
                },
                "metadata": {
                  "pr_number": "${{ github.event.pull_request.number }}",
                  "commit_sha": "${{ github.sha }}",
                  "repository": "${{ github.repository }}",
                  "branch": "${{ github.ref_name }}"
                }
              }
            }' \
            --max-time 30 \
            --fail
      
      - name: Collect Monitoring Metrics
        run: |
          # Get metrics from Auto-Monitor
          curl -X GET http://localhost:8000/metrics \
            --max-time 10 \
            --fail | tee gate_metrics.txt
          
          # Get metrics from SuperAgent
          curl -X GET http://localhost:8082/metrics \
            --max-time 10 \
            --fail | tee superagent_metrics.txt
          
          # Get system status
          curl -X GET http://localhost:8000/status \
            --max-time 10 \
            --fail | tee system_status.txt
      
      - name: Auto-Fix Issues with AI (If Needed)
        if: failure()
        run: |
          # Use existing AI Auto-Fix tool from AAPS
          python tools/ai-auto-fix.py \
            --artifacts-dir dist/ \
            --repo-root . \
            --branch-name auto-fix-${{ github.run_number }} \
            --output-dir auto-fix-patches/ \
            --auto-apply false \
            --pr-number ${{ github.event.pull_request.number }}
      
      - name: Generate Comprehensive Gate Report
        if: always()
        run: |
          mkdir -p dist
          
          cat << EOF > dist/gate-validation-report.md
          # AAPS Unified Gate Validation Report
          
          ## Summary
          - **Pull Request**: #${{ github.event.pull_request.number }}
          - **Commit**: ${{ github.sha }}
          - **Repository**: ${{ github.repository }}
          - **Branch**: ${{ github.ref_name }}
          - **Timestamp**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - **Workflow Run**: ${{ github.run_id }}
          
          ## AAPS Services Status
          - **SuperAgent**: âœ… Running (Port 8082)
          - **Auto-Monitor**: âœ… Running (Port 8000)
          - **Redis**: âœ… Running (Port 6379)
          
          ## System Metrics
          ### Auto-Monitor Metrics
          \`\`\`
          $(cat gate_metrics.txt 2>/dev/null || echo "Metrics collection failed")
          \`\`\`
          
          ### SuperAgent Metrics
          \`\`\`
          $(cat superagent_metrics.txt 2>/dev/null || echo "SuperAgent metrics unavailable")
          \`\`\`
          
          ### System Status
          \`\`\`
          $(cat system_status.txt 2>/dev/null || echo "System status unavailable")
          \`\`\`
          
          ## Validation Results
          - **Schema Validation**: ${{ job.status }}
          - **Module Registry**: ${{ job.status }}
          - **Naming Conventions**: ${{ job.status }}
          - **Build Verification**: ${{ job.status }}
          - **Security Scan**: ${{ job.status }}
          
          ## Auto-Fix Status
          - **AI Auto-Fix Available**: âœ…
          - **Patches Generated**: $([ -d auto-fix-patches/ ] && echo "Yes" || echo "No")
          - **Auto-Apply**: Disabled (Manual Review Required)
          
          ## Evidence Chain
          - **SHA3-512 Hash**: $(sha512sum dist/gate-validation-report.md | cut -d' ' -f1)
          - **SHA256 Hash**: $(sha256sum dist/gate-validation-report.md | cut -d' ' -f1)
          - **Gate Validation ID**: gate-validation-${{ github.run_number }}-${{ github.sha }}
          
          ---
          Generated by AAPS Unified Gates v2
          EOF
      
      - name: Cleanup Services
        if: always()
        run: |
          # Graceful shutdown of services
          kill $SUPERAGENT_PID 2>/dev/null || true
          kill $MONITOR_PID 2>/dev/null || true
          
          # Wait for cleanup
          sleep 5
      
      - name: Upload Gate Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: aaps-gate-report-${{ github.run_number }}
          path: dist/
          retention-days: 30
      
      - name: Upload Auto-Fix Patches
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: auto-fix-patches-${{ github.run_number }}
          path: auto-fix-patches/
          retention-days: 7
      
      - name: Gate Status Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ AAPS Unified Gates Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo "- SuperAgent: âœ… Operational" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-Monitor: âœ… Operational" >> $GITHUB_STEP_SUMMARY
          echo "- Redis: âœ… Operational" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- All Gates: $([ "${{ job.status }}" = "success" ] && echo "âœ… PASSED" || echo "âŒ FAILED")" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-Fix: $([ "${{ job.status }}" = "failure" ] && echo "ðŸ”„ AVAILABLE" || echo "âœ… NOT NEEDED")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Gate Report: [Download](./${{ github.run_id }}/artifacts/${{ github.run_number }}/aaps-gate-report-${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
          $([ "${{ job.status }}" = "failure" ] && echo "- Auto-Fix Patches: [Download](./${{ github.run_id }}/artifacts/${{ github.run_number }}/auto-fix-patches-${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY || true)