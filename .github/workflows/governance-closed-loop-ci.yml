# =============================================================================
# SynergyMesh Governance Closed-Loop CI
# Ê≤ªÁêÜÈñâÁí∞ CI - Êï¥Âêà‰∏ÉÂ§ßÊ†∏ÂøÉÊ™¢Êü•
# =============================================================================
# This workflow consolidates governance-related CI jobs into 7 core checks:
# 1. DAG Validation - Check governance-index.json for circular dependencies
# 2. Policy Execution Check - Ensure all required dimensions are executed
# 3. Compliance Framework Check - Verify ISO-42001, NIST-AI-RMF compliance
# 4. Event Closure Check - Validate event registry causal chains
# 5. Technical Debt Tracking - Scan TODO/FIXME/DEBT markers
# 6. Security Check - SBOM + vulnerability scanning
# 7. Deployment Verification - Validate artifacts can be deployed
# =============================================================================

name: Governance Closed-Loop CI

on:
  push:
    branches: [main, develop]
    paths:
      - "governance/**"
      - ".github/workflows/governance-closed-loop-ci.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "governance/**"
  workflow_dispatch:
    inputs:
      full_scan:
        description: "Run full governance scan"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Restrict permissions to minimum required
permissions:
  contents: read

env:
  PYTHON_VERSION: "3.11"
  OPA_VERSION: "0.60.0"

jobs:
  # ===========================================================================
  # Job 1: DAG Validation (Ê≤ªÁêÜÁ¥¢Âºï DAG È©óË≠â)
  # ===========================================================================
  dag-validation:
    name: "1Ô∏è‚É£ DAG Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      dag_valid: ${{ steps.validate.outputs.valid }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate Governance DAG
        id: validate
        run: |
          python3 << 'EOF'
          import json
          import sys
          from collections import defaultdict

          def detect_cycles(dimensions):
              """Detect circular dependencies using DFS"""
              visited = set()
              rec_stack = set()
              cycles = []

              def dfs(node, path):
                  visited.add(node)
                  rec_stack.add(node)
                  path.append(node)

                  deps = dimensions.get(node, {}).get('depends_on', [])
                  for dep in deps:
                      if dep not in visited:
                          if dfs(dep, path):
                              return True
                      elif dep in rec_stack:
                          cycle_start = path.index(dep)
                          cycles.append(path[cycle_start:] + [dep])
                          return True

                  path.pop()
                  rec_stack.remove(node)
                  return False

              for node in dimensions:
                  if node not in visited:
                      dfs(node, [])

              return cycles

          def check_missing_deps(dimensions):
              """Check for dependencies that don't exist"""
              all_ids = set(dimensions.keys())
              missing = []
              for dim_id, dim in dimensions.items():
                  deps = dim.get('depends_on', [])
                  for dep in deps:
                      if dep not in all_ids:
                          missing.append(f"{dim_id} -> {dep}")
              return missing

          def check_orphans(dimensions):
              """Check for orphan nodes with no connections"""
              dependents = set()
              for dim in dimensions.values():
                  for dep in dim.get('depends_on', []):
                      dependents.add(dep)
              
              orphans = []
              for dim_id, dim in dimensions.items():
                  if not dim.get('depends_on') and dim_id not in dependents:
                      # Exclude known root dimensions
                      if dim_id not in ['01', '23', '31', '33', '34', '12', '22', '29']:
                          orphans.append(dim_id)
              return orphans

          # Load governance index
          try:
              with open('governance/governance-index.json') as f:
                  index = json.load(f)
          except FileNotFoundError:
              print("‚ùå ERROR: governance/governance-index.json not found")
              sys.exit(1)

          # Load dimensions
          try:
              with open('governance/index/dimensions.json') as f:
                  dim_data = json.load(f)
          except FileNotFoundError:
              print("‚ùå ERROR: governance/index/dimensions.json not found")
              sys.exit(1)

          # Build dimension map
          dimensions = {}
          for dim in dim_data.get('dimensions', []):
              dimensions[dim['id']] = dim

          # Run validations
          errors = []
          warnings = []

          # Check circular dependencies
          cycles = detect_cycles(dimensions)
          if cycles:
              errors.append(f"Circular dependencies detected: {cycles}")

          # Check missing dependencies
          missing = check_missing_deps(dimensions)
          if missing:
              errors.append(f"Missing dependencies: {missing}")

          # Check orphans (warning only)
          orphans = check_orphans(dimensions)
          if orphans:
              warnings.append(f"Orphan dimensions (no dependencies): {orphans}")

          # Report results
          print("=" * 60)
          print("üîç DAG VALIDATION REPORT")
          print("=" * 60)
          print(f"Total dimensions: {len(dimensions)}")
          print(f"Circular dependencies: {len(cycles)}")
          print(f"Missing dependencies: {len(missing)}")
          print(f"Orphan dimensions: {len(orphans)}")

          if warnings:
              print("\n‚ö†Ô∏è WARNINGS:")
              for w in warnings:
                  print(f"  - {w}")

          if errors:
              print("\n‚ùå ERRORS:")
              for e in errors:
                  print(f"  - {e}")
              print("\nDAG validation failed!")
              with open("$GITHUB_OUTPUT", "a") as f:
                  f.write("valid=false\n")
              sys.exit(1)
          else:
              print("\n‚úÖ DAG validation passed!")
              with open("$GITHUB_OUTPUT", "a") as f:
                  f.write("valid=true\n")

          EOF
        env:
          GITHUB_OUTPUT: ${{ github.output }}

  # ===========================================================================
  # Job 2: Policy Execution Check (Á≠ñÁï•Âü∑Ë°åÊ™¢Êü•)
  # ===========================================================================
  policy-execution-check:
    name: "2Ô∏è‚É£ Policy Execution Check"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: dag-validation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check Required Dimensions
        run: |
          python3 << 'EOF'
          import json
          import os
          import sys

          # Load dimensions
          with open('governance/index/dimensions.json') as f:
              dim_data = json.load(f)

          # Check required dimensions have proper structure
          required_dims = []
          missing_structure = []

          for dim in dim_data.get('dimensions', []):
              if dim.get('execution') == 'required':
                  required_dims.append(dim)
                  dim_path = f"governance/{dim['path']}"
                  
                  # Check directory exists
                  if not os.path.isdir(dim_path):
                      missing_structure.append(f"{dim['id']}: directory {dim_path} missing")
                      continue
                  
                  # Check for dimension.yaml or README.md
                  has_config = (
                      os.path.exists(f"{dim_path}/dimension.yaml") or
                      os.path.exists(f"{dim_path}/framework.yaml") or
                      os.path.exists(f"{dim_path}/README.md")
                  )
                  if not has_config:
                      missing_structure.append(f"{dim['id']}: missing dimension.yaml/framework.yaml/README.md")

          print("=" * 60)
          print("üìã POLICY EXECUTION CHECK")
          print("=" * 60)
          print(f"Total required dimensions: {len(required_dims)}")
          print(f"Missing structure: {len(missing_structure)}")

          if missing_structure:
              print("\n‚ùå ERRORS:")
              for m in missing_structure[:10]:  # Limit output
                  print(f"  - {m}")
              if len(missing_structure) > 10:
                  print(f"  ... and {len(missing_structure) - 10} more")
              
              # Warning only for now - don't fail
              print("\n‚ö†Ô∏è Some required dimensions have incomplete structure")
          else:
              print("\n‚úÖ All required dimensions have proper structure!")

          # List required dimensions by layer
          by_layer = {}
          for dim in required_dims:
              layer = dim.get('layer', 'unknown')
              by_layer.setdefault(layer, []).append(dim['id'])

          print("\nRequired dimensions by layer:")
          for layer, dims in sorted(by_layer.items()):
              print(f"  {layer}: {', '.join(dims)}")

          EOF

  # ===========================================================================
  # Job 3: Compliance Framework Check (ÂêàË¶èÊ°ÜÊû∂Ê™¢Êü•)
  # ===========================================================================
  compliance-framework-check:
    name: "3Ô∏è‚É£ Compliance Framework Check"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: dag-validation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check Compliance Frameworks
        run: |
          python3 << 'EOF'
          import json
          import sys

          # Load compliance data
          try:
              with open('governance/index/compliance.json') as f:
                  compliance = json.load(f)
          except FileNotFoundError:
              print("‚ùå ERROR: governance/index/compliance.json not found")
              sys.exit(1)

          # Load dimensions
          with open('governance/index/dimensions.json') as f:
              dim_data = json.load(f)

          dimensions = {d['id']: d for d in dim_data.get('dimensions', [])}

          print("=" * 60)
          print("üìú COMPLIANCE FRAMEWORK CHECK")
          print("=" * 60)

          frameworks = compliance.get('frameworks', [])
          print(f"Registered frameworks: {len(frameworks)}")

          errors = []
          warnings = []

          # Check each framework
          for fw in frameworks:
              fw_id = fw['id']
              fw_dims = fw.get('dimensions', [])
              status = fw.get('status', 'unknown')
              
              print(f"\nüìå {fw_id} ({status})")
              print(f"   Dimensions: {len(fw_dims)}")
              
              # Check dimensions exist
              for dim in fw_dims:
                  dim_id = dim.split('-')[0] if '-' in dim else dim
                  if dim_id not in dimensions and dim not in ['ci', '10-stakeholder']:
                      warnings.append(f"{fw_id}: dimension '{dim}' not found")
              
              # Check blocking frameworks have all controls implemented
              if fw_id in compliance.get('enforcement', {}).get('blocking_frameworks', []):
                  controls = fw.get('controls', fw.get('obligations', fw.get('requirements', [])))
                  for ctrl in controls:
                      if ctrl.get('status') != 'implemented':
                          errors.append(f"{fw_id}: control {ctrl.get('id')} not implemented")

          # Check compliance matrix
          matrix = compliance.get('compliance_matrix', {}).get('by_dimension', {})
          dims_with_frameworks = set()
          for dim_id, fws in matrix.items():
              dims_with_frameworks.add(dim_id.split('-')[0] if '-' in dim_id else dim_id)

          # Check production dimensions have framework coverage
          for dim_id, dim in dimensions.items():
              if dim.get('status') == 'production' and dim_id not in dims_with_frameworks:
                  if dim_id not in ['01', '23', '31', '33', '34']:  # Infrastructure dims
                      warnings.append(f"Production dimension {dim_id} has no framework coverage")

          if warnings:
              print("\n‚ö†Ô∏è WARNINGS:")
              for w in warnings[:10]:
                  print(f"  - {w}")

          if errors:
              print("\n‚ùå ERRORS:")
              for e in errors:
                  print(f"  - {e}")
              sys.exit(1)
          else:
              print("\n‚úÖ Compliance framework check passed!")

          EOF

  # ===========================================================================
  # Job 4: Event Closure Check (‰∫ã‰ª∂ÈñâÁí∞Ê™¢Êü•)
  # ===========================================================================
  event-closure-check:
    name: "4Ô∏è‚É£ Event Closure Check"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: dag-validation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check Event Causal Chains
        run: |
          python3 << 'EOF'
          import json
          import sys

          # Load event registry
          try:
              with open('governance/index/events/registry.json') as f:
                  registry = json.load(f)
          except FileNotFoundError:
              print("‚ö†Ô∏è WARNING: Event registry not found, skipping")
              sys.exit(0)

          print("=" * 60)
          print("üîó EVENT CLOSURE CHECK")
          print("=" * 60)

          # Check event DAG flow patterns
          event_dag = registry.get('event_dag', {})
          flow_patterns = event_dag.get('flow_patterns', [])

          print(f"Flow patterns defined: {len(flow_patterns)}")

          warnings = []
          for pattern in flow_patterns:
              pattern_id = pattern.get('id')
              chain = pattern.get('chain', [])
              closes_at = pattern.get('closes_at')
              
              print(f"\nüìå {pattern_id}")
              print(f"   Chain: {' -> '.join(chain)}")
              print(f"   Closes at: {closes_at}")
              
              if not closes_at:
                  warnings.append(f"Pattern {pattern_id} has no closure point")
              
              if len(chain) < 2:
                  warnings.append(f"Pattern {pattern_id} chain too short")

          # Check bootstrap contract
          bootstrap = registry.get('bootstrap_contract', {})
          required_context = bootstrap.get('required_context', [])
          
          print(f"\nüìú Bootstrap Contract")
          print(f"   Required context files: {len(required_context)}")
          
          # Verify required context files exist
          import os
          for ctx in required_context:
              ctx_path = f"governance/index/{ctx}"
              if not os.path.exists(ctx_path):
                  warnings.append(f"Bootstrap context file missing: {ctx}")

          # Check storage configuration
          storage = registry.get('storage', {})
          retention = storage.get('retention', {})
          print(f"\nüì¶ Storage Configuration")
          print(f"   Hot retention: {retention.get('hot', 'N/A')}")
          print(f"   Warm retention: {retention.get('warm', 'N/A')}")
          print(f"   Cold retention: {retention.get('cold', 'N/A')}")

          if warnings:
              print("\n‚ö†Ô∏è WARNINGS:")
              for w in warnings:
                  print(f"  - {w}")

          print("\n‚úÖ Event closure check completed!")

          EOF

  # ===========================================================================
  # Job 5: Technical Debt Tracking (ÊäÄË°ìÂÇµÂãôËøΩËπ§)
  # ===========================================================================
  tech-debt-tracking:
    name: "5Ô∏è‚É£ Technical Debt Tracking"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: dag-validation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan Technical Debt Markers
        run: |
          echo "============================================================"
          echo "üìä TECHNICAL DEBT TRACKING"
          echo "============================================================"

          # Count TODO markers
          echo -e "\nüìå TODO markers:"
          TODO_COUNT=$(grep -r "TODO" --include="*.py" --include="*.ts" --include="*.js" --include="*.yaml" --include="*.yml" governance/ 2>/dev/null | wc -l || echo "0")
          echo "   Count: $TODO_COUNT"

          # Count FIXME markers
          echo -e "\nüìå FIXME markers:"
          FIXME_COUNT=$(grep -r "FIXME" --include="*.py" --include="*.ts" --include="*.js" --include="*.yaml" --include="*.yml" governance/ 2>/dev/null | wc -l || echo "0")
          echo "   Count: $FIXME_COUNT"

          # Count DEBT markers
          echo -e "\nüìå DEBT markers:"
          DEBT_COUNT=$(grep -r "DEBT\|tech.debt\|technical.debt" --include="*.py" --include="*.ts" --include="*.js" --include="*.yaml" --include="*.yml" governance/ 2>/dev/null | wc -l || echo "0")
          echo "   Count: $DEBT_COUNT"

          # Count DEPRECATED markers
          echo -e "\nüìå DEPRECATED markers:"
          DEPRECATED_COUNT=$(grep -r "DEPRECATED\|deprecated" --include="*.py" --include="*.ts" --include="*.js" --include="*.yaml" --include="*.yml" governance/ 2>/dev/null | wc -l || echo "0")
          echo "   Count: $DEPRECATED_COUNT"

          # Check tech-debt.json
          if [ -f "governance/index/tech-debt.json" ]; then
              echo -e "\nüìå Tech debt registry:"
              cat governance/index/tech-debt.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'   Registered items: {len(d.get(\"items\", []))}')" 2>/dev/null || echo "   Unable to parse"
          fi

          # Check technical-debt-report.json
          if [ -f "governance/technical-debt-report.json" ]; then
              echo -e "\nüìå Technical debt report:"
              cat governance/technical-debt-report.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'   Total issues: {d.get(\"summary\", {}).get(\"total_issues\", \"N/A\")}')" 2>/dev/null || echo "   Unable to parse"
          fi

          # Summary
          TOTAL=$((TODO_COUNT + FIXME_COUNT + DEBT_COUNT + DEPRECATED_COUNT))
          echo -e "\nüìä SUMMARY"
          echo "   Total debt markers: $TOTAL"

          if [ "$TOTAL" -gt 100 ]; then
              echo "   ‚ö†Ô∏è High technical debt detected!"
          elif [ "$TOTAL" -gt 50 ]; then
              echo "   ‚ö° Moderate technical debt"
          else
              echo "   ‚úÖ Technical debt under control"
          fi

  # ===========================================================================
  # Job 6: Security Check (ÂÆâÂÖ®Ê™¢Êü•)
  # ===========================================================================
  security-check:
    name: "6Ô∏è‚É£ Security Check"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: dag-validation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check SBOM
        run: |
          echo "============================================================"
          echo "üîí SECURITY CHECK"
          echo "============================================================"

          # Check for SBOM files
          echo -e "\nüìå SBOM Files:"
          if [ -d "governance/38-sbom" ]; then
              SBOM_COUNT=$(find governance/38-sbom -name "*.json" -o -name "*.spdx" 2>/dev/null | wc -l)
              echo "   SBOM files found: $SBOM_COUNT"
          else
              echo "   ‚ö†Ô∏è SBOM directory not found"
          fi

          # Check for security policies
          echo -e "\nüìå Security Policies:"
          if [ -d "governance/06-security" ]; then
              POLICY_COUNT=$(find governance/06-security -name "*.rego" -o -name "*.yaml" 2>/dev/null | wc -l)
              echo "   Security policy files: $POLICY_COUNT"
          else
              echo "   ‚ö†Ô∏è Security dimension not found"
          fi

          # Check for attestations
          echo -e "\nüìå Attestations:"
          if [ -d "governance/64-attestation" ]; then
              ATTESTATION_COUNT=$(find governance/64-attestation -type f 2>/dev/null | wc -l)
              echo "   Attestation files: $ATTESTATION_COUNT"
          else
              echo "   ‚ö†Ô∏è Attestation dimension not found"
          fi

          # Check compliance with SLSA
          echo -e "\nüìå SLSA Compliance:"
          if [ -f "governance/index/compliance.json" ]; then
              SLSA_STATUS=$(cat governance/index/compliance.json | python3 -c "import json,sys; d=json.load(sys.stdin); fws=[f for f in d.get('frameworks',[]) if f.get('id')=='SLSA']; print(fws[0].get('status','unknown') if fws else 'not found')" 2>/dev/null || echo "unknown")
              SLSA_LEVEL=$(cat governance/index/compliance.json | python3 -c "import json,sys; d=json.load(sys.stdin); fws=[f for f in d.get('frameworks',[]) if f.get('id')=='SLSA']; print(fws[0].get('level','N/A') if fws else 'N/A')" 2>/dev/null || echo "N/A")
              echo "   Status: $SLSA_STATUS"
              echo "   Level: $SLSA_LEVEL"
          fi

          echo -e "\n‚úÖ Security check completed!"

      - name: Run OSV Scanner (if available)
        continue-on-error: true
        run: |
          if command -v osv-scanner &> /dev/null; then
              echo "Running OSV scanner..."
              osv-scanner --recursive governance/ || true
          else
              echo "OSV scanner not installed, skipping"
          fi

  # ===========================================================================
  # Job 7: Deployment Verification (ÈÉ®ÁΩ≤È©óË≠â)
  # ===========================================================================
  deployment-verification:
    name: "7Ô∏è‚É£ Deployment Verification"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - dag-validation
      - policy-execution-check
      - compliance-framework-check
      - event-closure-check
      - tech-debt-tracking
      - security-check

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: pip install pyyaml

      - name: Verify Deployment Artifacts
        run: |
          python3 << 'EOF'
          import json
          import os
          import yaml
          import sys

          print("=" * 60)
          print("üöÄ DEPLOYMENT VERIFICATION")
          print("=" * 60)

          errors = []
          warnings = []

          # Check governance-index.json
          print("\nüìå Governance Index:")
          if os.path.exists('governance/governance-index.json'):
              with open('governance/governance-index.json') as f:
                  index = json.load(f)
              print(f"   Version: {index.get('version', 'N/A')}")
              print(f"   Status: {index.get('metadata', {}).get('status', 'N/A')}")
              
              # Check execution control
              exec_ctrl = index.get('execution_control', {})
              print(f"   Instant deployment: {exec_ctrl.get('instant_deployment', False)}")
              print(f"   Max deployment time: {exec_ctrl.get('max_deployment_time', 'N/A')}")
          else:
              errors.append("governance-index.json not found")

          # Check deploy script
          print("\nüìå Deploy Script:")
          if os.path.exists('governance/deploy-instant.sh'):
              print("   ‚úÖ deploy-instant.sh found")
              # Check if executable
              if os.access('governance/deploy-instant.sh', os.X_OK):
                  print("   ‚úÖ Script is executable")
              else:
                  warnings.append("deploy-instant.sh is not executable")
          else:
              warnings.append("deploy-instant.sh not found")

          # Check CI configurations
          print("\nüìå CI Configurations:")
          ci_configs = ['governance/ci/github-actions.yaml', 'governance/ci/gitlab-ci.yaml', 'governance/ci/argocd-app.yaml']
          for cfg in ci_configs:
              if os.path.exists(cfg):
                  print(f"   ‚úÖ {os.path.basename(cfg)}")
              else:
                  warnings.append(f"{os.path.basename(cfg)} not found")

          # Check governance.yaml
          print("\nüìå Governance Configuration:")
          if os.path.exists('governance/governance.yaml'):
              with open('governance/governance.yaml') as f:
                  gov_config = yaml.safe_load(f)
              print(f"   ‚úÖ governance.yaml found")
              if gov_config:
                  print(f"   Version: {gov_config.get('apiVersion', 'N/A')}")
          else:
              warnings.append("governance.yaml not found")

          # Summary
          print("\n" + "=" * 60)
          print("DEPLOYMENT VERIFICATION SUMMARY")
          print("=" * 60)

          if errors:
              print("\n‚ùå ERRORS:")
              for e in errors:
                  print(f"  - {e}")

          if warnings:
              print("\n‚ö†Ô∏è WARNINGS:")
              for w in warnings:
                  print(f"  - {w}")

          if errors:
              print("\n‚ùå Deployment verification failed!")
              sys.exit(1)
          else:
              print("\n‚úÖ Deployment verification passed!")
              print("   All governance artifacts are ready for deployment.")

          EOF

  # ===========================================================================
  # Summary Job (Ê≤ªÁêÜÈñâÁí∞ CI ÊëòË¶Å)
  # ===========================================================================
  governance-summary:
    name: "üìä Governance CI Summary"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs:
      - dag-validation
      - policy-execution-check
      - compliance-framework-check
      - event-closure-check
      - tech-debt-tracking
      - security-check
      - deployment-verification
    if: always()

    steps:
      - name: Generate Summary
        env:
          DAG_RESULT: ${{ needs.dag-validation.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
          POLICY_RESULT: ${{ needs.policy-execution-check.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
          COMPLIANCE_RESULT: ${{ needs.compliance-framework-check.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
          EVENT_RESULT: ${{ needs.event-closure-check.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
          DEBT_RESULT: ${{ needs.tech-debt-tracking.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
          SECURITY_RESULT: ${{ needs.security-check.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
          DEPLOY_RESULT: ${{ needs.deployment-verification.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
        run: |
          echo "# üéØ Governance Closed-Loop CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1Ô∏è‚É£ DAG Validation | $DAG_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| 2Ô∏è‚É£ Policy Execution | $POLICY_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| 3Ô∏è‚É£ Compliance Framework | $COMPLIANCE_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| 4Ô∏è‚É£ Event Closure | $EVENT_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| 5Ô∏è‚É£ Tech Debt Tracking | $DEBT_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| 6Ô∏è‚É£ Security Check | $SECURITY_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| 7Ô∏è‚É£ Deployment Verification | $DEPLOY_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Generated at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> This workflow consolidates governance-related CI into 7 core checks." >> $GITHUB_STEP_SUMMARY
          echo "> See [CI Refactoring Guide](../../../governance/CI_REFACTORING_GUIDE.md) for details." >> $GITHUB_STEP_SUMMARY
