name: ðŸšª PR Evidence Gate - å¼·åˆ¶åŸ·è¡Œè­‰æ“šé©—è­‰

on:
  pull_request:
    branches: [main, master]
    types: [opened, edited, synchronize, reopened]

env:
  AGENT_CONTRACT_ENFORCEMENT: true
  EVIDENCE_REQUIRED: true
  STRICT_MODE: true

jobs:
  validate-pr-evidence:
    name: ðŸ” é©—è­‰ PR è­‰æ“šå®Œæ•´æ€§
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: é©—è­‰å››å¤§æ ¸å¿ƒè­‰æ“š
        id: validation
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const fs = require('fs');
            const scriptPath = './.github/scripts/validate-pr-evidence.js';

            if (!fs.existsSync(scriptPath)) {
              core.setFailed(`Missing validator script at ${scriptPath}`);
            } else {
              const { validatePREvidence } = require(scriptPath);
              validatePREvidence({ context, core });
            }

      - name: ðŸ“Š é©—è­‰çµæžœè¼¸å‡º
        if: always()
        run: |
          echo "## ðŸš¨ PR é©—è­‰çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é©—è­‰ç‹€æ…‹:** ${{ steps.validation.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validation.outputs.status }}" = "FAIL" ]; then
            echo "### âŒ é©—è­‰å¤±æ•—é …ç›®:" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validation.outputs.missing-items }}" | tr ',' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… é©—è­‰é€šéŽ" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰å››å¤§æ ¸å¿ƒè­‰æ“šéƒ½å·²æä¾›ä¸”æ ¼å¼æ­£ç¢ºã€‚" >> $GITHUB_STEP_SUMMARY
          fi
