name: ğŸšª PR Evidence Gate - å¼·åˆ¶åŸ·è¡Œè­‰æ“šé©—è­‰
true:
  pull_request:
    branches:
    - main
    - master
    types:
    - opened
    - edited
    - synchronize
    - reopened
env:
  AGENT_CONTRACT_ENFORCEMENT: true
  EVIDENCE_REQUIRED: true
  STRICT_MODE: true
jobs:
  validate-pr-evidence:
    name: ğŸ” é©—è­‰ PR è­‰æ“šå®Œæ•´æ€§
    outputs:
      missing-items: ${{ steps.validation.outputs.missing-items }}
      validation-status: ${{ steps.validation.outputs.status }}
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599
        with:
          fetch-depth: 0

      - name: ğŸ” é©—è­‰å››å¤§æ ¸å¿ƒè­‰æ“š
        id: validation
        uses: 60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = (pr && pr.body) ? pr.body : "";
            const errors = [];

            // å…è¨±å¤§å°å¯«ã€å…è¨±æ¬„ä½å‰å¾Œç©ºç™½
            // 1) repo: https://github.com/<owner>/<repo>
            const repoRe = /(^|\n)\s*-\s*repo\s*:\s*https:\/\/github\.com\/[^\/\s]+\/[^\/\s]+(\s|$)/i;

            // 2) branch: <something>
            const branchRe = /(^|\n)\s*-\s*branch\s*:\s*\S+(\s|$)/i;

            // 3) commit (40-char SHA): <40 hex>
            const commitRe = /(^|\n)\s*-\s*commit(?:\s*\(40-char\s*sha\))?\s*:\s*[0-9a-f]{40}(\s|$)/i;

            // 4) PR: https://github.com/<owner>/<repo>/pull/<number>
            const prRe = /(^|\n)\s*-\s*pr\s*:\s*https:\/\/github\.com\/[^\/\s]+\/[^\/\s]+\/pull\/\d+(\s|$)/i;

            if (!repoRe.test(body)) errors.push("ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- repo: https://github.com/<owner>/<repo>");
            if (!branchRe.test(body)) errors.push("ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- branch: <branch-name>");
            if (!commitRe.test(body)) errors.push("ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- commit: <40ä½sha>");
            if (!prRe.test(body)) errors.push("ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- PR: https://github.com/<owner>/<repo>/pull/<number>");

            // æª¢æŸ¥ placeholder
            const placeholders = [
              "<owner>", "<repo>", "<branch-name>", "<paste-full-sha-here>", "<this pr url>", "<number>", "[pr_number]", "[æœ¬ pr ç·¨è™Ÿ]"
            ];
            const lowerBody = body.toLowerCase();
            const badPlaceholders = placeholders.filter(p => lowerBody.includes(p.toLowerCase()));
            if (badPlaceholders.length > 0) {
              errors.push(`PR ä»åŒ…å«æœªæ›¿æ›çš„ placeholderï¼š${badPlaceholders.join(", ")}`);
            }

            if (errors.length > 0) {
              core.setFailed(
                [
                  "PR äº¤ä»˜è­‰æ“š Gate æœªé€šéï¼ˆç¼ºä¸€ä¸å¯ï¼‰ã€‚",
                  "",
                  "è«‹åœ¨ PR æè¿°æœ€ä¸Šæ–¹åŠ å…¥ä»¥ä¸‹å››é …ï¼ˆä¸¦å¡«å…¥çœŸå¯¦å€¼ï¼‰ï¼š",
                  "- repo: https://github.com/MachineNativeOps/MachineNativeOps",
                  "- branch: <branch-name>",
                  "- commit: <40ä½sha>",
                  "- PR: https://github.com/MachineNativeOps/MachineNativeOps/pull/<number>",
                  "",
                  "éŒ¯èª¤æ¸…å–®ï¼š",
                  ...errors.map(e => `- ${e}`),
                ].join("\n")
              );
              core.setOutput('status', 'FAIL');
              core.setOutput('missing-items', errors.join(','));
            } else {
              core.info("âœ… PR äº¤ä»˜è­‰æ“šæ¬„ä½é½Šå…¨ã€‚");
              core.setOutput('status', 'PASS');
              core.setOutput('missing-items', '');
            }

      - name: ğŸ“Š é©—è­‰çµæœè¼¸å‡º
        if: always()
        run: |
          echo "## ğŸš¨ PR é©—è­‰çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é©—è­‰ç‹€æ…‹:** ${{ steps.validation.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validation.outputs.status }}" = "FAIL" ]; then
            echo "### âŒ é©—è­‰å¤±æ•—é …ç›®:" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validation.outputs.missing-items }}" | tr ',' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… é©—è­‰é€šé" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰å››å¤§æ ¸å¿ƒè­‰æ“šéƒ½å·²æä¾›ä¸”æ ¼å¼æ­£ç¢ºã€‚" >> $GITHUB_STEP_SUMMARY
          fi
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
      with:
        fetch-depth: 0
    - id: validation
      name: ğŸ” é©—è­‰å››å¤§æ ¸å¿ƒè­‰æ“š
      uses: 60a0d83039c74a4aee543508d2ffcb1c3799cdea
      with:
        script: "const pr = context.payload.pull_request;\nconst body = (pr && pr.body)\
          \ ? pr.body : \"\";\nconst errors = [];\n\n// å…è¨±å¤§å°å¯«ã€å…è¨±æ¬„ä½å‰å¾Œç©ºç™½\n// 1) repo:\
          \ https://github.com/<owner>/<repo>\nconst repoRe = /(^|\\n)\\s*-\\s*repo\\\
          s*:\\s*https:\\/\\/github\\.com\\/[^\\/\\s]+\\/[^\\/\\s]+(\\s|$)/i;\n\n\
          // 2) branch: <something>\nconst branchRe = /(^|\\n)\\s*-\\s*branch\\s*:\\\
          s*\\S+(\\s|$)/i;\n\n// 3) commit (40-char SHA): <40 hex>\nconst commitRe\
          \ = /(^|\\n)\\s*-\\s*commit(?:\\s*\\(40-char\\s*sha\\))?\\s*:\\s*[0-9a-f]{40}(\\\
          s|$)/i;\n\n// 4) PR: https://github.com/<owner>/<repo>/pull/<number>\nconst\
          \ prRe = /(^|\\n)\\s*-\\s*pr\\s*:\\s*https:\\/\\/github\\.com\\/[^\\/\\\
          s]+\\/[^\\/\\s]+\\/pull\\/\\d+(\\s|$)/i;\n\nif (!repoRe.test(body)) errors.push(\"\
          ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- repo: https://github.com/<owner>/<repo>\");\nif (!branchRe.test(body))\
          \ errors.push(\"ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- branch: <branch-name>\");\nif (!commitRe.test(body))\
          \ errors.push(\"ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- commit: <40ä½sha>\");\nif (!prRe.test(body)) errors.push(\"\
          ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- PR: https://github.com/<owner>/<repo>/pull/<number>\");\n\n//\
          \ æª¢æŸ¥ placeholder\nconst placeholders = [\n  \"<owner>\", \"<repo>\", \"\
          <branch-name>\", \"<paste-full-sha-here>\", \"<this pr url>\", \"<number>\"\
          , \"[pr_number]\", \"[æœ¬ pr ç·¨è™Ÿ]\"\n];\nconst lowerBody = body.toLowerCase();\n\
          const badPlaceholders = placeholders.filter(p => lowerBody.includes(p.toLowerCase()));\n\
          if (badPlaceholders.length > 0) {\n  errors.push(`PR ä»åŒ…å«æœªæ›¿æ›çš„ placeholderï¼š${badPlaceholders.join(\"\
          , \")}`);\n}\n\nif (errors.length > 0) {\n  core.setFailed(\n    [\n   \
          \   \"PR äº¤ä»˜è­‰æ“š Gate æœªé€šéï¼ˆç¼ºä¸€ä¸å¯ï¼‰ã€‚\",\n      \"\",\n      \"è«‹åœ¨ PR æè¿°æœ€ä¸Šæ–¹åŠ å…¥ä»¥ä¸‹å››é …ï¼ˆä¸¦å¡«å…¥çœŸå¯¦å€¼ï¼‰ï¼š\"\
          ,\n      \"- repo: https://github.com/MachineNativeOps/MachineNativeOps\"\
          ,\n      \"- branch: <branch-name>\",\n      \"- commit: <40ä½sha>\",\n \
          \     \"- PR: https://github.com/MachineNativeOps/MachineNativeOps/pull/<number>\"\
          ,\n      \"\",\n      \"éŒ¯èª¤æ¸…å–®ï¼š\",\n      ...errors.map(e => `- ${e}`),\n\
          \    ].join(\"\\n\")\n  );\n  core.setOutput('status', 'FAIL');\n  core.setOutput('missing-items',\
          \ errors.join(','));\n} else {\n  core.info(\"âœ… PR äº¤ä»˜è­‰æ“šæ¬„ä½é½Šå…¨ã€‚\");\n  core.setOutput('status',\
          \ 'PASS');\n  core.setOutput('missing-items', '');\n}\n"
    - if: always()
      name: ğŸ“Š é©—è­‰çµæœè¼¸å‡º
      run: "echo \"## \U0001F6A8 PR é©—è­‰çµæœ\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"**é©—è­‰ç‹€æ…‹:** ${{ steps.validation.outputs.status }}\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\n\nif [ \"${{ steps.validation.outputs.status\
        \ }}\" = \"FAIL\" ]; then\n  echo \"### âŒ é©—è­‰å¤±æ•—é …ç›®:\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"${{ steps.validation.outputs.missing-items }}\" | tr ',' '\\n' |\
        \ sed 's/^/- /' >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"### âœ… é©—è­‰é€šé\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"æ‰€æœ‰å››å¤§æ ¸å¿ƒè­‰æ“šéƒ½å·²æä¾›ä¸”æ ¼å¼æ­£ç¢ºã€‚\" >> $GITHUB_STEP_SUMMARY\nfi"
