name: ğŸšª PR Evidence Gate - å¼·åˆ¶åŸ·è¡Œè­‰æ“šé©—è­‰

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches: [main, master]

env:
  EVIDENCE_REQUIRED: true
  STRICT_MODE: true
  AGENT_CONTRACT_ENFORCEMENT: true

jobs:
  validate-pr-evidence:
    name: ğŸ” é©—è­‰ PR è­‰æ“šå®Œæ•´æ€§
    runs-on: ubuntu-latest
    outputs:
      validation-status: ${{ steps.validation.outputs.status }}
      missing-items: ${{ steps.validation.outputs.missing-items }}

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” é©—è­‰å››å¤§æ ¸å¿ƒè­‰æ“š
        id: validation
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = (pr && pr.body) ? pr.body : "";
            const errors = [];

            // å…è¨±å¤§å°å¯«ã€å…è¨±æ¬„ä½å‰å¾Œç©ºç™½
            // 1) repo: https://github.com/<owner>/<repo>
            const repoRe = /(^|\n)\s*-\s*repo\s*:\s*https:\/\/github\.com\/[^\/\s]+\/[^\/\s]+(\s|$)/i;

            // 2) branch: <something>
            const branchRe = /(^|\n)\s*-\s*branch\s*:\s*\S+(\s|$)/i;

            // 3) commit (40-char SHA): <40 hex>
            const commitRe = /(^|\n)\s*-\s*commit(?:\s*\(40-char\s*sha\))?\s*:\s*[0-9a-f]{40}(\s|$)/i;

            // 4) PR: https://github.com/<owner>/<repo>/pull/<number>
            const prRe = /(^|\n)\s*-\s*pr\s*:\s*https:\/\/github\.com\/[^\/\s]+\/[^\/\s]+\/pull\/\d+(\s|$)/i;

            if (!repoRe.test(body)) errors.push("ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- repo: https://github.com/<owner>/<repo>");
            if (!branchRe.test(body)) errors.push("ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- branch: <branch-name>");
            if (!commitRe.test(body)) errors.push("ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- commit: <40ä½sha>");
            if (!prRe.test(body)) errors.push("ç¼ºå°‘æˆ–æ ¼å¼éŒ¯èª¤ï¼š- PR: https://github.com/<owner>/<repo>/pull/<number>");

            // æª¢æŸ¥ placeholder
            const placeholders = [
              "<owner>", "<repo>", "<branch-name>", "<paste-full-sha-here>", "<this pr url>", "<number>", "[pr_number]", "[æœ¬ pr ç·¨è™Ÿ]"
            ];
            const lowerBody = body.toLowerCase();
            const badPlaceholders = placeholders.filter(p => lowerBody.includes(p.toLowerCase()));
            if (badPlaceholders.length > 0) {
              errors.push(`PR ä»åŒ…å«æœªæ›¿æ›çš„ placeholderï¼š${badPlaceholders.join(", ")}`);
            }

            if (errors.length > 0) {
              core.setFailed(
                [
                  "PR äº¤ä»˜è­‰æ“š Gate æœªé€šéï¼ˆç¼ºä¸€ä¸å¯ï¼‰ã€‚",
                  "",
                  "è«‹åœ¨ PR æè¿°æœ€ä¸Šæ–¹åŠ å…¥ä»¥ä¸‹å››é …ï¼ˆä¸¦å¡«å…¥çœŸå¯¦å€¼ï¼‰ï¼š",
                  "- repo: https://github.com/MachineNativeOps/MachineNativeOps",
                  "- branch: <branch-name>",
                  "- commit: <40ä½sha>",
                  "- PR: https://github.com/MachineNativeOps/MachineNativeOps/pull/<number>",
                  "",
                  "éŒ¯èª¤æ¸…å–®ï¼š",
                  ...errors.map(e => `- ${e}`),
                ].join("\n")
              );
              core.setOutput('status', 'FAIL');
              core.setOutput('missing-items', errors.join(','));
            } else {
              core.info("âœ… PR äº¤ä»˜è­‰æ“šæ¬„ä½é½Šå…¨ã€‚");
              core.setOutput('status', 'PASS');
              core.setOutput('missing-items', '');
            }

      - name: ğŸ“Š é©—è­‰çµæœè¼¸å‡º
        if: always()
        run: |
          echo "## ğŸš¨ PR é©—è­‰çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é©—è­‰ç‹€æ…‹:** ${{ steps.validation.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validation.outputs.status }}" = "FAIL" ]; then
            echo "### âŒ é©—è­‰å¤±æ•—é …ç›®:" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validation.outputs.missing-items }}" | tr ',' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… é©—è­‰é€šé" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰å››å¤§æ ¸å¿ƒè­‰æ“šéƒ½å·²æä¾›ä¸”æ ¼å¼æ­£ç¢ºã€‚" >> $GITHUB_STEP_SUMMARY
          fi