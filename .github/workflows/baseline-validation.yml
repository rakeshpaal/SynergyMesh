name: ♻️ Baseline Validation (Reusable)

on:
  workflow_call:

permissions:
  contents: read

jobs:
  validate:
    name: Baseline validation (docs + root specs)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Verify docs surface
        run: |
          if [ ! -f docs/README.md ]; then
            echo "ERROR: docs/README.md file not found"; exit 1;
          fi

      - name: Verify validator script
        run: |
          if [ ! -f controlplane/baseline/validation/validate-root-specs.py ]; then
            echo "ERROR: validate-root-specs.py script not found at controlplane/baseline/validation/"; exit 1;
          fi

      - name: Run root specification validation
        run: python controlplane/baseline/validation/validate-root-specs.py

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: validation-report
          path: |
            controlplane/overlay/evidence/validation/validation.report.md
            controlplane/overlay/evidence/validation/validation.report.json

      - name: Comment validation result on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'controlplane/overlay/evidence/validation/validation.report.md';
            const SUMMARY_CHAR_LIMIT = 12000;
            let summary = fs.existsSync(reportPath)
              ? fs.readFileSync(reportPath, 'utf8')
              : 'Validation report not found.';
            if (summary.length > SUMMARY_CHAR_LIMIT) {
              summary = `${summary.slice(0, SUMMARY_CHAR_LIMIT)}\n...(truncated, see workflow artifact for full report)`;
            }
            const status = '${{ job.status }}';
            const body = [
              `## Root Specification Validation - ${status.toUpperCase()}`,
              '',
              '詳細報告：',
              '```markdown',
              summary,
              '```',
              '',
              '修復建議：請根據報告中的錯誤訊息調整檔案並重新提交。'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
