# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    è‡ªå‹•æ›´æ–°çŸ¥è­˜åœ–è­œ (Auto-Update Knowledge Graph)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# é€™å€‹ Workflow æœƒåœ¨ main åˆ†æ”¯æœ‰æ–°çš„ commit æ™‚è‡ªå‹•åŸ·è¡Œï¼š
#   1. é‡æ–°ç”¢ç”Ÿ MN-DOC (generated-mndoc.yaml)
#   2. é‡æ–°ç”¢ç”ŸçŸ¥è­˜åœ–è­œ (knowledge-graph.yaml)
#   3. é‡æ–°ç”¢ç”Ÿ SuperRoot å¯¦é«” (superroot-entities.yaml)
#   4. å¦‚æžœæœ‰è®Šæ›´ï¼Œè‡ªå‹• commit å›ž main åˆ†æ”¯
#
# ä½¿ç”¨è€…å®Œå…¨ä¸éœ€è¦ï¼š
#   - è¨˜ä½ä»»ä½•æŒ‡ä»¤
#   - åŸ·è¡Œ make all-kg
#   - æ‰‹å‹• commit ç”Ÿæˆçš„æª”æ¡ˆ
#
# åªè¦æ­£å¸¸ç·¨è¼¯æª”æ¡ˆã€Push åˆ° mainï¼Œæ©Ÿå™¨äººæœƒè‡ªå‹•è™•ç†æ‰€æœ‰äº‹æƒ…ã€‚
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: è‡ªå‹•æ›´æ–°çŸ¥è­˜åœ–è­œ

on:
  push:
    branches:
      - main
    paths:
      - "README.md"
      - "docs/**"
      - "core/**"
      - "config/**"
      - "governance/**"
      - "tools/**"
      - "synergymesh.yaml"
      - "!docs/generated-mndoc.yaml"
      - "!docs/knowledge-graph.yaml"
      - "!docs/superroot-entities.yaml"
  workflow_dispatch: # Allow manual trigger

# Cost protection: prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  auto-update:
    name: è‡ªå‹•ç”¢ç”Ÿä¸¦æäº¤çŸ¥è­˜åœ–è­œ
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Prevent runaway costs

    # é¿å…æ©Ÿå™¨äºº commit è§¸ç™¼ç„¡é™è¿´åœˆ
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'ðŸ¤– è‡ªå‹•æ›´æ–°')"

    steps:
      - name: å–å¾—ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: å®‰è£ Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: å®‰è£ç›¸ä¾å¥—ä»¶
        run: |
          pip install pyyaml

      - name: ç”¢ç”Ÿ MN-DOCï¼ˆå¾ž README.md æŠ½å–æ©Ÿå™¨åŽŸç”Ÿæ–‡æª”ï¼‰
        run: |
          echo "ðŸ“„ æ­£åœ¨ç”¢ç”Ÿ MN-DOC..."
          python tools/docs/generate_mndoc_from_readme.py \
            --readme README.md \
            --output docs/generated-mndoc.yaml

      - name: ç”¢ç”ŸçŸ¥è­˜åœ–è­œï¼ˆæŽƒææ•´å€‹ repo çµæ§‹ï¼‰
        run: |
          echo "ðŸ”— æ­£åœ¨ç”¢ç”ŸçŸ¥è­˜åœ–è­œ..."
          python tools/docs/generate_knowledge_graph.py \
            --repo-root . \
            --output docs/knowledge-graph.yaml

      - name: ç”¢ç”Ÿ SuperRoot å¯¦é«”ï¼ˆæ˜ å°„åˆ°æ²»ç†æ¡†æž¶ï¼‰
        run: |
          echo "ðŸ—ï¸ æ­£åœ¨ç”¢ç”Ÿ SuperRoot å¯¦é«”..."
          python tools/docs/project_to_superroot.py \
            --kg docs/knowledge-graph.yaml \
            --output docs/superroot-entities.yaml

      - name: æª¢æŸ¥ä¸¦è‡ªå‹•æäº¤è®Šæ›´
        run: |
          # è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
          git config user.name "unmanned-island-bot"
          git config user.email "bot@unmanned-island.system"

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if git diff --quiet docs/generated-mndoc.yaml docs/knowledge-graph.yaml docs/superroot-entities.yaml 2>/dev/null; then
            echo "âœ… æ²’æœ‰éœ€è¦æ›´æ–°çš„å…§å®¹ï¼ŒçŸ¥è­˜åœ–è­œå·²æ˜¯æœ€æ–°ç‹€æ…‹"
            exit 0
          fi

          # é¡¯ç¤ºè®Šæ›´æ‘˜è¦
          echo "ðŸ“Š åµæ¸¬åˆ°ä»¥ä¸‹æª”æ¡ˆæœ‰è®Šæ›´ï¼š"
          git diff --stat docs/generated-mndoc.yaml docs/knowledge-graph.yaml docs/superroot-entities.yaml 2>/dev/null || true

          # å–å¾—çµ±è¨ˆè³‡è¨Š
          NODES=$(grep -oP 'total_nodes:\s*\K\d+' docs/knowledge-graph.yaml 2>/dev/null || echo "N/A")
          EDGES=$(grep -oP 'total_edges:\s*\K\d+' docs/knowledge-graph.yaml 2>/dev/null || echo "N/A")
          ENTITIES=$(grep -oP 'total_entities:\s*\K\d+' docs/superroot-entities.yaml 2>/dev/null || echo "N/A")

          # åŠ å…¥è®Šæ›´ä¸¦æäº¤
          git add docs/generated-mndoc.yaml docs/knowledge-graph.yaml docs/superroot-entities.yaml

          git commit -m "ðŸ¤– è‡ªå‹•æ›´æ–°çŸ¥è­˜åœ–è­œ

          - ç¯€é»žæ•¸: ${NODES}
          - é—œä¿‚æ•¸: ${EDGES}
          - å¯¦é«”æ•¸: ${ENTITIES}

          æ­¤ commit ç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿã€‚
          è§¸ç™¼ä¾†æº: ${{ github.event.head_commit.message }}"

          # æŽ¨é€è®Šæ›´
          git push

          echo "âœ… å·²è‡ªå‹•æäº¤ä¸¦æŽ¨é€çŸ¥è­˜åœ–è­œæ›´æ–°"

      - name: è¼¸å‡ºåŸ·è¡Œæ‘˜è¦
        run: |
          echo "## ðŸ¤– è‡ªå‹•æ›´æ–°çŸ¥è­˜åœ–è­œå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ç”¢ç”Ÿçš„æª”æ¡ˆ" >> $GITHUB_STEP_SUMMARY
          echo "| æª”æ¡ˆ | èªªæ˜Ž |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`docs/generated-mndoc.yaml\` | å¾ž README.md æŠ½å–çš„æ©Ÿå™¨åŽŸç”Ÿæ–‡æª” |" >> $GITHUB_STEP_SUMMARY
          echo "| \`docs/knowledge-graph.yaml\` | æ•´å€‹ repo çš„çŸ¥è­˜åœ–è­œ |" >> $GITHUB_STEP_SUMMARY
          echo "| \`docs/superroot-entities.yaml\` | SuperRoot æ²»ç†æ¡†æž¶å¯¦é«” |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "docs/knowledge-graph.yaml" ]; then
            echo "### çŸ¥è­˜åœ–è­œçµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
            echo '```yaml' >> $GITHUB_STEP_SUMMARY
            grep -A 10 "statistics:" docs/knowledge-graph.yaml >> $GITHUB_STEP_SUMMARY || echo "ç„¡çµ±è¨ˆè³‡è¨Š"
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **ä½¿ç”¨èªªæ˜Ž**ï¼šä½ ä¸éœ€è¦æ‰‹å‹•åŸ·è¡Œä»»ä½•æŒ‡ä»¤ï¼" >> $GITHUB_STEP_SUMMARY
          echo "åªè¦æ­£å¸¸ç·¨è¼¯æª”æ¡ˆä¸¦æŽ¨é€åˆ° main åˆ†æ”¯ï¼Œæ©Ÿå™¨äººæœƒè‡ªå‹•æ›´æ–°çŸ¥è­˜åœ–è­œã€‚" >> $GITHUB_STEP_SUMMARY
