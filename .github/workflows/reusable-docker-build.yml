---
name: Reusable Docker Build & Test

on:
  workflow_call:
    inputs:
      service-name:
        description: "Service name for identification"
        required: true
        type: string
      context:
        description: "Build context directory"
        required: true
        type: string
      dockerfile:
        description: "Path to Dockerfile"
        required: true
        type: string
      health-check-url:
        description: "Health check URL (optional, e.g. http://localhost:3000/healthz)"
        required: false
        type: string
        default: ""
      health-check-port:
        description: "Container port for health check"
        required: false
        type: string
        default: "3000"
      enable-security-scan:
        description: "Enable container security scanning"
        required: false
        type: boolean
        default: true
      push-image:
        description: "Push image to registry"
        required: false
        type: boolean
        default: false
      image-tags:
        description: "Comma-separated list of image tags"
        required: false
        type: string
        default: ""
    outputs:
      image-id:
        description: "Built image ID"
        value: ${{ jobs.docker-build.outputs.image_id }}
      image-digest:
        description: "Built image digest"
        value: ${{ jobs.docker-build.outputs.image_digest }}
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false

# Cost protection: prevent concurrent runs
concurrency:
  group: docker-build-${{ inputs.service-name }}-${{ github.ref }}
  cancel-in-progress: true

# Reusable workflow permissions are inherited from the caller
# See: https://docs.github.com/en/actions/using-workflows/reusing-workflows#supported-keywords-for-jobs-that-call-a-reusable-workflow
permissions:
  contents: read
  packages: write # For pushing to container registry

jobs:
  docker-build:
    timeout-minutes: 20
    runs-on: ubuntu-latest
    outputs:
      image_id: ${{ steps.build.outputs.imageid }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3.7.1

      - name: ðŸ” Log in to Container Registry
        if: inputs.push-image == true
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ secrets.REGISTRY_USERNAME || github.actor }}
          password: ${{ secrets.REGISTRY_PASSWORD || secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Generate image tags
        id: meta
        run: |
          service="${{ inputs.service-name }}"
          sha_short="${GITHUB_SHA::7}"

          if [ -n "${{ inputs.image-tags }}" ]; then
            tags="${{ inputs.image-tags }}"
          else
            tags="ghcr.io/${{ github.repository }}/${service}:${sha_short}"
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              tags="${tags},ghcr.io/${{ github.repository }}/${service}:latest"
            fi
          fi

          echo "tags=${tags}" >> $GITHUB_OUTPUT

      - name: ðŸ—ï¸ Build Docker image
        id: build
        uses: docker/build-push-action@48aba3b46d1b1fec4febb7c5d0c644b249a11355 # v6.10.0
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          push: ${{ inputs.push-image }}
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: ${{ inputs.push-image == false }}

      - name: ðŸ§ª Test Docker image
        if: inputs.health-check-url != '' && inputs.push-image == false
        env:
          SERVICE_NAME: ${{ inputs.service-name }}
          HEALTH_PORT: ${{ inputs.health-check-port }}
          HEALTH_URL: ${{ inputs.health-check-url }}
          IMAGE_TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          echo "ðŸ§ª Testing Docker image..."

          service_name="$SERVICE_NAME"
          port="$HEALTH_PORT"
          health_url="$HEALTH_URL"

          # Extract first tag for testing
          first_tag=$(echo "$IMAGE_TAGS" | cut -d',' -f1)

          # Start container
          container_id=$(docker run --rm -d --name "test-${service_name}" -p "${port}:${port}" "${first_tag}")
          echo "Started container: ${container_id}"

          # Health check with retry
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -sf "${health_url}" > /dev/null 2>&1; then
              echo "âœ… ${service_name} health check passed"
              docker stop "${container_id}"
              exit 0
            fi
            attempt=$((attempt + 1))
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ ${service_name} health check failed after ${max_attempts} attempts"
              echo "Container logs:"
              docker logs "${container_id}"
              docker stop "${container_id}"
              exit 1
            fi
            echo "Waiting for ${service_name} to be ready... ($attempt/$max_attempts)"
            sleep 2
          done

      - name: ðŸ”’ Run security scan
        if: inputs.enable-security-scan == true && inputs.push-image == false
        env:
          IMAGE_TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          echo "ðŸ”’ Running container security scan..."

          # Extract first tag for scanning
          first_tag=$(echo "$IMAGE_TAGS" | cut -d',' -f1)

          # Use Trivy for security scanning
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image --severity HIGH,CRITICAL \
            --exit-code 0 "${first_tag}" || echo "âš ï¸ Security vulnerabilities detected"

      - name: ðŸ“Š Build summary
        env:
          SERVICE_NAME: ${{ inputs.service-name }}
          BUILD_CONTEXT: ${{ inputs.context }}
          IMAGE_TAGS: ${{ steps.meta.outputs.tags }}
          PUSH_IMAGE: ${{ inputs.push-image }}
        run: |
          echo "## ðŸ³ Docker Build Complete: $SERVICE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Image built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Context: \`$BUILD_CONTEXT\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ Tags: \`$IMAGE_TAGS\`" >> $GITHUB_STEP_SUMMARY
          if [ "$PUSH_IMAGE" == "true" ]; then
            echo "- ðŸ“¤ Pushed to registry: âœ…" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ“¤ Pushed to registry: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ inputs.health-check-url }}" ]; then
            echo "- ðŸ§ª Health check: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.enable-security-scan }}" == "true" ]; then
            echo "- ðŸ”’ Security scan: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          fi
