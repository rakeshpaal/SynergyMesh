name: project-self-awareness

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
  workflow_dispatch:

# Cost protection: prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  self-awareness-report:
    timeout-minutes: 10 # Prevent runaway costs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install workspace dependencies
        run: npm install --workspaces --include-workspace-root

      - name: Install island-ai dependencies
        working-directory: island-ai
        run: npm install

      - name: Generate report
        run: |
          mkdir -p reports
          python3 automation/self_awareness_report.py \
            --output reports/self-awareness.md \
            --json-output reports/self-awareness.json \
            --lint-cmd "npm run lint --workspaces --if-present" \
            --test-cmd "npm test --workspaces --if-present" \
            --automation-cmd "Island AI Lint=cd island-ai && npm run lint" \
            --automation-cmd "Audit=npm audit --workspaces --include-workspace-root" \
            --max-log-lines 10 \
            --fail-on-errors

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: self-awareness-report
          path: |
            reports/self-awareness.md
            reports/self-awareness.json

      - name: Comment on pull request
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('reports/self-awareness.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
