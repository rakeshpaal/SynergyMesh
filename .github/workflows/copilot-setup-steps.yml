---
name: "Copilot Setup Steps"

# æ­¤ workflow ç”¨æ–¼é…ç½® GitHub Copilot Coding Agent çš„é–‹ç™¼ç’°å¢ƒ
# åƒè€ƒæ–‡æª”ï¼šhttps://docs.github.com/en/copilot/customizing-copilot/customizing-the-development-environment-for-copilot-coding-agent

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # Job åç¨±å¿…é ˆæ˜¯ copilot-setup-steps
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # æœ€å°æ¬Šé™åŸå‰‡ï¼Œåªçµ¦å®‰è£ä¾è³´æ‰€éœ€çš„ read
    permissions:
      contents: read

    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout repository (with Git LFS enabled)
        uses: actions/checkout@v4
        with:
          # è‹¥æœ‰ä½¿ç”¨ Git LFSï¼Œé€™ä¸€è¡Œæœƒå¹«ä½ æŠ“ LFS ç‰©ä»¶
          lfs: true

      # ===== Node.js / TypeScript ç’°å¢ƒ =====
      - name: ğŸ” Detect package manager
        id: detect-pm
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> "$GITHUB_OUTPUT"
          elif [ -f package-lock.json ]; then
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> "$GITHUB_OUTPUT"
          else
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ”§ Set up Node.js
        uses: actions/setup-node@v4
        with:
          # ä¾å°ˆæ¡ˆ engines è¦æ±‚ (>=18.0.0)ï¼Œä½¿ç”¨ Node 20
          node-version: "20"
          # æ ¹æ“šåµæ¸¬åˆ°çš„å¥—ä»¶ç®¡ç†å™¨è¨­å®šå¿«å–
          cache: ${{ steps.detect-pm.outputs.manager }}

      - name: ğŸ” Show detected package manager
        run: |
          echo "ğŸ“¦ åµæ¸¬åˆ°å¥—ä»¶ç®¡ç†å™¨: ${{ steps.detect-pm.outputs.manager }}"

      - name: ğŸ“¦ Install Node.js dependencies
        run: |
          case "${{ steps.detect-pm.outputs.manager }}" in
            pnpm)
              corepack enable
              pnpm install --frozen-lockfile
              ;;
            yarn)
              yarn install --frozen-lockfile
              ;;
            npm)
              npm ci
              ;;
          esac

      # ===== Python ç’°å¢ƒï¼ˆæ”¯æ´å°ˆæ¡ˆä¸­çš„ Python è…³æœ¬ï¼‰=====
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Python dependencies if requirements.txt exists
        run: |
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          fi

      # ===== Shell å·¥å…·å®‰è£ =====
      - name: ğŸ› ï¸ Install additional CLI tools
        run: |
          sudo apt-get update -y
          # å®‰è£å¸¸ç”¨ CLI å·¥å…·
          sudo apt-get install -y jq

      # ===== å¿«é€Ÿé©—è­‰é—œéµå·¥å…·æ˜¯å¦å¯ç”¨ =====
      - name: âœ… Verify toolchain availability
        run: |
          echo "ğŸ” æª¢æŸ¥å·¥å…·éˆ..."
          echo "Node.js: $(node -v)"
          echo "npm: $(npm -v)"
          echo "Python: $(python -V)"
          echo "jq: $(jq --version)"
          echo "âœ… ç’°å¢ƒæº–å‚™å®Œæˆ"
