name: ğŸš€ CI Pipeline
true:
  pull_request:
    branches:
    - main
    - develop
    types:
    - opened
    - synchronize
    - reopened
  push:
    branches:
    - main
    - develop
concurrency:
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
  group: ${{ github.workflow }}-${{ github.ref }}
permissions:
  checks: write
  contents: read
  packages: write
  pull-requests: write
env:
  DOCKER_REGISTRY: ghcr.io
  GO_VERSION: '1.21'
  IMAGE_NAME: machinenativeops
  JAVA_VERSION: '17'
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
jobs:
  # =============================================================================
  # ä»£ç¢¼å“è³ªæª¢æŸ¥
  # =============================================================================
  code-quality:
    name: "ğŸ” Code Quality Analysis"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599
        with:
          fetch-depth: 0

      - name: "è¨­ç½® Python ç’°å¢ƒ"
        uses: 82c7e631bb3cdc910f68e0081d534527d238d7a7
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: "è¨­ç½® Node.js ç’°å¢ƒ"
        uses: 1e60f620b9541d16bece96c5465dc8ee9832be0b
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "å®‰è£ä»£ç¢¼å“è³ªå·¥å…·"
        run: |
          pip install --user pylint black flake8 mypy bandit safety
          npm install -g eslint prettier @typescript-eslint/parser
          
      - name: "Python ä»£ç¢¼æª¢æŸ¥"
        run: |
          echo "ğŸ” åŸ·è¡Œ Python ä»£ç¢¼å“è³ªæª¢æŸ¥..."
          find . -name "*.py" -type f ! -path "*/node_modules/*" ! -path "*/.git/*" > python_files.txt
          
          if [ -s python_files.txt ]; then
            echo "ğŸ“Š ç™¼ç¾ $(wc -l < python_files.txt) å€‹ Python æ–‡ä»¶"
            
            # Pylint æª¢æŸ¥
            echo "ğŸ” åŸ·è¡Œ Pylint æª¢æŸ¥..."
            pylint --disable=C0114,C0115,C0116 --score=no $(cat python_files.txt) || true
            
            # Black æ ¼å¼æª¢æŸ¥
            echo "ğŸ¨ æª¢æŸ¥ä»£ç¢¼æ ¼å¼..."
            black --check --diff $(cat python_files.txt) || echo "âš ï¸ Black æª¢æŸ¥ç™¼ç¾æ ¼å¼å•é¡Œ"
            
            # Flake8 æª¢æŸ¥
            echo "ğŸ” åŸ·è¡Œ Flake8 æª¢æŸ¥..."
            flake8 --max-line-length=100 --ignore=E203,W503 $(cat python_files.txt) || true
            
            # MyPy é¡å‹æª¢æŸ¥
            echo "ğŸ” åŸ·è¡Œ MyPy é¡å‹æª¢æŸ¥..."
            mypy --ignore-missing-imports --no-strict-optional $(cat python_files.txt) || true
          else
            echo "â„¹ï¸ æœªç™¼ç¾ Python æ–‡ä»¶"
          fi

      - name: "JavaScript/TypeScript ä»£ç¢¼æª¢æŸ¥"
        run: |
          echo "ğŸ” åŸ·è¡Œ JavaScript/TypeScript ä»£ç¢¼å“è³ªæª¢æŸ¥..."
          find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | grep -v node_modules > js_files.txt
          
          if [ -s js_files.txt ]; then
            echo "ğŸ“Š ç™¼ç¾ $(wc -l < js_files.txt) å€‹ JS/TS æ–‡ä»¶"
            
            # ESLint æª¢æŸ¥
            echo "ğŸ” åŸ·è¡Œ ESLint æª¢æŸ¥..."
            eslint $(cat js_files.txt) || echo "âš ï¸ ESLint æª¢æŸ¥ç™¼ç¾å•é¡Œ"
            
            # Prettier æ ¼å¼æª¢æŸ¥
            echo "ğŸ¨ æª¢æŸ¥ä»£ç¢¼æ ¼å¼..."
            prettier --check $(cat js_files.txt) || echo "âš ï¸ Prettier æª¢æŸ¥ç™¼ç¾æ ¼å¼å•é¡Œ"
          else
            echo "â„¹ï¸ æœªç™¼ç¾ JavaScript/TypeScript æ–‡ä»¶"
          fi

      - name: "ç”Ÿæˆä»£ç¢¼å“è³ªå ±å‘Š"
        run: |
          echo "# ğŸ“Š Code Quality Report" > code-quality-report.md
          echo "" >> code-quality-report.md
          echo "**æª¢æŸ¥æ™‚é–“**: $(date)" >> code-quality-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> code-quality-report.md
          echo "" >> code-quality-report.md
          
          # çµ±è¨ˆæ–‡ä»¶æ•¸é‡
          PY_COUNT=$(find . -name "*.py" -type f ! -path "*/node_modules/*" | wc -l)
          JS_COUNT=$(find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | grep -v node_modules | wc -l)
          
          echo "## ğŸ“ˆ ä»£ç¢¼çµ±è¨ˆ" >> code-quality-report.md
          echo "- Python æ–‡ä»¶: $PY_COUNT" >> code-quality-report.md
          echo "- JavaScript/TypeScript æ–‡ä»¶: $JS_COUNT" >> code-quality-report.md
          echo "" >> code-quality-report.md
          
          echo "## ğŸ” æª¢æŸ¥çµæœ" >> code-quality-report.md
          echo "âœ… ä»£ç¢¼å“è³ªæª¢æŸ¥å·²å®Œæˆ" >> code-quality-report.md
          
          cat code-quality-report.md

      - name: "ä¸Šå‚³å“è³ªå ±å‘Š"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: code-quality-report
          path: code-quality-report.md
          retention-days: 30

  # =============================================================================
  # å®‰å…¨æ¼æ´æƒæ
  # =============================================================================
  security-scan:
    name: "ğŸ”’ Security Vulnerability Scan"
  ci-summary:
    if: always()
    name: ğŸ“‹ CI Summary Report
    needs:
    - code-quality
    - security-scan
    - unit-tests
    - integration-tests
    runs-on: ubuntu-latest
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: "è¨­ç½® Python ç’°å¢ƒ"
        uses: 82c7e631bb3cdc910f68e0081d534527d238d7a7
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "å®‰è£å®‰å…¨æƒæå·¥å…·"
        run: |
          pip install --user safety bandit semgrep
          npm install -g audit-ci snyk

      - name: "Python ä¾è³´å®‰å…¨æƒæ"
        run: |
          echo "ğŸ”’ æƒæ Python ä¾è³´æ¼æ´..."
          find . -name "requirements.txt" -o -name "setup.py" -o -name "pyproject.toml" | grep -v node_modules > requirements_files.txt
          
          if [ -s requirements_files.txt ]; then
            for req_file in $(cat requirements_files.txt); do
              echo "ğŸ“‹ æª¢æŸ¥æ–‡ä»¶: $req_file"
              if [ -f "$req_file" ]; then
                safety check -r "$req_file" --json --output safety-report.json || echo "âš ï¸ Safety ç™¼ç¾æ½›åœ¨å•é¡Œ"
              fi
            done
          else
            echo "â„¹ï¸ æœªç™¼ç¾ Python ä¾è³´æ–‡ä»¶"
          fi

      - name: "Python ä»£ç¢¼å®‰å…¨æƒæ"
        run: |
          echo "ğŸ” åŸ·è¡Œ Bandit å®‰å…¨æƒæ..."
          find . -name "*.py" -type f ! -path "*/node_modules/*" ! -path "*/.git/*" > python_files.txt
          
          if [ -s python_files.txt ]; then
            bandit -r $(dirname $(head -1 python_files.txt)) -f json -o bandit-report.json || echo "âš ï¸ Bandit ç™¼ç¾æ½›åœ¨å®‰å…¨å•é¡Œ"
          fi

      - name: "Semgrep ä»£ç¢¼åˆ†æ"
        run: |
          echo "ğŸ” åŸ·è¡Œ Semgrep ä»£ç¢¼åˆ†æ..."
          semgrep --config=auto --json --output=semgrep-report.json . || echo "âš ï¸ Semgrep åˆ†æå®Œæˆ"

      - name: "Node.js ä¾è³´å®‰å…¨æƒæ"
        run: |
          echo "ğŸ”’ æƒæ Node.js ä¾è³´æ¼æ´..."
          find . -name "package.json" | grep -v node_modules > package_files.txt
          
          if [ -s package_files.txt ]; then
            for pkg_file in $(cat package_files.txt); do
              pkg_dir=$(dirname "$pkg_file")
              echo "ğŸ“‹ æª¢æŸ¥ç›®éŒ„: $pkg_dir"
              cd "$pkg_dir"
              npm audit --audit-level moderate --json > ../npm-audit-report.json || echo "âš ï¸ npm audit ç™¼ç¾å•é¡Œ"
              cd - > /dev/null
            done
          else
            echo "â„¹ï¸ æœªç™¼ç¾ Node.js ä¾è³´æ–‡ä»¶"
          fi

      - name: "ç”Ÿæˆå®‰å…¨å ±å‘Š"
        run: |
          echo "# ğŸ”’ Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "**æƒææ™‚é–“**: $(date)" >> security-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          
          echo "## ğŸ›¡ï¸ å®‰å…¨æƒæçµæœ" >> security-report.md
          echo "âœ… å®‰å…¨æƒæå·²å®Œæˆ" >> security-report.md
          echo "" >> security-report.md
          
          echo "### ğŸ“‹ æƒæé …ç›®" >> security-report.md
          echo "- Python ä¾è³´æ¼æ´æƒæ (Safety)" >> security-report.md
          echo "- Python ä»£ç¢¼å®‰å…¨æƒæ (Bandit)" >> security-report.md
          echo "- ä»£ç¢¼éœæ…‹åˆ†æ (Semgrep)" >> security-report.md
          echo "- Node.js ä¾è³´æƒæ (npm audit)" >> security-report.md
          
          cat security-report.md

      - name: "ä¸Šå‚³å®‰å…¨å ±å‘Š"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: security-scan-report
          path: |
            security-report.md
            safety-report.json
            bandit-report.json
            semgrep-report.json
            npm-audit-report.json
          retention-days: 30

  # =============================================================================
  # å–®å…ƒæ¸¬è©¦
  # =============================================================================
  unit-tests:
    name: "ğŸ§ª Unit Tests"
    - name: ä¸‹è¼‰æ‰€æœ‰å ±å‘Š
      uses: 6b208ae046db98c579e8a328f74b955651f427c0
      with:
        merge-multiple: true
    - name: ç”ŸæˆCIç¸½çµå ±å‘Š
      run: "echo \"# \U0001F680 CI Pipeline Summary Report\" > ci-summary-report.md\n\
        echo \"\" >> ci-summary-report.md\necho \"**ç”Ÿæˆæ™‚é–“**: $(date)\" >> ci-summary-report.md\n\
        echo \"**åˆ†æ”¯**: ${{ github.ref_name }}\" >> ci-summary-report.md\necho \"**æäº¤**:\
        \ ${{ github.sha }}\" >> ci-summary-report.md\necho \"**PR**: #${{ github.event.pull_request.number\
        \ || 'N/A' }}\" >> ci-summary-report.md\necho \"\" >> ci-summary-report.md\n\
        \necho \"## \U0001F4CA Pipeline ç‹€æ…‹\" >> ci-summary-report.md\necho \"- \U0001F50D\
        \ ä»£ç¢¼å“è³ªæª¢æŸ¥: ${{ needs.code-quality.result }}\" >> ci-summary-report.md\necho\
        \ \"- \U0001F512 å®‰å…¨æƒæ: ${{ needs.security-scan.result }}\" >> ci-summary-report.md\n\
        echo \"- \U0001F9EA å–®å…ƒæ¸¬è©¦: ${{ needs.unit-tests.result }}\" >> ci-summary-report.md\n\
        echo \"- \U0001F517 é›†æˆæ¸¬è©¦: ${{ needs.integration-tests.result }}\" >> ci-summary-report.md\n\
        echo \"\" >> ci-summary-report.md\n\n# åˆ¤æ–·æ•´é«”ç‹€æ…‹\nif [ \"${{ needs.code-quality.result\
        \ }}\" = \"success\" ] && \\\n   [ \"${{ needs.security-scan.result }}\" =\
        \ \"success\" ] && \\\n   [ \"${{ needs.unit-tests.result }}\" = \"success\"\
        \ ] && \\\n   [ \"${{ needs.integration-tests.result }}\" = \"success\" ];\
        \ then\n  echo \"## âœ… æ•´é«”ç‹€æ…‹: é€šé\" >> ci-summary-report.md\n  echo \"\U0001F389\
        \ æ‰€æœ‰ CI æª¢æŸ¥éƒ½å·²é€šéï¼\" >> ci-summary-report.md\nelse\n  echo \"## âŒ æ•´é«”ç‹€æ…‹: å¤±æ•—\"\
        \ >> ci-summary-report.md\n  echo \"âš ï¸ éƒ¨åˆ† CI æª¢æŸ¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹è©³ç´°å ±å‘Šã€‚\" >> ci-summary-report.md\n\
        fi\n\necho \"\" >> ci-summary-report.md\necho \"## \U0001F4CB è©³ç´°å ±å‘Š\" >> ci-summary-report.md\n\
        echo \"- [ä»£ç¢¼å“è³ªå ±å‘Š](code-quality-report.md)\" >> ci-summary-report.md\necho\
        \ \"- [å®‰å…¨æƒæå ±å‘Š](security-report.md)\" >> ci-summary-report.md\necho \"- [å–®å…ƒæ¸¬è©¦å ±å‘Š](test-report.md)\"\
        \ >> ci-summary-report.md\necho \"- [é›†æˆæ¸¬è©¦å ±å‘Š](integration-test-report.md)\"\
        \ >> ci-summary-report.md\n\ncat ci-summary-report.md\n"
    - if: failure() && github.event_name == 'pull_request'
      name: è©•è«–PRï¼ˆå¦‚æœæœ‰å¤±æ•—ï¼‰
      uses: 60a0d83039c74a4aee543508d2ffcb1c3799cdea
      with:
        script: "const fs = require('fs');\n\nif (fs.existsSync('ci-summary-report.md'))\
          \ {\n  const report = fs.readFileSync('ci-summary-report.md', 'utf8');\n\
          \  \n  github.rest.issues.createComment({\n    issue_number: context.issue.number,\n\
          \    owner: context.repo.owner,\n    repo: context.repo.repo,\n    body:\
          \ report\n  });\n}\n"
    - name: ä¸Šå‚³ç¸½çµå ±å‘Š
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: ci-summary-report
        path: ci-summary-report.md
        retention-days: 30
  code-quality:
    name: ğŸ” Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: "è¨­ç½® Python ${{ matrix.python-version }}"
        uses: 82c7e631bb3cdc910f68e0081d534527d238d7a7
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: "å®‰è£æ¸¬è©¦ä¾è³´"
        run: |
          pip install --user pytest pytest-cov pytest-xdist pytest-mock coverage

      - name: "åŸ·è¡Œå–®å…ƒæ¸¬è©¦"
        run: |
          echo "ğŸ§ª åŸ·è¡Œ Python å–®å…ƒæ¸¬è©¦..."
          
          # æŸ¥æ‰¾æ¸¬è©¦æ–‡ä»¶
          find . -name "test_*.py" -o -name "*_test.py" ! -path "*/node_modules/*" > test_files.txt
          
          if [ -s test_files.txt ]; then
            echo "ğŸ“Š ç™¼ç¾ $(wc -l < test_files.txt) å€‹æ¸¬è©¦æ–‡ä»¶"
            
            # åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
            pytest \
              --verbose \
              --tb=short \
              --cov=. \
              --cov-report=xml \
              --cov-report=html \
              --cov-report=term-missing \
              --junit-xml=test-results.xml \
              $(dirname $(head -1 test_files.txt)) || echo "âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—"
          else
            echo "â„¹ï¸ æœªç™¼ç¾æ¸¬è©¦æ–‡ä»¶"
          fi

      - name: "ç”Ÿæˆæ¸¬è©¦å ±å‘Š"
        if: always()
        run: |
          echo "# ğŸ§ª Unit Test Report" > test-report.md
          echo "" >> test-report.md
          echo "**æ¸¬è©¦æ™‚é–“**: $(date)" >> test-report.md
          echo "**Python ç‰ˆæœ¬**: ${{ matrix.python-version }}" >> test-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> test-report.md
          echo "" >> test-report.md
          
          if [ -f "test-results.xml" ]; then
            echo "## ğŸ“Š æ¸¬è©¦çµ±è¨ˆ" >> test-report.md
            # è§£æ JUnit XML çµ±è¨ˆä¿¡æ¯
            TESTS=$(grep -o 'tests="[0-9]*"' test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            FAILURES=$(grep -o 'failures="[0-9]*"' test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            ERRORS=$(grep -o 'errors="[0-9]*"' test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            
            echo "- ç¸½æ¸¬è©¦æ•¸: $TESTS" >> test-report.md
            echo "- å¤±æ•—æ•¸: $FAILURES" >> test-report.md
            echo "- éŒ¯èª¤æ•¸: $ERRORS" >> test-report.md
            
            if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
              echo "- ç‹€æ…‹: âœ… å…¨éƒ¨é€šé" >> test-report.md
            else
              echo "- ç‹€æ…‹: âŒ éƒ¨åˆ†å¤±æ•—" >> test-report.md
            fi
          else
            echo "â„¹ï¸ æœªç”Ÿæˆæ¸¬è©¦çµæœæ–‡ä»¶" >> test-report.md
          fi
          
          cat test-report.md

      - name: "ä¸Šå‚³æ¸¬è©¦å ±å‘Š"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            test-report.md
            test-results.xml
            htmlcov/
            coverage.xml
          retention-days: 30

  # =============================================================================
  # é›†æˆæ¸¬è©¦
  # =============================================================================
    - name: æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
      with:
        fetch-depth: 0
    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: 82c7e631bb3cdc910f68e0081d534527d238d7a7
      with:
        cache: pip
        python-version: ${{ env.PYTHON_VERSION }}
    - name: è¨­ç½® Node.js ç’°å¢ƒ
      uses: 1e60f620b9541d16bece96c5465dc8ee9832be0b
      with:
        cache: npm
        node-version: ${{ env.NODE_VERSION }}
    - name: å®‰è£ä»£ç¢¼å“è³ªå·¥å…·
      run: 'pip install --user pylint black flake8 mypy bandit safety

        npm install -g eslint prettier @typescript-eslint/parser

        '
    - name: Python ä»£ç¢¼æª¢æŸ¥
      run: "echo \"\U0001F50D åŸ·è¡Œ Python ä»£ç¢¼å“è³ªæª¢æŸ¥...\"\nfind . -name \"*.py\" -type f\
        \ ! -path \"*/node_modules/*\" ! -path \"*/.git/*\" > python_files.txt\n\n\
        if [ -s python_files.txt ]; then\n  echo \"\U0001F4CA ç™¼ç¾ $(wc -l < python_files.txt)\
        \ å€‹ Python æ–‡ä»¶\"\n  \n  # Pylint æª¢æŸ¥\n  echo \"\U0001F50D åŸ·è¡Œ Pylint æª¢æŸ¥...\"\n\
        \  pylint --disable=C0114,C0115,C0116 --score=no $(cat python_files.txt) ||\
        \ true\n  \n  # Black æ ¼å¼æª¢æŸ¥\n  echo \"\U0001F3A8 æª¢æŸ¥ä»£ç¢¼æ ¼å¼...\"\n  black --check\
        \ --diff $(cat python_files.txt) || echo \"âš ï¸ Black æª¢æŸ¥ç™¼ç¾æ ¼å¼å•é¡Œ\"\n  \n  # Flake8\
        \ æª¢æŸ¥\n  echo \"\U0001F50D åŸ·è¡Œ Flake8 æª¢æŸ¥...\"\n  flake8 --max-line-length=100\
        \ --ignore=E203,W503 $(cat python_files.txt) || true\n  \n  # MyPy é¡å‹æª¢æŸ¥\n\
        \  echo \"\U0001F50D åŸ·è¡Œ MyPy é¡å‹æª¢æŸ¥...\"\n  mypy --ignore-missing-imports --no-strict-optional\
        \ $(cat python_files.txt) || true\nelse\n  echo \"â„¹ï¸ æœªç™¼ç¾ Python æ–‡ä»¶\"\nfi\n"
    - name: JavaScript/TypeScript ä»£ç¢¼æª¢æŸ¥
      run: "echo \"\U0001F50D åŸ·è¡Œ JavaScript/TypeScript ä»£ç¢¼å“è³ªæª¢æŸ¥...\"\nfind . -name \"\
        *.js\" -o -name \"*.ts\" -o -name \"*.jsx\" -o -name \"*.tsx\" | grep -v node_modules\
        \ > js_files.txt\n\nif [ -s js_files.txt ]; then\n  echo \"\U0001F4CA ç™¼ç¾ $(wc\
        \ -l < js_files.txt) å€‹ JS/TS æ–‡ä»¶\"\n  \n  # ESLint æª¢æŸ¥\n  echo \"\U0001F50D\
        \ åŸ·è¡Œ ESLint æª¢æŸ¥...\"\n  eslint $(cat js_files.txt) || echo \"âš ï¸ ESLint æª¢æŸ¥ç™¼ç¾å•é¡Œ\"\
        \n  \n  # Prettier æ ¼å¼æª¢æŸ¥\n  echo \"\U0001F3A8 æª¢æŸ¥ä»£ç¢¼æ ¼å¼...\"\n  prettier --check\
        \ $(cat js_files.txt) || echo \"âš ï¸ Prettier æª¢æŸ¥ç™¼ç¾æ ¼å¼å•é¡Œ\"\nelse\n  echo \"â„¹ï¸\
        \ æœªç™¼ç¾ JavaScript/TypeScript æ–‡ä»¶\"\nfi\n"
    - name: ç”Ÿæˆä»£ç¢¼å“è³ªå ±å‘Š
      run: 'echo "# ğŸ“Š Code Quality Report" > code-quality-report.md

        echo "" >> code-quality-report.md

        echo "**æª¢æŸ¥æ™‚é–“**: $(date)" >> code-quality-report.md

        echo "**æäº¤**: ${{ github.sha }}" >> code-quality-report.md

        echo "" >> code-quality-report.md


        # çµ±è¨ˆæ–‡ä»¶æ•¸é‡

        PY_COUNT=$(find . -name "*.py" -type f ! -path "*/node_modules/*" | wc -l)

        JS_COUNT=$(find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx"
        | grep -v node_modules | wc -l)


        echo "## ğŸ“ˆ ä»£ç¢¼çµ±è¨ˆ" >> code-quality-report.md

        echo "- Python æ–‡ä»¶: $PY_COUNT" >> code-quality-report.md

        echo "- JavaScript/TypeScript æ–‡ä»¶: $JS_COUNT" >> code-quality-report.md

        echo "" >> code-quality-report.md


        echo "## ğŸ” æª¢æŸ¥çµæœ" >> code-quality-report.md

        echo "âœ… ä»£ç¢¼å“è³ªæª¢æŸ¥å·²å®Œæˆ" >> code-quality-report.md


        cat code-quality-report.md

        '
    - name: ä¸Šå‚³å“è³ªå ±å‘Š
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: code-quality-report
        path: code-quality-report.md
        retention-days: 30
    timeout-minutes: 20
  integration-tests:
    name: ğŸ”— Integration Tests
    needs:
    - code-quality
    - security-scan
    runs-on: ubuntu-latest
    services:
      postgres:
        env:
          POSTGRES_DB: testdb
          POSTGRES_PASSWORD: testpass
        image: postgres:15
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s
          --health-retries 5
        ports:
        - 5432:5432
      redis:
        image: redis:7
        options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout
          5s --health-retries 5
        ports:
        - 6379:6379
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: "è¨­ç½® Python ç’°å¢ƒ"
        uses: 82c7e631bb3cdc910f68e0081d534527d238d7a7
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "å®‰è£é›†æˆæ¸¬è©¦ä¾è³´"
        run: |
          pip install --user pytest docker-compose requests

      - name: "åŸ·è¡Œé›†æˆæ¸¬è©¦"
        run: |
          echo "ğŸ”— åŸ·è¡Œé›†æˆæ¸¬è©¦..."
          
          # è¨­ç½®æ¸¬è©¦ç’°å¢ƒè®Šé‡
          export DATABASE_URL="postgresql://postgres:testpass@localhost:5432/testdb"
          export REDIS_URL="redis://localhost:6379"
          export TEST_ENV="integration"
          
          # æŸ¥æ‰¾é›†æˆæ¸¬è©¦æ–‡ä»¶
          find . -name "*integration*" -name "test_*.py" -o -name "*integration*" -name "*_test.py" > integration_test_files.txt
          
          if [ -s integration_test_files.txt ]; then
            echo "ğŸ“Š ç™¼ç¾ $(wc -l < integration_test_files.txt) å€‹é›†æˆæ¸¬è©¦æ–‡ä»¶"
            
            # åŸ·è¡Œé›†æˆæ¸¬è©¦
            pytest \
              --verbose \
              --tb=short \
              --junit-xml=integration-test-results.xml \
              $(dirname $(head -1 integration_test_files.txt)) || echo "âš ï¸ éƒ¨åˆ†é›†æˆæ¸¬è©¦å¤±æ•—"
          else
            echo "â„¹ï¸ æœªç™¼ç¾é›†æˆæ¸¬è©¦æ–‡ä»¶"
          fi

      - name: "ç”Ÿæˆé›†æˆæ¸¬è©¦å ±å‘Š"
        if: always()
        run: |
          echo "# ğŸ”— Integration Test Report" > integration-test-report.md
          echo "" >> integration-test-report.md
          echo "**æ¸¬è©¦æ™‚é–“**: $(date)" >> integration-test-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> integration-test-report.md
          echo "" >> integration-test-report.md
          
          if [ -f "integration-test-results.xml" ]; then
            echo "## ğŸ”— é›†æˆæ¸¬è©¦çµ±è¨ˆ" >> integration-test-report.md
            # è§£æ JUnit XML çµ±è¨ˆä¿¡æ¯
            TESTS=$(grep -o 'tests="[0-9]*"' integration-test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            FAILURES=$(grep -o 'failures="[0-9]*"' integration-test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            ERRORS=$(grep -o 'errors="[0-9]*"' integration-test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            
            echo "- ç¸½æ¸¬è©¦æ•¸: $TESTS" >> integration-test-report.md
            echo "- å¤±æ•—æ•¸: $FAILURES" >> integration-test-report.md
            echo "- éŒ¯èª¤æ•¸: $ERRORS" >> integration-test-report.md
            
            if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
              echo "- ç‹€æ…‹: âœ… å…¨éƒ¨é€šé" >> integration-test-report.md
            else
              echo "- ç‹€æ…‹: âŒ éƒ¨åˆ†å¤±æ•—" >> integration-test-report.md
            fi
          else
            echo "â„¹ï¸ æœªç”Ÿæˆé›†æˆæ¸¬è©¦çµæœæ–‡ä»¶" >> integration-test-report.md
          fi
          
          cat integration-test-report.md

      - name: "ä¸Šå‚³é›†æˆæ¸¬è©¦å ±å‘Š"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        if: always()
        with:
          name: integration-test-results
          path: |
            integration-test-report.md
            integration-test-results.xml
          retention-days: 30

  # =============================================================================
  # CI ç¸½çµå ±å‘Š
  # =============================================================================
  ci-summary:
    name: "ğŸ“‹ CI Summary Report"
    - name: æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: 82c7e631bb3cdc910f68e0081d534527d238d7a7
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: å®‰è£é›†æˆæ¸¬è©¦ä¾è³´
      run: 'pip install --user pytest docker-compose requests

        '
    - name: åŸ·è¡Œé›†æˆæ¸¬è©¦
      run: "echo \"\U0001F517 åŸ·è¡Œé›†æˆæ¸¬è©¦...\"\n\n# è¨­ç½®æ¸¬è©¦ç’°å¢ƒè®Šé‡\nexport DATABASE_URL=\"postgresql://postgres:testpass@localhost:5432/testdb\"\
        \nexport REDIS_URL=\"redis://localhost:6379\"\nexport TEST_ENV=\"integration\"\
        \n\n# æŸ¥æ‰¾é›†æˆæ¸¬è©¦æ–‡ä»¶\nfind . -name \"*integration*\" -name \"test_*.py\" -o -name\
        \ \"*integration*\" -name \"*_test.py\" > integration_test_files.txt\n\nif\
        \ [ -s integration_test_files.txt ]; then\n  echo \"\U0001F4CA ç™¼ç¾ $(wc -l\
        \ < integration_test_files.txt) å€‹é›†æˆæ¸¬è©¦æ–‡ä»¶\"\n  \n  # åŸ·è¡Œé›†æˆæ¸¬è©¦\n  pytest \\\n \
        \   --verbose \\\n    --tb=short \\\n    --junit-xml=integration-test-results.xml\
        \ \\\n    $(dirname $(head -1 integration_test_files.txt)) || echo \"âš ï¸ éƒ¨åˆ†é›†æˆæ¸¬è©¦å¤±æ•—\"\
        \nelse\n  echo \"â„¹ï¸ æœªç™¼ç¾é›†æˆæ¸¬è©¦æ–‡ä»¶\"\nfi\n"
    - if: always()
      name: ç”Ÿæˆé›†æˆæ¸¬è©¦å ±å‘Š
      run: "echo \"# \U0001F517 Integration Test Report\" > integration-test-report.md\n\
        echo \"\" >> integration-test-report.md\necho \"**æ¸¬è©¦æ™‚é–“**: $(date)\" >> integration-test-report.md\n\
        echo \"**æäº¤**: ${{ github.sha }}\" >> integration-test-report.md\necho \"\"\
        \ >> integration-test-report.md\n\nif [ -f \"integration-test-results.xml\"\
        \ ]; then\n  echo \"## \U0001F517 é›†æˆæ¸¬è©¦çµ±è¨ˆ\" >> integration-test-report.md\n\
        \  # è§£æ JUnit XML çµ±è¨ˆä¿¡æ¯\n  TESTS=$(grep -o 'tests=\"[0-9]*\"' integration-test-results.xml\
        \ | head -1 | cut -d'\"' -f2 || echo \"0\")\n  FAILURES=$(grep -o 'failures=\"\
        [0-9]*\"' integration-test-results.xml | head -1 | cut -d'\"' -f2 || echo\
        \ \"0\")\n  ERRORS=$(grep -o 'errors=\"[0-9]*\"' integration-test-results.xml\
        \ | head -1 | cut -d'\"' -f2 || echo \"0\")\n  \n  echo \"- ç¸½æ¸¬è©¦æ•¸: $TESTS\"\
        \ >> integration-test-report.md\n  echo \"- å¤±æ•—æ•¸: $FAILURES\" >> integration-test-report.md\n\
        \  echo \"- éŒ¯èª¤æ•¸: $ERRORS\" >> integration-test-report.md\n  \n  if [ \"$FAILURES\"\
        \ = \"0\" ] && [ \"$ERRORS\" = \"0\" ]; then\n    echo \"- ç‹€æ…‹: âœ… å…¨éƒ¨é€šé\" >>\
        \ integration-test-report.md\n  else\n    echo \"- ç‹€æ…‹: âŒ éƒ¨åˆ†å¤±æ•—\" >> integration-test-report.md\n\
        \  fi\nelse\n  echo \"â„¹ï¸ æœªç”Ÿæˆé›†æˆæ¸¬è©¦çµæœæ–‡ä»¶\" >> integration-test-report.md\nfi\n\
        \ncat integration-test-report.md\n"
    - if: always()
      name: ä¸Šå‚³é›†æˆæ¸¬è©¦å ±å‘Š
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: integration-test-results
        path: 'integration-test-report.md

          integration-test-results.xml

          '
        retention-days: 30
    timeout-minutes: 45
  security-scan:
    name: ğŸ”’ Security Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: 82c7e631bb3cdc910f68e0081d534527d238d7a7
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: å®‰è£å®‰å…¨æƒæå·¥å…·
      run: 'pip install --user safety bandit semgrep

        npm install -g audit-ci snyk

        '
    - name: Python ä¾è³´å®‰å…¨æƒæ
      run: "echo \"\U0001F512 æƒæ Python ä¾è³´æ¼æ´...\"\nfind . -name \"requirements.txt\"\
        \ -o -name \"setup.py\" -o -name \"pyproject.toml\" | grep -v node_modules\
        \ > requirements_files.txt\n\nif [ -s requirements_files.txt ]; then\n  for\
        \ req_file in $(cat requirements_files.txt); do\n    echo \"\U0001F4CB æª¢æŸ¥æ–‡ä»¶:\
        \ $req_file\"\n    if [ -f \"$req_file\" ]; then\n      safety check -r \"\
        $req_file\" --json --output safety-report.json || echo \"âš ï¸ Safety ç™¼ç¾æ½›åœ¨å•é¡Œ\"\
        \n    fi\n  done\nelse\n  echo \"â„¹ï¸ æœªç™¼ç¾ Python ä¾è³´æ–‡ä»¶\"\nfi\n"
    - name: Python ä»£ç¢¼å®‰å…¨æƒæ
      run: "echo \"\U0001F50D åŸ·è¡Œ Bandit å®‰å…¨æƒæ...\"\nfind . -name \"*.py\" -type f !\
        \ -path \"*/node_modules/*\" ! -path \"*/.git/*\" > python_files.txt\n\nif\
        \ [ -s python_files.txt ]; then\n  bandit -r $(dirname $(head -1 python_files.txt))\
        \ -f json -o bandit-report.json || echo \"âš ï¸ Bandit ç™¼ç¾æ½›åœ¨å®‰å…¨å•é¡Œ\"\nfi\n"
    - name: Semgrep ä»£ç¢¼åˆ†æ
      run: 'echo "ğŸ” åŸ·è¡Œ Semgrep ä»£ç¢¼åˆ†æ..."

        semgrep --config=auto --json --output=semgrep-report.json . || echo "âš ï¸ Semgrep
        åˆ†æå®Œæˆ"

        '
    - name: Node.js ä¾è³´å®‰å…¨æƒæ
      run: "echo \"\U0001F512 æƒæ Node.js ä¾è³´æ¼æ´...\"\nfind . -name \"package.json\"\
        \ | grep -v node_modules > package_files.txt\n\nif [ -s package_files.txt\
        \ ]; then\n  for pkg_file in $(cat package_files.txt); do\n    pkg_dir=$(dirname\
        \ \"$pkg_file\")\n    echo \"\U0001F4CB æª¢æŸ¥ç›®éŒ„: $pkg_dir\"\n    cd \"$pkg_dir\"\
        \n    npm audit --audit-level moderate --json > ../npm-audit-report.json ||\
        \ echo \"âš ï¸ npm audit ç™¼ç¾å•é¡Œ\"\n    cd - > /dev/null\n  done\nelse\n  echo \"\
        â„¹ï¸ æœªç™¼ç¾ Node.js ä¾è³´æ–‡ä»¶\"\nfi\n"
    - name: ç”Ÿæˆå®‰å…¨å ±å‘Š
      run: 'echo "# ğŸ”’ Security Scan Report" > security-report.md

        echo "" >> security-report.md

        echo "**æƒææ™‚é–“**: $(date)" >> security-report.md

        echo "**æäº¤**: ${{ github.sha }}" >> security-report.md

        echo "" >> security-report.md


        echo "## ğŸ›¡ï¸ å®‰å…¨æƒæçµæœ" >> security-report.md

        echo "âœ… å®‰å…¨æƒæå·²å®Œæˆ" >> security-report.md

        echo "" >> security-report.md


        echo "### ğŸ“‹ æƒæé …ç›®" >> security-report.md

        echo "- Python ä¾è³´æ¼æ´æƒæ (Safety)" >> security-report.md

        echo "- Python ä»£ç¢¼å®‰å…¨æƒæ (Bandit)" >> security-report.md

        echo "- ä»£ç¢¼éœæ…‹åˆ†æ (Semgrep)" >> security-report.md

        echo "- Node.js ä¾è³´æƒæ (npm audit)" >> security-report.md


        cat security-report.md

        '
    - name: ä¸Šå‚³å®‰å…¨å ±å‘Š
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: security-scan-report
        path: 'security-report.md

          safety-report.json

          bandit-report.json

          semgrep-report.json

          npm-audit-report.json

          '
        retention-days: 30
    timeout-minutes: 15
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: "ä¸‹è¼‰æ‰€æœ‰å ±å‘Š"
        uses: 6b208ae046db98c579e8a328f74b955651f427c0
        with:
          merge-multiple: true

      - name: "ç”ŸæˆCIç¸½çµå ±å‘Š"
        run: |
          echo "# ğŸš€ CI Pipeline Summary Report" > ci-summary-report.md
          echo "" >> ci-summary-report.md
          echo "**ç”Ÿæˆæ™‚é–“**: $(date)" >> ci-summary-report.md
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> ci-summary-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> ci-summary-report.md
          echo "**PR**: #${{ github.event.pull_request.number || 'N/A' }}" >> ci-summary-report.md
          echo "" >> ci-summary-report.md
          
          echo "## ğŸ“Š Pipeline ç‹€æ…‹" >> ci-summary-report.md
          echo "- ğŸ” ä»£ç¢¼å“è³ªæª¢æŸ¥: ${{ needs.code-quality.result }}" >> ci-summary-report.md
          echo "- ğŸ”’ å®‰å…¨æƒæ: ${{ needs.security-scan.result }}" >> ci-summary-report.md
          echo "- ğŸ§ª å–®å…ƒæ¸¬è©¦: ${{ needs.unit-tests.result }}" >> ci-summary-report.md
          echo "- ğŸ”— é›†æˆæ¸¬è©¦: ${{ needs.integration-tests.result }}" >> ci-summary-report.md
          echo "" >> ci-summary-report.md
          
          # åˆ¤æ–·æ•´é«”ç‹€æ…‹
          if [ "${{ needs.code-quality.result }}" = "success" ] && \
             [ "${{ needs.security-scan.result }}" = "success" ] && \
             [ "${{ needs.unit-tests.result }}" = "success" ] && \
             [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "## âœ… æ•´é«”ç‹€æ…‹: é€šé" >> ci-summary-report.md
            echo "ğŸ‰ æ‰€æœ‰ CI æª¢æŸ¥éƒ½å·²é€šéï¼" >> ci-summary-report.md
          else
            echo "## âŒ æ•´é«”ç‹€æ…‹: å¤±æ•—" >> ci-summary-report.md
            echo "âš ï¸ éƒ¨åˆ† CI æª¢æŸ¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹è©³ç´°å ±å‘Šã€‚" >> ci-summary-report.md
          fi
          
          echo "" >> ci-summary-report.md
          echo "## ğŸ“‹ è©³ç´°å ±å‘Š" >> ci-summary-report.md
          echo "- [ä»£ç¢¼å“è³ªå ±å‘Š](code-quality-report.md)" >> ci-summary-report.md
          echo "- [å®‰å…¨æƒæå ±å‘Š](security-report.md)" >> ci-summary-report.md
          echo "- [å–®å…ƒæ¸¬è©¦å ±å‘Š](test-report.md)" >> ci-summary-report.md
          echo "- [é›†æˆæ¸¬è©¦å ±å‘Š](integration-test-report.md)" >> ci-summary-report.md
          
          cat ci-summary-report.md

      - name: "è©•è«–PRï¼ˆå¦‚æœæœ‰å¤±æ•—ï¼‰"
        if: failure() && github.event_name == 'pull_request'
        uses: 60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const fs = require('fs');
            
            if (fs.existsSync('ci-summary-report.md')) {
              const report = fs.readFileSync('ci-summary-report.md', 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

      - name: "ä¸Šå‚³ç¸½çµå ±å‘Š"
        uses: 65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: ci-summary-report
          path: ci-summary-report.md
          retention-days: 30
    - name: æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: è¨­ç½® Python ${{ matrix.python-version }}
      uses: 82c7e631bb3cdc910f68e0081d534527d238d7a7
      with:
        cache: pip
        python-version: ${{ matrix.python-version }}
    - name: å®‰è£æ¸¬è©¦ä¾è³´
      run: 'pip install --user pytest pytest-cov pytest-xdist pytest-mock coverage

        '
    - name: åŸ·è¡Œå–®å…ƒæ¸¬è©¦
      run: "echo \"\U0001F9EA åŸ·è¡Œ Python å–®å…ƒæ¸¬è©¦...\"\n\n# æŸ¥æ‰¾æ¸¬è©¦æ–‡ä»¶\nfind . -name \"test_*.py\"\
        \ -o -name \"*_test.py\" ! -path \"*/node_modules/*\" > test_files.txt\n\n\
        if [ -s test_files.txt ]; then\n  echo \"\U0001F4CA ç™¼ç¾ $(wc -l < test_files.txt)\
        \ å€‹æ¸¬è©¦æ–‡ä»¶\"\n  \n  # åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š\n  pytest \\\n    --verbose \\\n    --tb=short\
        \ \\\n    --cov=. \\\n    --cov-report=xml \\\n    --cov-report=html \\\n\
        \    --cov-report=term-missing \\\n    --junit-xml=test-results.xml \\\n \
        \   $(dirname $(head -1 test_files.txt)) || echo \"âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—\"\nelse\n  echo\
        \ \"â„¹ï¸ æœªç™¼ç¾æ¸¬è©¦æ–‡ä»¶\"\nfi\n"
    - if: always()
      name: ç”Ÿæˆæ¸¬è©¦å ±å‘Š
      run: "echo \"# \U0001F9EA Unit Test Report\" > test-report.md\necho \"\" >>\
        \ test-report.md\necho \"**æ¸¬è©¦æ™‚é–“**: $(date)\" >> test-report.md\necho \"**Python\
        \ ç‰ˆæœ¬**: ${{ matrix.python-version }}\" >> test-report.md\necho \"**æäº¤**: ${{\
        \ github.sha }}\" >> test-report.md\necho \"\" >> test-report.md\n\nif [ -f\
        \ \"test-results.xml\" ]; then\n  echo \"## \U0001F4CA æ¸¬è©¦çµ±è¨ˆ\" >> test-report.md\n\
        \  # è§£æ JUnit XML çµ±è¨ˆä¿¡æ¯\n  TESTS=$(grep -o 'tests=\"[0-9]*\"' test-results.xml\
        \ | head -1 | cut -d'\"' -f2 || echo \"0\")\n  FAILURES=$(grep -o 'failures=\"\
        [0-9]*\"' test-results.xml | head -1 | cut -d'\"' -f2 || echo \"0\")\n  ERRORS=$(grep\
        \ -o 'errors=\"[0-9]*\"' test-results.xml | head -1 | cut -d'\"' -f2 || echo\
        \ \"0\")\n  \n  echo \"- ç¸½æ¸¬è©¦æ•¸: $TESTS\" >> test-report.md\n  echo \"- å¤±æ•—æ•¸:\
        \ $FAILURES\" >> test-report.md\n  echo \"- éŒ¯èª¤æ•¸: $ERRORS\" >> test-report.md\n\
        \  \n  if [ \"$FAILURES\" = \"0\" ] && [ \"$ERRORS\" = \"0\" ]; then\n   \
        \ echo \"- ç‹€æ…‹: âœ… å…¨éƒ¨é€šé\" >> test-report.md\n  else\n    echo \"- ç‹€æ…‹: âŒ éƒ¨åˆ†å¤±æ•—\"\
        \ >> test-report.md\n  fi\nelse\n  echo \"â„¹ï¸ æœªç”Ÿæˆæ¸¬è©¦çµæœæ–‡ä»¶\" >> test-report.md\n\
        fi\n\ncat test-report.md\n"
    - if: always()
      name: ä¸Šå‚³æ¸¬è©¦å ±å‘Š
      uses: 65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: test-results-${{ matrix.python-version }}
        path: 'test-report.md

          test-results.xml

          htmlcov/

          coverage.xml

          '
        retention-days: 30
    strategy:
      matrix:
        python-version:
        - '3.9'
        - '3.11'
        - '3.12'
    timeout-minutes: 30
