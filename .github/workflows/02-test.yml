name: 02-test

on:
  pull_request:
    branches: [main]

# Cost protection: prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Workflow status check - always runs to prevent startup_failure
  workflow-status:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Workflow validation
        run: echo "Test workflow triggered successfully"

  # 檢測需要執行哪些測試
  detect-changes:
    timeout-minutes: 10 # Prevent runaway costs
    runs-on: ubuntu-latest
    outputs:
      typescript: ${{ steps.filter.outputs.typescript }}
      rust: ${{ steps.filter.outputs.rust }}
      go: ${{ steps.filter.outputs.go }}
      python: ${{ steps.filter.outputs.python }}
      java: ${{ steps.filter.outputs.java }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            typescript:
              - 'package.json'
              - '**/*.ts'
              - '**/*.tsx'
              - '**/*.js'
              - '.github/workflows/02-test.yml'
            rust:
              - 'core/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - '.github/workflows/02-test.yml'
            go:
              - 'services/**/*.go'
              - 'go.work'
              - 'go.mod'
              - '.github/workflows/02-test.yml'
            python:
              - '**/*.py'
              - 'pyproject.toml'
              - 'requirements.txt'
              - '.github/workflows/02-test.yml'
            java:
              - 'integrations/**/*.java'
              - 'pom.xml'
              - '.github/workflows/02-test.yml'

  typescript-tests:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.typescript == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Fail-fast: prevent runaway tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
      - run: npm install
      - run: npm run test --workspaces --if-present

  rust-tests:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.rust == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Fail-fast: prevent runaway tests
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo test --workspace --all-features

  go-tests:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.go == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Fail-fast: prevent runaway tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.21"
      - run: go test ./...
        working-directory: services

  python-tests:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.python == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Fail-fast: prevent runaway tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install pytest
        run: |
          set -e  # Fail-fast on errors
          pip install -r requirements.txt || pip install pytest
      - name: Run pytest
        run: |
          set -e  # Fail-fast: test failures must block PR
          pytest

  java-tests:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.java == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Fail-fast: prevent runaway tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin
          cache: maven
      - run: mvn test
