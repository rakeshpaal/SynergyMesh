name: Deploy to Cloudflare
permissions:
  contents: read
true:
  pull_request:
    branches:
    - main
    paths:
    - cloudflare/**
    - wrangler.toml
  push:
    branches:
    - main
    - staging
    paths:
    - cloudflare/**
    - wrangler.toml
    - .github/workflows/deploy-cloudflare.yml
    - src/frontend/**
    - src/web/**
  workflow_dispatch:
    inputs:
      deploy_pages:
        default: true
        description: Deploy Pages
        required: true
        type: boolean
      deploy_workers:
        default: true
        description: Deploy Workers
        required: true
        type: boolean
      environment:
        default: staging
        description: Deployment environment
        options:
        - development
        - staging
        - production
        required: true
        type: choice
concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}
env:
  NODE_VERSION: '20'
  WRANGLER_VERSION: 3.95.0
jobs:
  configure-webhook:
    if: needs.pre-check.outputs.environment == 'production' && github.event_name ==
      'push'
    name: Configure GitHub Webhook
    needs:
    - pre-check
    - deploy-workers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599
        with:
          fetch-depth: 0
    - env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      name: Configure GitHub Webhook
      run: 'echo "## GitHub Webhook Configuration" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "To complete the GitHub integration, configure a webhook in your repository:"
        >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

    steps:
      - name: Checkout repository
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: Setup Node.js
        uses: 1e60f620b9541d16bece96c5465dc8ee9832be0b
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: cloudflare/workers/package-lock.json
        echo "1. Go to **Repository Settings > Webhooks > Add webhook**" >> $GITHUB_STEP_SUMMARY

        echo "2. **Payload URL:** \`https://api.machinenativeops.com/webhooks/github\`"
        >> $GITHUB_STEP_SUMMARY

        echo "3. **Content type:** \`application/json\`" >> $GITHUB_STEP_SUMMARY

        echo "4. **Secret:** Use the value from \`GITHUB_WEBHOOK_SECRET\`" >> $GITHUB_STEP_SUMMARY

        echo "5. **Events:** Select individual events or ''Send me everything''" >>
        $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
      - name: Lint
        working-directory: cloudflare/workers
        run: npm run lint

        echo "Recommended events:" >> $GITHUB_STEP_SUMMARY

    steps:
      - name: Checkout repository
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: Setup Node.js
        uses: 1e60f620b9541d16bece96c5465dc8ee9832be0b
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: cloudflare/workers/package-lock.json
        echo "- Push" >> $GITHUB_STEP_SUMMARY

        echo "- Pull requests" >> $GITHUB_STEP_SUMMARY

        echo "- Issues" >> $GITHUB_STEP_SUMMARY

        echo "- Workflow runs" >> $GITHUB_STEP_SUMMARY

        echo "- Releases" >> $GITHUB_STEP_SUMMARY

        '
          if [[ "$DEPLOY_ENV" == "production" ]]; then
            wrangler deploy --env production
            echo "url=https://api.machinenativeops.com" >> $GITHUB_OUTPUT
          elif [[ "$DEPLOY_ENV" == "staging" ]]; then
            wrangler deploy --env staging
            echo "url=https://staging-api.machinenativeops.com" >> $GITHUB_OUTPUT
          else
            wrangler deploy --env development
            echo "url=https://dev.machinenativeops.workers.dev" >> $GITHUB_OUTPUT
          fi

      - name: Set Worker Secrets
        if: needs.pre-check.outputs.environment == 'production' || needs.pre-check.outputs.environment == 'staging'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          ENV="${{ needs.pre-check.outputs.environment }}"
          
          # Set GitHub token for API access
          if [ -n "${{ secrets.WORKER_GITHUB_TOKEN }}" ]; then
            echo "${{ secrets.WORKER_GITHUB_TOKEN }}" | wrangler secret put GITHUB_TOKEN --env "$ENV"
          else
            echo "Warning: WORKER_GITHUB_TOKEN not set" >&2
          fi

          # Set GitHub webhook secret (mandatory for production/staging)
          if [ -n "${{ secrets.GITHUB_WEBHOOK_SECRET }}" ]; then
            echo "${{ secrets.GITHUB_WEBHOOK_SECRET }}" | wrangler secret put GITHUB_WEBHOOK_SECRET --env "$ENV"
          else
            echo "Error: GITHUB_WEBHOOK_SECRET is required for $ENV" >&2
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo "## Workers Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ needs.pre-check.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Deploy Cloudflare Pages
  # ============================================================================
  deploy-pages:
    environment:
      name: cloudflare-pages-${{ needs.pre-check.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    if: '(needs.pre-check.outputs.should_deploy_pages == ''true'' || github.event_name
      == ''workflow_dispatch'') &&

    steps:
      - name: Checkout repository
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: Setup Node.js
        uses: 1e60f620b9541d16bece96c5465dc8ee9832be0b
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: ${{ needs.pre-check.outputs.environment == 'production' && 'https://api.machinenativeops.com' || 'https://staging-api.machinenativeops.com' }}

      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=machinenativeops --branch=${{ github.ref_name }}
      (github.event_name != ''workflow_dispatch'' || inputs.deploy_pages)

      '
    name: Deploy Pages
    needs: pre-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: Install Wrangler
        run: npm install -g wrangler@${{ env.WRANGLER_VERSION }}

    - name: Checkout repository
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: Setup Node.js
      uses: 1e60f620b9541d16bece96c5465dc8ee9832be0b
      with:
        cache: npm
        node-version: ${{ env.NODE_VERSION }}
    - name: Install dependencies
      run: npm ci
    - env:
        NEXT_PUBLIC_API_URL: ${{ needs.pre-check.outputs.environment == 'production'
          && 'https://api.machinenativeops.com' || 'https://staging-api.machinenativeops.com'
          }}
        NODE_ENV: production
      name: Build frontend
      run: npm run build
    - id: deploy
      name: Deploy to Cloudflare Pages
      uses: cloudflare/wrangler-action@v3
      with:
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        command: pages deploy dist --project-name=machinenativeops --branch=${{ github.ref_name
          }}
    - name: Deployment Summary
      run: 'echo "## Pages Deployment Complete" >> $GITHUB_STEP_SUMMARY

        echo "- **Environment:** ${{ needs.pre-check.outputs.environment }}" >> $GITHUB_STEP_SUMMARY

        echo "- **URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY

        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
      - name: Create/Verify KV Namespaces
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # List existing namespaces
          echo "Existing KV Namespaces:"
          wrangler kv:namespace list
          
          # Check and create CACHE namespace if needed
          if ! wrangler kv:namespace list | grep -q "CACHE"; then
            echo "Creating CACHE namespace..."
            wrangler kv:namespace create "CACHE"
          else
            echo "CACHE namespace already exists"
          fi
          
          # Check and create SESSIONS namespace if needed
          if ! wrangler kv:namespace list | grep -q "SESSIONS"; then
            echo "Creating SESSIONS namespace..."
            wrangler kv:namespace create "SESSIONS"
          else
            echo "SESSIONS namespace already exists"
          fi

  # ============================================================================
  # Setup D1 Database
  # ============================================================================
  setup-d1:
    name: Setup D1 Database
    runs-on: ubuntu-latest
    needs: [pre-check, deploy-workers]
    if: needs.pre-check.outputs.environment == 'production' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599
        '
  deploy-workers:
    environment:
      name: cloudflare-${{ needs.pre-check.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    if: '(needs.pre-check.outputs.should_deploy_workers == ''true'' || github.event_name
      == ''workflow_dispatch'') &&

      (github.event_name != ''workflow_dispatch'' || inputs.deploy_workers)

      '
    name: Deploy Workers
    needs:
    - pre-check
    - lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: Setup Node.js
      uses: 1e60f620b9541d16bece96c5465dc8ee9832be0b
      with:
        cache: npm
        cache-dependency-path: cloudflare/workers/package-lock.json
        node-version: ${{ env.NODE_VERSION }}
    - name: Install dependencies
      run: npm ci
      working-directory: cloudflare/workers
    - name: Install Wrangler
      run: npm install -g wrangler@${{ env.WRANGLER_VERSION }}
    - env:
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      id: deploy
      name: Deploy Worker
      run: "DEPLOY_ENV=\"${{ needs.pre-check.outputs.environment }}\"\n\nif [[ \"\
        $DEPLOY_ENV\" == \"production\" ]]; then\n  wrangler deploy --env production\n\
        \  echo \"url=https://api.machinenativeops.com\" >> $GITHUB_OUTPUT\nelif [[\
        \ \"$DEPLOY_ENV\" == \"staging\" ]]; then\n  wrangler deploy --env staging\n\
        \  echo \"url=https://staging-api.machinenativeops.com\" >> $GITHUB_OUTPUT\n\
        else\n  wrangler deploy --env development\n  echo \"url=https://dev.machinenativeops.workers.dev\"\
        \ >> $GITHUB_OUTPUT\nfi\n"
      working-directory: .
    - env:
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      if: needs.pre-check.outputs.environment == 'production'
      name: Set Worker Secrets
      run: '# Set GitHub token for API access

        echo "${{ secrets.WORKER_GITHUB_TOKEN }}" | wrangler secret put GITHUB_TOKEN
        --env production || true


        # Set GitHub webhook secret
      - name: Create/Verify D1 Database
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # List existing databases
          echo "Existing D1 Databases:"
          wrangler d1 list
          
          # Check and create database if needed
          if ! wrangler d1 list | grep -q "machinenativeops-prod"; then
            echo "Creating D1 database..."
            wrangler d1 create machinenativeops-prod
          else
            echo "Database already exists"
          fi

        echo "${{ secrets.GITHUB_WEBHOOK_SECRET }}" | wrangler secret put GITHUB_WEBHOOK_SECRET
        --env production || true

        '
    - name: Deployment Summary
      run: 'echo "## Workers Deployment Complete" >> $GITHUB_STEP_SUMMARY

        echo "- **Environment:** ${{ needs.pre-check.outputs.environment }}" >> $GITHUB_STEP_SUMMARY

        echo "- **URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY

        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

        '
  lint:
    if: needs.pre-check.outputs.should_deploy_workers == 'true' || github.event_name
      == 'workflow_dispatch'
    name: Lint & Type Check
    needs: pre-check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: Setup Node.js
      uses: 1e60f620b9541d16bece96c5465dc8ee9832be0b
      with:
        cache: npm
        cache-dependency-path: cloudflare/workers/package-lock.json
        node-version: ${{ env.NODE_VERSION }}
    - name: Install dependencies
      run: npm ci
      working-directory: cloudflare/workers
    - name: Type check
      run: npm run typecheck
      working-directory: cloudflare/workers
    - name: Lint
      run: npm run lint || true
      working-directory: cloudflare/workers
      - name: Checkout repository
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: Install Wrangler
        run: npm install -g wrangler@${{ env.WRANGLER_VERSION }}

      - name: Create/Verify R2 Bucket
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # List existing buckets
          echo "Existing R2 Buckets:"
          wrangler r2 bucket list
          
          # Check and create bucket if needed
          if ! wrangler r2 bucket list | grep -q "machinenativeops-assets-prod"; then
            echo "Creating R2 bucket..."
            wrangler r2 bucket create machinenativeops-assets-prod
          else
            echo "Bucket already exists"
          fi

  # ============================================================================
  # GitHub Webhook Configuration
  # ============================================================================
  configure-webhook:
    name: Configure GitHub Webhook
    runs-on: ubuntu-latest
    needs: [pre-check, deploy-workers]
    if: needs.pre-check.outputs.environment == 'production' && github.event_name == 'push'

    steps:
      - name: Configure GitHub Webhook
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## GitHub Webhook Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To complete the GitHub integration, configure a webhook in your repository:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Repository Settings > Webhooks > Add webhook**" >> $GITHUB_STEP_SUMMARY
          echo "2. **Payload URL:** \`https://api.machinenativeops.com/webhooks/github\`" >> $GITHUB_STEP_SUMMARY
          echo "3. **Content type:** \`application/json\`" >> $GITHUB_STEP_SUMMARY
          echo "4. **Secret:** Use the value from \`GITHUB_WEBHOOK_SECRET\`" >> $GITHUB_STEP_SUMMARY
          echo "5. **Events:** Select individual events or 'Send me everything'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Recommended events:" >> $GITHUB_STEP_SUMMARY
          echo "- Push" >> $GITHUB_STEP_SUMMARY
          echo "- Pull requests" >> $GITHUB_STEP_SUMMARY
          echo "- Issues" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow runs" >> $GITHUB_STEP_SUMMARY
          echo "- Releases" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Smoke Tests
  # ============================================================================
  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [pre-check, deploy-workers]
    if: always() && needs.deploy-workers.result == 'success'

    steps:
      - name: Health Check
        run: |
          ENV="${{ needs.pre-check.outputs.environment }}"

          # Derive the worker name from wrangler.toml for non-production/staging environments
          if [[ "$ENV" == "production" ]]; then
            URL="https://api.machinenativeops.com/health"
          elif [[ "$ENV" == "staging" ]]; then
            URL="https://staging-api.machinenativeops.com/health"
          else
            # For development, derive worker name from wrangler.toml
            WORKER_NAME="machinenativeops-worker-dev"
            if [[ -f "wrangler.toml" ]]; then
              # Try to extract the development worker name
              DEV_NAME=$(grep -A 5 '\[env.development\]' wrangler.toml | grep -E '^name *= *"' | sed -E 's/name *= *"([^"]+)"/\1/' || echo "")
              if [[ -n "$DEV_NAME" ]]; then
                WORKER_NAME="$DEV_NAME"
              fi
            fi
            URL="https://${WORKER_NAME}.workers.dev/health"
          fi

          echo "Checking health endpoint: $URL"

          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            if [[ "$response" == "200" ]]; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i: Got status $response, retrying..."
            sleep 10
          done

          echo "Health check failed after 5 attempts"
          exit 1

      - name: Test Results
        if: always()
        run: |
          echo "## Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Notify on Failure
  # ============================================================================
  notify-failure:
    if: failure()
    name: Notify on Failure
    needs:
    - deploy-workers
    - deploy-pages
    - smoke-test
    runs-on: ubuntu-latest
    steps:
    - name: Create Issue on Failure
      uses: 60a0d83039c74a4aee543508d2ffcb1c3799cdea
      with:
        script: "await github.rest.issues.create({\n  owner: context.repo.owner,\n\
          \  repo: context.repo.repo,\n  title: `Cloudflare Deployment Failed - ${context.sha.substring(0,\
          \ 7)}`,\n  body: `## Deployment Failure\n\n  **Workflow:** ${context.workflow}\n\
          \  **Run:** [${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\
          \  **Commit:** ${context.sha}\n  **Branch:** ${context.ref}\n\n  Please\
          \ investigate and fix the deployment issues.`,\n  labels: ['deployment',\
          \ 'cloudflare', 'automated']\n});\n"
  pre-check:
    name: Pre-deployment Checks
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
      should_deploy_pages: ${{ steps.changes.outputs.pages }}
      should_deploy_workers: ${{ steps.changes.outputs.workers }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
      with:
        fetch-depth: 0
    - id: determine-env
      name: Determine environment
      run: "if [[ \"${{ github.event_name }}\" == \"workflow_dispatch\" ]]; then\n\
        \  echo \"environment=${{ inputs.environment }}\" >> $GITHUB_OUTPUT\nelif\
        \ [[ \"${{ github.ref }}\" == \"refs/heads/main\" ]]; then\n  echo \"environment=production\"\
        \ >> $GITHUB_OUTPUT\nelif [[ \"${{ github.ref }}\" == \"refs/heads/staging\"\
        \ ]]; then\n  echo \"environment=staging\" >> $GITHUB_OUTPUT\nelse\n  echo\
        \ \"environment=development\" >> $GITHUB_OUTPUT\nfi\n"
    - id: changes
      name: Check for changes
      uses: dorny/paths-filter@v3
      with:
        filters: "workers:\n  - 'cloudflare/workers/**'\n  - 'wrangler.toml'\npages:\n\
          \  - 'src/frontend/**'\n  - 'src/web/**'\n  - 'cloudflare/pages/**'\n"
    - name: Summary
      run: 'echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY

        echo "- **Environment:** ${{ steps.determine-env.outputs.environment }}" >>
        $GITHUB_STEP_SUMMARY

        echo "- **Deploy Workers:** ${{ steps.changes.outputs.workers }}" >> $GITHUB_STEP_SUMMARY

        echo "- **Deploy Pages:** ${{ steps.changes.outputs.pages }}" >> $GITHUB_STEP_SUMMARY

        '
  setup-d1:
    if: needs.pre-check.outputs.environment == 'production' && github.event_name ==
      'push'
    name: Setup D1 Database
    needs:
    - pre-check
    - deploy-workers
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: Install Wrangler
      run: npm install -g wrangler@${{ env.WRANGLER_VERSION }}
    - env:
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      name: Create/Verify D1 Database
      run: '# List existing databases

        echo "Existing D1 Databases:"

        wrangler d1 list || true


        # Create database if it doesn''t exist

        wrangler d1 create machinenativeops-prod 2>/dev/null || echo "Database may
        already exist"

        '
    - env:
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      if: false
      name: Run D1 Migrations
      run: 'wrangler d1 migrations apply machinenativeops-prod --env production

        '
  setup-kv:
    if: needs.pre-check.outputs.environment == 'production' && github.event_name ==
      'push'
    name: Setup KV Namespaces
    needs:
    - pre-check
    - deploy-workers
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: Install Wrangler
      run: npm install -g wrangler@${{ env.WRANGLER_VERSION }}
    - env:
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      name: Create/Verify KV Namespaces
      run: '# List existing namespaces

        echo "Existing KV Namespaces:"

        wrangler kv:namespace list || true


        # Create namespaces if they don''t exist (will error if exists, that''s OK)

        wrangler kv:namespace create "CACHE" 2>/dev/null || echo "CACHE namespace
        may already exist"

        wrangler kv:namespace create "SESSIONS" 2>/dev/null || echo "SESSIONS namespace
        may already exist"

        '
  setup-r2:
    if: needs.pre-check.outputs.environment == 'production' && github.event_name ==
      'push'
    name: Setup R2 Bucket
    needs:
    - pre-check
    - deploy-workers
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: Install Wrangler
      run: npm install -g wrangler@${{ env.WRANGLER_VERSION }}
    - env:
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      name: Create/Verify R2 Bucket
      run: '# List existing buckets

        echo "Existing R2 Buckets:"

        wrangler r2 bucket list || true


        # Create bucket if it doesn''t exist

        wrangler r2 bucket create machinenativeops-assets-prod 2>/dev/null || echo
        "Bucket may already exist"

        '
  smoke-test:
    if: always() && needs.deploy-workers.result == 'success'
    name: Smoke Tests
    needs:
    - pre-check
    - deploy-workers
    runs-on: ubuntu-latest
    steps:
      - name: Create Issue on Failure
        uses: 60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Cloudflare Deployment Failed - ${context.sha.substring(0, 7)}`,
              body: `## Deployment Failure

              **Workflow:** ${context.workflow}
              **Run:** [${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              **Commit:** ${context.sha}
              **Branch:** ${context.ref}

              Please investigate and fix the deployment issues.`,
              labels: ['deployment', 'cloudflare', 'automated']
            });
    - name: Health Check
      run: "ENV=\"${{ needs.pre-check.outputs.environment }}\"\n\nif [[ \"$ENV\" ==\
        \ \"production\" ]]; then\n  URL=\"https://api.machinenativeops.com/health\"\
        \nelif [[ \"$ENV\" == \"staging\" ]]; then\n  URL=\"https://staging-api.machinenativeops.com/health\"\
        \nelse\n  URL=\"https://machinenativeops-worker-dev.workers.dev/health\"\n\
        fi\n\necho \"Checking health endpoint: $URL\"\n\nfor i in {1..5}; do\n  response=$(curl\
        \ -s -o /dev/null -w \"%{http_code}\" \"$URL\" || echo \"000\")\n  if [[ \"\
        $response\" == \"200\" ]]; then\n    echo \"Health check passed!\"\n    exit\
        \ 0\n  fi\n  echo \"Attempt $i: Got status $response, retrying...\"\n  sleep\
        \ 10\ndone\n\necho \"Health check failed after 5 attempts\"\nexit 1\n"
    - if: always()
      name: Test Results
      run: 'echo "## Smoke Test Results" >> $GITHUB_STEP_SUMMARY

        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

        '
