# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    ğŸ”§ Self-Healing CI System
#                    è‡ªé«”ä¿®å¾© CI ç³»çµ±
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# åŠŸèƒ½ï¼š
# 1. ç›£æ§ CI å¤±æ•—ä¸¦è‡ªå‹•åˆ†æ
# 2. å˜—è©¦è‡ªå‹•ä¿®å¾©å¸¸è¦‹å•é¡Œ
# 3. å­¸ç¿’ä¸¦è¨˜éŒ„ä¿®å¾©æ¨¡å¼
# 4. æä¾›ä¿®å¾©å»ºè­°
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸ”§ Self-Healing CI

on:
    workflow_run:
        workflows: ["*"]
        types: [completed]
        branches: [main]
    schedule:
        # æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡å¤±æ•—çš„ workflows
        - cron: "0 * * * *"
    workflow_dispatch:
        inputs:
            run_id:
                description: "è¦åˆ†æçš„ workflow run ID"
                required: false
                type: string
            auto_fix:
                description: "æ˜¯å¦è‡ªå‹•ä¿®å¾©"
                required: false
                type: boolean
                default: false


# Cost protection: prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
    contents: write
    actions: read
    pull-requests: write
    issues: write

env:
    HEALING_LOG_PATH: ".github/healing-logs"
    MAX_AUTO_FIX_ATTEMPTS: 3

jobs:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ç›£æ§å¤±æ•—çš„ workflows
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    monitor-failures:
        name: ğŸ“Š Monitor CI Failures
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
        outputs:
            has_failures: ${{ steps.check.outputs.has_failures }}
            failure_details: ${{ steps.check.outputs.failure_details }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Check for failures
              id: check
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  echo "ğŸ” Checking for CI failures..."

                  # ç²å–æœ€è¿‘å¤±æ•—çš„ workflows
                  FAILURES=$(gh run list --status failure --limit 10 --json databaseId,name,conclusion,headBranch,event,createdAt 2>/dev/null || echo "[]")

                  if [ "$FAILURES" == "[]" ] || [ -z "$FAILURES" ]; then
                    echo "âœ… No recent failures found"
                    echo "has_failures=false" >> $GITHUB_OUTPUT
                  else
                    echo "âš ï¸ Found failures:"
                    echo "$FAILURES" | jq -r '.[] | "- \(.name): \(.conclusion) (\(.createdAt))"'
                    echo "has_failures=true" >> $GITHUB_OUTPUT
                    echo "failure_details<<EOF" >> $GITHUB_OUTPUT
                    echo "$FAILURES" >> $GITHUB_OUTPUT
                    echo "EOF" >> $GITHUB_OUTPUT
                  fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # åˆ†æå¤±æ•—åŸå› 
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    analyze-failure:
        name: ğŸ”¬ Analyze Failure
        runs-on: ubuntu-latest
        needs: monitor-failures
        if: ${{ needs.monitor-failures.outputs.has_failures == 'true' || github.event.workflow_run.conclusion == 'failure' }}
        outputs:
            error_type: ${{ steps.analyze.outputs.error_type }}
            fix_suggestion: ${{ steps.analyze.outputs.fix_suggestion }}
            can_auto_fix: ${{ steps.analyze.outputs.can_auto_fix }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Analyze failure patterns
              id: analyze
              env:
                  GH_TOKEN: ${{ secrets.WE_TONKE || secrets.GITHUB_TOKEN }}
                  RUN_ID: ${{ github.event.workflow_run.id || inputs.run_id }}
              run: |
                  echo "ğŸ”¬ Analyzing failure patterns..."

                  # å¸¸è¦‹éŒ¯èª¤æ¨¡å¼
                  declare -A ERROR_PATTERNS=(
                    ["startup_failure"]="Workflow æª”æ¡ˆèªæ³•éŒ¯èª¤"
                    ["npm_install_failed"]="NPM å®‰è£å¤±æ•—"
                    ["test_failed"]="æ¸¬è©¦å¤±æ•—"
                    ["build_failed"]="å»ºç½®å¤±æ•—"
                    ["permission_denied"]="æ¬Šé™ä¸è¶³"
                    ["timeout"]="åŸ·è¡Œè¶…æ™‚"
                    ["rate_limit"]="API é€Ÿç‡é™åˆ¶"
                  )

                  # å˜—è©¦ç²å–å¤±æ•—æ—¥èªŒ
                  if [ -n "$RUN_ID" ]; then
                    LOGS=$(gh run view "$RUN_ID" --log-failed 2>/dev/null || echo "")
                  else
                    LOGS=""
                  fi

                  # åˆ†æéŒ¯èª¤é¡å‹
                  ERROR_TYPE="unknown"
                  CAN_AUTO_FIX="false"
                  FIX_SUGGESTION=""

                  if echo "$LOGS" | grep -q "startup_failure\|workflow file issue"; then
                    ERROR_TYPE="startup_failure"
                    FIX_SUGGESTION="æª¢æŸ¥ workflow YAML èªæ³•ï¼Œç¢ºä¿ hashFiles() åªç”¨åœ¨ step å±¤ç´š"
                    CAN_AUTO_FIX="true"
                  elif echo "$LOGS" | grep -q "npm ERR!\|ENOENT"; then
                    ERROR_TYPE="npm_install_failed"
                    FIX_SUGGESTION="æª¢æŸ¥ package.json å’Œ package-lock.json ä¸€è‡´æ€§"
                    CAN_AUTO_FIX="true"
                  elif echo "$LOGS" | grep -q "FAILED\|AssertionError\|test.*failed"; then
                    ERROR_TYPE="test_failed"
                    FIX_SUGGESTION="æª¢æŸ¥æ¸¬è©¦é‚è¼¯å’Œæ¸¬è©¦æ•¸æ“š"
                    CAN_AUTO_FIX="false"
                  elif echo "$LOGS" | grep -q "Build failed\|compilation error"; then
                    ERROR_TYPE="build_failed"
                    FIX_SUGGESTION="æª¢æŸ¥ç·¨è­¯éŒ¯èª¤å’Œä¾è³´"
                    CAN_AUTO_FIX="false"
                  fi

                  echo "error_type=$ERROR_TYPE" >> $GITHUB_OUTPUT
                  echo "fix_suggestion=$FIX_SUGGESTION" >> $GITHUB_OUTPUT
                  echo "can_auto_fix=$CAN_AUTO_FIX" >> $GITHUB_OUTPUT

                  echo "ğŸ“‹ Analysis Result:"
                  echo "  Error Type: $ERROR_TYPE"
                  echo "  Fix Suggestion: $FIX_SUGGESTION"
                  echo "  Can Auto Fix: $CAN_AUTO_FIX"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # å˜—è©¦è‡ªå‹•ä¿®å¾©
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    auto-fix:
        name: ğŸ”§ Auto Fix
        runs-on: ubuntu-latest
        needs: analyze-failure
        if: ${{ needs.analyze-failure.outputs.can_auto_fix == 'true' && (inputs.auto_fix == true || github.event_name == 'workflow_run') }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.WE_TONKE || secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20

            - name: Apply auto-fix
              id: fix
              env:
                  ERROR_TYPE: ${{ needs.analyze-failure.outputs.error_type }}
              run: |
                  echo "ğŸ”§ Attempting auto-fix for: $ERROR_TYPE"

                  case "$ERROR_TYPE" in
                    "startup_failure")
                      echo "Validating workflow files..."
                      # ä½¿ç”¨ actionlint æª¢æŸ¥èªæ³•
                      if command -v actionlint &> /dev/null; then
                        actionlint .github/workflows/*.yml || true
                      fi
                      
                      # æª¢æŸ¥ä¸¦ä¿®å¾©å¸¸è¦‹å•é¡Œ
                      for file in .github/workflows/*.yml; do
                        # æª¢æŸ¥ job å±¤ç´šçš„ hashFiles
                        if grep -q "^[[:space:]]*if:.*hashFiles" "$file"; then
                          echo "âš ï¸ Found potential hashFiles issue in $file"
                          echo "fix_needed=true" >> $GITHUB_OUTPUT
                        fi
                      done
                      ;;
                      
                    "npm_install_failed")
                      echo "Attempting npm fix..."
                      rm -rf node_modules package-lock.json
                      npm install
                      echo "fix_applied=true" >> $GITHUB_OUTPUT
                      ;;
                      
                    *)
                      echo "No auto-fix available for: $ERROR_TYPE"
                      echo "fix_applied=false" >> $GITHUB_OUTPUT
                      ;;
                  esac

            - name: Create fix PR
              if: ${{ steps.fix.outputs.fix_applied == 'true' }}
              env:
                  GH_TOKEN: ${{ secrets.WE_TONKE || secrets.GITHUB_TOKEN }}
              run: |
                  BRANCH="auto-fix/ci-healing-$(date +%Y%m%d-%H%M%S)"
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git checkout -b "$BRANCH"
                  git add -A
                  git commit -m "fix(ci): ğŸ”§ è‡ªå‹•ä¿®å¾© CI å•é¡Œ

                  - éŒ¯èª¤é¡å‹: ${{ needs.analyze-failure.outputs.error_type }}
                  - ä¿®å¾©å»ºè­°: ${{ needs.analyze-failure.outputs.fix_suggestion }}

                  ç”± Self-Healing CI è‡ªå‹•ç”Ÿæˆ" || exit 0

                  git push origin "$BRANCH"

                  gh pr create \
                    --title "ğŸ”§ Auto-fix: CI è‡ªå‹•ä¿®å¾©" \
                    --body "## ğŸ”§ CI è‡ªå‹•ä¿®å¾©

                  ### éŒ¯èª¤é¡å‹
                  \`${{ needs.analyze-failure.outputs.error_type }}\`

                  ### ä¿®å¾©å»ºè­°
                  ${{ needs.analyze-failure.outputs.fix_suggestion }}

                  ### è®Šæ›´å…§å®¹
                  æ­¤ PR ç”± Self-Healing CI ç³»çµ±è‡ªå‹•ç”Ÿæˆï¼ŒåŒ…å«é‡å° CI å¤±æ•—çš„è‡ªå‹•ä¿®å¾©ã€‚

                  ---
                  ğŸ¤– ç”± Self-Healing CI è‡ªå‹•ç”Ÿæˆ" \
                    --base main \
                    --head "$BRANCH"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # è¨˜éŒ„å­¸ç¿’çµæœ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    learn-and-log:
        name: ğŸ“š Learn & Log
        runs-on: ubuntu-latest
        needs: [analyze-failure]
        if: always()
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Log healing event
              env:
                  ERROR_TYPE: ${{ needs.analyze-failure.outputs.error_type }}
                  FIX_SUGGESTION: ${{ needs.analyze-failure.outputs.fix_suggestion }}
              run: |
                  mkdir -p ${{ env.HEALING_LOG_PATH }}

                  LOG_FILE="${{ env.HEALING_LOG_PATH }}/healing-$(date +%Y%m%d).json"

                  # å‰µå»ºæˆ–æ›´æ–°æ—¥èªŒ
                  if [ -f "$LOG_FILE" ]; then
                    EXISTING=$(cat "$LOG_FILE")
                  else
                    EXISTING="[]"
                  fi

                  NEW_ENTRY=$(jq -n \
                    --arg timestamp "$(date -Iseconds)" \
                    --arg error_type "$ERROR_TYPE" \
                    --arg fix_suggestion "$FIX_SUGGESTION" \
                    --arg run_id "${{ github.run_id }}" \
                    --arg workflow "${{ github.workflow }}" \
                    '{
                      timestamp: $timestamp,
                      error_type: $error_type,
                      fix_suggestion: $fix_suggestion,
                      run_id: $run_id,
                      workflow: $workflow
                    }')

                  echo "$EXISTING" | jq ". + [$NEW_ENTRY]" > "$LOG_FILE"

                  echo "ğŸ“š Logged healing event to $LOG_FILE"

            - name: Update healing statistics
              run: |
                  STATS_FILE="${{ env.HEALING_LOG_PATH }}/statistics.json"

                  # è¨ˆç®—çµ±è¨ˆæ•¸æ“š
                  if [ -d "${{ env.HEALING_LOG_PATH }}" ]; then
                    TOTAL_EVENTS=$(find ${{ env.HEALING_LOG_PATH }} -name "healing-*.json" -exec cat {} \; | jq -s 'add | length')
                    
                    # æŒ‰éŒ¯èª¤é¡å‹çµ±è¨ˆ
                    ERROR_STATS=$(find ${{ env.HEALING_LOG_PATH }} -name "healing-*.json" -exec cat {} \; | \
                      jq -s 'add | group_by(.error_type) | map({key: .[0].error_type, value: length}) | from_entries')
                    
                    jq -n \
                      --argjson total "$TOTAL_EVENTS" \
                      --argjson by_type "$ERROR_STATS" \
                      --arg updated "$(date -Iseconds)" \
                      '{
                        total_events: $total,
                        by_error_type: $by_type,
                        last_updated: $updated
                      }' > "$STATS_FILE"
                    
                    echo "ğŸ“Š Updated statistics:"
                    cat "$STATS_FILE"
                  fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ç™¼é€é€šçŸ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    notify:
        name: ğŸ“¢ Notify
        runs-on: ubuntu-latest
        needs: [analyze-failure, auto-fix]
        if: always() && needs.analyze-failure.outputs.error_type != 'unknown'
        steps:
            - name: Create issue for manual intervention
              if: ${{ needs.analyze-failure.outputs.can_auto_fix != 'true' }}
              env:
                  GH_TOKEN: ${{ secrets.WE_TONKE || secrets.GITHUB_TOKEN }}
              run: |
                  # æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒå•é¡Œçš„ issue
                  EXISTING=$(gh issue list --label "ci-failure" --state open --json number,title --jq '.[0].number')

                  if [ -z "$EXISTING" ]; then
                    gh issue create \
                      --title "ğŸ”§ CI å¤±æ•—éœ€è¦æ‰‹å‹•ä¿®å¾©: ${{ needs.analyze-failure.outputs.error_type }}" \
                      --body "## CI å¤±æ•—å ±å‘Š

                  ### éŒ¯èª¤é¡å‹
                  \`${{ needs.analyze-failure.outputs.error_type }}\`

                  ### ä¿®å¾©å»ºè­°
                  ${{ needs.analyze-failure.outputs.fix_suggestion }}

                  ### Workflow Run
                  - Run ID: ${{ github.run_id }}
                  - Workflow: ${{ github.workflow }}
                  - æ™‚é–“: $(date -Iseconds)

                  ---
                  ğŸ¤– ç”± Self-Healing CI è‡ªå‹•ç”Ÿæˆ" \
                      --label "ci-failure,needs-attention"
                  else
                    echo "Issue already exists: #$EXISTING"
                    gh issue comment "$EXISTING" --body "ğŸ”„ å†æ¬¡æª¢æ¸¬åˆ°ç›¸åŒé¡å‹çš„ CI å¤±æ•—

                  - æ™‚é–“: $(date -Iseconds)
                  - Run ID: ${{ github.run_id }}"
                  fi
