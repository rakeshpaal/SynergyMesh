name: ğŸšª Root Naming Policy Gate
true:
  pull_request:
    paths:
    - root.*
    - init.d/**
    - bin/**
    - sbin/**
    - etc/**
    - lib/**
    - var/**
    - usr/**
    types:
    - opened
    - edited
    - synchronize
    - reopened
    - ready_for_review
permissions:
  contents: read
  pull-requests: write
jobs:
  validate_root_naming:
    name: ğŸ” é©—è­‰ root/ å‘½åè¦ç¯„
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: 0ad4b8f3a27c304e21892351cbf9860471245599

      - name: ğŸ” æª¢æŸ¥ root/ è®Šæ›´æª”æ¡ˆ
        uses: 60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: prNumber, per_page: 100 }
            );

            const changedFiles = files.map(f => f.filename);
            const rootChanges = changedFiles.filter(p => 
              p.startsWith("root.") || 
              p.startsWith("init.d/") ||
              p.startsWith("bin/") ||
              p.startsWith("sbin/") ||
              p.startsWith("etc/") ||
              p.startsWith("lib/") ||
              p.startsWith("var/") ||
              p.startsWith("usr/")
            );

            if (rootChanges.length === 0) {
              core.info("âœ… æœ¬ PR æœªè®Šæ›´æ ¹å±¤æª”æ¡ˆï¼Œè·³éå‘½åè¦ç¯„æª¢æŸ¥");
              return;
            }

            core.info(`ğŸ“‹ æª¢æ¸¬åˆ° ${rootChanges.length} å€‹æ ¹å±¤è®Šæ›´æª”æ¡ˆ`);

            // å…è¨±çš„æª”æ¡ˆæ¨¡å¼ï¼ˆæ ¹å±¤ï¼‰
            const allowedPatterns = [
              // æ ¹å±¤æ²»ç†é…ç½®æª”æ¡ˆ
              /^root\.config\.yaml$/,
              /^root\.governance\.yaml$/,
              /^root\.modules\.yaml$/,
              /^root\.super-execution\.yaml$/,
              /^root\.trust\.yaml$/,
              /^root\.provenance\.yaml$/,
              /^root\.integrity\.yaml$/,
              /^root\.bootstrap\.yaml$/,
              /^root\.naming-policy\.yaml$/,
              /^root\.devices\.map$/,
              /^root\.fs\.map$/,
              /^root\.kernel\.map$/,
              /^root\.env\.sh$/,
              /^gates\.map\.yaml$/,
              
              // FHS æ¨™æº–ç›®éŒ„
              /^init\.d\/.*$/,
              /^bin\/.*$/,
              /^sbin\/.*$/,
              /^etc\/.*$/,
              /^lib\/.*$/,
              /^var\/.*$/,
              /^usr\/.*$/,
              /^home\/.*$/,
              /^tmp\/.*$/,
              /^opt\/.*$/,
              /^srv\/.*$/,
            ];

            // ç¦æ­¢çš„æ¨¡å¼
            const denyPatterns = [
              { pattern: /[A-Z]/, reason: "ç¦æ­¢å¤§å¯«å­—æ¯" },
              { pattern: /\s/, reason: "ç¦æ­¢ç©ºç™½å­—å…ƒ" },
              { pattern: /\.yml$/, reason: "çµ±ä¸€ä½¿ç”¨ .yamlï¼ˆä¸ç”¨ .ymlï¼‰" },
            ];

            const violations = [];

            for (const filepath of rootChanges) {
              // æª¢æŸ¥ç¦æ­¢æ¨¡å¼
              for (const deny of denyPatterns) {
                if (deny.pattern.test(filepath)) {
                  violations.push({
                    file: filepath,
                    reason: deny.reason,
                    severity: "error"
                  });
                }
              }

              // æª¢æŸ¥æ˜¯å¦ç¬¦åˆå…è¨±æ¨¡å¼
              const isAllowed = allowedPatterns.some(pattern => pattern.test(filepath));
              if (!isAllowed) {
                violations.push({
                  file: filepath,
                  reason: "ä¸ç¬¦åˆ root/ å‘½åè¦ç¯„ allowlist",
                  severity: "error"
                });
              }
            }

            // ç”Ÿæˆå ±å‘Š
            let report = "## ğŸ” Root å‘½åè¦ç¯„æª¢æŸ¥å ±å‘Š\n\n";
            
            if (violations.length === 0) {
              report += "### âœ… æª¢æŸ¥é€šé\n\n";
              report += `æ‰€æœ‰ ${rootChanges.length} å€‹æª”æ¡ˆéƒ½ç¬¦åˆå‘½åè¦ç¯„ã€‚\n\n`;
              report += "**è®Šæ›´æª”æ¡ˆæ¸…å–®:**\n";
              rootChanges.forEach(f => {
                report += `- âœ… \`${f}\`\n`;
              });
              
              core.info(report);
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: report
              });
              
              return;
            }

            // æœ‰é•è¦
            report += "### âŒ æª¢æŸ¥å¤±æ•—\n\n";
            report += `ç™¼ç¾ ${violations.length} å€‹é•è¦é …ç›®ï¼š\n\n`;
            
            violations.forEach((v, i) => {
              report += `${i + 1}. **\`${v.file}\`**\n`;
              report += `   - âŒ ${v.reason}\n\n`;
            });

            report += "\n---\n\n";
            report += "### ğŸ“‹ æ ¹å±¤å‘½åè¦ç¯„è¦æ±‚\n\n";
            report += "**å…è¨±çš„æª”æ¡ˆæ¨¡å¼:**\n";
            report += "- `root.<category>.yaml` (ä¾‹å¦‚: `root.config.yaml`)\n";
            report += "- `root.<category>.map` (ä¾‹å¦‚: `root.devices.map`)\n";
            report += "- `root.env.sh`\n";
            report += "- `init.d/**` (åˆå§‹åŒ–è…³æœ¬)\n";
            report += "- `bin/**`, `sbin/**`, `etc/**`, `lib/**` (FHS æ¨™æº–ç›®éŒ„)\n";
            report += "- `var/**`, `usr/**`, `home/**`, `tmp/**` (FHS æ¨™æº–ç›®éŒ„)\n\n";
            
            report += "**ç¦æ­¢çš„æ¨¡å¼:**\n";
            report += "- âŒ å¤§å¯«å­—æ¯\n";
            report += "- âŒ ç©ºç™½å­—å…ƒ\n";
            report += "- âŒ ä½¿ç”¨ `.yml` (è«‹çµ±ä¸€ä½¿ç”¨ `.yaml`)\n\n";
            
            report += "**ä¿®æ­£æ–¹å¼:**\n";
            report += "1. é‡å‘½åé•è¦æª”æ¡ˆä»¥ç¬¦åˆè¦ç¯„\n";
            report += "2. æ›´æ–° PR ä¸¦é‡æ–°æäº¤\n";
            report += "3. è‹¥éœ€æ–°å¢æ–°çš„æª”æ¡ˆé¡å‹ï¼Œè«‹å…ˆæ›´æ–° `root.naming-policy.yaml`\n";

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: report
            });

            core.setFailed(
              `Root å‘½åè¦ç¯„æª¢æŸ¥å¤±æ•—ï¼šç™¼ç¾ ${violations.length} å€‹é•è¦é …ç›®ã€‚è«‹æŸ¥çœ‹ PR è©•è«–äº†è§£è©³æƒ…ã€‚`
            );

      - name: ğŸ“Š è¼¸å‡ºæª¢æŸ¥æ‘˜è¦
        if: always()
        run: |
          echo "## ğŸšª Root Layer Naming Policy Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æœ¬æ¬¡æª¢æŸ¥é‡å°æ ¹å±¤æª”æ¡ˆï¼ˆroot.* å’Œ FHS ç›®éŒ„ï¼‰çš„å‘½åè¦ç¯„é€²è¡Œé©—è­‰ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°çµæœè«‹æŸ¥çœ‹ PR è©•è«–ã€‚" >> $GITHUB_STEP_SUMMARY
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: 0ad4b8f3a27c304e21892351cbf9860471245599
    - name: ğŸ” æª¢æŸ¥ root/ è®Šæ›´æª”æ¡ˆ
      uses: 60a0d83039c74a4aee543508d2ffcb1c3799cdea
      with:
        script: "const owner = context.repo.owner;\nconst repo = context.repo.repo;\n\
          const prNumber = context.payload.pull_request.number;\n\nconst files = await\
          \ github.paginate(\n  github.rest.pulls.listFiles,\n  { owner, repo, pull_number:\
          \ prNumber, per_page: 100 }\n);\n\nconst changedFiles = files.map(f => f.filename);\n\
          const rootChanges = changedFiles.filter(p => \n  p.startsWith(\"root.\"\
          ) || \n  p.startsWith(\"init.d/\") ||\n  p.startsWith(\"bin/\") ||\n  p.startsWith(\"\
          sbin/\") ||\n  p.startsWith(\"etc/\") ||\n  p.startsWith(\"lib/\") ||\n\
          \  p.startsWith(\"var/\") ||\n  p.startsWith(\"usr/\")\n);\n\nif (rootChanges.length\
          \ === 0) {\n  core.info(\"âœ… æœ¬ PR æœªè®Šæ›´æ ¹å±¤æª”æ¡ˆï¼Œè·³éå‘½åè¦ç¯„æª¢æŸ¥\");\n  return;\n}\n\n\
          core.info(`\U0001F4CB æª¢æ¸¬åˆ° ${rootChanges.length} å€‹æ ¹å±¤è®Šæ›´æª”æ¡ˆ`);\n\n// å…è¨±çš„æª”æ¡ˆæ¨¡å¼ï¼ˆæ ¹å±¤ï¼‰\n\
          const allowedPatterns = [\n  // æ ¹å±¤æ²»ç†é…ç½®æª”æ¡ˆ\n  /^root\\.config\\.yaml$/,\n\
          \  /^root\\.governance\\.yaml$/,\n  /^root\\.modules\\.yaml$/,\n  /^root\\\
          .super-execution\\.yaml$/,\n  /^root\\.trust\\.yaml$/,\n  /^root\\.provenance\\\
          .yaml$/,\n  /^root\\.integrity\\.yaml$/,\n  /^root\\.bootstrap\\.yaml$/,\n\
          \  /^root\\.naming-policy\\.yaml$/,\n  /^root\\.devices\\.map$/,\n  /^root\\\
          .fs\\.map$/,\n  /^root\\.kernel\\.map$/,\n  /^root\\.env\\.sh$/,\n  /^gates\\\
          .map\\.yaml$/,\n  \n  // FHS æ¨™æº–ç›®éŒ„\n  /^init\\.d\\/.*$/,\n  /^bin\\/.*$/,\n\
          \  /^sbin\\/.*$/,\n  /^etc\\/.*$/,\n  /^lib\\/.*$/,\n  /^var\\/.*$/,\n \
          \ /^usr\\/.*$/,\n  /^home\\/.*$/,\n  /^tmp\\/.*$/,\n  /^opt\\/.*$/,\n  /^srv\\\
          /.*$/,\n];\n\n// ç¦æ­¢çš„æ¨¡å¼\nconst denyPatterns = [\n  { pattern: /[A-Z]/, reason:\
          \ \"ç¦æ­¢å¤§å¯«å­—æ¯\" },\n  { pattern: /\\s/, reason: \"ç¦æ­¢ç©ºç™½å­—å…ƒ\" },\n  { pattern:\
          \ /\\.yml$/, reason: \"çµ±ä¸€ä½¿ç”¨ .yamlï¼ˆä¸ç”¨ .ymlï¼‰\" },\n];\n\nconst violations\
          \ = [];\n\nfor (const filepath of rootChanges) {\n  // æª¢æŸ¥ç¦æ­¢æ¨¡å¼\n  for (const\
          \ deny of denyPatterns) {\n    if (deny.pattern.test(filepath)) {\n    \
          \  violations.push({\n        file: filepath,\n        reason: deny.reason,\n\
          \        severity: \"error\"\n      });\n    }\n  }\n\n  // æª¢æŸ¥æ˜¯å¦ç¬¦åˆå…è¨±æ¨¡å¼\n\
          \  const isAllowed = allowedPatterns.some(pattern => pattern.test(filepath));\n\
          \  if (!isAllowed) {\n    violations.push({\n      file: filepath,\n   \
          \   reason: \"ä¸ç¬¦åˆ root/ å‘½åè¦ç¯„ allowlist\",\n      severity: \"error\"\n \
          \   });\n  }\n}\n\n// ç”Ÿæˆå ±å‘Š\nlet report = \"## \U0001F50D Root å‘½åè¦ç¯„æª¢æŸ¥å ±å‘Š\\\
          n\\n\";\n\nif (violations.length === 0) {\n  report += \"### âœ… æª¢æŸ¥é€šé\\n\\\
          n\";\n  report += `æ‰€æœ‰ ${rootChanges.length} å€‹æª”æ¡ˆéƒ½ç¬¦åˆå‘½åè¦ç¯„ã€‚\\n\\n`;\n  report\
          \ += \"**è®Šæ›´æª”æ¡ˆæ¸…å–®:**\\n\";\n  rootChanges.forEach(f => {\n    report += `-\
          \ âœ… \\`${f}\\`\\n`;\n  });\n  \n  core.info(report);\n  \n  await github.rest.issues.createComment({\n\
          \    owner,\n    repo,\n    issue_number: prNumber,\n    body: report\n\
          \  });\n  \n  return;\n}\n\n// æœ‰é•è¦\nreport += \"### âŒ æª¢æŸ¥å¤±æ•—\\n\\n\";\nreport\
          \ += `ç™¼ç¾ ${violations.length} å€‹é•è¦é …ç›®ï¼š\\n\\n`;\n\nviolations.forEach((v, i)\
          \ => {\n  report += `${i + 1}. **\\`${v.file}\\`**\\n`;\n  report += ` \
          \  - âŒ ${v.reason}\\n\\n`;\n});\n\nreport += \"\\n---\\n\\n\";\nreport +=\
          \ \"### \U0001F4CB æ ¹å±¤å‘½åè¦ç¯„è¦æ±‚\\n\\n\";\nreport += \"**å…è¨±çš„æª”æ¡ˆæ¨¡å¼:**\\n\";\nreport\
          \ += \"- `root.<category>.yaml` (ä¾‹å¦‚: `root.config.yaml`)\\n\";\nreport +=\
          \ \"- `root.<category>.map` (ä¾‹å¦‚: `root.devices.map`)\\n\";\nreport += \"\
          - `root.env.sh`\\n\";\nreport += \"- `init.d/**` (åˆå§‹åŒ–è…³æœ¬)\\n\";\nreport +=\
          \ \"- `bin/**`, `sbin/**`, `etc/**`, `lib/**` (FHS æ¨™æº–ç›®éŒ„)\\n\";\nreport +=\
          \ \"- `var/**`, `usr/**`, `home/**`, `tmp/**` (FHS æ¨™æº–ç›®éŒ„)\\n\\n\";\n\nreport\
          \ += \"**ç¦æ­¢çš„æ¨¡å¼:**\\n\";\nreport += \"- âŒ å¤§å¯«å­—æ¯\\n\";\nreport += \"- âŒ ç©ºç™½å­—å…ƒ\\\
          n\";\nreport += \"- âŒ ä½¿ç”¨ `.yml` (è«‹çµ±ä¸€ä½¿ç”¨ `.yaml`)\\n\\n\";\n\nreport += \"\
          **ä¿®æ­£æ–¹å¼:**\\n\";\nreport += \"1. é‡å‘½åé•è¦æª”æ¡ˆä»¥ç¬¦åˆè¦ç¯„\\n\";\nreport += \"2. æ›´æ–° PR\
          \ ä¸¦é‡æ–°æäº¤\\n\";\nreport += \"3. è‹¥éœ€æ–°å¢æ–°çš„æª”æ¡ˆé¡å‹ï¼Œè«‹å…ˆæ›´æ–° `root.naming-policy.yaml`\\\
          n\";\n\nawait github.rest.issues.createComment({\n  owner,\n  repo,\n  issue_number:\
          \ prNumber,\n  body: report\n});\n\ncore.setFailed(\n  `Root å‘½åè¦ç¯„æª¢æŸ¥å¤±æ•—ï¼šç™¼ç¾\
          \ ${violations.length} å€‹é•è¦é …ç›®ã€‚è«‹æŸ¥çœ‹ PR è©•è«–äº†è§£è©³æƒ…ã€‚`\n);\n"
    - if: always()
      name: ğŸ“Š è¼¸å‡ºæª¢æŸ¥æ‘˜è¦
      run: 'echo "## ğŸšª Root Layer Naming Policy Gate" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "æœ¬æ¬¡æª¢æŸ¥é‡å°æ ¹å±¤æª”æ¡ˆï¼ˆroot.* å’Œ FHS ç›®éŒ„ï¼‰çš„å‘½åè¦ç¯„é€²è¡Œé©—è­‰ã€‚" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "è©³ç´°çµæœè«‹æŸ¥çœ‹ PR è©•è«–ã€‚" >> $GITHUB_STEP_SUMMARY'
