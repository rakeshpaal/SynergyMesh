---
name: Core Services CI

on:
  pull_request:
    paths:
      - 'core/contract_service/contracts-L1/contracts/**'
      - 'mcp-servers/**'
      - '.github/workflows/core-services-ci.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'core/contract_service/contracts-L1/contracts/**'
      - 'mcp-servers/**'
      - '.github/workflows/core-services-ci.yml'
  workflow_dispatch:
    inputs:
      enable-docker-build:
        description: 'å•Ÿç”¨ Docker å»ºç½®ï¼ˆç›®å‰æœ‰å·²çŸ¥å•é¡Œï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  security-events: write
  pull-requests: write
  packages: write
  issues: write

jobs:
  # ==================== Tier 1: Contracts L1 Service ====================
  contracts-l1-ci:
    name: ğŸ—ï¸ Contracts L1 CI
    uses: ./.github/workflows/reusable-ci.yml
    with:
      working-directory: core/contract_service/contracts-L1/contracts
      service-name: contracts-l1
      node-version: '18'
      enable-coverage-upload: true
      enable-sbom: false
      enable-security-scan: false

  # ==================== Tier 2: MCP Servers ====================
  mcp-servers-ci:
    name: ğŸ”§ MCP Servers CI
    uses: ./.github/workflows/reusable-ci.yml
    with:
      working-directory: mcp-servers
      service-name: mcp-servers
      node-version: '18'
      enable-sbom: false
      enable-security-scan: false
      custom-scripts: 'validate:deployment, validate:logic'

  # ==================== Docker å»ºç½®é©—è­‰ ====================
  # æ³¨æ„ï¼šDocker å»ºç½®ç›®å‰å›  npm ci åœ¨å®¹å™¨ç’°å¢ƒä¸­çš„å·²çŸ¥å•é¡Œè€Œæš«æ™‚åœç”¨
  # Issue: npm åœ¨ Docker å®¹å™¨ä¸­å ±å‘Š "Exit handler never called" éŒ¯èª¤
  # Tracking: https://github.com/org/repo/issues/XXX  # TODO: æ›´æ–°ç‚ºå¯¦éš›è¿½è¹¤é€£çµ
  # Workaround: ç›®å‰åƒ…å…è¨± workflow_dispatch æ‰‹å‹•å•Ÿç”¨å»ºç½®ï¼Œé è¨­åœç”¨
  # TODO: è©•ä¼°ä½¿ç”¨ pnpm æˆ–å…¶ä»–å¥—ä»¶ç®¡ç†å™¨ä½œç‚ºæ›¿ä»£æ–¹æ¡ˆ
  # é€™ä¸å½±éŸ¿æœ¬åœ°é–‹ç™¼æˆ– CI æ¸¬è©¦ï¼Œåƒ…å½±éŸ¿å®¹å™¨åŒ–éƒ¨ç½²
  # è‹¥è¦å•Ÿç”¨ï¼Œè«‹å°‡ enable-docker-build è¨­ç‚º 'true'
  docker-build-verification:
    name: ğŸ³ Docker Build Verification
    runs-on: ubuntu-latest
    needs: [contracts-l1-ci, mcp-servers-ci]
    if: github.event.inputs.enable-docker-build == 'true'
    
    strategy:
      matrix:
        service:
          - name: contracts-l1
            context: core/contract_service/contracts-L1/contracts
            dockerfile: core/contract_service/contracts-L1/contracts/Dockerfile
          - name: mcp-servers
            context: mcp-servers
            dockerfile: mcp-servers/Dockerfile
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.3.0
      
      - name: ğŸ—ï¸ Build Docker image (${{ matrix.service.name }})
        uses: docker/build-push-action@v6.1.0
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: false
          tags: synergymesh/${{ matrix.service.name }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: ğŸ” Test Docker image (${{ matrix.service.name }})
        run: |
          echo "æ¸¬è©¦ Docker æ˜ åƒ..."
          docker images | grep synergymesh/${{ matrix.service.name }}
          echo "âœ… Docker æ˜ åƒå»ºç½®æˆåŠŸ"
      
      - name: ğŸ“Š Docker Build Summary
        run: |
          echo "## ğŸ³ Docker å»ºç½®å®Œæˆ: ${{ matrix.service.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ˜ åƒå»ºç½®æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ·ï¸ Tag: \`synergymesh/${{ matrix.service.name }}:ci-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # ==================== æ•´é«”ç‹€æ…‹å ±å‘Š ====================
  ci-status-report:
    name: ğŸ“Š CI Status Report
    runs-on: ubuntu-latest
    needs: [contracts-l1-ci, mcp-servers-ci]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate CI Report
        run: |
          echo "## ğŸ¯ æŒçºŒæ•´åˆå·¥ä½œç‹€æ…‹å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tier 1: æ ¸å¿ƒæœå‹™å±¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æœå‹™ | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Contracts L1 Service | ${{ needs.contracts-l1-ci.result == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tier 2: å·¥å…·èˆ‡é©—è­‰å±¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æœå‹™ | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| MCP Servers | ${{ needs.mcp-servers-ci.result == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ä½ç½®è³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "- **Contracts L1**: \`core/contract_service/contracts-L1/contracts/\`" >> $GITHUB_STEP_SUMMARY
          echo "- **MCP Servers**: \`mcp-servers/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ éƒ¨ç½²æŒ‡ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "- Contracts L1: \`docker-compose up contracts-l1\`" >> $GITHUB_STEP_SUMMARY
          echo "- MCP Servers: \`docker-compose up mcp-servers\`" >> $GITHUB_STEP_SUMMARY
      
      - name: âœ… Check overall status
        if: needs.contracts-l1-ci.result != 'success' || needs.mcp-servers-ci.result != 'success'
        run: |
          echo "âŒ æŸäº› CI æª¢æŸ¥å¤±æ•—"
          exit 1
  
  # ==================== äº’å‹•å¼å®¢æœæ•´åˆ ====================
  interactive-service:
    name: ğŸ¤– Core Services äº’å‹•å¼å®¢æœ
    needs: [contracts-l1-ci, mcp-servers-ci, ci-status-report]
    if: always()
    uses: ./.github/workflows/interactive-ci-service.yml
    with:
      ci-name: "Core Services CI"
      ci-status: ${{ (needs.contracts-l1-ci.result == 'success' && needs.mcp-servers-ci.result == 'success') && 'success' || 'failure' }}
      ci-context: |
        {
          "contracts_l1": "${{ needs.contracts-l1-ci.result }}",
          "mcp_servers": "${{ needs.mcp-servers-ci.result }}"
        }
      error-logs: ${{ needs.ci-status-report.result == 'failure' && 'æª¢æ¸¬åˆ° CI å¤±æ•—ï¼Œè«‹æŸ¥çœ‹è©³ç´°æ—¥èªŒ' || '' }}
