name: ğŸ”§ CI å¤±æ•—è‡ªå‹•åŒ–æ·±åº¦è§£æ±ºæ–¹æ¡ˆ

# æ­¤å·¥ä½œæµç¨‹ç›£æ§ CI å¤±æ•—ï¼Œè‡ªå‹•ç”Ÿæˆå…©å€‹æ·±åº¦è§£æ±ºæ–¹æ¡ˆä¸¦å»ºç«‹ GitHub Issue
# è¨­è¨ˆç†å¿µï¼šç•¶ CI å¤±æ•—æ™‚ï¼Œè‡ªå‹•åˆ†æå•é¡Œä¸¦æä¾›å…©å€‹ä¸åŒè§’åº¦çš„è§£æ±ºæ–¹æ¡ˆ
#
# è§¸ç™¼æ–¹å¼ï¼š
# 1. workflow_run: ç•¶ç›£æ§çš„å·¥ä½œæµç¨‹å¤±æ•—æ™‚è‡ªå‹•è§¸ç™¼
# 2. workflow_dispatch: æ‰‹å‹•è§¸ç™¼ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–æ¨¡æ“¬å¤±æ•—æƒ…å¢ƒï¼‰
on:
  workflow_run:
    workflows:
      - "Core Services CI"
      - "ğŸš€ æŒçºŒæ•´åˆèˆ‡éƒ¨ç½² (Integration & Deployment)"
      - "ğŸ¤– Auto-Fix Bot"
      - "CodeQL Advanced Security Scan"
      - "Stage 1: Basic CI"
      - "Docker Image CI"
      - "Contracts Service CD"
      - "ğŸ¤– Autonomous CI Guardian"
    types:
      - completed

  # æ‰‹å‹•è§¸ç™¼ï¼šç”¨æ–¼æ¸¬è©¦æˆ–æ¨¡æ“¬å¤±æ•—æƒ…å¢ƒ
  workflow_dispatch:
    inputs:
      simulate_failure:
        description: "æ¨¡æ“¬ CI å¤±æ•—é¡å‹"
        required: true
        default: "build"
        type: choice
        options:
          - build
          - test
          - docker
          - security
          - deployment
          - lint
          - integration
      workflow_name:
        description: "æ¨¡æ“¬å¤±æ•—çš„å·¥ä½œæµç¨‹åç¨±"
        required: false
        default: "Core Services CI"
        type: string
      pr_number:
        description: "é—œè¯çš„ PR ç·¨è™Ÿï¼ˆå¯é¸ï¼‰"
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read
  checks: read

env:
  SOLUTION_COUNT: 2

jobs:
  # ============================================
  # åµæ¸¬ CI å¤±æ•—ä¸¦æ”¶é›†è³‡è¨Š
  # ============================================
  detect-failure:
    name: ğŸ” åµæ¸¬ CI å¤±æ•—
    runs-on: ubuntu-latest
    # è§¸ç™¼æ¢ä»¶ï¼šå·¥ä½œæµç¨‹å¤±æ•— æˆ– æ‰‹å‹•è§¸ç™¼
    if: github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch'
    outputs:
      has_failure: ${{ steps.check.outputs.has_failure }}
      workflow_name: ${{ steps.check.outputs.workflow_name }}
      run_url: ${{ steps.check.outputs.run_url }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      pr_url: ${{ steps.check.outputs.pr_url }}
      branch: ${{ steps.check.outputs.branch }}
      commit_sha: ${{ steps.check.outputs.commit_sha }}
      failure_jobs: ${{ steps.analyze-jobs.outputs.failure_jobs }}
      failure_type: ${{ steps.check.outputs.failure_type }}

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: ğŸ” æª¢æŸ¥å¤±æ•—ç‹€æ…‹
        id: check
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            // åˆ¤æ–·æ˜¯è‡ªå‹•è§¸ç™¼é‚„æ˜¯æ‰‹å‹•è§¸ç™¼
            const isManualTrigger = context.eventName === 'workflow_dispatch';

            let workflowName, runUrl, branch, commitSha, failureType;
            let prNumber = null;
            let prUrl = null;

            if (isManualTrigger) {
              // æ‰‹å‹•è§¸ç™¼ï¼šä½¿ç”¨è¼¸å…¥åƒæ•¸
              workflowName = '${{ inputs.workflow_name }}' || 'Core Services CI';
              failureType = '${{ inputs.simulate_failure }}';
              runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              branch = context.ref.replace('refs/heads/', '');
              commitSha = context.sha;
              const prInput = '${{ inputs.pr_number }}';
              prNumber = prInput && prInput.trim() !== '' ? prInput : null;
              
              console.log('=== æ‰‹å‹•è§¸ç™¼æ¨¡å¼ ===');
              console.log(`æ¨¡æ“¬å¤±æ•—é¡å‹: ${failureType}`);
              console.log(`æ¨¡æ“¬å·¥ä½œæµç¨‹: ${workflowName}`);
            } else {
              // è‡ªå‹•è§¸ç™¼ï¼šå¾ workflow_run äº‹ä»¶ç²å–è³‡è¨Š
              const workflowRun = context.payload.workflow_run;
              workflowName = workflowRun.name;
              runUrl = workflowRun.html_url;
              branch = workflowRun.head_branch;
              commitSha = workflowRun.head_sha;
              failureType = 'auto'; // è‡ªå‹•åµæ¸¬
              
              console.log('=== è‡ªå‹•è§¸ç™¼æ¨¡å¼ ===');
              console.log(`Workflow: ${workflowRun.name}`);
              console.log(`Conclusion: ${workflowRun.conclusion}`);
              console.log(`Branch: ${workflowRun.head_branch}`);
            }

            // ç²å–é—œè¯çš„ PR
            if (!prNumber) {
              try {
                const pulls = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: `${context.repo.owner}:${branch}`,
                  state: 'open'
                });
                
                if (pulls.data.length > 0) {
                  prNumber = pulls.data[0].number;
                  prUrl = pulls.data[0].html_url;
                }
              } catch (error) {
                console.log(`ç„¡æ³•ç²å– PR: ${error.message}`);
              }
            } else if (prNumber) {
              prUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${prNumber}`;
            }

            core.setOutput('has_failure', 'true');
            core.setOutput('workflow_name', workflowName);
            core.setOutput('run_url', runUrl);
            core.setOutput('pr_number', prNumber || '');
            core.setOutput('pr_url', prUrl || '');
            core.setOutput('branch', branch);
            core.setOutput('commit_sha', commitSha);
            core.setOutput('failure_type', failureType);

      - name: ğŸ“Š åˆ†æå¤±æ•—çš„ Jobs
        id: analyze-jobs
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const isManualTrigger = context.eventName === 'workflow_dispatch';
            let failedJobs = [];

            if (isManualTrigger) {
              // æ‰‹å‹•è§¸ç™¼ï¼šæ¨¡æ“¬å¤±æ•—çš„ jobs
              const failureType = '${{ inputs.simulate_failure }}' || 'build';
              const workflowName = '${{ inputs.workflow_name }}' || 'Core Services CI';
              
              // æ ¹æ“šå¤±æ•—é¡å‹ç”Ÿæˆæ¨¡æ“¬çš„å¤±æ•— jobs
              const simulatedJobs = {
                'build': [
                  { name: `${workflowName} - Build`, conclusion: 'failure', steps: [{ name: 'npm run build', conclusion: 'failure' }] }
                ],
                'test': [
                  { name: `${workflowName} - Test`, conclusion: 'failure', steps: [{ name: 'npm test', conclusion: 'failure' }] }
                ],
                'docker': [
                  { name: `${workflowName} - Docker Build`, conclusion: 'failure', steps: [{ name: 'docker build', conclusion: 'failure' }] }
                ],
                'security': [
                  { name: `${workflowName} - Security Scan`, conclusion: 'failure', steps: [{ name: 'npm audit', conclusion: 'failure' }] }
                ],
                'deployment': [
                  { name: `${workflowName} - Deploy`, conclusion: 'failure', steps: [{ name: 'deploy to production', conclusion: 'failure' }] }
                ],
                'lint': [
                  { name: `${workflowName} - Lint`, conclusion: 'failure', steps: [{ name: 'npm run lint', conclusion: 'failure' }] }
                ],
                'integration': [
                  { name: `${workflowName} - Integration Test`, conclusion: 'failure', steps: [{ name: 'npm run test:integration', conclusion: 'failure' }] }
                ]
              };
              
              // ä½¿ç”¨é¸æ“‡çš„å¤±æ•—é¡å‹ï¼Œå¦‚æœç„¡æ•ˆå‰‡ä½¿ç”¨ build ä½œç‚ºé è¨­
              if (!simulatedJobs[failureType]) {
                console.log(`è­¦å‘Šï¼šæœªçŸ¥çš„å¤±æ•—é¡å‹ '${failureType}'ï¼Œä½¿ç”¨é è¨­é¡å‹ 'build'`);
                failureType = 'build';
              }
              failedJobs = simulatedJobs[failureType];
              failedJobs = failedJobs.map(job => ({
                ...job,
                html_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                started_at: new Date().toISOString(),
                completed_at: new Date().toISOString()
              }));
              
              console.log(`[æ‰‹å‹•æ¨¡å¼] æ¨¡æ“¬ ${failedJobs.length} å€‹å¤±æ•—çš„ jobs (é¡å‹: ${failureType})`);
            } else {
              // è‡ªå‹•è§¸ç™¼ï¼šå¾å¯¦éš›å·¥ä½œæµç¨‹ç²å–å¤±æ•—çš„ jobs
              const runId = context.payload.workflow_run.id;
              
              // ç²å–æ‰€æœ‰ jobs
              const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });
              
              // éæ¿¾å¤±æ•—çš„ jobs
              failedJobs = jobs.jobs.filter(job => 
                job.conclusion === 'failure' || job.conclusion === 'timed_out'
              ).map(job => ({
                name: job.name,
                conclusion: job.conclusion,
                html_url: job.html_url,
                started_at: job.started_at,
                completed_at: job.completed_at,
                steps: job.steps?.filter(step => step.conclusion === 'failure').map(step => ({
                  name: step.name,
                  conclusion: step.conclusion
                })) || []
              }));
              
              console.log(`[è‡ªå‹•æ¨¡å¼] ç™¼ç¾ ${failedJobs.length} å€‹å¤±æ•—çš„ jobs`);
            }

            core.setOutput('failure_jobs', JSON.stringify(failedJobs));

  # ============================================
  # ç”Ÿæˆæ·±åº¦è§£æ±ºæ–¹æ¡ˆ
  # ============================================
  generate-solutions:
    name: ğŸ§  ç”Ÿæˆæ·±åº¦è§£æ±ºæ–¹æ¡ˆ
    needs: detect-failure
    runs-on: ubuntu-latest
    if: needs.detect-failure.outputs.has_failure == 'true'
    outputs:
      solution_1: ${{ steps.generate.outputs.solution_1 }}
      solution_2: ${{ steps.generate.outputs.solution_2 }}
      root_cause_analysis: ${{ steps.generate.outputs.root_cause_analysis }}

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: ğŸ è¨­ç½® Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: ğŸ§  ç”Ÿæˆæ·±åº¦è§£æ±ºæ–¹æ¡ˆ
        id: generate
        env:
          WORKFLOW_NAME: ${{ needs.detect-failure.outputs.workflow_name }}
          RUN_URL: ${{ needs.detect-failure.outputs.run_url }}
          PR_NUMBER: ${{ needs.detect-failure.outputs.pr_number }}
          BRANCH: ${{ needs.detect-failure.outputs.branch }}
          COMMIT_SHA: ${{ needs.detect-failure.outputs.commit_sha }}
          FAILURE_JOBS: ${{ needs.detect-failure.outputs.failure_jobs }}
          FAILURE_TYPE: ${{ needs.detect-failure.outputs.failure_type }}
        run: |
          python3 .github/scripts/solution_generator.py > solutions.json
          cat solutions.json

          # æå–è§£æ±ºæ–¹æ¡ˆ
          SOLUTION_1=$(cat solutions.json | jq -r '.solutions[0]' | jq -c '.')
          SOLUTION_2=$(cat solutions.json | jq -r '.solutions[1]' | jq -c '.')
          ROOT_CAUSE=$(cat solutions.json | jq -r '.root_cause_analysis' | jq -c '.')

          # è¨­ç½®è¼¸å‡ºï¼ˆä½¿ç”¨ heredoc è™•ç†å¤šè¡Œï¼‰
          echo "solution_1<<EOF" >> $GITHUB_OUTPUT
          echo "$SOLUTION_1" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "solution_2<<EOF" >> $GITHUB_OUTPUT
          echo "$SOLUTION_2" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "root_cause_analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$ROOT_CAUSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ============================================
  # å»ºç«‹ GitHub Issue
  # ============================================
  create-issue:
    name: ğŸ“‹ å»ºç«‹è‡ªå‹•åŒ– Issue
    needs: [detect-failure, generate-solutions]
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create.outputs.issue_number }}
      issue_url: ${{ steps.create.outputs.issue_url }}

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: ğŸ“‹ å»ºç«‹ Issue èˆ‡æ·±åº¦è§£æ±ºæ–¹æ¡ˆ
        id: create
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          SOLUTION_1: ${{ needs.generate-solutions.outputs.solution_1 }}
          SOLUTION_2: ${{ needs.generate-solutions.outputs.solution_2 }}
          ROOT_CAUSE_ANALYSIS: ${{ needs.generate-solutions.outputs.root_cause_analysis }}
        with:
          script: |
            const workflowName = '${{ needs.detect-failure.outputs.workflow_name }}';
            const runUrl = '${{ needs.detect-failure.outputs.run_url }}';
            const prNumber = '${{ needs.detect-failure.outputs.pr_number }}';
            const prUrl = '${{ needs.detect-failure.outputs.pr_url }}';
            const branch = '${{ needs.detect-failure.outputs.branch }}';
            const commitSha = '${{ needs.detect-failure.outputs.commit_sha }}';
            const failedJobsRaw = `${{ needs.detect-failure.outputs.failure_jobs }}`;

            let failedJobs = [];
            try {
              failedJobs = JSON.parse(failedJobsRaw);
            } catch (e) {
              console.log('ç„¡æ³•è§£æå¤±æ•—çš„ jobs:', e.message);
            }

            // è§£æè§£æ±ºæ–¹æ¡ˆ
            let solution1 = {};
            let solution2 = {};
            let rootCause = {};

            try {
              solution1 = JSON.parse(process.env.SOLUTION_1);
              solution2 = JSON.parse(process.env.SOLUTION_2);
              rootCause = JSON.parse(process.env.ROOT_CAUSE_ANALYSIS);
            } catch (e) {
              console.log('è§£æè§£æ±ºæ–¹æ¡ˆæ™‚å‡ºéŒ¯:', e.message);
              solution1 = { title: 'æ–¹æ¡ˆä¸€', description: 'è«‹æŸ¥çœ‹ CI æ—¥èªŒ', steps: ['æª¢æŸ¥éŒ¯èª¤æ—¥èªŒ', 'åˆ†ææ ¹æœ¬åŸå› ', 'å¯¦æ–½ä¿®å¾©'] };
              solution2 = { title: 'æ–¹æ¡ˆäºŒ', description: 'è«‹è¯ç¹«åœ˜éšŠ', steps: ['å›å ±å•é¡Œ', 'è«‹æ±‚å”åŠ©', 'å…±åŒè§£æ±º'] };
              rootCause = { summary: 'éœ€è¦é€²ä¸€æ­¥åˆ†æ', details: 'è«‹æŸ¥çœ‹å®Œæ•´çš„ CI æ—¥èªŒ' };
            }

            // å»ºç«‹ Issue å…§å®¹
            const timestamp = new Date().toISOString();
            const shortSha = commitSha.substring(0, 7);

            let issueBody = `## ğŸš¨ CI å·¥ä½œæµç¨‹å¤±æ•—å ±å‘Š

            **æ™‚é–“**ï¼š${timestamp}
            **å·¥ä½œæµç¨‹**ï¼š${workflowName}
            **åˆ†æ”¯**ï¼š\`${branch}\`
            **Commit**ï¼š\`${shortSha}\`

            ---

            ### ğŸ”— ç›¸é—œé€£çµ

            | é …ç›® | é€£çµ |
            |------|------|
            | CI åŸ·è¡Œçµæœ | [æŸ¥çœ‹æ—¥èªŒ](${runUrl}) |
            ${prNumber ? `| é—œè¯ PR | [#${prNumber}](${prUrl}) |` : '| é—œè¯ PR | ç„¡ |'}
            | Commit | [\`${shortSha}\`](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${commitSha}) |

            ---

            ### âŒ å¤±æ•—çš„ Jobs

            `;

            if (failedJobs.length > 0) {
              for (const job of failedJobs) {
                issueBody += `#### ${job.name}\n`;
                issueBody += `- **ç‹€æ…‹**ï¼š${job.conclusion === 'failure' ? 'âŒ å¤±æ•—' : 'â±ï¸ è¶…æ™‚'}\n`;
                issueBody += `- **æ—¥èªŒ**ï¼š[æŸ¥çœ‹è©³æƒ…](${job.html_url})\n`;
                
                if (job.steps && job.steps.length > 0) {
                  issueBody += `- **å¤±æ•—æ­¥é©Ÿ**ï¼š\n`;
                  for (const step of job.steps) {
                    issueBody += `  - ${step.name}\n`;
                  }
                }
                issueBody += '\n';
              }
            } else {
              issueBody += 'ç„¡æ³•ç²å–è©³ç´°çš„å¤±æ•— Jobs è³‡è¨Šï¼Œè«‹æŸ¥çœ‹ CI æ—¥èªŒã€‚\n\n';
            }

            issueBody += `---

            ### ğŸ”¬ æ ¹æœ¬åŸå› åˆ†æ

            **æ‘˜è¦**ï¼š${rootCause.summary || 'éœ€è¦é€²ä¸€æ­¥åˆ†æ'}

            ${rootCause.details || 'è«‹æŸ¥çœ‹å®Œæ•´çš„ CI æ—¥èªŒä»¥ç²å–æ›´å¤šè³‡è¨Šã€‚'}

            ---

            ## ğŸ’¡ æ·±åº¦è§£æ±ºæ–¹æ¡ˆ

            ä»¥ä¸‹æä¾›å…©å€‹ä¸åŒè§’åº¦çš„è§£æ±ºæ–¹æ¡ˆï¼Œè«‹æ ¹æ“šå¯¦éš›æƒ…æ³é¸æ“‡é©åˆçš„æ–¹æ¡ˆï¼š

            ### ğŸ”µ æ–¹æ¡ˆä¸€ï¼š${solution1.title || 'å¿«é€Ÿä¿®å¾©'}

            **æè¿°**ï¼š${solution1.description || 'é‡å°ç•¶å‰å•é¡Œçš„ç›´æ¥ä¿®å¾©æ–¹æ¡ˆ'}

            **å¯¦æ–½æ­¥é©Ÿ**ï¼š
            `;

            if (solution1.steps && solution1.steps.length > 0) {
              for (let i = 0; i < solution1.steps.length; i++) {
                issueBody += `${i + 1}. ${solution1.steps[i]}\n`;
              }
            }

            if (solution1.code_example) {
              issueBody += `\n**åƒè€ƒç¨‹å¼ç¢¼**ï¼š\n\`\`\`${solution1.code_language || ''}\n${solution1.code_example}\n\`\`\`\n`;
            }

            issueBody += `
            **é æœŸæ•ˆæœ**ï¼š${solution1.expected_outcome || 'ä¿®å¾© CI éŒ¯èª¤'}

            **é¢¨éšªè©•ä¼°**ï¼š${solution1.risk_level || 'ä½'}

            ---

            ### ğŸŸ¢ æ–¹æ¡ˆäºŒï¼š${solution2.title || 'æ·±åº¦é‡æ§‹'}

            **æè¿°**ï¼š${solution2.description || 'å¾æ ¹æœ¬ä¸Šè§£æ±ºå•é¡Œçš„æ–¹æ¡ˆ'}

            **å¯¦æ–½æ­¥é©Ÿ**ï¼š
            `;

            if (solution2.steps && solution2.steps.length > 0) {
              for (let i = 0; i < solution2.steps.length; i++) {
                issueBody += `${i + 1}. ${solution2.steps[i]}\n`;
              }
            }

            if (solution2.code_example) {
              issueBody += `\n**åƒè€ƒç¨‹å¼ç¢¼**ï¼š\n\`\`\`${solution2.code_language || ''}\n${solution2.code_example}\n\`\`\`\n`;
            }

            issueBody += `
            **é æœŸæ•ˆæœ**ï¼š${solution2.expected_outcome || 'å¾¹åº•è§£æ±ºå•é¡Œä¸¦é é˜²æœªä¾†ç™¼ç”Ÿ'}

            **é¢¨éšªè©•ä¼°**ï¼š${solution2.risk_level || 'ä¸­'}

            ---

            ### ğŸ“Š è§£æ±ºæ–¹æ¡ˆæ¯”è¼ƒ

            | æ¯”è¼ƒé …ç›® | æ–¹æ¡ˆä¸€ | æ–¹æ¡ˆäºŒ |
            |----------|--------|--------|
            | å¯¦æ–½æ™‚é–“ | ${solution1.implementation_time || 'çŸ­'} | ${solution2.implementation_time || 'é•·'} |
            | é¢¨éšªç­‰ç´š | ${solution1.risk_level || 'ä½'} | ${solution2.risk_level || 'ä¸­'} |
            | é•·æœŸæ•ˆç›Š | ${solution1.long_term_benefit || 'ä¸€èˆ¬'} | ${solution2.long_term_benefit || 'é«˜'} |

            ---

            ### ğŸ¤ éœ€è¦å”åŠ©ï¼Ÿ

            - ğŸ’¬ åœ¨æ­¤ Issue ç•™è¨€è¨è«–
            - ğŸ“š æŸ¥çœ‹ [CI æ•…éšœæ’é™¤æ–‡æª”](./docs/ci-troubleshooting.md)
            - ğŸ”§ åŸ·è¡Œ \`bash scripts/check-env.sh\` æª¢æŸ¥æœ¬åœ°ç’°å¢ƒ

            ---

            *æ­¤ Issue ç”± CI å¤±æ•—è‡ªå‹•åŒ–ç³»çµ±è‡ªå‹•ç”Ÿæˆ*
            *æœ€å¾Œæ›´æ–°ï¼š${timestamp}*
            `;

            // å»ºç«‹ Issue
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”§ [CI å¤±æ•—] ${workflowName} - ${branch} (${shortSha})`,
              body: issueBody,
              labels: ['ci-failure', 'auto-generated', 'needs-attention']
            });

            console.log(`å»ºç«‹ Issue #${issue.number}: ${issue.html_url}`);

            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_url', issue.html_url);

  # ============================================
  # åœ¨ PR ä¸Šè©•è«–ï¼ˆå¦‚æœ‰é—œè¯ï¼‰
  # ============================================
  comment-on-pr:
    name: ğŸ’¬ åœ¨ PR ä¸Šè©•è«–
    needs: [detect-failure, generate-solutions, create-issue]
    runs-on: ubuntu-latest
    if: needs.detect-failure.outputs.pr_number != ''

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: ğŸ’¬ åœ¨ PR ä¸Šç™¼å¸ƒè§£æ±ºæ–¹æ¡ˆæ‘˜è¦
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = parseInt('${{ needs.detect-failure.outputs.pr_number }}');
            const issueNumber = '${{ needs.create-issue.outputs.issue_number }}';
            const issueUrl = '${{ needs.create-issue.outputs.issue_url }}';
            const workflowName = '${{ needs.detect-failure.outputs.workflow_name }}';

            // è§£æè§£æ±ºæ–¹æ¡ˆ
            let solution1 = {};
            let solution2 = {};

            try {
              solution1 = JSON.parse(`${{ needs.generate-solutions.outputs.solution_1 }}`);
              solution2 = JSON.parse(`${{ needs.generate-solutions.outputs.solution_2 }}`);
            } catch (e) {
              solution1 = { title: 'å¿«é€Ÿä¿®å¾©', description: 'è«‹æŸ¥çœ‹ Issue è©³æƒ…' };
              solution2 = { title: 'æ·±åº¦é‡æ§‹', description: 'è«‹æŸ¥çœ‹ Issue è©³æƒ…' };
            }

            const comment = `## ğŸš¨ CI å¤±æ•—ï¼š${workflowName}

            CI å·¥ä½œæµç¨‹ **${workflowName}** åŸ·è¡Œå¤±æ•—ã€‚æˆ‘å·²è‡ªå‹•åˆ†æå•é¡Œä¸¦ç”Ÿæˆäº†å…©å€‹æ·±åº¦è§£æ±ºæ–¹æ¡ˆã€‚

            ### ğŸ“‹ è©³ç´° Issue

            ğŸ‘‰ **[Issue #${issueNumber}](${issueUrl})** - åŒ…å«å®Œæ•´çš„åˆ†æå’Œè§£æ±ºæ–¹æ¡ˆ

            ---

            ### ğŸ’¡ å¿«é€Ÿæ‘˜è¦

            | æ–¹æ¡ˆ | æ¨™é¡Œ | æè¿° |
            |------|------|------|
            | ğŸ”µ æ–¹æ¡ˆä¸€ | ${solution1.title || 'å¿«é€Ÿä¿®å¾©'} | ${solution1.description || 'ç›´æ¥ä¿®å¾©ç•¶å‰å•é¡Œ'} |
            | ğŸŸ¢ æ–¹æ¡ˆäºŒ | ${solution2.title || 'æ·±åº¦é‡æ§‹'} | ${solution2.description || 'å¾æ ¹æœ¬è§£æ±ºå•é¡Œ'} |

            ---

            è«‹æŸ¥çœ‹ Issue ä»¥ç²å–è©³ç´°çš„å¯¦æ–½æ­¥é©Ÿå’Œç¨‹å¼ç¢¼ç¯„ä¾‹ã€‚

            *æ­¤è©•è«–ç”± CI å¤±æ•—è‡ªå‹•åŒ–ç³»çµ±è‡ªå‹•ç”Ÿæˆ*`;

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„è©•è«–
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existingComment = comments.find(c => 
              c.body.includes('CI å¤±æ•—è‡ªå‹•åŒ–ç³»çµ±è‡ªå‹•ç”Ÿæˆ') &&
              c.body.includes(`Issue #${issueNumber}`)
            );

            if (existingComment) {
              // æ›´æ–°ç¾æœ‰è©•è«–
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
              console.log('æ›´æ–°ç¾æœ‰è©•è«–');
            } else {
              // å»ºç«‹æ–°è©•è«–
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              console.log('å»ºç«‹æ–°è©•è«–');
            }

  # ============================================
  # ç”Ÿæˆå ±å‘Šæ‘˜è¦
  # ============================================
  summary:
    name: ğŸ“Š ç”ŸæˆåŸ·è¡Œæ‘˜è¦
    needs: [detect-failure, generate-solutions, create-issue]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“Š ç”Ÿæˆ GitHub Actions æ‘˜è¦
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const workflowName = '${{ needs.detect-failure.outputs.workflow_name }}' || 'Unknown';
            const issueNumber = '${{ needs.create-issue.outputs.issue_number }}' || 'N/A';
            const issueUrl = '${{ needs.create-issue.outputs.issue_url }}' || '#';
            const prNumber = '${{ needs.detect-failure.outputs.pr_number }}' || 'N/A';

            await core.summary
              .addHeading('ğŸ”§ CI å¤±æ•—è‡ªå‹•åŒ–æ·±åº¦è§£æ±ºæ–¹æ¡ˆ', 1)
              .addTable([
                [{data: 'é …ç›®', header: true}, {data: 'çµæœ', header: true}],
                ['å¤±æ•—çš„å·¥ä½œæµç¨‹', workflowName],
                ['å»ºç«‹çš„ Issue', `[#${issueNumber}](${issueUrl})`],
                ['é—œè¯çš„ PR', prNumber !== 'N/A' ? `#${prNumber}` : 'ç„¡'],
                ['ç”Ÿæˆçš„è§£æ±ºæ–¹æ¡ˆæ•¸é‡', '2']
              ])
              .addHeading('âœ… å®Œæˆå‹•ä½œ', 2)
              .addList([
                'åˆ†æ CI å¤±æ•—åŸå› ',
                'ç”Ÿæˆå…©å€‹æ·±åº¦è§£æ±ºæ–¹æ¡ˆ',
                'å»ºç«‹è©³ç´°çš„ GitHub Issue',
                prNumber !== 'N/A' ? 'åœ¨ PR ä¸Šç™¼å¸ƒæ‘˜è¦è©•è«–' : 'ï¼ˆç„¡é—œè¯ PRï¼‰'
              ])
              .write();
