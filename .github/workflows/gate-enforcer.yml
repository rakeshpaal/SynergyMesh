name: ğŸšª Gate Enforcer - é–˜é–€å¼·åˆ¶å™¨

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  enforce-gates:
    name: ğŸ”’ Enforce PR Gates
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.11"

      - name: ğŸ“ Save PR Body to File
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "$PR_BODY" > /tmp/pr_body.md

      - name: ğŸšª Run Gate Enforcer
        id: gate-enforcer
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
        run: |
          chmod +x .github/scripts/gate-enforcer.py

          # é‹è¡Œé–˜é–€å¼·åˆ¶å™¨ä¸¦æ•ç²è¼¸å‡º
          python .github/scripts/gate-enforcer.py \
            --pr-body-file /tmp/pr_body.md \
            --pr-number ${{ github.event.pull_request.number }} \
            --output both \
            --repo-root . \
            > /tmp/gate_report.txt 2>&1 || true

          # æå– markdown å’Œ json å ±å‘Š
          cat /tmp/gate_report.txt

          # è§£æ JSON å ±å‘Šç²å–åˆ†æ•¸
          SCORE=$(grep -A 100 '^{' /tmp/gate_report.txt | python -c "import sys,json; data=json.load(sys.stdin); print(data['score'])" 2>/dev/null || echo "0")
          PASSED=$(grep -A 100 '^{' /tmp/gate_report.txt | python -c "import sys,json; data=json.load(sys.stdin); print(data['passed'])" 2>/dev/null || echo "0")
          FAILED=$(grep -A 100 '^{' /tmp/gate_report.txt | python -c "import sys,json; data=json.load(sys.stdin); print(data['failed'])" 2>/dev/null || echo "0")

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          # ä¿å­˜å ±å‘Š
          cp /tmp/gate_report.txt gate-report.md

      - name: ğŸ“Š Generate Summary
        run: |
          echo "## ğŸšª é–˜é–€é©—è­‰çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é©—è­‰åˆ†æ•¸**: ${{ steps.gate-enforcer.outputs.score }}%" >> $GITHUB_STEP_SUMMARY
          echo "**é€šé**: ${{ steps.gate-enforcer.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
          echo "**å¤±æ•—**: ${{ steps.gate-enforcer.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ·»åŠ è©³ç´°å ±å‘Š
          head -50 gate-report.md >> $GITHUB_STEP_SUMMARY || true

      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7.0.2
        with:
          script: |
            const fs = require('fs');

            // è®€å–å ±å‘Š
            let report = '';
            try {
              report = fs.readFileSync('gate-report.md', 'utf8');
              // åªå– markdown éƒ¨åˆ† (åœ¨ --- ä¹‹å‰)
              const parts = report.split('---\n');
              report = parts[0];
            } catch (e) {
              report = 'ç„¡æ³•è®€å–é–˜é–€å ±å‘Š';
            }

            const score = parseFloat('${{ steps.gate-enforcer.outputs.score }}') || 0;
            const failed = parseInt('${{ steps.gate-enforcer.outputs.failed }}') || 0;

            // æ§‹å»ºè©•è«–
            let body = report;

            // æ·»åŠ ç‹€æ…‹æ¨™ç±¤
            if (score >= 80) {
              body = '# âœ… é–˜é–€æª¢æŸ¥é€šé\n\n' + body;
            } else if (score >= 50) {
              body = '# âš ï¸ é–˜é–€æª¢æŸ¥éƒ¨åˆ†é€šé\n\n' + body;
            } else {
              body = '# âŒ é–˜é–€æª¢æŸ¥å¤±æ•—\n\n' + body;
            }

            body += '\n\n---\n*æ­¤å ±å‘Šç”± Gate Enforcer è‡ªå‹•ç”Ÿæˆ*';

            // æŸ¥æ‰¾ç¾æœ‰è©•è«–
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Gate Enforcer')
            );

            if (botComment) {
              // æ›´æ–°ç¾æœ‰è©•è«–
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // å‰µå»ºæ–°è©•è«–
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: ğŸ“¤ Upload Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: gate-enforcer-report
          path: gate-report.md
          retention-days: 30

      - name: ğŸš« Fail if Gates Failed
        if: ${{ steps.gate-enforcer.outputs.failed > 0 }}
        run: |
          echo "::error::é–˜é–€æª¢æŸ¥å¤±æ•—: ${{ steps.gate-enforcer.outputs.failed }} å€‹é–˜é–€æœªé€šé"
          echo "è«‹ä¿®å¾©ä¸Šè¿°å•é¡Œå¾Œé‡æ–°æäº¤"
          exit 1


  # =============================================================================
  # è‡ªå‹•ä¿®å¾©ä½œæ¥­ (å¯é¸ - å˜—è©¦è‡ªå‹•å¡«å¯«æ¨¡æ¿)
  # =============================================================================
  auto-fill-template:
    name: ğŸ¤– Auto-fill PR Template
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'  # åªåœ¨ PR é¦–æ¬¡é–‹å•Ÿæ™‚é‹è¡Œ

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2
        with:
          fetch-depth: 0

      - name: ğŸ” Collect PR Evidence
        id: evidence
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
        run: |
          # æ”¶é›†è­‰æ“š
          REPO="https://github.com/${{ github.repository }}"
          BRANCH="${{ github.head_ref }}"
          COMMIT="${{ github.event.pull_request.head.sha }}"
          PR_URL="https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"

          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

          # ç²å–è®Šæ›´æª”æ¡ˆ
          git diff --name-only origin/${{ github.base_ref }}...HEAD > /tmp/changed_files.txt
          CHANGED_FILES=$(cat /tmp/changed_files.txt | head -20 | sed 's/^/  - /' | tr '\n' '\n')
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“ Generate Suggested Update
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7.0.2
        with:
          script: |
            const currentBody = context.payload.pull_request.body || '';

            // æª¢æŸ¥æ˜¯å¦å·²ç¶“å¡«å¯«äº†è­‰æ“š
            if (currentBody.includes('${{ steps.evidence.outputs.commit }}')) {
              console.log('è­‰æ“šå·²å¡«å¯«ï¼Œè·³é');
              return;
            }

            // æ§‹å»ºå»ºè­°çš„è­‰æ“šå€å¡Š
            const evidenceBlock = `
            ### ğŸ“‹ å››å¤§æ ¸å¿ƒè­‰æ“š
            \`\`\`yaml
            - repo: ${{ steps.evidence.outputs.repo }}
            - branch: ${{ steps.evidence.outputs.branch }}
            - commit: ${{ steps.evidence.outputs.commit }}
            - PR: ${{ steps.evidence.outputs.pr_url }}
            \`\`\`

            ### ğŸ“Š è®Šæ›´æª”æ¡ˆ (è‡ªå‹•æª¢æ¸¬)
            \`\`\`yaml
            modified_files:
            ${{ steps.evidence.outputs.changed_files }}
            \`\`\`
            `;

            // å‰µå»ºä¸€å€‹å»ºè­°è©•è«–
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ¤– è‡ªå‹•æ”¶é›†çš„è­‰æ“š

            ä»¥ä¸‹æ˜¯è‡ªå‹•æ”¶é›†çš„ PR è­‰æ“šï¼Œè«‹å°‡å…¶æ·»åŠ åˆ° PR æè¿°ä¸­ï¼š

            ${evidenceBlock}

            ---
            *æç¤ºï¼šæ‚¨å¯ä»¥è¤‡è£½ä¸Šè¿°å…§å®¹ä¸¦æ›´æ–° PR æè¿°ï¼Œæˆ–è€…ä½¿ç”¨ç·¨è¼¯åŠŸèƒ½ç›´æ¥ä¿®æ”¹ã€‚*`
            });
