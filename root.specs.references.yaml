# ğŸ”— Root Layer Reference Specification
# Version: 1.0.0
# Scope: All reference fields in root.*.yaml files
# Enforcement: Strict (GitHub Actions gate-root-specs.yml)

apiVersion: machinenativeops.io/v1
kind: RootReferenceSpec
metadata:
  name: root-reference-specification
  namespace: machinenativeops-specs
  labels:
    machinenativeops.io/tier: "specs"
    machinenativeops.io/version: "v1.0.0"
    machinenativeops.io/component: "reference-spec"
  annotations:
    machinenativeops.io/description: "Machine-verifiable reference conventions for root layer"
    machinenativeops.io/enforcement: "strict"
    machinenativeops.io/last-modified: "2025-12-21T02:00:00Z"

spec:
  version: 1
  
  # === å¼•ç”¨æ ¼å¼å®šç¾© ===
  reference_formats:
    # 1. URN æ ¼å¼ï¼ˆä¸»è¦å¼•ç”¨æ ¼å¼ï¼‰
    urn:
      description: "çµ±ä¸€è³‡æºåç¨±ï¼Œç”¨æ–¼è·¨ç³»çµ±å¼•ç”¨"
      pattern: "^urn:machinenativeops:(module|service|config|policy|certificate|audit):[a-z0-9-]+(:v\\d+)?$"
      components:
        scheme: "urn"
        namespace: "machinenativeops"
        type: "module|service|config|policy|certificate|audit"
        identifier: "[a-z0-9-]+"
        version: "v\\d+ (optional)"
      examples:
        valid:
          - "urn:machinenativeops:module:governance-engine"
          - "urn:machinenativeops:module:governance-engine:v1"
          - "urn:machinenativeops:service:trust-manager"
          - "urn:machinenativeops:config:root-config"
          - "urn:machinenativeops:policy:rbac-policy"
          - "urn:machinenativeops:certificate:root-ca"
          - "urn:machinenativeops:audit:governance-audit"
        invalid:
          - "urn:axiom:module:governance-engine"  # éŒ¯èª¤çš„ namespace
          - "urn:machinenativeops:Module:governance-engine"  # å¤§å¯«
          - "urn:machinenativeops:module:GovernanceEngine"  # PascalCase
          - "machinenativeops:module:governance-engine"  # ç¼ºå°‘ urn: å‰ç¶´
    
    # 2. æ¨¡çµ„å¼•ç”¨æ ¼å¼
    module_ref:
      description: "æ¨¡çµ„é–“ä¾è³´å¼•ç”¨"
      pattern: "^[a-z][a-z0-9-]*[a-z0-9]$"
      examples:
        valid:
          - "config-manager"
          - "logging-service"
          - "trust-manager"
        invalid:
          - "ConfigManager"
          - "config_manager"
          - "config.manager"
    
    # 3. æª”æ¡ˆè·¯å¾‘å¼•ç”¨
    file_path_ref:
      description: "æª”æ¡ˆç³»çµ±è·¯å¾‘å¼•ç”¨"
      pattern: "^(/[a-z0-9_-]+)+(/[a-z0-9_.-]+)?$"
      examples:
        valid:
          - "/opt/machinenativenops/modules/governance-engine/main.py"
          - "/etc/machinenativenops/config.yaml"
          - "/var/log/machinenativenops/audit.log"
        invalid:
          - "/Opt/MachineNativeOps/Main.py"  # å¤§å¯«
          - "opt/machinenativenops/main.py"  # ç¼ºå°‘å‰å°æ–œç·š
          - "/opt/machinenativenops//main.py"  # é›™æ–œç·š
    
    # 4. é…ç½®å¼•ç”¨æ ¼å¼
    config_ref:
      description: "é…ç½®é …ç›®å¼•ç”¨"
      pattern: "^root\\.[a-z][a-z0-9-]*$"
      examples:
        valid:
          - "root.config"
          - "root.modules"
          - "root.governance"
        invalid:
          - "config"  # ç¼ºå°‘ root. å‰ç¶´
          - "root.Config"  # å¤§å¯«
    
    # 5. ç’°å¢ƒè®Šæ•¸å¼•ç”¨
    env_var_ref:
      description: "ç’°å¢ƒè®Šæ•¸å¼•ç”¨"
      pattern: "^[A-Z][A-Z0-9_]*$"
      examples:
        valid:
          - "GOVERNANCE_MODE"
          - "API_KEY"
          - "DB_HOST"
        invalid:
          - "governance_mode"  # å°å¯«
          - "GovernanceMode"  # PascalCase
          - "GOVERNANCE-MODE"  # é€£å­—è™Ÿ

  # === å¼•ç”¨æ¬„ä½è¦å‰‡ ===
  reference_field_rules:
    # æ‰€æœ‰ä»¥ *_ref çµå°¾çš„æ¬„ä½
    - field_pattern: ".*_ref$"
      required_format: "urn"
      description: "æ‰€æœ‰ *_ref æ¬„ä½å¿…é ˆä½¿ç”¨ URN æ ¼å¼"
      examples:
        valid_fields:
          - "module_ref: urn:machinenativeops:module:governance-engine"
          - "service_ref: urn:machinenativeops:service:trust-manager"
        invalid_fields:
          - "module_ref: governance-engine"  # é URN æ ¼å¼
    
    # ä¾è³´é …ç›®å¼•ç”¨
    - field_pattern: "^dependencies\\[\\]\\.name$"
      required_format: "module_ref"
      description: "ä¾è³´é …ç›®åç¨±å¿…é ˆä½¿ç”¨æ¨¡çµ„å¼•ç”¨æ ¼å¼"
      validation:
        - "å¿…é ˆåœ¨ root.registry.modules.yaml ä¸­å­˜åœ¨"
        - "ä¸å¯å¼•ç”¨è‡ªèº«"
        - "ä¸å¯å½¢æˆå¾ªç’°ä¾è³´"
    
    # å…¥å£é»å¼•ç”¨
    - field_pattern: "^entrypoint$"
      required_format: "file_path_ref"
      description: "å…¥å£é»å¿…é ˆä½¿ç”¨çµ•å°è·¯å¾‘"
      validation:
        - "è·¯å¾‘å¿…é ˆå­˜åœ¨æ–¼æª”æ¡ˆç³»çµ±æ˜ å°„ä¸­"
        - "å¿…é ˆæŒ‡å‘å¯åŸ·è¡Œæª”æ¡ˆ"
    
    # é…ç½®å¼•ç”¨
    - field_pattern: "^config_source$"
      required_format: "config_ref"
      description: "é…ç½®ä¾†æºå¿…é ˆå¼•ç”¨ root.* é…ç½®æª”"
      validation:
        - "å¼•ç”¨çš„é…ç½®æª”å¿…é ˆå­˜åœ¨"

  # === å¼•ç”¨é©—è­‰è¦å‰‡ ===
  validation_rules:
    - id: "REF-001"
      description: "æ‰€æœ‰å¼•ç”¨å¿…é ˆå¯è§£æ"
      severity: "error"
      check: "å¼•ç”¨çš„ç›®æ¨™å¿…é ˆå­˜åœ¨æ–¼è¨»å†Šè¡¨ä¸­"
      scope: ["module_ref", "service_ref", "config_ref"]
      
    - id: "REF-002"
      description: "URN æ ¼å¼å¿…é ˆæ­£ç¢º"
      severity: "error"
      check: "æ‰€æœ‰ URN å¿…é ˆç¬¦åˆå®šç¾©çš„æ­£å‰‡è¡¨é”å¼"
      scope: ["urn"]
      
    - id: "REF-003"
      description: "æ¨¡çµ„ä¾è³´ä¸å¯å¾ªç’°"
      severity: "error"
      check: "ä¾è³´åœ–å¿…é ˆæ˜¯æœ‰å‘ç„¡ç’°åœ– (DAG)"
      scope: ["dependencies"]
      algorithm: "topological_sort"
      
    - id: "REF-004"
      description: "æª”æ¡ˆè·¯å¾‘å¿…é ˆå­˜åœ¨"
      severity: "warning"
      check: "å¼•ç”¨çš„æª”æ¡ˆè·¯å¾‘å¿…é ˆåœ¨ root.fs.map ä¸­å®šç¾©"
      scope: ["file_path_ref"]
      
    - id: "REF-005"
      description: "ç‰ˆæœ¬å¼•ç”¨å¿…é ˆç›¸å®¹"
      severity: "error"
      check: "ä¾è³´ç‰ˆæœ¬å¿…é ˆæ»¿è¶³ semver ç›¸å®¹æ€§"
      scope: ["dependencies[].version"]
      
    - id: "REF-006"
      description: "ç’°å¢ƒè®Šæ•¸å¼•ç”¨å¿…é ˆå®šç¾©"
      severity: "warning"
      check: "å¼•ç”¨çš„ç’°å¢ƒè®Šæ•¸å¿…é ˆåœ¨é…ç½®ä¸­å®šç¾©"
      scope: ["env_var_ref"]

  # === å¼•ç”¨å®Œæ•´æ€§æª¢æŸ¥ ===
  integrity_checks:
    # 1. å­˜åœ¨æ€§æª¢æŸ¥
    existence:
      enabled: true
      description: "é©—è­‰æ‰€æœ‰å¼•ç”¨çš„ç›®æ¨™éƒ½å­˜åœ¨"
      sources:
        - "root.registry.modules.yaml"
        - "root.registry.urns.yaml"
        - "root.fs.map"
      actions:
        on_missing: "error"
        on_ambiguous: "warning"
    
    # 2. å”¯ä¸€æ€§æª¢æŸ¥
    uniqueness:
      enabled: true
      description: "é©—è­‰å¼•ç”¨ç›®æ¨™çš„å”¯ä¸€æ€§"
      check:
        - "åŒä¸€ URN ä¸å¯æŒ‡å‘å¤šå€‹å¯¦é«”"
        - "åŒä¸€æ¨¡çµ„åç¨±ä¸å¯é‡è¤‡å®šç¾©"
      actions:
        on_duplicate: "error"
    
    # 3. ä¸€è‡´æ€§æª¢æŸ¥
    consistency:
      enabled: true
      description: "é©—è­‰å¼•ç”¨åœ¨ä¸åŒæª”æ¡ˆé–“çš„ä¸€è‡´æ€§"
      check:
        - "åŒä¸€æ¨¡çµ„åœ¨ä¸åŒæª”æ¡ˆä¸­çš„å¼•ç”¨å¿…é ˆä¸€è‡´"
        - "ç‰ˆæœ¬è™Ÿå¿…é ˆåŒ¹é…"
      actions:
        on_mismatch: "error"
    
    # 4. å¾ªç’°ä¾è³´æª¢æŸ¥
    circular_dependency:
      enabled: true
      description: "æª¢æ¸¬ä¸¦é˜²æ­¢å¾ªç’°ä¾è³´"
      algorithm: "depth_first_search"
      actions:
        on_cycle_detected: "error"
        report_cycle_path: true

  # === å¼•ç”¨è§£æç­–ç•¥ ===
  resolution_strategy:
    # URN è§£æ
    urn_resolution:
      priority: 1
      lookup_order:
        - "root.registry.urns.yaml"
        - "root.registry.modules.yaml"
      cache_enabled: true
      cache_ttl: "300s"
    
    # æ¨¡çµ„å¼•ç”¨è§£æ
    module_resolution:
      priority: 2
      lookup_order:
        - "root.registry.modules.yaml"
        - "root.modules.yaml"
      version_matching: "semver"
    
    # æª”æ¡ˆè·¯å¾‘è§£æ
    file_path_resolution:
      priority: 3
      lookup_order:
        - "root.fs.map"
        - "filesystem"
      validate_existence: true

  # === å¼•ç”¨æœ€ä½³å¯¦è¸ ===
  best_practices:
    - id: "BP-REF-001"
      title: "å„ªå…ˆä½¿ç”¨ URN"
      description: "è·¨ç³»çµ±å¼•ç”¨æ‡‰å„ªå…ˆä½¿ç”¨ URN æ ¼å¼"
      rationale: "URN æä¾›å…¨åŸŸå”¯ä¸€æ€§å’Œç‰ˆæœ¬æ§åˆ¶"
      
    - id: "BP-REF-002"
      title: "é¿å…ç¡¬ç·¨ç¢¼è·¯å¾‘"
      description: "ä½¿ç”¨é…ç½®å¼•ç”¨è€Œéç¡¬ç·¨ç¢¼æª”æ¡ˆè·¯å¾‘"
      rationale: "æé«˜å¯ç§»æ¤æ€§å’Œå¯ç¶­è­·æ€§"
      
    - id: "BP-REF-003"
      title: "æ˜ç¢ºç‰ˆæœ¬ä¾è³´"
      description: "ä¾è³´è²æ˜æ‡‰åŒ…å«æ˜ç¢ºçš„ç‰ˆæœ¬ç¯„åœ"
      rationale: "é¿å…ç‰ˆæœ¬è¡çªå’Œä¸ç›¸å®¹å•é¡Œ"
      
    - id: "BP-REF-004"
      title: "æ–‡æª”åŒ–å¼•ç”¨é—œä¿‚"
      description: "è¤‡é›œå¼•ç”¨é—œä¿‚æ‡‰åœ¨è¨»è§£ä¸­èªªæ˜"
      rationale: "æé«˜å¯è®€æ€§å’Œå¯ç¶­è­·æ€§"

  # === é©—è­‰é…ç½® ===
  validation:
    enabled: true
    enforcement_level: "strict"
    
    checks:
      - name: "format_validation"
        enabled: true
        description: "é©—è­‰å¼•ç”¨æ ¼å¼"
        
      - name: "existence_validation"
        enabled: true
        description: "é©—è­‰å¼•ç”¨ç›®æ¨™å­˜åœ¨"
        
      - name: "consistency_validation"
        enabled: true
        description: "é©—è­‰å¼•ç”¨ä¸€è‡´æ€§"
        
      - name: "circular_dependency_detection"
        enabled: true
        description: "æª¢æ¸¬å¾ªç’°ä¾è³´"
    
    error_handling:
      on_format_error: "block_pr"
      on_missing_reference: "block_pr"
      on_circular_dependency: "block_pr"
      on_version_mismatch: "warning"

# === ç‹€æ…‹ ===
status:
  phase: "Active"
  conditions:
    - type: "Validated"
      status: "True"
      lastTransitionTime: "2025-12-21T02:00:00Z"
      reason: "SpecificationComplete"
      message: "Reference specification is complete and validated"
  
  statistics:
    total_formats: 5
    total_rules: 6
    total_checks: 4
    coverage: "100%"