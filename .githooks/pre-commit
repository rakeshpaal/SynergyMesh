#!/usr/bin/env bash
# Pre-commit hook - ä½¿ç”¨ controlplane é©—è­‰æ–‡ä»¶å‘½å
# é€™æ˜¯ controlplane å¯¦éš›æ‡‰ç”¨çš„ç¤ºä¾‹

# ä¸ä½¿ç”¨ set -eï¼Œå› ç‚ºæˆ‘å€‘éœ€è¦æ”¶é›†æ‰€æœ‰éŒ¯èª¤å¾Œå†æ±ºå®šæ˜¯å¦é€€å‡º
set -u
set -o pipefail

# è¼‰å…¥ controlplane åº«
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || {
    echo "[pre-commit] ERROR: not a git repository (git rev-parse failed)"
    exit 1
}

CONTROLPLANE_LIB="$REPO_ROOT/lib/controlplane.sh"
if [[ ! -f "$CONTROLPLANE_LIB" ]]; then
    echo "[pre-commit] WARNING: $CONTROLPLANE_LIB not found, skipping validation"
    exit 0
fi

# shellcheck source=/dev/null
source "$CONTROLPLANE_LIB" || {
    echo "[pre-commit] ERROR: failed to source $CONTROLPLANE_LIB"
    exit 1
}

echo "ğŸ” Running pre-commit validation with controlplane..."
echo ""

# æª¢æŸ¥ controlplane æ˜¯å¦å­˜åœ¨
if ! cp_check_exists; then
    cp_log_warning "Controlplane not found, skipping validation"
    exit 0
fi

# ç²å–æš«å­˜çš„æ–‡ä»¶
staged_files=()
mapfile -t staged_files < <(git diff --cached --name-only --diff-filter=ACM)

if [[ ${#staged_files[@]} -eq 0 ]]; then
    cp_log_info "No files staged for commit"
    exit 0
fi

# é©—è­‰è¨ˆæ•¸å™¨
total_files=0
invalid_files=0
validated_files=()
invalid_file_list=()

# é©—è­‰æ¯å€‹æ–‡ä»¶çš„å‘½å
for file in "${staged_files[@]}"; do
    # è·³éç‰¹æ®Šæ–‡ä»¶å’Œç›®éŒ„
    if [[ "$file" == .git* ]] || [[ -d "$file" ]]; then
        continue
    fi
    
    # ç²å–æ–‡ä»¶å
    filename=$(basename "$file")
    
    # è·³éæŸäº›ç‰¹æ®Šæ–‡ä»¶ï¼ˆä½¿ç”¨æ¨¡å¼åŒ¹é…ä»¥ä¾¿ç¶­è­·ï¼‰
    # æ’é™¤æ–‡ä»¶åˆ—è¡¨å¯ä»¥å¾é…ç½®æ–‡ä»¶è®€å–ï¼Œä½†é€™è£¡å…ˆä½¿ç”¨ç°¡å–®æ¨¡å¼
    if [[ "$filename" =~ ^(LICENSE|.*\.md|\.git.*|CHANGELOG.*|CODEOWNERS)$ ]]; then
        continue
    fi
    
    total_files=$((total_files + 1))
    
    # é©—è­‰æ–‡ä»¶å
    if cp_validate_name "$filename" "file" 2>/dev/null; then
        validated_files+=("$file")
    else
        invalid_files=$((invalid_files + 1))
        invalid_file_list+=("$file")
    fi
done

# é¡¯ç¤ºçµæœ
echo ""
echo "Validation Results:"
echo "  Total files checked: $total_files"
echo "  Valid files: $((total_files - invalid_files))"
echo "  Invalid files: $invalid_files"

if [[ $invalid_files -gt 0 ]]; then
    echo ""
    cp_log_error "The following files have invalid names:"
    for file in "${invalid_file_list[@]}"; do
        echo "  - $file"
    done
    echo ""
    cp_log_error "Please rename files to follow kebab-case naming convention"
    cp_log_info "Example: MyFile.yaml â†’ my-file.yaml"
    cp_log_info "To bypass this check (not recommended): git commit --no-verify"
    exit 1
fi

cp_log_success "All file names are valid!"
echo ""

# å¯é¸ï¼šé‹è¡Œå®Œæ•´é©—è­‰ï¼ˆå¦‚æœä¿®æ”¹äº† controlplane æ–‡ä»¶ï¼‰
if printf '%s\n' "${staged_files[@]}" | grep -q "^controlplane/"; then
    cp_log_info "Controlplane files modified, running full validation..."
    if ! cp_run_validation; then
        cp_log_error "Controlplane validation failed"
        exit 1
    fi
fi

exit 0
