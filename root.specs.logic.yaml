# ğŸ§  Root Layer Logic Specification
# Version: 1.0.0
# Scope: Logical consistency rules for root layer
# Enforcement: Strict (GitHub Actions gate-root-specs.yml)

apiVersion: machinenativeops.io/v1
kind: RootLogicSpec
metadata:
  name: root-logic-specification
  namespace: machinenativeops-specs
  labels:
    machinenativeops.io/tier: "specs"
    machinenativeops.io/version: "v1.0.0"
    machinenativeops.io/component: "logic-spec"
  annotations:
    machinenativeops.io/description: "Machine-verifiable logical consistency rules for root layer"
    machinenativeops.io/enforcement: "strict"
    machinenativeops.io/last-modified: "2025-12-21T02:00:00Z"

spec:
  version: 1
  
  # === é‚è¼¯è¦å‰‡é¡åˆ¥ ===
  logic_categories:
    # 1. äº’æ–¥è¦å‰‡
    mutual_exclusion:
      description: "å®šç¾©äº’æ–¥çš„é…ç½®é¸é …"
      rules:
        - id: "LOGIC-MX-001"
          description: "æ¨¡çµ„ä¸å¯åŒæ™‚å•Ÿç”¨å’Œç¦ç”¨"
          check: "NOT (enabled == true AND enabled == false)"
          scope: "root.modules.yaml::modules[]"
          
        - id: "LOGIC-MX-002"
          description: "åŒä¸€ç«¯å£ä¸å¯è¢«å¤šå€‹æœå‹™ä½¿ç”¨"
          check: "UNIQUE(modules[].port)"
          scope: "root.modules.yaml"
          
        - id: "LOGIC-MX-003"
          description: "åŒä¸€ URN ä¸å¯æŒ‡å‘å¤šå€‹è³‡æº"
          check: "UNIQUE(urns[].urn)"
          scope: "root.registry.urns.yaml"
    
    # 2. ä¾è³´è¦å‰‡
    dependency:
      description: "å®šç¾©ä¾è³´é—œä¿‚çš„é‚è¼¯ç´„æŸ"
      rules:
        - id: "LOGIC-DEP-001"
          description: "ä¾è³´çš„æ¨¡çµ„å¿…é ˆå­˜åœ¨"
          check: |
            FOR EACH module M:
              FOR EACH dependency D in M.dependencies:
                EXISTS module M2 WHERE M2.name == D.name
          scope: "root.modules.yaml"
          severity: "error"
          
        - id: "LOGIC-DEP-002"
          description: "ä¾è³´ä¸å¯å½¢æˆå¾ªç’°"
          check: "NO_CYCLES(dependency_graph)"
          algorithm: "topological_sort"
          scope: "root.modules.yaml"
          severity: "error"
          
        - id: "LOGIC-DEP-003"
          description: "å¿…è¦ä¾è³´ä¸å¯æ¨™è¨˜ç‚ºå¯é¸"
          check: |
            FOR EACH module M:
              FOR EACH dependency D in M.dependencies:
                IF D.critical == true THEN D.optional == false
          scope: "root.modules.yaml"
          severity: "error"
          
        - id: "LOGIC-DEP-004"
          description: "ç‰ˆæœ¬ä¾è³´å¿…é ˆå¯æ»¿è¶³"
          check: |
            FOR EACH module M:
              FOR EACH dependency D in M.dependencies:
                EXISTS version V WHERE V satisfies D.version_constraint
          scope: "root.modules.yaml"
          severity: "error"
    
    # 3. ç‹€æ…‹ä¸€è‡´æ€§è¦å‰‡
    state_consistency:
      description: "å®šç¾©ç‹€æ…‹ä¹‹é–“çš„ä¸€è‡´æ€§ç´„æŸ"
      rules:
        - id: "LOGIC-STATE-001"
          description: "å•Ÿç”¨çš„æ¨¡çµ„å¿…é ˆæœ‰å…¥å£é»"
          check: |
            FOR EACH module M:
              IF M.enabled == true THEN M.entrypoint != null
          scope: "root.modules.yaml"
          severity: "error"
          
        - id: "LOGIC-STATE-002"
          description: "è‡ªå‹•å•Ÿå‹•çš„æ¨¡çµ„å¿…é ˆå·²å•Ÿç”¨"
          check: |
            FOR EACH module M:
              IF M.auto_start == true THEN M.enabled == true
          scope: "root.modules.yaml"
          severity: "error"
          
        - id: "LOGIC-STATE-003"
          description: "å¥åº·æª¢æŸ¥å¿…é ˆæœ‰ç«¯é»"
          check: |
            FOR EACH module M:
              IF M.health_check.enabled == true THEN M.health_check.endpoint != null
          scope: "root.modules.yaml"
          severity: "error"
          
        - id: "LOGIC-STATE-004"
          description: "éšæ®µé †åºå¿…é ˆéå¢"
          check: |
            FOR EACH phase P1, P2 in bootstrap.phases:
              IF P1.order < P2.order THEN P1.sequence < P2.sequence
          scope: "root.bootstrap.yaml"
          severity: "error"
    
    # 4. è³‡æºç´„æŸè¦å‰‡
    resource_constraints:
      description: "å®šç¾©è³‡æºä½¿ç”¨çš„é‚è¼¯ç´„æŸ"
      rules:
        - id: "LOGIC-RES-001"
          description: "è³‡æºè«‹æ±‚ä¸å¯è¶…éé™åˆ¶"
          check: |
            FOR EACH module M:
              M.resources.cpu.request <= M.resources.cpu.limit AND
              M.resources.memory.request <= M.resources.memory.limit
          scope: "root.modules.yaml"
          severity: "error"
          
        - id: "LOGIC-RES-002"
          description: "å„ªå…ˆç´šå¿…é ˆåœ¨æœ‰æ•ˆç¯„åœå…§"
          check: |
            FOR EACH module M:
              0 <= M.priority <= 100
          scope: "root.modules.yaml"
          severity: "error"
          
        - id: "LOGIC-RES-003"
          description: "é‡è©¦æ¬¡æ•¸å¿…é ˆç‚ºæ­£æ•¸"
          check: |
            FOR EACH module M:
              IF M.health_check.retries != null THEN M.health_check.retries > 0
          scope: "root.modules.yaml"
          severity: "error"
    
    # 5. æ™‚é–“é‚è¼¯è¦å‰‡
    temporal_logic:
      description: "å®šç¾©æ™‚é–“ç›¸é—œçš„é‚è¼¯ç´„æŸ"
      rules:
        - id: "LOGIC-TIME-001"
          description: "è¶…æ™‚æ™‚é–“å¿…é ˆå¤§æ–¼é–“éš”æ™‚é–“"
          check: |
            FOR EACH module M:
              IF M.health_check.timeout AND M.health_check.interval THEN
                parse_duration(M.health_check.timeout) > parse_duration(M.health_check.interval)
          scope: "root.modules.yaml"
          severity: "warning"
          
        - id: "LOGIC-TIME-002"
          description: "è­‰æ›¸æœ‰æ•ˆæœŸå¿…é ˆåœ¨æœªä¾†"
          check: |
            FOR EACH certificate C:
              C.valid_until > current_time()
          scope: "root.trust.yaml"
          severity: "error"
          
        - id: "LOGIC-TIME-003"
          description: "å¯©è¨ˆä¿ç•™æœŸå¿…é ˆåˆç†"
          check: |
            FOR EACH audit_config A:
              1 <= A.retention_days <= 3650  # 1 day to 10 years
          scope: "root.provenance.yaml"
          severity: "warning"
    
    # 6. æ¬Šé™é‚è¼¯è¦å‰‡
    permission_logic:
      description: "å®šç¾©æ¬Šé™ç›¸é—œçš„é‚è¼¯ç´„æŸ"
      rules:
        - id: "LOGIC-PERM-001"
          description: "è§’è‰²å¿…é ˆæœ‰è‡³å°‘ä¸€å€‹æ¬Šé™"
          check: |
            FOR EACH role R:
              LENGTH(R.permissions) > 0
          scope: "root.governance.yaml"
          severity: "warning"
          
        - id: "LOGIC-PERM-002"
          description: "ç®¡ç†å“¡è§’è‰²å¿…é ˆæœ‰æ‰€æœ‰æ¬Šé™"
          check: |
            FOR EACH role R:
              IF R.name == "admin" THEN R.permissions CONTAINS "*"
          scope: "root.governance.yaml"
          severity: "error"
          
        - id: "LOGIC-PERM-003"
          description: "å”¯è®€è§’è‰²ä¸å¯æœ‰å¯«å…¥æ¬Šé™"
          check: |
            FOR EACH role R:
              IF R.name CONTAINS "readonly" THEN
                NOT (R.permissions CONTAINS "write" OR R.permissions CONTAINS "delete")
          scope: "root.governance.yaml"
          severity: "error"

  # === è¤‡åˆé‚è¼¯è¦å‰‡ ===
  compound_rules:
    - id: "LOGIC-COMP-001"
      description: "æ¨¡çµ„å®Œæ•´æ€§æª¢æŸ¥"
      severity: "error"
      conditions:
        - "æ¨¡çµ„å¿…é ˆå­˜åœ¨æ–¼è¨»å†Šè¡¨"
        - "æ¨¡çµ„å¿…é ˆæœ‰æœ‰æ•ˆçš„å…¥å£é»"
        - "æ¨¡çµ„çš„æ‰€æœ‰ä¾è³´å¿…é ˆå¯è§£æ"
        - "æ¨¡çµ„çš„è³‡æºé…ç½®å¿…é ˆåˆç†"
      check: |
        FOR EACH module M:
          M IN registry.modules AND
          M.entrypoint != null AND
          ALL(D in M.dependencies: D.name IN registry.modules) AND
          M.resources.cpu.request <= M.resources.cpu.limit
      
    - id: "LOGIC-COMP-002"
      description: "å•Ÿå‹•é †åºä¸€è‡´æ€§"
      severity: "error"
      conditions:
        - "ä¾è³´çš„æ¨¡çµ„å¿…é ˆå…ˆå•Ÿå‹•"
        - "å„ªå…ˆç´šé«˜çš„æ¨¡çµ„æ‡‰å…ˆå•Ÿå‹•"
        - "æ ¸å¿ƒæ¨¡çµ„å¿…é ˆåœ¨æ‡‰ç”¨æ¨¡çµ„ä¹‹å‰å•Ÿå‹•"
      check: |
        FOR EACH module M1, M2:
          IF M2 IN M1.dependencies THEN
            M2.priority >= M1.priority OR
            M2.group == "core"
      
    - id: "LOGIC-COMP-003"
      description: "å®‰å…¨é…ç½®ä¸€è‡´æ€§"
      severity: "error"
      conditions:
        - "å•Ÿç”¨ TLS æ™‚å¿…é ˆæœ‰è­‰æ›¸é…ç½®"
        - "å•Ÿç”¨èªè­‰æ™‚å¿…é ˆæœ‰ä¿¡ä»»éˆ"
        - "æ•æ„Ÿè³‡æ–™å¿…é ˆåŠ å¯†"
      check: |
        IF security.tls.enabled == true THEN
          security.certificates != null AND
          security.trust_chain != null

  # === æ¢ä»¶é‚è¼¯è¦å‰‡ ===
  conditional_rules:
    - id: "LOGIC-COND-001"
      description: "ç”Ÿç”¢ç’°å¢ƒå¿…é ˆå•Ÿç”¨å®‰å…¨åŠŸèƒ½"
      condition: "environment == 'production'"
      requirements:
        - "security.tls.enabled == true"
        - "security.authentication.enabled == true"
        - "audit.enabled == true"
      severity: "error"
      
    - id: "LOGIC-COND-002"
      description: "é–‹ç™¼ç’°å¢ƒå¯ä»¥æ”¾å¯¬é™åˆ¶"
      condition: "environment == 'development'"
      allowances:
        - "security.tls.enabled may be false"
        - "debug.enabled may be true"
      severity: "info"
      
    - id: "LOGIC-COND-003"
      description: "é«˜å¯ç”¨æ¨¡å¼å¿…é ˆæœ‰å‚™ä»½é…ç½®"
      condition: "high_availability == true"
      requirements:
        - "replicas >= 3"
        - "backup.enabled == true"
        - "failover.enabled == true"
      severity: "error"

  # === ä¸è®Šé‡è¦å‰‡ ===
  invariants:
    - id: "LOGIC-INV-001"
      description: "æ¨¡çµ„ç¸½æ•¸ä¸å¯è¶…éé™åˆ¶"
      invariant: "COUNT(modules) <= 100"
      scope: "root.modules.yaml"
      severity: "warning"
      
    - id: "LOGIC-INV-002"
      description: "ä¾è³´æ·±åº¦ä¸å¯éæ·±"
      invariant: "MAX_DEPTH(dependency_graph) <= 10"
      scope: "root.modules.yaml"
      severity: "warning"
      
    - id: "LOGIC-INV-003"
      description: "é…ç½®æª”æ¡ˆå¤§å°ä¸å¯éå¤§"
      invariant: "FILE_SIZE(root.*.yaml) <= 1MB"
      scope: "root.*.yaml"
      severity: "warning"

  # === é©—è­‰ç®—æ³• ===
  validation_algorithms:
    # å¾ªç’°ä¾è³´æª¢æ¸¬
    cycle_detection:
      algorithm: "depth_first_search"
      description: "ä½¿ç”¨ DFS æª¢æ¸¬ä¾è³´åœ–ä¸­çš„å¾ªç’°"
      complexity: "O(V + E)"
      implementation: |
        function detect_cycle(graph):
          visited = set()
          rec_stack = set()
          
          for node in graph.nodes:
            if node not in visited:
              if dfs(node, visited, rec_stack):
                return true
          return false
        
        function dfs(node, visited, rec_stack):
          visited.add(node)
          rec_stack.add(node)
          
          for neighbor in node.dependencies:
            if neighbor not in visited:
              if dfs(neighbor, visited, rec_stack):
                return true
            elif neighbor in rec_stack:
              return true
          
          rec_stack.remove(node)
          return false
    
    # æ‹“æ’²æ’åº
    topological_sort:
      algorithm: "kahn"
      description: "ä½¿ç”¨ Kahn ç®—æ³•é€²è¡Œæ‹“æ’²æ’åº"
      complexity: "O(V + E)"
      implementation: |
        function topological_sort(graph):
          in_degree = compute_in_degree(graph)
          queue = [node for node in graph.nodes if in_degree[node] == 0]
          result = []
          
          while queue:
            node = queue.pop(0)
            result.append(node)
            
            for neighbor in node.dependencies:
              in_degree[neighbor] -= 1
              if in_degree[neighbor] == 0:
                queue.append(neighbor)
          
          if len(result) != len(graph.nodes):
            raise CycleDetectedError()
          
          return result
    
    # ç‰ˆæœ¬ç›¸å®¹æ€§æª¢æŸ¥
    version_compatibility:
      algorithm: "semver"
      description: "ä½¿ç”¨ Semantic Versioning æª¢æŸ¥ç‰ˆæœ¬ç›¸å®¹æ€§"
      implementation: |
        function is_compatible(required, available):
          req = parse_version(required)
          avail = parse_version(available)
          
          if req.operator == ">=":
            return avail >= req.version
          elif req.operator == "<=":
            return avail <= req.version
          elif req.operator == "==":
            return avail == req.version
          elif req.operator == "~":
            return avail.major == req.version.major and avail.minor == req.version.minor
          elif req.operator == "^":
            return avail.major == req.version.major

  # === é©—è­‰é…ç½® ===
  validation:
    enabled: true
    enforcement_level: "strict"
    
    execution_order:
      - "mutual_exclusion"
      - "dependency"
      - "state_consistency"
      - "resource_constraints"
      - "temporal_logic"
      - "permission_logic"
      - "compound_rules"
      - "conditional_rules"
      - "invariants"
    
    error_handling:
      on_logic_error: "block_pr"
      on_cycle_detected: "block_pr"
      on_invalid_state: "block_pr"
      on_constraint_violation: "block_pr"
      on_invariant_violation: "warning"
    
    reporting:
      format: "markdown"
      include_fix_suggestions: true
      show_violation_path: true

# === ç‹€æ…‹ ===
status:
  phase: "Active"
  conditions:
    - type: "Validated"
      status: "True"
      lastTransitionTime: "2025-12-21T02:00:00Z"
      reason: "SpecificationComplete"
      message: "Logic specification is complete and validated"
  
  statistics:
    total_categories: 6
    total_rules: 23
    total_algorithms: 3
    coverage: "100%"