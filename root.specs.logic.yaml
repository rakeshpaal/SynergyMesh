apiVersion: machinenativeops.io/v1
kind: RootLogicSpec
metadata:
  annotations:
    machinenativeops.io/description: Machine-verifiable logical consistency rules
      for root layer
    machinenativeops.io/enforcement: strict
    machinenativeops.io/last-modified: '2025-12-21T02:00:00Z'
  labels:
    machinenativeops.io/component: logic-spec
    machinenativeops.io/tier: specs
    machinenativeops.io/version: v1.0.0
  name: root-logic-specification
  namespace: machinenativenops
spec:
  compound_rules:
  - check: "FOR EACH module M:\n  M IN registry.modules AND\n  M.entrypoint != null\
      \ AND\n  ALL(D in M.dependencies: D.name IN registry.modules) AND\n  M.resources.cpu.request\
      \ <= M.resources.cpu.limit\n"
    conditions:
    - 模組必須存在於註冊表
    - 模組必須有有效的入口點
    - 模組的所有依賴必須可解析
    - 模組的資源配置必須合理
    description: 模組完整性檢查
    id: LOGIC-COMP-001
    severity: error
  - check: "FOR EACH module M1, M2:\n  IF M2 IN M1.dependencies THEN\n    M2.priority\
      \ >= M1.priority OR\n    M2.group == \"core\"\n"
    conditions:
    - 依賴的模組必須先啟動
    - 優先級高的模組應先啟動
    - 核心模組必須在應用模組之前啟動
    description: 啟動順序一致性
    id: LOGIC-COMP-002
    severity: error
  - check: "IF security.tls.enabled == true THEN\n  security.certificates != null\
      \ AND\n  security.trust_chain != null\n"
    conditions:
    - 啟用 TLS 時必須有證書配置
    - 啟用認證時必須有信任鏈
    - 敏感資料必須加密
    description: 安全配置一致性
    id: LOGIC-COMP-003
    severity: error
  conditional_rules:
  - condition: environment == 'production'
    description: 生產環境必須啟用安全功能
    id: LOGIC-COND-001
    requirements:
    - security.tls.enabled == true
    - security.authentication.enabled == true
    - audit.enabled == true
    severity: error
  - allowances:
    - security.tls.enabled may be false
    - debug.enabled may be true
    condition: environment == 'development'
    description: 開發環境可以放寬限制
    id: LOGIC-COND-002
    severity: info
  - condition: high_availability == true
    description: 高可用模式必須有備份配置
    id: LOGIC-COND-003
    requirements:
    - replicas >= 3
    - backup.enabled == true
    - failover.enabled == true
    severity: error
  invariants:
  - description: 模組總數不可超過限制
    id: LOGIC-INV-001
    invariant: COUNT(modules) <= 100
    scope: root.modules.yaml
    severity: warning
  - description: 依賴深度不可過深
    id: LOGIC-INV-002
    invariant: MAX_DEPTH(dependency_graph) <= 10
    scope: root.modules.yaml
    severity: warning
  - description: 配置檔案大小不可過大
    id: LOGIC-INV-003
    invariant: FILE_SIZE(root.*.yaml) <= 1MB
    scope: root.*.yaml
    severity: warning
  logic_categories:
    dependency:
      description: 定義依賴關係的邏輯約束
      rules:
      - check: "FOR EACH module M:\n  FOR EACH dependency D in M.dependencies:\n \
          \   EXISTS module M2 WHERE M2.name == D.name\n"
        description: 依賴的模組必須存在
        id: LOGIC-DEP-001
        scope: root.modules.yaml
        severity: error
      - algorithm: topological_sort
        check: NO_CYCLES(dependency_graph)
        description: 依賴不可形成循環
        id: LOGIC-DEP-002
        scope: root.modules.yaml
        severity: error
      - check: "FOR EACH module M:\n  FOR EACH dependency D in M.dependencies:\n \
          \   IF D.critical == true THEN D.optional == false\n"
        description: 必要依賴不可標記為可選
        id: LOGIC-DEP-003
        scope: root.modules.yaml
        severity: error
      - check: "FOR EACH module M:\n  FOR EACH dependency D in M.dependencies:\n \
          \   EXISTS version V WHERE V satisfies D.version_constraint\n"
        description: 版本依賴必須可滿足
        id: LOGIC-DEP-004
        scope: root.modules.yaml
        severity: error
    mutual_exclusion:
      description: 定義互斥的配置選項
      rules:
      - check: NOT (enabled == true AND enabled == false)
        description: 模組不可同時啟用和禁用
        id: LOGIC-MX-001
        scope: root.modules.yaml::modules[]
      - check: UNIQUE(modules[].port)
        description: 同一端口不可被多個服務使用
        id: LOGIC-MX-002
        scope: root.modules.yaml
      - check: UNIQUE(urns[].urn)
        description: 同一 URN 不可指向多個資源
        id: LOGIC-MX-003
        scope: root.registry.urns.yaml
    permission_logic:
      description: 定義權限相關的邏輯約束
      rules:
      - check: "FOR EACH role R:\n  LENGTH(R.permissions) > 0\n"
        description: 角色必須有至少一個權限
        id: LOGIC-PERM-001
        scope: root.governance.yaml
        severity: warning
      - check: "FOR EACH role R:\n  IF R.name == \"admin\" THEN R.permissions CONTAINS\
          \ \"*\"\n"
        description: 管理員角色必須有所有權限
        id: LOGIC-PERM-002
        scope: root.governance.yaml
        severity: error
      - check: "FOR EACH role R:\n  IF R.name CONTAINS \"readonly\" THEN\n    NOT\
          \ (R.permissions CONTAINS \"write\" OR R.permissions CONTAINS \"delete\"\
          )\n"
        description: 唯讀角色不可有寫入權限
        id: LOGIC-PERM-003
        scope: root.governance.yaml
        severity: error
    resource_constraints:
      description: 定義資源使用的邏輯約束
      rules:
      - check: "FOR EACH module M:\n  M.resources.cpu.request <= M.resources.cpu.limit\
          \ AND\n  M.resources.memory.request <= M.resources.memory.limit\n"
        description: 資源請求不可超過限制
        id: LOGIC-RES-001
        scope: root.modules.yaml
        severity: error
      - check: "FOR EACH module M:\n  0 <= M.priority <= 100\n"
        description: 優先級必須在有效範圍內
        id: LOGIC-RES-002
        scope: root.modules.yaml
        severity: error
      - check: "FOR EACH module M:\n  IF M.health_check.retries != null THEN M.health_check.retries\
          \ > 0\n"
        description: 重試次數必須為正數
        id: LOGIC-RES-003
        scope: root.modules.yaml
        severity: error
    state_consistency:
      description: 定義狀態之間的一致性約束
      rules:
      - check: "FOR EACH module M:\n  IF M.enabled == true THEN M.entrypoint != null\n"
        description: 啟用的模組必須有入口點
        id: LOGIC-STATE-001
        scope: root.modules.yaml
        severity: error
      - check: "FOR EACH module M:\n  IF M.auto_start == true THEN M.enabled == true\n"
        description: 自動啟動的模組必須已啟用
        id: LOGIC-STATE-002
        scope: root.modules.yaml
        severity: error
      - check: "FOR EACH module M:\n  IF M.health_check.enabled == true THEN M.health_check.endpoint\
          \ != null\n"
        description: 健康檢查必須有端點
        id: LOGIC-STATE-003
        scope: root.modules.yaml
        severity: error
      - check: "FOR EACH phase P1, P2 in bootstrap.phases:\n  IF P1.order < P2.order\
          \ THEN P1.sequence < P2.sequence\n"
        description: 階段順序必須遞增
        id: LOGIC-STATE-004
        scope: root.bootstrap.yaml
        severity: error
    temporal_logic:
      description: 定義時間相關的邏輯約束
      rules:
      - check: "FOR EACH module M:\n  IF M.health_check.timeout AND M.health_check.interval\
          \ THEN\n    parse_duration(M.health_check.timeout) > parse_duration(M.health_check.interval)\n"
        description: 超時時間必須大於間隔時間
        id: LOGIC-TIME-001
        scope: root.modules.yaml
        severity: warning
      - check: "FOR EACH certificate C:\n  C.valid_until > current_time()\n"
        description: 證書有效期必須在未來
        id: LOGIC-TIME-002
        scope: root.trust.yaml
        severity: error
      - check: "FOR EACH audit_config A:\n  1 <= A.retention_days <= 3650  # 1 day\
          \ to 10 years\n"
        description: 審計保留期必須合理
        id: LOGIC-TIME-003
        scope: root.provenance.yaml
        severity: warning
  validation:
    enabled: true
    enforcement_level: strict
    error_handling:
      on_constraint_violation: block_pr
      on_cycle_detected: block_pr
      on_invalid_state: block_pr
      on_invariant_violation: warning
      on_logic_error: block_pr
    execution_order:
    - mutual_exclusion
    - dependency
    - state_consistency
    - resource_constraints
    - temporal_logic
    - permission_logic
    - compound_rules
    - conditional_rules
    - invariants
    reporting:
      format: markdown
      include_fix_suggestions: true
      show_violation_path: true
  validation_algorithms:
    cycle_detection:
      algorithm: depth_first_search
      complexity: O(V + E)
      description: 使用 DFS 檢測依賴圖中的循環
      implementation: "function detect_cycle(graph):\n  visited = set()\n  rec_stack\
        \ = set()\n  \n  for node in graph.nodes:\n    if node not in visited:\n \
        \     if dfs(node, visited, rec_stack):\n        return true\n  return false\n\
        \nfunction dfs(node, visited, rec_stack):\n  visited.add(node)\n  rec_stack.add(node)\n\
        \  \n  for neighbor in node.dependencies:\n    if neighbor not in visited:\n\
        \      if dfs(neighbor, visited, rec_stack):\n        return true\n    elif\
        \ neighbor in rec_stack:\n      return true\n  \n  rec_stack.remove(node)\n\
        \  return false\n"
    topological_sort:
      algorithm: kahn
      complexity: O(V + E)
      description: 使用 Kahn 算法進行拓撲排序
      implementation: "function topological_sort(graph):\n  in_degree = compute_in_degree(graph)\n\
        \  queue = [node for node in graph.nodes if in_degree[node] == 0]\n  result\
        \ = []\n  \n  while queue:\n    node = queue.pop(0)\n    result.append(node)\n\
        \    \n    for neighbor in node.dependencies:\n      in_degree[neighbor] -=\
        \ 1\n      if in_degree[neighbor] == 0:\n        queue.append(neighbor)\n\
        \  \n  if len(result) != len(graph.nodes):\n    raise CycleDetectedError()\n\
        \  \n  return result\n"
    version_compatibility:
      algorithm: semver
      description: 使用 Semantic Versioning 檢查版本相容性
      implementation: "function is_compatible(required, available):\n  req = parse_version(required)\n\
        \  avail = parse_version(available)\n  \n  if req.operator == \">=\":\n  \
        \  return avail >= req.version\n  elif req.operator == \"<=\":\n    return\
        \ avail <= req.version\n  elif req.operator == \"==\":\n    return avail ==\
        \ req.version\n  elif req.operator == \"~\":\n    return avail.major == req.version.major\
        \ and avail.minor == req.version.minor\n  elif req.operator == \"^\":\n  \
        \  return avail.major == req.version.major\n"
  version: 1
status:
  conditions:
  - lastTransitionTime: '2025-12-21T02:00:00Z'
    message: Logic specification is complete and validated
    reason: SpecificationComplete
    status: 'True'
    type: Validated
  phase: Active
  statistics:
    coverage: 100%
    total_algorithms: 3
    total_categories: 6
    total_rules: 23
