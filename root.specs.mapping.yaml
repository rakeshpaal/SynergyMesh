# ğŸ—ºï¸ Root Layer Mapping Specification
# Version: 1.0.0
# Scope: All mapping relationships in root layer
# Enforcement: Strict (GitHub Actions gate-root-specs.yml)

apiVersion: machinenativeops.io/v1
kind: RootMappingSpec
metadata:
  name: root-mapping-specification
  namespace: machinenativeops-specs
  labels:
    machinenativeops.io/tier: "specs"
    machinenativeops.io/version: "v1.0.0"
    machinenativeops.io/component: "mapping-spec"
  annotations:
    machinenativeops.io/description: "Machine-verifiable mapping conventions for root layer"
    machinenativeops.io/enforcement: "strict"
    machinenativeops.io/last-modified: "2025-12-21T02:00:00Z"

spec:
  version: 1
  
  # === æ˜ å°„é¡å‹å®šç¾© ===
  mapping_types:
    # 1. æ¨¡çµ„æ˜ å°„
    module_mapping:
      description: "æ¨¡çµ„åç¨±èˆ‡æª”æ¡ˆç³»çµ±çš„æ˜ å°„é—œä¿‚"
      source: "root.registry.modules.yaml"
      targets:
        - type: "file_path"
          pattern: "/opt/machinenativenops/modules/{module_name}/"
        - type: "config_file"
          pattern: "config/{module_name}.yaml"
        - type: "log_file"
          pattern: "/var/log/machinenativenops/{module_name}.log"
      validation:
        - "æ¨¡çµ„åç¨±å¿…é ˆå”¯ä¸€"
        - "æª”æ¡ˆè·¯å¾‘å¿…é ˆå­˜åœ¨æ–¼ root.fs.map"
        - "é…ç½®æª”æ¡ˆå¿…é ˆå­˜åœ¨"
      examples:
        - module_name: "governance-engine"
          file_path: "/opt/machinenativenops/modules/governance-engine/"
          config_file: "config/governance-engine.yaml"
          log_file: "/var/log/machinenativenops/governance-engine.log"
    
    # 2. URN æ˜ å°„
    urn_mapping:
      description: "URN èˆ‡å¯¦éš›è³‡æºçš„æ˜ å°„é—œä¿‚"
      source: "root.registry.urns.yaml"
      format: "urn:machinenativeops:{type}:{identifier}"
      targets:
        - type: "module"
          registry: "root.registry.modules.yaml"
        - type: "service"
          registry: "root.registry.modules.yaml"
        - type: "config"
          registry: "root.*.yaml"
        - type: "policy"
          registry: "root.governance.yaml"
      validation:
        - "URN å¿…é ˆå”¯ä¸€"
        - "ç›®æ¨™è³‡æºå¿…é ˆå­˜åœ¨"
        - "é¡å‹å¿…é ˆåŒ¹é…"
      examples:
        - urn: "urn:machinenativeops:module:governance-engine"
          target_type: "module"
          target_registry: "root.registry.modules.yaml"
          target_key: "modules[name=governance-engine]"
    
    # 3. è¨­å‚™æ˜ å°„
    device_mapping:
      description: "è¨­å‚™æª”æ¡ˆèˆ‡ç³»çµ±è³‡æºçš„æ˜ å°„"
      source: "root.devices.map"
      format: "{device_path} -> {resource_type}:{resource_id}"
      categories:
        - "block_devices"
        - "character_devices"
        - "network_devices"
        - "virtual_devices"
      validation:
        - "è¨­å‚™è·¯å¾‘å¿…é ˆä»¥ /dev/ é–‹é ­"
        - "è³‡æºé¡å‹å¿…é ˆæœ‰æ•ˆ"
        - "ä¸å¯é‡è¤‡æ˜ å°„"
      examples:
        - device_path: "/dev/sda1"
          resource_type: "block"
          resource_id: "primary_storage"
    
    # 4. æª”æ¡ˆç³»çµ±æ˜ å°„
    filesystem_mapping:
      description: "ç›®éŒ„çµæ§‹èˆ‡ç”¨é€”çš„æ˜ å°„"
      source: "root.fs.map"
      format: "{directory_path} -> {purpose}:{description}"
      categories:
        - "system_directories"
        - "application_directories"
        - "data_directories"
        - "log_directories"
      validation:
        - "ç›®éŒ„è·¯å¾‘å¿…é ˆçµ•å°è·¯å¾‘"
        - "ç”¨é€”å¿…é ˆæ˜ç¢ºå®šç¾©"
        - "ä¸å¯é‡è¤‡æ˜ å°„"
      examples:
        - directory_path: "/opt/machinenativenops"
          purpose: "application"
          description: "MachineNativeOps application root"
    
    # 5. æ ¸å¿ƒæ¨¡çµ„æ˜ å°„
    kernel_mapping:
      description: "æ ¸å¿ƒæ¨¡çµ„èˆ‡åŠŸèƒ½çš„æ˜ å°„"
      source: "root.kernel.map"
      format: "{module_name} -> {function}:{description}"
      categories:
        - "core_modules"
        - "driver_modules"
        - "filesystem_modules"
        - "network_modules"
      validation:
        - "æ¨¡çµ„åç¨±å¿…é ˆæœ‰æ•ˆ"
        - "åŠŸèƒ½æè¿°å¿…é ˆæ¸…æ™°"
      examples:
        - module_name: "machinenativeops_core"
          function: "core"
          description: "MachineNativeOps core functionality"

  # === æ˜ å°„è¦å‰‡ ===
  mapping_rules:
    - id: "MAP-001"
      description: "æ¨¡çµ„åç¨±å¿…é ˆèˆ‡æª”æ¡ˆè·¯å¾‘ä¸€è‡´"
      severity: "error"
      check: |
        å°æ–¼æ¯å€‹æ¨¡çµ„ Mï¼š
        - M.name å¿…é ˆå‡ºç¾åœ¨ M.entrypoint è·¯å¾‘ä¸­
        - è·¯å¾‘æ ¼å¼ï¼š/opt/machinenativenops/modules/{M.name}/
      examples:
        valid:
          - name: "governance-engine"
            entrypoint: "/opt/machinenativenops/modules/governance-engine/main.py"
        invalid:
          - name: "governance-engine"
            entrypoint: "/opt/machinenativenops/modules/governance/main.py"
    
    - id: "MAP-002"
      description: "URN å¿…é ˆæ˜ å°„åˆ°å”¯ä¸€è³‡æº"
      severity: "error"
      check: |
        å°æ–¼æ¯å€‹ URN Uï¼š
        - U åªèƒ½æ˜ å°„åˆ°ä¸€å€‹è³‡æº
        - è³‡æºå¿…é ˆå­˜åœ¨æ–¼å°æ‡‰çš„è¨»å†Šè¡¨ä¸­
      
    - id: "MAP-003"
      description: "é…ç½®æª”æ¡ˆåç¨±å¿…é ˆèˆ‡æ¨¡çµ„åç¨±ä¸€è‡´"
      severity: "warning"
      check: |
        å°æ–¼æ¯å€‹æ¨¡çµ„ Mï¼š
        - å¦‚æœå­˜åœ¨é…ç½®æª”æ¡ˆï¼Œæª”åæ‡‰ç‚º {M.name}.yaml
        - é…ç½®æª”æ¡ˆæ‡‰ä½æ–¼ config/ ç›®éŒ„
      examples:
        valid:
          - module: "governance-engine"
            config: "config/governance-engine.yaml"
        invalid:
          - module: "governance-engine"
            config: "config/governance.yaml"
    
    - id: "MAP-004"
      description: "æ—¥èªŒæª”æ¡ˆè·¯å¾‘å¿…é ˆéµå¾ªæ¨™æº–æ ¼å¼"
      severity: "warning"
      check: |
        å°æ–¼æ¯å€‹æ¨¡çµ„ Mï¼š
        - æ—¥èªŒæª”æ¡ˆæ‡‰ä½æ–¼ /var/log/machinenativenops/
        - æª”åæ ¼å¼ï¼š{M.name}.log
      examples:
        valid:
          - module: "governance-engine"
            log: "/var/log/machinenativenops/governance-engine.log"
    
    - id: "MAP-005"
      description: "è¨­å‚™æ˜ å°„ä¸å¯é‡è¤‡"
      severity: "error"
      check: |
        å°æ–¼æ‰€æœ‰è¨­å‚™æ˜ å°„ï¼š
        - åŒä¸€è¨­å‚™è·¯å¾‘åªèƒ½æ˜ å°„ä¸€æ¬¡
        - åŒä¸€è³‡æº ID åªèƒ½è¢«ä¸€å€‹è¨­å‚™æ˜ å°„
    
    - id: "MAP-006"
      description: "ç›®éŒ„æ˜ å°„å¿…é ˆå”¯ä¸€ä¸”ä¸é‡ç–Š"
      severity: "error"
      check: |
        å°æ–¼æ‰€æœ‰ç›®éŒ„æ˜ å°„ï¼š
        - åŒä¸€ç›®éŒ„è·¯å¾‘åªèƒ½æ˜ å°„ä¸€æ¬¡
        - å­ç›®éŒ„æ˜ å°„ä¸å¯èˆ‡çˆ¶ç›®éŒ„æ˜ å°„è¡çª

  # === æ˜ å°„å®Œæ•´æ€§æª¢æŸ¥ ===
  integrity_checks:
    # 1. é›™å‘æ˜ å°„ä¸€è‡´æ€§
    bidirectional_consistency:
      enabled: true
      description: "é©—è­‰æ­£å‘å’Œåå‘æ˜ å°„çš„ä¸€è‡´æ€§"
      checks:
        - name: "module_to_path"
          forward: "module_name -> file_path"
          reverse: "file_path -> module_name"
          validation: "forward(reverse(x)) == x"
        
        - name: "urn_to_resource"
          forward: "urn -> resource"
          reverse: "resource -> urn"
          validation: "forward(reverse(x)) == x"
    
    # 2. æ˜ å°„è¦†è“‹ç‡
    coverage:
      enabled: true
      description: "é©—è­‰æ‰€æœ‰è³‡æºéƒ½æœ‰å°æ‡‰çš„æ˜ å°„"
      checks:
        - resource_type: "modules"
          required_mappings:
            - "file_path"
            - "config_file"
            - "log_file"
          coverage_threshold: 100
        
        - resource_type: "services"
          required_mappings:
            - "urn"
            - "endpoint"
          coverage_threshold: 100
    
    # 3. æ˜ å°„å”¯ä¸€æ€§
    uniqueness:
      enabled: true
      description: "é©—è­‰æ˜ å°„çš„å”¯ä¸€æ€§"
      checks:
        - mapping_type: "urn"
          constraint: "unique"
          scope: "global"
        
        - mapping_type: "module_name"
          constraint: "unique"
          scope: "global"
        
        - mapping_type: "device_path"
          constraint: "unique"
          scope: "global"
    
    # 4. æ˜ å°„æœ‰æ•ˆæ€§
    validity:
      enabled: true
      description: "é©—è­‰æ˜ å°„ç›®æ¨™çš„æœ‰æ•ˆæ€§"
      checks:
        - mapping_type: "file_path"
          validation: "path_exists_in_fs_map"
        
        - mapping_type: "urn"
          validation: "target_exists_in_registry"
        
        - mapping_type: "module_ref"
          validation: "module_exists_in_registry"

  # === æ˜ å°„è¡çªè§£æ±º ===
  conflict_resolution:
    # å„ªå…ˆç´šè¦å‰‡
    priority_rules:
      - source: "root.registry.modules.yaml"
        priority: 1
        description: "æ¨¡çµ„è¨»å†Šè¡¨å…·æœ‰æœ€é«˜å„ªå…ˆç´š"
      
      - source: "root.registry.urns.yaml"
        priority: 2
        description: "URN è¨»å†Šè¡¨æ¬¡ä¹‹"
      
      - source: "root.*.yaml"
        priority: 3
        description: "å…¶ä»–é…ç½®æª”æ¡ˆ"
    
    # è¡çªè™•ç†ç­–ç•¥
    strategies:
      duplicate_mapping:
        action: "error"
        message: "æª¢æ¸¬åˆ°é‡è¤‡æ˜ å°„ï¼Œè«‹è§£æ±ºè¡çª"
      
      ambiguous_mapping:
        action: "warning"
        message: "æ˜ å°„ä¸æ˜ç¢ºï¼Œå»ºè­°æ˜ç¢ºæŒ‡å®š"
      
      missing_mapping:
        action: "error"
        message: "ç¼ºå°‘å¿…è¦çš„æ˜ å°„é—œä¿‚"

  # === æ˜ å°„æœ€ä½³å¯¦è¸ ===
  best_practices:
    - id: "BP-MAP-001"
      title: "ä¿æŒæ˜ å°„ä¸€è‡´æ€§"
      description: "åŒä¸€è³‡æºåœ¨ä¸åŒæ˜ å°„ä¸­çš„åç¨±æ‡‰ä¿æŒä¸€è‡´"
      rationale: "é¿å…æ··æ·†å’ŒéŒ¯èª¤"
      
    - id: "BP-MAP-002"
      title: "ä½¿ç”¨æè¿°æ€§æ˜ å°„éµ"
      description: "æ˜ å°„éµæ‡‰æ¸…æ™°æè¿°æ˜ å°„é—œä¿‚"
      rationale: "æé«˜å¯è®€æ€§"
      
    - id: "BP-MAP-003"
      title: "æ–‡æª”åŒ–è¤‡é›œæ˜ å°„"
      description: "è¤‡é›œçš„æ˜ å°„é—œä¿‚æ‡‰åœ¨è¨»è§£ä¸­èªªæ˜"
      rationale: "ä¾¿æ–¼ç†è§£å’Œç¶­è­·"
      
    - id: "BP-MAP-004"
      title: "å®šæœŸé©—è­‰æ˜ å°„"
      description: "å®šæœŸåŸ·è¡Œæ˜ å°„å®Œæ•´æ€§æª¢æŸ¥"
      rationale: "åŠæ—©ç™¼ç¾å•é¡Œ"

  # === é©—è­‰é…ç½® ===
  validation:
    enabled: true
    enforcement_level: "strict"
    
    checks:
      - name: "consistency_check"
        enabled: true
        description: "é©—è­‰æ˜ å°„ä¸€è‡´æ€§"
      
      - name: "coverage_check"
        enabled: true
        description: "é©—è­‰æ˜ å°„è¦†è“‹ç‡"
      
      - name: "uniqueness_check"
        enabled: true
        description: "é©—è­‰æ˜ å°„å”¯ä¸€æ€§"
      
      - name: "validity_check"
        enabled: true
        description: "é©—è­‰æ˜ å°„æœ‰æ•ˆæ€§"
    
    error_handling:
      on_inconsistency: "block_pr"
      on_incomplete_coverage: "warning"
      on_duplicate: "block_pr"
      on_invalid_target: "block_pr"

# === ç‹€æ…‹ ===
status:
  phase: "Active"
  conditions:
    - type: "Validated"
      status: "True"
      lastTransitionTime: "2025-12-21T02:00:00Z"
      reason: "SpecificationComplete"
      message: "Mapping specification is complete and validated"
  
  statistics:
    total_mapping_types: 5
    total_rules: 6
    total_checks: 4
    coverage: "100%"