apiVersion: machinenativeops.io/v1
kind: RootMappingSpec
metadata:
  annotations:
    machinenativeops.io/description: Machine-verifiable mapping conventions for root
      layer
    machinenativeops.io/enforcement: strict
    machinenativeops.io/last-modified: '2025-12-21T02:00:00Z'
  labels:
    machinenativeops.io/component: mapping-spec
    machinenativeops.io/tier: specs
    machinenativeops.io/version: v1.0.0
  name: root-mapping-specification
  namespace: machinenativenops
spec:
  best_practices:
  - description: 同一資源在不同映射中的名稱應保持一致
    id: BP-MAP-001
    rationale: 避免混淆和錯誤
    title: 保持映射一致性
  - description: 映射鍵應清晰描述映射關係
    id: BP-MAP-002
    rationale: 提高可讀性
    title: 使用描述性映射鍵
  - description: 複雜的映射關係應在註解中說明
    id: BP-MAP-003
    rationale: 便於理解和維護
    title: 文檔化複雜映射
  - description: 定期執行映射完整性檢查
    id: BP-MAP-004
    rationale: 及早發現問題
    title: 定期驗證映射
  conflict_resolution:
    priority_rules:
    - description: 模組註冊表具有最高優先級
      priority: 1
      source: root.registry.modules.yaml
    - description: URN 註冊表次之
      priority: 2
      source: root.registry.urns.yaml
    - description: 其他配置檔案
      priority: 3
      source: root.*.yaml
    strategies:
      ambiguous_mapping:
        action: warning
        message: 映射不明確，建議明確指定
      duplicate_mapping:
        action: error
        message: 檢測到重複映射，請解決衝突
      missing_mapping:
        action: error
        message: 缺少必要的映射關係
  integrity_checks:
    bidirectional_consistency:
      checks:
      - forward: module_name -> file_path
        name: module_to_path
        reverse: file_path -> module_name
        validation: forward(reverse(x)) == x
      - forward: urn -> resource
        name: urn_to_resource
        reverse: resource -> urn
        validation: forward(reverse(x)) == x
      description: 驗證正向和反向映射的一致性
      enabled: true
    coverage:
      checks:
      - coverage_threshold: 100
        required_mappings:
        - file_path
        - config_file
        - log_file
        resource_type: modules
      - coverage_threshold: 100
        required_mappings:
        - urn
        - endpoint
        resource_type: services
      description: 驗證所有資源都有對應的映射
      enabled: true
    uniqueness:
      checks:
      - constraint: unique
        mapping_type: urn
        scope: global
      - constraint: unique
        mapping_type: module_name
        scope: global
      - constraint: unique
        mapping_type: device_path
        scope: global
      description: 驗證映射的唯一性
      enabled: true
    validity:
      checks:
      - mapping_type: file_path
        validation: path_exists_in_fs_map
      - mapping_type: urn
        validation: target_exists_in_registry
      - mapping_type: module_ref
        validation: module_exists_in_registry
      description: 驗證映射目標的有效性
      enabled: true
  mapping_rules:
  - check: '對於每個模組 M：

      - M.name 必須出現在 M.entrypoint 路徑中

      - 路徑格式：/opt/machinenativenops/modules/{M.name}/

      '
    description: 模組名稱必須與檔案路徑一致
    examples:
      invalid:
      - entrypoint: /opt/machinenativenops/modules/governance/main.py
        name: governance-engine
      valid:
      - entrypoint: /opt/machinenativenops/modules/governance-engine/main.py
        name: governance-engine
    id: MAP-001
    severity: error
  - check: '對於每個 URN U：

      - U 只能映射到一個資源

      - 資源必須存在於對應的註冊表中

      '
    description: URN 必須映射到唯一資源
    id: MAP-002
    severity: error
  - check: '對於每個模組 M：

      - 如果存在配置檔案，檔名應為 {M.name}.yaml

      - 配置檔案應位於 config/ 目錄

      '
    description: 配置檔案名稱必須與模組名稱一致
    examples:
      invalid:
      - config: config/governance.yaml
        module: governance-engine
      valid:
      - config: config/governance-engine.yaml
        module: governance-engine
    id: MAP-003
    severity: warning
  - check: '對於每個模組 M：

      - 日誌檔案應位於 /var/log/machinenativenops/

      - 檔名格式：{M.name}.log

      '
    description: 日誌檔案路徑必須遵循標準格式
    examples:
      valid:
      - log: /var/log/machinenativenops/governance-engine.log
        module: governance-engine
    id: MAP-004
    severity: warning
  - check: '對於所有設備映射：

      - 同一設備路徑只能映射一次

      - 同一資源 ID 只能被一個設備映射

      '
    description: 設備映射不可重複
    id: MAP-005
    severity: error
  - check: '對於所有目錄映射：

      - 同一目錄路徑只能映射一次

      - 子目錄映射不可與父目錄映射衝突

      '
    description: 目錄映射必須唯一且不重疊
    id: MAP-006
    severity: error
  mapping_types:
    device_mapping:
      categories:
      - block_devices
      - character_devices
      - network_devices
      - virtual_devices
      description: 設備檔案與系統資源的映射
      examples:
      - device_path: /dev/sda1
        resource_id: primary_storage
        resource_type: block
      format: '{device_path} -> {resource_type}:{resource_id}'
      source: root.devices.map
      validation:
      - 設備路徑必須以 /dev/ 開頭
      - 資源類型必須有效
      - 不可重複映射
    filesystem_mapping:
      categories:
      - system_directories
      - application_directories
      - data_directories
      - log_directories
      description: 目錄結構與用途的映射
      examples:
      - description: MachineNativeOps application root
        directory_path: /opt/machinenativenops
        purpose: application
      format: '{directory_path} -> {purpose}:{description}'
      source: root.fs.map
      validation:
      - 目錄路徑必須絕對路徑
      - 用途必須明確定義
      - 不可重複映射
    kernel_mapping:
      categories:
      - core_modules
      - driver_modules
      - filesystem_modules
      - network_modules
      description: 核心模組與功能的映射
      examples:
      - description: MachineNativeOps core functionality
        function: core
        module_name: machinenativeops_core
      format: '{module_name} -> {function}:{description}'
      source: root.kernel.map
      validation:
      - 模組名稱必須有效
      - 功能描述必須清晰
    module_mapping:
      description: 模組名稱與檔案系統的映射關係
      examples:
      - config_file: config/governance-engine.yaml
        file_path: /opt/machinenativenops/modules/governance-engine/
        log_file: /var/log/machinenativenops/governance-engine.log
        module_name: governance-engine
      source: root.registry.modules.yaml
      targets:
      - pattern: /opt/machinenativenops/modules/{module_name}/
        type: file_path
      - pattern: config/{module_name}.yaml
        type: config_file
      - pattern: /var/log/machinenativenops/{module_name}.log
        type: log_file
      validation:
      - 模組名稱必須唯一
      - 檔案路徑必須存在於 root.fs.map
      - 配置檔案必須存在
    urn_mapping:
      description: URN 與實際資源的映射關係
      examples:
      - target_key: modules[name=governance-engine]
        target_registry: root.registry.modules.yaml
        target_type: module
        urn: urn:machinenativeops:module:governance-engine
      format: urn:machinenativeops:{type}:{identifier}
      source: root.registry.urns.yaml
      targets:
      - registry: root.registry.modules.yaml
        type: module
      - registry: root.registry.modules.yaml
        type: service
      - registry: root.*.yaml
        type: config
      - registry: root.governance.yaml
        type: policy
      validation:
      - URN 必須唯一
      - 目標資源必須存在
      - 類型必須匹配
  validation:
    checks:
    - description: 驗證映射一致性
      enabled: true
      name: consistency_check
    - description: 驗證映射覆蓋率
      enabled: true
      name: coverage_check
    - description: 驗證映射唯一性
      enabled: true
      name: uniqueness_check
    - description: 驗證映射有效性
      enabled: true
      name: validity_check
    enabled: true
    enforcement_level: strict
    error_handling:
      on_duplicate: block_pr
      on_incomplete_coverage: warning
      on_inconsistency: block_pr
      on_invalid_target: block_pr
  version: 1
status:
  conditions:
  - lastTransitionTime: '2025-12-21T02:00:00Z'
    message: Mapping specification is complete and validated
    reason: SpecificationComplete
    status: 'True'
    type: Validated
  phase: Active
  statistics:
    coverage: 100%
    total_checks: 4
    total_mapping_types: 5
    total_rules: 6
