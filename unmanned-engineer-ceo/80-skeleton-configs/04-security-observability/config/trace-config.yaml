# OpenTelemetry Tracing Configuration
version: 1.0.0

# 追蹤導出器配置
exporters:
  otlp:
    endpoint: "http://otel-collector:4317"
    protocol: grpc
    compression: gzip
    timeout: 10s
    retry:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

# 資源屬性
resource:
  service.name: "${SERVICE_NAME}"
  service.version: "${SERVICE_VERSION}"
  deployment.environment: "${ENVIRONMENT}"
  cloud.provider: "${CLOUD_PROVIDER:-unknown}"
  cloud.region: "${CLOUD_REGION:-unknown}"

# 取樣策略
sampling:
  # 預設取樣率
  default:
    type: parent_based_trace_id_ratio
    ratio: 0.1  # 10%
  
  # 規則型取樣
  rules:
    # 錯誤請求全部追蹤
    - condition:
        attribute: http.status_code
        operator: gte
        value: 500
      sampler:
        type: always_on
    
    # 健康檢查低取樣
    - condition:
        attribute: http.url.path
        operator: equals
        value: /health
      sampler:
        type: trace_id_ratio
        ratio: 0.01  # 1%
    
    # 關鍵 API 高取樣
    - condition:
        attribute: http.url.path
        operator: starts_with
        value: /api/v1/critical
      sampler:
        type: trace_id_ratio
        ratio: 0.5  # 50%

# Span 處理器
span_processors:
  - type: batch
    config:
      max_queue_size: 2048
      schedule_delay: 5s
      export_timeout: 30s
      max_export_batch_size: 512

# 必須的 Span 屬性
required_attributes:
  - service.name
  - service.version
  - deployment.environment
  - trace.id
  - span.id

# 敏感屬性過濾
attribute_filters:
  # 移除敏感資訊
  exclude:
    - http.request.header.authorization
    - http.request.header.cookie
    - http.request.body
    - db.statement  # 可能包含敏感資料
  
  # 遮罩處理
  mask:
    - attribute: user.email
      pattern: "(.{3}).*(@.*)"
      replacement: "$1***$2"
    
    - attribute: user.phone
      pattern: "(.{3}).*(.{4})"
      replacement: "$1***$2"

# Instrumentation 配置
instrumentations:
  http:
    enabled: true
    capture_headers: true
    capture_body: false
  
  database:
    enabled: true
    capture_statement: false  # 安全考量
    capture_statement_hash: true
  
  grpc:
    enabled: true
  
  redis:
    enabled: true
  
  message_queue:
    enabled: true