apiVersion: machinenativeops.io/v1
kind: RootContextSpec
metadata:
  annotations:
    machinenativeops.io/description: Machine-verifiable context consistency rules
      for root layer
    machinenativeops.io/enforcement: strict
    machinenativeops.io/last-modified: '2025-12-21T02:00:00Z'
  labels:
    machinenativeops.io/component: context-spec
    machinenativeops.io/tier: specs
    machinenativeops.io/version: v1.0.0
  name: root-context-specification
  namespace: machinenativenops
spec:
  consistency_rules:
    api_version_context:
    - check: "FOR EACH file F:\n  api_versions = [R.apiVersion for R in F.resources]\n\
        \  ASSERT len(set(api_versions)) == 1\n"
      description: 同一檔案內的 API 版本必須一致
      id: CTX-API-001
      severity: error
    - check: "FOR EACH resource R with previous_version P:\n  ASSERT R.apiVersion\
        \ is_backward_compatible_with P.apiVersion\n"
      description: API 版本必須向後相容
      id: CTX-API-002
      severity: error
    environment_context:
    - check: 'environments = [R.spec.environment for R in all_resources]

        ASSERT len(set(environments)) == 1

        '
      description: 所有配置必須使用相同環境
      id: CTX-ENV-001
      severity: error
    - check: "IF environment == \"production\":\n  FOR EACH module M:\n    ASSERT\
        \ M.version matches \"^\\\\d+\\\\.\\\\d+\\\\.\\\\d+$\"  # No pre-release\n"
      description: 生產環境必須使用穩定版本
      id: CTX-ENV-002
      severity: error
    - check: "IF environment == \"development\":\n  FOR EACH module M:\n    M.version\
        \ may include \"-alpha\", \"-beta\", \"-rc\"\n"
      description: 開發環境可以使用預發布版本
      id: CTX-ENV-003
      severity: info
    label_context:
    - check: "FOR EACH resource R:\n  label_version = R.metadata.labels[\"machinenativeops.io/version\"\
        ]\n  spec_version = R.spec.version\n  ASSERT normalize_version(label_version)\
        \ == normalize_version(spec_version)\n"
      description: 版本標籤必須與實際版本一致
      id: CTX-LABEL-001
      severity: error
    - check: "FOR EACH resource R:\n  component = R.metadata.labels[\"machinenativeops.io/component\"\
        ]\n  name = R.metadata.name\n  ASSERT component in name OR name in component\n"
      description: 組件標籤必須與資源名稱相關
      id: CTX-LABEL-002
      severity: warning
    - check: "FOR EACH resource R in file F:\n  tier = R.metadata.labels[\"machinenativeops.io/tier\"\
        ]\n  ASSERT tier matches F.category\n"
      description: 層級標籤必須與檔案位置一致
      id: CTX-LABEL-003
      severity: error
    module_context:
    - check: "FOR EACH module M:\n  name_in_registry = registry.modules[M.id].name\n\
        \  name_in_modules = modules.yaml[M.id].name\n  name_in_bootstrap = bootstrap.yaml[M.id].name\n\
        \  ASSERT name_in_registry == name_in_modules == name_in_bootstrap\n"
      description: 模組名稱在所有檔案中必須一致
      files:
      - root.registry.modules.yaml
      - root.modules.yaml
      - root.bootstrap.yaml
      id: CTX-MOD-001
      severity: error
    - check: "FOR EACH module M:\n  FOR EACH reference R to M:\n    ASSERT R.version\
        \ is_compatible_with M.version\n"
      description: 模組版本在所有引用中必須相容
      id: CTX-MOD-002
      severity: error
    - check: "FOR EACH module M:\n  descriptions = [M.description in each file]\n\
        \  ASSERT all_similar(descriptions, threshold=0.8)\n"
      description: 模組描述在不同檔案中應一致
      id: CTX-MOD-003
      severity: warning
    namespace_context:
    - check: "FOR EACH resource_type T:\n  namespaces = [R.metadata.namespace for\
        \ R in resources of type T]\n  ASSERT len(set(namespaces)) == 1\n"
      description: 同類資源應使用相同命名空間
      id: CTX-NS-001
      severity: warning
    - check: "FOR EACH resource R:\n  ns = R.metadata.namespace\n  ASSERT ns matches\
        \ \"^machinenativenops-[a-z][a-z0-9-]*$\"\n"
      description: 命名空間必須遵循命名規範
      id: CTX-NS-002
      severity: error
  context_keys:
    core_keys:
    - authoritative_source: root.registry.modules.yaml
      description: 模組唯一識別符
      immutable: true
      key: module_id
      pattern: ^[a-z][a-z0-9-]*[a-z0-9]$
      scope: global
      type: string
    - consistency_rule: 同一 module_id 的 name 必須一致
      description: 資源名稱
      immutable: false
      key: name
      pattern: ^[a-z][a-z0-9-]*[a-z0-9]$
      scope: per_resource_type
      type: string
    - consistency_rule: 同一模組在不同檔案中的版本必須一致
      description: 版本號
      immutable: false
      key: version
      pattern: ^\d+\.\d+\.\d+$
      scope: per_module
      type: string
    - consistency_rule: 同一資源類型應使用相同命名空間
      description: 命名空間
      immutable: true
      key: namespace
      pattern: ^[a-z][a-z0-9-]*$
      scope: per_resource
      type: string
    - consistency_rule: 同一檔案內的 apiVersion 必須一致
      description: API 版本
      immutable: false
      key: apiVersion
      pattern: ^[a-z0-9.-]+/v\d+$
      scope: per_file
      type: string
    - consistency_rule: kind 必須與檔案類型匹配
      description: 資源類型
      immutable: true
      key: kind
      pattern: ^Root[A-Z][a-zA-Z0-9]*$
      scope: per_resource
      type: string
    environment_keys:
    - allowed_values:
      - development
      - staging
      - production
      consistency_rule: 所有配置必須使用相同環境
      description: 環境類型
      key: environment
      scope: global
      type: string
    - consistency_rule: 同一環境的所有資源應在相同區域
      description: 部署區域
      key: region
      pattern: ^[a-z]{2}-[a-z]+-\d+$
      scope: global
      type: string
    label_keys:
    - allowed_values:
      - core
      - modules
      - specs
      - security
      - monitoring
      consistency_rule: 同一模組在不同檔案中的 tier 必須一致
      description: 層級標籤
      key: machinenativeops.io/tier
      type: string
    - consistency_rule: 必須與 spec.version 一致
      description: 版本標籤
      key: machinenativeops.io/version
      pattern: ^v\d+\.\d+\.\d+$
      type: string
    - consistency_rule: 必須與資源名稱相關
      description: 組件標籤
      key: machinenativeops.io/component
      pattern: ^[a-z][a-z0-9-]*$
      type: string
  drift_detection:
    config_drift:
      checks:
      - context: resource_limits
        sources:
        - root.modules.yaml::spec.modules[].resources
        - root.config.yaml::spec.defaults.resources
        tolerance: 10%
      description: 檢測配置值不一致
      enabled: true
    name_drift:
      checks:
      - context: module_name
        sources:
        - root.registry.modules.yaml::modules[].name
        - root.modules.yaml::spec.modules[].name
        - root.bootstrap.yaml::spec.phases[].modules[]
        tolerance: 0
      - context: service_name
        sources:
        - root.modules.yaml::spec.modules[].name
        - root.super-execution.yaml::spec.flows[].steps[].service
        tolerance: 0
      description: 檢測同一概念在不同地方使用不同名稱
      enabled: true
    semantic_drift:
      checks:
      - context: module_description
        similarity_threshold: 0.8
        sources:
        - root.registry.modules.yaml::modules[].description
        - root.modules.yaml::spec.modules[].description
      description: 檢測語意不一致
      enabled: true
    version_drift:
      checks:
      - context: module_version
        sources:
        - root.registry.modules.yaml::modules[].version
        - root.modules.yaml::spec.modules[].version
        tolerance: minor
      - context: api_version
        sources:
        - root.*.yaml::apiVersion
        tolerance: 0
      description: 檢測版本號不一致
      enabled: true
  isolation_rules:
  - contexts:
    - development
    - staging
    - production
    description: 不同環境的配置必須隔離
    id: CTX-ISO-001
    isolation_level: strict
    shared_contexts: []
  - contexts:
    - machinenativenops-core
    - machinenativenops-modules
    - machinenativenops-specs
    description: 不同命名空間的資源必須隔離
    id: CTX-ISO-002
    isolation_level: moderate
    shared_contexts:
    - global_config
  - contexts:
    - test_data
    - production_data
    description: 測試和生產資料必須隔離
    id: CTX-ISO-003
    isolation_level: strict
    shared_contexts: []
  propagation_rules:
  - description: 模組註冊表是模組資訊的唯一事實來源
    id: CTX-PROP-001
    propagated_fields:
    - name
    - version
    - description
    source: root.registry.modules.yaml
    targets:
    - root.modules.yaml
    - root.bootstrap.yaml
    - root.super-execution.yaml
    update_strategy: authoritative
  - description: URN 註冊表是引用的唯一事實來源
    id: CTX-PROP-002
    propagated_fields:
    - urn
    - target_type
    - target_id
    source: root.registry.urns.yaml
    targets:
    - root.*.yaml
    update_strategy: authoritative
  - description: 全域配置傳播到所有模組
    id: CTX-PROP-003
    propagated_fields:
    - environment
    - region
    - log_level
    source: root.config.yaml
    targets:
    - root.modules.yaml::spec.modules[]
    update_strategy: default_with_override
  validation:
    checks:
    - description: 驗證上下文一致性
      enabled: true
      name: consistency_check
    - description: 檢測上下文漂移
      enabled: true
      name: drift_detection
    - description: 驗證上下文傳播
      enabled: true
      name: propagation_validation
    - description: 驗證上下文隔離
      enabled: true
      name: isolation_validation
    enabled: true
    enforcement_level: strict
    error_handling:
      on_drift_detected: warning
      on_inconsistency: block_pr
      on_isolation_violation: block_pr
      on_propagation_failure: block_pr
    reporting:
      format: markdown
      include_context_map: true
      show_drift_details: true
      suggest_fixes: true
  validation_algorithms:
    consistency_check:
      algorithm: cross_reference_validation
      complexity: O(n * m)
      description: 跨檔案驗證上下文一致性
      steps:
      - 收集所有上下文鍵的值
      - 按照 authoritative_source 建立優先級
      - 比較不同來源的值
      - 報告不一致項
    drift_detection:
      algorithm: similarity_analysis
      description: 使用相似度分析檢測語意漂移
      similarity_metric: levenshtein_distance
      steps:
      - 提取相同上下文的所有值
      - 計算值之間的相似度
      - 標記低於閾值的項目
      - 生成漂移報告
    propagation_validation:
      algorithm: dependency_graph_traversal
      complexity: O(V + E)
      description: 驗證上下文正確傳播
      steps:
      - 建立上下文依賴圖
      - 從 authoritative_source 開始遍歷
      - 驗證每個目標的值
      - 報告傳播失敗
  version: 1
status:
  conditions:
  - lastTransitionTime: '2025-12-21T02:00:00Z'
    message: Context specification is complete and validated
    reason: SpecificationComplete
    status: 'True'
    type: Validated
  phase: Active
  statistics:
    coverage: 100%
    total_consistency_rules: 15
    total_context_keys: 11
    total_drift_checks: 4
    total_propagation_rules: 3
