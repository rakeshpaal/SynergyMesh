# ğŸŒ Root Layer Context Specification
# Version: 1.0.0
# Scope: Context consistency rules for root layer
# Enforcement: Strict (GitHub Actions gate-root-specs.yml)

apiVersion: machinenativeops.io/v1
kind: RootContextSpec
metadata:
  name: root-context-specification
  namespace: machinenativeops-specs
  labels:
    machinenativeops.io/tier: "specs"
    machinenativeops.io/version: "v1.0.0"
    machinenativeops.io/component: "context-spec"
  annotations:
    machinenativeops.io/description: "Machine-verifiable context consistency rules for root layer"
    machinenativeops.io/enforcement: "strict"
    machinenativeops.io/last-modified: "2025-12-21T02:00:00Z"

spec:
  version: 1
  
  # === ä¸Šä¸‹æ–‡éµå®šç¾© ===
  context_keys:
    # 1. æ ¸å¿ƒä¸Šä¸‹æ–‡éµ
    core_keys:
      - key: "module_id"
        description: "æ¨¡çµ„å”¯ä¸€è­˜åˆ¥ç¬¦"
        type: "string"
        pattern: "^[a-z][a-z0-9-]*[a-z0-9]$"
        scope: "global"
        immutable: true
        authoritative_source: "root.registry.modules.yaml"
        
      - key: "name"
        description: "è³‡æºåç¨±"
        type: "string"
        pattern: "^[a-z][a-z0-9-]*[a-z0-9]$"
        scope: "per_resource_type"
        immutable: false
        consistency_rule: "åŒä¸€ module_id çš„ name å¿…é ˆä¸€è‡´"
        
      - key: "version"
        description: "ç‰ˆæœ¬è™Ÿ"
        type: "string"
        pattern: "^\\d+\\.\\d+\\.\\d+$"
        scope: "per_module"
        immutable: false
        consistency_rule: "åŒä¸€æ¨¡çµ„åœ¨ä¸åŒæª”æ¡ˆä¸­çš„ç‰ˆæœ¬å¿…é ˆä¸€è‡´"
        
      - key: "namespace"
        description: "å‘½åç©ºé–“"
        type: "string"
        pattern: "^[a-z][a-z0-9-]*$"
        scope: "per_resource"
        immutable: true
        consistency_rule: "åŒä¸€è³‡æºé¡å‹æ‡‰ä½¿ç”¨ç›¸åŒå‘½åç©ºé–“"
        
      - key: "apiVersion"
        description: "API ç‰ˆæœ¬"
        type: "string"
        pattern: "^[a-z0-9.-]+/v\\d+$"
        scope: "per_file"
        immutable: false
        consistency_rule: "åŒä¸€æª”æ¡ˆå…§çš„ apiVersion å¿…é ˆä¸€è‡´"
        
      - key: "kind"
        description: "è³‡æºé¡å‹"
        type: "string"
        pattern: "^Root[A-Z][a-zA-Z0-9]*$"
        scope: "per_resource"
        immutable: true
        consistency_rule: "kind å¿…é ˆèˆ‡æª”æ¡ˆé¡å‹åŒ¹é…"
    
    # 2. æ¨™ç±¤ä¸Šä¸‹æ–‡éµ
    label_keys:
      - key: "machinenativeops.io/tier"
        description: "å±¤ç´šæ¨™ç±¤"
        type: "string"
        allowed_values: ["core", "modules", "specs", "security", "monitoring"]
        consistency_rule: "åŒä¸€æ¨¡çµ„åœ¨ä¸åŒæª”æ¡ˆä¸­çš„ tier å¿…é ˆä¸€è‡´"
        
      - key: "machinenativeops.io/version"
        description: "ç‰ˆæœ¬æ¨™ç±¤"
        type: "string"
        pattern: "^v\\d+\\.\\d+\\.\\d+$"
        consistency_rule: "å¿…é ˆèˆ‡ spec.version ä¸€è‡´"
        
      - key: "machinenativeops.io/component"
        description: "çµ„ä»¶æ¨™ç±¤"
        type: "string"
        pattern: "^[a-z][a-z0-9-]*$"
        consistency_rule: "å¿…é ˆèˆ‡è³‡æºåç¨±ç›¸é—œ"
    
    # 3. ç’°å¢ƒä¸Šä¸‹æ–‡éµ
    environment_keys:
      - key: "environment"
        description: "ç’°å¢ƒé¡å‹"
        type: "string"
        allowed_values: ["development", "staging", "production"]
        scope: "global"
        consistency_rule: "æ‰€æœ‰é…ç½®å¿…é ˆä½¿ç”¨ç›¸åŒç’°å¢ƒ"
        
      - key: "region"
        description: "éƒ¨ç½²å€åŸŸ"
        type: "string"
        pattern: "^[a-z]{2}-[a-z]+-\\d+$"
        scope: "global"
        consistency_rule: "åŒä¸€ç’°å¢ƒçš„æ‰€æœ‰è³‡æºæ‡‰åœ¨ç›¸åŒå€åŸŸ"

  # === ä¸Šä¸‹æ–‡ä¸€è‡´æ€§è¦å‰‡ ===
  consistency_rules:
    # 1. æ¨¡çµ„ä¸Šä¸‹æ–‡ä¸€è‡´æ€§
    module_context:
      - id: "CTX-MOD-001"
        description: "æ¨¡çµ„åç¨±åœ¨æ‰€æœ‰æª”æ¡ˆä¸­å¿…é ˆä¸€è‡´"
        severity: "error"
        check: |
          FOR EACH module M:
            name_in_registry = registry.modules[M.id].name
            name_in_modules = modules.yaml[M.id].name
            name_in_bootstrap = bootstrap.yaml[M.id].name
            ASSERT name_in_registry == name_in_modules == name_in_bootstrap
        files:
          - "root.registry.modules.yaml"
          - "root.modules.yaml"
          - "root.bootstrap.yaml"
        
      - id: "CTX-MOD-002"
        description: "æ¨¡çµ„ç‰ˆæœ¬åœ¨æ‰€æœ‰å¼•ç”¨ä¸­å¿…é ˆç›¸å®¹"
        severity: "error"
        check: |
          FOR EACH module M:
            FOR EACH reference R to M:
              ASSERT R.version is_compatible_with M.version
        
      - id: "CTX-MOD-003"
        description: "æ¨¡çµ„æè¿°åœ¨ä¸åŒæª”æ¡ˆä¸­æ‡‰ä¸€è‡´"
        severity: "warning"
        check: |
          FOR EACH module M:
            descriptions = [M.description in each file]
            ASSERT all_similar(descriptions, threshold=0.8)
    
    # 2. æ¨™ç±¤ä¸Šä¸‹æ–‡ä¸€è‡´æ€§
    label_context:
      - id: "CTX-LABEL-001"
        description: "ç‰ˆæœ¬æ¨™ç±¤å¿…é ˆèˆ‡å¯¦éš›ç‰ˆæœ¬ä¸€è‡´"
        severity: "error"
        check: |
          FOR EACH resource R:
            label_version = R.metadata.labels["machinenativeops.io/version"]
            spec_version = R.spec.version
            ASSERT normalize_version(label_version) == normalize_version(spec_version)
        
      - id: "CTX-LABEL-002"
        description: "çµ„ä»¶æ¨™ç±¤å¿…é ˆèˆ‡è³‡æºåç¨±ç›¸é—œ"
        severity: "warning"
        check: |
          FOR EACH resource R:
            component = R.metadata.labels["machinenativeops.io/component"]
            name = R.metadata.name
            ASSERT component in name OR name in component
        
      - id: "CTX-LABEL-003"
        description: "å±¤ç´šæ¨™ç±¤å¿…é ˆèˆ‡æª”æ¡ˆä½ç½®ä¸€è‡´"
        severity: "error"
        check: |
          FOR EACH resource R in file F:
            tier = R.metadata.labels["machinenativeops.io/tier"]
            ASSERT tier matches F.category
    
    # 3. å‘½åç©ºé–“ä¸Šä¸‹æ–‡ä¸€è‡´æ€§
    namespace_context:
      - id: "CTX-NS-001"
        description: "åŒé¡è³‡æºæ‡‰ä½¿ç”¨ç›¸åŒå‘½åç©ºé–“"
        severity: "warning"
        check: |
          FOR EACH resource_type T:
            namespaces = [R.metadata.namespace for R in resources of type T]
            ASSERT len(set(namespaces)) == 1
        
      - id: "CTX-NS-002"
        description: "å‘½åç©ºé–“å¿…é ˆéµå¾ªå‘½åè¦ç¯„"
        severity: "error"
        check: |
          FOR EACH resource R:
            ns = R.metadata.namespace
            ASSERT ns matches "^machinenativenops-[a-z][a-z0-9-]*$"
    
    # 4. API ç‰ˆæœ¬ä¸Šä¸‹æ–‡ä¸€è‡´æ€§
    api_version_context:
      - id: "CTX-API-001"
        description: "åŒä¸€æª”æ¡ˆå…§çš„ API ç‰ˆæœ¬å¿…é ˆä¸€è‡´"
        severity: "error"
        check: |
          FOR EACH file F:
            api_versions = [R.apiVersion for R in F.resources]
            ASSERT len(set(api_versions)) == 1
        
      - id: "CTX-API-002"
        description: "API ç‰ˆæœ¬å¿…é ˆå‘å¾Œç›¸å®¹"
        severity: "error"
        check: |
          FOR EACH resource R with previous_version P:
            ASSERT R.apiVersion is_backward_compatible_with P.apiVersion
    
    # 5. ç’°å¢ƒä¸Šä¸‹æ–‡ä¸€è‡´æ€§
    environment_context:
      - id: "CTX-ENV-001"
        description: "æ‰€æœ‰é…ç½®å¿…é ˆä½¿ç”¨ç›¸åŒç’°å¢ƒ"
        severity: "error"
        check: |
          environments = [R.spec.environment for R in all_resources]
          ASSERT len(set(environments)) == 1
        
      - id: "CTX-ENV-002"
        description: "ç”Ÿç”¢ç’°å¢ƒå¿…é ˆä½¿ç”¨ç©©å®šç‰ˆæœ¬"
        severity: "error"
        check: |
          IF environment == "production":
            FOR EACH module M:
              ASSERT M.version matches "^\\d+\\.\\d+\\.\\d+$"  # No pre-release
        
      - id: "CTX-ENV-003"
        description: "é–‹ç™¼ç’°å¢ƒå¯ä»¥ä½¿ç”¨é ç™¼å¸ƒç‰ˆæœ¬"
        severity: "info"
        check: |
          IF environment == "development":
            FOR EACH module M:
              M.version may include "-alpha", "-beta", "-rc"

  # === ä¸Šä¸‹æ–‡æ¼‚ç§»æª¢æ¸¬ ===
  drift_detection:
    # 1. åç¨±æ¼‚ç§»
    name_drift:
      enabled: true
      description: "æª¢æ¸¬åŒä¸€æ¦‚å¿µåœ¨ä¸åŒåœ°æ–¹ä½¿ç”¨ä¸åŒåç¨±"
      checks:
        - context: "module_name"
          sources:
            - "root.registry.modules.yaml::modules[].name"
            - "root.modules.yaml::spec.modules[].name"
            - "root.bootstrap.yaml::spec.phases[].modules[]"
          tolerance: 0  # å¿…é ˆå®Œå…¨ä¸€è‡´
          
        - context: "service_name"
          sources:
            - "root.modules.yaml::spec.modules[].name"
            - "root.super-execution.yaml::spec.flows[].steps[].service"
          tolerance: 0
    
    # 2. ç‰ˆæœ¬æ¼‚ç§»
    version_drift:
      enabled: true
      description: "æª¢æ¸¬ç‰ˆæœ¬è™Ÿä¸ä¸€è‡´"
      checks:
        - context: "module_version"
          sources:
            - "root.registry.modules.yaml::modules[].version"
            - "root.modules.yaml::spec.modules[].version"
          tolerance: "minor"  # å…è¨± minor ç‰ˆæœ¬å·®ç•°
          
        - context: "api_version"
          sources:
            - "root.*.yaml::apiVersion"
          tolerance: 0  # API ç‰ˆæœ¬å¿…é ˆä¸€è‡´
    
    # 3. é…ç½®æ¼‚ç§»
    config_drift:
      enabled: true
      description: "æª¢æ¸¬é…ç½®å€¼ä¸ä¸€è‡´"
      checks:
        - context: "resource_limits"
          sources:
            - "root.modules.yaml::spec.modules[].resources"
            - "root.config.yaml::spec.defaults.resources"
          tolerance: "10%"  # å…è¨± 10% å·®ç•°
    
    # 4. èªæ„æ¼‚ç§»
    semantic_drift:
      enabled: true
      description: "æª¢æ¸¬èªæ„ä¸ä¸€è‡´"
      checks:
        - context: "module_description"
          sources:
            - "root.registry.modules.yaml::modules[].description"
            - "root.modules.yaml::spec.modules[].description"
          similarity_threshold: 0.8  # 80% ç›¸ä¼¼åº¦

  # === ä¸Šä¸‹æ–‡å‚³æ’­è¦å‰‡ ===
  propagation_rules:
    - id: "CTX-PROP-001"
      description: "æ¨¡çµ„è¨»å†Šè¡¨æ˜¯æ¨¡çµ„è³‡è¨Šçš„å”¯ä¸€äº‹å¯¦ä¾†æº"
      source: "root.registry.modules.yaml"
      targets:
        - "root.modules.yaml"
        - "root.bootstrap.yaml"
        - "root.super-execution.yaml"
      propagated_fields:
        - "name"
        - "version"
        - "description"
      update_strategy: "authoritative"
      
    - id: "CTX-PROP-002"
      description: "URN è¨»å†Šè¡¨æ˜¯å¼•ç”¨çš„å”¯ä¸€äº‹å¯¦ä¾†æº"
      source: "root.registry.urns.yaml"
      targets:
        - "root.*.yaml"
      propagated_fields:
        - "urn"
        - "target_type"
        - "target_id"
      update_strategy: "authoritative"
      
    - id: "CTX-PROP-003"
      description: "å…¨åŸŸé…ç½®å‚³æ’­åˆ°æ‰€æœ‰æ¨¡çµ„"
      source: "root.config.yaml"
      targets:
        - "root.modules.yaml::spec.modules[]"
      propagated_fields:
        - "environment"
        - "region"
        - "log_level"
      update_strategy: "default_with_override"

  # === ä¸Šä¸‹æ–‡éš”é›¢è¦å‰‡ ===
  isolation_rules:
    - id: "CTX-ISO-001"
      description: "ä¸åŒç’°å¢ƒçš„é…ç½®å¿…é ˆéš”é›¢"
      contexts:
        - "development"
        - "staging"
        - "production"
      isolation_level: "strict"
      shared_contexts: []
      
    - id: "CTX-ISO-002"
      description: "ä¸åŒå‘½åç©ºé–“çš„è³‡æºå¿…é ˆéš”é›¢"
      contexts:
        - "machinenativenops-core"
        - "machinenativenops-modules"
        - "machinenativenops-specs"
      isolation_level: "moderate"
      shared_contexts: ["global_config"]
      
    - id: "CTX-ISO-003"
      description: "æ¸¬è©¦å’Œç”Ÿç”¢è³‡æ–™å¿…é ˆéš”é›¢"
      contexts:
        - "test_data"
        - "production_data"
      isolation_level: "strict"
      shared_contexts: []

  # === ä¸Šä¸‹æ–‡é©—è­‰ç®—æ³• ===
  validation_algorithms:
    # ä¸Šä¸‹æ–‡ä¸€è‡´æ€§æª¢æŸ¥
    consistency_check:
      algorithm: "cross_reference_validation"
      description: "è·¨æª”æ¡ˆé©—è­‰ä¸Šä¸‹æ–‡ä¸€è‡´æ€§"
      steps:
        - "æ”¶é›†æ‰€æœ‰ä¸Šä¸‹æ–‡éµçš„å€¼"
        - "æŒ‰ç…§ authoritative_source å»ºç«‹å„ªå…ˆç´š"
        - "æ¯”è¼ƒä¸åŒä¾†æºçš„å€¼"
        - "å ±å‘Šä¸ä¸€è‡´é …"
      complexity: "O(n * m)"  # n=è³‡æºæ•¸, m=æª”æ¡ˆæ•¸
      
    # æ¼‚ç§»æª¢æ¸¬
    drift_detection:
      algorithm: "similarity_analysis"
      description: "ä½¿ç”¨ç›¸ä¼¼åº¦åˆ†ææª¢æ¸¬èªæ„æ¼‚ç§»"
      steps:
        - "æå–ç›¸åŒä¸Šä¸‹æ–‡çš„æ‰€æœ‰å€¼"
        - "è¨ˆç®—å€¼ä¹‹é–“çš„ç›¸ä¼¼åº¦"
        - "æ¨™è¨˜ä½æ–¼é–¾å€¼çš„é …ç›®"
        - "ç”Ÿæˆæ¼‚ç§»å ±å‘Š"
      similarity_metric: "levenshtein_distance"
      
    # å‚³æ’­é©—è­‰
    propagation_validation:
      algorithm: "dependency_graph_traversal"
      description: "é©—è­‰ä¸Šä¸‹æ–‡æ­£ç¢ºå‚³æ’­"
      steps:
        - "å»ºç«‹ä¸Šä¸‹æ–‡ä¾è³´åœ–"
        - "å¾ authoritative_source é–‹å§‹éæ­·"
        - "é©—è­‰æ¯å€‹ç›®æ¨™çš„å€¼"
        - "å ±å‘Šå‚³æ’­å¤±æ•—"
      complexity: "O(V + E)"

  # === é©—è­‰é…ç½® ===
  validation:
    enabled: true
    enforcement_level: "strict"
    
    checks:
      - name: "consistency_check"
        enabled: true
        description: "é©—è­‰ä¸Šä¸‹æ–‡ä¸€è‡´æ€§"
        
      - name: "drift_detection"
        enabled: true
        description: "æª¢æ¸¬ä¸Šä¸‹æ–‡æ¼‚ç§»"
        
      - name: "propagation_validation"
        enabled: true
        description: "é©—è­‰ä¸Šä¸‹æ–‡å‚³æ’­"
        
      - name: "isolation_validation"
        enabled: true
        description: "é©—è­‰ä¸Šä¸‹æ–‡éš”é›¢"
    
    error_handling:
      on_inconsistency: "block_pr"
      on_drift_detected: "warning"
      on_propagation_failure: "block_pr"
      on_isolation_violation: "block_pr"
    
    reporting:
      format: "markdown"
      include_context_map: true
      show_drift_details: true
      suggest_fixes: true

# === ç‹€æ…‹ ===
status:
  phase: "Active"
  conditions:
    - type: "Validated"
      status: "True"
      lastTransitionTime: "2025-12-21T02:00:00Z"
      reason: "SpecificationComplete"
      message: "Context specification is complete and validated"
  
  statistics:
    total_context_keys: 11
    total_consistency_rules: 15
    total_drift_checks: 4
    total_propagation_rules: 3
    coverage: "100%"