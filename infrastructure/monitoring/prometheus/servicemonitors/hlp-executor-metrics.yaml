# ═══════════════════════════════════════════════════════════════════════════════
#                    HLP Executor Core - Prometheus ServiceMonitor
#                    HLP 執行器核心 - Prometheus 服務監控配置
# ═══════════════════════════════════════════════════════════════════════════════

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: hlp-executor-metrics
  namespace: unmanned-island-system
  labels:
    app: hlp-executor-core
    component: monitoring
    prometheus: kube-prometheus
  annotations:
    description: "ServiceMonitor for HLP Executor Core metrics"
    docs: "https://docs.unmanned-island.io/hlp-executor/monitoring"
spec:
  # Select services to monitor
  selector:
    matchLabels:
      app: hlp-executor-core
      component: metrics

  # Namespace selector
  namespaceSelector:
    matchNames:
      - unmanned-island-system

  # Endpoints to scrape
  endpoints:
    - port: metrics
      interval: 30s # Scrape every 30 seconds
      scrapeTimeout: 10s
      path: /metrics
      scheme: http

      # Relabeling configurations
      relabelings:
        # Add namespace label
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
          action: replace

        # Add pod name label
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
          action: replace

        # Add service name label
        - sourceLabels: [__meta_kubernetes_service_name]
          targetLabel: service
          action: replace

        # Add instance label (pod IP)
        - sourceLabels: [__meta_kubernetes_pod_ip]
          targetLabel: instance
          action: replace

      # Metric relabelings (apply after scraping)
      metricRelabelings:
        # Drop high-cardinality metrics
        - sourceLabels: [__name__]
          regex: "go_gc_.*"
          action: drop

        # Add custom labels
        - targetLabel: component
          replacement: hlp-executor-core
          action: replace

        - targetLabel: system
          replacement: unmanned-island
          action: replace

  # Optional: TLS configuration
  # tlsConfig:
  #   insecureSkipVerify: false
  #   ca:
  #     secret:
  #       name: prometheus-ca
  #       key: ca.crt

---
# PrometheusRule for HLP Executor alerting rules
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: hlp-executor-alerts
  namespace: unmanned-island-system
  labels:
    app: hlp-executor-core
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
    - name: hlp-executor-core
      interval: 30s
      rules:
        # High error rate alert
        - alert: HLPExecutorHighErrorRate
          expr: |
            rate(hlp_executor_errors_total[5m]) > 0.01
          for: 5m
          labels:
            severity: warning
            component: hlp-executor-core
          annotations:
            summary: "HLP Executor has high error rate"
            description: "HLP Executor error rate is {{ $value }} errors/sec (threshold: 0.01)"

        # High queue depth alert
        - alert: HLPExecutorHighQueueDepth
          expr: |
            hlp_executor_queue_depth > 1000
          for: 5m
          labels:
            severity: warning
            component: hlp-executor-core
          annotations:
            summary: "HLP Executor queue depth is high"
            description: "HLP Executor queue depth is {{ $value }} (threshold: 1000)"

        # High latency alert
        - alert: HLPExecutorHighLatency
          expr: |
            histogram_quantile(0.95, rate(hlp_executor_execution_latency_seconds_bucket[5m])) > 1.0
          for: 5m
          labels:
            severity: warning
            component: hlp-executor-core
          annotations:
            summary: "HLP Executor P95 latency is high"
            description: "HLP Executor P95 latency is {{ $value }}s (threshold: 1s)"

        # Service down alert
        - alert: HLPExecutorDown
          expr: |
            up{job="hlp-executor-core"} == 0
          for: 1m
          labels:
            severity: critical
            component: hlp-executor-core
          annotations:
            summary: "HLP Executor is down"
            description: "HLP Executor instance {{ $labels.instance }} is down"

        # High rollback rate alert
        - alert: HLPExecutorHighRollbackRate
          expr: |
            rate(hlp_executor_rollbacks_total[5m]) > 0.5
          for: 10m
          labels:
            severity: warning
            component: hlp-executor-core
          annotations:
            summary: "HLP Executor has high rollback rate"
            description: "HLP Executor rollback rate is {{ $value }} rollbacks/sec (threshold: 0.5)"

        # Circuit breaker open alert
        - alert: HLPExecutorCircuitBreakerOpen
          expr: |
            hlp_executor_circuit_breaker_state{state="open"} == 1
          for: 5m
          labels:
            severity: warning
            component: hlp-executor-core
          annotations:
            summary: "HLP Executor circuit breaker is open"
            description: "HLP Executor circuit breaker for {{ $labels.circuit }} is open"

        # Resource exhaustion alert
        - alert: HLPExecutorResourceExhaustion
          expr: |
            hlp_executor_resource_utilization_percent > 90
          for: 5m
          labels:
            severity: critical
            component: hlp-executor-core
          annotations:
            summary: "HLP Executor resource utilization is high"
            description: "HLP Executor {{ $labels.resource }} utilization is {{ $value }}% (threshold: 90%)"

        # Checkpoint failure alert
        - alert: HLPExecutorCheckpointFailure
          expr: |
            rate(hlp_executor_checkpoint_failures_total[5m]) > 0.1
          for: 5m
          labels:
            severity: warning
            component: hlp-executor-core
          annotations:
            summary: "HLP Executor checkpoint failures detected"
            description: "HLP Executor checkpoint failure rate is {{ $value }} failures/sec"
