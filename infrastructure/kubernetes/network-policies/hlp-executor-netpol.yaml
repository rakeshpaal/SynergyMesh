---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hlp-executor-core-netpol
  namespace: unmanned-island-system
  labels:
    app: hlp-executor-core
    component: execution-engine
  annotations:
    description: "Network policy for HLP Executor Core - restricts ingress and egress traffic"
spec:
  podSelector:
    matchLabels:
      app: hlp-executor-core

  policyTypes:
    - Ingress
    - Egress

  # Ingress Rules - Allow traffic from specific sources
  ingress:
    # Allow from within the same namespace
    - from:
        - namespaceSelector:
            matchLabels:
              name: unmanned-island-system
      ports:
        - protocol: TCP
          port: 8080 # HTTP API
        - protocol: TCP
          port: 50051 # gRPC API
        - protocol: TCP
          port: 9090 # Metrics

    # Allow from Prometheus for metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
          podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 9090 # Metrics endpoint

  # Egress Rules - Allow traffic to specific destinations
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53 # DNS
        - protocol: TCP
          port: 53 # DNS over TCP

    # Allow to Kubernetes API server
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              component: apiserver
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443

    # Allow to within same namespace (for service discovery)
    - to:
        - namespaceSelector:
            matchLabels:
              name: unmanned-island-system
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 50051

    # Allow to databases (PostgreSQL)
    - to:
        - namespaceSelector:
            matchLabels:
              name: unmanned-island-system
          podSelector:
            matchLabels:
              app: postgresql
      ports:
        - protocol: TCP
          port: 5432

    # Allow to Redis
    - to:
        - namespaceSelector:
            matchLabels:
              name: unmanned-island-system
          podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379

    # Allow to monitoring stack
    - to:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 9090 # Prometheus
        - protocol: TCP
          port: 3000 # Grafana
        - protocol: TCP
          port: 14268 # Jaeger collector
        - protocol: TCP
          port: 4317 # OpenTelemetry gRPC

    # Allow HTTPS egress for external services (if needed)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
