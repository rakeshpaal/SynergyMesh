name: 07-dependency-update

on:
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEPENDENCY_BOT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Update npm workspaces
        run: |
          npm install
          npm update --workspaces --if-present

      - name: Go tidy
        if: ${{ hashFiles('services/**/*.go') != '' }}
        uses: actions/setup-go@v5
        with:
          go-version: 1.21
      - if: ${{ hashFiles('services/**/*.go') != '' }}
        name: Run go mod tidy
        run: |
          find services -name "go.mod" -print0 | xargs -0 -I{} sh -c 'cd "$(dirname {})" && go mod tidy'

      - name: Cargo update
        if: ${{ hashFiles('core/**') != '' }}
        uses: dtolnay/rust-toolchain@stable
      - name: Refresh Cargo.lock
        if: ${{ hashFiles('core/**') != '' }}
        run: cargo update

      - name: Maven versions plugin
        if: ${{ hashFiles('pom.xml') != '' }}
        run: mvn versions:use-latest-releases -Dincludes=io.island:*

      - name: Create dependency PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/auto-dependency-updates
          commit-message: 'chore: automated dependency updates'
          title: 'chore: automated dependency updates'
          body: |
            ## Summary
            - Updated workspace dependencies across supported languages.
            - Please review language-specific changelogs before merging.
          reviewers: ${{ vars.DEFAULT_REVIEWERS || '' }}
