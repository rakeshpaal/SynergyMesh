#!/bin/bash
# MachineNativeOps Auto Monitor - System wrapper
# Provides proper environment and error handling for the Python application

set -euo pipefail

# Application metadata
APP_NAME="machinenativenops-auto-monitor"
APP_VERSION="2.0.0"
ARCHITECTURE_HASH="e7f8a9b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9"

# Default configuration paths
DEFAULT_CONFIG="/etc/machinenativenops/monitor_config.yaml"
DEFAULT_LOG_FILE="/var/log/machinenativenops/monitor.log"
DEFAULT_DATA_DIR="/var/lib/machinenativenops/auto_monitor"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$APP_NAME] $1" | tee -a "${LOG_FILE:-$DEFAULT_LOG_FILE}"
}

log_info() {
    log "${GREEN}INFO${NC} $1"
}

log_warn() {
    log "${YELLOW}WARN${NC} $1"
}

log_error() {
    log "${RED}ERROR${NC} $1"
}

log_debug() {
    log "${BLUE}DEBUG${NC} $1"
}

# Print application header
print_header() {
    cat << EOF
${GREEN}
╔══════════════════════════════════════════════════════════════╗
║           MachineNativeOps Auto Monitor v${APP_VERSION}            ║
║         System Monitoring with Quantum State Tracking           ║
╚══════════════════════════════════════════════════════════════╝${NC}
Architecture Hash: ${BLUE}$ARCHITECTURE_HASH${NC}
EOF
}

# Check if running as root (for file permissions)
check_privileges() {
    if [[ $EUID -eq 0 ]]; then
        log_warn "Running as root - this is acceptable for system services"
    else
        log_info "Running as non-root user - ensure proper permissions"
    fi
}

# Ensure necessary directories exist
ensure_directories() {
    local dirs=(
        "/etc/machinenativenops"
        "/var/log/machinenativenops"
        "/var/lib/machinenativenops/auto_monitor"
        "/var/run/machinenativenops"
    )
    
    for dir in "${dirs[@]}"; do
        if [[ ! -d "$dir" ]]; then
            log_info "Creating directory: $dir"
            mkdir -p "$dir"
            if [[ $EUID -eq 0 ]]; then
                chmod 755 "$dir"
            fi
        fi
    done
}

# Check if Python 3 is available
check_python() {
    if ! command -v python3 &> /dev/null; then
        log_error "Python 3 is required but not found"
        exit 1
    fi
    
    local python_version=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
    log_info "Python version: $python_version"
    
    # Check minimum version (3.8)
    if python3 -c "import sys; exit(0 if sys.version_info >= (3, 8) else 1)"; then
        log_info "Python version is acceptable"
    else
        log_error "Python 3.8 or higher is required"
        exit 1
    fi
}

# Check if the Python module is available
check_module() {
    local module="machinenativenops_auto_monitor"
    
    if python3 -c "import $module" 2>/dev/null; then
        log_info "Python module '$module' is available"
    else
        log_error "Python module '$module' not found"
        log_error "Ensure the package is installed: pip install machinenativenops-auto-monitor"
        exit 1
    fi
}

# Validate configuration file
validate_config() {
    local config_file="${1:-$DEFAULT_CONFIG}"
    
    if [[ ! -f "$config_file" ]]; then
        log_warn "Configuration file not found: $config_file"
        log_info "Using default configuration"
        return
    fi
    
    # Validate YAML syntax
    if python3 -c "import yaml; yaml.safe_load(open('$config_file'))" 2>/dev/null; then
        log_info "Configuration file is valid: $config_file"
    else
        log_error "Invalid YAML syntax in configuration file: $config_file"
        exit 1
    fi
}

# Set environment variables
setup_environment() {
    # Set default environment variables if not already set
    export MNO_APP_NAME="${MNO_APP_NAME:-$APP_NAME}"
    export MNO_APP_VERSION="${MNO_APP_VERSION:-$APP_VERSION}"
    export MNO_ARCHITECTURE_HASH="${MNO_ARCHITECTURE_HASH:-$ARCHITECTURE_HASH}"
    
    # Configuration path
    export MNO_CONFIG_FILE="${MNO_CONFIG_FILE:-$DEFAULT_CONFIG}"
    
    # Logging
    export MNO_LOG_FILE="${MNO_LOG_FILE:-$DEFAULT_LOG_FILE}"
    export MNO_LOG_LEVEL="${MNO_LOG_LEVEL:-INFO}"
    
    # Data directory
    export MNO_DATA_DIR="${MNO_DATA_DIR:-$DEFAULT_DATA_DIR}"
    
    # Python path
    export PYTHONPATH="${PYTHONPATH:-$(python3 -c 'import site; print(site.getsitepackages()[0])')}"
    
    log_debug "Environment setup complete"
}

# Start the monitoring service
start_service() {
    log_info "Starting MachineNativeOps Auto Monitor service"
    
    # Validate configuration
    validate_config "$MNO_CONFIG_FILE"
    
    # Start the Python application
    exec python3 -m machinenativenops_auto_monitor serve \
        --config "$MNO_CONFIG_FILE" \
        --log-level "$MNO_LOG_LEVEL"
}

# Run one-time collection
run_once() {
    log_info "Running one-time metrics collection"
    
    local output_file="${1:-}"
    
    # Validate configuration
    validate_config "$MNO_CONFIG_FILE"
    
    if [[ -n "$output_file" ]]; then
        exec python3 -m machinenativenops_auto_monitor once \
            --config "$MNO_CONFIG_FILE" \
            --log-level "$MNO_LOG_LEVEL" \
            --output "$output_file"
    else
        exec python3 -m machinenativenops_auto_monitor once \
            --config "$MNO_CONFIG_FILE" \
            --log-level "$MNO_LOG_LEVEL"
    fi
}

# Validate configuration
validate_command() {
    local config_file="${1:-$MNO_CONFIG_FILE}"
    
    log_info "Validating configuration: $config_file"
    
    exec python3 -m machinenativenops_auto_monitor validate-config \
        --config "$config_file"
}

# Print default configuration
print_default_config() {
    local output_file="${1:-}"
    
    log_info "Generating default configuration"
    
    if [[ -n "$output_file" ]]; then
        exec python3 -m machinenativenops_auto_monitor print-default-config \
            --output "$output_file"
    else
        exec python3 -m machinenativenops_auto_monitor print-default-config
    fi
}

# Show database statistics
show_database_stats() {
    log_info "Showing database statistics"
    
    exec python3 -m machinenativenops_auto_monitor database-stats \
        --config "$MNO_CONFIG_FILE"
}

# Show help information
show_help() {
    cat << EOF
MachineNativeOps Auto Monitor v$APP_VERSION

Usage: $APP_NAME [COMMAND] [OPTIONS]

Commands:
  serve                    Start monitoring service (default)
  once [output]            Run collection once, optionally save to file
  validate-config [file]   Validate configuration file
  print-default-config [file]  Print default configuration
  database-stats          Show database statistics
  help                    Show this help message

Environment Variables:
  MNO_CONFIG_FILE         Configuration file path (default: $DEFAULT_CONFIG)
  MNO_LOG_FILE           Log file path (default: $DEFAULT_LOG_FILE)
  MNO_LOG_LEVEL          Log level (DEBUG, INFO, WARNING, ERROR)
  MNO_DATA_DIR           Data directory path (default: $DEFAULT_DATA_DIR)

Examples:
  $APP_NAME serve                    # Start monitoring service
  $APP_NAME once /tmp/metrics.json   # Collect once and save
  $APP_NAME validate-config          # Validate default config
  MNO_LOG_LEVEL=DEBUG $APP_NAME serve # Start with debug logging

For more information, see: https://docs.machinenativenops.io

Architecture Hash: $ARCHITECTURE_HASH
EOF
}

# Main execution logic
main() {
    local command="${1:-serve}"
    
    # Print header
    print_header
    
    # System checks
    check_privileges
    ensure_directories
    check_python
    check_module
    
    # Setup environment
    setup_environment
    
    # Execute command
    case "$command" in
        "serve")
            start_service
            ;;
        "once")
            run_once "$2"
            ;;
        "validate-config")
            validate_command "$2"
            ;;
        "print-default-config")
            print_default_config "$2"
            ;;
        "database-stats")
            show_database_stats
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

# Trap signals for graceful shutdown
trap 'log_info "Received signal, shutting down..."; exit 0' SIGTERM SIGINT

# Run main function with all arguments
main "$@"