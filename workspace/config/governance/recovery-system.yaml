# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                      Recovery System Configuration
#                          æ¢å¾©ç³»çµ±é…ç½®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Version: 1.0.0
# Created: 2025-12-09
# Purpose: Configuration for Dr. Phoenix and recovery system
#
# This configuration defines the behavior of the self-healing recovery system.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

version: "1.0.0"
name: "SynergyMesh Recovery System"
description: "Self-healing system recovery with Dr. Phoenix"

# ============================================================================
# Phoenix Agent Configuration (é³³å‡°ä»£ç†é…ç½®)
# ============================================================================
phoenix_agent:
  enabled: true
  mode: "autonomous"  # autonomous | supervised | manual
  profile: "config/agents/profiles/recovery_expert.yaml"
  
  # Operating parameters
  parameters:
    startup_delay: 0  # Start immediately
    always_running: true
    cannot_be_disabled: true
    independent_process: true
    priority: "critical"

# ============================================================================
# Monitoring Configuration (ç›£æ§é…ç½®)
# ============================================================================
monitoring:
  # Health check interval in seconds
  health_check_interval: 30
  
  # Heartbeat configuration
  heartbeat:
    enabled: true
    interval: 20  # Send heartbeat every 20 seconds
    timeout: 90  # Alert if no heartbeat for 90 seconds
    file: ".launcher_heartbeat.json"
  
  # Critical components to monitor
  critical_components:
    - name: "automation_launcher"
      pattern: "automation_launcher.py"
      health_check: "process_running"
      critical: true
      
    - name: "master_orchestrator"
      pattern: "master_orchestrator"
      health_check: "api_endpoint"
      critical: true
      
    - name: "core_services"
      pattern: "system_resources"
      health_check: "resource_usage"
      critical: true
  
  # Health thresholds
  thresholds:
    cpu_percent:
      warning: 70
      critical: 90
    memory_percent:
      warning: 70
      critical: 90
    disk_percent:
      warning: 80
      critical: 90
    response_time_ms:
      warning: 1000
      critical: 5000

# ============================================================================
# Recovery Configuration (æ¢å¾©é…ç½®)
# ============================================================================
recovery:
  # Maximum restart attempts before escalation
  max_restart_attempts: 3
  
  # Delay between retry attempts (seconds)
  retry_delay: 5
  
  # Cooldown between restart attempts (seconds)
  restart_cooldown: 60
  
  # Strategy timeouts (seconds)
  strategy_timeout:
    quick_restart: 30
    safe_mode_restart: 120
    configuration_rollback: 300
    service_dependency_restart: 600
    backup_restore: 1800
    full_system_bootstrap: 7200
  
  # Recovery strategies in order of preference
  strategies:
    - name: "quick_restart"
      priority: 1
      description: "Simple process restart"
      conditions:
        - "first_attempt"
        - "process_crashed"
      actions:
        - "terminate_process"
        - "wait_5_seconds"
        - "start_process"
      rollback_on_failure: false
      
    - name: "safe_mode_restart"
      priority: 2
      description: "Restart with minimal configuration"
      conditions:
        - "quick_restart_failed"
        - "configuration_suspected"
      actions:
        - "backup_current_config"
        - "load_minimal_config"
        - "restart_process"
        - "verify_startup"
      rollback_on_failure: true
      
    - name: "configuration_rollback"
      priority: 3
      description: "Rollback to last known good configuration"
      conditions:
        - "safe_mode_failed"
        - "recent_config_change"
      actions:
        - "identify_last_good_config"
        - "backup_current_config"
        - "restore_previous_config"
        - "restart_all_services"
        - "verify_system"
      rollback_on_failure: true
      max_rollback_depth: 5
      
    - name: "service_dependency_restart"
      priority: 4
      description: "Restart all dependent services"
      conditions:
        - "configuration_rollback_failed"
        - "dependency_issues"
      actions:
        - "identify_dependencies"
        - "stop_all_dependent_services"
        - "restart_in_dependency_order"
        - "verify_all_services"
      rollback_on_failure: true
      
    - name: "backup_restore"
      priority: 5
      description: "Restore from latest backup"
      conditions:
        - "dependency_restart_failed"
        - "data_corruption"
      actions:
        - "stop_all_services"
        - "identify_latest_backup"
        - "restore_backup"
        - "restart_all_services"
        - "verify_system"
      rollback_on_failure: false
      requires_approval: true  # Requires human approval
      
    - name: "full_system_bootstrap"
      priority: 6
      description: "Complete system rebuild from scratch"
      conditions:
        - "all_other_strategies_failed"
        - "critical_failure"
      actions:
        - "emergency_shutdown"
        - "run_emergency_recovery_script"
        - "bootstrap_core_components"
        - "restore_configurations"
        - "restart_system"
        - "full_verification"
      rollback_on_failure: false
      requires_approval: true

# ============================================================================
# Backup Configuration (å‚™ä»½é…ç½®)
# ============================================================================
backup:
  enabled: true
  
  # Backup locations
  paths:
    configs: "config/"
    state: ".automation_logs/"
    data: "data/"  # If exists
  
  # Backup retention
  retention:
    hourly: 24  # Keep 24 hourly backups
    daily: 7    # Keep 7 daily backups
    weekly: 4   # Keep 4 weekly backups
    monthly: 3  # Keep 3 monthly backups
  
  # Automatic backup triggers
  triggers:
    - "before_recovery_attempt"
    - "configuration_change"
    - "system_upgrade"
    - "manual_request"
  
  # Backup verification
  verification:
    enabled: true
    integrity_check: true
    test_restore: false  # Disable by default to avoid overhead

# ============================================================================
# Escalation Configuration (å‡ç´šé…ç½®)
# ============================================================================
escalation:
  enabled: true
  
  # Escalation levels
  levels:
    - level: 1
      name: "info"
      trigger: "automatic_recovery_successful"
      actions:
        - "log_event"
        - "update_metrics"
      notification: false
      
    - level: 2
      name: "warning"
      trigger: "recovery_in_progress"
      actions:
        - "log_event"
        - "send_status_update"
        - "update_metrics"
      notification: false
      
    - level: 3
      name: "alert"
      trigger: "multiple_recovery_attempts"
      actions:
        - "log_event"
        - "alert_team"
        - "create_incident"
      notification: true
      notify_channels: ["slack"]
      
    - level: 4
      name: "critical"
      trigger: "all_automatic_recovery_failed"
      actions:
        - "log_event"
        - "page_on_call"
        - "create_critical_incident"
        - "prepare_for_manual_intervention"
      notification: true
      notify_channels: ["slack", "email", "pagerduty"]
      
    - level: 5
      name: "emergency"
      trigger: "system_wide_outage"
      actions:
        - "log_event"
        - "page_incident_commander"
        - "activate_disaster_recovery"
        - "notify_stakeholders"
      notification: true
      notify_channels: ["slack", "email", "pagerduty", "phone"]

# ============================================================================
# Notification Configuration (é€šçŸ¥é…ç½®)
# ============================================================================
notifications:
  enabled: true
  
  # Notification channels
  channels:
    slack:
      enabled: false  # Enable when configured
      webhook_url: "${SLACK_WEBHOOK_URL}"
      channel: "#alerts"
      
    email:
      enabled: false  # Enable when configured
      smtp_server: "${SMTP_SERVER}"
      from_address: "phoenix@machinenativeops.ai"
      to_addresses: []
      
    pagerduty:
      enabled: false  # Enable when configured
      api_key: "${PAGERDUTY_API_KEY}"
      service_id: "${PAGERDUTY_SERVICE_ID}"
  
  # Notification templates
  templates:
    recovery_started:
      title: "ğŸ¦… Dr. Phoenix: Recovery Started"
      message: "Recovery initiated for {component} using {strategy}"
      
    recovery_success:
      title: "âœ… Dr. Phoenix: Recovery Successful"
      message: "Successfully recovered {component} using {strategy}"
      
    recovery_failed:
      title: "âŒ Dr. Phoenix: Recovery Failed"
      message: "Failed to recover {component}. Escalating to level {level}"
      
    escalation:
      title: "ğŸš¨ Dr. Phoenix: Escalation Level {level}"
      message: "Incident {incident_id} escalated. {details}"

# ============================================================================
# Watchdog Configuration (çœ‹é–€ç‹—é…ç½®)
# ============================================================================
watchdog:
  enabled: true
  independent_process: true
  
  # Monitoring parameters
  check_interval: 30
  heartbeat_timeout: 90
  max_restart_attempts: 5
  restart_cooldown: 300
  
  # Monitored processes
  monitored_processes:
    - name: "automation_launcher"
      pattern: "automation_launcher.py"
      critical: true
      auto_restart: true
      health_checks:
        - "process_running"
        - "heartbeat_alive"
        - "responding_to_requests"
      
    - name: "phoenix_agent"
      pattern: "phoenix_agent.py"
      critical: true
      auto_restart: true
      health_checks:
        - "process_running"

# ============================================================================
# Learning & Analytics (å­¸ç¿’èˆ‡åˆ†æ)
# ============================================================================
learning:
  enabled: true
  
  # Pattern recognition
  pattern_recognition:
    enabled: true
    min_samples: 10
    confidence_threshold: 0.8
  
  # Strategy optimization
  strategy_optimization:
    enabled: true
    adjustment_frequency: "weekly"
    success_weight: 1.0
    duration_weight: 0.5
  
  # Failure analysis
  failure_analysis:
    enabled: true
    root_cause_detection: true
    correlation_analysis: true
  
  # Recommendation engine
  recommendations:
    enabled: true
    suggest_preventive_measures: true
    suggest_configuration_changes: true
    suggest_infrastructure_improvements: true

# ============================================================================
# Logging Configuration (æ—¥èªŒé…ç½®)
# ============================================================================
logging:
  level: "INFO"  # DEBUG | INFO | WARNING | ERROR | CRITICAL
  
  # Log files
  files:
    phoenix_agent: ".automation_logs/phoenix.log"
    watchdog: ".automation_logs/watchdog.log"
    emergency_recovery: ".automation_logs/emergency_recovery.log"
    incidents: ".automation_logs/incidents.log"
  
  # Log retention (days)
  retention: 30
  
  # Log format
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  
  # Structured logging
  structured: true
  include_context: true

# ============================================================================
# Testing & Validation (æ¸¬è©¦èˆ‡é©—è­‰)
# ============================================================================
testing:
  # Chaos engineering
  chaos_engineering:
    enabled: false  # Enable for testing only
    scenarios:
      - "random_process_kill"
      - "configuration_corruption"
      - "resource_exhaustion"
      - "network_partition"
  
  # Health check validation
  health_check_validation:
    enabled: true
    frequency: "daily"
    verify_all_checks: true
  
  # Recovery drill
  recovery_drill:
    enabled: false  # Enable for scheduled drills
    frequency: "monthly"
    scenarios:
      - "launcher_crash"
      - "configuration_error"
      - "dependency_failure"

# ============================================================================
# Security (å®‰å…¨æ€§)
# ============================================================================
security:
  # Authentication
  authentication:
    required: false  # Emergency access doesn't require auth
    
  # Authorization
  authorization:
    phoenix_agent_permissions:
      - "read_logs"
      - "read_configs"
      - "write_state"
      - "restart_services"
      - "rollback_configs"
    
    requires_approval:
      - "data_deletion"
      - "major_version_rollback"
      - "infrastructure_changes"
  
  # Audit logging
  audit:
    enabled: true
    log_all_actions: true
    include_context: true
    retention_days: 90

# ============================================================================
# Performance (æ€§èƒ½)
# ============================================================================
performance:
  # Resource limits for Phoenix Agent
  phoenix_agent:
    max_cpu_percent: 10
    max_memory_mb: 256
    max_threads: 4
  
  # Resource limits for Watchdog
  watchdog:
    max_cpu_percent: 5
    max_memory_mb: 128
    max_threads: 2
  
  # Concurrency
  max_concurrent_recoveries: 3
  max_concurrent_health_checks: 10

# ============================================================================
# Metadata (å…ƒæ•¸æ“š)
# ============================================================================
metadata:
  created_by: "SynergyMesh Team"
  created_date: "2025-12-09"
  last_updated: "2025-12-09"
  version: "1.0.0"
  
  related_files:
    - "services/agents/recovery/phoenix_agent.py"
    - "services/watchdog/system_watchdog.py"
    - "emergency_recovery.py"
    - "config/agents/profiles/recovery_expert.yaml"
    - "docs/PHOENIX_AGENT.md"
    - "docs/RECOVERY_PLAYBOOK.md"
