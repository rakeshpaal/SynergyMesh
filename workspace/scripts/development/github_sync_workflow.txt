name: 08 - Auto Sync All Subdirectories

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
  workflow_dispatch:
    inputs:
      sync_depth:
        description: '同步深度（-1 表示無限深度）'
        required: false
        default: '-1'

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.10'
  RUST_VERSION: '1.75'
  GO_VERSION: '1.21'

jobs:
  detect-changes:
    name: 檢測變更目錄
    runs-on: ubuntu-latest
    outputs:
      changed_dirs: ${{ steps.detect.outputs.dirs }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      
    steps:
      - name: Checkout 代碼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: 檢測變更目錄
        id: detect
        run: |
          echo "ðŸ" 檢測變更的目錄..."
          
          # 獲取所有變更文件
          CHANGED_FILES=$(git diff --name-only HEAD^..HEAD)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "⚠ï¸ 沒有檢測到文件變更"
            exit 0
          fi
          
          # 提取目錄路徑（包括所有層級）
          CHANGED_DIRS=$(echo "$CHANGED_FILES" | \
            grep -v '^\.git' | \
            sed 's|/[^/]*$||' | \
            sort -u)
          
          # 遞歸獲取所有父目錄
          ALL_DIRS=""
          for dir in $CHANGED_DIRS; do
            current_dir="$dir"
            while [ "$current_dir" != "." ]; do
              ALL_DIRS="$ALL_DIRS
$current_dir"
              current_dir=$(dirname "$current_dir")
            done
          done
          
          # 去重並排序
          UNIQUE_DIRS=$(echo "$ALL_DIRS" | sort -u | grep -v '^\.$')
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # 將目錄列表轉換為 JSON 數組
          DIRS_JSON=$(echo "$UNIQUE_DIRS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "dirs=$DIRS_JSON" >> $GITHUB_OUTPUT
          
          echo "✅ 檢測到以下目錄變更:"
          echo "$UNIQUE_DIRS"

  sync-core-rust:
    name: 同步核心層（Rust）
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 安裝 Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          
      - name: 檢測 Rust 項目變更
        id: check_rust
        run: |
          CHANGED_DIRS='${{ needs.detect-changes.outputs.changed_dirs }}'
          HAS_RUST=$(echo "$CHANGED_DIRS" | jq -r '.[] | select(startswith("core/"))' | wc -l)
          echo "has_rust_changes=$HAS_RUST" >> $GITHUB_OUTPUT
          
      - name: 構建 Rust 項目
        if: steps.check_rust.outputs.has_rust_changes != '0'
        run: |
          cd core
          cargo build --workspace
          cargo test --workspace
          
      - name: 同步 Rust 子目錄
        if: steps.check_rust.outputs.has_rust_changes != '0'
        run: |
          echo "✅ Rust 核心層同步完成"

  sync-services-go:
    name: 同步服務層（Go）
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 安裝 Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          
      - name: 檢測 Go 項目變更
        id: check_go
        run: |
          CHANGED_DIRS='${{ needs.detect-changes.outputs.changed_dirs }}'
          HAS_GO=$(echo "$CHANGED_DIRS" | jq -r '.[] | select(startswith("services/"))' | wc -l)
          echo "has_go_changes=$HAS_GO" >> $GITHUB_OUTPUT
          
      - name: 構建 Go 服務
        if: steps.check_go.outputs.has_go_changes != '0'
        run: |
          cd services
          go work sync
          go build ./...
          go test ./...
          
      - name: 同步 Go 子目錄
        if: steps.check_go.outputs.has_go_changes != '0'
        run: |
          echo "✅ Go 服務層同步完成"

  sync-agents-typescript:
    name: 同步 Agents（TypeScript）
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 安裝 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: 檢測 TypeScript Agents 變更
        id: check_ts
        run: |
          CHANGED_DIRS='${{ needs.detect-changes.outputs.changed_dirs }}'
          HAS_TS=$(echo "$CHANGED_DIRS" | jq -r '.[] | select(startswith("agents/") and (contains("architect") or contains("developer") or contains("devops") or contains("qa") or contains("product-manager")))' | wc -l)
          echo "has_ts_changes=$HAS_TS" >> $GITHUB_OUTPUT
          
      - name: 安裝依賴並構建
        if: steps.check_ts.outputs.has_ts_changes != '0'
        run: |
          npm ci
          npm run build --workspaces --if-present
          npm run test --workspaces --if-present
          
      - name: 同步 TypeScript Agents 子目錄
        if: steps.check_ts.outputs.has_ts_changes != '0'
        run: |
          echo "✅ TypeScript Agents 同步完成"

  sync-agents-python:
    name: 同步 Agents（Python）
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 安裝 Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: 檢測 Python Agents 變更
        id: check_py
        run: |
          CHANGED_DIRS='${{ needs.detect-changes.outputs.changed_dirs }}'
          HAS_PY=$(echo "$CHANGED_DIRS" | jq -r '.[] | select(startswith("agents/") and (contains("security") or contains("data-scientist")))' | wc -l)
          echo "has_py_changes=$HAS_PY" >> $GITHUB_OUTPUT
          
      - name: 安裝依賴並測試
        if: steps.check_py.outputs.has_py_changes != '0'
        run: |
          python -m pip install --upgrade pip
          find agents -name "requirements.txt" -exec pip install -r {} \;
          find agents -name "pyproject.toml" -exec pip install -e {} \;
          
      - name: 同步 Python Agents 子目錄
        if: steps.check_py.outputs.has_py_changes != '0'
        run: |
          echo "✅ Python Agents 同步完成"

  sync-integrations-java:
    name: 同步集成層（Java）
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 安裝 Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
          
      - name: 檢測 Java 項目變更
        id: check_java
        run: |
          CHANGED_DIRS='${{ needs.detect-changes.outputs.changed_dirs }}'
          HAS_JAVA=$(echo "$CHANGED_DIRS" | jq -r '.[] | select(startswith("integrations/"))' | wc -l)
          echo "has_java_changes=$HAS_JAVA" >> $GITHUB_OUTPUT
          
      - name: 構建 Maven 項目
        if: steps.check_java.outputs.has_java_changes != '0'
        run: |
          cd integrations
          mvn clean install -DskipTests
          mvn test
          
      - name: 同步 Java 子目錄
        if: steps.check_java.outputs.has_java_changes != '0'
        run: |
          echo "✅ Java 集成層同步完成"

  sync-infrastructure:
    name: 同步基礎設施
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 檢測基礎設施變更
        id: check_infra
        run: |
          CHANGED_DIRS='${{ needs.detect-changes.outputs.changed_dirs }}'
          HAS_INFRA=$(echo "$CHANGED_DIRS" | jq -r '.[] | select(startswith("infrastructure/"))' | wc -l)
          echo "has_infra_changes=$HAS_INFRA" >> $GITHUB_OUTPUT
          
      - name: 驗證 Terraform
        if: steps.check_infra.outputs.has_infra_changes != '0'
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.0'
          
      - name: 驗證 Kubernetes 配置
        if: steps.check_infra.outputs.has_infra_changes != '0'
        run: |
          # 安裝 kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          
          # 驗證 YAML
          find infrastructure/kubernetes -name "*.yaml" -exec kubectl apply --dry-run=client -f {} \;
          
      - name: 同步基礎設施子目錄
        if: steps.check_infra.outputs.has_infra_changes != '0'
        run: |
          echo "✅ 基礎設施配置同步完成"

  sync-documentation:
    name: 同步文檔
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 檢測文檔變更
        id: check_docs
        run: |
          CHANGED_DIRS='${{ needs.detect-changes.outputs.changed_dirs }}'
          HAS_DOCS=$(echo "$CHANGED_DIRS" | jq -r '.[] | select(startswith("docs/"))' | wc -l)
          echo "has_docs_changes=$HAS_DOCS" >> $GITHUB_OUTPUT
          
      - name: 驗證 Markdown 連結
        if: steps.check_docs.outputs.has_docs_changes != '0'
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          
      - name: 生成文檔站點
        if: steps.check_docs.outputs.has_docs_changes != '0'
        run: |
          npm ci
          npm run docs:build
          
      - name: 同步文檔子目錄
        if: steps.check_docs.outputs.has_docs_changes != '0'
        run: |
          echo "✅ 文檔同步完成"

  final-report:
    name: 生成同步報告
    needs: 
      - detect-changes
      - sync-core-rust
      - sync-services-go
      - sync-agents-typescript
      - sync-agents-python
      - sync-integrations-java
      - sync-infrastructure
      - sync-documentation
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: 生成同步報告
        run: |
          echo "# ðŸ"„ Island AI 自動同步報告" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**時間:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**分支:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**提交:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## 同步狀態" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 模塊 | 狀態 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| 核心層 (Rust) | ${{ needs.sync-core-rust.result == 'success' && '✅ 成功' || needs.sync-core-rust.result == 'skipped' && '⏭ï¸ 跳過' || 'â�� 失敗' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 服務層 (Go) | ${{ needs.sync-services-go.result == 'success' && '✅ 成功' || needs.sync-services-go.result == 'skipped' && '⏭ï¸ 跳過' || '❌ 失敗' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agents (TypeScript) | ${{ needs.sync-agents-typescript.result == 'success' && '✅ 成功' || needs.sync-agents-typescript.result == 'skipped' && '⏭ï¸ 跳過' || '❌ 失敗' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agents (Python) | ${{ needs.sync-agents-python.result == 'success' && '✅ 成功' || needs.sync-agents-python.result == 'skipped' && '⏭ï¸ 跳過' || '❌ 失敗' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 集成層 (Java) | ${{ needs.sync-integrations-java.result == 'success' && '✅ 成功' || needs.sync-integrations-java.result == 'skipped' && '⏭ï¸ 跳過' || '❌ 失敗' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 基礎設施 | ${{ needs.sync-infrastructure.result == 'success' && '✅ 成功' || needs.sync-infrastructure.result == 'skipped' && '⏭ï¸ 跳過' || '❌ 失敗' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 文檔 | ${{ needs.sync-documentation.result == 'success' && '✅ 成功' || needs.sync-documentation.result == 'skipped' && '⏭ï¸ 跳過' || '❌ 失敗' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## 變更目錄" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ needs.detect-changes.outputs.changed_dirs }}' | jq '.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
