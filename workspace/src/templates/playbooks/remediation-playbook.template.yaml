# è‡ªåŠ¨ä¿®å¤ Playbook æ¨¡æ¿
# ç”¨äºå‘½åè¿è§„çš„è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤

apiVersion: governance.machinenativeops.io/v1alpha1
kind: RemediationPlaybook
metadata:
  name: naming-violation-auto-remediation
  description: "æ ‡å‡†å‘½åè¿è§„è‡ªåŠ¨ä¿®å¤æµç¨‹"
  labels:
    category: remediation
    module: naming-governance
    automation: enabled

spec:
  # è§¦å‘æ¡ä»¶
  triggers:
    - type: alert
      source: Prometheus
      condition:
        alertName: NamingPolicyViolation
        severity: critical
      description: "å½“æ£€æµ‹åˆ° critical çº§åˆ«çš„å‘½åè¿è§„æ—¶è‡ªåŠ¨è§¦å‘"

    - type: alert
      source: Prometheus
      condition:
        alertName: ProductionNamingViolation
      description: "ç”Ÿäº§ç¯å¢ƒå‘½åè¿è§„ç«‹å³è§¦å‘"

    - type: schedule
      schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨ 2:00
      description: "å®šæœŸæ‰«æå’Œä¿®å¤å‘½åè¿è§„"

    - type: manual
      description: "æ”¯æŒæ‰‹åŠ¨è§¦å‘ä¿®å¤æµç¨‹"

  # æ‰§è¡Œæ­¥éª¤
  steps:
    # æ­¥éª¤ 1: æ£€æŸ¥å‘½åè¿è§„èµ„æº
    - name: "æ£€æŸ¥å‘½åè¿è§„èµ„æº"
      description: "æ‰«æå¹¶è¯†åˆ«æ‰€æœ‰è¿åå‘½åè§„èŒƒçš„èµ„æº"
      action:
        type: script
        script:
          language: python
          path: "tools/governance/python/check_naming_violation.py"
          args:
            - "--severity"
            - "{{ .trigger.severity | default \"all\" }}"
            - "--environment"
            - "{{ .trigger.environment | default \"all\" }}"
            - "--output"
            - "/tmp/violations.json"
          env:
            KUBECONFIG: "/path/to/kubeconfig"
            LOG_LEVEL: "info"
      timeout: "5m"
      retry:
        enabled: true
        maxAttempts: 3
        backoff: exponential
      continueOnError: false

    # æ­¥éª¤ 2: åˆ†æè¿è§„å¹¶ç”Ÿæˆä¿®å¤å»ºè®®
    - name: "ç”Ÿæˆä¿®å¤å»ºè®®"
      description: "åˆ†æè¿è§„èµ„æºå¹¶ç”Ÿæˆç¬¦åˆè§„èŒƒçš„å‘½åå»ºè®®"
      action:
        type: script
        script:
          language: python
          path: "tools/governance/python/generate_suggestions.py"
          args:
            - "--input"
            - "/tmp/violations.json"
            - "--output"
            - "/tmp/suggestions.json"
            - "--policy"
            - "policies/naming/"
      timeout: "3m"
      continueOnError: false

    # æ­¥éª¤ 3: éªŒè¯ä¿®å¤å»ºè®®
    - name: "éªŒè¯ä¿®å¤å»ºè®®"
      description: "ç¡®ä¿å»ºè®®çš„å‘½åç¬¦åˆè§„èŒƒä¸”ä¸ä¼šäº§ç”Ÿå†²çª"
      action:
        type: script
        script:
          language: python
          path: "tools/governance/python/validate_suggestions.py"
          args:
            - "--suggestions"
            - "/tmp/suggestions.json"
            - "--check-conflicts"
            - "true"
      timeout: "2m"
      continueOnError: false

    # æ­¥éª¤ 4: å¤‡ä»½å½“å‰çŠ¶æ€
    - name: "å¤‡ä»½å½“å‰çŠ¶æ€"
      description: "å¤‡ä»½èµ„æºå½“å‰çŠ¶æ€ä»¥æ”¯æŒå›æ»š"
      action:
        type: script
        script:
          language: bash
          path: "tools/governance/bash/backup_resources.sh"
          args:
            - "/tmp/violations.json"
            - "/tmp/backup/"
      timeout: "5m"
      continueOnError: false

    # æ­¥éª¤ 5: æ‰§è¡Œè‡ªåŠ¨ä¿®æ­£
    - name: "è‡ªåŠ¨ä¿®æ­£å‘½åä¸æ ‡ç­¾"
      description: "æ ¹æ®å»ºè®®è‡ªåŠ¨é‡å‘½åèµ„æºå¹¶æ›´æ–°æ ‡ç­¾"
      action:
        type: script
        script:
          language: python
          path: "tools/governance/python/rename_and_label.py"
          args:
            - "--suggestions"
            - "/tmp/suggestions.json"
            - "--dry-run"
            - "false"
            - "--update-labels"
            - "true"
            - "--backup-dir"
            - "/tmp/backup/"
          env:
            APPLY_CHANGES: "true"
      timeout: "10m"
      retry:
        enabled: true
        maxAttempts: 2
        backoff: linear
      continueOnError: false

    # æ­¥éª¤ 6: éªŒè¯ä¿®å¤ç»“æœ
    - name: "éªŒè¯ä¿®å¤ç»“æœ"
      description: "ç¡®è®¤èµ„æºå·²æ­£ç¡®é‡å‘½åä¸”ç¬¦åˆè§„èŒƒ"
      action:
        type: script
        script:
          language: python
          path: "tools/governance/python/verify_compliance.py"
          args:
            - "--resources"
            - "/tmp/violations.json"
            - "--strict"
            - "true"
      timeout: "3m"
      continueOnError: false

    # æ­¥éª¤ 7: æ›´æ–°ç›‘æ§æŒ‡æ ‡
    - name: "æ›´æ–°ç›‘æ§æŒ‡æ ‡"
      description: "æ›´æ–° Prometheus æŒ‡æ ‡ä»¥åæ˜ ä¿®å¤ç»“æœ"
      action:
        type: script
        script:
          language: python
          path: "tools/governance/python/update_metrics.py"
          args:
            - "--type"
            - "remediation"
            - "--status"
            - "success"
      timeout: "1m"
      continueOnError: true

    # æ­¥éª¤ 8: ç”Ÿæˆä¿®å¤æŠ¥å‘Š
    - name: "æŠ¥å‘Šä¿®å¤ç»“æœ"
      description: "ç”Ÿæˆè¯¦ç»†çš„ä¿®å¤æŠ¥å‘Šå¹¶å‘é€é€šçŸ¥"
      action:
        type: script
        script:
          language: python
          path: "tools/governance/python/report_patch_result.py"
          args:
            - "--violations"
            - "/tmp/violations.json"
            - "--suggestions"
            - "/tmp/suggestions.json"
            - "--output"
            - "/tmp/report.html"
            - "--notify"
            - "true"
      timeout: "2m"
      continueOnError: true

  # éªŒè¯æ­¥éª¤
  verification:
    enabled: true
    checks:
      - name: "å‘½ååˆè§„æ£€æŸ¥"
        type: command
        command: "python tools/governance/python/verify_compliance.py --resources /tmp/violations.json"
        condition: "exit code == 0"
        timeout: "2m"

      - name: "èµ„æºå¥åº·æ£€æŸ¥"
        type: command
        command: "kubectl get pods --all-namespaces -o json | jq '.items[].status.phase' | grep -v Running | wc -l"
        condition: "stdout == 0"
        timeout: "1m"

      - name: "åˆè§„ç‡æ£€æŸ¥"
        type: metric
        metric: "naming_compliance_rate"
        condition: "> 95"
        timeout: "1m"

  # å›æ»šé…ç½®
  rollback:
    enabled: true
    automatic: true
    trigger:
      - "éªŒè¯å¤±è´¥"
      - "èµ„æºå¥åº·æ£€æŸ¥å¤±è´¥"
      - "é”™è¯¯ç‡ > 5%"
    steps:
      - name: "è¿˜åŸèµ„æºå‘½å"
        action:
          type: script
          script:
            language: bash
            path: "tools/governance/bash/restore_names.sh"
            args:
              - "/tmp/backup/"
        timeout: "10m"

      - name: "éªŒè¯å›æ»šæˆåŠŸ"
        action:
          type: script
          script:
            language: bash
            path: "tools/governance/bash/verify_rollback.sh"
            args:
              - "/tmp/backup/"
        timeout: "5m"

      - name: "æ›´æ–°å¤±è´¥æŒ‡æ ‡"
        action:
          type: script
          script:
            language: python
            path: "tools/governance/python/update_metrics.py"
            args:
              - "--type"
              - "remediation"
              - "--status"
              - "failed_rollback"

  # é€šçŸ¥é…ç½®
  notifications:
    onStart:
      - channel: "#governance-alerts"
        message: |
          ğŸ”§ **è‡ªåŠ¨ä¿®å¤å¼€å§‹**
          è§¦å‘å™¨: {{ .trigger.type }}
          è¿è§„æ•°é‡: {{ .violations_count }}
          ç¯å¢ƒ: {{ .environment }}

    onSuccess:
      - channel: "#governance-alerts"
        message: |
          âœ… **è‡ªåŠ¨ä¿®å¤æˆåŠŸ**
          ä¿®å¤æ•°é‡: {{ .fixed_count }}
          è€—æ—¶: {{ .duration }}
          æŠ¥å‘Š: {{ .report_url }}

    onFailure:
      - channel: "#governance-alerts"
        message: |
          âŒ **è‡ªåŠ¨ä¿®å¤å¤±è´¥**
          é”™è¯¯: {{ .error }}
          éœ€è¦äººå·¥ä»‹å…¥
          Runbook: https://wiki.example.com/runbooks/remediation-failure

    onRollback:
      - channel: "#governance-alerts"
        message: |
          âª **æ‰§è¡Œå›æ»š**
          åŸå› : {{ .rollback_reason }}
          çŠ¶æ€: {{ .rollback_status }}

  # å®¡è®¡å’Œæ—¥å¿—
  audit:
    enabled: true
    logLevel: "info"
    storage:
      type: "elasticsearch"
      index: "governance-remediation-logs"
      retention: "90d"
    fields:
      - "timestamp"
      - "playbook_name"
      - "trigger_type"
      - "violations_count"
      - "fixed_count"
      - "failed_count"
      - "duration"
      - "status"
      - "error_message"

  # æ€§èƒ½å’Œé™åˆ¶
  performance:
    maxConcurrent: 3  # æœ€å¤šåŒæ—¶è¿è¡Œ 3 ä¸ªä¿®å¤ä»»åŠ¡
    throttle:
      enabled: true
      maxPerHour: 10  # æ¯å°æ—¶æœ€å¤šè§¦å‘ 10 æ¬¡
    timeout: "30m"  # æ•´ä¸ª playbook æœ€å¤§æ‰§è¡Œæ—¶é—´
