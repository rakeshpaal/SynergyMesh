# Kubernetes Deployment Template
# 符合治理框架命名规范的 Deployment 模板

apiVersion: apps/v1
kind: Deployment
metadata:
  # 命名格式: {environment}-{app}-deploy-{version}
  # 示例: prod-payment-deploy-v1.0.0
  name: {{ .environment }}-{{ .app }}-deploy-{{ .version }}

  # 命名空间
  namespace: {{ .namespace | default .environment }}

  # 标签 (用于选择器和组织)
  labels:
    app: {{ .app }}
    version: {{ .version }}
    environment: {{ .environment }}
    managed-by: "governance-framework"

    # 数据分类 (安全要求)
    data-classification: {{ .dataClassification | default "internal" }}

    # 合规范围
    compliance-scope: {{ .complianceScope | default "none" }}

    # 所有者
    owner: {{ .owner }}
    team: {{ .team }}

    # 成本中心
    cost-center: {{ .costCenter }}

  # 注解
  annotations:
    description: {{ .description | quote }}
    contact: {{ .contact }}
    documentation: {{ .documentation }}

    # 变更追踪
    last-change-id: {{ .lastChangeId | default "CHG-XXXX-XXX" }}
    deployed-at: {{ .deployedAt | default "YYYY-MM-DDTHH:MM:SSZ" }}
    deployed-by: {{ .deployedBy }}

spec:
  # 副本数
  replicas: {{ .replicas | default 3 }}

  # 选择器
  selector:
    matchLabels:
      app: {{ .app }}
      version: {{ .version }}
      environment: {{ .environment }}

  # 更新策略
  strategy:
    type: {{ .strategyType | default "RollingUpdate" }}
    rollingUpdate:
      maxSurge: {{ .maxSurge | default "25%" }}
      maxUnavailable: {{ .maxUnavailable | default "25%" }}

  # Pod 模板
  template:
    metadata:
      labels:
        app: {{ .app }}
        version: {{ .version }}
        environment: {{ .environment }}
        managed-by: "governance-framework"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "{{ .metricsPort | default "8080" }}"
        prometheus.io/path: "{{ .metricsPath | default "/metrics" }}"

    spec:
      # Service Account
      serviceAccountName: {{ .serviceAccount | default (printf "%s-%s-sa" .environment .app) }}

      # 安全上下文
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000

      # 容器
      containers:
      - name: {{ .app }}
        image: {{ .image }}
        imagePullPolicy: {{ .imagePullPolicy | default "IfNotPresent" }}

        # 端口
        ports:
        - name: http
          containerPort: {{ .containerPort | default 8080 }}
          protocol: TCP
        - name: metrics
          containerPort: {{ .metricsPort | default 8080 }}
          protocol: TCP

        # 环境变量
        env:
        - name: ENVIRONMENT
          value: {{ .environment | quote }}
        - name: APP_NAME
          value: {{ .app | quote }}
        - name: APP_VERSION
          value: {{ .version | quote }}
        {{- range .env }}
        - name: {{ .name }}
          value: {{ .value | quote }}
        {{- end }}

        # 环境变量 from ConfigMap/Secret
        envFrom:
        {{- if .configMap }}
        - configMapRef:
            name: {{ .environment }}-{{ .app }}-cm-{{ .version }}
        {{- end }}
        {{- if .secret }}
        - secretRef:
            name: {{ .environment }}-{{ .app }}-secret-{{ .version }}
        {{- end }}

        # 资源限制
        resources:
          requests:
            memory: {{ .resources.requests.memory | default "256Mi" }}
            cpu: {{ .resources.requests.cpu | default "100m" }}
          limits:
            memory: {{ .resources.limits.memory | default "512Mi" }}
            cpu: {{ .resources.limits.cpu | default "500m" }}

        # 健康检查
        livenessProbe:
          httpGet:
            path: {{ .livenessPath | default "/health" }}
            port: http
          initialDelaySeconds: {{ .livenessInitialDelay | default 30 }}
          periodSeconds: {{ .livenessPeriod | default 10 }}
          timeoutSeconds: {{ .livenessTimeout | default 5 }}
          failureThreshold: {{ .livenessFailureThreshold | default 3 }}

        readinessProbe:
          httpGet:
            path: {{ .readinessPath | default "/ready" }}
            port: http
          initialDelaySeconds: {{ .readinessInitialDelay | default 10 }}
          periodSeconds: {{ .readinessPeriod | default 5 }}
          timeoutSeconds: {{ .readinessTimeout | default 3 }}
          failureThreshold: {{ .readinessFailureThreshold | default 3 }}

        # 容器安全上下文
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          capabilities:
            drop:
            - ALL

        # 卷挂载
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        {{- range .volumeMounts }}
        - name: {{ .name }}
          mountPath: {{ .mountPath }}
          {{- if .subPath }}
          subPath: {{ .subPath }}
          {{- end }}
          {{- if .readOnly }}
          readOnly: {{ .readOnly }}
          {{- end }}
        {{- end }}

      # 卷
      volumes:
      - name: tmp
        emptyDir: {}
      {{- range .volumes }}
      - name: {{ .name }}
        {{- if .configMap }}
        configMap:
          name: {{ .configMap.name }}
        {{- else if .secret }}
        secret:
          secretName: {{ .secret.secretName }}
        {{- else if .persistentVolumeClaim }}
        persistentVolumeClaim:
          claimName: {{ .persistentVolumeClaim.claimName }}
        {{- else if .emptyDir }}
        emptyDir: {}
        {{- end }}
      {{- end }}

      # 亲和性和反亲和性
      {{- if .affinity }}
      affinity:
        {{ .affinity | toYaml | nindent 8 }}
      {{- else }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - {{ .app }}
              topologyKey: kubernetes.io/hostname
      {{- end }}

      # 容忍度
      {{- if .tolerations }}
      tolerations:
        {{ .tolerations | toYaml | nindent 8 }}
      {{- end }}

---
# Service Template
apiVersion: v1
kind: Service
metadata:
  name: {{ .environment }}-{{ .app }}-svc-{{ .version }}
  namespace: {{ .namespace | default .environment }}
  labels:
    app: {{ .app }}
    version: {{ .version }}
    environment: {{ .environment }}
  annotations:
    description: "Service for {{ .app }}"

spec:
  type: {{ .serviceType | default "ClusterIP" }}
  selector:
    app: {{ .app }}
    version: {{ .version }}
    environment: {{ .environment }}
  ports:
  - name: http
    port: {{ .servicePort | default 80 }}
    targetPort: http
    protocol: TCP
  {{- if eq (.serviceType | default "ClusterIP") "NodePort" }}
    nodePort: {{ .nodePort }}
  {{- end }}

---
# HorizontalPodAutoscaler Template (Optional)
{{- if .autoscaling }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .environment }}-{{ .app }}-hpa-{{ .version }}
  namespace: {{ .namespace | default .environment }}
  labels:
    app: {{ .app }}
    version: {{ .version }}
    environment: {{ .environment }}

spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .environment }}-{{ .app }}-deploy-{{ .version }}

  minReplicas: {{ .autoscaling.minReplicas | default 2 }}
  maxReplicas: {{ .autoscaling.maxReplicas | default 10 }}

  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .autoscaling.targetCPU | default 70 }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .autoscaling.targetMemory | default 80 }}
{{- end }}
