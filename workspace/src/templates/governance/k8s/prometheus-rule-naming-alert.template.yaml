# Prometheus Rules for Naming Governance Monitoring
# 用于监控命名规范合规性的 Prometheus 告警规则

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: governance-naming-compliance
  namespace: monitoring
  labels:
    prometheus: kube-prometheus
    role: alert-rules
    category: governance

spec:
  groups:
  - name: governance.naming_compliance
    interval: 5m
    rules:

    # 命名合规率低于阈值
    - alert: NamingComplianceRateLow
      expr: |
        (
          sum(governance_naming_compliant_resources) /
          sum(governance_naming_total_resources)
        ) * 100 < 90
      for: 15m
      labels:
        severity: warning
        category: governance
        component: naming
      annotations:
        summary: "Naming compliance rate below threshold"
        description: |
          Naming compliance rate is {{ $value | humanizePercentage }}, below the 90% threshold.
          Review and fix non-compliant resources.
        runbook_url: "https://governance.example.com/runbooks/naming-compliance"

    # 命名合规率严重低于阈值
    - alert: NamingComplianceRateCritical
      expr: |
        (
          sum(governance_naming_compliant_resources) /
          sum(governance_naming_total_resources)
        ) * 100 < 85
      for: 5m
      labels:
        severity: critical
        category: governance
        component: naming
      annotations:
        summary: "Naming compliance rate critically low"
        description: |
          Naming compliance rate is {{ $value | humanizePercentage }}, below the critical 85% threshold.
          IMMEDIATE ACTION REQUIRED.
        runbook_url: "https://governance.example.com/runbooks/naming-compliance"

    # 发现新的命名违规
    - alert: NewNamingViolations
      expr: |
        increase(governance_naming_violations_total[5m]) > 0
      labels:
        severity: warning
        category: governance
        component: naming
      annotations:
        summary: "New naming violations detected"
        description: |
          {{ $value }} new naming violations detected in the last 5 minutes.
          Resource: {{ $labels.resource_type }}
          Namespace: {{ $labels.namespace }}
        runbook_url: "https://governance.example.com/runbooks/naming-violations"

    # 生产环境命名违规
    - alert: ProductionNamingViolation
      expr: |
        governance_naming_violations{environment="production"} > 0
      for: 1m
      labels:
        severity: critical
        category: governance
        component: naming
        environment: production
      annotations:
        summary: "Naming violation in production environment"
        description: |
          {{ $value }} naming violations detected in PRODUCTION environment.
          This must be addressed immediately.
          Resource: {{ $labels.resource_type }}
          Namespace: {{ $labels.namespace }}
        runbook_url: "https://governance.example.com/runbooks/prod-violations"

    # 未标记数据分类
    - alert: MissingDataClassification
      expr: |
        count(
          kube_pod_info{label_data_classification=""}
        ) > 10
      for: 30m
      labels:
        severity: warning
        category: governance
        component: security
      annotations:
        summary: "Resources missing data classification label"
        description: |
          {{ $value }} pods are missing the required 'data-classification' label.
          All resources must have proper data classification.
        runbook_url: "https://governance.example.com/runbooks/data-classification"

    # 遗留命名模式仍在使用
    - alert: LegacyNamingPatternInUse
      expr: |
        governance_naming_legacy_pattern_usage > 0
      for: 7d
      labels:
        severity: info
        category: governance
        component: naming
      annotations:
        summary: "Legacy naming patterns still in use"
        description: |
          {{ $value }} resources are still using legacy naming patterns.
          Plan migration to new naming convention.
        runbook_url: "https://governance.example.com/runbooks/legacy-migration"

  - name: governance.change_management
    interval: 5m
    rules:

    # 变更成功率低
    - alert: ChangeSuccessRateLow
      expr: |
        (
          sum(rate(governance_changes_successful_total[24h])) /
          sum(rate(governance_changes_total[24h]))
        ) * 100 < 95
      for: 1h
      labels:
        severity: warning
        category: governance
        component: change-management
      annotations:
        summary: "Change success rate below threshold"
        description: |
          Change success rate is {{ $value | humanizePercentage }}, below the 95% threshold.
          Review recent failures and improve change procedures.
        runbook_url: "https://governance.example.com/runbooks/change-success-rate"

    # 紧急变更比例过高
    - alert: EmergencyChangeRateHigh
      expr: |
        (
          sum(rate(governance_changes_total{type="紧急变更"}[7d])) /
          sum(rate(governance_changes_total[7d]))
        ) * 100 > 5
      for: 1d
      labels:
        severity: warning
        category: governance
        component: change-management
      annotations:
        summary: "Emergency change rate is too high"
        description: |
          Emergency changes account for {{ $value | humanizePercentage }} of all changes,
          exceeding the 5% threshold. Review change planning processes.
        runbook_url: "https://governance.example.com/runbooks/emergency-changes"

    # 未批准的变更
    - alert: UnapprovedChangeDetected
      expr: |
        governance_changes_unapproved_total > 0
      labels:
        severity: critical
        category: governance
        component: change-management
      annotations:
        summary: "Unapproved change detected"
        description: |
          {{ $value }} unapproved changes detected.
          All changes must go through proper approval process.
          Change ID: {{ $labels.change_id }}
        runbook_url: "https://governance.example.com/runbooks/unapproved-changes"

  - name: governance.exceptions
    interval: 5m
    rules:

    # 例外即将到期
    - alert: ExceptionExpiringSoon
      expr: |
        (governance_exception_expiry_timestamp - time()) < 7 * 24 * 3600
      labels:
        severity: warning
        category: governance
        component: exception-management
      annotations:
        summary: "Governance exception expiring soon"
        description: |
          Exception {{ $labels.exception_id }} will expire in less than 7 days.
          Review and renew if necessary, or implement remediation.
        runbook_url: "https://governance.example.com/runbooks/exception-renewal"

    # 例外已过期但仍在使用
    - alert: ExpiredExceptionInUse
      expr: |
        governance_exception_expired_active > 0
      labels:
        severity: critical
        category: governance
        component: exception-management
      annotations:
        summary: "Expired exception still in use"
        description: |
          {{ $value }} expired exceptions are still active.
          These must be revoked or renewed immediately.
          Exception ID: {{ $labels.exception_id }}
        runbook_url: "https://governance.example.com/runbooks/expired-exceptions"

    # 高风险例外数量过多
    - alert: HighRiskExceptionCountHigh
      expr: |
        count(governance_exception_risk_level{level="高"}) > 5
      for: 1d
      labels:
        severity: warning
        category: governance
        component: exception-management
      annotations:
        summary: "Too many high-risk exceptions"
        description: |
          {{ $value }} high-risk exceptions are currently active.
          Review and reduce high-risk exceptions.
        runbook_url: "https://governance.example.com/runbooks/high-risk-exceptions"

  - name: governance.health
    interval: 5m
    rules:

    # 治理健康分数低
    - alert: GovernanceHealthScoreLow
      expr: |
        governance_health_score < 70
      for: 1h
      labels:
        severity: warning
        category: governance
      annotations:
        summary: "Governance health score is low"
        description: |
          Overall governance health score is {{ $value }}, below the 70 threshold.
          Review compliance metrics and address issues.
        runbook_url: "https://governance.example.com/runbooks/health-score"

    # 审计发现未解决
    - alert: UnresolvedAuditFindings
      expr: |
        count(governance_audit_findings{status="open",severity=~"critical|high"}) > 10
      for: 7d
      labels:
        severity: warning
        category: governance
        component: audit
      annotations:
        summary: "Unresolved high-severity audit findings"
        description: |
          {{ $value }} high-severity audit findings remain unresolved for over 7 days.
          Review and prioritize remediation.
        runbook_url: "https://governance.example.com/runbooks/audit-findings"
