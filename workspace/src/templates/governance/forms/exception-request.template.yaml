apiVersion: governance.machinenativeops.io/v1alpha1
kind: ComplianceExceptionRequest
metadata:
  # 例外申请唯一标识符 (格式: EXC-YYYY-NNN)
  id: "EXC-YYYY-NNN"

  # 申请人或团队
  applicant: "team-name-or-user-id"

  # 创建时间 (自动填充)
  createdAt: "YYYY-MM-DDTHH:MM:SSZ"

  # 标签 (用于分类)
  labels:
    urgency: ""        # high | medium | low
    category: ""       # naming | security | process | documentation

spec:
  # 例外项目说明 (必填，最少 10 字符)
  # 描述违反了哪条规则或标准
  item: |
    详细说明需要例外的项目。
    例如: "遗留支付系统使用非标准命名convention: legacy-payment-svc"

  # 违反的具体策略 (必填)
  # 引用具体的策略ID或路径
  policyViolated: "naming-governance/k8s-deployment-naming"

  # 例外理由 (必填，最少 20 字符)
  # 说明为什么需要这个例外
  reason: |
    详细解释为什么需要偏离标准规范。
    例如: "遗留系统迁移成本过高，且计划在 6 个月内退役。
    重命名会导致停机 2 周，影响关键业务。"

  # 业务正当性 (可选但推荐)
  # 从业务角度说明必要性
  businessJustification: |
    业务影响和必要性说明。
    例如: "该系统服务 500+ 重要客户，停机会造成重大业务损失。
    客户合同中硬编码了现有服务名称。"

  # 技术限制 (可选但推荐)
  # 说明技术上的限制或困难
  technicalConstraints: |
    技术限制说明。
    例如: "服务发现、负载均衡、监控系统都硬编码了现有名称。
    涉及 20+ 个配置文件和 5 个第三方集成。"

  # 风险评估 (必填)
  riskEvaluation:
    # 风险等级 (选择: 高 | 中 | 低)
    level: "中"

    # 风险描述
    description: |
      评估例外带来的风险。
      例如: "命名不一致可能导致运维团队混淆，
      但影响可通过文档和监控缓解。"

    # 风险缓解措施 (必填，至少一项)
    mitigationMeasures:
      - "在文档中明确标注例外"
      - "设置特殊监控和告警"
      - "禁止创建类似的新资源"
      - "定期复审例外状态"

    # 剩余风险 (实施缓解措施后)
    residualRisk: |
      实施缓解措施后的剩余风险。
      例如: "运维人员可能误操作，但概率低且影响可控。"

  # 请求到期日期 (必填，格式: YYYY-MM-DD)
  # 最长不超过 12 个月
  requestedExpire: "YYYY-MM-DD"

  # 关联的变更请求 (可选)
  # 如果例外需要配合变更实施
  linkedChangeId: "CHG-YYYY-NNN"

  # 例外范围 (必填)
  scope:
    # 受影响的资源
    resources:
      - "production/legacy-payment-svc"
      - "production/legacy-payment-deploy"

    # 适用环境
    environments:
      - "production"

    # 相关服务
    services:
      - "legacy-payment"

  # 审批信息
  approval:
    # 审批状态 (默认: UnderReview)
    # 选择: UnderReview | Approved | Rejected | Expired | Revoked
    status: "UnderReview"

    # 审批人 (审批后填写)
    reviewer: ""

    # 审批时间 (审批后填写)
    reviewedAt: ""

    # 批准条件 (可选)
    approvalConditions:
      - "每季度复审一次"
      - "不得扩展到其他服务"
      - "必须有明确的退役计划"

    # 审批意见 (可选)
    comments: ""

  # 监控和审计 (可选)
  monitoring:
    # 复审频率 (monthly | quarterly | semi-annually)
    reviewFrequency: "quarterly"

    # 是否启用告警
    alertsEnabled: true

    # 是否记录审计日志
    auditLog: true

  # 补救计划 (必填)
  # 说明如何最终符合规范
  remediation:
    # 补救计划描述
    plan: |
      详细的补救计划。
      例如: "系统将在 2026-06-30 退役，届时例外自动解决。
      在此之前，禁止创建新的类似资源。"

    # 目标日期 (必填)
    targetDate: "YYYY-MM-DD"

    # 负责人 (必填)
    responsible: "team-lead-or-user-id"

# 例外状态 (系统自动更新)
status:
  # 当前状态
  # Active | Expired | Revoked | Remediated
  currentStatus: "Pending"

  # 到期时间 (批准后自动设置)
  expiresAt: ""

  # 最后复审日期
  lastReviewDate: ""

  # 下次复审日期
  nextReviewDate: ""

  # 续期次数
  renewalCount: 0

---
# 填写指南
#
# 1. 何时申请例外
#    - 无法在合理时间内符合标准规范
#    - 有充分的业务或技术理由
#    - 风险可控且有缓解措施
#    - 有明确的补救计划
#
# 2. 例外类型
#    - Naming Compliance: 命名规范例外
#    - Security Policy: 安全策略例外
#    - Change Management: 变更管理流程例外
#    - Documentation: 文档要求例外
#
# 3. 风险评估原则
#    - 低: 影响范围小，易于缓解
#    - 中: 影响范围中等，需要额外控制
#    - 高: 影响范围大，需要高层审批
#
# 4. 审批层级 (根据风险等级)
#    - 低风险: Team Lead 审批
#    - 中风险: Department Manager + Governance Board
#    - 高风险: VP Engineering + CISO + Governance Board
#
# 5. 缓解措施建议
#    - 文档化例外情况
#    - 设置特殊监控
#    - 限制例外范围
#    - 定期复审
#    - 禁止扩散
#
# 6. 补救计划要求
#    - 必须有明确的目标日期
#    - 说明具体实施步骤
#    - 指定负责人
#    - 考虑依赖和阻塞因素
#
# 7. 禁止事项
#    - 为避免工作而申请例外
#    - 无实质理由的例外
#    - 无补救计划的例外
#    - 范围过大的例外
#
# 8. 提交前检查清单
#    [ ] 充分的理由和正当性
#    [ ] 完整的风险评估
#    [ ] 有效的缓解措施
#    [ ] 明确的例外范围
#    [ ] 可执行的补救计划
#    [ ] 合理的到期日期 (≤ 12 个月)
#    [ ] 已尝试其他解决方案
#
# 9. 常见例外场景
#    - 遗留系统迁移成本过高
#    - 第三方集成依赖现有配置
#    - 临时试验或 POC 项目
#    - 计划退役的系统
#    - 技术限制暂时无法解决
#
# 10. 例外生命周期
#     Draft → Under Review → Approved → Active → (Remediated | Expired | Revoked)
