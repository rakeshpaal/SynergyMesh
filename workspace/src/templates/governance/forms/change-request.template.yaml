apiVersion: governance.machinenativeops.io/v1alpha1
kind: ChangeRequest
metadata:
  # 变更请求唯一标识符 (格式: CHG-YYYY-NNN)
  id: "CHG-YYYY-NNN"

  # 变更简要描述 (10-200 字符)
  title: "简要描述变更内容"

  # 创建时间 (自动填充)
  createdAt: "YYYY-MM-DDTHH:MM:SSZ"

  # 标签 (用于分类和搜索)
  labels:
    service: ""        # 相关服务名称
    team: ""           # 负责团队
    priority: ""       # 优先级: P0-P3

spec:
  # 变更类型 (必填)
  # 选择: 标准变更 | 常规变更 | 紧急变更
  type: "常规变更"

  # 申请人信息 (必填)
  requester:
    userId: ""         # 用户ID
    name: ""           # 姓名
    email: ""          # 邮箱
    team: ""           # 团队

  # 风险等级 (必填)
  # 选择: 高 | 中 | 低
  riskLevel: "中"

  # 优先级 (可选，默认 P2)
  # 选择: P0 | P1 | P2 | P3
  priority: "P2"

  # 影响评估 (必填)
  impactAssessment:
    # 受影响的服务列表
    servicesAffected:
      - "service-name-1"
      - "service-name-2"

    # 预期停机时间 (如: "0 min", "5 min", "30 min")
    downtimeExpected: "0 min"

    # 受影响用户数 (可选)
    usersImpacted: 0

    # 数据影响 (选择: none | read-only | write | migration)
    dataImpact: "none"

    # 依赖项 (可选)
    dependencies:
      - "其他变更或服务的依赖"

  # 审批信息 (必填)
  approval:
    # 审批方式 (选择: Auto | CAB | Manager | TechLead)
    method: "CAB"

    # 审批状态 (默认: Pending)
    # 选择: Pending | Approved | Rejected | Withdrawn
    status: "Pending"

    # 审批人 (审批后填写)
    approver: ""

    # 审批时间 (审批后填写)
    approvedAt: ""

    # 审批意见 (可选)
    comments: ""

  # 计划变更窗口 (可选)
  scheduledWindow:
    # 开始时间
    startTime: "YYYY-MM-DDTHH:MM:SSZ"

    # 结束时间
    endTime: "YYYY-MM-DDTHH:MM:SSZ"

    # 时区 (默认: UTC)
    timezone: "UTC"

  # 实施计划 (必填)
  implementationPlan:
    # 实施步骤
    steps:
      - order: 1
        description: "步骤1: 备份当前配置"
        estimatedDuration: "5 min"
        assignee: ""
        validationCriteria: "备份文件存在且可恢复"

      - order: 2
        description: "步骤2: 执行变更"
        estimatedDuration: "10 min"
        assignee: ""
        validationCriteria: "变更成功，无错误日志"

      - order: 3
        description: "步骤3: 验证变更效果"
        estimatedDuration: "5 min"
        assignee: ""
        validationCriteria: "服务健康检查通过"

    # 实施前检查项
    preChecks:
      - "确认备份已完成"
      - "验证回滚方案可用"
      - "确认监控和告警正常"
      - "通知相关团队"

    # 实施后验证项
    postChecks:
      - "检查服务健康状态"
      - "验证关键业务流程"
      - "监控错误率和性能指标"
      - "确认无告警触发"

  # 回滚计划 (必填)
  rollbackPlan:
    # 回滚步骤
    steps:
      - order: 1
        description: "步骤1: 停止新版本"

      - order: 2
        description: "步骤2: 恢复到前一版本"

      - order: 3
        description: "步骤3: 验证回滚成功"

    # 回滚触发条件
    triggers:
      - "健康检查连续失败 3 次"
      - "错误率超过 5%"
      - "响应时间超过基线 200%"
      - "业务流程验证失败"

    # 预计回滚时间
    estimatedTime: "10 min"

  # 测试计划 (可选)
  testing:
    # 测试环境
    environment: "staging"

    # 测试用例
    testCases:
      - "功能测试: 验证新功能正常工作"
      - "性能测试: 响应时间符合预期"
      - "集成测试: 与其他服务正常交互"

    # 测试结果链接 (可选)
    testResults: "https://link-to-test-report"

  # 指标和审计 (可选)
  metrics:
    # KPI 指标
    kpi:
      - name: "response_time"
        baseline: "100ms"
        target: "<150ms"

      - name: "error_rate"
        baseline: "0.1%"
        target: "<0.2%"

    # 审计
    audit:
      logEnabled: true
      reviewer: ""

  # 沟通计划 (可选)
  communication:
    # 利益相关者
    stakeholders:
      - "team-lead@example.com"
      - "product-manager@example.com"

    # 通知渠道
    notificationChannels:
      - "slack:#engineering"
      - "email:team@example.com"

    # 是否更新状态页
    statusPageUpdate: false

# 变更状态 (系统自动更新)
status:
  # 当前阶段
  # Draft | Pending Approval | Approved | Scheduled | In Progress | Completed | Failed | Rolled Back
  phase: "Draft"

  # 最后更新时间
  lastUpdate: ""

  # 备注
  notes: []

---
# 填写指南
#
# 1. 基本信息
#    - id: 使用格式 CHG-YYYY-NNN，例如 CHG-2025-001
#    - title: 简洁描述变更内容，如 "升级 Payment Service 到 v2.0.0"
#
# 2. 变更类型选择
#    - 标准变更: 低风险、预先批准、可自动执行
#    - 常规变更: 中等风险、需要 CAB 审批
#    - 紧急变更: 用于生产事故修复
#
# 3. 风险评估
#    - 低: 影响 < 100 用户，有完整回滚方案
#    - 中: 影响 100-1000 用户，可能短暂停机
#    - 高: 影响 > 1000 用户，需要停机或数据迁移
#
# 4. 审批方式
#    - Auto: 低风险标准变更自动批准
#    - CAB: 变更咨询委员会审批 (常规变更)
#    - Manager: 经理审批
#    - TechLead: 技术负责人审批
#
# 5. 实施计划
#    - 详细列出每个步骤
#    - 包含预估时间
#    - 指定负责人
#    - 明确验证标准
#
# 6. 回滚计划
#    - 必须有明确的回滚步骤
#    - 定义回滚触发条件
#    - 估算回滚时间
#
# 7. 提交前检查清单
#    [ ] 所有必填字段已填写
#    [ ] 风险评估完整
#    [ ] 实施计划详细且可执行
#    [ ] 回滚计划明确
#    [ ] 测试已在预发布环境完成
#    [ ] 相关团队已通知
#    [ ] 选择了正确的变更窗口
