# GitLab CI: 命名规范验证
# 用途: 自动检查 MR 中的资源命名是否符合组织规范
# 触发: Merge Request

variables:
  GOVERNANCE_REPO: "https://github.com/MachineNativeOps/MachineNativeOps.git"
  GOVERNANCE_BRANCH: "main"
  PYTHON_VERSION: "3.11"

stages:
  - validate
  - report

# 命名规范验证
naming-compliance:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - apt-get update && apt-get install -y git
    - pip install pyyaml jsonschema requests
    - git clone --depth 1 --branch ${GOVERNANCE_BRANCH} ${GOVERNANCE_REPO} governance-framework
  script:
    # 获取变更的文件
    - |
      git diff --name-only ${CI_MERGE_REQUEST_DIFF_BASE_SHA}...${CI_COMMIT_SHA} \
        | grep -E '\.(yaml|yml|json|tf)$' > changed-files.txt || true

    # 运行命名验证
    - |
      if [ -s changed-files.txt ]; then
        python governance-framework/tools/python/validate_naming.py \
          --files-list changed-files.txt \
          --policies governance-framework/policies/naming/ \
          --schemas governance-framework/schemas/ \
          --output naming-report.json \
          --format json
      else
        echo '{"status": "skipped", "message": "No relevant files changed"}' > naming-report.json
      fi
  artifacts:
    reports:
      junit: naming-report.xml
    paths:
      - naming-report.json
      - naming-report.xml
    expire_in: 30 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "**/*.yaml"
        - "**/*.yml"
        - "**/*.json"
        - "**/*.tf"

# Kubernetes 资源验证
k8s-naming-validation:
  stage: validate
  image: alpine/k8s:1.28.3
  before_script:
    - apk add --no-cache python3 py3-pip git
    - pip3 install pyyaml jsonschema
  script:
    # 验证 Kubernetes manifest 语法
    - |
      find . -name "*.yaml" -o -name "*.yml" | while read file; do
        if grep -q "apiVersion.*kind:" "$file"; then
          echo "Validating K8s manifest: $file"
          kubectl apply --dry-run=client -f "$file" || exit 1
        fi
      done

    # 验证 Deployment 命名
    - |
      python3 << 'EOF'
      import yaml
      import re
      import sys
      from pathlib import Path

      # 命名模式: {env}-{app}-deploy-{version}
      pattern = re.compile(r'^(dev|staging|prod)-[a-z0-9-]+-deploy-v\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?$')

      errors = []
      for yaml_file in Path('.').rglob('*.yaml'):
          try:
              with open(yaml_file) as f:
                  docs = yaml.safe_load_all(f)
                  for doc in docs:
                      if doc and doc.get('kind') == 'Deployment':
                          name = doc.get('metadata', {}).get('name', '')
                          if not pattern.match(name):
                              errors.append(f'{yaml_file}: Deployment "{name}" does not match naming convention')
                              errors.append(f'  Expected: {{env}}-{{app}}-deploy-{{version}}')
                              errors.append(f'  Example: prod-payment-deploy-v1.0.0')
          except Exception as e:
              continue

      if errors:
          print('\n'.join(errors), file=sys.stderr)
          sys.exit(1)
      else:
          print('✓ All Kubernetes resource names are compliant')
      EOF
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "**/*.yaml"
        - "**/*.yml"

# 生成 MR 评论报告
post-mr-comment:
  stage: report
  image: python:${PYTHON_VERSION}-slim
  dependencies:
    - naming-compliance
  before_script:
    - pip install requests pyyaml
  script:
    - |
      python3 << 'EOF'
      import os
      import json
      import requests

      # 读取验证报告
      with open('naming-report.json') as f:
          report = json.load(f)

      # 生成 Markdown 评论
      status = report.get('status', 'unknown')
      emoji = '✅' if status == 'passed' else '❌' if status == 'failed' else '⚠️'

      comment = f"""
      ## {emoji} Naming Compliance Report

      **Status**: {status.upper()}

      ### Summary
      - Total files checked: {report.get('total_files', 0)}
      - Compliant: {report.get('compliant', 0)}
      - Violations: {report.get('violations', 0)}

      """

      if report.get('violations', 0) > 0:
          comment += "\n### Violations\n\n"
          for violation in report.get('violation_details', []):
              comment += f"- **{violation['file']}**: {violation['message']}\n"
              comment += f"  - Expected: `{violation.get('expected', 'N/A')}`\n"
              comment += f"  - Actual: `{violation.get('actual', 'N/A')}`\n\n"

      comment += "\n---\n*Automated by Governance Framework*"

      # 发送到 GitLab MR
      gitlab_api = os.environ['CI_API_V4_URL']
      project_id = os.environ['CI_PROJECT_ID']
      mr_iid = os.environ['CI_MERGE_REQUEST_IID']
      token = os.environ['GITLAB_TOKEN']

      url = f"{gitlab_api}/projects/{project_id}/merge_requests/{mr_iid}/notes"
      headers = {'PRIVATE-TOKEN': token}
      data = {'body': comment}

      response = requests.post(url, headers=headers, json=data)
      if response.status_code == 201:
          print('✓ Comment posted to MR')
      else:
          print(f'✗ Failed to post comment: {response.status_code}')
      EOF
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  only:
    variables:
      - $GITLAB_TOKEN

# 配置说明:
#
# 1. 环境变量设置 (GitLab CI/CD Settings)
#    - GITLAB_TOKEN: 用于发布 MR 评论的 Personal Access Token
#                    需要 api 权限
#
# 2. 触发条件
#    - Merge Request 事件
#    - 包含 YAML/JSON/Terraform 文件变更
#
# 3. Pipeline 阶段
#    - validate: 运行命名规范和 K8s 验证
#    - report: 生成报告并发布 MR 评论
#
# 4. 自定义配置
#    - 修改 GOVERNANCE_REPO 指向你的治理仓库
#    - 调整验证工具参数和规则
#    - 自定义报告格式和内容
#
# 5. 集成到你的项目
#    - 复制此文件到项目根目录 .gitlab-ci.yml
#    - 或将内容合并到现有的 .gitlab-ci.yml
#    - 设置必需的环境变量
#    - 根据需要调整触发规则
