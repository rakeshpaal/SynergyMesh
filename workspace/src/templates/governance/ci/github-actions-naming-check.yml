# GitHub Actions: 命名规范验证
# 用途: 自动检查 PR 中的资源命名是否符合组织规范
# 触发: Pull Request 到 main/develop 分支

name: Naming Compliance Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '**/*.tf'
      - '**/*.json'

jobs:
  naming-validation:
    runs-on: ubuntu-latest
    name: Validate Resource Naming

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史以比较变更

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pyyaml jsonschema

      - name: Checkout governance framework
        uses: actions/checkout@v4
        with:
          repository: MachineNativeOps/MachineNativeOps
          path: governance-framework
          sparse-checkout: |
            schemas/
            policies/
            tools/

      - name: Run naming validation
        id: naming-check
        run: |
          python governance-framework/tools/python/validate_naming.py \
            --changed-files-only \
            --base-ref ${{ github.event.pull_request.base.sha }} \
            --head-ref ${{ github.event.pull_request.head.sha }} \
            --policies governance-framework/policies/naming/ \
            --schemas governance-framework/schemas/ \
            --output naming-report.json
        continue-on-error: true

      - name: Generate report comment
        if: always()
        id: report
        run: |
          python governance-framework/tools/python/generate_pr_comment.py \
            --report naming-report.json \
            --output comment.md

      - name: Post PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');

            // 查找已存在的 bot 评论
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Naming Compliance Report')
            );

            // 更新或创建评论
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: naming-validation-report
          path: naming-report.json
          retention-days: 30

      - name: Check validation status
        if: steps.naming-check.outcome == 'failure'
        run: |
          echo "::error::Naming validation failed. Please review the report and fix the issues."
          exit 1

      - name: Add labels
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['governance-violation', 'naming-compliance']
            });

  kubernetes-naming:
    runs-on: ubuntu-latest
    name: Kubernetes Resource Naming
    if: contains(github.event.pull_request.changed_files, '.yaml') || contains(github.event.pull_request.changed_files, '.yml')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup tools
        run: |
          # 安装 kubectl 和 kustomize
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          # 查找所有 Kubernetes YAML 文件
          find . -name "*.yaml" -o -name "*.yml" | while read file; do
            # 检查是否是 Kubernetes 资源
            if grep -q "apiVersion.*kind:" "$file"; then
              echo "Validating: $file"
              kubectl apply --dry-run=client -f "$file" || exit 1
            fi
          done

      - name: Check Kubernetes naming convention
        run: |
          # 验证 Kubernetes 资源命名
          python -c "
          import yaml
          import re
          import sys
          from pathlib import Path

          pattern = re.compile(r'^(dev|staging|prod)-[a-z0-9-]+-deploy-v\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?$')

          errors = []
          for yaml_file in Path('.').rglob('*.yaml'):
              try:
                  with open(yaml_file) as f:
                      docs = yaml.safe_load_all(f)
                      for doc in docs:
                          if doc and doc.get('kind') == 'Deployment':
                              name = doc.get('metadata', {}).get('name', '')
                              if not pattern.match(name):
                                  errors.append(f'{yaml_file}: Deployment name \'{name}\' does not match naming convention')
              except Exception as e:
                  pass

          if errors:
              for error in errors:
                  print(f'::error::{error}')
              sys.exit(1)
          "

# 配置说明:
#
# 1. 触发条件
#    - Pull Request 到 main/develop 分支
#    - 包含 YAML/JSON/Terraform 文件变更
#
# 2. 验证内容
#    - 资源命名符合规范
#    - Kubernetes manifest 语法正确
#    - 遵循 DNS-1123 命名规则
#
# 3. 报告输出
#    - PR 评论中显示验证结果
#    - 上传详细报告作为 artifact
#    - 失败时添加标签
#
# 4. 自定义配置
#    - 修改 policies/ 路径指向你的策略仓库
#    - 调整验证工具参数
#    - 自定义报告格式
#
# 5. 集成到你的项目
#    - 复制此文件到 .github/workflows/
#    - 根据项目需求调整触发条件和路径
#    - 确保有权限访问 governance-framework 仓库
