# Change Request Schema
# 变更请求的标准结构
$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://machinenativeops.io/schemas/change-request.schema.yaml"
title: "Change Request Schema"
description: "Schema for standardized change requests"
type: object
required:
  - apiVersion
  - kind
  - metadata
  - spec
properties:
  apiVersion:
    type: string
    const: "governance.machinenativeops.io/v1alpha1"

  kind:
    type: string
    const: "ChangeRequest"

  metadata:
    type: object
    required:
      - id
      - title
    properties:
      id:
        type: string
        description: "变更唯一标识符"
        pattern: "^CHG-\\d{4}-\\d{3,5}$"
        examples:
          - "CHG-2025-001"
          - "CHG-2025-12345"

      title:
        type: string
        description: "变更简要描述"
        minLength: 10
        maxLength: 200

      createdAt:
        type: string
        format: "date-time"
        description: "创建时间"

      updatedAt:
        type: string
        format: "date-time"
        description: "最后更新时间"

      labels:
        type: object
        additionalProperties:
          type: string

  spec:
    type: object
    required:
      - type
      - requester
      - riskLevel
      - implementationPlan
      - rollbackPlan
    properties:
      type:
        type: string
        description: "变更类型"
        enum:
          - "标准变更"
          - "常规变更"
          - "紧急变更"
        examples:
          - "标准变更"

      requester:
        type: object
        description: "申请人信息"
        required:
          - userId
          - team
        properties:
          userId:
            type: string
          name:
            type: string
          email:
            type: string
            format: "email"
          team:
            type: string

      riskLevel:
        type: string
        description: "风险等级"
        enum: ["高", "中", "低"]

      priority:
        type: string
        description: "优先级"
        enum: ["P0", "P1", "P2", "P3"]
        default: "P2"

      impactAssessment:
        type: object
        description: "影响评估"
        properties:
          servicesAffected:
            type: array
            items:
              type: string
            description: "受影响的服务"
          downtimeExpected:
            type: string
            description: "预期停机时间"
            examples:
              - "0 min"
              - "5 min"
              - "30 min"
          usersImpacted:
            type: integer
            description: "受影响用户数"
          dataImpact:
            type: string
            enum: ["none", "read-only", "write", "migration"]
          dependencies:
            type: array
            items:
              type: string
            description: "依赖的其他变更或服务"

      approval:
        type: object
        description: "审批信息"
        required:
          - method
          - status
        properties:
          method:
            type: string
            enum: ["Auto", "CAB", "Manager", "TechLead"]
            description: |
              - Auto: 自动批准（低风险标准变更）
              - CAB: 变更咨询委员会审批
              - Manager: 经理审批
              - TechLead: 技术负责人审批
          status:
            type: string
            enum: ["Pending", "Approved", "Rejected", "Withdrawn"]
            default: "Pending"
          approver:
            type: string
            description: "审批人"
          approvedAt:
            type: string
            format: "date-time"
          comments:
            type: string
            description: "审批意见"

      scheduledWindow:
        type: object
        description: "计划变更窗口"
        properties:
          startTime:
            type: string
            format: "date-time"
          endTime:
            type: string
            format: "date-time"
          timezone:
            type: string
            default: "UTC"

      implementationPlan:
        type: object
        description: "实施计划"
        required:
          - steps
        properties:
          steps:
            type: array
            items:
              type: object
              required:
                - order
                - description
              properties:
                order:
                  type: integer
                description:
                  type: string
                estimatedDuration:
                  type: string
                assignee:
                  type: string
                validationCriteria:
                  type: string
          preChecks:
            type: array
            items:
              type: string
            description: "实施前检查项"
          postChecks:
            type: array
            items:
              type: string
            description: "实施后验证项"

      rollbackPlan:
        type: object
        description: "回滚计划"
        required:
          - steps
        properties:
          steps:
            type: array
            items:
              type: object
              required:
                - order
                - description
              properties:
                order:
                  type: integer
                description:
                  type: string
          triggers:
            type: array
            items:
              type: string
            description: "触发回滚的条件"
          estimatedTime:
            type: string
            description: "预计回滚时间"

      testing:
        type: object
        description: "测试计划"
        properties:
          environment:
            type: string
            description: "测试环境"
          testCases:
            type: array
            items:
              type: string
          testResults:
            type: string
            description: "测试结果链接"

      metrics:
        type: object
        description: "指标和审计"
        properties:
          kpi:
            type: array
            items:
              type: object
              properties:
                name:
                  type: string
                baseline:
                  type: string
                target:
                  type: string
          audit:
            type: object
            properties:
              logEnabled:
                type: boolean
                default: true
              reviewer:
                type: string

      communication:
        type: object
        description: "沟通计划"
        properties:
          stakeholders:
            type: array
            items:
              type: string
          notificationChannels:
            type: array
            items:
              type: string
            examples:
              - "slack:#engineering"
              - "email:team@example.com"
          statusPageUpdate:
            type: boolean

  status:
    type: object
    description: "变更状态（自动更新）"
    properties:
      phase:
        type: string
        enum:
          - "Draft"
          - "Pending Approval"
          - "Approved"
          - "Scheduled"
          - "In Progress"
          - "Completed"
          - "Failed"
          - "Rolled Back"
      lastUpdate:
        type: string
        format: "date-time"
      notes:
        type: array
        items:
          type: object
          properties:
            timestamp:
              type: string
              format: "date-time"
            author:
              type: string
            message:
              type: string

# 完整示例
example:
  apiVersion: "governance.machinenativeops.io/v1alpha1"
  kind: "ChangeRequest"
  metadata:
    id: "CHG-2025-001"
    title: "升级 Payment Service 到 v2.0.0"
    createdAt: "2025-12-17T10:00:00Z"
    labels:
      service: "payment"
      team: "backend"
  spec:
    type: "标准变更"
    requester:
      userId: "john.doe"
      name: "John Doe"
      email: "john@example.com"
      team: "backend-team"
    riskLevel: "中"
    priority: "P2"
    impactAssessment:
      servicesAffected:
        - "payment-service"
        - "order-service"
      downtimeExpected: "5 min"
      usersImpacted: 1000
      dataImpact: "none"
    approval:
      method: "TechLead"
      status: "Approved"
      approver: "tech-lead@example.com"
      approvedAt: "2025-12-17T11:00:00Z"
    scheduledWindow:
      startTime: "2025-12-20T02:00:00Z"
      endTime: "2025-12-20T03:00:00Z"
      timezone: "UTC"
    implementationPlan:
      steps:
        - order: 1
          description: "备份当前配置"
          estimatedDuration: "5 min"
        - order: 2
          description: "部署新版本"
          estimatedDuration: "10 min"
        - order: 3
          description: "验证健康检查"
          estimatedDuration: "5 min"
      preChecks:
        - "确认备份完成"
        - "验证测试环境"
      postChecks:
        - "检查服务健康状态"
        - "验证关键业务流程"
    rollbackPlan:
      steps:
        - order: 1
          description: "回滚到前一版本"
        - order: 2
          description: "恢复配置"
      triggers:
        - "健康检查失败"
        - "错误率超过 1%"
      estimatedTime: "10 min"
    metrics:
      kpi:
        - name: "response_time"
          baseline: "100ms"
          target: "<150ms"
        - name: "error_rate"
          baseline: "0.1%"
          target: "<0.2%"
      audit:
        logEnabled: true
        reviewer: "audit-team"
