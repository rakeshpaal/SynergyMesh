# Naming Policy Schema
# 定义命名规则策略的结构
$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://machinenativeops.io/schemas/naming-policy.schema.yaml"
title: "Naming Policy Schema"
description: "Schema for defining naming policies for different resource types"
type: object
required:
  - apiVersion
  - kind
  - metadata
  - spec
properties:
  apiVersion:
    type: string
    const: "governance.machinenativeops.io/v1alpha1"

  kind:
    type: string
    const: "NamingPolicy"

  metadata:
    type: object
    required:
      - name
    properties:
      name:
        type: string
        description: "策略唯一标识符"
        pattern: "^[a-z0-9-]+$"
      description:
        type: string
        description: "策略说明"
      labels:
        type: object
        description: "策略标签"
        additionalProperties:
          type: string
      annotations:
        type: object
        description: "策略注解"
        additionalProperties:
          type: string

  spec:
    type: object
    required:
      - pattern
      - schemaRef
    properties:
      pattern:
        type: string
        description: "命名模式（使用Go模板语法）"
        examples:
          - "{{ .environment }}-{{ .app }}-deploy-{{ .version }}"
          - "{{ .namespace }}/{{ .resourceType }}/{{ .app }}"

      schemaRef:
        type: string
        description: "关联的schema文件路径"
        examples:
          - "schemas/resource-name.schema.yaml"

      validation:
        type: object
        description: "额外验证规则"
        properties:
          minLength:
            type: integer
            minimum: 1
          maxLength:
            type: integer
            minimum: 1
          customPattern:
            type: string
            description: "自定义正则表达式"

      enforcement:
        type: object
        description: "执行策略"
        properties:
          level:
            type: string
            enum: ["advisory", "warning", "error"]
            default: "error"
            description: |
              - advisory: 建议性质，不强制
              - warning: 警告但允许通过
              - error: 错误，必须符合规范
          scope:
            type: array
            items:
              type: string
            description: "应用范围（命名空间、团队等）"
          exemptions:
            type: array
            items:
              type: string
            description: "豁免列表"

      examples:
        type: object
        description: "命名示例"
        properties:
          valid:
            type: array
            items:
              type: string
            description: "符合规范的示例"
          invalid:
            type: array
            items:
              type: string
            description: "不符合规范的示例"

      metadata:
        type: object
        description: "策略元数据"
        properties:
          version:
            type: string
            pattern: "^v\\d+\\.\\d+\\.\\d+$"
          owner:
            type: string
          reviewDate:
            type: string
            format: "date"
          approvers:
            type: array
            items:
              type: string

# 完整示例
example:
  apiVersion: "governance.machinenativeops.io/v1alpha1"
  kind: "NamingPolicy"
  metadata:
    name: "k8s-deployment-standard"
    description: "Kubernetes Deployment命名标准"
    labels:
      category: "kubernetes"
      team: "platform"
  spec:
    pattern: "{{ .environment }}-{{ .app }}-deploy-{{ .version }}"
    schemaRef: "schemas/resource-name.schema.yaml"
    validation:
      minLength: 10
      maxLength: 63
    enforcement:
      level: "error"
      scope:
        - "production"
        - "staging"
      exemptions:
        - "legacy-system"
    examples:
      valid:
        - "prod-payment-deploy-v1.3.0"
        - "staging-user-deploy-v2.0.0-beta1"
      invalid:
        - "production-payment-deploy-v1.3.0"  # 环境名不是缩写
        - "prod_payments_deploy_1.3"           # 使用下划线和非语义化版本
    metadata:
      version: "v1.0.0"
      owner: "platform-team"
      reviewDate: "2025-12-17"
      approvers:
        - "tech-lead@example.com"
        - "architect@example.com"
