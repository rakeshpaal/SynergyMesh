# Exception Request Schema
# 合规例外申请的标准结构
$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://machinenativeops.io/schemas/exception-request.schema.yaml"
title: "Exception Request Schema"
description: "Schema for compliance exception requests"
type: object
required:
  - apiVersion
  - kind
  - metadata
  - spec
properties:
  apiVersion:
    type: string
    const: "governance.machinenativeops.io/v1alpha1"

  kind:
    type: string
    const: "ComplianceExceptionRequest"

  metadata:
    type: object
    required:
      - id
      - applicant
    properties:
      id:
        type: string
        description: "例外申请唯一标识符"
        pattern: "^EXC-\\d{4}-\\d{3,5}$"
        examples:
          - "EXC-2025-001"

      applicant:
        type: string
        description: "申请人或团队"

      createdAt:
        type: string
        format: "date-time"

      labels:
        type: object
        additionalProperties:
          type: string

  spec:
    type: object
    required:
      - item
      - reason
      - riskEvaluation
      - requestedExpire
    properties:
      item:
        type: string
        description: "例外项目说明（违反了哪条规则）"
        minLength: 10

      policyViolated:
        type: string
        description: "违反的具体策略"
        examples:
          - "naming-governance/k8s-deployment-naming"
          - "security-compliance/password-policy"

      reason:
        type: string
        description: "业务或技术理由"
        minLength: 20

      businessJustification:
        type: string
        description: "业务正当性说明"

      technicalConstraints:
        type: string
        description: "技术限制说明"

      riskEvaluation:
        type: object
        description: "风险评估"
        required:
          - level
          - description
        properties:
          level:
            type: string
            enum: ["高", "中", "低"]
          description:
            type: string
          mitigationMeasures:
            type: array
            items:
              type: string
            description: "风险缓解措施"
          residualRisk:
            type: string
            description: "剩余风险"

      requestedExpire:
        type: string
        format: "date"
        description: "请求的到期日期（YYYY-MM-DD）"

      linkedChangeId:
        type: string
        description: "关联的变更请求ID"
        pattern: "^CHG-\\d{4}-\\d{3,5}$"

      scope:
        type: object
        description: "例外范围"
        properties:
          resources:
            type: array
            items:
              type: string
            description: "受影响的资源"
          environments:
            type: array
            items:
              type: string
            description: "适用环境"
          services:
            type: array
            items:
              type: string

      approval:
        type: object
        description: "审批信息"
        required:
          - status
        properties:
          status:
            type: string
            enum:
              - "UnderReview"
              - "Approved"
              - "Rejected"
              - "Expired"
              - "Revoked"
            default: "UnderReview"
          reviewer:
            type: string
          reviewedAt:
            type: string
            format: "date-time"
          approvalConditions:
            type: array
            items:
              type: string
            description: "批准条件"
          comments:
            type: string

      monitoring:
        type: object
        description: "监控和审计"
        properties:
          reviewFrequency:
            type: string
            description: "复审频率"
            examples:
              - "monthly"
              - "quarterly"
          alertsEnabled:
            type: boolean
            default: true
          auditLog:
            type: boolean
            default: true

      remediation:
        type: object
        description: "补救计划"
        properties:
          plan:
            type: string
            description: "如何最终符合规范"
          targetDate:
            type: string
            format: "date"
          responsible:
            type: string

  status:
    type: object
    description: "例外状态"
    properties:
      currentStatus:
        type: string
        enum:
          - "Active"
          - "Expired"
          - "Revoked"
          - "Remediated"
      expiresAt:
        type: string
        format: "date-time"
      lastReviewDate:
        type: string
        format: "date"
      nextReviewDate:
        type: string
        format: "date"
      renewalCount:
        type: integer
        description: "续期次数"

# 完整示例
example:
  apiVersion: "governance.machinenativeops.io/v1alpha1"
  kind: "ComplianceExceptionRequest"
  metadata:
    id: "EXC-2025-001"
    applicant: "legacy-team"
    createdAt: "2025-12-17T10:00:00Z"
    labels:
      urgency: "high"
      category: "naming"
  spec:
    item: "Legacy payment system uses non-standard naming convention"
    policyViolated: "naming-governance/k8s-deployment-naming"
    reason: "遗留系统迁移成本过高，且计划在6个月内退役"
    businessJustification: "该系统服务关键客户，重命名会导致2周停机"
    technicalConstraints: "硬编码的服务发现依赖于现有名称"
    riskEvaluation:
      level: "中"
      description: "命名不一致可能导致运维混淆"
      mitigationMeasures:
        - "在文档中明确标注例外"
        - "设置特殊监控告警"
        - "禁止新建类似资源"
      residualRisk: "运维人员可能误操作，但影响可控"
    requestedExpire: "2026-06-30"
    linkedChangeId: "CHG-2025-042"
    scope:
      resources:
        - "production/legacy-payment-svc"
      environments:
        - "production"
      services:
        - "legacy-payment"
    approval:
      status: "Approved"
      reviewer: "governance-board@example.com"
      reviewedAt: "2025-12-17T15:00:00Z"
      approvalConditions:
        - "每季度复审一次"
        - "必须有明确的退役计划"
        - "不得扩展到其他服务"
      comments: "批准，但需严格限制范围"
    monitoring:
      reviewFrequency: "quarterly"
      alertsEnabled: true
      auditLog: true
    remediation:
      plan: "在系统退役时自动解决"
      targetDate: "2026-06-30"
      responsible: "legacy-team-lead"
  status:
    currentStatus: "Active"
    expiresAt: "2026-06-30T23:59:59Z"
    lastReviewDate: "2025-12-17"
    nextReviewDate: "2026-03-17"
    renewalCount: 0
