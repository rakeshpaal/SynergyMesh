# Metric Definition Schema
# 治理指标定义的标准结构
$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://machinenativeops.io/schemas/metric-definition.schema.yaml"
title: "Metric Definition Schema"
description: "Schema for defining governance metrics and KPIs"
type: object
required:
  - apiVersion
  - kind
  - metadata
  - spec
properties:
  apiVersion:
    type: string
    const: "governance.machinenativeops.io/v1alpha1"

  kind:
    type: string
    const: "MetricDefinition"

  metadata:
    type: object
    required:
      - name
    properties:
      name:
        type: string
        description: "指标唯一标识符"
        pattern: "^[a-z0-9_]+$"
        examples:
          - "naming_compliance_rate"
          - "change_success_rate"

      displayName:
        type: string
        description: "指标显示名称"

      description:
        type: string
        description: "指标说明"

      category:
        type: string
        description: "指标分类"
        enum:
          - "compliance"
          - "quality"
          - "performance"
          - "adoption"
          - "risk"

  spec:
    type: object
    required:
      - query
      - unit
      - threshold
    properties:
      query:
        type: object
        description: "指标查询定义"
        required:
          - type
          - expression
        properties:
          type:
            type: string
            enum: ["prometheus", "sql", "api", "custom"]
          expression:
            type: string
            description: "查询表达式"
          datasource:
            type: string
            description: "数据源"

      unit:
        type: string
        description: "单位"
        examples:
          - "percent"
          - "count"
          - "seconds"
          - "boolean"

      threshold:
        type: object
        description: "阈值设置"
        properties:
          target:
            type: number
            description: "目标值"
          warning:
            type: number
            description: "警告阈值"
          critical:
            type: number
            description: "严重阈值"
          direction:
            type: string
            enum: ["above", "below"]
            description: "阈值方向（高于或低于目标为好）"

      aggregation:
        type: object
        description: "聚合方式"
        properties:
          method:
            type: string
            enum: ["avg", "sum", "min", "max", "count", "rate"]
          period:
            type: string
            examples:
              - "1h"
              - "1d"
              - "7d"
              - "30d"
          groupBy:
            type: array
            items:
              type: string

      visualization:
        type: object
        description: "可视化配置"
        properties:
          chartType:
            type: string
            enum: ["line", "bar", "gauge", "stat", "table"]
          dashboard:
            type: string
            description: "关联的仪表板"
          panel:
            type: string
            description: "面板配置"

      alerting:
        type: object
        description: "告警配置"
        properties:
          enabled:
            type: boolean
            default: false
          rules:
            type: array
            items:
              type: object
              properties:
                condition:
                  type: string
                severity:
                  type: string
                  enum: ["info", "warning", "critical"]
                notificationChannels:
                  type: array
                  items:
                    type: string

      owner:
        type: string
        description: "指标负责人"

      reviewFrequency:
        type: string
        description: "复审频率"
        examples:
          - "weekly"
          - "monthly"
          - "quarterly"

# 示例
examples:
  - apiVersion: "governance.machinenativeops.io/v1alpha1"
    kind: "MetricDefinition"
    metadata:
      name: "naming_compliance_rate"
      displayName: "命名规范符合率"
      description: "资源命名符合规范的比例"
      category: "compliance"
    spec:
      query:
        type: "prometheus"
        expression: |
          sum(compliant_resources) / sum(total_resources) * 100
        datasource: "prometheus"
      unit: "percent"
      threshold:
        target: 95
        warning: 90
        critical: 85
        direction: "above"
      aggregation:
        method: "avg"
        period: "7d"
        groupBy:
          - "environment"
          - "team"
      visualization:
        chartType: "gauge"
        dashboard: "governance-overview"
      alerting:
        enabled: true
        rules:
          - condition: "< 90"
            severity: "warning"
            notificationChannels:
              - "slack:#governance"
          - condition: "< 85"
            severity: "critical"
            notificationChannels:
              - "slack:#governance"
              - "pagerduty:governance-team"
      owner: "platform-team"
      reviewFrequency: "monthly"

  - apiVersion: "governance.machinenativeops.io/v1alpha1"
    kind: "MetricDefinition"
    metadata:
      name: "change_success_rate"
      displayName: "变更成功率"
      description: "变更请求成功完成的比例"
      category: "quality"
    spec:
      query:
        type: "sql"
        expression: |
          SELECT
            COUNT(CASE WHEN status = 'Completed' THEN 1 END) * 100.0 / COUNT(*) as success_rate
          FROM change_requests
          WHERE created_at >= NOW() - INTERVAL '30 days'
        datasource: "postgres"
      unit: "percent"
      threshold:
        target: 98
        warning: 95
        critical: 90
        direction: "above"
      aggregation:
        method: "rate"
        period: "30d"
        groupBy:
          - "change_type"
          - "risk_level"
      visualization:
        chartType: "line"
        dashboard: "change-management"
      alerting:
        enabled: true
        rules:
          - condition: "< 95"
            severity: "warning"
            notificationChannels:
              - "email:change-board@example.com"
      owner: "change-management-team"
      reviewFrequency: "weekly"
