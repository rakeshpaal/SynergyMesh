# Audit Report Schema
# 审计报告的标准结构
$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://machinenativeops.io/schemas/audit-report.schema.yaml"
title: "Audit Report Schema"
description: "Schema for governance audit reports"
type: object
required:
  - apiVersion
  - kind
  - metadata
  - spec
properties:
  apiVersion:
    type: string
    const: "governance.machinenativeops.io/v1alpha1"

  kind:
    type: string
    const: "AuditReport"

  metadata:
    type: object
    required:
      - id
      - title
      - period
    properties:
      id:
        type: string
        pattern: "^AUD-\\d{4}-\\d{2}$"
        examples:
          - "AUD-2025-12"

      title:
        type: string

      period:
        type: object
        required:
          - startDate
          - endDate
        properties:
          startDate:
            type: string
            format: "date"
          endDate:
            type: string
            format: "date"

      generatedAt:
        type: string
        format: "date-time"

      auditor:
        type: string

  spec:
    type: object
    required:
      - scope
      - findings
      - summary
    properties:
      scope:
        type: object
        description: "审计范围"
        properties:
          modules:
            type: array
            items:
              type: string
            description: "审计的治理模块"
          environments:
            type: array
            items:
              type: string
          teams:
            type: array
            items:
              type: string

      complianceMetrics:
        type: object
        description: "合规指标"
        properties:
          namingCompliance:
            type: object
            properties:
              rate:
                type: number
              total:
                type: integer
              compliant:
                type: integer
              nonCompliant:
                type: integer
          changeManagement:
            type: object
            properties:
              totalChanges:
                type: integer
              successRate:
                type: number
              averageLeadTime:
                type: string
          exceptionManagement:
            type: object
            properties:
              activeExceptions:
                type: integer
              expiredExceptions:
                type: integer
              averageDuration:
                type: string

      findings:
        type: array
        description: "审计发现"
        items:
          type: object
          required:
            - id
            - severity
            - description
          properties:
            id:
              type: string
              pattern: "^F-\\d{3}$"
            severity:
              type: string
              enum: ["critical", "high", "medium", "low", "info"]
            category:
              type: string
              enum:
                - "policy-violation"
                - "process-gap"
                - "documentation"
                - "training"
                - "tooling"
            description:
              type: string
            evidence:
              type: array
              items:
                type: string
            impact:
              type: string
            recommendation:
              type: string
            owner:
              type: string
            dueDate:
              type: string
              format: "date"
            status:
              type: string
              enum: ["open", "in-progress", "resolved", "accepted-risk"]

      summary:
        type: object
        description: "总结"
        required:
          - overallAssessment
          - keyTakeaways
        properties:
          overallAssessment:
            type: string
            enum: ["excellent", "good", "needs-improvement", "poor"]
          keyTakeaways:
            type: array
            items:
              type: string
          strengths:
            type: array
            items:
              type: string
          improvements:
            type: array
            items:
              type: string
          trends:
            type: string
            description: "趋势分析"

      actionPlan:
        type: array
        description: "行动计划"
        items:
          type: object
          required:
            - description
            - owner
            - priority
          properties:
            description:
              type: string
            owner:
              type: string
            priority:
              type: string
              enum: ["P0", "P1", "P2", "P3"]
            dueDate:
              type: string
              format: "date"
            relatedFindings:
              type: array
              items:
                type: string

      previousAudit:
        type: object
        description: "与上次审计的对比"
        properties:
          id:
            type: string
          improvementRate:
            type: number
          resolvedFindings:
            type: integer
          newFindings:
            type: integer

# 完整示例
example:
  apiVersion: "governance.machinenativeops.io/v1alpha1"
  kind: "AuditReport"
  metadata:
    id: "AUD-2025-12"
    title: "2025年12月治理审计报告"
    period:
      startDate: "2025-12-01"
      endDate: "2025-12-17"
    generatedAt: "2025-12-17T18:00:00Z"
    auditor: "governance-team"
  spec:
    scope:
      modules:
        - "naming-governance"
        - "change-management"
        - "exception-handling"
      environments:
        - "production"
        - "staging"
      teams:
        - "backend"
        - "frontend"
        - "platform"
    complianceMetrics:
      namingCompliance:
        rate: 92.5
        total: 1250
        compliant: 1156
        nonCompliant: 94
      changeManagement:
        totalChanges: 45
        successRate: 97.8
        averageLeadTime: "2.3 days"
      exceptionManagement:
        activeExceptions: 3
        expiredExceptions: 0
        averageDuration: "4.2 months"
    findings:
      - id: "F-001"
        severity: "high"
        category: "policy-violation"
        description: "发现 12 个生产环境资源未遵循命名规范"
        evidence:
          - "prod-legacy_payment-deploy (下划线)"
          - "production-user-svc (环境名未缩写)"
        impact: "可能导致自动化工具无法识别"
        recommendation: "创建变更请求进行重命名，或申请例外"
        owner: "backend-team"
        dueDate: "2026-01-15"
        status: "open"
      - id: "F-002"
        severity: "medium"
        category: "documentation"
        description: "3个团队的治理文档未及时更新"
        evidence:
          - "frontend-team: 文档更新滞后 60 天"
        impact: "新成员培训困难"
        recommendation: "建立文档更新 SOP"
        owner: "frontend-team-lead"
        dueDate: "2026-01-10"
        status: "in-progress"
      - id: "F-003"
        severity: "low"
        category: "tooling"
        description: "CI 命名检查未覆盖所有仓库"
        evidence:
          - "8/50 仓库未启用命名检查"
        impact: "无法自动拦截违规"
        recommendation: "推广 CI 模板到所有仓库"
        owner: "platform-team"
        dueDate: "2026-02-01"
        status: "open"
    summary:
      overallAssessment: "good"
      keyTakeaways:
        - "整体合规率 92.5%，较上月提升 3.2%"
        - "变更成功率保持高位 (97.8%)"
        - "需要加强遗留系统治理"
      strengths:
        - "变更管理流程执行良好"
        - "例外管理规范，无过期例外"
        - "团队配合度高，问题响应及时"
      improvements:
        - "命名规范在遗留系统的覆盖率"
        - "自动化工具的推广"
        - "培训材料的更新频率"
      trends: "过去三个月合规率稳步提升 (87% -> 89% -> 92.5%)"
    actionPlan:
      - description: "推动 F-001 相关资源重命名或申请例外"
        owner: "backend-team"
        priority: "P1"
        dueDate: "2026-01-15"
        relatedFindings:
          - "F-001"
      - description: "建立文档自动更新检查机制"
        owner: "platform-team"
        priority: "P2"
        dueDate: "2026-01-31"
        relatedFindings:
          - "F-002"
      - description: "在所有仓库启用命名检查 CI"
        owner: "platform-team"
        priority: "P2"
        dueDate: "2026-02-01"
        relatedFindings:
          - "F-003"
    previousAudit:
      id: "AUD-2025-11"
      improvementRate: 3.8
      resolvedFindings: 5
      newFindings: 3
