# Canonical Naming Governance - Machine-Readable Specification
# Single Source of Truth for all naming rules across Gatekeeper, Conftest, CI/CD

apiVersion: naming.machinenativeops.io/v1alpha1
kind: CanonicalNamingSpec
metadata:
  name: canonical-naming-governance
  version: v1.0
  rfc: "RFC-2025-10-25"
  description: "单一权威命名规范，所有 Gatekeeper、Conftest、CI/CD 规则由此派生"
  lastUpdated: "2025-01-15"
  owner: "Platform Engineering Team"
  approvedBy: "Governance Board"

spec:
  # 基础命名规则
  naming:
    # 允许的字符（RFC-1123 DNS_LABEL）
    allowed_chars: "[a-z0-9-]"

    # 字符大小写
    case: "lower"

    # 最大长度（Kubernetes 限制）
    max_length: 63

    # 命名段（按优先级）
    segments:
      - "domain"      # 团队/租户域
      - "component"   # 组件/工作负载
      - "environment" # 环境
      - "region"      # 区域（可选）
      - "version"     # 版本（可选）
      - "suffix"      # 后缀（可选）

    # 保留关键字（不可用作命名段）
    reserved_tokens:
      - "core"
      - "internal"
      - "system"
      - "legacy"
      - "experimental"
      - "kube"
      - "kubernetes"
      - "default"

    # 标准环境列表
    environments:
      - name: "dev"
        description: "开发环境"
        aliases: ["develop", "development"]
      - name: "test"
        description: "测试环境"
        aliases: ["testing", "qa"]
      - name: "staging"
        description: "预生产环境"
        aliases: ["stage", "preprod", "uat"]
      - name: "prod"
        description: "生产环境"
        aliases: ["production", "live"]
      - name: "learn"
        description: "学习/沙箱环境"
        aliases: ["sandbox", "demo"]

    # Canonical Regex（主规则）
    canonical_regex: "^(team|tenant|dev|test|staging|prod|learn)-[a-z0-9-]{1,56}[a-z0-9]$"

    # 三种标准命名模式
    naming_modes:
      # 模式 1: team-domain-env
      - id: "team-domain-env"
        pattern: "^{team}-{domain}-{environment}$"
        regex: "^team-[a-z0-9-]+-(?:dev|test|staging|prod|learn)$"
        example: "team-frontend-prod"
        use_cases:
          - "团队级命名空间"
          - "微服务命名空间"
        required_labels:
          - "team"
          - "environment"
          - "domain"

      # 模式 2: tenant-workload-env-region
      - id: "tenant-workload-env-region"
        pattern: "^{tenant}-{workload}-{environment}-{region}$"
        regex: "^tenant-[a-z0-9-]+-(?:dev|test|staging|prod)-[a-z0-9-]+$"
        example: "tenant-payment-prod-uswest"
        use_cases:
          - "多租户环境"
          - "跨区域部署"
        required_labels:
          - "tenant"
          - "workload"
          - "environment"
          - "region"

      # 模式 3: env-app-version
      - id: "env-app-version"
        pattern: "^{environment}-{app}-{version}$"
        regex: "^(?:dev|test|staging|prod)-[a-z0-9-]+-v[0-9]+$"
        example: "prod-api-v2"
        use_cases:
          - "多版本共存"
          - "蓝绿部署"
          - "金丝雀发布"
        required_labels:
          - "environment"
          - "app"
          - "version"

  # 必需标签（所有资源必须具备）
  required_labels:
    - key: "environment"
      description: "部署环境（dev/test/staging/prod/learn）"
      validation_regex: "^(dev|test|staging|prod|learn)$"
      required: true
      scope: ["Namespace", "Deployment", "Service", "Ingress"]

    - key: "tenant"
      description: "租户标识"
      validation_regex: "^[a-z0-9-]{2,32}$"
      required: true
      scope: ["Namespace"]
      exemptions:
        - "kube-system"
        - "kube-public"
        - "kube-node-lease"

    - key: "app.kubernetes.io/name"
      description: "应用名称"
      validation_regex: "^[a-z0-9-]{2,63}$"
      required: true
      scope: ["Deployment", "StatefulSet", "DaemonSet"]

    - key: "app.kubernetes.io/managed-by"
      description: "管理工具（helm/kubectl/terraform）"
      validation_regex: "^(helm|kubectl|terraform|argocd|flux)$"
      required: true
      scope: ["all"]

    - key: "team"
      description: "负责团队"
      validation_regex: "^[a-z0-9-]{2,32}$"
      required: false
      scope: ["Namespace", "Deployment"]

  # URN/URI 映射
  urn_mapping:
    enabled: true
    format: "urn:machinenativeops:{domain}:{component}:env:{environment}:{version}"
    examples:
      - namespace: "team-frontend-prod"
        urn: "urn:machinenativeops:team:frontend:env:prod:v1"
      - namespace: "tenant-payment-prod-uswest"
        urn: "urn:machinenativeops:tenant:payment:env:prod:region:uswest"

    annotation_key: "machinenativeops.io/canonical-urn"
    description: "所有 Namespace 必须包含 URN annotation"

  # 验证规则（用于 CI/CD、Conftest、Gatekeeper）
  validation_rules:
    # 规则 1: Namespace 命名验证
    - id: "RULE-001"
      resource_type: "Namespace"
      field: "metadata.name"
      rule_type: "regex"
      pattern: "^(team|tenant|dev|test|staging|prod|learn)-[a-z0-9-]{1,56}[a-z0-9]$"
      severity: "critical"
      error_message: "Namespace 名称必须符合 Canonical 命名模式之一"
      remediation: "使用 team-{domain}-{env}、tenant-{workload}-{env}-{region} 或 env-{app}-{version} 格式"

    # 规则 2: 必需标签验证
    - id: "RULE-002"
      resource_type: "Namespace"
      field: "metadata.labels"
      rule_type: "required_keys"
      required_keys: ["environment", "tenant"]
      severity: "high"
      error_message: "Namespace 缺少必需标签"
      exemptions: ["kube-system", "kube-public", "kube-node-lease", "default"]

    # 规则 3: URN annotation 验证
    - id: "RULE-003"
      resource_type: "Namespace"
      field: "metadata.annotations"
      rule_type: "required_keys"
      required_keys: ["machinenativeops.io/canonical-urn"]
      severity: "medium"
      error_message: "Namespace 缺少 Canonical URN annotation"

    # 规则 4: 保留关键字验证
    - id: "RULE-004"
      resource_type: "all"
      field: "metadata.name"
      rule_type: "deny_list"
      denied_values: ["core", "internal", "system", "legacy", "experimental", "kube", "kubernetes"]
      severity: "critical"
      error_message: "资源名称不能使用保留关键字"

    # 规则 5: 环境标签值验证
    - id: "RULE-005"
      resource_type: "all"
      field: "metadata.labels.environment"
      rule_type: "allow_list"
      allowed_values: ["dev", "test", "staging", "prod", "learn"]
      severity: "critical"
      error_message: "environment 标签值必须是标准环境之一"

  # 迁移策略
  migration:
    # 冲突检测
    conflict_detection:
      enabled: true
      check_types:
        - "duplicate_names"
        - "reserved_keywords"
        - "label_inconsistency"
        - "urn_collision"

    # 自动建议
    auto_suggestion:
      enabled: true
      algorithm: "pattern_matching"
      fallback: "team-{original_name}-{env}"

    # 批量迁移配置
    batch_config:
      max_batch_size: 50
      cooldown_period: "1h"
      rollback_enabled: true

  # 工具集成配置
  tooling:
    # Gatekeeper 集成
    gatekeeper:
      enabled: true
      constraint_template: "policies/gatekeeper/namespace-constraints.yaml"
      enforcement_action: "deny"  # deny | dryrun | warn

    # Conftest 集成
    conftest:
      enabled: true
      policy_path: "templates/conftest/naming.rego"
      namespace: "main"

    # CI/CD 集成
    cicd:
      github_actions:
        enabled: true
        workflow_path: ".github/workflows/naming-validation.yml"
      gitlab_ci:
        enabled: false

    # 监控集成
    observability:
      prometheus:
        enabled: true
        metrics_path: "policies/observability/naming-metrics-policy.yaml"
      grafana:
        enabled: true
        dashboard_path: "templates/grafana/naming-compliance-dashboard.json"

  # 豁免管理
  exemptions:
    - resource: "kube-system"
      reason: "Kubernetes 系统命名空间"
      approved_by: "platform-team"
      expires_at: "permanent"

    - resource: "kube-public"
      reason: "Kubernetes 公共命名空间"
      approved_by: "platform-team"
      expires_at: "permanent"

    - resource: "kube-node-lease"
      reason: "Kubernetes 节点租约命名空间"
      approved_by: "platform-team"
      expires_at: "permanent"

    - resource: "default"
      reason: "Kubernetes 默认命名空间"
      approved_by: "platform-team"
      expires_at: "permanent"

    - resource: "legacy-*"
      reason: "历史遗留系统，迁移计划中"
      approved_by: "governance-board"
      expires_at: "2025-12-31T23:59:59Z"

  # SLA 目标
  sla:
    naming_compliance_rate:
      target: 99.9
      measurement: "percentage"
      alert_threshold: 95.0

    validation_failure_rate:
      target: 1.0
      measurement: "percentage"
      alert_threshold: 5.0

    migration_success_rate:
      target: 95.0
      measurement: "percentage"
      alert_threshold: 85.0

  # 审计追踪
  audit:
    enabled: true
    log_level: "info"
    retention: "1 year"
    fields:
      - "timestamp"
      - "resource_type"
      - "resource_name"
      - "validation_result"
      - "rule_id"
      - "severity"
      - "error_message"

# 使用指南
usage:
  description: |
    本文件是 Canonical Naming Governance 的唯一权威规范（Single Source of Truth）。
    所有 Gatekeeper ConstraintTemplates、Conftest Rego 规则、CI/CD 验证流程都应从此文件派生。

  how_to_consume:
    - "CI/CD: 直接读取本文件进行验证"
    - "Gatekeeper: 使用 parameters 生成 ConstraintTemplates"
    - "Conftest: 基于 validation_rules 生成 Rego 规则"
    - "Migration: 使用 naming_modes 生成建议"

  examples:
    - description: "验证 Namespace 名称"
      command: "python tools/governance/python/validate_naming.py --spec canonical/machine-spec.yaml --resource manifests/namespace.yaml"

    - description: "生成 Gatekeeper Constraints"
      command: "python tools/governance/python/generate_gatekeeper.py --spec canonical/machine-spec.yaml --output policies/gatekeeper/"

    - description: "检测命名冲突"
      command: "python tools/governance/python/naming-migration.py --spec canonical/machine-spec.yaml --scan"

# 版本控制
versioning:
  changelog: "canonical/CHANGELOG.md"
  upgrade_guide: "docs/governance/naming-upgrade-guide.md"
