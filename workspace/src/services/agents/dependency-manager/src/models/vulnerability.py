"""
漏洞模型 - Vulnerability Model
定義安全漏洞的數據結構
"""

from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum


class VulnerabilitySeverity(Enum):
    """漏洞嚴重程度"""
    CRITICAL = "CRITICAL"   # 嚴重
    HIGH = "HIGH"           # 高
    MEDIUM = "MEDIUM"       # 中
    LOW = "LOW"             # 低
    UNKNOWN = "UNKNOWN"     # 未知

    @classmethod
    def from_cvss(cls, score: float) -> "VulnerabilitySeverity":
        """
        從 CVSS 分數轉換為嚴重程度
        
        Args:
            score: CVSS 分數 (0.0-10.0)
            
        Returns:
            對應的嚴重程度
        """
        if score >= 9.0:
            return cls.CRITICAL
        elif score >= 7.0:
            return cls.HIGH
        elif score >= 4.0:
            return cls.MEDIUM
        elif score > 0:
            return cls.LOW
        return cls.UNKNOWN


class VulnerabilitySource(Enum):
    """漏洞數據來源"""
    NVD = "nvd"     # 美國國家漏洞數據庫
    GHSA = "ghsa"   # GitHub Security Advisories
    OSV = "osv"     # Open Source Vulnerabilities
    SNYK = "snyk"   # Snyk 漏洞數據庫


@dataclass
class Vulnerability:
    """
    安全漏洞數據結構
    
    Attributes:
        id: 漏洞 ID (CVE/GHSA)
        package: 受影響的套件名稱
        severity: 嚴重程度
        title: 漏洞標題
        description: 漏洞描述
        affected_versions: 受影響的版本範圍
        fixed_version: 修復版本
        cvss_score: CVSS 分數
        source: 數據來源
        references: 參考連結
        published_at: 發布時間
    """
    id: str
    package: str
    severity: VulnerabilitySeverity
    title: str = ""
    description: str = ""
    affected_versions: str = ""
    fixed_version: str | None = None
    cvss_score: float | None = None
    source: VulnerabilitySource = VulnerabilitySource.NVD
    references: list[str] = field(default_factory=list)
    published_at: datetime | None = None

    def has_fix(self) -> bool:
        """檢查是否有修復版本"""
        return self.fixed_version is not None

    def is_critical(self) -> bool:
        """檢查是否為嚴重漏洞"""
        return self.severity == VulnerabilitySeverity.CRITICAL

    def to_dict(self) -> dict:
        """轉換為字典格式"""
        return {
            "id": self.id,
            "package": self.package,
            "severity": self.severity.value,
            "title": self.title,
            "description": self.description,
            "affected_versions": self.affected_versions,
            "fixed_version": self.fixed_version,
            "cvss_score": self.cvss_score,
            "source": self.source.value,
            "references": self.references,
            "published_at": self.published_at.isoformat() if self.published_at else None
        }

    def __str__(self) -> str:
        return f"{self.id}: {self.package} ({self.severity.value})"


@dataclass
class VulnerabilityScanResult:
    """
    漏洞掃描結果
    
    Attributes:
        scan_id: 掃描 ID
        timestamp: 掃描時間
        vulnerabilities: 發現的漏洞列表
        total_count: 總漏洞數
        critical_count: 嚴重漏洞數
        high_count: 高危漏洞數
        medium_count: 中危漏洞數
        low_count: 低危漏洞數
    """
    scan_id: str
    timestamp: datetime = field(default_factory=datetime.utcnow)
    vulnerabilities: list[Vulnerability] = field(default_factory=list)
    total_count: int = 0
    critical_count: int = 0
    high_count: int = 0
    medium_count: int = 0
    low_count: int = 0

    def add_vulnerability(self, vuln: Vulnerability) -> None:
        """添加漏洞"""
        self.vulnerabilities.append(vuln)
        self.total_count += 1

        if vuln.severity == VulnerabilitySeverity.CRITICAL:
            self.critical_count += 1
        elif vuln.severity == VulnerabilitySeverity.HIGH:
            self.high_count += 1
        elif vuln.severity == VulnerabilitySeverity.MEDIUM:
            self.medium_count += 1
        elif vuln.severity == VulnerabilitySeverity.LOW:
            self.low_count += 1

    def get_critical_vulnerabilities(self) -> list[Vulnerability]:
        """獲取嚴重漏洞"""
        return [v for v in self.vulnerabilities if v.is_critical()]

    def has_critical_issues(self) -> bool:
        """檢查是否存在嚴重問題"""
        return self.critical_count > 0

    def to_dict(self) -> dict:
        """轉換為字典格式"""
        return {
            "scan_id": self.scan_id,
            "timestamp": self.timestamp.isoformat(),
            "summary": {
                "total": self.total_count,
                "critical": self.critical_count,
                "high": self.high_count,
                "medium": self.medium_count,
                "low": self.low_count
            },
            "vulnerabilities": [v.to_dict() for v in self.vulnerabilities]
        }
