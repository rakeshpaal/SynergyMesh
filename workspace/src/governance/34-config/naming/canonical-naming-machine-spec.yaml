---
version: v1.0
kind: CanonicalNamingSpec
metadata:
  name: canonical-naming-governance
  owner: platform-governance
  description: Single-source machine spec for naming governance with URN/URI mapping

naming:
  allowed_chars: "[a-z0-9-]"
  case: lower
  max_length: 63
  segments:
    - domain
    - component
    - environment
    - region
    - version
    - suffix
  environments:
    - dev
    - test
    - staging
    - prod
    - learn
    - sandbox
  reserved_tokens:
    - core
    - internal
    - system
    - legacy
    - experimental
  qualifier_rules:
    max_qualifiers: 12
    key_pattern: "^[a-z0-9][a-z0-9-]{0,29}$"
    value_pattern: "^[a-zA-Z0-9.:@/+%-]{0,127}$"
  canonical_regex: "^(?!.*--)(team|tenant|dev|test|staging|prod|learn|sandbox)-[a-z0-9]+(?:-[a-z0-9]+)*$"
  canonical_regex_source: "derived from organizational prefixes (team/tenant) + environments list with -- guard"
  prefix_alignment:
    allow_environment_prefix: true
    require_label_match: true
  suffix_map:
    namespace: "ns"
    deployment: "deploy"
    service: "svc"
    configmap: "config"
    secret: "secret"
    pvc: "pvc"
    job: "job"

required_labels:
  - environment
  - tenant
  - app.kubernetes.io/managed-by

urn_template: "urn:machinenativeops:{domain}:{component}:env:{environment}:{version}"
segment_mapping:
  domain: "{domain}"
  component: "{component}"
  environment: "{environment}"
  region: "qualifier:region"
  version: "{version}"
  suffix: "suffix_map.*"
segment_mapping_notes:
  region: "region values are stored under annotations key machinenativeops.io/qualifiers as region=<value>"
  suffix: "suffix resolution uses suffix_map entries when present"
annotations:
  canonical_urn: "machinenativeops.io/canonical-urn"
  qualifiers: "machinenativeops.io/qualifiers"

validation:
  gatekeeper:
    constraint_templates:
      - name: K8sRequiredLabels
        required_labels_ref: required_labels
      - name: K8sNamingPattern
        pattern_ref: naming.canonical_regex
        max_length_ref: naming.max_length
    failure_policy: Fail
  ci:
    conftest_policy: governance/23-policies/conftest/naming_policy.rego
    kubeval: true
    yamllint: true

migration:
  strategy: warn-and-plan
  dry_run_report: reports/canonical-naming-mapping.csv
  risk_tags:
    - high
    - medium
    - low
