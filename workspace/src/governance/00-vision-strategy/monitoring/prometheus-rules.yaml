# Prometheus Rules for GaC Governance Monitoring
# Phase 3 - Monitoring & Observability

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: governance-compliance-rules
  namespace: monitoring
  labels:
    prometheus: kube-prometheus
    role: alert-rules
  annotations:
    gac-phase: "3-monitoring"
spec:
  groups:
    - name: governance.compliance
      interval: 30s
      rules:
        # Governance Resource Availability
        - alert: GovernanceResourceMissing
          expr: |
            count(kube_customresource_version{customresource_group="governance.kai"}) < 9
          for: 5m
          labels:
            severity: critical
            component: governance
          annotations:
            summary: "Governance resources missing"
            description: "Expected 9 governance resources, found {{ $value }}"

        # CRD Health
        - alert: GovernanceCRDUnhealthy
          expr: |
            kube_customresourcedefinition_status_condition{condition="Established",status="false",customresourcedefinition=~".*governance.kai"} == 1
          for: 2m
          labels:
            severity: warning
            component: governance-crd
          annotations:
            summary: "Governance CRD not established"
            description: "CRD {{ $labels.customresourcedefinition }} is not established"

        # OPA Gatekeeper Policy Violations
        - alert: GovernancePolicyViolation
          expr: |
            increase(gatekeeper_violations{enforcement_action="deny"}[5m]) > 0
          labels:
            severity: warning
            component: governance-policy
          annotations:
            summary: "Governance policy violations detected"
            description: "{{ $value }} policy violations in the last 5 minutes"

        # GitOps Sync Status
        - alert: GovernanceGitOpsSyncFailed
          expr: |
            argocd_app_sync_status{name=~"gac-.*",sync_status!="Synced"} == 1
          for: 10m
          labels:
            severity: critical
            component: gitops
          annotations:
            summary: "GitOps sync failed for governance resources"
            description: "Application {{ $labels.name }} sync status: {{ $labels.sync_status }}"

        # Resource Update Lag
        - alert: GovernanceResourceStale
          expr: |
            time() - kube_customresource_created{customresource_group="governance.kai"} > 86400 * 90
          labels:
            severity: info
            component: governance
          annotations:
            summary: "Governance resource not updated recently"
            description: "Resource {{ $labels.customresource_kind }}/{{ $labels.name }} hasn't been updated in 90 days"

    - name: governance.metrics
      interval: 1m
      rules:
        # Total Governance Resources
        - record: governance:resources:total
          expr: count(kube_customresource_version{customresource_group="governance.kai"})

        # Compliance Rate
        - record: governance:compliance:rate
          expr: |
            (
              count(kube_customresource_version{customresource_group="governance.kai"})
              /
              9
            ) * 100

        # Policy Enforcement Rate
        - record: governance:policy:enforcement_rate
          expr: |
            rate(gatekeeper_constraints_enforced_total[5m])

        # GitOps Sync Success Rate
        - record: governance:gitops:sync_success_rate
          expr: |
            (
              count(argocd_app_sync_status{name=~"gac-.*",sync_status="Synced"})
              /
              count(argocd_app_sync_status{name=~"gac-.*"})
            ) * 100
