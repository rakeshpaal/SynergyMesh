task_type: sync_knowledge
name: "Sync Living Knowledge Base with Repository Changes"
description: "åµæ¸¬å€‰åº«è®Šå‹• â†’ é‡æ–°ç”ŸæˆçŸ¥è­˜åœ–è­œ â†’ æ›´æ–°æ²»ç†ç´¢å¼• â†’ åŒæ­¥ç›¸é—œå…§å®¹"
version: "1.0.0"

metadata:
  priority: P0
  estimated_duration: "< 3 minutes"
  auto_trigger: true
  ç‰¹è‰²: "ç´€éŒ„åŠŸèƒ½ - åªè¦å€‰åº«ä¸€æœ‰è®Šå‹•ï¼Œç«‹åˆ»æ‰¾åˆ°æ­¤æ¬¡è®Šå‹•çš„å…§å®¹ã€ç›¸é—œå…§å®¹ã€é«˜åº¦ç›¸é—œå…§å®¹"

steps:
  # =========================================================================
  # Step 1: Detect Changes (æ„ŸçŸ¥å±¤ - Perception)
  # =========================================================================
  - step: 1
    name: "Detect Repository Changes"
    action: "git_diff_analysis"
    parameters:
      base: "HEAD~1"
      target: "HEAD"
      include_untracked: false
    output_var: "changes"
    description: "åµæ¸¬å€‰åº«è®Šå‹•ï¼šæ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤çš„æª”æ¡ˆ"

  - step: 2
    name: "Classify Changed Files"
    action: "classify_changes"
    parameters:
      changes: "{{ changes }}"
      categories:
        - governance      # æ²»ç†ç›¸é—œæª”æ¡ˆ
        - schema          # Schema å®šç¾©
        - config          # é…ç½®æª”æ¡ˆ
        - code            # ç¨‹å¼ç¢¼
        - documentation   # æ–‡ä»¶
        - workflow        # CI/CD workflows
    output_var: "classified_changes"
    description: "åˆ†é¡è®Šå‹•çš„æª”æ¡ˆé¡å‹"

  - step: 3
    name: "Extract Change Metadata"
    action: "extract_metadata"
    parameters:
      changes: "{{ classified_changes }}"
      extract:
        - commit_message
        - commit_author
        - commit_timestamp
        - file_paths
        - change_type  # added, modified, deleted
        - line_count
    output_var: "change_metadata"
    description: "æå–è®Šå‹•çš„å…ƒæ•¸æ“š"

  # =========================================================================
  # Step 4-6: Regenerate Knowledge Artifacts (å»ºæ¨¡å±¤ - Modeling)
  # =========================================================================
  - step: 4
    name: "Generate MN-DOC"
    action: "run_command"
    parameters:
      command: "make mndoc"
      working_dir: "{{ repo_root }}"
      timeout: 60
    output_var: "mndoc_result"
    description: "é‡æ–°ç”Ÿæˆ MN-DOC (generated-mndoc.yaml)"

  - step: 5
    name: "Generate Knowledge Graph"
    action: "run_command"
    parameters:
      command: "make kg"
      working_dir: "{{ repo_root }}"
      timeout: 120
    output_var: "kg_result"
    description: "é‡æ–°ç”ŸæˆçŸ¥è­˜åœ–è­œ (knowledge-graph.yaml)"

  - step: 6
    name: "Generate SuperRoot Entities"
    action: "run_command"
    parameters:
      command: "make superroot"
      working_dir: "{{ repo_root }}"
      timeout: 60
    output_var: "superroot_result"
    description: "æŠ•å½±åˆ° SuperRoot å¯¦é«”æ ¼å¼ (superroot-entities.yaml)"

  # =========================================================================
  # Step 7-8: Find Related Content (æª¢ç´¢å±¤ - Retrieval)
  # =========================================================================
  - step: 7
    name: "Find Related Artifacts"
    action: "vector_search"
    parameters:
      query_template: "Find artifacts related to: {{ change_metadata.file_paths }}"
      dimensions: ["content", "structure", "governance"]
      top_k: 20
      similarity_threshold: 0.7
    output_var: "related_artifacts"
    description: "æ‰¾åˆ°èˆ‡è®Šå‹•ç›¸é—œçš„ artifacts"

  - step: 8
    name: "Find Highly Related Content"
    action: "vector_search"
    parameters:
      query_template: "Find highly similar content to: {{ change_metadata }}"
      dimensions: ["content", "structure"]
      top_k: 10
      similarity_threshold: 0.85
      boost_same_category: true
    output_var: "highly_related_content"
    description: "æ‰¾åˆ°é«˜åº¦ç›¸é—œçš„å…§å®¹"

  # =========================================================================
  # Step 9: Analyze Impact (è¨ºæ–·å±¤ - Diagnosis)
  # =========================================================================
  - step: 9
    name: "Analyze Change Impact"
    action: "impact_analysis"
    parameters:
      changes: "{{ classified_changes }}"
      knowledge_graph: "{{ kg_result.output_file }}"
      governance_index: "../governance/index.json"
    output_var: "impact_analysis"
    description: "åˆ†æè®Šå‹•å½±éŸ¿ï¼šå“ªäº› artifacts å—å½±éŸ¿ã€ä¾è³´é—œä¿‚"

  - step: 10
    name: "Check for Broken References"
    action: "reference_check"
    parameters:
      changes: "{{ classified_changes }}"
      knowledge_graph: "{{ kg_result.output_file }}"
      check_types:
        - imports
        - links
        - dependencies
        - governance_refs
    output_var: "broken_refs"
    description: "æª¢æŸ¥æ˜¯å¦æœ‰æ–·æ‰çš„å¼•ç”¨æˆ–é€£çµ"

  # =========================================================================
  # Step 11-12: Update Governance Index (æ²»ç†å±¤ - Governance)
  # =========================================================================
  - step: 11
    name: "Update Governance Index"
    action: "update_index"
    parameters:
      index_file: "../governance/index.json"
      updates:
        new_artifacts: "{{ impact_analysis.new_artifacts }}"
        modified_artifacts: "{{ impact_analysis.modified_artifacts }}"
        deleted_artifacts: "{{ impact_analysis.deleted_artifacts }}"
        timestamp: "{{ now() }}"
    output_var: "index_update_result"
    description: "æ›´æ–°å…¨å±€æ²»ç†ç´¢å¼•"

  - step: 12
    name: "Update DAG"
    action: "update_dag"
    parameters:
      dag_file: "../governance/dag.graphml"
      knowledge_graph: "{{ kg_result.output_file }}"
      preserve_manual_edges: true
    output_var: "dag_update_result"
    description: "åŒæ­¥æ›´æ–°æ²»ç† DAG"

  # =========================================================================
  # Step 13: Update Vector Indices (æª¢ç´¢å±¤ - Retrieval)
  # =========================================================================
  - step: 13
    name: "Update Vector Indices"
    action: "update_vectors"
    parameters:
      artifacts: "{{ impact_analysis.affected_artifacts }}"
      dimensions: ["content", "structure", "governance"]
      embedding_model: "text-embedding-ada-002"
      batch_size: 50
    output_var: "vector_update_result"
    description: "æ›´æ–°å‘é‡ç´¢å¼•"

  # =========================================================================
  # Step 14-15: Generate Reports and Log (å›é¥‹å±¤ - Feedback)
  # =========================================================================
  - step: 14
    name: "Generate Change Summary"
    action: "generate_report"
    parameters:
      template: |
        # Repository Change Summary
        
        **Timestamp**: {{ change_metadata.commit_timestamp }}
        **Commit**: {{ change_metadata.commit_sha }}
        **Author**: {{ change_metadata.commit_author }}
        **Message**: {{ change_metadata.commit_message }}
        
        ## Changes Detected
        
        {{ classified_changes | format_table }}
        
        ## Impact Analysis
        
        - **Affected Artifacts**: {{ impact_analysis.affected_count }}
        - **New Artifacts**: {{ impact_analysis.new_artifacts | length }}
        - **Modified Artifacts**: {{ impact_analysis.modified_artifacts | length }}
        - **Deleted Artifacts**: {{ impact_analysis.deleted_artifacts | length }}
        
        ## Related Content
        
        ### Related Artifacts ({{ related_artifacts | length }})
        {{ related_artifacts | format_list }}
        
        ### Highly Related Content ({{ highly_related_content | length }})
        {{ highly_related_content | format_list }}
        
        ## Broken References
        
        {{ broken_refs | format_issues }}
        
        ## Knowledge Graph Status
        
        - **MN-DOC**: {{ mndoc_result.status }}
        - **Knowledge Graph**: {{ kg_result.status }}
        - **SuperRoot Entities**: {{ superroot_result.status }}
        - **Governance Index**: {{ index_update_result.status }}
        - **Vector Indices**: {{ vector_update_result.status }}
    output_var: "change_summary"
    description: "ç”Ÿæˆè®Šå‹•æ‘˜è¦å ±å‘Š"

  - step: 15
    name: "Log to Trust Chain"
    action: "log_to_trust_chain"
    parameters:
      event: "knowledge_sync_completed"
      artifact_ids: "{{ impact_analysis.affected_artifacts | map('id') }}"
      metadata:
        commit_sha: "{{ change_metadata.commit_sha }}"
        changes_count: "{{ classified_changes | length }}"
        affected_artifacts_count: "{{ impact_analysis.affected_count }}"
        related_artifacts_count: "{{ related_artifacts | length }}"
        highly_related_count: "{{ highly_related_content | length }}"
        broken_refs_count: "{{ broken_refs | length }}"
        timestamp: "{{ now() }}"
    output_var: "trust_chain_entry"
    description: "è¨˜éŒ„åˆ°è­‰æ“šéˆ"

  # =========================================================================
  # Step 16: Store Change Record (ç´€éŒ„åŠŸèƒ½)
  # =========================================================================
  - step: 16
    name: "Store Change Record"
    action: "store_record"
    parameters:
      storage_path: "../state/change-records/"
      filename: "change-{{ change_metadata.commit_sha }}.yaml"
      content:
        commit: "{{ change_metadata }}"
        changes: "{{ classified_changes }}"
        impact: "{{ impact_analysis }}"
        related: "{{ related_artifacts }}"
        highly_related: "{{ highly_related_content }}"
        broken_refs: "{{ broken_refs }}"
        knowledge_artifacts:
          mndoc: "{{ mndoc_result }}"
          knowledge_graph: "{{ kg_result }}"
          superroot: "{{ superroot_result }}"
        governance_updates:
          index: "{{ index_update_result }}"
          dag: "{{ dag_update_result }}"
          vectors: "{{ vector_update_result }}"
        summary: "{{ change_summary }}"
    output_var: "record_stored"
    description: "å„²å­˜å®Œæ•´çš„è®Šå‹•è¨˜éŒ„ä¾›æœªä¾†æŸ¥è©¢"

output:
  success: true
  commit_sha: "{{ change_metadata.commit_sha }}"
  changes_processed: "{{ classified_changes | length }}"
  artifacts_affected: "{{ impact_analysis.affected_count }}"
  related_artifacts: "{{ related_artifacts | length }}"
  highly_related: "{{ highly_related_content | length }}"
  knowledge_synced: true
  record_path: "{{ record_stored.path }}"
  summary: "{{ change_summary }}"

triggers:
  - event: "git.push"
    condition: "true"
    priority: "high"
  
  - event: "git.commit"
    condition: "true"
    priority: "high"
  
  - event: "workflow.completed"
    condition: "true"
    priority: "medium"
  
  - event: "scheduled.knowledge_sync"
    schedule: "0 */6 * * *"  # Every 6 hours
    priority: "low"

notifications:
  on_completion:
    method: "log"
    level: "info"
    message: "Knowledge base synchronized. {{ impact_analysis.affected_count }} artifacts affected."
  
  on_broken_refs:
    method: "github_issue"
    condition: "broken_refs | length > 0"
    template: |
      ## ğŸ”— Broken References Detected
      
      The knowledge sync detected {{ broken_refs | length }} broken reference(s):
      
      {{ broken_refs | format_issues }}
      
      **Commit**: {{ change_metadata.commit_sha }}
      **Full Report**: {{ record_stored.path }}
