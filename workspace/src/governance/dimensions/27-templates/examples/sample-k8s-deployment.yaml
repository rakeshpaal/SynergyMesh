# Kubernetes Deployment å‘½åè§„èŒƒç¤ºä¾‹

# âœ… æ­£ç¡®ç¤ºä¾‹: ç¬¦åˆå‘½åè§„èŒƒçš„ç”Ÿäº§ç¯å¢ƒ Deployment

apiVersion: apps/v1
kind: Deployment
metadata:
  # å‘½åæ ¼å¼: {environment}-{app}-{resource-type}-{version}
  name: prod-payment-api-deploy-v1.3.0
  namespace: production

  labels:
    # å¿…éœ€æ ‡ç­¾
    app: payment-api
    version: v1.3.0
    environment: production

    # æ²»ç†æ ‡ç­¾
    data-classification: "confidential"  # public | internal | confidential | restricted
    owner: "payment-team"
    team: "backend"
    cost-center: "engineering"

    # åˆè§„æ ‡ç­¾
    compliance-scope: "pci-dss,soc2"

    # ä¸šåŠ¡æ ‡ç­¾
    product: "payment-platform"
    service-tier: "critical"

  annotations:
    # å˜æ›´è¿½è¸ª
    governance.machinenativeops.io/change-request: "CHG-2025-001"
    governance.machinenativeops.io/approved-by: "cab-2025-01-15"

    # æ–‡æ¡£é“¾æ¥
    documentation: "https://wiki.example.com/services/payment-api"
    runbook: "https://wiki.example.com/runbooks/payment-api"

    # ç›‘æ§
    prometheus.io/scrape: "true"
    prometheus.io/port: "8080"
    prometheus.io/path: "/metrics"

spec:
  replicas: 3

  selector:
    matchLabels:
      app: payment-api
      version: v1.3.0
      environment: production

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  template:
    metadata:
      labels:
        app: payment-api
        version: v1.3.0
        environment: production
        data-classification: "confidential"
        owner: "payment-team"

      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"

    spec:
      # æœåŠ¡è´¦å·: éµå¾ªå‘½åè§„èŒƒ
      serviceAccountName: prod-payment-api-sa

      # å®‰å…¨ä¸Šä¸‹æ–‡
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      containers:
      - name: payment-api
        # é•œåƒ: ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬æ ‡ç­¾ï¼Œä¸ä½¿ç”¨ latest
        image: registry.example.com/payment-api:v1.3.0
        imagePullPolicy: IfNotPresent

        # å®¹å™¨å®‰å…¨ä¸Šä¸‹æ–‡
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          capabilities:
            drop:
              - ALL

        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        - name: metrics
          containerPort: 8080
          protocol: TCP

        # ç¯å¢ƒå˜é‡
        env:
        - name: ENVIRONMENT
          value: "production"
        - name: SERVICE_NAME
          value: "payment-api"
        - name: SERVICE_VERSION
          value: "v1.3.0"
        - name: LOG_LEVEL
          value: "info"
        - name: LOG_FORMAT
          value: "json"

        # ä» ConfigMap è¯»å–é…ç½®
        envFrom:
        - configMapRef:
            name: prod-payment-api-cm-v1.3.0

        # ä» Secret è¯»å–æ•æ„Ÿä¿¡æ¯
        - secretRef:
            name: prod-payment-api-secret-v1.3.0

        # èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

        # å­˜æ´»æ¢é’ˆ
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        # å°±ç»ªæ¢é’ˆ
        readinessProbe:
          httpGet:
            path: /ready
            port: http
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3

        # å¯åŠ¨æ¢é’ˆ (for slow-starting containers)
        startupProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 0
          periodSeconds: 5
          failureThreshold: 30  # æœ€å¤šç­‰å¾… 150 ç§’

        # å·æŒ‚è½½
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /app/cache

      volumes:
      - name: tmp
        emptyDir: {}
      - name: cache
        emptyDir: {}

      # Pod åäº²å’Œæ€§ (ç¡®ä¿ Pod åˆ†æ•£åœ¨ä¸åŒèŠ‚ç‚¹)
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - payment-api
              topologyKey: kubernetes.io/hostname

---
# âœ… å¯¹åº”çš„ Service

apiVersion: v1
kind: Service
metadata:
  # å‘½åæ ¼å¼: {environment}-{app}-{resource-type}-{version}
  name: prod-payment-api-svc-v1.3.0
  namespace: production

  labels:
    app: payment-api
    version: v1.3.0
    environment: production
    data-classification: "confidential"
    owner: "payment-team"

  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8080"
    prometheus.io/path: "/metrics"

spec:
  type: ClusterIP
  selector:
    app: payment-api
    version: v1.3.0
    environment: production

  ports:
  - name: http
    port: 80
    targetPort: http
    protocol: TCP
  - name: metrics
    port: 8080
    targetPort: metrics
    protocol: TCP

---
# âœ… å¯¹åº”çš„ ConfigMap

apiVersion: v1
kind: ConfigMap
metadata:
  # å‘½åæ ¼å¼: {environment}-{app}-{resource-type}-{version}
  name: prod-payment-api-cm-v1.3.0
  namespace: production

  labels:
    app: payment-api
    version: v1.3.0
    environment: production
    owner: "payment-team"

data:
  # åº”ç”¨é…ç½®
  database_host: "prod-postgres-primary.database.svc.cluster.local"
  database_port: "5432"
  database_name: "payment_db"

  # ç¼“å­˜é…ç½®
  redis_host: "prod-redis-primary.cache.svc.cluster.local"
  redis_port: "6379"

  # é™æµé…ç½®
  rate_limit_enabled: "true"
  rate_limit_requests_per_second: "1000"

  # ç›‘æ§é…ç½®
  metrics_enabled: "true"
  tracing_enabled: "true"
  tracing_sample_rate: "0.1"

---
# âœ… å¯¹åº”çš„ Secret (ç¤ºä¾‹ï¼Œå®é™…åº”ä½¿ç”¨å¤–éƒ¨å¯†é’¥ç®¡ç†)

apiVersion: v1
kind: Secret
metadata:
  # å‘½åæ ¼å¼: {environment}-{app}-{resource-type}-{version}
  name: prod-payment-api-secret-v1.3.0
  namespace: production

  labels:
    app: payment-api
    version: v1.3.0
    environment: production
    data-classification: "restricted"
    owner: "payment-team"

  annotations:
    # å¯†é’¥è½®æ¢ä¿¡æ¯
    governance.machinenativeops.io/secret-rotation-date: "2025-01-01"
    governance.machinenativeops.io/secret-expiry-date: "2025-04-01"

type: Opaque
data:
  # Base64 ç¼–ç çš„å€¼ (ç¤ºä¾‹)
  database_password: "cGFzc3dvcmQxMjM="
  redis_password: "cmVkaXNwYXNzMTIz"
  api_key: "YXBpa2V5MTIzNDU="
  encryption_key: "ZW5jcnlwdGlvbmtleTEyMzQ1"

---
# âœ… å¯¹åº”çš„ ServiceAccount

apiVersion: v1
kind: ServiceAccount
metadata:
  # å‘½åæ ¼å¼: {environment}-{app}-sa
  name: prod-payment-api-sa
  namespace: production

  labels:
    app: payment-api
    environment: production
    owner: "payment-team"

  annotations:
    governance.machinenativeops.io/rbac-review-date: "2025-01-01"

---
# âœ… å¯¹åº”çš„ HorizontalPodAutoscaler

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  # å‘½åæ ¼å¼: {environment}-{app}-{resource-type}-{version}
  name: prod-payment-api-hpa-v1.3.0
  namespace: production

  labels:
    app: payment-api
    version: v1.3.0
    environment: production
    owner: "payment-team"

spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: prod-payment-api-deploy-v1.3.0

  minReplicas: 3
  maxReplicas: 10

  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70

  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80

  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 2
        periodSeconds: 15
      selectPolicy: Max

---
# âŒ é”™è¯¯ç¤ºä¾‹: ä¸ç¬¦åˆå‘½åè§„èŒƒ

# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: Payment-Service  # âŒ ä½¿ç”¨å¤§å†™å­—æ¯
#   name: payment_service  # âŒ ä½¿ç”¨ä¸‹åˆ’çº¿
#   name: payment-deploy   # âŒ ç¼ºå°‘ç¯å¢ƒå’Œç‰ˆæœ¬
#   name: prod-payment-1.3.0  # âŒ ç¼ºå°‘èµ„æºç±»å‹ï¼Œç‰ˆæœ¬æ ¼å¼é”™è¯¯
#   name: production-payment-service-deployment-v1.3.0  # âŒ ç¯å¢ƒåç§°è¿‡é•¿
#
#   labels:
#     # âŒ ç¼ºå°‘å¿…éœ€æ ‡ç­¾: data-classification, owner, team
#     app: payment
#
# spec:
#   # âŒ ä¸å®‰å…¨çš„é…ç½®
#   securityContext: {}  # åº”è¯¥è®¾ç½®å®‰å…¨ä¸Šä¸‹æ–‡
#
#   containers:
#   - name: payment
#     image: payment-api:latest  # âŒ ä½¿ç”¨ latest æ ‡ç­¾
#
#     # âŒ ç¼ºå°‘å®‰å…¨ä¸Šä¸‹æ–‡
#     securityContext: {}
#
#     # âŒ ç¼ºå°‘èµ„æºé™åˆ¶
#     resources: {}
#
#     # âŒ ç¼ºå°‘å¥åº·æ£€æŸ¥
#     # æ²¡æœ‰ livenessProbe å’Œ readinessProbe

---
# ğŸ“‹ å‘½åè§„èŒƒæ£€æŸ¥æ¸…å•

# Deployment:
#   - [ ] åç§°æ ¼å¼: {env}-{app}-deploy-{version}
#   - [ ] åŒ…å«å¿…éœ€æ ‡ç­¾: app, version, environment, data-classification, owner, team
#   - [ ] åŒ…å«æ²»ç†æ³¨è§£: change-request, approved-by
#   - [ ] å®‰å…¨ä¸Šä¸‹æ–‡é…ç½®æ­£ç¡®
#   - [ ] èµ„æºé™åˆ¶å·²è®¾ç½®
#   - [ ] å¥åº·æ£€æŸ¥å·²é…ç½®
#   - [ ] ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬é•œåƒæ ‡ç­¾

# Service:
#   - [ ] åç§°æ ¼å¼: {env}-{app}-svc-{version}
#   - [ ] æ ‡ç­¾ä¸ Deployment ä¸€è‡´
#   - [ ] é€‰æ‹©å™¨åŒ¹é… Pod æ ‡ç­¾

# ConfigMap:
#   - [ ] åç§°æ ¼å¼: {env}-{app}-cm-{version}
#   - [ ] ç‰ˆæœ¬åŒ–é…ç½®

# Secret:
#   - [ ] åç§°æ ¼å¼: {env}-{app}-secret-{version}
#   - [ ] æ•°æ®åˆ†ç±»æ ‡è®°ä¸º restricted
#   - [ ] åŒ…å«è½®æ¢ä¿¡æ¯æ³¨è§£

# ServiceAccount:
#   - [ ] åç§°æ ¼å¼: {env}-{app}-sa
#   - [ ] RBAC å®¡æŸ¥æ³¨è§£

# éªŒè¯å‘½ä»¤:
# kubectl get all -n production -o yaml | grep -E "name:|app:|version:|environment:"
