{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "version": "2.0.0",
  "description": "CI 錯誤模式數據庫 - 用於精確診斷和一次性修復",
  "lastUpdated": "2025-01-01T00:00:00Z",

  "errorPatterns": {
    "typescript": {
      "displayName": "TypeScript",
      "category": "type",
      "severity": "high",
      "autoFixable": false,
      "patterns": [
        {
          "id": "ts-generic-error",
          "regex": "(.+\\.tsx?)\\((\\d+),(\\d+)\\): error (TS\\d+): (.+)",
          "description": "TypeScript 編譯錯誤（標準格式）",
          "locationGroups": { "file": 1, "line": 2, "column": 3 },
          "messageGroup": 5,
          "codeGroup": 4
        },
        {
          "id": "ts-vscode-format",
          "regex": "(.+\\.tsx?):(\\d+):(\\d+) - error (TS\\d+): (.+)",
          "description": "TypeScript 錯誤（VSCode 格式）",
          "locationGroups": { "file": 1, "line": 2, "column": 3 },
          "messageGroup": 5,
          "codeGroup": 4
        }
      ],
      "commonErrors": {
        "TS2345": {
          "name": "參數類型不匹配",
          "suggestion": "檢查函數調用的參數類型是否與函數定義匹配",
          "example": "Expected 'string', got 'number'"
        },
        "TS2339": {
          "name": "屬性不存在",
          "suggestion": "確認對象類型是否包含該屬性，或添加類型斷言",
          "example": "Property 'x' does not exist on type 'Y'"
        },
        "TS7006": {
          "name": "隱式 any",
          "suggestion": "為參數添加明確的類型註釋",
          "quickFix": "param: unknown"
        },
        "TS2304": {
          "name": "找不到名稱",
          "suggestion": "檢查是否缺少 import 語句或類型定義",
          "example": "Cannot find name 'foo'"
        },
        "TS2322": {
          "name": "類型不可賦值",
          "suggestion": "檢查賦值目標的類型是否正確",
          "example": "Type 'X' is not assignable to type 'Y'"
        }
      },
      "fixStrategy": {
        "commands": [],
        "manualSteps": [
          "運行 `npx tsc --noEmit` 查看完整錯誤",
          "根據錯誤代碼查詢 TypeScript 文檔",
          "修改代碼以符合類型要求",
          "推送修復並重新運行 CI"
        ]
      },
      "documentation": [
        { "title": "TypeScript 錯誤代碼列表", "url": "https://typescript.tv/errors/" },
        { "title": "TypeScript 官方文檔", "url": "https://www.typescriptlang.org/docs/" }
      ]
    },

    "eslint": {
      "displayName": "ESLint",
      "category": "lint",
      "severity": "medium",
      "autoFixable": true,
      "patterns": [
        {
          "id": "eslint-standard",
          "regex": "(.+\\.(?:js|jsx|ts|tsx)):(\\d+):(\\d+): (.+) \\[(.+)\\]",
          "description": "ESLint 錯誤（標準格式）",
          "locationGroups": { "file": 1, "line": 2, "column": 3 },
          "messageGroup": 4,
          "ruleGroup": 5
        },
        {
          "id": "eslint-summary",
          "regex": "✖ (\\d+) problems? \\((\\d+) errors?, (\\d+) warnings?\\)",
          "description": "ESLint 摘要",
          "statsGroups": { "total": 1, "errors": 2, "warnings": 3 }
        },
        {
          "id": "eslint-table",
          "regex": "(.+\\.(?:js|jsx|ts|tsx))\\s+(\\d+):(\\d+)\\s+error\\s+(.+?)\\s+(\\S+)$",
          "description": "ESLint 表格格式",
          "locationGroups": { "file": 1, "line": 2, "column": 3 },
          "messageGroup": 4,
          "ruleGroup": 5
        }
      ],
      "commonErrors": {
        "no-unused-vars": {
          "name": "未使用的變數",
          "autoFix": false,
          "suggestion": "刪除未使用的變數或添加下劃線前綴",
          "quickFix": "// eslint-disable-next-line @typescript-eslint/no-unused-vars"
        },
        "prefer-const": {
          "name": "應使用 const",
          "autoFix": true,
          "suggestion": "將 let 改為 const（變數未被重新賦值）"
        },
        "semi": {
          "name": "分號問題",
          "autoFix": true,
          "suggestion": "添加或移除分號以符合配置"
        },
        "quotes": {
          "name": "引號問題",
          "autoFix": true,
          "suggestion": "統一使用單引號或雙引號"
        },
        "indent": {
          "name": "縮進問題",
          "autoFix": true,
          "suggestion": "修正縮進以符合配置"
        },
        "no-console": {
          "name": "禁止 console",
          "autoFix": false,
          "suggestion": "移除或替換為 logger"
        }
      },
      "fixStrategy": {
        "commands": [
          "npx eslint --fix .",
          "npx eslint --fix --ext .ts,.tsx,.js,.jsx ."
        ],
        "verification": ["npx eslint ."]
      },
      "documentation": [
        { "title": "ESLint 規則文檔", "url": "https://eslint.org/docs/rules/" },
        { "title": "TypeScript ESLint 規則", "url": "https://typescript-eslint.io/rules/" }
      ]
    },

    "prettier": {
      "displayName": "Prettier",
      "category": "format",
      "severity": "low",
      "autoFixable": true,
      "patterns": [
        {
          "id": "prettier-warn",
          "regex": "\\[warn\\] (.+\\.(?:js|jsx|ts|tsx|json|yaml|yml|md))",
          "description": "Prettier 警告",
          "locationGroups": { "file": 1 }
        },
        {
          "id": "prettier-check",
          "regex": "Code style issues found in (.+)",
          "description": "Prettier 檢查失敗",
          "locationGroups": { "file": 1 }
        },
        {
          "id": "prettier-forgot",
          "regex": "Forgot to run Prettier",
          "description": "未運行 Prettier"
        }
      ],
      "fixStrategy": {
        "commands": [
          "npx prettier --write .",
          "npx prettier --write \"**/*.{ts,tsx,js,jsx,json,yaml,yml,md}\""
        ],
        "verification": ["npx prettier --check ."]
      },
      "documentation": [
        { "title": "Prettier 配置", "url": "https://prettier.io/docs/en/configuration.html" }
      ]
    },

    "test": {
      "displayName": "Test",
      "category": "test",
      "severity": "high",
      "autoFixable": false,
      "patterns": [
        {
          "id": "jest-fail",
          "regex": "FAIL\\s+(.+\\.(?:test|spec)\\.(?:js|jsx|ts|tsx))",
          "description": "Jest 測試失敗",
          "locationGroups": { "file": 1 }
        },
        {
          "id": "jest-error",
          "regex": "●\\s+(.+?)\\s+›\\s+(.+)",
          "description": "Jest 測試錯誤詳情",
          "suiteGroup": 1,
          "testGroup": 2
        },
        {
          "id": "jest-assertion",
          "regex": "Expected: (.+)\\s+Received: (.+)",
          "description": "Jest 斷言失敗",
          "expectedGroup": 1,
          "receivedGroup": 2
        },
        {
          "id": "test-location",
          "regex": "at (.+\\.(?:test|spec)\\.(?:js|jsx|ts|tsx)):(\\d+):(\\d+)",
          "description": "測試錯誤位置",
          "locationGroups": { "file": 1, "line": 2, "column": 3 }
        }
      ],
      "fixStrategy": {
        "commands": [],
        "manualSteps": [
          "運行 `npm test -- --verbose` 查看詳細錯誤",
          "檢查測試案例與實際代碼的差異",
          "確認測試數據與預期結果是否正確",
          "修復代碼或更新測試案例",
          "推送修復並重新運行 CI"
        ]
      },
      "documentation": [
        { "title": "Jest 文檔", "url": "https://jestjs.io/docs/getting-started" }
      ]
    },

    "build": {
      "displayName": "Build",
      "category": "build",
      "severity": "critical",
      "autoFixable": false,
      "patterns": [
        {
          "id": "build-failed",
          "regex": "error: build failed|Build error occurred|Failed to compile",
          "description": "建置失敗"
        },
        {
          "id": "module-not-found",
          "regex": "Module not found: Error: Can't resolve '(.+)'",
          "description": "找不到模組",
          "moduleGroup": 1
        },
        {
          "id": "webpack-error",
          "regex": "ERROR in (.+\\.(?:js|jsx|ts|tsx))",
          "description": "Webpack 錯誤",
          "locationGroups": { "file": 1 }
        }
      ],
      "commonErrors": {
        "module-not-found": {
          "name": "找不到模組",
          "suggestion": "檢查 import 路徑是否正確，或安裝缺少的依賴",
          "quickFix": "npm install <module-name>"
        }
      },
      "fixStrategy": {
        "commands": [],
        "manualSteps": [
          "運行 `npm run build` 查看完整錯誤",
          "檢查 import/require 路徑是否正確",
          "確認所有依賴是否已安裝",
          "檢查 tsconfig.json / webpack.config.js 配置"
        ]
      }
    },

    "dependency": {
      "displayName": "Dependency",
      "category": "runtime",
      "severity": "high",
      "autoFixable": true,
      "patterns": [
        {
          "id": "npm-error",
          "regex": "npm ERR! (.+)",
          "description": "npm 錯誤",
          "messageGroup": 1
        },
        {
          "id": "cannot-find-module",
          "regex": "Cannot find module '(.+)'",
          "description": "找不到模組",
          "moduleGroup": 1
        },
        {
          "id": "peer-dep",
          "regex": "peer dep missing: (.+)",
          "description": "缺少對等依賴",
          "depGroup": 1
        },
        {
          "id": "eresolve",
          "regex": "ERESOLVE unable to resolve dependency tree",
          "description": "依賴解析衝突"
        }
      ],
      "fixStrategy": {
        "commands": [
          "rm -rf node_modules package-lock.json",
          "npm install",
          "npm ci"
        ],
        "verification": ["npm ci"]
      }
    },

    "security": {
      "displayName": "Security",
      "category": "security",
      "severity": "critical",
      "autoFixable": true,
      "patterns": [
        {
          "id": "npm-audit",
          "regex": "(\\d+) vulnerabilities? \\((\\d+) (critical|high|moderate|low)",
          "description": "npm 安全審計",
          "statsGroups": { "total": 1, "count": 2, "severity": 3 }
        },
        {
          "id": "cve",
          "regex": "(CVE-\\d{4}-\\d+)",
          "description": "CVE 漏洞",
          "cveGroup": 1
        },
        {
          "id": "ghsa",
          "regex": "(GHSA-\\w+-\\w+-\\w+)",
          "description": "GitHub 安全通知",
          "ghsaGroup": 1
        }
      ],
      "fixStrategy": {
        "commands": [
          "npm audit fix",
          "npm audit fix --force"
        ],
        "verification": ["npm audit"],
        "manualSteps": [
          "運行 `npm audit` 查看漏洞詳情",
          "評估 `--force` 選項的影響",
          "對於需要 breaking changes 的修復，手動更新依賴"
        ]
      },
      "documentation": [
        { "title": "npm audit 文檔", "url": "https://docs.npmjs.com/cli/audit" }
      ]
    },

    "yaml": {
      "displayName": "YAML",
      "category": "syntax",
      "severity": "medium",
      "autoFixable": true,
      "patterns": [
        {
          "id": "yaml-error",
          "regex": "yaml: (.+) at line (\\d+)",
          "description": "YAML 語法錯誤",
          "messageGroup": 1,
          "locationGroups": { "line": 2 }
        },
        {
          "id": "yaml-exception",
          "regex": "YAMLException: (.+) at line (\\d+)",
          "description": "YAML 例外",
          "messageGroup": 1,
          "locationGroups": { "line": 2 }
        }
      ],
      "fixStrategy": {
        "commands": [
          "npx prettier --write '**/*.{yaml,yml}'"
        ],
        "verification": ["npx yaml-lint ."]
      }
    },

    "markdown": {
      "displayName": "Markdown",
      "category": "format",
      "severity": "low",
      "autoFixable": true,
      "patterns": [
        {
          "id": "markdownlint",
          "regex": "(.+\\.md):(\\d+):?(\\d+)? (MD\\d{3})",
          "description": "Markdown lint 錯誤",
          "locationGroups": { "file": 1, "line": 2, "column": 3 },
          "ruleGroup": 4
        }
      ],
      "commonErrors": {
        "MD001": { "name": "標題層級遞增", "autoFix": false },
        "MD009": { "name": "尾隨空格", "autoFix": true },
        "MD012": { "name": "多餘空行", "autoFix": true },
        "MD022": { "name": "標題前後空行", "autoFix": true },
        "MD031": { "name": "代碼塊前後空行", "autoFix": true },
        "MD032": { "name": "列表前後空行", "autoFix": true },
        "MD034": { "name": "裸 URL", "autoFix": true },
        "MD041": { "name": "第一行應為標題", "autoFix": false }
      },
      "fixStrategy": {
        "commands": [
          "npx markdownlint --fix '**/*.md'",
          "npx markdownlint-cli2-fix '**/*.md'"
        ],
        "verification": ["npx markdownlint '**/*.md'"]
      }
    },

    "docker": {
      "displayName": "Docker",
      "category": "build",
      "severity": "high",
      "autoFixable": false,
      "patterns": [
        {
          "id": "docker-error",
          "regex": "docker: Error|failed to solve: (.+)",
          "description": "Docker 建置錯誤",
          "messageGroup": 1
        },
        {
          "id": "dockerfile-line",
          "regex": "Dockerfile:(\\d+)",
          "description": "Dockerfile 行號",
          "locationGroups": { "file": "Dockerfile", "line": 1 }
        }
      ],
      "fixStrategy": {
        "commands": [],
        "manualSteps": [
          "檢查 Dockerfile 語法",
          "確認基礎映像是否存在",
          "檢查 COPY/ADD 路徑是否正確"
        ]
      }
    },

    "permission": {
      "displayName": "Permission",
      "category": "runtime",
      "severity": "high",
      "autoFixable": false,
      "patterns": [
        {
          "id": "eacces",
          "regex": "EACCES: permission denied|Permission denied",
          "description": "權限拒絕"
        }
      ],
      "fixStrategy": {
        "commands": [],
        "manualSteps": [
          "檢查文件/目錄權限",
          "確認 CI 運行用戶有足夠權限",
          "考慮使用 sudo（謹慎使用）"
        ]
      }
    }
  },

  "repairStrategies": {
    "lint-and-format": {
      "name": "Lint 和格式修復",
      "description": "自動修復所有 lint 和格式問題",
      "commands": [
        "npx eslint --fix .",
        "npx prettier --write ."
      ],
      "verification": [
        "npx eslint .",
        "npx prettier --check ."
      ]
    },
    "full-dependency-reset": {
      "name": "完整依賴重置",
      "description": "刪除並重新安裝所有依賴",
      "commands": [
        "rm -rf node_modules",
        "rm -f package-lock.json",
        "npm install"
      ],
      "verification": ["npm ci"]
    },
    "security-patch": {
      "name": "安全補丁",
      "description": "自動應用安全修復",
      "commands": ["npm audit fix"],
      "verification": ["npm audit"]
    }
  },

  "priorityOrder": [
    "security",
    "build",
    "typescript",
    "test",
    "dependency",
    "eslint",
    "prettier",
    "yaml",
    "markdown",
    "docker",
    "permission"
  ],

  "metadata": {
    "maintainer": "platform-governance",
    "updateFrequency": "monthly",
    "sources": [
      "TypeScript GitHub Issues",
      "ESLint Rule Documentation",
      "npm Security Advisories",
      "Internal CI Failure Analysis"
    ]
  }
}
