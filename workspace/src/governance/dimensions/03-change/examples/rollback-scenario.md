# å›æ»šåœºæ™¯ç¤ºä¾‹ (Rollback Scenario Example)

æœ¬æ–‡æ¡£æä¾›äº†å˜æ›´ç®¡ç†ä¸­å›æ»šåœºæ™¯çš„è¯¦ç»†ç¤ºä¾‹ï¼Œå¸®åŠ©å›¢é˜Ÿç†è§£å¦‚ä½•è®¡åˆ’å’Œæ‰§è¡Œå›æ»šã€‚

## åœºæ™¯ 1: åº”ç”¨ç‰ˆæœ¬å›æ»š

### èƒŒæ™¯

Payment Service ä» v1.2.0 å‡çº§åˆ° v1.3.0 åï¼Œå‘ç°æ”¯ä»˜æˆåŠŸç‡ä» 99.8% ä¸‹é™åˆ° 95%ï¼Œéœ€è¦ç«‹å³å›æ»šã€‚

### å˜æ›´è¯·æ±‚

```yaml
apiVersion: governance.machinenativeops.io/v1alpha1
kind: ChangeRequest
metadata:
  id: "CHG-2025-015"
  title: "Payment Service v1.3.0 å‡çº§"
  status: "rolled-back"
```

### å›æ»šè§¦å‘æ¡ä»¶

åœ¨å®æ–½è®¡åˆ’ä¸­å®šä¹‰çš„è§¦å‘æ¡ä»¶ï¼š

```yaml
rollbackPlan:
  triggers:
    - "æ”¯ä»˜æˆåŠŸç‡ < 98% æŒç»­ 5 åˆ†é’Ÿ"  # âœ… è§¦å‘
    - "å¹³å‡å“åº”æ—¶é—´ > 1000ms æŒç»­ 10 åˆ†é’Ÿ"  # âŒ æœªè§¦å‘
    - "é”™è¯¯ç‡ > 1% æŒç»­ 5 åˆ†é’Ÿ"  # âŒ æœªè§¦å‘
```

**è§¦å‘æ—¶é—´**: 2025-01-15 14:35:00 UTC

### å›æ»šæ‰§è¡Œ

#### ç¬¬ 1 æ­¥: ç¡®è®¤å›æ»šå†³ç­– (2åˆ†é’Ÿ)

```bash
# 14:35 - ç¡®è®¤æŒ‡æ ‡å¼‚å¸¸
# Grafana ä»ªè¡¨æ¿æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸç‡ä¸‹é™åˆ° 95%

# æ£€æŸ¥å‘Šè­¦
FIRING: PaymentSuccessRateLow
  - Current: 95.2%
  - Threshold: 98%
  - Duration: 5m

# å†³ç­–: ç«‹å³å›æ»š
# å†³ç­–äºº: SRE On-call + Team Lead
```

#### ç¬¬ 2 æ­¥: æ‰§è¡Œ Kubernetes å›æ»š (3åˆ†é’Ÿ)

```bash
# 14:37 - æ‰§è¡Œå›æ»šå‘½ä»¤
kubectl rollout undo deployment/prod-payment-deploy -n production

# è¾“å‡º
deployment.apps/prod-payment-deploy rolled back

# ç›‘æ§å›æ»šè¿›åº¦
kubectl rollout status deployment/prod-payment-deploy -n production

# è¾“å‡º
Waiting for deployment "prod-payment-deploy" rollout to finish: 1 out of 3 new replicas have been updated...
Waiting for deployment "prod-payment-deploy" rollout to finish: 1 out of 3 new replicas have been updated...
Waiting for deployment "prod-payment-deploy" rollout to finish: 2 out of 3 new replicas have been updated...
Waiting for deployment "prod-payment-deploy" rollout to finish: 2 old replicas are pending termination...
Waiting for deployment "prod-payment-deploy" rollout to finish: 1 old replicas are pending termination...
deployment "prod-payment-deploy" successfully rolled out

# 14:40 - å›æ»šå®Œæˆ
```

#### ç¬¬ 3 æ­¥: éªŒè¯å›æ»šæˆåŠŸ (5åˆ†é’Ÿ)

```bash
# æ£€æŸ¥ Pod çŠ¶æ€
kubectl get pods -n production -l app=payment-api

# è¾“å‡º
NAME                                      READY   STATUS    RESTARTS   AGE
prod-payment-deploy-v1.2.0-abc123-xyz1   1/1     Running   0          2m
prod-payment-deploy-v1.2.0-abc123-xyz2   1/1     Running   0          3m
prod-payment-deploy-v1.2.0-abc123-xyz3   1/1     Running   0          3m

# æ£€æŸ¥ç‰ˆæœ¬
kubectl describe deployment prod-payment-deploy -n production | grep Image

# è¾“å‡º
Image: payment-api:v1.2.0  # âœ… å·²å›æ»šåˆ° v1.2.0

# è¿è¡Œå¥åº·æ£€æŸ¥
curl https://api.example.com/health

# è¾“å‡º
{
  "status": "healthy",
  "version": "v1.2.0"
}

# 14:45 - éªŒè¯é€šè¿‡
```

#### ç¬¬ 4 æ­¥: ç›‘æ§æ¢å¤ (10åˆ†é’Ÿ)

```promql
# ç›‘æ§æ”¯ä»˜æˆåŠŸç‡
(
  sum(rate(payment_success_total[5m])) /
  sum(rate(payment_total[5m]))
) * 100

# 14:50 æ—¶é—´ç‚¹æ•°æ®
Time: 14:50
Value: 99.7%  # âœ… å·²æ¢å¤æ­£å¸¸

# 15:00 æ—¶é—´ç‚¹æ•°æ®
Time: 15:00
Value: 99.8%  # âœ… å®Œå…¨æ¢å¤
```

#### ç¬¬ 5 æ­¥: é€šçŸ¥å’Œè®°å½• (æŒç»­)

```bash
# 14:40 - å‘é€ Slack é€šçŸ¥
# Channel: #incidents
Message:
ğŸ”„ [ROLLBACK] Payment Service å·²å›æ»šåˆ° v1.2.0
åŸå› : æ”¯ä»˜æˆåŠŸç‡ä¸‹é™åˆ° 95%
å½±å“: 14:35-14:40 (5åˆ†é’Ÿ)
å½“å‰çŠ¶æ€: æœåŠ¡å·²æ¢å¤æ­£å¸¸
åç»­: å°†è¿›è¡Œæ ¹å› åˆ†æ

# 14:45 - æ›´æ–°å˜æ›´è¯·æ±‚
# çŠ¶æ€: rolled-back
# æ·»åŠ å›æ»šè®°å½•

# 15:00 - å‘é€æ¢å¤ç¡®è®¤
# Channel: #incidents
Message:
âœ… [RESOLVED] Payment Service å·²å®Œå…¨æ¢å¤
æ”¯ä»˜æˆåŠŸç‡: 99.8%
å½±å“æ—¶é•¿: 5 åˆ†é’Ÿ
å—å½±å“äº¤æ˜“: ~50 ç¬” (å·²é‡è¯•æˆåŠŸ)
```

### æ€»æ—¶é•¿

- **æ£€æµ‹åˆ°é—®é¢˜**: 14:30 (è‡ªåŠ¨å‘Šè­¦)
- **å†³ç­–å›æ»š**: 14:35 (5åˆ†é’Ÿ)
- **æ‰§è¡Œå›æ»š**: 14:37-14:40 (3åˆ†é’Ÿ)
- **éªŒè¯é€šè¿‡**: 14:45 (5åˆ†é’Ÿ)
- **å®Œå…¨æ¢å¤**: 15:00 (10åˆ†é’Ÿ)

**æ€»è®¡**: ä»æ£€æµ‹åˆ°å®Œå…¨æ¢å¤ 30 åˆ†é’Ÿ

### æ ¹å› åˆ†æ

```yaml
äº‹ååˆ†æä¼šè®®:
  æ—¶é—´: 2025-01-16 10:00
  å‚ä¸: Payment Team, SRE, QA

æ ¹æœ¬åŸå› :
  - v1.3.0 å¼•å…¥çš„æ–°é‡è¯•é€»è¾‘æœ‰ bug
  - åœ¨æŸäº›å¤±è´¥åœºæ™¯ä¸‹å¯¼è‡´é‡å¤æ‰£æ¬¾
  - Payment Gateway æ£€æµ‹åˆ°å¼‚å¸¸å¹¶æ‹’ç»éƒ¨åˆ†è¯·æ±‚

ä¸ºä»€ä¹ˆæ²¡æœ‰åœ¨æµ‹è¯•ä¸­å‘ç°:
  - æµ‹è¯•ç¯å¢ƒçš„ Payment Gateway é…ç½®ä¸ç”Ÿäº§ä¸åŒ
  - æµ‹è¯•æ•°æ®æ²¡æœ‰è¦†ç›–è¿™ä¸ªç‰¹å®šçš„å¤±è´¥åœºæ™¯
  - å‹åŠ›æµ‹è¯•è§„æ¨¡ä¸å¤Ÿ

æ”¹è¿›æªæ–½:
  1. å¢åŠ ç”Ÿäº§ç¯å¢ƒçš„æµ‹è¯•ç”¨ä¾‹
  2. ä½¿ç”¨ç”Ÿäº§æµé‡çš„ shadow testing
  3. å¢å¼ºå‹åŠ›æµ‹è¯•åœºæ™¯
  4. Payment Gateway é…ç½®åŒæ­¥åˆ°æµ‹è¯•ç¯å¢ƒ
  5. å¢åŠ é‡è¯•é€»è¾‘çš„å•å…ƒæµ‹è¯•è¦†ç›–

é¢„é˜²æªæ–½:
  - å®æ–½é‡‘ä¸é›€å‘å¸ƒï¼ˆå…ˆ 10% æµé‡ï¼‰
  - å¢åŠ è‡ªåŠ¨å›æ»šè§¦å‘å™¨
  - æ”¹è¿›å‘Šè­¦çµæ•åº¦
```

### ç»éªŒæ•™è®­

#### âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **å¿«é€Ÿå†³ç­–**: 5åˆ†é’Ÿå†…å†³å®šå›æ»š
2. **æ¸…æ™°çš„å›æ»šè®¡åˆ’**: æå‰å®šä¹‰å¥½è§¦å‘æ¡ä»¶å’Œæ­¥éª¤
3. **è‡ªåŠ¨åŒ–å·¥å…·**: Kubernetes ä¸€é”®å›æ»š
4. **æœ‰æ•ˆæ²Ÿé€š**: åŠæ—¶é€šçŸ¥æ‰€æœ‰ç›¸å…³æ–¹
5. **å®Œæ•´è®°å½•**: è¯¦ç»†çš„æ—¶é—´çº¿å’Œå†³ç­–è®°å½•

#### âŒ éœ€è¦æ”¹è¿›çš„åœ°æ–¹

1. **æµ‹è¯•è¦†ç›–**: ç”Ÿäº§ç¯å¢ƒé…ç½®æœªåŒæ­¥åˆ°æµ‹è¯•
2. **å‘å¸ƒç­–ç•¥**: åº”è¯¥ä½¿ç”¨é‡‘ä¸é›€å‘å¸ƒ
3. **å‘Šè­¦å»¶è¿Ÿ**: 5åˆ†é’Ÿæ‰è§¦å‘å‘Šè­¦ï¼Œå¯ä»¥æ›´å¿«
4. **å½±å“è¯„ä¼°**: æ²¡æœ‰æå‰è¯„ä¼°å›æ»šçš„ä¸šåŠ¡å½±å“

---

## åœºæ™¯ 2: æ•°æ®åº“ Schema å˜æ›´å›æ»š

### èƒŒæ™¯

User Service æ•°æ®åº“ schema å˜æ›´åï¼Œå‘ç°æ–°å­—æ®µå¯¼è‡´æŸ¥è¯¢æ€§èƒ½ä¸¥é‡ä¸‹é™ï¼Œéœ€è¦å›æ»š schemaã€‚

### æŒ‘æˆ˜

**éš¾ç‚¹**: æ•°æ®åº“ schema å›æ»šæ¯”åº”ç”¨å›æ»šå¤æ‚å¾—å¤šï¼š

- å¯èƒ½å·²æœ‰æ–°æ•°æ®å†™å…¥æ–°å­—æ®µ
- å‘åå…¼å®¹æ€§é—®é¢˜
- éœ€è¦æ•°æ®è¿ç§»

### å›æ»šç­–ç•¥

#### ç­–ç•¥ 1: å‰å‘ä¿®å¤ (ä¼˜å…ˆ)

```sql
-- ä¸å›æ»š schemaï¼Œè€Œæ˜¯ä¼˜åŒ–æŸ¥è¯¢
-- æ·»åŠ ç´¢å¼•è§£å†³æ€§èƒ½é—®é¢˜
CREATE INDEX idx_users_new_field ON users(new_field);

-- åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM users WHERE new_field = 'value';
```

**å†³ç­–**: å¦‚æœèƒ½åœ¨ 1 å°æ—¶å†…ä¿®å¤ï¼Œä¼˜å…ˆå‰å‘ä¿®å¤

#### ç­–ç•¥ 2: Schema å›æ»š (æœ€åæ‰‹æ®µ)

```yaml
å›æ»šæ­¥éª¤:
  1. åº”ç”¨å›æ»šåˆ°å…¼å®¹æ—§ schema çš„ç‰ˆæœ¬
  2. ç¡®è®¤æ²¡æœ‰ä»£ç ä¾èµ–æ–°å­—æ®µ
  3. å¯¼å‡ºæ–°å­—æ®µæ•°æ®ï¼ˆå¦‚æœéœ€è¦ä¿ç•™ï¼‰
  4. æ‰§è¡Œ schema å›æ»š
  5. éªŒè¯åº”ç”¨åŠŸèƒ½
```

```sql
-- æ­¥éª¤ 3: å¤‡ä»½æ–°å­—æ®µæ•°æ®
CREATE TABLE users_new_field_backup AS
SELECT id, new_field, created_at
FROM users
WHERE new_field IS NOT NULL;

-- æ­¥éª¤ 4: åˆ é™¤æ–°å­—æ®µ
ALTER TABLE users DROP COLUMN new_field;

-- éªŒè¯
\d users
```

### å®é™…æ‰§è¡Œ

æœ¬æ¬¡é€‰æ‹©äº†**å‰å‘ä¿®å¤**ï¼š

```sql
-- æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX CONCURRENTLY idx_users_email_new_field
ON users(email, new_field);

-- æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”
-- ä¿®å¤å‰: 2500ms
-- ä¿®å¤å: 45ms

-- âœ… é—®é¢˜è§£å†³ï¼Œæ— éœ€å›æ»š
```

---

## åœºæ™¯ 3: é…ç½®å˜æ›´å›æ»š

### èƒŒæ™¯

æ›´æ–° Nginx ingress é…ç½®åï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚è¿”å› 502 é”™è¯¯ã€‚

### å›æ»šæ‰§è¡Œ

```bash
# ç«‹å³å›æ»šé…ç½®
kubectl rollout undo deployment/ingress-nginx-controller -n ingress-nginx

# æˆ–è€…ï¼šåº”ç”¨ä¹‹å‰çš„é…ç½®æ–‡ä»¶
kubectl apply -f backup/ingress-config-previous.yaml

# éªŒè¯
curl -I https://api.example.com

# è¾“å‡º
HTTP/2 200 OK  # âœ… å·²æ¢å¤
```

### æ—¶é•¿

- **æ£€æµ‹**: 30 ç§’ï¼ˆæ‰€æœ‰è¯·æ±‚ç«‹å³å¤±è´¥ï¼‰
- **å›æ»š**: 1 åˆ†é’Ÿ
- **æ¢å¤**: 2 åˆ†é’Ÿ

**æ€»è®¡**: 3 åˆ†é’Ÿå†…å®Œå…¨æ¢å¤

---

## å›æ»šæœ€ä½³å®è·µ

### 1. è®¡åˆ’é˜¶æ®µ

```yaml
å›æ»šè®¡åˆ’å¿…é¡»åŒ…å«:
  - [ ] æ˜ç¡®çš„è§¦å‘æ¡ä»¶
  - [ ] è¯¦ç»†çš„å›æ»šæ­¥éª¤
  - [ ] é¢„ä¼°çš„å›æ»šæ—¶é—´
  - [ ] å›æ»šåçš„éªŒè¯æ–¹æ³•
  - [ ] å›æ»šçš„æ½œåœ¨å½±å“
  - [ ] æ•°æ®ä¸€è‡´æ€§å¤„ç†
  - [ ] é€šçŸ¥è®¡åˆ’
```

### 2. æ‰§è¡Œé˜¶æ®µ

```yaml
å›æ»šæ‰§è¡ŒåŸåˆ™:
  - å¿«é€Ÿå†³ç­–: æ»¡è¶³è§¦å‘æ¡ä»¶ç«‹å³æ‰§è¡Œ
  - æ¸…æ™°æ²Ÿé€š: é€šçŸ¥æ‰€æœ‰ç›¸å…³æ–¹
  - å®Œæ•´è®°å½•: è®°å½•æ‰€æœ‰æ“ä½œå’Œæ—¶é—´
  - æŒç»­ç›‘æ§: ç¡®ä¿å›æ»šæˆåŠŸ
  - ä¿ç•™è¯æ®: ä¾¿äºäº‹ååˆ†æ
```

### 3. éªŒè¯é˜¶æ®µ

```yaml
å›æ»šéªŒè¯æ¸…å•:
  - [ ] åº”ç”¨ç‰ˆæœ¬æ­£ç¡®
  - [ ] æ‰€æœ‰ Pod å¥åº·
  - [ ] å¥åº·æ£€æŸ¥é€šè¿‡
  - [ ] å…³é”®æŒ‡æ ‡æ¢å¤æ­£å¸¸
  - [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡
  - [ ] æ— æ–°çš„å‘Šè­¦
  - [ ] ç”¨æˆ·æµé‡æ­£å¸¸
```

### 4. äº‹ååˆ†æ

```yaml
äº‹ååˆ†æé‡ç‚¹:
  - æ ¹æœ¬åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
  - ä¸ºä»€ä¹ˆæ²¡åœ¨æµ‹è¯•ä¸­å‘ç°ï¼Ÿ
  - å›æ»šæ‰§è¡Œæ˜¯å¦é¡ºåˆ©ï¼Ÿ
  - å“ªäº›å¯ä»¥æ”¹è¿›ï¼Ÿ
  - å¦‚ä½•é¢„é˜²ç±»ä¼¼é—®é¢˜ï¼Ÿ
```

---

## å›æ»šå†³ç­–æ ‘

```
é—®é¢˜æ£€æµ‹
  â†“
ä¸¥é‡ç¨‹åº¦è¯„ä¼°
  â”œâ”€ ä¸¥é‡ (P0/P1)
  â”‚   â”œâ”€ æœ‰å¿«é€Ÿä¿®å¤ï¼Ÿ
  â”‚   â”‚   â”œâ”€ æ˜¯ â†’ å‰å‘ä¿®å¤ (< 5åˆ†é’Ÿ)
  â”‚   â”‚   â””â”€ å¦ â†’ ç«‹å³å›æ»š
  â”‚   â””â”€ å›æ»š
  â”‚
  â””â”€ ä¸­ç­‰/ä½ (P2/P3)
      â”œâ”€ æœ‰ä¿®å¤æ–¹æ¡ˆï¼Ÿ
      â”‚   â”œâ”€ æ˜¯ â†’ è¯„ä¼°ä¿®å¤æ—¶é—´
      â”‚   â”‚   â”œâ”€ < 1å°æ—¶ â†’ å‰å‘ä¿®å¤
      â”‚   â”‚   â””â”€ > 1å°æ—¶ â†’ å›æ»š
      â”‚   â””â”€ å¦ â†’ å›æ»š
      â””â”€ å›æ»š

å›æ»šå†³ç­–åŸåˆ™:
  - P0/P1: ä¼˜å…ˆå¿«é€Ÿæ¢å¤æœåŠ¡
  - P2/P3: æƒè¡¡ä¿®å¤æˆæœ¬å’Œå½±å“
  - ä¸ç¡®å®šæ—¶: é€‰æ‹©å›æ»š
```

---

## å‚è€ƒèµ„æ–™

- [å˜æ›´ç®¡ç†æ–‡æ¡£](../../docs/governance/05-change-management.md)
- [å˜æ›´è¯·æ±‚æ¨¡æ¿](../../templates/governance/forms/change-request.template.yaml)
- [å˜æ›´è¯·æ±‚ç¤ºä¾‹](./CHG-2025-001.yaml)
