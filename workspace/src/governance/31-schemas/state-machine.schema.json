{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://unmanned-island.io/schemas/state-machine.schema.json",
  "title": "HLP Executor State Machine Schema",
  "description": "Schema for defining state machines in the HLP Executor Core Plugin",
  "type": "object",
  "required": ["initial_state", "states"],
  "properties": {
    "initial_state": {
      "type": "string",
      "description": "The initial state of the state machine",
      "minLength": 1,
      "examples": ["idle", "ready", "initializing"]
    },
    "states": {
      "type": "array",
      "description": "List of all states in the state machine",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/state"
      }
    },
    "metadata": {
      "type": "object",
      "description": "Optional metadata for the state machine",
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable name of the state machine"
        },
        "version": {
          "type": "string",
          "description": "Version of the state machine definition",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "description": {
          "type": "string",
          "description": "Description of the state machine purpose"
        }
      }
    }
  },
  "definitions": {
    "state": {
      "type": "object",
      "required": ["name", "transitions"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique name of the state",
          "minLength": 1,
          "pattern": "^[a-z0-9_-]+$"
        },
        "transitions": {
          "type": "array",
          "description": "List of valid transitions from this state",
          "items": {
            "$ref": "#/definitions/transition"
          }
        },
        "timeout_seconds": {
          "type": "integer",
          "description": "Maximum time allowed in this state before timeout (in seconds)",
          "minimum": 0,
          "maximum": 86400,
          "examples": [30, 60, 300]
        },
        "final_state": {
          "type": "boolean",
          "description": "Whether this is a final/terminal state",
          "default": false
        },
        "recovery_state": {
          "type": "boolean",
          "description": "Whether this is a recovery/rollback state",
          "default": false
        },
        "on_entry": {
          "type": "array",
          "description": "Actions to execute when entering this state",
          "items": {
            "type": "string"
          }
        },
        "on_exit": {
          "type": "array",
          "description": "Actions to execute when exiting this state",
          "items": {
            "type": "string"
          }
        },
        "metadata": {
          "type": "object",
          "description": "Optional metadata for the state",
          "properties": {
            "description": {
              "type": "string"
            },
            "severity": {
              "type": "string",
              "enum": ["info", "warning", "error", "critical"]
            },
            "checkpoint_enabled": {
              "type": "boolean",
              "description": "Whether to create a checkpoint when entering this state",
              "default": false
            }
          }
        }
      }
    },
    "transition": {
      "type": "object",
      "required": ["target", "event"],
      "properties": {
        "target": {
          "type": "string",
          "description": "Target state name for this transition",
          "minLength": 1
        },
        "event": {
          "type": "string",
          "description": "Event that triggers this transition",
          "minLength": 1,
          "examples": ["start", "complete", "error", "timeout"]
        },
        "condition": {
          "type": "string",
          "description": "Optional condition expression that must be true for the transition",
          "examples": ["execution_count < 3", "risk_score < 0.5"]
        },
        "guard": {
          "type": "string",
          "description": "Optional guard function name to evaluate before transition"
        },
        "actions": {
          "type": "array",
          "description": "Actions to execute during this transition",
          "items": {
            "type": "string"
          }
        },
        "metadata": {
          "type": "object",
          "description": "Optional metadata for the transition",
          "properties": {
            "description": {
              "type": "string"
            },
            "priority": {
              "type": "integer",
              "minimum": 0,
              "maximum": 100,
              "default": 50
            }
          }
        }
      }
    }
  },
  "examples": [
    {
      "initial_state": "idle",
      "metadata": {
        "name": "task-execution-state-machine",
        "version": "1.0.0",
        "description": "State machine for task execution workflow"
      },
      "states": [
        {
          "name": "idle",
          "transitions": [
            {
              "target": "running",
              "event": "start",
              "actions": ["initialize_resources"]
            }
          ],
          "timeout_seconds": 300,
          "final_state": false,
          "recovery_state": false,
          "metadata": {
            "description": "Initial idle state",
            "checkpoint_enabled": true
          }
        },
        {
          "name": "running",
          "transitions": [
            {
              "target": "completed",
              "event": "success",
              "actions": ["cleanup_resources"]
            },
            {
              "target": "failed",
              "event": "error",
              "actions": ["log_error", "initiate_rollback"]
            },
            {
              "target": "recovery",
              "event": "recoverable_error",
              "condition": "retry_count < 3"
            }
          ],
          "timeout_seconds": 3600,
          "final_state": false,
          "recovery_state": false,
          "on_entry": ["start_monitoring"],
          "on_exit": ["stop_monitoring"],
          "metadata": {
            "description": "Task execution in progress",
            "severity": "info",
            "checkpoint_enabled": true
          }
        },
        {
          "name": "recovery",
          "transitions": [
            {
              "target": "running",
              "event": "retry"
            },
            {
              "target": "failed",
              "event": "recovery_failed"
            }
          ],
          "timeout_seconds": 600,
          "final_state": false,
          "recovery_state": true,
          "metadata": {
            "description": "Recovery state for handling errors",
            "severity": "warning"
          }
        },
        {
          "name": "completed",
          "transitions": [],
          "final_state": true,
          "recovery_state": false,
          "metadata": {
            "description": "Task completed successfully",
            "severity": "info"
          }
        },
        {
          "name": "failed",
          "transitions": [],
          "final_state": true,
          "recovery_state": false,
          "metadata": {
            "description": "Task failed permanently",
            "severity": "error"
          }
        }
      ]
    }
  ]
}
