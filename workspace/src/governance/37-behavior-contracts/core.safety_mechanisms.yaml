# ═══════════════════════════════════════════════════════════════════════════════
#                    Behavior Contract: core.safety_mechanisms
#                    行為契約：安全機制
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define expected behaviors for safety mechanisms module
# 用途: 定義安全機制模組的預期行為
#
# Version: 1.0.0
# Owner: @security-team
# Last Updated: 2025-12-07
# ═══════════════════════════════════════════════════════════════════════════════

contract:
  module: "core.safety_mechanisms"
  version: "1.0.0"
  status: "active"
  owner: "@security-team"
  
  description: |
    Safety mechanisms module provides runtime safety checks, risk assessment,
    and automated mitigation for autonomous operations.
    
    安全機制模組提供運行時安全檢查、風險評估和自主操作的自動緩解。

# ============================================================================
# API Contracts | API 契約
# ============================================================================

api:
  base_path: "/api/v1/safety"
  
  endpoints:
    
    # ─────────────────────────────────────────────────────────────────────────
    # Execute Safety Check
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Execute Safety Check"
      method: POST
      path: "/checks"
      
      description: |
        Execute safety checks before allowing an operation.
        執行安全檢查以允許操作。
      
      input_schema:
        type: "object"
        required: ["operation_type", "context"]
        properties:
          operation_type:
            type: "string"
            enum: ["deployment", "data_access", "system_modification", "autonomous_action"]
          context:
            type: "object"
            properties:
              actor: { type: "string" }
              target: { type: "string" }
              environment: { type: "string" }
              metadata: { type: "object" }
          constraints:
            type: "array"
            items:
              type: "string"
      
      output_schema:
        type: "object"
        properties:
          check_id: { type: "string" }
          allowed: { type: "boolean" }
          risk_level: { type: "string", enum: ["low", "medium", "high", "critical"] }
          violations: { type: "array", items: { type: "string" } }
          recommendations: { type: "array", items: { type: "string" } }
          checked_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "All safety rules are evaluated"
        - "Decision is deterministic for same input"
        - "Response time < 50ms for critical operations"
        - "Audit trail is created"
      
      error_responses:
        - code: 400
          condition: "Invalid operation type"
          message: "ERR_INVALID_OPERATION"
        - code: 500
          condition: "Safety check engine failure"
          message: "ERR_SAFETY_CHECK_FAILED"
      
      performance:
        response_time_p50: "< 10ms"
        response_time_p99: "< 50ms"
        throughput: "> 5000 req/s"

    # ─────────────────────────────────────────────────────────────────────────
    # Assess Risk
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Assess Risk"
      method: POST
      path: "/risk-assessment"
      
      description: |
        Assess risk level for a proposed action.
        評估提議操作的風險等級。
      
      input_schema:
        type: "object"
        required: ["action", "impact_scope"]
        properties:
          action:
            type: "object"
            properties:
              type: { type: "string" }
              description: { type: "string" }
          impact_scope:
            type: "object"
            properties:
              users_affected: { type: "integer" }
              systems_affected: { type: "array" }
              data_sensitivity: { type: "string" }
      
      output_schema:
        type: "object"
        properties:
          assessment_id: { type: "string" }
          risk_score: { type: "number", minimum: 0, maximum: 100 }
          risk_level: { type: "string" }
          risk_factors: { type: "array" }
          mitigation_steps: { type: "array" }
          approval_required: { type: "boolean" }
      
      guarantees:
        - "Risk score is calculated consistently"
        - "All risk factors are considered"
        - "Mitigation steps are actionable"

    # ─────────────────────────────────────────────────────────────────────────
    # Apply Circuit Breaker
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Apply Circuit Breaker"
      method: POST
      path: "/circuit-breaker"
      
      description: |
        Activate circuit breaker to stop unsafe operations.
        啟動斷路器以停止不安全的操作。
      
      input_schema:
        type: "object"
        required: ["target", "reason"]
        properties:
          target:
            type: "string"
            description: "Module or service to protect"
          reason: { type: "string" }
          duration_seconds: { type: "integer" }
      
      output_schema:
        type: "object"
        properties:
          breaker_id: { type: "string" }
          activated: { type: "boolean" }
          active_until: { type: "string", format: "date-time" }
      
      guarantees:
        - "Circuit breaker activates immediately"
        - "All requests to target are blocked"
        - "Automatic recovery after duration"

# ============================================================================
# Event Contracts | 事件契約
# ============================================================================

events:
  
  - name: "safety.check_failed"
    description: "Emitted when safety check fails"
    
    payload_schema:
      type: "object"
      required: ["check_id", "operation_type", "violations"]
      properties:
        check_id: { type: "string" }
        operation_type: { type: "string" }
        violations: { type: "array" }
        risk_level: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "90 days"
    
    consumers:
      - "services.audit"
      - "ops.alerting"
      - "automation.monitoring"

  - name: "safety.circuit_breaker_activated"
    description: "Emitted when circuit breaker is activated"
    
    payload_schema:
      type: "object"
      properties:
        breaker_id: { type: "string" }
        target: { type: "string" }
        reason: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "30 days"
    
    consumers:
      - "ops.alerting"
      - "services.incident_management"

  - name: "safety.high_risk_operation"
    description: "Emitted when high-risk operation is attempted"
    
    payload_schema:
      type: "object"
      properties:
        operation_type: { type: "string" }
        risk_score: { type: "number" }
        actor: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "180 days"
    
    consumers:
      - "services.security"
      - "services.audit"

# ============================================================================
# Invariants | 不變條件
# ============================================================================

invariants:
  
  - name: "Fail-Safe Default"
    description: "When in doubt, deny the operation"
    rule: "if uncertain(check_result) then deny(operation)"
    enforcement: "application-logic"
    
  - name: "All Checks Must Pass"
    description: "Operation allowed only if all safety checks pass"
    rule: "allowed(op) implies forall c in checks(op): passed(c)"
    enforcement: "pre-condition"
    
  - name: "Circuit Breaker Precedence"
    description: "Active circuit breaker blocks all operations"
    rule: "forall op where active_breaker(op.target): deny(op)"
    enforcement: "application-logic"
    
  - name: "Audit Trail Required"
    description: "All safety decisions are logged"
    rule: "forall decision: exists audit_entry where audit_entry.decision_id = decision.id"
    enforcement: "post-condition"
    
  - name: "No Bypass Mechanism"
    description: "Safety checks cannot be bypassed programmatically"
    rule: "not exists bypass_flag in code"
    enforcement: "code-review"

# ============================================================================
# Failure Modes | 失敗模式
# ============================================================================

failure_modes:
  
  - scenario: "Safety Check Timeout"
    triggers:
      - "Check takes > 50ms"
      - "Rule evaluation hangs"
    recovery:
      - "Fail-safe: deny operation"
      - "Log timeout event"
      - "Alert monitoring team"
    error_code: "ERR_SAFETY_TIMEOUT"
    fail_safe: "deny"
    
  - scenario: "Rule Engine Failure"
    triggers:
      - "Rule compilation error"
      - "Rule execution exception"
    recovery:
      - "Fail-safe: deny operation"
      - "Alert security team immediately"
      - "Use cached last-known-good rules"
    error_code: "ERR_RULE_ENGINE_FAILED"
    fail_safe: "deny"
    
  - scenario: "Conflicting Rules"
    triggers:
      - "Two rules give opposite decisions"
    recovery:
      - "Apply most restrictive rule"
      - "Log conflict for review"
      - "Alert rule maintainers"
    error_code: "WARN_RULE_CONFLICT"
    fail_safe: "deny"

# ============================================================================
# Dependencies | 依賴關係
# ============================================================================

dependencies:
  
  required:
    - module: "governance.policies"
      purpose: "Safety policy definitions"
      failure_mode: "use-cached"
    
    - module: "infrastructure.database"
      purpose: "Store safety decisions"
      failure_mode: "critical"
  
  optional:
    - module: "services.audit"
      purpose: "Audit logging"
      failure_mode: "log-and-continue"

# ============================================================================
# Testing Requirements | 測試要求
# ============================================================================

testing:
  unit_tests:
    coverage_min: 90
    critical_paths:
      - "Fail-safe logic"
      - "Circuit breaker activation"
      - "Risk assessment calculation"
  
  integration_tests:
    required:
      - "End-to-end safety check with denial"
      - "Circuit breaker triggering and recovery"
      - "High-risk operation detection"
  
  chaos_tests:
    scenarios:
      - "Rule engine crash during check"
      - "Database unavailable"
      - "Extremely high load (>10k req/s)"

# ============================================================================
# Security & Compliance | 安全與合規
# ============================================================================

security:
  safety_critical: true
  
  security_controls:
    - "Fail-safe defaults (deny when uncertain)"
    - "No programmatic bypass"
    - "Audit all decisions"
    - "Circuit breaker for runaway systems"
  
  compliance:
    - "ISO 26262 (Safety Critical Systems)"
    - "DO-178C (Software Safety)"

# ============================================================================
# Monitoring & Observability | 監控與可觀測性
# ============================================================================

observability:
  metrics:
    - name: "safety_checks_total"
      type: "counter"
      labels: ["result", "operation_type"]
    - name: "safety_check_duration_seconds"
      type: "histogram"
    - name: "risk_score_distribution"
      type: "histogram"
    - name: "circuit_breakers_active"
      type: "gauge"
    - name: "safety_violations_total"
      type: "counter"
      labels: ["violation_type"]
  
  logs:
    level: "INFO"
    security_events: "WARN"
    all_denials: "WARN"
    structured: true
    retention: "180 days"
  
  alerts:
    - condition: "safety_violations_total > 50/hour"
      severity: "critical"
    - condition: "circuit_breakers_active > 5"
      severity: "high"
    - condition: "safety_check_duration_seconds.p99 > 50ms"
      severity: "warning"

# ============================================================================
# References | 參考
# ============================================================================

references:
  architecture_governance_matrix: "governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md"
  ownership_map: "governance/34-config/ownership-map.yaml#core.safety_mechanisms"
  policies: "governance/23-policies/architecture-rules.yaml"
