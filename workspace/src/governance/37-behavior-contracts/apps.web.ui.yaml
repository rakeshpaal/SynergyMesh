# ═══════════════════════════════════════════════════════════════════════════════
#                    Behavior Contract: apps.web.ui
#                    行為契約：Web 使用者介面
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define expected behaviors for web application user interface
# 用途: 定義 Web 應用程式使用者介面的預期行為
#
# Version: 1.0.0
# Owner: @frontend-team
# Last Updated: 2025-12-07
# ═══════════════════════════════════════════════════════════════════════════════

contract:
  module: "apps.web.ui"
  version: "1.0.0"
  status: "active"
  owner: "@frontend-team"
  
  description: |
    Web UI provides user-facing interface for SynergyMesh platform,
    including dashboards, monitoring, configuration, and administration.
    
    Web UI 為 SynergyMesh 平台提供面向使用者的介面，包括儀表板、監控、配置和管理。

# ============================================================================
# API Contracts | API 契約
# ============================================================================

api:
  base_path: "/api/v1/ui"
  
  endpoints:
    
    # ─────────────────────────────────────────────────────────────────────────
    # User Session Management
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Create Session"
      method: POST
      path: "/sessions"
      
      description: |
        Create authenticated user session.
        創建已驗證的使用者會話。
      
      input_schema:
        type: "object"
        required: ["credentials"]
        properties:
          credentials: { type: "object" }
          remember_me: { type: "boolean" }
      
      output_schema:
        type: "object"
        properties:
          session_id: { type: "string" }
          user: { type: "object" }
          permissions: { type: "array" }
          expires_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "Session ID is secure and unique"
        - "Credentials validated"
        - "Permissions loaded"
      
      performance:
        response_time_p50: "< 100ms"
        response_time_p99: "< 500ms"

    # ─────────────────────────────────────────────────────────────────────────
    # Dashboard Data
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Get Dashboard Data"
      method: GET
      path: "/dashboard"
      
      description: "Retrieve dashboard metrics and status"
      
      query_parameters:
        time_range: { type: "string" }
        modules: { type: "array" }
      
      output_schema:
        type: "object"
        properties:
          metrics: { type: "object" }
          alerts: { type: "array" }
          system_status: { type: "string" }
          last_updated: { type: "string", format: "date-time" }
      
      guarantees:
        - "Data is fresh (< 5s old)"
        - "Aggregated from all modules"
        - "User permissions respected"
      
      performance:
        response_time_p50: "< 150ms"
        response_time_p99: "< 500ms"

    # ─────────────────────────────────────────────────────────────────────────
    # Configuration Update
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Update Configuration"
      method: PUT
      path: "/config/{module}"
      
      description: |
        Update module configuration through UI.
        透過 UI 更新模組配置。
      
      input_schema:
        type: "object"
        required: ["config_changes"]
        properties:
          config_changes: { type: "object" }
          validate_only: { type: "boolean" }
      
      output_schema:
        type: "object"
        properties:
          validation_result: { type: "object" }
          applied: { type: "boolean" }
          requires_restart: { type: "boolean" }
      
      guarantees:
        - "Schema validation before apply"
        - "Backup of previous config"
        - "Rollback available"
        - "Audit log entry created"

    # ─────────────────────────────────────────────────────────────────────────
    # Real-time Notifications
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Subscribe to Notifications"
      method: POST
      path: "/notifications/subscribe"
      
      description: "Subscribe to real-time notifications via WebSocket"
      
      input_schema:
        type: "object"
        properties:
          topics: { type: "array" }
          severity_levels: { type: "array" }
      
      output_schema:
        type: "object"
        properties:
          subscription_id: { type: "string" }
          websocket_url: { type: "string" }
      
      guarantees:
        - "WebSocket connection authenticated"
        - "Topic permissions validated"
        - "Heartbeat mechanism active"

    # ─────────────────────────────────────────────────────────────────────────
    # User Preferences
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Update User Preferences"
      method: PUT
      path: "/preferences"
      
      description: "Update user UI preferences"
      
      input_schema:
        type: "object"
        properties:
          theme: { type: "string" }
          language: { type: "string" }
          dashboard_layout: { type: "object" }
          notification_settings: { type: "object" }
      
      output_schema:
        type: "object"
        properties:
          updated: { type: "boolean" }
          preferences: { type: "object" }
      
      guarantees:
        - "Preferences persisted"
        - "Applied immediately"

    # ─────────────────────────────────────────────────────────────────────────
    # Export Data
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Export Data"
      method: POST
      path: "/export"
      
      description: |
        Export dashboard data and reports in various formats.
        以各種格式導出儀表板數據和報告。
      
      input_schema:
        type: "object"
        required: ["export_type", "format"]
        properties:
          export_type:
            type: "string"
            enum: ["dashboard", "report", "logs", "metrics", "configuration"]
          format:
            type: "string"
            enum: ["json", "csv", "pdf", "xlsx"]
          date_range:
            type: "object"
            properties:
              start: { type: "string", format: "date-time" }
              end: { type: "string", format: "date-time" }
          filters: { type: "object" }
          include_metadata: { type: "boolean", default: true }
      
      output_schema:
        type: "object"
        properties:
          export_id: { type: "string" }
          download_url: { type: "string", format: "uri" }
          file_size_bytes: { type: "integer" }
          format: { type: "string" }
          expires_at: { type: "string", format: "date-time" }
          generated_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "Export includes all requested data"
        - "Format conversion accurate"
        - "Download URL valid for 24 hours"
        - "Large exports handled efficiently"
      
      error_responses:
        - code: 400
          condition: "Invalid date range or filters"
          message: "ERR_INVALID_EXPORT_PARAMS"
        - code: 413
          condition: "Export size exceeds limit"
          message: "ERR_EXPORT_TOO_LARGE"
      
      performance:
        response_time_p50: "< 1s"
        response_time_p99: "< 10s"

# ============================================================================
# Event Contracts | 事件契約
# ============================================================================

events:
  
  - name: "ui.session_created"
    description: "Emitted when user session is created"
    
    payload_schema:
      type: "object"
      properties:
        session_id: { type: "string" }
        user_id: { type: "string" }
        ip_address: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "90 days"
    
    consumers:
      - "services.audit"
      - "services.security"

  - name: "ui.config_changed"
    description: "Emitted when configuration is changed through UI"
    
    payload_schema:
      type: "object"
      properties:
        module: { type: "string" }
        changed_by: { type: "string" }
        changes: { type: "object" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "180 days"
    
    consumers:
      - "services.audit"
      - "core.unified_integration"

  - name: "ui.critical_action"
    description: "Emitted when user performs critical action"
    
    payload_schema:
      type: "object"
      properties:
        action_type: { type: "string" }
        user_id: { type: "string" }
        resource: { type: "string" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "180 days"
    
    consumers:
      - "services.audit"
      - "ops.alerting"

# ============================================================================
# Invariants | 不變條件
# ============================================================================

invariants:
  
  - name: "Authentication Required"
    description: "All UI operations require valid session"
    rule: "forall operation: has_valid_session(operation.user)"
    enforcement: "middleware"
    
  - name: "Permission Enforcement"
    description: "Users can only perform permitted actions"
    rule: "forall action: has_permission(action.user, action.resource, action.operation)"
    enforcement: "authorization-layer"
    
  - name: "Input Validation"
    description: "All user input is validated"
    rule: "forall input: validated(input)"
    enforcement: "pre-condition"
    
  - name: "Audit Trail"
    description: "All critical actions are logged"
    rule: "forall critical_action: exists audit_entry where audit_entry.action = critical_action"
    enforcement: "post-condition"

# ============================================================================
# Failure Modes | 失敗模式
# ============================================================================

failure_modes:
  
  - scenario: "Session Expired"
    triggers:
      - "Session timeout reached"
      - "User inactive"
    recovery:
      - "Redirect to login"
      - "Preserve unsaved work in local storage"
      - "Show session expired message"
    error_code: "SESSION_EXPIRED"
    user_facing: true
    
  - scenario: "API Service Unavailable"
    triggers:
      - "Backend service down"
      - "Network error"
    recovery:
      - "Show offline mode message"
      - "Retry with exponential backoff"
      - "Cache last known state"
    error_code: "SERVICE_UNAVAILABLE"
    user_facing: true
    
  - scenario: "Permission Denied"
    triggers:
      - "User lacks required permission"
    recovery:
      - "Show permission denied message"
      - "Suggest contacting administrator"
      - "Log unauthorized access attempt"
    error_code: "PERMISSION_DENIED"
    user_facing: true

# ============================================================================
# Dependencies | 依賴關係
# ============================================================================

dependencies:
  
  required:
    - module: "services.auth"
      purpose: "Authentication and authorization"
      failure_mode: "critical"
    
    - module: "services.api_gateway"
      purpose: "Backend API access"
      failure_mode: "critical"
  
  optional:
    - module: "services.analytics"
      purpose: "User behavior tracking"
      failure_mode: "log-and-continue"

# ============================================================================
# User Experience Requirements | 使用者體驗要求
# ============================================================================

user_experience:
  performance:
    initial_load: "< 2s"
    page_transition: "< 200ms"
    api_response_feedback: "< 100ms"
  
  accessibility:
    wcag_level: "AA"
    keyboard_navigation: true
    screen_reader_support: true
  
  responsiveness:
    mobile_support: true
    tablet_support: true
    desktop_optimized: true
  
  internationalization:
    supported_languages: ["en", "zh-TW"]
    rtl_support: false

# ============================================================================
# Security Requirements | 安全要求
# ============================================================================

security:
  session_management:
    secure_cookies: true
    httponly: true
    samesite: "strict"
    session_timeout: "30 minutes"
  
  content_security_policy:
    enabled: true
    directives:
      - "default-src 'self'"
      - "script-src 'self'"
      - "style-src 'self' 'unsafe-inline'"
  
  xss_protection: true
  csrf_protection: true

# ============================================================================
# Monitoring & Observability | 監控與可觀測性
# ============================================================================

observability:
  metrics:
    - name: "ui_sessions_active"
      type: "gauge"
    - name: "ui_page_views_total"
      type: "counter"
      labels: ["page", "user_type"]
    - name: "ui_page_load_duration_seconds"
      type: "histogram"
    - name: "ui_api_errors_total"
      type: "counter"
      labels: ["endpoint", "error_type"]
    - name: "ui_config_changes_total"
      type: "counter"
      labels: ["module", "user"]
  
  logs:
    level: "INFO"
    user_actions: "INFO"
    errors: "ERROR"
    structured: true
  
  alerts:
    - condition: "ui_api_errors_total > 100/hour"
      severity: "high"
    - condition: "ui_page_load_duration_seconds.p95 > 3s"
      severity: "warning"
    - condition: "ui_sessions_active = 0 AND expected > 0"
      severity: "critical"

# ============================================================================
# Testing Requirements | 測試要求
# ============================================================================

testing:
  unit_tests:
    coverage_min: 70
    framework: "Jest/Vitest"
  
  integration_tests:
    required:
      - "Authentication flow"
      - "Dashboard data loading"
      - "Configuration updates"
  
  e2e_tests:
    required:
      - "User login and logout"
      - "Dashboard navigation"
      - "Critical user workflows"
    framework: "Playwright/Cypress"
  
  accessibility_tests:
    automated: true
    manual_review: true

# ============================================================================
# References | 參考
# ============================================================================

references:
  ownership_map: "governance/34-config/ownership-map.yaml#apps.web.ui"
  architecture_governance_matrix: "governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md"
  design_system: "docs/design-system.md"
