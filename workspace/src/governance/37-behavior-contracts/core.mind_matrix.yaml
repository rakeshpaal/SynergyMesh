# ═══════════════════════════════════════════════════════════════════════════════
#                    Behavior Contract: core.mind_matrix
#                    行為契約：思維矩陣 AI 核心
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Define expected behaviors for AI cognitive processing core
# 用途: 定義 AI 認知處理核心的預期行為
#
# Version: 1.0.0
# Owner: @ai-research-team
# Last Updated: 2025-12-07
# ═══════════════════════════════════════════════════════════════════════════════

contract:
  module: "core.mind_matrix"
  version: "1.0.0"
  status: "active"
  owner: "@ai-research-team"
  
  description: |
    Mind Matrix is the AI cognitive processing core providing decision making,
    pattern recognition, learning, and reasoning capabilities for autonomous systems.
    
    思維矩陣是 AI 認知處理核心，為自主系統提供決策制定、模式識別、學習和推理能力。

# ============================================================================
# API Contracts | API 契約
# ============================================================================

api:
  base_path: "/api/v1/mind-matrix"
  
  endpoints:
    
    # ─────────────────────────────────────────────────────────────────────────
    # Decision Making
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Make Decision"
      method: POST
      path: "/decisions"
      
      description: |
        Request AI decision making based on context and constraints.
        根據上下文和約束請求 AI 決策。
      
      input_schema:
        type: "object"
        required: ["decision_type", "context"]
        properties:
          decision_type:
            type: "string"
            enum: ["classification", "optimization", "prediction", "recommendation"]
          context:
            type: "object"
            properties:
              data: { type: "object" }
              constraints: { type: "array" }
              preferences: { type: "object" }
          confidence_threshold: { type: "number", minimum: 0, maximum: 1 }
          explain: { type: "boolean", default: false }
      
      output_schema:
        type: "object"
        properties:
          decision_id: { type: "string" }
          decision: { type: "object" }
          confidence: { type: "number" }
          reasoning: { type: "array" }
          alternatives: { type: "array" }
          timestamp: { type: "string", format: "date-time" }
      
      guarantees:
        - "Confidence score is always provided"
        - "Reasoning is explainable when requested"
        - "Decisions respect safety constraints"
        - "Response time bounded"
      
      error_responses:
        - code: 400
          condition: "Invalid context or decision type"
          message: "ERR_INVALID_DECISION_REQUEST"
        - code: 422
          condition: "Confidence below threshold"
          message: "ERR_LOW_CONFIDENCE"
        - code: 503
          condition: "AI model unavailable"
          message: "ERR_MODEL_UNAVAILABLE"
      
      performance:
        response_time_p50: "< 200ms"
        response_time_p99: "< 1s"

    # ─────────────────────────────────────────────────────────────────────────
    # Pattern Recognition
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Recognize Pattern"
      method: POST
      path: "/patterns/recognize"
      
      description: |
        Identify patterns in data using AI models.
        使用 AI 模型識別數據中的模式。
      
      input_schema:
        type: "object"
        required: ["data"]
        properties:
          data: { type: "object" }
          pattern_types: { type: "array" }
          sensitivity: { type: "number", minimum: 0, maximum: 1 }
      
      output_schema:
        type: "object"
        properties:
          patterns: { type: "array" }
          confidence_scores: { type: "object" }
          anomalies_detected: { type: "array" }
      
      guarantees:
        - "All pattern types checked"
        - "Anomalies flagged if detected"
        - "Confidence scores for each pattern"

    # ─────────────────────────────────────────────────────────────────────────
    # Learning Update
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Update Learning"
      method: POST
      path: "/learning/update"
      
      description: |
        Update AI models with new training data or feedback.
        使用新訓練數據或反饋更新 AI 模型。
      
      input_schema:
        type: "object"
        required: ["model_id", "feedback"]
        properties:
          model_id: { type: "string" }
          feedback:
            type: "object"
            properties:
              decision_id: { type: "string" }
              actual_outcome: { type: "object" }
              correctness: { type: "boolean" }
      
      output_schema:
        type: "object"
        properties:
          update_id: { type: "string" }
          model_version: { type: "string" }
          improvement_metrics: { type: "object" }
      
      guarantees:
        - "Model version tracked"
        - "Updates are atomic"
        - "Rollback capability maintained"

    # ─────────────────────────────────────────────────────────────────────────
    # Cognitive State
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Get Cognitive State"
      method: GET
      path: "/state"
      
      description: "Retrieve current cognitive processing state"
      
      output_schema:
        type: "object"
        properties:
          active_models: { type: "array" }
          processing_load: { type: "number" }
          learning_rate: { type: "number" }
          knowledge_version: { type: "string" }
      
      guarantees:
        - "Real-time state reflection"
        - "Performance metrics included"

    # ─────────────────────────────────────────────────────────────────────────
    # Model Inference
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Run Inference"
      method: POST
      path: "/inference"
      
      description: |
        Run inference using trained AI models.
        使用訓練好的 AI 模型運行推理。
      
      input_schema:
        type: "object"
        required: ["model_id", "input_data"]
        properties:
          model_id: { type: "string" }
          input_data: { type: "object" }
          batch_size: { type: "integer", minimum: 1, maximum: 100, default: 1 }
          return_embeddings: { type: "boolean", default: false }
      
      output_schema:
        type: "object"
        properties:
          inference_id: { type: "string" }
          predictions: { type: "array" }
          probabilities: { type: "array" }
          embeddings: { type: "array" }
          inference_time_ms: { type: "number" }
          model_version: { type: "string" }
      
      guarantees:
        - "Model version logged"
        - "Inference is deterministic with same input"
        - "Batching optimizes throughput"
      
      error_responses:
        - code: 404
          condition: "Model not found"
          message: "ERR_MODEL_NOT_FOUND"
        - code: 413
          condition: "Batch size exceeds limit"
          message: "ERR_BATCH_TOO_LARGE"
      
      performance:
        response_time_p50: "< 150ms"
        response_time_p99: "< 800ms"
        max_batch_size: 100

    # ─────────────────────────────────────────────────────────────────────────
    # Knowledge Query
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Query Knowledge Base"
      method: POST
      path: "/knowledge/query"
      
      description: |
        Query the AI knowledge base for information retrieval.
        查詢 AI 知識庫以檢索信息。
      
      input_schema:
        type: "object"
        required: ["query"]
        properties:
          query:
            type: "string"
            description: "Natural language query"
          context: { type: "object" }
          max_results: { type: "integer", minimum: 1, maximum: 50, default: 10 }
          similarity_threshold: { type: "number", minimum: 0, maximum: 1, default: 0.7 }
          include_sources: { type: "boolean", default: true }
      
      output_schema:
        type: "object"
        properties:
          query_id: { type: "string" }
          results:
            type: "array"
            items:
              type: "object"
              properties:
                content: { type: "string" }
                similarity_score: { type: "number" }
                source: { type: "string" }
                metadata: { type: "object" }
          total_results: { type: "integer" }
          query_time_ms: { type: "number" }
      
      guarantees:
        - "Results ordered by similarity score"
        - "Threshold filtering applied"
        - "Source attribution when available"
        - "Query embedding cached"
      
      performance:
        response_time_p50: "< 100ms"
        response_time_p99: "< 500ms"

    # ─────────────────────────────────────────────────────────────────────────
    # Model Evaluation
    # ─────────────────────────────────────────────────────────────────────────
    - name: "Evaluate Model"
      method: POST
      path: "/models/{model_id}/evaluate"
      
      description: |
        Evaluate model performance on test dataset.
        在測試數據集上評估模型性能。
      
      input_schema:
        type: "object"
        required: ["test_data"]
        properties:
          test_data:
            type: "object"
            properties:
              inputs: { type: "array" }
              expected_outputs: { type: "array" }
          metrics:
            type: "array"
            items: { type: "string", enum: ["accuracy", "precision", "recall", "f1", "auc-roc"] }
            default: ["accuracy", "precision", "recall"]
      
      output_schema:
        type: "object"
        properties:
          evaluation_id: { type: "string" }
          model_id: { type: "string" }
          model_version: { type: "string" }
          metrics:
            type: "object"
            properties:
              accuracy: { type: "number" }
              precision: { type: "number" }
              recall: { type: "number" }
              f1_score: { type: "number" }
              auc_roc: { type: "number" }
          confusion_matrix: { type: "array" }
          test_samples: { type: "integer" }
          evaluation_time_seconds: { type: "number" }
          evaluated_at: { type: "string", format: "date-time" }
      
      guarantees:
        - "All requested metrics calculated"
        - "Test data not leaked into training"
        - "Evaluation is reproducible"
        - "Results logged for tracking"
      
      error_responses:
        - code: 400
          condition: "Test data format invalid"
          message: "ERR_INVALID_TEST_DATA"
        - code: 404
          condition: "Model not found"
          message: "ERR_MODEL_NOT_FOUND"
      
      performance:
        response_time_p99: "< 30s"

# ============================================================================
# Event Contracts | 事件契約
# ============================================================================

events:
  
  - name: "mind_matrix.decision_made"
    description: "Emitted when AI makes a decision"
    
    payload_schema:
      type: "object"
      properties:
        decision_id: { type: "string" }
        decision_type: { type: "string" }
        confidence: { type: "number" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "30 days"
    
    consumers:
      - "services.audit"
      - "automation.monitoring"

  - name: "mind_matrix.low_confidence"
    description: "Emitted when decision confidence is below threshold"
    
    payload_schema:
      type: "object"
      properties:
        decision_id: { type: "string" }
        confidence: { type: "number" }
        threshold: { type: "number" }
        requires_human_review: { type: "boolean" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "90 days"
    
    consumers:
      - "ops.alerting"
      - "services.human_review"

  - name: "mind_matrix.model_updated"
    description: "Emitted when AI model is updated"
    
    payload_schema:
      type: "object"
      properties:
        model_id: { type: "string" }
        old_version: { type: "string" }
        new_version: { type: "string" }
        improvement_metrics: { type: "object" }
        timestamp: { type: "string", format: "date-time" }
    
    delivery_guarantee: "at-least-once"
    retention: "180 days"
    
    consumers:
      - "services.audit"
      - "ops.ml_ops"

# ============================================================================
# Invariants | 不變條件
# ============================================================================

invariants:
  
  - name: "Explainable Decisions"
    description: "All decisions must be explainable"
    rule: "forall decision: exists reasoning where reasoning.explains(decision)"
    enforcement: "application-logic"
    
  - name: "Confidence Bounds"
    description: "Confidence scores are between 0 and 1"
    rule: "forall decision: 0 <= decision.confidence <= 1"
    enforcement: "pre-condition"
    
  - name: "Safety Constraints Respected"
    description: "Decisions never violate safety constraints"
    rule: "forall decision: satisfies(decision, safety_constraints)"
    enforcement: "pre-condition"
    
  - name: "Model Versioning"
    description: "All model changes are versioned"
    rule: "forall update: update.old_version != update.new_version"
    enforcement: "application-logic"

# ============================================================================
# Failure Modes | 失敗模式
# ============================================================================

failure_modes:
  
  - scenario: "Model Unavailable"
    triggers:
      - "Model loading failure"
      - "Resource exhaustion"
    recovery:
      - "Fallback to previous model version"
      - "Return cached decision if available"
      - "Alert ML ops team"
    error_code: "ERR_MODEL_UNAVAILABLE"
    degraded_mode: true
    
  - scenario: "Low Confidence Decision"
    triggers:
      - "Confidence below threshold"
      - "Ambiguous input"
    recovery:
      - "Return alternatives"
      - "Flag for human review"
      - "Log for model improvement"
    error_code: "WARN_LOW_CONFIDENCE"
    
  - scenario: "Model Drift Detected"
    triggers:
      - "Accuracy degradation"
      - "Distribution shift"
    recovery:
      - "Trigger retraining"
      - "Alert ML ops"
      - "Increase monitoring"
    error_code: "WARN_MODEL_DRIFT"

# ============================================================================
# Dependencies | 依賴關係
# ============================================================================

dependencies:
  
  required:
    - module: "infrastructure.ml_platform"
      purpose: "Model hosting and inference"
      failure_mode: "critical"
    
    - module: "core.safety_mechanisms"
      purpose: "Decision validation"
      failure_mode: "critical"
  
  optional:
    - module: "services.audit"
      purpose: "Decision logging"
      failure_mode: "log-and-continue"

# ============================================================================
# Performance Characteristics | 性能特徵
# ============================================================================

performance:
  inference:
    p50: "< 200ms"
    p99: "< 1s"
    throughput: "> 1000 decisions/s"
    
  learning_update:
    p50: "< 500ms"
    p99: "< 2s"

# ============================================================================
# Monitoring & Observability | 監控與可觀測性
# ============================================================================

observability:
  metrics:
    - name: "decisions_total"
      type: "counter"
      labels: ["decision_type", "confidence_level"]
    - name: "decision_latency_seconds"
      type: "histogram"
    - name: "model_confidence_score"
      type: "histogram"
    - name: "low_confidence_decisions"
      type: "counter"
    - name: "model_updates_total"
      type: "counter"
  
  alerts:
    - condition: "low_confidence_decisions > 20%"
      severity: "warning"
    - condition: "decision_latency_seconds.p99 > 2s"
      severity: "warning"
    - condition: "model_unavailable"
      severity: "critical"

# ============================================================================
# AI/ML Specific Requirements | AI/ML 特定要求
# ============================================================================

ml_governance:
  model_versioning: "semantic versioning"
  explainability: "LIME or SHAP"
  fairness_monitoring: true
  bias_detection: true
  
  retraining_policy:
    frequency: "weekly"
    trigger_conditions:
      - "accuracy drop > 5%"
      - "new data volume > threshold"

# ============================================================================
# References | 參考
# ============================================================================

references:
  ownership_map: "governance/34-config/ownership-map.yaml#core.mind_matrix"
  architecture_governance_matrix: "governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md"
