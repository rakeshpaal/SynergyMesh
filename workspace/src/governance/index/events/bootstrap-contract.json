{
  "$schema": "../schemas/bootstrap-contract.schema.json",
  "version": "1.0.0",
  "timestamp": "2025-12-12T00:00:00Z",
  "metadata": {
    "name": "Agent Bootstrap Contract",
    "description": "入口協定 - 強制所有代理讀取事件上下文",
    "purpose": "解決代理失憶問題，確保每個代理啟動時都有完整記憶",
    "status": "production",
    "enforcement": "mandatory"
  },
  "entry_requirements": {
    "description": "代理啟動前必須滿足的條件",
    "must_read": [
      {
        "resource": "events/registry.json",
        "purpose": "獲取事件索引",
        "required": true
      },
      {
        "resource": "events/current-session.json",
        "purpose": "獲取當前會話上下文",
        "required": true
      },
      {
        "resource": "events/vector-index.json",
        "purpose": "獲取事件向量以便檢索",
        "required": true
      },
      {
        "resource": "../governance-index.json",
        "purpose": "獲取治理系統配置",
        "required": true
      }
    ],
    "must_write": [
      {
        "resource": "events/current-session.json",
        "purpose": "記錄代理產生的事件",
        "required": true
      }
    ]
  },
  "validation_rules": [
    {
      "id": "events-loaded",
      "description": "驗證事件已載入",
      "check": "context.events !== undefined",
      "severity": "error",
      "block_execution": true
    },
    {
      "id": "session-active",
      "description": "驗證會話上下文存在",
      "check": "context.session_id !== undefined",
      "severity": "error",
      "block_execution": true
    },
    {
      "id": "registry-valid",
      "description": "驗證註冊表可讀",
      "check": "context.registry.status === 'production'",
      "severity": "error",
      "block_execution": true
    }
  ],
  "ci_gate": {
    "enabled": true,
    "check_name": "bootstrap-contract-validation",
    "on_failure": "block",
    "error_template": "Agent {agent_id} failed bootstrap contract: {reason}"
  },
  "bootstrap_sequence": {
    "description": "代理啟動順序",
    "steps": [
      {
        "step": 1,
        "action": "load_registry",
        "resource": "events/registry.json",
        "timeout": "5s"
      },
      {
        "step": 2,
        "action": "load_session",
        "resource": "events/current-session.json",
        "timeout": "5s"
      },
      {
        "step": 3,
        "action": "load_vectors",
        "resource": "events/vector-index.json",
        "timeout": "10s"
      },
      {
        "step": 4,
        "action": "validate_context",
        "validation": "validation_rules",
        "timeout": "2s"
      },
      {
        "step": 5,
        "action": "inject_context",
        "target": "agent_memory",
        "timeout": "3s"
      },
      {
        "step": 6,
        "action": "register_agent",
        "event": "agent.registered",
        "timeout": "2s"
      }
    ],
    "total_timeout": "30s",
    "on_timeout": "abort"
  },
  "context_injection": {
    "description": "自動注入到代理的上下文",
    "inject": {
      "recent_events": {
        "source": "events/current-session.json",
        "field": "events",
        "limit": 50
      },
      "causal_chain": {
        "source": "events/current-session.json",
        "field": "context.causal_chain"
      },
      "related_vectors": {
        "source": "events/vector-index.json",
        "field": "active_vectors",
        "limit": 20
      }
    }
  },
  "event_writing_contract": {
    "description": "代理必須遵守的事件寫入規則",
    "rules": [
      {
        "rule": "all_actions_logged",
        "description": "所有操作必須產生事件",
        "required": true
      },
      {
        "rule": "causal_parent_required",
        "description": "每個事件必須指定因果父事件",
        "required": true,
        "exception": "session_first_event"
      },
      {
        "rule": "close_loop_on_complete",
        "description": "完成任務後必須關閉事件迴圈",
        "required": true
      }
    ]
  }
}
