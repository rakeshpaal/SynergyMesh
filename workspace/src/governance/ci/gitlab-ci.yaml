# =============================================================================
# SynergyMesh Governance - GitLab CI/CD Pipeline
# Machine-First Governance Framework
# =============================================================================
# Execution Standard: INSTANT (< 3 minutes)
# =============================================================================

variables:
  OPA_VERSION: "0.60.0"
  PYTHON_VERSION: "3.11"

stages:
  - validate
  - lint
  - test
  - audit
  - deploy

# ===========================================================================
# STAGE 1: VALIDATE
# ===========================================================================
validate:yaml:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  script:
    - pip install pyyaml
    - |
      echo "Validating YAML files..."
      find governance -name "*.yaml" -o -name "*.yml" | while read file; do
        python -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
      done
      echo "All YAML files are valid"
  rules:
    - changes:
        - governance/**/*

validate:json:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  script:
    - |
      echo "Validating JSON files..."
      find governance -name "*.json" | while read file; do
        python -c "import json; json.load(open('$file'))" || exit 1
      done
      echo "All JSON files are valid"
  rules:
    - changes:
        - governance/**/*

validate:schema:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  script:
    - pip install pyyaml jsonschema
    - |
      echo "Validating schemas..."
      python -c "
      import json
      from jsonschema import Draft7Validator

      for schema_file in ['governance/schemas/governance-schema.json',
                          'governance/schemas/dimension-schema.json',
                          'governance/schemas/audit-log-schema.json']:
          with open(schema_file) as f:
              schema = json.load(f)
          errors = list(Draft7Validator.check_schema(schema))
          if errors:
              print(f'Invalid schema: {schema_file}')
              exit(1)
      print('All schemas are valid')
      "
  rules:
    - changes:
        - governance/**/*

# ===========================================================================
# STAGE 2: LINT
# ===========================================================================
lint:policies:
  stage: lint
  image: openpolicyagent/opa:${OPA_VERSION}
  script:
    - |
      echo "Linting OPA policies..."
      find governance -name "*.rego" | while read file; do
        opa fmt --diff "$file"
        opa check "$file" || exit 1
      done
      echo "All policies pass lint checks"
  rules:
    - changes:
        - governance/**/*.rego

# ===========================================================================
# STAGE 3: TEST
# ===========================================================================
test:policies:
  stage: test
  image: openpolicyagent/opa:${OPA_VERSION}
  script:
    - |
      echo "Running policy tests..."
      opa test governance/ -v --coverage --format=json > coverage.json || true
      cat coverage.json
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.json
    paths:
      - coverage.json
    expire_in: 1 week
  rules:
    - changes:
        - governance/**/*.rego

test:dependencies:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  script:
    - pip install pyyaml
    - |
      python -c "
      import yaml
      import os

      dimensions = {}
      for root, dirs, files in os.walk('governance/dimensions'):
          if 'dimension.yaml' in files:
              path = os.path.join(root, 'dimension.yaml')
              with open(path) as f:
                  dim = yaml.safe_load(f)
                  dim_id = dim['metadata']['id']
                  dimensions[dim_id] = dim

      errors = []
      for dim_id, dim in dimensions.items():
          deps = dim.get('spec', {}).get('dependencies', {}).get('required', [])
          for dep in deps:
              if dep not in dimensions:
                  errors.append(f'{dim_id} depends on missing: {dep}')

      if errors:
          for e in errors:
              print(f'ERROR: {e}')
          exit(1)
      print(f'Dependencies satisfied for {len(dimensions)} dimensions')
      "
  rules:
    - changes:
        - governance/**/*

# ===========================================================================
# STAGE 4: AUDIT
# ===========================================================================
audit:report:
  stage: audit
  image: python:${PYTHON_VERSION}-slim
  script:
    - pip install pyyaml
    - |
      python -c "
      import yaml
      import json
      import os
      from datetime import datetime

      report = {
          'generated_at': datetime.now().isoformat(),
          'ci_job_id': os.environ.get('CI_JOB_ID', 'local'),
          'commit': os.environ.get('CI_COMMIT_SHA', 'unknown'),
          'dimensions': {'total': 0, 'by_category': {}},
          'policies': {'total': 0},
          'schemas': {'total': 0}
      }

      for root, dirs, files in os.walk('governance/dimensions'):
          if 'dimension.yaml' in files:
              with open(os.path.join(root, 'dimension.yaml')) as f:
                  dim = yaml.safe_load(f)
                  report['dimensions']['total'] += 1
                  cat = dim['metadata'].get('category', 'unknown')
                  report['dimensions']['by_category'][cat] = report['dimensions']['by_category'].get(cat, 0) + 1

      for root, dirs, files in os.walk('governance'):
          for f in files:
              if f.endswith('.rego'):
                  report['policies']['total'] += 1
              if f.endswith('.json') and 'schema' in f.lower():
                  report['schemas']['total'] += 1

      with open('audit-report.json', 'w') as f:
          json.dump(report, f, indent=2)

      print(json.dumps(report, indent=2))
      "
  artifacts:
    paths:
      - audit-report.json
    expire_in: 1 month
  rules:
    - changes:
        - governance/**/*

# ===========================================================================
# STAGE 5: DEPLOY
# ===========================================================================
deploy:production:
  stage: deploy
  image: alpine:latest
  script:
    - |
      echo "Deploying governance framework..."
      echo "Commit: ${CI_COMMIT_SHA}"
      echo "Branch: ${CI_COMMIT_REF_NAME}"
      echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
      echo "Deployment successful!"
  environment:
    name: production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - governance/**/*
