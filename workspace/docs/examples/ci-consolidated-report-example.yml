---
# Example CI Workflow with Consolidated Reporting
# This is a template showing how to implement consolidated CI reports
# Copy and modify this file to create your own CI workflows

name: Example CI with Consolidated Report

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Job 1: Build
  build:
    name: ðŸ—ï¸ å»ºç½®
    runs-on: ubuntu-latest
    outputs:
      summary: ${{ steps.summary.outputs.text }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        id: install
        continue-on-error: true
        run: npm ci
      
      - name: Build project
        id: build
        continue-on-error: true
        run: npm run build
      
      - name: Create summary
        id: summary
        if: always()
        run: |
          STATUS="success"
          MESSAGE="å»ºç½®: é€šéŽ"
          
          if [ "${{ steps.install.outcome }}" != "success" ]; then
            STATUS="failure"
            MESSAGE="ä¾è³´å®‰è£å¤±æ•—"
          elif [ "${{ steps.build.outcome }}" != "success" ]; then
            STATUS="failure"
            MESSAGE="å»ºç½®å¤±æ•—"
          fi
          
          echo "text={\"status\":\"$STATUS\",\"message\":\"$MESSAGE\"}" >> $GITHUB_OUTPUT
  
  # Job 2: Test
  test:
    name: ðŸ§ª æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: build
    outputs:
      summary: ${{ steps.summary.outputs.text }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        id: test
        continue-on-error: true
        run: npm test
      
      - name: Create summary
        id: summary
        if: always()
        run: |
          STATUS="success"
          MESSAGE="æ¸¬è©¦: é€šéŽ"
          
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            STATUS="failure"
            MESSAGE="æ¸¬è©¦å¤±æ•—"
          fi
          
          echo "text={\"status\":\"$STATUS\",\"message\":\"$MESSAGE\"}" >> $GITHUB_OUTPUT
  
  # Job 3: Lint
  lint:
    name: ðŸ” ä»£ç¢¼æª¢æŸ¥
    runs-on: ubuntu-latest
    needs: build
    outputs:
      summary: ${{ steps.summary.outputs.text }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        id: lint
        continue-on-error: true
        run: npm run lint
      
      - name: Create summary
        id: summary
        if: always()
        run: |
          STATUS="success"
          MESSAGE="Lint: é€šéŽ"
          
          if [ "${{ steps.lint.outcome }}" != "success" ]; then
            STATUS="warning"
            MESSAGE="Lint æœ‰è­¦å‘Š"
          fi
          
          echo "text={\"status\":\"$STATUS\",\"message\":\"$MESSAGE\"}" >> $GITHUB_OUTPUT
  
  # Final Job: Consolidated Report
  report:
    name: ðŸ“Š æ•´åˆå ±å‘Š
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Prepare job summaries
        id: prepare
        run: |
          # Build JSON with all job summaries
          cat > job-summaries.json <<EOF
          {
            "build": ${{ needs.build.outputs.summary || '{"status":"unknown","message":"ç„¡æ‘˜è¦"}' }},
            "test": ${{ needs.test.outputs.summary || '{"status":"unknown","message":"ç„¡æ‘˜è¦"}' }},
            "lint": ${{ needs.lint.outputs.summary || '{"status":"unknown","message":"ç„¡æ‘˜è¦"}' }}
          }
          EOF
          
          cat job-summaries.json
          
          # Determine overall status
          OVERALL_STATUS="success"
          if [ "${{ needs.build.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ] || \
             [ "${{ needs.lint.result }}" == "failure" ]; then
            OVERALL_STATUS="failure"
          elif [ "${{ needs.lint.result }}" == "success" ] && \
               [ "${{ needs.test.result }}" == "success" ] && \
               [ "${{ needs.build.result }}" == "success" ]; then
            OVERALL_STATUS="success"
          else
            OVERALL_STATUS="warning"
          fi
          
          echo "overall-status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "job-summaries=$(cat job-summaries.json | jq -c .)" >> $GITHUB_OUTPUT
      
      - name: Call consolidated report workflow
        if: github.event_name == 'pull_request'
        uses: ./.github/workflows/ci-consolidated-report.yml
        with:
          ci-name: 'Example CI Pipeline'
          job-summaries: ${{ steps.prepare.outputs.job-summaries }}
          workflow-run-id: ${{ github.run_id }}
          commit-sha: ${{ github.sha }}
          overall-status: ${{ steps.prepare.outputs.overall-status }}
          pr-number: ${{ github.event.pull_request.number }}
        secrets:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "## ðŸ“Š CI åŸ·è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint**: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status**: ${{ steps.prepare.outputs.overall-status }}" >> $GITHUB_STEP_SUMMARY
