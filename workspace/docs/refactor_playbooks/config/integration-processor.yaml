# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    Integration Processor - é›†æˆè™•ç†å™¨é…ç½®
#                    å­ç›®éŒ„æœ€ä½³åŒ–èˆ‡åŸ·è¡Œå¼•æ“
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Version: 1.0.0
# Updated: 2025-12-08
# Purpose: å®šç¾©é›†æˆéšæ®µçš„æœ€ä½³åŒ–æ±ºç­–èˆ‡åŸ·è¡Œé‚è¼¯
#
# åŠŸèƒ½ï¼š
# 1. é›†æˆåˆ°å­ç›®éŒ„æ™‚çš„æœ€ä½³åŒ–æ±ºç­–
# 2. ç”Ÿæˆæ•´å€‹å­ç›®éŒ„çš„ç›®éŒ„åœ–è­œ
# 3. æ‰¹é‡åŸ·è¡Œæ›´æ–°
# 4. é©—è­‰é›†æˆçµæœ
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

version: "1.0.0"
name: "IntegrationProcessor"
description: "é›†æˆè™•ç†å™¨ - æœ€ä½³åŒ–å­ç›®éŒ„çµæ§‹ä¸¦åŸ·è¡Œé›†æˆ"

# ============================================================================
# å­ç›®éŒ„æœ€ä½³åŒ–å¼•æ“
# ============================================================================
directory_optimizer:
  name: "DirectoryOptimizer"
  description: "åˆ†æä¸¦æœ€ä½³åŒ–ç›®æ¨™å­ç›®éŒ„çš„çµæ§‹"

  # æœ€ä½³åŒ–ç›®æ¨™
  optimization_goals:
    - goal: "structural_clarity"
      description: "çµæ§‹æ¸…æ™°åº¦"
      weight: 0.30
      metrics:
        - "ç›®éŒ„æ·±åº¦ â‰¤ 4 å±¤"
        - "æ¯ç›®éŒ„æª”æ¡ˆæ•¸ â‰¤ 15"
        - "å‘½åä¸€è‡´æ€§ > 90%"

    - goal: "functional_cohesion"
      description: "åŠŸèƒ½å…§èšæ€§"
      weight: 0.25
      metrics:
        - "ç›¸é—œåŠŸèƒ½åœ¨åŒä¸€ç›®éŒ„"
        - "ç„¡è·¨ç›®éŒ„åŠŸèƒ½åˆ†æ•£"
        - "ä»‹é¢é›†ä¸­å®šç¾©"

    - goal: "dependency_minimization"
      description: "ä¾è³´æœ€å°åŒ–"
      weight: 0.25
      metrics:
        - "ç„¡å¾ªç’°ä¾è³´"
        - "ä¾è³´æ–¹å‘æ­£ç¢º"
        - "å¤–éƒ¨ä¾è³´é›†ä¸­"

    - goal: "naming_consistency"
      description: "å‘½åä¸€è‡´æ€§"
      weight: 0.20
      metrics:
        - "éµå¾ªå°ˆæ¡ˆå‘½åè¦ç¯„"
        - "ç„¡æ··ç”¨å‘½åé¢¨æ ¼"
        - "æè¿°æ€§å‘½å"

  # æœ€ä½³åŒ–è¦å‰‡
  optimization_rules:
    # ç›®éŒ„å±¤ç´šè¦å‰‡
    depth_rules:
      max_depth: 4
      recommended_depth: 3
      actions_when_exceeded:
        - "flatten_structure"
        - "create_index_files"
        - "split_into_siblings"

    # æª”æ¡ˆåˆ†çµ„è¦å‰‡
    grouping_rules:
      max_files_per_directory: 15
      min_files_per_directory: 2
      grouping_strategies:
        - name: "by_type"
          description: "æŒ‰é¡å‹åˆ†çµ„"
          patterns:
            interfaces: ["*interface*", "*contract*", "*api*"]
            implementations: ["*impl*", "*service*", "*handler*"]
            configs: ["*.yaml", "*.yml", "*.json", "*.config.*"]
            tests: ["*test*", "*spec*", "__tests__"]

        - name: "by_feature"
          description: "æŒ‰åŠŸèƒ½åˆ†çµ„"
          patterns:
            auth: ["*auth*", "*login*", "*session*"]
            data: ["*data*", "*model*", "*schema*"]
            ui: ["*component*", "*view*", "*page*"]

    # å‘½åè¦å‰‡
    naming_rules:
      directory_naming:
        style: "kebab-case"
        allowed_patterns:
          - "^[a-z][a-z0-9-]*$"
          - "^[a-z][a-z0-9_]*$"  # å…è¨±åº•ç·šï¼ˆPython æ…£ä¾‹ï¼‰
        forbidden_patterns:
          - "^[A-Z]"  # ä¸å…è¨±å¤§å¯«é–‹é ­
          - "\\s"     # ä¸å…è¨±ç©ºæ ¼

      file_naming:
        styles:
          markdown: "UPPER_SNAKE_CASE.md"
          yaml: "kebab-case.yaml"
          python: "snake_case.py"
          typescript: "camelCase.ts"

# ============================================================================
# ç›®éŒ„åœ–è­œç”Ÿæˆå™¨
# ============================================================================
directory_mapper:
  name: "DirectoryMapper"
  description: "ç”Ÿæˆç›®éŒ„çµæ§‹åœ–è­œèˆ‡å±¬æ€§æ˜ å°„"

  # åœ–è­œé¡å‹
  map_types:
    # çµæ§‹åœ–è­œ (ASCII)
    structure_ascii:
      format: "ascii_tree"
      include:
        - "directories"
        - "files"
        - "annotations"
      example: |
        docs/refactor_playbooks/
        â”œâ”€â”€ 01_deconstruction/           # è§£æ§‹å±¤
        â”‚   â”œâ”€â”€ README.md
        â”‚   â”œâ”€â”€ hlp-executor-core/       # ğŸ†• HLP çµ±ä¸€ç›®éŒ„
        â”‚   â”‚   â””â”€â”€ deconstruction.md
        â”‚   â””â”€â”€ kg-builder/              # ğŸ†• kg-builder çµ±ä¸€ç›®éŒ„
        â”‚       â””â”€â”€ deconstruction.md
        â””â”€â”€ ...

    # çµæ§‹åœ–è­œ (Mermaid)
    structure_mermaid:
      format: "mermaid_flowchart"
      template: |
        ```mermaid
        graph TD
            subgraph refactor_playbooks
                A[01_deconstruction] --> B[02_integration]
                B --> C[03_refactor]
                D[_legacy_scratch] -.-> A
            end
        ```

    # å±¬æ€§åœ–è­œ
    attribute_map:
      format: "yaml"
      attributes:
        - "path"
        - "type"          # directory | file
        - "category"      # core | config | doc | template
        - "status"        # active | deprecated | new | modified
        - "owner"         # team/person responsible
        - "dependencies"  # list of dependent paths

  # åœ–è­œç”Ÿæˆé…ç½®
  generation_config:
    include_hidden: false
    max_depth: 5
    file_count_threshold: 100  # è¶…éæ­¤æ•¸é‡ä½¿ç”¨æ‘˜è¦
    annotation_rules:
      - pattern: "README.md"
        annotation: "# å…¥å£èªªæ˜"
      - pattern: "*.yaml"
        annotation: "# é…ç½®"
      - pattern: "*_test.*"
        annotation: "# æ¸¬è©¦"

# ============================================================================
# é›†æˆåŸ·è¡Œå¼•æ“
# ============================================================================
integration_executor:
  name: "IntegrationExecutor"
  description: "åŸ·è¡Œé›†æˆæ“ä½œçš„å¼•æ“"

  # åŸ·è¡Œæ¨¡å¼
  execution_modes:
    dry_run:
      description: "æ¨¡æ“¬åŸ·è¡Œï¼Œåªç”Ÿæˆå ±å‘Š"
      writes_files: false
      generates_report: true

    interactive:
      description: "äº’å‹•æ¨¡å¼ï¼Œæ¯æ­¥ç¢ºèª"
      writes_files: true
      requires_confirmation: true

    batch:
      description: "æ‰¹é‡åŸ·è¡Œï¼Œè‡ªå‹•è™•ç†"
      writes_files: true
      requires_confirmation: false
      safety_checks: true

  # æ“ä½œé¡å‹
  operations:
    # å‰µå»ºç›®éŒ„
    create_directory:
      name: "å‰µå»ºç›®éŒ„"
      command: "mkdir -p {path}"
      validation:
        pre: "ç›®éŒ„ä¸å­˜åœ¨"
        post: "ç›®éŒ„å·²å‰µå»º"
      rollback: "rmdir {path}"

    # ç§»å‹•æª”æ¡ˆ
    move_file:
      name: "ç§»å‹•æª”æ¡ˆ"
      command: "mv {source} {target}"
      validation:
        pre: "ä¾†æºå­˜åœ¨ï¼Œç›®æ¨™ä¸å­˜åœ¨"
        post: "ç›®æ¨™å­˜åœ¨ï¼Œä¾†æºä¸å­˜åœ¨"
      rollback: "mv {target} {source}"
      requires_backup: true

    # è¤‡è£½æª”æ¡ˆ
    copy_file:
      name: "è¤‡è£½æª”æ¡ˆ"
      command: "cp {source} {target}"
      validation:
        pre: "ä¾†æºå­˜åœ¨"
        post: "ç›®æ¨™å­˜åœ¨"
      rollback: "rm {target}"

    # åˆä½µæª”æ¡ˆ
    merge_file:
      name: "åˆä½µæª”æ¡ˆ"
      command: "custom_merge"
      validation:
        pre: "å…©å€‹ä¾†æºéƒ½å­˜åœ¨"
        post: "åˆä½µå¾Œæª”æ¡ˆæœ‰æ•ˆ"
      rollback: "restore_from_backup"
      requires_backup: true

    # åˆªé™¤æª”æ¡ˆ
    delete_file:
      name: "åˆªé™¤æª”æ¡ˆ"
      command: "rm {path}"
      validation:
        pre: "æª”æ¡ˆå­˜åœ¨"
        post: "æª”æ¡ˆä¸å­˜åœ¨"
      rollback: "restore_from_backup"
      requires_backup: true
      requires_confirmation: true

    # æ›´æ–°å¼•ç”¨
    update_references:
      name: "æ›´æ–°å¼•ç”¨è·¯å¾‘"
      command: "sed_replace"
      validation:
        pre: "èˆŠè·¯å¾‘å­˜åœ¨æ–¼æª”æ¡ˆä¸­"
        post: "æ–°è·¯å¾‘å­˜åœ¨ï¼ŒèˆŠè·¯å¾‘ä¸å­˜åœ¨"
      rollback: "restore_from_backup"
      requires_backup: true

  # åŸ·è¡Œé †åºè¦å‰‡
  execution_order:
    phases:
      - phase: 1
        name: "æº–å‚™"
        operations:
          - "backup_targets"
          - "validate_prerequisites"

      - phase: 2
        name: "çµæ§‹è®Šæ›´"
        operations:
          - "create_directory"
          - "move_file"
          - "copy_file"

      - phase: 3
        name: "å…§å®¹æ›´æ–°"
        operations:
          - "merge_file"
          - "update_references"

      - phase: 4
        name: "æ¸…ç†"
        operations:
          - "delete_file"
          - "remove_empty_directories"

      - phase: 5
        name: "é©—è­‰"
        operations:
          - "validate_structure"
          - "validate_references"
          - "run_tests"

# ============================================================================
# æ‰¹é‡æ›´æ–°è™•ç†
# ============================================================================
batch_processor:
  name: "BatchProcessor"
  description: "è™•ç†æ•´å€‹å­ç›®éŒ„çš„æ‰¹é‡æ›´æ–°"

  # æ‰¹é‡æ“ä½œé…ç½®
  batch_config:
    max_parallel_operations: 5
    checkpoint_interval: 10  # æ¯ 10 å€‹æ“ä½œå»ºç«‹æª¢æŸ¥é»
    retry_on_failure: true
    max_retries: 3

  # å­ç›®éŒ„å…¨é¢æ›´æ–°æµç¨‹
  full_directory_update:
    name: "å­ç›®éŒ„å…¨é¢æ›´æ–°"
    description: "ç•¶éœ€è¦æ•´é«”æ›´æ–°å­ç›®éŒ„æ™‚çš„è™•ç†æµç¨‹"

    steps:
      - step: 1
        name: "åˆ†æç¾æœ‰çµæ§‹"
        actions:
          - "scan_current_structure"
          - "identify_all_files"
          - "map_dependencies"

      - step: 2
        name: "ç”Ÿæˆç›®æ¨™çµæ§‹"
        actions:
          - "apply_optimization_rules"
          - "generate_target_map"
          - "calculate_changes"

      - step: 3
        name: "ç”Ÿæˆè®Šæ›´è¨ˆç•«"
        actions:
          - "list_creates"
          - "list_moves"
          - "list_merges"
          - "list_deletes"

      - step: 4
        name: "é©—è­‰è¨ˆç•«"
        actions:
          - "check_conflicts"
          - "validate_dependencies"
          - "estimate_impact"

      - step: 5
        name: "åŸ·è¡Œè®Šæ›´"
        actions:
          - "execute_creates"
          - "execute_moves"
          - "execute_merges"
          - "execute_deletes"

      - step: 6
        name: "å¾Œè™•ç†"
        actions:
          - "update_all_references"
          - "regenerate_indexes"
          - "update_documentation"

      - step: 7
        name: "é©—è­‰çµæœ"
        actions:
          - "validate_structure"
          - "run_tests"
          - "generate_report"

# ============================================================================
# ç´¢å¼•æ›´æ–°å™¨
# ============================================================================
index_updater:
  name: "IndexUpdater"
  description: "æ›´æ–°å„ç¨®ç´¢å¼•æª”æ¡ˆ"

  # ç´¢å¼•é¡å‹
  index_types:
    # index.yaml - æ©Ÿå™¨å¯è®€ç´¢å¼•
    machine_index:
      file: "03_refactor/index.yaml"
      format: "yaml"
      auto_update: true
      update_triggers:
        - "file_created"
        - "file_moved"
        - "file_deleted"

    # INDEX.md - äººé¡å¯è®€ç´¢å¼•
    human_index:
      file: "03_refactor/INDEX.md"
      format: "markdown"
      auto_update: true
      template: "templates/INDEX_TEMPLATE.md"

    # legacy_assets_index.yaml - èˆŠè³‡ç”¢ç´¢å¼•
    legacy_index:
      file: "01_deconstruction/legacy_assets_index.yaml"
      format: "yaml"
      auto_update: true
      update_triggers:
        - "asset_archived"
        - "asset_integrated"

    # README.md - ä¸»èªªæ˜æ–‡ä»¶
    readme:
      file: "README.md"
      format: "markdown"
      auto_update: false  # éœ€è¦æ‰‹å‹•ç¢ºèª
      sections_to_update:
        - "ç›®éŒ„çµæ§‹"
        - "ç›¸é—œæ–‡ä»¶é€£çµ"

# ============================================================================
# é©—è­‰å¼•æ“
# ============================================================================
validation_engine:
  name: "ValidationEngine"
  description: "é©—è­‰é›†æˆçµæœçš„æ­£ç¢ºæ€§"

  # é©—è­‰é …ç›®
  validations:
    # çµæ§‹é©—è­‰
    structure_validation:
      name: "çµæ§‹é©—è­‰"
      checks:
        - check: "all_directories_exist"
          description: "æ‰€æœ‰è¦åŠƒçš„ç›®éŒ„éƒ½å·²å‰µå»º"
          severity: "error"

        - check: "no_orphan_files"
          description: "æ²’æœ‰å­¤ç«‹æª”æ¡ˆ"
          severity: "warning"

        - check: "depth_within_limit"
          description: "ç›®éŒ„æ·±åº¦åœ¨é™åˆ¶å…§"
          severity: "warning"

    # å¼•ç”¨é©—è­‰
    reference_validation:
      name: "å¼•ç”¨é©—è­‰"
      checks:
        - check: "no_broken_links"
          description: "æ²’æœ‰æå£çš„é€£çµ"
          severity: "error"

        - check: "no_old_paths"
          description: "æ²’æœ‰èˆŠè·¯å¾‘å¼•ç”¨"
          severity: "error"

        - check: "relative_paths_correct"
          description: "ç›¸å°è·¯å¾‘æ­£ç¢º"
          severity: "error"

    # å…§å®¹é©—è­‰
    content_validation:
      name: "å…§å®¹é©—è­‰"
      checks:
        - check: "yaml_syntax_valid"
          description: "YAML èªæ³•æ­£ç¢º"
          severity: "error"

        - check: "markdown_links_valid"
          description: "Markdown é€£çµæœ‰æ•ˆ"
          severity: "warning"

        - check: "no_duplicate_content"
          description: "æ²’æœ‰é‡è¤‡å…§å®¹"
          severity: "warning"

    # ä¸€è‡´æ€§é©—è­‰
    consistency_validation:
      name: "ä¸€è‡´æ€§é©—è­‰"
      checks:
        - check: "naming_consistent"
          description: "å‘½åé¢¨æ ¼ä¸€è‡´"
          severity: "warning"

        - check: "index_synchronized"
          description: "ç´¢å¼•èˆ‡å¯¦éš›çµæ§‹åŒæ­¥"
          severity: "error"

# ============================================================================
# å ±å‘Šç”Ÿæˆå™¨
# ============================================================================
report_generator:
  name: "ReportGenerator"
  description: "ç”Ÿæˆé›†æˆåŸ·è¡Œå ±å‘Š"

  # å ±å‘Šé¡å‹
  report_types:
    # åŸ·è¡Œæ‘˜è¦
    execution_summary:
      filename: "execution_summary_{timestamp}.md"
      sections:
        - "åŸ·è¡Œæ¦‚è¦½"
        - "è®Šæ›´çµ±è¨ˆ"
        - "æˆåŠŸé …ç›®"
        - "å¤±æ•—é …ç›®"
        - "è­¦å‘Šé …ç›®"

    # è©³ç´°æ—¥èªŒ
    detailed_log:
      filename: "execution_log_{timestamp}.md"
      sections:
        - "æ¯æ­¥é©Ÿè©³æƒ…"
        - "éŒ¯èª¤è¿½è¹¤"
        - "æ•ˆèƒ½æŒ‡æ¨™"

    # è®Šæ›´æ¸…å–®
    change_manifest:
      filename: "changes_{timestamp}.yaml"
      format: "yaml"
      includes:
        - "created_files"
        - "moved_files"
        - "deleted_files"
        - "modified_files"

    # å›æ»¾æŒ‡å—
    rollback_guide:
      filename: "rollback_guide_{timestamp}.md"
      sections:
        - "å›æ»¾å‰æª¢æŸ¥"
        - "å›æ»¾æ­¥é©Ÿ"
        - "å›æ»¾å¾Œé©—è­‰"

# ============================================================================
# å®‰å…¨èˆ‡å‚™ä»½
# ============================================================================
safety:
  # å‚™ä»½é…ç½®
  backup:
    enabled: true
    location: "_legacy_scratch/_backups/"
    retention_days: 30
    compression: true

  # æª¢æŸ¥é»
  checkpoints:
    enabled: true
    location: "_legacy_scratch/_checkpoints/"
    auto_save_interval: 5  # æ¯ 5 åˆ†é˜

  # å›æ»¾æ”¯æ´
  rollback:
    enabled: true
    max_rollback_depth: 10  # æœ€å¤šå›æ»¾ 10 æ­¥
    preserve_backup_after_success: true

# ============================================================================
# å·¥ä½œæµç¨‹å®šç¾©
# ============================================================================
workflows:
  # æ¨™æº–é›†æˆå·¥ä½œæµç¨‹
  standard_integration:
    name: "æ¨™æº–é›†æˆæµç¨‹"
    steps:
      - name: "è¼‰å…¥æ±ºç­–"
        action: "load_placement_decisions"
      - name: "æœ€ä½³åŒ–çµæ§‹"
        action: "optimize_directory_structure"
      - name: "ç”Ÿæˆåœ–è­œ"
        action: "generate_directory_map"
      - name: "å»ºç«‹è¨ˆç•«"
        action: "create_execution_plan"
      - name: "åŸ·è¡Œé›†æˆ"
        action: "execute_integration"
      - name: "æ›´æ–°ç´¢å¼•"
        action: "update_all_indexes"
      - name: "é©—è­‰çµæœ"
        action: "validate_integration"
      - name: "ç”Ÿæˆå ±å‘Š"
        action: "generate_reports"

  # å¿«é€Ÿé›†æˆï¼ˆå–®æª”æ¡ˆï¼‰
  quick_integration:
    name: "å¿«é€Ÿé›†æˆ"
    steps:
      - name: "é©—è­‰æ±ºç­–"
        action: "validate_single_decision"
      - name: "åŸ·è¡Œç§»å‹•"
        action: "execute_single_move"
      - name: "æ›´æ–°å¼•ç”¨"
        action: "update_references"
      - name: "æ›´æ–°ç´¢å¼•"
        action: "update_indexes"

  # æ‰¹é‡é‡çµ„ï¼ˆæ•´å€‹å­ç›®éŒ„ï¼‰
  bulk_reorganization:
    name: "æ‰¹é‡é‡çµ„"
    steps:
      - name: "å®Œæ•´æƒæ"
        action: "full_directory_scan"
      - name: "æœ€ä½³åŒ–æ±ºç­–"
        action: "bulk_optimization"
      - name: "ç”Ÿæˆå®Œæ•´è¨ˆç•«"
        action: "generate_full_plan"
      - name: "äººå·¥å¯©æŸ¥"
        action: "await_approval"
      - name: "æ‰¹é‡åŸ·è¡Œ"
        action: "batch_execute"
      - name: "å…¨é¢é©—è­‰"
        action: "comprehensive_validation"
