apiVersion: machinenativeops.io/v2
kind: CanonicalNamingSpec
metadata:
  approvedBy: Governance Board
  description: 单一权威命名规范，所有 Gatekeeper、Conftest、CI/CD 规则由此派生
  lastUpdated: '2025-01-15'
  name: canonical-naming-governance
  owner: Platform Engineering Team
  rfc: RFC-2025-10-25
  version: v1.0
spec:
  audit:
    enabled: true
<<<<<<< HEAD
    fields:
    - timestamp
    - resource_type
    - resource_name
    - validation_result
    - rule_id
    - severity
    - error_message
    log_level: info
    retention: 1 year
  exemptions:
  - approved_by: platform-team
    expires_at: permanent
    reason: Kubernetes 系统命名空间
    resource: kube-system
  - approved_by: platform-team
    expires_at: permanent
    reason: Kubernetes 公共命名空间
    resource: kube-public
  - approved_by: platform-team
    expires_at: permanent
    reason: Kubernetes 节点租约命名空间
    resource: kube-node-lease
  - approved_by: platform-team
    expires_at: permanent
    reason: Kubernetes 默认命名空间
    resource: default
  - approved_by: governance-board
    expires_at: '2025-12-31T23:59:59Z'
    reason: 历史遗留系统，迁移计划中
    resource: legacy-*
=======
    format: "urn:machinenativeops:{domain}:{component}:env:{environment}:{version}"
    examples:
      - namespace: "team-frontend-prod"
        urn: "urn:machinenativeops:team:frontend:env:prod:v1"
      - namespace: "tenant-payment-prod-uswest"
        urn: "urn:machinenativeops:tenant:payment:env:prod:region:uswest"

    annotation_key: "machinenativeops.io/canonical-urn"
    description: "所有 Namespace 必须包含 URN annotation"

  # 验证规则（用于 CI/CD、Conftest、Gatekeeper）
  validation_rules:
    # 规则 1: Namespace 命名验证
    - id: "RULE-001"
      resource_type: "Namespace"
      field: "metadata.name"
      rule_type: "regex"
      pattern: "^(team|tenant|dev|test|staging|prod|learn)-[a-z0-9-]{1,56}[a-z0-9]$"
      severity: "critical"
      error_message: "Namespace 名称必须符合 Canonical 命名模式之一"
      remediation: "使用 team-{domain}-{env}、tenant-{workload}-{env}-{region} 或 env-{app}-{version} 格式"

    # 规则 2: 必需标签验证
    - id: "RULE-002"
      resource_type: "Namespace"
      field: "metadata.labels"
      rule_type: "required_keys"
      required_keys: ["environment", "tenant"]
      severity: "high"
      error_message: "Namespace 缺少必需标签"
      exemptions: ["kube-system", "kube-public", "kube-node-lease", "default"]

    # 规则 3: URN annotation 验证
    - id: "RULE-003"
      resource_type: "Namespace"
      field: "metadata.annotations"
      rule_type: "required_keys"
      required_keys: ["machinenativeops.io/canonical-urn"]
      severity: "medium"
      error_message: "Namespace 缺少 Canonical URN annotation"

    # 规则 4: 保留关键字验证
    - id: "RULE-004"
      resource_type: "all"
      field: "metadata.name"
      rule_type: "deny_list"
      denied_values: ["core", "internal", "system", "legacy", "experimental", "kube", "kubernetes"]
      severity: "critical"
      error_message: "资源名称不能使用保留关键字"

    # 规则 5: 环境标签值验证
    - id: "RULE-005"
      resource_type: "all"
      field: "metadata.labels.environment"
      rule_type: "allow_list"
      allowed_values: ["dev", "test", "staging", "prod", "learn"]
      severity: "critical"
      error_message: "environment 标签值必须是标准环境之一"

  # 迁移策略
>>>>>>> main
  migration:
    auto_suggestion:
      algorithm: pattern_matching
      enabled: true
      fallback: team-{original_name}-{env}
    batch_config:
      cooldown_period: 1h
      max_batch_size: 50
      rollback_enabled: true
    conflict_detection:
      check_types:
      - duplicate_names
      - reserved_keywords
      - label_inconsistency
      - urn_collision
      enabled: true
  naming:
    allowed_chars: '[a-z0-9-]'
    canonical_regex: ^(team|tenant|dev|test|staging|prod|learn)-[a-z0-9-]{1,56}[a-z0-9]$
    case: lower
    environments:
    - aliases:
      - develop
      - development
      description: 开发环境
      name: dev
    - aliases:
      - testing
      - qa
      description: 测试环境
      name: test
    - aliases:
      - stage
      - preprod
      - uat
      description: 预生产环境
      name: staging
    - aliases:
      - production
      - live
      description: 生产环境
      name: prod
    - aliases:
      - sandbox
      - demo
      description: 学习/沙箱环境
      name: learn
    max_length: 63
    naming_modes:
    - example: team-frontend-prod
      id: team-domain-env
      pattern: ^{team}-{domain}-{environment}$
      regex: ^team-[a-z0-9-]+-(?:dev|test|staging|prod|learn)$
      required_labels:
      - team
      - environment
      - domain
      use_cases:
      - 团队级命名空间
      - 微服务命名空间
    - example: tenant-payment-prod-uswest
      id: tenant-workload-env-region
      pattern: ^{tenant}-{workload}-{environment}-{region}$
      regex: ^tenant-[a-z0-9-]+-(?:dev|test|staging|prod)-[a-z0-9-]+$
      required_labels:
      - tenant
      - workload
      - environment
      - region
      use_cases:
      - 多租户环境
      - 跨区域部署
    - example: prod-api-v2
      id: env-app-version
      pattern: ^{environment}-{app}-{version}$
      regex: ^(?:dev|test|staging|prod)-[a-z0-9-]+-v[0-9]+$
      required_labels:
      - environment
      - app
      - version
      use_cases:
      - 多版本共存
      - 蓝绿部署
      - 金丝雀发布
    reserved_tokens:
    - core
    - internal
    - system
    - legacy
    - experimental
    - kube
    - kubernetes
    - default
    segments:
    - domain
    - component
    - environment
    - region
    - version
    - suffix
  required_labels:
  - description: 部署环境（dev/test/staging/prod/learn）
    key: environment
    required: true
    scope:
    - Namespace
    - Deployment
    - Service
    - Ingress
    validation_regex: ^(dev|test|staging|prod|learn)$
  - description: 租户标识
    exemptions:
    - kube-system
    - kube-public
    - kube-node-lease
    key: tenant
    required: true
    scope:
    - Namespace
    validation_regex: ^[a-z0-9-]{2,32}$
  - description: 应用名称
    key: app.kubernetes.io/name
    required: true
    scope:
    - Deployment
    - StatefulSet
    - DaemonSet
    validation_regex: ^[a-z0-9-]{2,63}$
  - description: 管理工具（helm/kubectl/terraform）
    key: app.kubernetes.io/managed-by
    required: true
    scope:
    - all
    validation_regex: ^(helm|kubectl|terraform|argocd|flux)$
  - description: 负责团队
    key: team
    required: false
    scope:
    - Namespace
    - Deployment
    validation_regex: ^[a-z0-9-]{2,32}$
  sla:
    migration_success_rate:
      alert_threshold: 85.0
      measurement: percentage
      target: 95.0
    naming_compliance_rate:
      alert_threshold: 95.0
      measurement: percentage
      target: 99.9
    validation_failure_rate:
      alert_threshold: 5.0
      measurement: percentage
      target: 1.0
  tooling:
    cicd:
      github_actions:
        enabled: true
        workflow_path: .github/workflows/naming-validation.yml
      gitlab_ci:
        enabled: false
    conftest:
      enabled: true
      namespace: main
      policy_path: templates/conftest/naming.rego
    gatekeeper:
      constraint_template: policies/gatekeeper/namespace-constraints.yaml
      enabled: true
      enforcement_action: deny
    observability:
      grafana:
        dashboard_path: templates/grafana/naming-compliance-dashboard.json
        enabled: true
      prometheus:
        enabled: true
        metrics_path: policies/observability/naming-metrics-policy.yaml
  urn_mapping:
    annotation_key: machinenativeops.io/canonical-urn
    description: 所有 Namespace 必须包含 URN annotation
    enabled: true
    examples:
    - namespace: team-frontend-prod
      urn: urn:machinenativeops:team:frontend:env:prod:v1
    - namespace: tenant-payment-prod-uswest
      urn: urn:machinenativeops:tenant:payment:env:prod:region:uswest
    format: urn:machinenativeops:{domain}:{component}:env:{environment}:{version}
  validation_rules:
  - error_message: Namespace 名称必须符合 Canonical 命名模式之一
    field: metadata.name
    id: RULE-001
    pattern: ^(team|tenant|dev|test|staging|prod|learn)-[a-z0-9-]{1,56}[a-z0-9]$
    remediation: 使用 team-{domain}-{env}、tenant-{workload}-{env}-{region} 或 env-{app}-{version}
      格式
    resource_type: Namespace
    rule_type: regex
    severity: critical
  - error_message: Namespace 缺少必需标签
    exemptions:
    - kube-system
    - kube-public
    - kube-node-lease
    - default
    field: metadata.labels
    id: RULE-002
    required_keys:
    - environment
    - tenant
    resource_type: Namespace
    rule_type: required_keys
    severity: high
  - error_message: Namespace 缺少 Canonical URN annotation
    field: metadata.annotations
    id: RULE-003
    required_keys:
    - axiom.io/canonical-urn
    resource_type: Namespace
    rule_type: required_keys
    severity: medium
  - denied_values:
    - core
    - internal
    - system
    - legacy
    - experimental
    - kube
    - kubernetes
    error_message: 资源名称不能使用保留关键字
    field: metadata.name
    id: RULE-004
    resource_type: all
    rule_type: deny_list
    severity: critical
  - allowed_values:
    - dev
    - test
    - staging
    - prod
    - learn
    error_message: environment 标签值必须是标准环境之一
    field: metadata.labels.environment
    id: RULE-005
    resource_type: all
    rule_type: allow_list
    severity: critical
usage:
  description: '本文件是 Canonical Naming Governance 的唯一权威规范（Single Source of Truth）。

    所有 Gatekeeper ConstraintTemplates、Conftest Rego 规则、CI/CD 验证流程都应从此文件派生。

    '
  examples:
  - command: python tools/governance/python/validate_naming.py --spec canonical/machine-spec.yaml
      --resource manifests/namespace.yaml
    description: 验证 Namespace 名称
  - command: python tools/governance/python/generate_gatekeeper.py --spec canonical/machine-spec.yaml
      --output policies/gatekeeper/
    description: 生成 Gatekeeper Constraints
  - command: python tools/governance/python/naming-migration.py --spec canonical/machine-spec.yaml
      --scan
    description: 检测命名冲突
  how_to_consume:
  - 'CI/CD: 直接读取本文件进行验证'
  - 'Gatekeeper: 使用 parameters 生成 ConstraintTemplates'
  - 'Conftest: 基于 validation_rules 生成 Rego 规则'
  - 'Migration: 使用 naming_modes 生成建议'
versioning:
  changelog: canonical/CHANGELOG.md
  upgrade_guide: docs/governance/naming-upgrade-guide.md
