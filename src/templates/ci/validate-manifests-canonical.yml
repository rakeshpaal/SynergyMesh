name: Canonical Naming Validation
true:
  pull_request:
    branches:
    - main
    - master
    - develop
    - release/**
    paths:
    - manifests/**
    - kubernetes/**
    - k8s/**
    - helm/**
    - terraform/**
    - kustomize/**
  push:
    branches:
    - main
    - master
    paths:
    - canonical/**
    - policies/**
    - templates/**
  workflow_dispatch:
    inputs:
      paths:
        default: manifests/
        description: Custom paths to validate (comma-separated)
        required: false
permissions:
  checks: write
  contents: read
  pull-requests: write
jobs:
  compliance-metrics:
    name: Calculate Compliance Metrics
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Calculate metrics
      run: "echo \"\U0001F4CA Calculating naming compliance metrics...\"\n\npython\
        \ -c \"\nimport yaml\nimport os\nfrom pathlib import Path\n\ntotal = 0\ncompliant\
        \ = 0\n\n# 查找所有 Namespace 定義\nfor path in Path('manifests/').rglob('*.yaml'):\n\
        \    try:\n        with open(path, 'r') as f:\n            for doc in yaml.safe_load_all(f):\n\
        \                if doc and doc.get('kind') == 'Namespace':\n            \
        \        total += 1\n                    name = doc.get('metadata', {}).get('name',\
        \ '')\n\n                    # 簡單檢查是否符合基本格式\n                    if len(name)\
        \ >= 3 and len(name) <= 63 and name.islower():\n                        compliant\
        \ += 1\n    except:\n        pass\n\nif total > 0:\n    rate = (compliant\
        \ / total) * 100\n    print(f'\U0001F4CA Naming Compliance Rate: {rate:.1f}%\
        \ ({compliant}/{total})')\n    print(f'NCR={rate:.1f}' >> '$GITHUB_ENV')\n\
        else:\n    print('⚠️  No namespaces found')\n\"\n"
    - if: always()
      name: Create status check
      uses: actions/github-script@v7
      with:
        script: "const ncr = process.env.NCR || '0';\nconst status = parseFloat(ncr)\
          \ >= 99.0 ? 'success' : 'failure';\n\ngithub.rest.repos.createCommitStatus({\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  sha: context.sha,\n\
          \  state: status,\n  context: 'naming/compliance-rate',\n  description:\
          \ `NCR: ${ncr}% (Target: 99.0%)`,\n  target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`\n\
          });\n"
    timeout-minutes: 5
  detect-conflicts:
    if: github.event_name == 'pull_request'
    name: Detect Naming Conflicts
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: 'pip install pyyaml

        '
    - name: Run conflict detection
      run: "echo \"\U0001F50D Detecting naming conflicts...\"\n\npython tools/governance/python/naming-migration.py\
        \ \\\n  --spec canonical/machine-spec.yaml \\\n  --detect-conflicts \\\n \
        \ --output conflicts.json \\\n  2>&1 | tee conflict-detection.log || true\n"
    - if: always()
      name: Upload conflict report
      uses: actions/upload-artifact@v4
      with:
        name: conflict-report
        path: 'conflicts.json

          conflict-detection.log

          '
        retention-days: 30
    timeout-minutes: 5
  validate-naming:
    name: Validate Naming Compliance
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        cache: pip
        python-version: '3.11'
    - name: Install Python dependencies
      run: 'pip install --upgrade pip

        pip install pyyaml jsonschema

        '
    - name: Install Conftest
      run: 'wget https://github.com/open-policy-agent/conftest/releases/download/v0.48.0/conftest_0.48.0_Linux_x86_64.tar.gz

        tar xzf conftest_0.48.0_Linux_x86_64.tar.gz

        sudo mv conftest /usr/local/bin/

        conftest --version

        '
    - name: Validate machine-spec.yaml structure
      run: "echo \"\U0001F50D Validating canonical/machine-spec.yaml structure...\"\
        \npython -c \"\nimport yaml\nimport json\nimport sys\nfrom jsonschema import\
        \ validate, ValidationError\n\n# 讀取 machine-spec.yaml\nwith open('canonical/machine-spec.yaml',\
        \ 'r') as f:\n    spec = yaml.safe_load(f)\n\n# 讀取 schema\nwith open('schemas/naming-spec.schema.yaml',\
        \ 'r') as f:\n    schema = yaml.safe_load(f)\n\n# 驗證\ntry:\n    validate(instance=spec,\
        \ schema=schema)\n    print('✅ machine-spec.yaml is valid')\nexcept ValidationError\
        \ as e:\n    print(f'❌ machine-spec.yaml validation failed: {e}')\n    sys.exit(1)\n\
        \"\n"
    - continue-on-error: true
      id: conftest
      name: Run Conftest validation
      run: "echo \"\U0001F50D Running Conftest validation...\"\n\n# 查找所有 Kubernetes\
        \ manifest 文件\nMANIFEST_FILES=$(find manifests/ kubernetes/ k8s/ helm/ -name\
        \ '*.yaml' -o -name '*.yml' 2>/dev/null | head -100)\n\nif [ -z \"$MANIFEST_FILES\"\
        \ ]; then\n  echo \"⚠️  No manifest files found, skipping validation\"\n \
        \ exit 0\nfi\n\n# 運行 Conftest\nconftest test $MANIFEST_FILES \\\n  --policy\
        \ templates/conftest/ \\\n  --output json \\\n  --all-namespaces \\\n  2>&1\
        \ | tee conftest-results.json || true\n\n# 生成摘要\npython -c \"\nimport json\n\
        import sys\n\ntry:\n    with open('conftest-results.json', 'r') as f:\n  \
        \      results = [json.loads(line) for line in f if line.strip()]\n\n    total\
        \ = len(results)\n    failures = sum(1 for r in results if r.get('failures'))\n\
        \    warnings = sum(1 for r in results if r.get('warnings'))\n\n    print(f'\\\
        n\U0001F4CA Conftest Results:')\n    print(f'  Total files: {total}')\n  \
        \  print(f'  Failures: {failures}')\n    print(f'  Warnings: {warnings}')\n\
        \n    if failures > 0:\n        sys.exit(1)\nexcept Exception as e:\n    print(f'Error\
        \ processing results: {e}')\n    sys.exit(0)\n\"\n"
    - continue-on-error: true
      id: python-validation
      name: Custom Python validation
      run: "echo \"\U0001F50D Running custom Python validation...\"\n\npython tools/governance/python/validate_naming.py\
        \ \\\n  --spec canonical/machine-spec.yaml \\\n  --resource manifests/ \\\n\
        \  --strict \\\n  --output validation-report.json \\\n  2>&1 | tee validation.log\
        \ || true\n"
    - if: always()
      name: Generate validation report
      run: "echo \"\U0001F4DD Generating validation report...\"\n\npython -c \"\n\
        import yaml\nimport json\nimport os\nfrom datetime import datetime\n\nreport\
        \ = {\n    'timestamp': datetime.now().isoformat(),\n    'pr_number': os.environ.get('GITHUB_REF',\
        \ 'N/A'),\n    'commit_sha': os.environ.get('GITHUB_SHA', 'N/A'),\n    'conftest_passed':\
        \ '${{ steps.conftest.outcome }}' == 'success',\n    'python_validation_passed':\
        \ '${{ steps.python-validation.outcome }}' == 'success',\n    'overall_status':\
        \ 'pass' if ('${{ steps.conftest.outcome }}' == 'success' and '${{ steps.python-validation.outcome\
        \ }}' == 'success') else 'fail'\n}\n\n# 讀取 Conftest 結果\ntry:\n    with open('conftest-results.json',\
        \ 'r') as f:\n        report['conftest_results'] = [json.loads(line) for line\
        \ in f if line.strip()]\nexcept:\n    report['conftest_results'] = []\n\n\
        # 讀取 Python 驗證結果\ntry:\n    with open('validation-report.json', 'r') as f:\n\
        \        report['python_validation_results'] = json.load(f)\nexcept:\n   \
        \ report['python_validation_results'] = {}\n\n# 寫入報告\nwith open('full-validation-report.json',\
        \ 'w') as f:\n    json.dump(report, f, indent=2)\n\nprint('✅ Report generated:\
        \ full-validation-report.json')\n\"\n"
    - if: always()
      name: Upload validation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: validation-results
        path: 'conftest-results.json

          validation-report.json

          full-validation-report.json

          validation.log

          '
        retention-days: 30
    - if: failure() && github.event_name == 'pull_request'
      name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: "const fs = require('fs');\n\nlet comment = '## ❌ Canonical Naming\
          \ Validation Failed\\n\\n';\n\n// 讀取驗證結果\ntry {\n  const report = JSON.parse(fs.readFileSync('full-validation-report.json',\
          \ 'utf8'));\n\n  comment += '### Summary\\n';\n  comment += `- **Conftest**:\
          \ ${report.conftest_passed ? '✅ Passed' : '❌ Failed'}\\n`;\n  comment +=\
          \ `- **Python Validation**: ${report.python_validation_passed ? '✅ Passed'\
          \ : '❌ Failed'}\\n`;\n  comment += '\\n';\n\n  // 添加失敗詳情\n  if (!report.conftest_passed\
          \ && report.conftest_results) {\n    comment += '### Conftest Violations\\\
          n';\n    const failures = report.conftest_results.filter(r => r.failures\
          \ && r.failures.length > 0);\n    failures.slice(0, 5).forEach(f => {\n\
          \      comment += `\\n**${f.filename}:**\\n`;\n      f.failures.forEach(fail\
          \ => {\n        comment += `- ${fail.msg}\\n`;\n      });\n    });\n   \
          \ if (failures.length > 5) {\n      comment += `\\n... and ${failures.length\
          \ - 5} more files with violations\\n`;\n    }\n  }\n\n  comment += '\\n###\
          \ How to Fix\\n';\n  comment += '1. Review the [Canonical Naming Governance\
          \ Guide](../canonical/README.md)\\n';\n  comment += '2. Ensure all namespaces\
          \ follow one of the three canonical patterns:\\n';\n  comment += '   - `team-{domain}-{environment}`\\\
          n';\n  comment += '   - `tenant-{workload}-{environment}-{region}`\\n';\n\
          \  comment += '   - `{environment}-{app}-{version}`\\n';\n  comment += '3.\
          \ Add required labels: `environment`, `tenant`\\n';\n  comment += '4. Add\
          \ required annotation: `machinenativeops.io/canonical-urn`\\n';\n  comment\
          \ += '\\n';\n  comment += '\U0001F4DA [Full Documentation](../docs/governance/04-canonical-naming-governance.md)\\\
          n';\n\n} catch (e) {\n  comment += `Error reading validation report: ${e.message}\\\
          n`;\n}\n\ngithub.rest.issues.createComment({\n  issue_number: context.issue.number,\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  body: comment\n\
          });\n"
    - if: steps.conftest.outcome == 'failure' || steps.python-validation.outcome ==
        'failure'
      name: Fail workflow if validation failed
      run: 'echo "❌ Validation failed. Please fix the naming violations before merging."

        exit 1

        '
    timeout-minutes: 10
