k8s-naming-validation:
  before_script:
  - apk add --no-cache python3 py3-pip git
  - pip3 install pyyaml jsonschema
  image: alpine/k8s:1.28.3
  rules:
  - changes:
    - '**/*.yaml'
    - '**/*.yml'
    if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
  - "find . -name \"*.yaml\" -o -name \"*.yml\" | while read file; do\n  if grep -q\
    \ \"apiVersion.*kind:\" \"$file\"; then\n    echo \"Validating K8s manifest: $file\"\
    \n    kubectl apply --dry-run=client -f \"$file\" || exit 1\n  fi\ndone\n"
  - "python3 << 'EOF'\nimport yaml\nimport re\nimport sys\nfrom pathlib import Path\n\
    \n# 命名模式: {env}-{app}-deploy-{version}\npattern = re.compile(r'^(dev|staging|prod)-[a-z0-9-]+-deploy-v\\\
    d+\\.\\d+\\.\\d+(-[a-zA-Z0-9]+)?$')\n\nerrors = []\nfor yaml_file in Path('.').rglob('*.yaml'):\n\
    \    try:\n        with open(yaml_file) as f:\n            docs = yaml.safe_load_all(f)\n\
    \            for doc in docs:\n                if doc and doc.get('kind') == 'Deployment':\n\
    \                    name = doc.get('metadata', {}).get('name', '')\n        \
    \            if not pattern.match(name):\n                        errors.append(f'{yaml_file}:\
    \ Deployment \"{name}\" does not match naming convention')\n                 \
    \       errors.append(f'  Expected: {{env}}-{{app}}-deploy-{{version}}')\n   \
    \                     errors.append(f'  Example: prod-payment-deploy-v1.0.0')\n\
    \    except Exception as e:\n        continue\n\nif errors:\n    print('\\n'.join(errors),\
    \ file=sys.stderr)\n    sys.exit(1)\nelse:\n    print('✓ All Kubernetes resource\
    \ names are compliant')\nEOF\n"
  stage: validate
naming-compliance:
  artifacts:
    expire_in: 30 days
    paths:
    - naming-report.json
    - naming-report.xml
    reports:
      junit: naming-report.xml
  before_script:
  - apt-get update && apt-get install -y git
  - pip install pyyaml jsonschema requests
  - git clone --depth 1 --branch ${GOVERNANCE_BRANCH} ${GOVERNANCE_REPO} governance-framework
  image: python:${PYTHON_VERSION}-slim
  rules:
  - changes:
    - '**/*.yaml'
    - '**/*.yml'
    - '**/*.json'
    - '**/*.tf'
    if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
  - "git diff --name-only ${CI_MERGE_REQUEST_DIFF_BASE_SHA}...${CI_COMMIT_SHA} \\\n\
    \  | grep -E '\\.(yaml|yml|json|tf)$' > changed-files.txt || true\n"
  - "if [ -s changed-files.txt ]; then\n  python governance-framework/tools/python/validate_naming.py\
    \ \\\n    --files-list changed-files.txt \\\n    --policies governance-framework/policies/naming/\
    \ \\\n    --schemas governance-framework/schemas/ \\\n    --output naming-report.json\
    \ \\\n    --format json\nelse\n  echo '{\"status\": \"skipped\", \"message\":\
    \ \"No relevant files changed\"}' > naming-report.json\nfi\n"
  stage: validate
post-mr-comment:
  before_script:
  - pip install requests pyyaml
  dependencies:
  - naming-compliance
  image: python:${PYTHON_VERSION}-slim
  only:
    variables:
    - $GITLAB_TOKEN
  rules:
  - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
  - "python3 << 'EOF'\nimport os\nimport json\nimport requests\n\n# 读取验证报告\nwith open('naming-report.json')\
    \ as f:\n    report = json.load(f)\n\n# 生成 Markdown 评论\nstatus = report.get('status',\
    \ 'unknown')\nemoji = '✅' if status == 'passed' else '❌' if status == 'failed'\
    \ else '⚠️'\n\ncomment = f\"\"\"\n## {emoji} Naming Compliance Report\n\n**Status**:\
    \ {status.upper()}\n\n### Summary\n- Total files checked: {report.get('total_files',\
    \ 0)}\n- Compliant: {report.get('compliant', 0)}\n- Violations: {report.get('violations',\
    \ 0)}\n\n\"\"\"\n\nif report.get('violations', 0) > 0:\n    comment += \"\\n###\
    \ Violations\\n\\n\"\n    for violation in report.get('violation_details', []):\n\
    \        comment += f\"- **{violation['file']}**: {violation['message']}\\n\"\n\
    \        comment += f\"  - Expected: `{violation.get('expected', 'N/A')}`\\n\"\
    \n        comment += f\"  - Actual: `{violation.get('actual', 'N/A')}`\\n\\n\"\
    \n\ncomment += \"\\n---\\n*Automated by Governance Framework*\"\n\n# 发送到 GitLab\
    \ MR\ngitlab_api = os.environ['CI_API_V4_URL']\nproject_id = os.environ['CI_PROJECT_ID']\n\
    mr_iid = os.environ['CI_MERGE_REQUEST_IID']\ntoken = os.environ['GITLAB_TOKEN']\n\
    \nurl = f\"{gitlab_api}/projects/{project_id}/merge_requests/{mr_iid}/notes\"\n\
    headers = {'PRIVATE-TOKEN': token}\ndata = {'body': comment}\n\nresponse = requests.post(url,\
    \ headers=headers, json=data)\nif response.status_code == 201:\n    print('✓ Comment\
    \ posted to MR')\nelse:\n    print(f'✗ Failed to post comment: {response.status_code}')\n\
    EOF\n"
  stage: report
stages:
- validate
- report
variables:
  GOVERNANCE_BRANCH: main
  GOVERNANCE_REPO: https://github.com/MachineNativeOps/MachineNativeOps.git
  PYTHON_VERSION: '3.11'
