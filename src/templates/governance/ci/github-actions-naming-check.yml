name: Naming Compliance Check
true:
  pull_request:
    branches:
    - main
    - develop
    paths:
    - '**/*.yaml'
    - '**/*.yml'
    - '**/*.tf'
    - '**/*.json'
jobs:
  kubernetes-naming:
    if: contains(github.event.pull_request.changed_files, '.yaml') || contains(github.event.pull_request.changed_files,
      '.yml')
    name: Kubernetes Resource Naming
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup tools
      run: '# 安装 kubectl 和 kustomize

        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"

        chmod +x kubectl

        sudo mv kubectl /usr/local/bin/

        '
    - name: Validate Kubernetes manifests
      run: "# 查找所有 Kubernetes YAML 文件\nfind . -name \"*.yaml\" -o -name \"*.yml\"\
        \ | while read file; do\n  # 检查是否是 Kubernetes 资源\n  if grep -q \"apiVersion.*kind:\"\
        \ \"$file\"; then\n    echo \"Validating: $file\"\n    kubectl apply --dry-run=client\
        \ -f \"$file\" || exit 1\n  fi\ndone\n"
    - name: Check Kubernetes naming convention
      run: "# 验证 Kubernetes 资源命名\npython -c \"\nimport yaml\nimport re\nimport sys\n\
        from pathlib import Path\n\npattern = re.compile(r'^(dev|staging|prod)-[a-z0-9-]+-deploy-v\\\
        d+\\.\\d+\\.\\d+(-[a-zA-Z0-9]+)?$')\n\nerrors = []\nfor yaml_file in Path('.').rglob('*.yaml'):\n\
        \    try:\n        with open(yaml_file) as f:\n            docs = yaml.safe_load_all(f)\n\
        \            for doc in docs:\n                if doc and doc.get('kind')\
        \ == 'Deployment':\n                    name = doc.get('metadata', {}).get('name',\
        \ '')\n                    if not pattern.match(name):\n                 \
        \       errors.append(f'{yaml_file}: Deployment name \\'{name}\\' does not\
        \ match naming convention')\n    except Exception as e:\n        pass\n\n\
        if errors:\n    for error in errors:\n        print(f'::error::{error}')\n\
        \    sys.exit(1)\n\"\n"
  naming-validation:
    name: Validate Resource Naming
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        cache: pip
        python-version: '3.11'
    - name: Install dependencies
      run: 'pip install pyyaml jsonschema

        '
    - name: Checkout governance framework
      uses: actions/checkout@v4
      with:
        path: governance-framework
        repository: MachineNativeOps/MachineNativeOps
        sparse-checkout: 'schemas/

          policies/

          tools/

          '
    - continue-on-error: true
      id: naming-check
      name: Run naming validation
      run: "python governance-framework/tools/python/validate_naming.py \\\n  --changed-files-only\
        \ \\\n  --base-ref ${{ github.event.pull_request.base.sha }} \\\n  --head-ref\
        \ ${{ github.event.pull_request.head.sha }} \\\n  --policies governance-framework/policies/naming/\
        \ \\\n  --schemas governance-framework/schemas/ \\\n  --output naming-report.json\n"
    - id: report
      if: always()
      name: Generate report comment
      run: "python governance-framework/tools/python/generate_pr_comment.py \\\n \
        \ --report naming-report.json \\\n  --output comment.md\n"
    - if: always()
      name: Post PR comment
      uses: actions/github-script@v7
      with:
        script: "const fs = require('fs');\nconst comment = fs.readFileSync('comment.md',\
          \ 'utf8');\n\n// 查找已存在的 bot 评论\nconst { data: comments } = await github.rest.issues.listComments({\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  issue_number:\
          \ context.issue.number,\n});\n\nconst botComment = comments.find(comment\
          \ =>\n  comment.user.type === 'Bot' &&\n  comment.body.includes('Naming\
          \ Compliance Report')\n);\n\n// 更新或创建评论\nif (botComment) {\n  await github.rest.issues.updateComment({\n\
          \    owner: context.repo.owner,\n    repo: context.repo.repo,\n    comment_id:\
          \ botComment.id,\n    body: comment\n  });\n} else {\n  await github.rest.issues.createComment({\n\
          \    owner: context.repo.owner,\n    repo: context.repo.repo,\n    issue_number:\
          \ context.issue.number,\n    body: comment\n  });\n}\n"
    - if: always()
      name: Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: naming-validation-report
        path: naming-report.json
        retention-days: 30
    - if: steps.naming-check.outcome == 'failure'
      name: Check validation status
      run: 'echo "::error::Naming validation failed. Please review the report and
        fix the issues."

        exit 1

        '
    - if: failure()
      name: Add labels
      uses: actions/github-script@v7
      with:
        script: "await github.rest.issues.addLabels({\n  owner: context.repo.owner,\n\
          \  repo: context.repo.repo,\n  issue_number: context.issue.number,\n  labels:\
          \ ['governance-violation', 'naming-compliance']\n});\n"
