apiVersion: machinenativeops.io/v2
kind: PrometheusRule
metadata:
  labels:
    machinenativeops.io/category: governance
    machinenativeops.io/prometheus: kube-prometheus
    machinenativeops.io/role: alert-rules
  name: governance-naming-compliance
  namespace: machinenativenops
spec:
  groups:
  - interval: 5m
    name: governance.naming_compliance
    rules:
    - alert: NamingComplianceRateLow
      annotations:
        description: 'Naming compliance rate is {{ $value | humanizePercentage }},
          below the 90% threshold.

          Review and fix non-compliant resources.

          '
        runbook_url: https://governance.example.com/runbooks/naming-compliance
        summary: Naming compliance rate below threshold
      expr: "(\n  sum(governance_naming_compliant_resources) /\n  sum(governance_naming_total_resources)\n\
        ) * 100 < 90\n"
      for: 15m
      labels:
        category: governance
        component: naming
        severity: warning
    - alert: NamingComplianceRateCritical
      annotations:
        description: 'Naming compliance rate is {{ $value | humanizePercentage }},
          below the critical 85% threshold.

          IMMEDIATE ACTION REQUIRED.

          '
        runbook_url: https://governance.example.com/runbooks/naming-compliance
        summary: Naming compliance rate critically low
      expr: "(\n  sum(governance_naming_compliant_resources) /\n  sum(governance_naming_total_resources)\n\
        ) * 100 < 85\n"
      for: 5m
      labels:
        category: governance
        component: naming
        severity: critical
    - alert: NewNamingViolations
      annotations:
        description: '{{ $value }} new naming violations detected in the last 5 minutes.

          Resource: {{ $labels.resource_type }}

          Namespace: {{ $labels.namespace }}

          '
        runbook_url: https://governance.example.com/runbooks/naming-violations
        summary: New naming violations detected
      expr: 'increase(governance_naming_violations_total[5m]) > 0

        '
      labels:
        category: governance
        component: naming
        severity: warning
    - alert: ProductionNamingViolation
      annotations:
        description: '{{ $value }} naming violations detected in PRODUCTION environment.

          This must be addressed immediately.

          Resource: {{ $labels.resource_type }}

          Namespace: {{ $labels.namespace }}

          '
        runbook_url: https://governance.example.com/runbooks/prod-violations
        summary: Naming violation in production environment
      expr: 'governance_naming_violations{environment="production"} > 0

        '
      for: 1m
      labels:
        category: governance
        component: naming
        environment: production
        severity: critical
    - alert: MissingDataClassification
      annotations:
        description: '{{ $value }} pods are missing the required ''data-classification''
          label.

          All resources must have proper data classification.

          '
        runbook_url: https://governance.example.com/runbooks/data-classification
        summary: Resources missing data classification label
      expr: "count(\n  kube_pod_info{label_data_classification=\"\"}\n) > 10\n"
      for: 30m
      labels:
        category: governance
        component: security
        severity: warning
    - alert: LegacyNamingPatternInUse
      annotations:
        description: '{{ $value }} resources are still using legacy naming patterns.

          Plan migration to new naming convention.

          '
        runbook_url: https://governance.example.com/runbooks/legacy-migration
        summary: Legacy naming patterns still in use
      expr: 'governance_naming_legacy_pattern_usage > 0

        '
      for: 7d
      labels:
        category: governance
        component: naming
        severity: info
  - interval: 5m
    name: governance.change_management
    rules:
    - alert: ChangeSuccessRateLow
      annotations:
        description: 'Change success rate is {{ $value | humanizePercentage }}, below
          the 95% threshold.

          Review recent failures and improve change procedures.

          '
        runbook_url: https://governance.example.com/runbooks/change-success-rate
        summary: Change success rate below threshold
      expr: "(\n  sum(rate(governance_changes_successful_total[24h])) /\n  sum(rate(governance_changes_total[24h]))\n\
        ) * 100 < 95\n"
      for: 1h
      labels:
        category: governance
        component: change-management
        severity: warning
    - alert: EmergencyChangeRateHigh
      annotations:
        description: 'Emergency changes account for {{ $value | humanizePercentage
          }} of all changes,

          exceeding the 5% threshold. Review change planning processes.

          '
        runbook_url: https://governance.example.com/runbooks/emergency-changes
        summary: Emergency change rate is too high
      expr: "(\n  sum(rate(governance_changes_total{type=\"紧急变更\"}[7d])) /\n  sum(rate(governance_changes_total[7d]))\n\
        ) * 100 > 5\n"
      for: 1d
      labels:
        category: governance
        component: change-management
        severity: warning
    - alert: UnapprovedChangeDetected
      annotations:
        description: '{{ $value }} unapproved changes detected.

          All changes must go through proper approval process.

          Change ID: {{ $labels.change_id }}

          '
        runbook_url: https://governance.example.com/runbooks/unapproved-changes
        summary: Unapproved change detected
      expr: 'governance_changes_unapproved_total > 0

        '
      labels:
        category: governance
        component: change-management
        severity: critical
  - interval: 5m
    name: governance.exceptions
    rules:
    - alert: ExceptionExpiringSoon
      annotations:
        description: 'Exception {{ $labels.exception_id }} will expire in less than
          7 days.

          Review and renew if necessary, or implement remediation.

          '
        runbook_url: https://governance.example.com/runbooks/exception-renewal
        summary: Governance exception expiring soon
      expr: '(governance_exception_expiry_timestamp - time()) < 7 * 24 * 3600

        '
      labels:
        category: governance
        component: exception-management
        severity: warning
    - alert: ExpiredExceptionInUse
      annotations:
        description: '{{ $value }} expired exceptions are still active.

          These must be revoked or renewed immediately.

          Exception ID: {{ $labels.exception_id }}

          '
        runbook_url: https://governance.example.com/runbooks/expired-exceptions
        summary: Expired exception still in use
      expr: 'governance_exception_expired_active > 0

        '
      labels:
        category: governance
        component: exception-management
        severity: critical
    - alert: HighRiskExceptionCountHigh
      annotations:
        description: '{{ $value }} high-risk exceptions are currently active.

          Review and reduce high-risk exceptions.

          '
        runbook_url: https://governance.example.com/runbooks/high-risk-exceptions
        summary: Too many high-risk exceptions
      expr: 'count(governance_exception_risk_level{level="高"}) > 5

        '
      for: 1d
      labels:
        category: governance
        component: exception-management
        severity: warning
  - interval: 5m
    name: governance.health
    rules:
    - alert: GovernanceHealthScoreLow
      annotations:
        description: 'Overall governance health score is {{ $value }}, below the 70
          threshold.

          Review compliance metrics and address issues.

          '
        runbook_url: https://governance.example.com/runbooks/health-score
        summary: Governance health score is low
      expr: 'governance_health_score < 70

        '
      for: 1h
      labels:
        category: governance
        severity: warning
    - alert: UnresolvedAuditFindings
      annotations:
        description: '{{ $value }} high-severity audit findings remain unresolved
          for over 7 days.

          Review and prioritize remediation.

          '
        runbook_url: https://governance.example.com/runbooks/audit-findings
        summary: Unresolved high-severity audit findings
      expr: 'count(governance_audit_findings{status="open",severity=~"critical|high"})
        > 10

        '
      for: 7d
      labels:
        category: governance
        component: audit
        severity: warning
