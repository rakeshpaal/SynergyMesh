apiVersion: machinenativeops.io/v2
kind: RemediationPlaybook
metadata:
  description: æ ‡å‡†å‘½åè¿è§„è‡ªåŠ¨ä¿®å¤æµç¨‹
  labels:
    machinenativeops.io/automation: enabled
    machinenativeops.io/category: remediation
    machinenativeops.io/module: naming-governance
  name: naming-violation-auto-remediation
spec:
  audit:
    enabled: true
    fields:
    - timestamp
    - playbook_name
    - trigger_type
    - violations_count
    - fixed_count
    - failed_count
    - duration
    - status
    - error_message
    logLevel: info
    storage:
      index: governance-remediation-logs
      retention: 90d
      type: elasticsearch
  notifications:
    onFailure:
    - channel: '#governance-alerts'
      message: 'âŒ **è‡ªåŠ¨ä¿®å¤å¤±è´¥**

        é”™è¯¯: {{ .error }}

        éœ€è¦äººå·¥ä»‹å…¥

        Runbook: https://wiki.example.com/runbooks/remediation-failure

        '
    onRollback:
    - channel: '#governance-alerts'
      message: 'âª **æ‰§è¡Œå›æ»š**

        åŸå› : {{ .rollback_reason }}

        çŠ¶æ€: {{ .rollback_status }}

        '
    onStart:
    - channel: '#governance-alerts'
      message: 'ğŸ”§ **è‡ªåŠ¨ä¿®å¤å¼€å§‹**

        è§¦å‘å™¨: {{ .trigger.type }}

        è¿è§„æ•°é‡: {{ .violations_count }}

        ç¯å¢ƒ: {{ .environment }}

        '
    onSuccess:
    - channel: '#governance-alerts'
      message: 'âœ… **è‡ªåŠ¨ä¿®å¤æˆåŠŸ**

        ä¿®å¤æ•°é‡: {{ .fixed_count }}

        è€—æ—¶: {{ .duration }}

        æŠ¥å‘Š: {{ .report_url }}

        '
  performance:
    maxConcurrent: 3
    throttle:
      enabled: true
      maxPerHour: 10
    timeout: 30m
  rollback:
    automatic: true
    enabled: true
    steps:
    - action:
        script:
          args:
          - /tmp/backup/
          language: bash
          path: tools/governance/bash/restore_names.sh
        type: script
      name: è¿˜åŸèµ„æºå‘½å
      timeout: 10m
    - action:
        script:
          args:
          - /tmp/backup/
          language: bash
          path: tools/governance/bash/verify_rollback.sh
        type: script
      name: éªŒè¯å›æ»šæˆåŠŸ
      timeout: 5m
    - action:
        script:
          args:
          - --type
          - remediation
          - --status
          - failed_rollback
          language: python
          path: tools/governance/python/update_metrics.py
        type: script
      name: æ›´æ–°å¤±è´¥æŒ‡æ ‡
    trigger:
    - éªŒè¯å¤±è´¥
    - èµ„æºå¥åº·æ£€æŸ¥å¤±è´¥
    - é”™è¯¯ç‡ > 5%
  steps:
  - action:
      script:
        args:
        - --severity
        - '{{ .trigger.severity | default "all" }}'
        - --environment
        - '{{ .trigger.environment | default "all" }}'
        - --output
        - /tmp/violations.json
        env:
          KUBECONFIG: /path/to/kubeconfig
          LOG_LEVEL: info
        language: python
        path: tools/governance/python/check_naming_violation.py
      type: script
    continueOnError: false
    description: æ‰«æå¹¶è¯†åˆ«æ‰€æœ‰è¿åå‘½åè§„èŒƒçš„èµ„æº
    name: æ£€æŸ¥å‘½åè¿è§„èµ„æº
    retry:
      backoff: exponential
      enabled: true
      maxAttempts: 3
    timeout: 5m
  - action:
      script:
        args:
        - --input
        - /tmp/violations.json
        - --output
        - /tmp/suggestions.json
        - --policy
        - policies/naming/
        language: python
        path: tools/governance/python/generate_suggestions.py
      type: script
    continueOnError: false
    description: åˆ†æè¿è§„èµ„æºå¹¶ç”Ÿæˆç¬¦åˆè§„èŒƒçš„å‘½åå»ºè®®
    name: ç”Ÿæˆä¿®å¤å»ºè®®
    timeout: 3m
  - action:
      script:
        args:
        - --suggestions
        - /tmp/suggestions.json
        - --check-conflicts
        - 'true'
        language: python
        path: tools/governance/python/validate_suggestions.py
      type: script
    continueOnError: false
    description: ç¡®ä¿å»ºè®®çš„å‘½åç¬¦åˆè§„èŒƒä¸”ä¸ä¼šäº§ç”Ÿå†²çª
    name: éªŒè¯ä¿®å¤å»ºè®®
    timeout: 2m
  - action:
      script:
        args:
        - /tmp/violations.json
        - /tmp/backup/
        language: bash
        path: tools/governance/bash/backup_resources.sh
      type: script
    continueOnError: false
    description: å¤‡ä»½èµ„æºå½“å‰çŠ¶æ€ä»¥æ”¯æŒå›æ»š
    name: å¤‡ä»½å½“å‰çŠ¶æ€
    timeout: 5m
  - action:
      script:
        args:
        - --suggestions
        - /tmp/suggestions.json
        - --dry-run
        - 'false'
        - --update-labels
        - 'true'
        - --backup-dir
        - /tmp/backup/
        env:
          APPLY_CHANGES: 'true'
        language: python
        path: tools/governance/python/rename_and_label.py
      type: script
    continueOnError: false
    description: æ ¹æ®å»ºè®®è‡ªåŠ¨é‡å‘½åèµ„æºå¹¶æ›´æ–°æ ‡ç­¾
    name: è‡ªåŠ¨ä¿®æ­£å‘½åä¸æ ‡ç­¾
    retry:
      backoff: linear
      enabled: true
      maxAttempts: 2
    timeout: 10m
  - action:
      script:
        args:
        - --resources
        - /tmp/violations.json
        - --strict
        - 'true'
        language: python
        path: tools/governance/python/verify_compliance.py
      type: script
    continueOnError: false
    description: ç¡®è®¤èµ„æºå·²æ­£ç¡®é‡å‘½åä¸”ç¬¦åˆè§„èŒƒ
    name: éªŒè¯ä¿®å¤ç»“æœ
    timeout: 3m
  - action:
      script:
        args:
        - --type
        - remediation
        - --status
        - success
        language: python
        path: tools/governance/python/update_metrics.py
      type: script
    continueOnError: true
    description: æ›´æ–° Prometheus æŒ‡æ ‡ä»¥åæ˜ ä¿®å¤ç»“æœ
    name: æ›´æ–°ç›‘æ§æŒ‡æ ‡
    timeout: 1m
  - action:
      script:
        args:
        - --violations
        - /tmp/violations.json
        - --suggestions
        - /tmp/suggestions.json
        - --output
        - /tmp/report.html
        - --notify
        - 'true'
        language: python
        path: tools/governance/python/report_patch_result.py
      type: script
    continueOnError: true
    description: ç”Ÿæˆè¯¦ç»†çš„ä¿®å¤æŠ¥å‘Šå¹¶å‘é€é€šçŸ¥
    name: æŠ¥å‘Šä¿®å¤ç»“æœ
    timeout: 2m
  triggers:
  - condition:
      alertName: NamingPolicyViolation
      severity: critical
    description: å½“æ£€æµ‹åˆ° critical çº§åˆ«çš„å‘½åè¿è§„æ—¶è‡ªåŠ¨è§¦å‘
    source: Prometheus
    type: alert
  - condition:
      alertName: ProductionNamingViolation
    description: ç”Ÿäº§ç¯å¢ƒå‘½åè¿è§„ç«‹å³è§¦å‘
    source: Prometheus
    type: alert
  - description: å®šæœŸæ‰«æå’Œä¿®å¤å‘½åè¿è§„
    schedule: 0 2 * * *
    type: schedule
  - description: æ”¯æŒæ‰‹åŠ¨è§¦å‘ä¿®å¤æµç¨‹
    type: manual
  verification:
    checks:
    - command: python tools/governance/python/verify_compliance.py --resources /tmp/violations.json
      condition: exit code == 0
      name: å‘½ååˆè§„æ£€æŸ¥
      timeout: 2m
      type: command
    - command: kubectl get pods --all-namespaces -o json | jq '.items[].status.phase'
        | grep -v Running | wc -l
      condition: stdout == 0
      name: èµ„æºå¥åº·æ£€æŸ¥
      timeout: 1m
      type: command
    - condition: '> 95'
      metric: naming_compliance_rate
      name: åˆè§„ç‡æ£€æŸ¥
      timeout: 1m
      type: metric
    enabled: true
