apiVersion: machinenativeops.io/v2
kind: ExampleEnvironmentConfig
metadata:
  created: '2025-12-19'
  name: example-runtime-environments
  namespace: machinenativenops
  version: 1.0.0
spec:
  development_environments:
  - description: 本地开发环境
    environment_variables:
      API_BASE_URL: http://localhost:3000
      DB_HOST: localhost
      DB_NAME: automation_dev
      DB_PORT: '5432'
      DEBUG: automation:*
      LOG_LEVEL: debug
      NODE_ENV: development
      REDIS_HOST: localhost
      REDIS_PORT: '6379'
    name: local_development
    prerequisites:
    - install_command: nvm install 20
      name: nodejs
      required: true
      version: 20.x
    - install_command: pyenv install 3.10
      name: python
      required: true
      version: 3.10+
    - install_url: https://docs.docker.com/get-docker/
      name: docker
      required: true
      version: 24.x
    - install_command: brew install docker-compose
      name: docker-compose
      required: true
      version: 2.x
    - install_command: brew install postgresql@15
      name: postgresql
      required: false
      version: 15.x
    - install_command: brew install redis
      name: redis
      required: false
      version: 7.x
    setup_commands:
    - command: npm install
      description: 安装Node.js依赖
      name: install_dependencies
    - command: python -m venv venv && source venv/bin/activate && pip install -r requirements.txt
      description: 设置Python虚拟环境
      name: setup_python_env
    - command: docker-compose up -d
      description: 启动依赖服务
      name: start_services
      working_directory: docker/
    - command: npm run db:migrate
      description: 运行数据库迁移
      name: run_migrations
    - command: npm run db:seed
      description: 填充测试数据
      name: seed_data
    type: local
  - configuration:
      image: gitpod/workspace-full:latest
      ports:
      - description: API服务器
        onOpen: open-preview
        port: 3000
      - description: Web前端
        onOpen: open-browser
        port: 8080
      - description: PostgreSQL
        onOpen: ignore
        port: 5432
      tasks:
      - command: npm run dev
        init: 'npm install

          pip install -r requirements.txt

          docker-compose up -d

          '
        name: init
      vscode:
        extensions:
        - dbaeumer.vscode-eslint
        - esbenp.prettier-vscode
        - ms-python.python
        - ms-azuretools.vscode-docker
    description: 云端开发环境（Gitpod）
    name: cloud_development
    provider: gitpod
    type: cloud
  environment_variables:
    common:
      LANG: en_US.UTF-8
      LOG_FORMAT: json
      LOG_TIMESTAMP: 'true'
      TZ: UTC
    development:
      DEBUG: '*'
      ENABLE_HOT_RELOAD: 'true'
      ENABLE_SOURCE_MAPS: 'true'
      LOG_LEVEL: debug
      NODE_ENV: development
    production:
      ENABLE_MONITORING: 'true'
      ENABLE_TRACING: 'true'
      LOG_LEVEL: warn
      NODE_ENV: production
      RATE_LIMIT_ENABLED: 'true'
    staging:
      ENABLE_PROFILING: 'true'
      LOG_LEVEL: info
      NODE_ENV: staging
    testing:
      COVERAGE_ENABLED: 'true'
      LOG_LEVEL: error
      NODE_ENV: test
      TEST_TIMEOUT: '30000'
  production_environments:
  - autoscaling:
      enabled: true
      maxReplicas: 10
      minReplicas: 3
      targetCPUUtilizationPercentage: 70
      targetMemoryUtilizationPercentage: 80
    description: 生产K8s集群
    monitoring:
      datadog:
        apiKey: ${DATADOG_API_KEY}
        enabled: true
      enabled: true
      prometheus:
        enabled: true
        port: 9090
    name: production_kubernetes
    namespace: examples-production
    resources:
      limits:
        cpu: '2'
        memory: 4Gi
      requests:
        cpu: '1'
        memory: 2Gi
    security:
      networkPolicy:
        egress:
        - ports:
          - port: 443
            protocol: TCP
          - port: 5432
            protocol: TCP
          to:
          - namespaceSelector: {}
        enabled: true
        ingress:
        - from:
          - namespaceSelector:
              matchLabels:
                name: ingress-nginx
      podSecurityPolicy: restricted
    type: kubernetes
  testing_environments:
  - configuration:
      runs-on: ubuntu-latest
      services:
        postgres:
          env:
            POSTGRES_DB: automation_test
            POSTGRES_PASSWORD: postgres
          image: postgres:15
          options: --health-cmd pg_isready --health-interval 10s --health-timeout
            5s --health-retries 5
          ports:
          - 5432:5432
        redis:
          image: redis:7
          options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout
            5s --health-retries 5
          ports:
          - 6379:6379
      steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: setup_node
        uses: actions/setup-node@v3
        with:
          cache: npm
          node-version: 20.x
      - name: setup_python
        uses: actions/setup-python@v4
        with:
          cache: pip
          python-version: '3.10'
      - name: install_dependencies
        run: 'npm ci

          pip install -r requirements.txt

          '
      - env:
          DB_HOST: localhost
          DB_NAME: automation_test
          DB_PASSWORD: postgres
          DB_PORT: 5432
          DB_USER: postgres
          NODE_ENV: test
        name: run_tests
        run: 'npm test

          pytest

          '
      - name: upload_coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
    description: GitHub Actions CI环境
    name: ci_environment
    type: github_actions
  - deployment:
      containers:
      - env:
        - name: NODE_ENV
          value: sandbox
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              key: host
              name: db-credentials
        image: machinenativeops/examples:latest
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        name: app
        ports:
        - containerPort: 3000
          name: http
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
      replicas: 1
      strategy:
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 0
        type: RollingUpdate
    description: K8s沙箱测试环境
    name: sandbox_environment
    namespace: examples-sandbox
    resources:
      limits:
        cpu: '1'
        ephemeral-storage: 2Gi
        memory: 1Gi
      requests:
        cpu: 500m
        ephemeral-storage: 1Gi
        memory: 512Mi
    services:
    - name: postgres
      ports:
      - port: 5432
      type: ClusterIP
    - name: redis
      ports:
      - port: 6379
      type: ClusterIP
    type: kubernetes
  tools:
    build_tools:
      babel:
        config: babel.config.js
        version: 7.x
      typescript:
        compiler: tsc
        config: tsconfig.json
        version: '5.3'
      webpack:
        config: webpack.config.js
        version: 5.x
    package_managers:
      maven:
        local_repo: ~/.m2/repository
        version: 3.9.x
      npm:
        cache_dir: ~/.npm
        registry: https://registry.npmjs.org/
        version: 10.x
      pip:
        cache_dir: ~/.cache/pip
        index_url: https://pypi.org/simple
        version: 23.x
    testing_tools:
      jest:
        config: jest.config.js
        version: 29.x
      playwright:
        browsers:
        - chromium
        - firefox
        - webkit
        version: '1.40'
      pytest:
        config: pytest.ini
        version: 7.x
