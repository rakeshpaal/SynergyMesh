name: SBOM Generation and Signing
true:
  push:
    branches:
    - main
    tags:
    - v*.*.*
  release:
    types:
    - published
  workflow_dispatch: null
env:
  COSIGN_EXPERIMENTAL: 1
  SBOM_FORMAT: cyclonedx-json
  SBOM_VERSION: '1.5'
jobs:
  generate-sbom:
    name: ç”Ÿæˆèˆ‡ç°½ç«  SBOM
    permissions:
      contents: write
      id-token: write
      packages: write
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: ðŸ”§ å®‰è£ Syft
      run: 'curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh
        | sh -s -- -b /usr/local/bin

        syft version

        '
    - name: ðŸ”§ å®‰è£ Cosign
      uses: sigstore/cosign-installer@v3
      with:
        cosign-release: v2.2.1
    - name: ðŸ“¦ ç”Ÿæˆ SBOM - å°ˆæ¡ˆæ ¹ç›®éŒ„
      run: "echo \"\U0001F50D æŽƒæå°ˆæ¡ˆä¾è³´...\"\nsyft packages dir:. \\\n  -o cyclonedx-json\
        \ \\\n  --file sbom/project-sbom.json\n\necho \"âœ… SBOM å·²ç”Ÿæˆ: sbom/project-sbom.json\"\
        \n\n# ç”Ÿæˆäººé¡žå¯è®€ç‰ˆæœ¬\nsyft packages dir:. \\\n  -o table \\\n  --file sbom/project-sbom.txt\n"
    - name: ðŸ“¦ ç”Ÿæˆ SBOM - Intelligent Hyperautomation
      run: "if [ -d \"intelligent-hyperautomation\" ]; then\n  echo \"\U0001F50D æŽƒæ\
        \ intelligent-hyperautomation...\"\n  syft packages dir:intelligent-hyperautomation\
        \ \\\n    -o cyclonedx-json \\\n    --file sbom/intelligent-hyperautomation-sbom.json\n\
        \  \n  # æ›´æ–°ä½”ä½ç¬¦\n  cp sbom/intelligent-hyperautomation-sbom.json \\\n     intelligent-hyperautomation/docs/sbom-placeholder.json\n\
        \  \n  echo \"âœ… Intelligent Hyperautomation SBOM å·²ç”Ÿæˆ\"\nfi\n"
    - name: ðŸ“¦ ç”Ÿæˆ SBOM - Contracts L1
      run: "if [ -d \"core/contract_service/contracts-L1\" ]; then\n  echo \"\U0001F50D\
        \ æŽƒæ Contracts L1...\"\n  syft packages dir:core/contract_service/contracts-L1\
        \ \\\n    -o cyclonedx-json \\\n    --file sbom/contracts-l1-sbom.json\n \
        \ \n  echo \"âœ… Contracts L1 SBOM å·²ç”Ÿæˆ\"\nfi\n"
    - name: ðŸ” ç°½ç«  SBOM - Keyless (Sigstore)
      run: "echo \"\U0001F511 ä½¿ç”¨ Sigstore é€²è¡Œ keyless ç°½ç« ...\"\n\n# ç°½ç« å°ˆæ¡ˆ SBOM\nif [\
        \ -f \"sbom/project-sbom.json\" ]; then\n  cosign sign-blob \\\n    --yes\
        \ \\\n    --output-signature sbom/project-sbom.sig \\\n    --output-certificate\
        \ sbom/project-sbom.pem \\\n    sbom/project-sbom.json\n  \n  echo \"âœ… å°ˆæ¡ˆ\
        \ SBOM å·²ç°½ç« \"\nfi\n\n# ç°½ç«  Intelligent Hyperautomation SBOM\nif [ -f \"sbom/intelligent-hyperautomation-sbom.json\"\
        \ ]; then\n  cosign sign-blob \\\n    --yes \\\n    --output-signature sbom/intelligent-hyperautomation-sbom.sig\
        \ \\\n    --output-certificate sbom/intelligent-hyperautomation-sbom.pem \\\
        \n    sbom/intelligent-hyperautomation-sbom.json\n  \n  echo \"âœ… Intelligent\
        \ Hyperautomation SBOM å·²ç°½ç« \"\nfi\n"
    - name: ðŸ“Š ç”Ÿæˆ SBOM æ‘˜è¦å ±å‘Š
      run: "cat > sbom/sbom-summary.json << EOF\n{\n  \"generation_timestamp\": \"\
        $(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\",\n  \"workflow_run_id\": \"${{ github.run_id\
        \ }}\",\n  \"commit_sha\": \"${{ github.sha }}\",\n  \"branch\": \"${{ github.ref_name\
        \ }}\",\n  \"repository\": \"${{ github.repository }}\",\n  \"sbom_format\"\
        : \"${SBOM_FORMAT}\",\n  \"sbom_version\": \"${SBOM_VERSION}\",\n  \"signing_method\"\
        : \"cosign-keyless\",\n  \"generated_sboms\": [\n    {\n      \"name\": \"\
        project-sbom.json\",\n      \"path\": \"sbom/project-sbom.json\",\n      \"\
        signature\": \"sbom/project-sbom.sig\",\n      \"certificate\": \"sbom/project-sbom.pem\"\
        \n    },\n    {\n      \"name\": \"intelligent-hyperautomation-sbom.json\"\
        ,\n      \"path\": \"sbom/intelligent-hyperautomation-sbom.json\",\n     \
        \ \"signature\": \"sbom/intelligent-hyperautomation-sbom.sig\",\n      \"\
        certificate\": \"sbom/intelligent-hyperautomation-sbom.pem\"\n    }\n  ],\n\
        \  \"verification\": {\n    \"command\": \"cosign verify-blob --signature\
        \ <sig> --certificate <pem> --certificate-identity-regexp '.*' --certificate-oidc-issuer-regexp\
        \ '.*' <sbom>\",\n    \"tool\": \"cosign >= v2.2.0\"\n  },\n  \"metadata\"\
        : {\n    \"language\": \"zh-TW\",\n    \"compliance\": [\"SLSA Level 2\",\
        \ \"CycloneDX 1.5\"]\n  }\n}\nEOF\n\necho \"\U0001F4CB SBOM æ‘˜è¦å ±å‘Šå·²ç”Ÿæˆ\"\ncat\
        \ sbom/sbom-summary.json | jq '.'\n"
    - name: ðŸ“¤ ä¸Šå‚³ SBOM Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sbom-${{ github.sha }}
        path: 'sbom/*.json

          sbom/*.sig

          sbom/*.pem

          sbom/*.txt

          '
        retention-days: 365
    - name: ðŸ“ˆ ç”Ÿæˆæ‘˜è¦
      run: "echo \"## \U0001F512 SBOM ç”Ÿæˆèˆ‡ç°½ç« æ‘˜è¦\" >> $GITHUB_STEP_SUMMARY\necho \"\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"### \U0001F4E6 ç”Ÿæˆçš„ SBOM\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\n\nfor sbom in sbom/*.json; do\n  if [ -f\
        \ \"$sbom\" ]; then\n    filename=$(basename \"$sbom\")\n    size=$(ls -lh\
        \ \"$sbom\" | awk '{print $5}')\n    echo \"- âœ… $filename ($size)\" >> $GITHUB_STEP_SUMMARY\n\
        \  fi\ndone\n\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"### \U0001F510 ç°½ç« é©—è­‰\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"æ‰€æœ‰ SBOM\
        \ å·²ä½¿ç”¨ Sigstore keyless ç°½ç« \" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"**é©—è­‰å‘½ä»¤:**\" >> $GITHUB_STEP_SUMMARY\necho \"\\`\\`\\`bash\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"cosign verify-blob \\\\\" >> $GITHUB_STEP_SUMMARY\necho \"  --signature\
        \ sbom/project-sbom.sig \\\\\" >> $GITHUB_STEP_SUMMARY\necho \"  --certificate\
        \ sbom/project-sbom.pem \\\\\" >> $GITHUB_STEP_SUMMARY\necho \"  --certificate-identity-regexp\
        \ '.*' \\\\\" >> $GITHUB_STEP_SUMMARY\necho \"  --certificate-oidc-issuer-regexp\
        \ '.*' \\\\\" >> $GITHUB_STEP_SUMMARY\necho \"  sbom/project-sbom.json\" >>\
        \ $GITHUB_STEP_SUMMARY\necho \"\\`\\`\\`\" >> $GITHUB_STEP_SUMMARY\necho \"\
        \" >> $GITHUB_STEP_SUMMARY\necho \"### \U0001F4CA Artifact è³‡è¨Š\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\necho \"- \U0001F4E6 Artifact åç¨±: \\`sbom-${{\
        \ github.sha }}\\`\" >> $GITHUB_STEP_SUMMARY\necho \"- â° ä¿ç•™æœŸé™: 365 å¤©\" >>\
        \ $GITHUB_STEP_SUMMARY\necho \"- \U0001F517 Commit: \\`${{ github.sha }}\\\
        `\" >> $GITHUB_STEP_SUMMARY\n"
