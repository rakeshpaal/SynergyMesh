apiVersion: machinenativeops.io/v2
kind: PrometheusRule
metadata:
  labels:
    machinenativeops.io/app: contracts-service
    machinenativeops.io/team: contracts-team
    machinenativeops.io/prometheus: kube-prometheus
  name: contracts-service-alerts
spec:
  groups:
  - interval: 30s
    name: contracts-service
    rules:
    - alert: ContractsServicePodDown
      annotations:
        description: Pod {{ $labels.pod }} is down for more than 5 minutes
        runbook_url: https://github.com/we-can-fix/machinenativeops/blob/main/docs/runbooks/contracts-service-down.md
        summary: Contracts Service Pod is down
      expr: up{job="contracts-service"} == 0
      for: 5m
      labels:
        namespace_io_environment: production
        severity: critical
        team: contracts-team
    - alert: ContractsServiceHighErrorRate
      annotations:
        description: 'Error rate is {{ $value | humanizePercentage }} (threshold:
          5%)'
        runbook_url: https://github.com/we-can-fix/machinenativeops/blob/main/docs/runbooks/high-error-rate.md
        summary: High error rate in Contracts Service
      expr: "rate(http_requests_total{job=\"contracts-service\",status=~\"5..\"}[5m])\
        \ \n/ \nrate(http_requests_total{job=\"contracts-service\"}[5m]) > 0.05\n"
      for: 5m
      labels:
        severity: warning
        team: contracts-team
    - alert: ContractsServiceHighLatency
      annotations:
        description: 'P99 latency is {{ $value }}s (threshold: 1s)'
        runbook_url: https://github.com/we-can-fix/machinenativeops/blob/main/docs/runbooks/high-latency.md
        summary: High latency in Contracts Service
      expr: "histogram_quantile(0.99, \n  rate(http_request_duration_seconds_bucket{job=\"\
        contracts-service\"}[5m])\n) > 1\n"
      for: 5m
      labels:
        severity: warning
        team: contracts-team
    - alert: ContractsServiceFrequentRestarts
      annotations:
        description: Pod {{ $labels.pod }} is restarting frequently
        runbook_url: https://github.com/we-can-fix/machinenativeops/blob/main/docs/runbooks/pod-restarts.md
        summary: Frequent pod restarts in Contracts Service
      expr: "rate(kube_pod_container_status_restarts_total{\n  pod=~\"contracts-service-.*\"\
        \n}[15m]) > 0.1\n"
      for: 5m
      labels:
        severity: warning
        team: contracts-team
    - alert: ContractsServiceHighMemoryUsage
      annotations:
        description: 'Memory usage is {{ $value | humanizePercentage }} (threshold:
          90%)'
        runbook_url: https://github.com/we-can-fix/machinenativeops/blob/main/docs/runbooks/high-memory.md
        summary: High memory usage in Contracts Service
      expr: "container_memory_usage_bytes{pod=~\"contracts-service-.*\"} \n/ \ncontainer_spec_memory_limit_bytes{pod=~\"\
        contracts-service-.*\"} > 0.9\n"
      for: 5m
      labels:
        severity: warning
        team: contracts-team
    - alert: ContractsServiceHighCPUUsage
      annotations:
        description: 'CPU usage is {{ $value | humanizePercentage }} (threshold: 90%)'
        runbook_url: https://github.com/we-can-fix/machinenativeops/blob/main/docs/runbooks/high-cpu.md
        summary: High CPU usage in Contracts Service
      expr: 'rate(container_cpu_usage_seconds_total{pod=~"contracts-service-.*"}[5m])

        / on(pod) group_left()

        (container_spec_cpu_quota{pod=~"contracts-service-.*"} / container_spec_cpu_period{pod=~"contracts-service-.*"})
        > 0.9

        '
      for: 5m
      labels:
        severity: warning
        team: contracts-team
    - alert: ContractsServicePodNotReady
      annotations:
        description: Pod {{ $labels.pod }} has been not ready for more than 10 minutes
        runbook_url: https://github.com/we-can-fix/machinenativeops/blob/main/docs/runbooks/pod-not-ready.md
        summary: Contracts Service Pod not ready
      expr: "kube_pod_status_ready{\n  pod=~\"contracts-service-.*\",\n  condition=\"\
        true\"\n} == 0\n"
      for: 10m
      labels:
        severity: warning
        team: contracts-team
