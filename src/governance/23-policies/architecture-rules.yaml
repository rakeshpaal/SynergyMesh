api_policies:
  api_documentation:
    enforcement: CI-warning
    format:
    - OpenAPI 3.0 OR
    - Behavior contract YAML
    required_for:
    - Public APIs
    - Service interfaces
    - Cross-domain interfaces
  api_stability:
  - constraint: Breaking changes prohibited
    enforcement: API-compatibility-check
    lifecycle: active
    process: Version bump and deprecation notice
  - constraint: Breaking changes allowed with notice
    enforcement: documentation-review
    lifecycle: experimental
    process: Document in CHANGELOG
  - constraint: No new features, security fixes only
    enforcement: code-review
    lifecycle: deprecated
    process: Migration guide required
data_flow_policies:
  cross_layer_data:
  - constraint: Must go through services layer
    enforcement: static-analysis
    exceptions: []
    source_layer: apps
    target_layer: core
  - constraint: Must use abstraction layer
    enforcement: architecture-review
    exceptions: []
    source_layer: services
    target_layer: infrastructure
  - constraint: Cannot cross domain boundaries without encryption
    data_type: PII
    enforcement: data-flow-analysis
  - constraint: Cannot be logged or stored in plain text
    data_type: credentials
    enforcement: runtime-validation
dependency_anti_patterns:
  prohibited_patterns:
  - description: Lower layers cannot depend on higher layers
    enforcement: CI-blocking
    name: Upward Dependencies
    pattern: 'core/* depends on services/*

      core/* depends on apps/*

      runtime/* depends on core/*

      '
    severity: critical
  - description: No circular dependencies between modules
    enforcement: CI-blocking
    name: Circular Module Dependencies
    pattern: 'module A -> module B -> module A

      '
    severity: critical
  - description: Apps must use service layer for data access
    enforcement: code-review
    exceptions:
    - apps/*/migrations/*
    name: Direct Database Access from Apps
    pattern: 'apps/* imports database driver

      '
    severity: high
  - description: No single module should have > 50 dependencies
    enforcement: architecture-review
    name: God Object
    pattern: 'module with > 50 imports

      '
    severity: high
  - description: Cross-domain calls must go through defined interfaces
    enforcement: code-review
    exceptions:
    - cross_domain_interfaces defined in layers-domains.yaml
    name: Cross-Domain Direct Calls
    pattern: 'domain A module directly imports domain B module

      '
    severity: medium
description: Executable architecture policies for automated validation
id: machinenativeops.architecture-rules
language_policies:
  globally_prohibited:
    exceptions:
    - path: legacy/*
      reason: Legacy code scheduled for migration
      removal_date: '2026-12-31'
    - approval_required: '@architecture-team'
      path: experiments/*
      reason: Experimental sandbox
    - approval_required: '@security-team + @architecture-team'
      condition: Emergency security patch
      documentation_required: true
      reason: Critical security fix for production system
    languages:
    - php
    - perl
    - ruby
    migration_timeline:
      milestone_1: 2025-06-30 - No new code in deprecated languages
      milestone_2: 2026-06-30 - 50% reduction in existing code
      milestone_3: 2026-12-31 - Complete migration
      start_date: '2025-01-01'
      target_completion: '2026-12-31'
    reason: Deprecated languages - consolidate to Python/TypeScript/Go
  layer_language_constraints:
    apps:
      allowed:
      - typescript
      - python
      - go
      preferred:
      - typescript
      prohibited:
      - php
      - perl
      rationale: Applications use modern web technologies
    core:
      allowed:
      - python
      - typescript
      - go
      preferred:
      - python
      - typescript
      prohibited:
      - php
      - perl
      - ruby
      rationale: Core platform uses modern, type-safe languages
    governance:
      allowed:
      - yaml
      - json
      - rego
      - python
      prohibited:
      - typescript
      - go
      - java
      rationale: Governance should be declarative and policy-oriented
    infrastructure:
      allowed:
      - yaml
      - json
      - shell
      prohibited:
      - python
      - typescript
      - go
      - java
      rationale: Infrastructure definitions should be declarative
    services:
      allowed:
      - typescript
      - python
      - go
      preferred:
      - typescript
      prohibited:
      - php
      - perl
      - ruby
      rationale: Services prioritize TypeScript for consistency
module_structure:
  prohibited_structures:
  - constraint: Maximum depth of 5 levels
    enforcement: CI-warning
    pattern: Deeply nested directories
  - constraint: One primary language per module directory
    enforcement: architecture-review
    exceptions:
    - test files
    - build scripts
    pattern: Mixed language in single module
  required_files:
  - enforcement: CI-warning
    pattern: core/*
    required:
    - README.md
    - pyproject.toml OR package.json OR go.mod
  - enforcement: CI-warning
    pattern: services/*
    required:
    - README.md
    - package.json OR go.mod
    - Dockerfile
  - enforcement: CI-warning
    pattern: apps/*
    required:
    - README.md
    - package.json
performance_policies:
  response_time_slas:
  - constraint: p99 < 500ms for critical paths
    enforcement: performance-tests
    layer: core
  - constraint: p99 < 1s for API endpoints
    enforcement: performance-tests
    layer: services
  - constraint: Time to interactive < 3s
    enforcement: lighthouse-ci
    layer: apps
references:
  architecture_governance_matrix: governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md
  behavior_contracts: governance/37-behavior-contracts/
  layers_domains: governance/01-architecture/config/layers-domains.yaml
  module_mapping: config/system-module-map.yaml
  ownership_map: governance/34-config/ownership-map.yaml
security_policies:
  network_access:
    allowed_layers:
    - services
    - apps
    - automation
    prohibited_layers:
    - governance
    - infrastructure
    restricted_layers:
    - core
    - runtime
    rules:
    - constraint: Can only access internal services, no external network
      enforcement: network-policy
      layer: core
    - constraint: No network access permitted
      enforcement: compile-time
      layer: governance
  secret_management:
    allowed_secret_sources:
    - environment variables
    - kubernetes secrets
    - vault integration
    prohibited:
    - enforcement: pre-commit-hook
      location: source code
    - enforcement: CI validation
      exceptions:
      - '*.env.example'
      location: configuration files
    - enforcement: log-scrubbing
      location: logs
    rules:
    - constraint: Secrets must use dedicated secret manager
      enforcement: code-review
      layers:
      - core
      - services
      - apps
testing_policies:
  coverage_requirements:
  - critical_paths_coverage: 95
    enforcement: CI-blocking
    layer: core
    min_coverage: 80
  - critical_paths_coverage: 90
    enforcement: CI-blocking
    layer: services
    min_coverage: 75
  - critical_paths_coverage: 80
    enforcement: CI-warning
    layer: apps
    min_coverage: 60
  - critical_paths_coverage: 85
    enforcement: CI-warning
    layer: automation
    min_coverage: 70
  test_organization:
    e2e_tests:
      enforcement: convention
      location: tests/e2e/
      naming: '*_e2e_test.*'
    integration_tests:
      enforcement: convention
      location: tests/integration/
      naming: '*_integration_test.*'
    unit_tests:
      enforcement: convention
      location: Same directory as source OR tests/unit/
      naming: '*_test.* OR *.test.*'
validation:
  ci_checks:
  - blocking: true
    name: Language Policy Validation
    script: tools/governance/validate-language-policy.py
    tool: custom-script
    when: on_commit
  - blocking: true
    config: .dependency-cruiser.json
    name: Dependency Rule Check
    tool: dependency-cruiser
    when: on_commit
  - blocking: true
    name: Architecture Layer Validation
    policy: governance/23-policies/architecture/*.rego
    tool: opa
    when: on_commit
  - blocking: true
    name: API Compatibility Check
    tool: openapi-diff
    when: on_pr
  - blocking: true
    name: Security Boundary Check
    script: tools/governance/validate-security-boundaries.py
    tool: custom-script
    when: on_commit
  manual_reviews:
  - required_approvals: 2
    reviewers:
    - '@architecture-team'
    trigger: New cross-domain interface
  - required_approvals: 2
    reviewers:
    - '@architecture-team'
    - module-owner
    trigger: Breaking API change
  - required_approvals: 2
    reviewers:
    - '@security-team'
    - '@architecture-team'
    trigger: Security boundary change
version: 1.0.0
