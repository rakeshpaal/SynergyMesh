api:
  base_path: /api/v1/contracts
  endpoints:
  - description: 'Create a new contract with signature verification and provenance
      attestation.

      創建新合約，包含簽名驗證和溯源認證。

      '
    error_responses:
    - code: 400
      condition: Invalid signature or malformed input
      message: ERR_INVALID_SIGNATURE or ERR_MALFORMED_INPUT
    - code: 409
      condition: Contract with same content hash already exists
      message: ERR_DUPLICATE_CONTRACT
    - code: 500
      condition: Internal server error or database failure
      message: ERR_INTERNAL_ERROR
    guarantees:
    - Contract ID is globally unique (UUID v4)
    - Timestamp is monotonically increasing within single process
    - Signature is verified before storage
    - Provenance attestation is created and stored
    - Transaction is atomic (all-or-nothing)
    input_schema:
      properties:
        content:
          description: Contract content in structured format
          type: string
        metadata:
          properties:
            creator:
              type: string
            tags:
              items:
                type: string
              type: array
            timestamp:
              format: date-time
              type: string
          type: object
        signature:
          properties:
            algorithm:
              enum:
              - RSA-SHA256
              - ECDSA-SHA256
              type: string
            public_key:
              type: string
            value:
              type: string
          type: object
      required:
      - content
      - signature
      - metadata
      type: object
    method: POST
    name: Create Contract
    output_schema:
      properties:
        contract_id:
          description: Unique contract identifier (UUID v4)
          type: string
        created_at:
          format: date-time
          type: string
        provenance_url:
          format: uri
          type: string
        status:
          enum:
          - created
          - verified
          - failed
          type: string
      type: object
    path: /contracts
    performance:
      response_time_p50: < 100ms
      response_time_p99: < 500ms
      throughput: '> 1000 req/s'
  - description: 'Retrieve a contract by its unique identifier.

      根據唯一識別碼檢索合約。

      '
    error_responses:
    - code: 404
      condition: Contract not found
      message: ERR_CONTRACT_NOT_FOUND
    - code: 500
      condition: Internal server error
      message: ERR_INTERNAL_ERROR
    guarantees:
    - Returns consistent data for same contract_id
    - Includes full provenance chain
    - Signature is re-verifiable
    input_schema:
      properties:
        contract_id:
          description: Unique contract identifier
          type: string
      type: object
    method: GET
    name: Get Contract
    output_schema:
      properties:
        content:
          type: string
        contract_id:
          type: string
        created_at:
          format: date-time
          type: string
        metadata:
          type: object
        provenance:
          type: object
        signature:
          type: object
        updated_at:
          format: date-time
          type: string
      type: object
    path: /contracts/{contract_id}
    performance:
      cache_ttl: 5 minutes
      response_time_p50: < 50ms
      response_time_p99: < 200ms
  - description: 'Re-verify the signature of an existing contract.

      重新驗證現有合約的簽名。

      '
    guarantees:
    - Uses same algorithm as original verification
    - Result is deterministic for same contract
    - Does not modify contract state
    method: POST
    name: Verify Contract Signature
    output_schema:
      properties:
        contract_id:
          type: string
        valid:
          type: boolean
        verification_details:
          type: object
        verified_at:
          format: date-time
          type: string
      type: object
    path: /contracts/{contract_id}/verify
    performance:
      response_time_p50: < 80ms
      response_time_p99: < 300ms
  - description: 'List contracts with pagination and filtering.

      列出合約，支援分頁和篩選。

      '
    guarantees:
    - Results are ordered by specified sort field
    - Pagination is consistent during iteration
    - Total count reflects filter criteria
    input_schema:
      properties:
        filter:
          type: object
        page:
          default: 1
          minimum: 1
          type: integer
        page_size:
          default: 20
          maximum: 100
          minimum: 1
          type: integer
        sort:
          enum:
          - created_at
          - updated_at
          type: string
      type: object
    method: GET
    name: List Contracts
    output_schema:
      properties:
        contracts:
          items:
            type: object
          type: array
        has_more:
          type: boolean
        page:
          type: integer
        page_size:
          type: integer
        total_count:
          type: integer
      type: object
    path: /contracts
    performance:
      response_time_p50: < 150ms
      response_time_p99: < 800ms
compatibility:
  backward_compatible: true
  breaking_changes: []
  deprecated_features:
  - feature: Legacy signature algorithm MD5
    migration: Use RSA-SHA256 or ECDSA-SHA256
    removed_in: 2.0.0
contract:
  description: 'The Contract Service L1 provides contract lifecycle management,

    signature verification, and SLSA provenance attestation.


    合約服務 L1 提供合約生命週期管理、簽名驗證和 SLSA 溯源認證。

    '
  module: core.contract_service.L1
  owner: '@core-platform-team'
  status: active
  version: 1.0.0
dependencies:
  optional:
  - api_version: 1.x
    failure_mode: log-and-continue
    module: services.billing
    purpose: Trigger billing events
  required:
  - api_version: 1.x
    failure_mode: degraded
    module: core.slsa_provenance
    purpose: Generate provenance attestations
  - failure_mode: critical
    module: infrastructure.database
    purpose: Store contract data
    type: PostgreSQL 14+
events:
- consumers:
  - services.billing
  - services.audit
  - automation.monitoring
  delivery_guarantee: at-least-once
  description: Emitted when a new contract is successfully created
  name: contract.created
  ordering: per-contract
  payload_schema:
    properties:
      content_hash:
        type: string
      contract_id:
        type: string
      created_at:
        format: date-time
        type: string
      creator:
        type: string
      metadata:
        type: object
    required:
    - contract_id
    - creator
    - created_at
    type: object
  retention: 30 days
- consumers:
  - services.audit
  - core.slsa_provenance
  delivery_guarantee: at-least-once
  description: Emitted when a contract signature is verified
  name: contract.verified
  ordering: per-contract
  payload_schema:
    properties:
      contract_id:
        type: string
      valid:
        type: boolean
      verification_method:
        type: string
      verified_at:
        format: date-time
        type: string
    required:
    - contract_id
    - valid
    - verified_at
    type: object
  retention: 90 days
- consumers:
  - automation.monitoring
  - ops.alerting
  delivery_guarantee: at-least-once
  description: Emitted when contract operation fails
  name: contract.error
  payload_schema:
    properties:
      contract_id:
        nullable: true
        type: string
      error_code:
        type: string
      error_message:
        type: string
      operation:
        type: string
      timestamp:
        format: date-time
        type: string
    required:
    - operation
    - error_code
    - timestamp
    type: object
  retention: 7 days
failure_modes:
- error_code: ERR_INVALID_SIGNATURE
  recovery:
  - Return 400 error with details
  - Log security event
  - Do not store contract
  scenario: Invalid Signature
  triggers:
  - Signature algorithm not supported
  - Public key format invalid
  - Signature verification fails
- error_code: ERR_DUPLICATE_CONTRACT
  recovery:
  - Return 409 error with existing contract ID
  - Do not create new contract
  scenario: Duplicate Contract
  triggers:
  - Contract with same content hash exists
- error_code: ERR_DATABASE_FAILURE
  recovery:
  - Rollback transaction
  - Return 500 error
  - Alert operations team
  - Retry with exponential backoff
  scenario: Database Failure
  triggers:
  - Database connection lost
  - Transaction timeout
  - Storage capacity exceeded
- degraded_mode: true
  error_code: WARN_PROVENANCE_DELAYED
  recovery:
  - Store contract without provenance (degraded mode)
  - Queue provenance generation for retry
  - Log warning
  - Return success with warning flag
  scenario: Provenance Service Unavailable
  triggers:
  - SLSA provenance service down
  - Attestation generation fails
invariants:
- description: All contracts must have verified signatures before storage
  enforcement: pre-condition
  name: Signature Verification Required
  rule: 'forall c in contracts: c.signature.verified = true'
- description: Contract content cannot be modified after creation
  enforcement: database-constraint
  name: Immutable Contract Content
  rule: 'forall c in contracts: c.content is immutable'
- description: Contract IDs must be globally unique
  enforcement: database-constraint
  name: Unique Contract IDs
  rule: 'forall c1, c2 in contracts: c1.id != c2.id'
- description: Contract timestamps increase monotonically within process
  enforcement: application-logic
  name: Monotonic Timestamps
  rule: 'forall c1, c2 in contracts where c1.created_at < c2.created_at: c1.id !=
    c2.id'
- description: All contracts must have associated provenance attestation
  enforcement: post-condition
  name: Provenance Required
  rule: 'forall c in contracts: exists p in provenance where p.contract_id = c.id'
- description: Contract service never modifies final settlement state
  enforcement: access-control
  name: No Final Settlement Modification
  rule: settlement.state is not writable by contract_service
observability:
  logs:
    level: INFO
    retention: 30 days
    security_events: WARN
    structured: true
  metrics:
  - labels:
    - status
    name: contract_create_total
    type: counter
  - buckets:
    - 0.01
    - 0.05
    - 0.1
    - 0.5
    - 1.0
    name: contract_create_duration_seconds
    type: histogram
  - labels:
    - valid
    - algorithm
    name: signature_verification_total
    type: counter
  - name: provenance_generation_errors
    type: counter
  traces:
    critical_paths: 1.0
    enabled: true
    sample_rate: 0.1
references:
  api_documentation: core/contract_service/contracts-L1/API.md
  architecture_governance_matrix: governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md
  ownership_map: governance/34-config/ownership-map.yaml
  source_code: core/contract_service/contracts-L1/
testing:
  chaos_tests:
    scenarios:
    - Database failure during transaction
    - Provenance service unavailable
    - Network partition
  integration_tests:
    required:
    - End-to-end contract creation
    - Signature verification flow
    - Provenance integration
    - Database transaction handling
  performance_tests:
    scenarios:
    - duration: 5 minutes
      name: High throughput
      rps: 1000
    - name: Large payload
      payload_size: 1MB
      response_time_p99: < 1s
  unit_tests:
    coverage_min: 85
    critical_paths:
    - Signature verification logic
    - Contract ID generation
    - Transaction rollback
