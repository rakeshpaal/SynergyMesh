api:
  base_path: /api/v1/safety
  endpoints:
  - description: 'Execute safety checks before allowing an operation.

      執行安全檢查以允許操作。

      '
    error_responses:
    - code: 400
      condition: Invalid operation type
      message: ERR_INVALID_OPERATION
    - code: 500
      condition: Safety check engine failure
      message: ERR_SAFETY_CHECK_FAILED
    guarantees:
    - All safety rules are evaluated
    - Decision is deterministic for same input
    - Response time < 50ms for critical operations
    - Audit trail is created
    input_schema:
      properties:
        constraints:
          items:
            type: string
          type: array
        context:
          properties:
            actor:
              type: string
            environment:
              type: string
            metadata:
              type: object
            target:
              type: string
          type: object
        operation_type:
          enum:
          - deployment
          - data_access
          - system_modification
          - autonomous_action
          type: string
      required:
      - operation_type
      - context
      type: object
    method: POST
    name: Execute Safety Check
    output_schema:
      properties:
        allowed:
          type: boolean
        check_id:
          type: string
        checked_at:
          format: date-time
          type: string
        recommendations:
          items:
            type: string
          type: array
        risk_level:
          enum:
          - low
          - medium
          - high
          - critical
          type: string
        violations:
          items:
            type: string
          type: array
      type: object
    path: /checks
    performance:
      response_time_p50: < 10ms
      response_time_p99: < 50ms
      throughput: '> 5000 req/s'
  - description: 'Assess risk level for a proposed action.

      評估提議操作的風險等級。

      '
    guarantees:
    - Risk score is calculated consistently
    - All risk factors are considered
    - Mitigation steps are actionable
    input_schema:
      properties:
        action:
          properties:
            description:
              type: string
            type:
              type: string
          type: object
        impact_scope:
          properties:
            data_sensitivity:
              type: string
            systems_affected:
              type: array
            users_affected:
              type: integer
          type: object
      required:
      - action
      - impact_scope
      type: object
    method: POST
    name: Assess Risk
    output_schema:
      properties:
        approval_required:
          type: boolean
        assessment_id:
          type: string
        mitigation_steps:
          type: array
        risk_factors:
          type: array
        risk_level:
          type: string
        risk_score:
          maximum: 100
          minimum: 0
          type: number
      type: object
    path: /risk-assessment
  - description: 'Activate circuit breaker to stop unsafe operations.

      啟動斷路器以停止不安全的操作。

      '
    guarantees:
    - Circuit breaker activates immediately
    - All requests to target are blocked
    - Automatic recovery after duration
    input_schema:
      properties:
        duration_seconds:
          type: integer
        reason:
          type: string
        target:
          description: Module or service to protect
          type: string
      required:
      - target
      - reason
      type: object
    method: POST
    name: Apply Circuit Breaker
    output_schema:
      properties:
        activated:
          type: boolean
        active_until:
          format: date-time
          type: string
        breaker_id:
          type: string
      type: object
    path: /circuit-breaker
contract:
  description: 'Safety mechanisms module provides runtime safety checks, risk assessment,

    and automated mitigation for autonomous operations.


    安全機制模組提供運行時安全檢查、風險評估和自主操作的自動緩解。

    '
  module: core.safety_mechanisms
  owner: '@security-team'
  status: active
  version: 1.0.0
dependencies:
  optional:
  - failure_mode: log-and-continue
    module: services.audit
    purpose: Audit logging
  required:
  - failure_mode: use-cached
    module: governance.policies
    purpose: Safety policy definitions
  - failure_mode: critical
    module: infrastructure.database
    purpose: Store safety decisions
events:
- consumers:
  - services.audit
  - ops.alerting
  - automation.monitoring
  delivery_guarantee: at-least-once
  description: Emitted when safety check fails
  name: safety.check_failed
  payload_schema:
    properties:
      check_id:
        type: string
      operation_type:
        type: string
      risk_level:
        type: string
      timestamp:
        format: date-time
        type: string
      violations:
        type: array
    required:
    - check_id
    - operation_type
    - violations
    type: object
  retention: 90 days
- consumers:
  - ops.alerting
  - services.incident_management
  delivery_guarantee: at-least-once
  description: Emitted when circuit breaker is activated
  name: safety.circuit_breaker_activated
  payload_schema:
    properties:
      breaker_id:
        type: string
      reason:
        type: string
      target:
        type: string
      timestamp:
        format: date-time
        type: string
    type: object
  retention: 30 days
- consumers:
  - services.security
  - services.audit
  delivery_guarantee: at-least-once
  description: Emitted when high-risk operation is attempted
  name: safety.high_risk_operation
  payload_schema:
    properties:
      actor:
        type: string
      operation_type:
        type: string
      risk_score:
        type: number
      timestamp:
        format: date-time
        type: string
    type: object
  retention: 180 days
failure_modes:
- error_code: ERR_SAFETY_TIMEOUT
  fail_safe: deny
  recovery:
  - 'Fail-safe: deny operation'
  - Log timeout event
  - Alert monitoring team
  scenario: Safety Check Timeout
  triggers:
  - Check takes > 50ms
  - Rule evaluation hangs
- error_code: ERR_RULE_ENGINE_FAILED
  fail_safe: deny
  recovery:
  - 'Fail-safe: deny operation'
  - Alert security team immediately
  - Use cached last-known-good rules
  scenario: Rule Engine Failure
  triggers:
  - Rule compilation error
  - Rule execution exception
- error_code: WARN_RULE_CONFLICT
  fail_safe: deny
  recovery:
  - Apply most restrictive rule
  - Log conflict for review
  - Alert rule maintainers
  scenario: Conflicting Rules
  triggers:
  - Two rules give opposite decisions
invariants:
- description: When in doubt, deny the operation
  enforcement: application-logic
  name: Fail-Safe Default
  rule: if uncertain(check_result) then deny(operation)
- description: Operation allowed only if all safety checks pass
  enforcement: pre-condition
  name: All Checks Must Pass
  rule: 'allowed(op) implies forall c in checks(op): passed(c)'
- description: Active circuit breaker blocks all operations
  enforcement: application-logic
  name: Circuit Breaker Precedence
  rule: 'forall op where active_breaker(op.target): deny(op)'
- description: All safety decisions are logged
  enforcement: post-condition
  name: Audit Trail Required
  rule: 'forall decision: exists audit_entry where audit_entry.decision_id = decision.id'
- description: Safety checks cannot be bypassed programmatically
  enforcement: code-review
  name: No Bypass Mechanism
  rule: not exists bypass_flag in code
observability:
  alerts:
  - condition: safety_violations_total > 50/hour
    severity: critical
  - condition: circuit_breakers_active > 5
    severity: high
  - condition: safety_check_duration_seconds.p99 > 50ms
    severity: warning
  logs:
    all_denials: WARN
    level: INFO
    retention: 180 days
    security_events: WARN
    structured: true
  metrics:
  - labels:
    - result
    - operation_type
    name: safety_checks_total
    type: counter
  - name: safety_check_duration_seconds
    type: histogram
  - name: risk_score_distribution
    type: histogram
  - name: circuit_breakers_active
    type: gauge
  - labels:
    - violation_type
    name: safety_violations_total
    type: counter
references:
  architecture_governance_matrix: governance/29-docs/ARCHITECTURE_GOVERNANCE_MATRIX.md
  ownership_map: governance/34-config/ownership-map.yaml#core.safety_mechanisms
  policies: governance/23-policies/architecture-rules.yaml
security:
  compliance:
  - ISO 26262 (Safety Critical Systems)
  - DO-178C (Software Safety)
  safety_critical: true
  security_controls:
  - Fail-safe defaults (deny when uncertain)
  - No programmatic bypass
  - Audit all decisions
  - Circuit breaker for runaway systems
testing:
  chaos_tests:
    scenarios:
    - Rule engine crash during check
    - Database unavailable
    - Extremely high load (>10k req/s)
  integration_tests:
    required:
    - End-to-end safety check with denial
    - Circuit breaker triggering and recovery
    - High-risk operation detection
  unit_tests:
    coverage_min: 90
    critical_paths:
    - Fail-safe logic
    - Circuit breaker activation
    - Risk assessment calculation
