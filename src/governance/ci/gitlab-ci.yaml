audit:report:
  artifacts:
    expire_in: 1 month
    paths:
    - audit-report.json
  image: python:${PYTHON_VERSION}-slim
  rules:
  - changes:
    - governance/**/*
  script:
  - pip install pyyaml
  - "python -c \"\nimport yaml\nimport json\nimport os\nfrom datetime import datetime\n\
    \nreport = {\n    'generated_at': datetime.now().isoformat(),\n    'ci_job_id':\
    \ os.environ.get('CI_JOB_ID', 'local'),\n    'commit': os.environ.get('CI_COMMIT_SHA',\
    \ 'unknown'),\n    'dimensions': {'total': 0, 'by_category': {}},\n    'policies':\
    \ {'total': 0},\n    'schemas': {'total': 0}\n}\n\nfor root, dirs, files in os.walk('governance/dimensions'):\n\
    \    if 'dimension.yaml' in files:\n        with open(os.path.join(root, 'dimension.yaml'))\
    \ as f:\n            dim = yaml.safe_load(f)\n            report['dimensions']['total']\
    \ += 1\n            cat = dim['metadata'].get('category', 'unknown')\n       \
    \     report['dimensions']['by_category'][cat] = report['dimensions']['by_category'].get(cat,\
    \ 0) + 1\n\nfor root, dirs, files in os.walk('governance'):\n    for f in files:\n\
    \        if f.endswith('.rego'):\n            report['policies']['total'] += 1\n\
    \        if f.endswith('.json') and 'schema' in f.lower():\n            report['schemas']['total']\
    \ += 1\n\nwith open('audit-report.json', 'w') as f:\n    json.dump(report, f,\
    \ indent=2)\n\nprint(json.dumps(report, indent=2))\n\"\n"
  stage: audit
deploy:production:
  environment:
    name: production
  image: alpine:latest
  rules:
  - changes:
    - governance/**/*
    if: $CI_COMMIT_BRANCH == "main"
  script:
  - 'echo "Deploying governance framework..."

    echo "Commit: ${CI_COMMIT_SHA}"

    echo "Branch: ${CI_COMMIT_REF_NAME}"

    echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

    echo "Deployment successful!"

    '
  stage: deploy
lint:policies:
  image: openpolicyagent/opa:${OPA_VERSION}
  rules:
  - changes:
    - governance/**/*.rego
  script:
  - "echo \"Linting OPA policies...\"\nfind governance -name \"*.rego\" | while read\
    \ file; do\n  opa fmt --diff \"$file\"\n  opa check \"$file\" || exit 1\ndone\n\
    echo \"All policies pass lint checks\"\n"
  stage: lint
stages:
- validate
- lint
- test
- audit
- deploy
test:dependencies:
  image: python:${PYTHON_VERSION}-slim
  rules:
  - changes:
    - governance/**/*
  script:
  - pip install pyyaml
  - "python -c \"\nimport yaml\nimport os\n\ndimensions = {}\nfor root, dirs, files\
    \ in os.walk('governance/dimensions'):\n    if 'dimension.yaml' in files:\n  \
    \      path = os.path.join(root, 'dimension.yaml')\n        with open(path) as\
    \ f:\n            dim = yaml.safe_load(f)\n            dim_id = dim['metadata']['id']\n\
    \            dimensions[dim_id] = dim\n\nerrors = []\nfor dim_id, dim in dimensions.items():\n\
    \    deps = dim.get('spec', {}).get('dependencies', {}).get('required', [])\n\
    \    for dep in deps:\n        if dep not in dimensions:\n            errors.append(f'{dim_id}\
    \ depends on missing: {dep}')\n\nif errors:\n    for e in errors:\n        print(f'ERROR:\
    \ {e}')\n    exit(1)\nprint(f'Dependencies satisfied for {len(dimensions)} dimensions')\n\
    \"\n"
  stage: test
test:policies:
  artifacts:
    expire_in: 1 week
    paths:
    - coverage.json
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.json
  image: openpolicyagent/opa:${OPA_VERSION}
  rules:
  - changes:
    - governance/**/*.rego
  script:
  - 'echo "Running policy tests..."

    opa test governance/ -v --coverage --format=json > coverage.json || true

    cat coverage.json

    '
  stage: test
validate:json:
  image: python:${PYTHON_VERSION}-slim
  rules:
  - changes:
    - governance/**/*
  script:
  - "echo \"Validating JSON files...\"\nfind governance -name \"*.json\" | while read\
    \ file; do\n  python -c \"import json; json.load(open('$file'))\" || exit 1\n\
    done\necho \"All JSON files are valid\"\n"
  stage: validate
validate:schema:
  image: python:${PYTHON_VERSION}-slim
  rules:
  - changes:
    - governance/**/*
  script:
  - pip install pyyaml jsonschema
  - "echo \"Validating schemas...\"\npython -c \"\nimport json\nfrom jsonschema import\
    \ Draft7Validator\n\nfor schema_file in ['governance/schemas/governance-schema.json',\n\
    \                    'governance/schemas/dimension-schema.json',\n           \
    \         'governance/schemas/audit-log-schema.json']:\n    with open(schema_file)\
    \ as f:\n        schema = json.load(f)\n    errors = list(Draft7Validator.check_schema(schema))\n\
    \    if errors:\n        print(f'Invalid schema: {schema_file}')\n        exit(1)\n\
    print('All schemas are valid')\n\"\n"
  stage: validate
validate:yaml:
  image: python:${PYTHON_VERSION}-slim
  rules:
  - changes:
    - governance/**/*
  script:
  - pip install pyyaml
  - "echo \"Validating YAML files...\"\nfind governance -name \"*.yaml\" -o -name\
    \ \"*.yml\" | while read file; do\n  python -c \"import yaml; yaml.safe_load(open('$file'))\"\
    \ || exit 1\ndone\necho \"All YAML files are valid\"\n"
  stage: validate
variables:
  OPA_VERSION: 0.60.0
  PYTHON_VERSION: '3.11'
