name: Governance CI/CD Pipeline
true:
  pull_request:
    branches:
    - main
    - develop
    paths:
    - governance/**
  push:
    branches:
    - main
    - develop
    paths:
    - governance/**
  workflow_dispatch:
    inputs:
      dimension:
        description: Specific dimension to validate (e.g., 00-vision-strategy)
        required: false
        type: string
env:
  NODE_VERSION: '20'
  OPA_VERSION: 0.60.0
  PYTHON_VERSION: '3.11'
jobs:
  audit:
    name: Generate Audit Report
    needs: integration-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Generate Governance Report
      run: "python -c \"\nimport yaml\nimport json\nimport os\nfrom datetime import\
        \ datetime\n\nreport = {\n    'generated_at': datetime.now().isoformat(),\n\
        \    'governance_version': '2.0.0',\n    'dimensions': {\n        'total':\
        \ 0,\n        'by_category': {},\n        'by_status': {}\n    },\n    'policies':\
        \ {\n        'total': 0,\n        'global': 0,\n        'dimension': 0\n \
        \   },\n    'schemas': {\n        'total': 0\n    },\n    'compliance': {\n\
        \        'frameworks': set()\n    }\n}\n\n# Count dimensions\nfor root, dirs,\
        \ files in os.walk('governance/dimensions'):\n    if 'dimension.yaml' in files:\n\
        \        with open(os.path.join(root, 'dimension.yaml')) as f:\n         \
        \   dim = yaml.safe_load(f)\n            report['dimensions']['total'] +=\
        \ 1\n            category = dim['metadata'].get('category', 'unknown')\n \
        \           report['dimensions']['by_category'][category] = report['dimensions']['by_category'].get(category,\
        \ 0) + 1\n            status = dim.get('status', 'unknown')\n            report['dimensions']['by_status'][status]\
        \ = report['dimensions']['by_status'].get(status, 0) + 1\n\n# Count policies\n\
        for root, dirs, files in os.walk('governance'):\n    for f in files:\n   \
        \     if f.endswith('.rego'):\n            report['policies']['total'] +=\
        \ 1\n            if 'policies' in root:\n                report['policies']['global']\
        \ += 1\n            else:\n                report['policies']['dimension']\
        \ += 1\n\n# Count schemas\nfor root, dirs, files in os.walk('governance'):\n\
        \    for f in files:\n        if f.endswith('.json') and 'schema' in f.lower():\n\
        \            report['schemas']['total'] += 1\n\nreport['compliance']['frameworks']\
        \ = ['ISO-42001', 'NIST-AI-RMF', 'EU-AI-Act', 'SOX', 'GDPR']\n\nprint('='\
        \ * 60)\nprint('GOVERNANCE AUDIT REPORT')\nprint('=' * 60)\nprint(f'Generated:\
        \ {report[\\\"generated_at\\\"]}')\nprint(f'Version: {report[\\\"governance_version\\\
        \"]}')\nprint()\nprint('DIMENSIONS:')\nprint(f'  Total: {report[\\\"dimensions\\\
        \"][\\\"total\\\"]}')\nprint(f'  By Category: {report[\\\"dimensions\\\"][\\\
        \"by_category\\\"]}')\nprint(f'  By Status: {report[\\\"dimensions\\\"][\\\
        \"by_status\\\"]}')\nprint()\nprint('POLICIES:')\nprint(f'  Total: {report[\\\
        \"policies\\\"][\\\"total\\\"]}')\nprint(f'  Global: {report[\\\"policies\\\
        \"][\\\"global\\\"]}')\nprint(f'  Dimension: {report[\\\"policies\\\"][\\\"\
        dimension\\\"]}')\nprint()\nprint('SCHEMAS:')\nprint(f'  Total: {report[\\\
        \"schemas\\\"][\\\"total\\\"]}')\nprint()\nprint('COMPLIANCE FRAMEWORKS:')\n\
        for fw in report['compliance']['frameworks']:\n    print(f'  - {fw}')\nprint('='\
        \ * 60)\n\n# Save report\nwith open('governance-report.json', 'w') as f:\n\
        \    report['compliance']['frameworks'] = list(report['compliance']['frameworks'])\n\
        \    json.dump(report, f, indent=2)\n\"\n"
    - name: Upload Audit Report
      uses: actions/upload-artifact@v4
      with:
        name: governance-audit-report
        path: governance-report.json
    timeout-minutes: 5
  deploy:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    name: Deploy Governance Configuration
    needs: audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    - name: Generate Deployment Manifest
      run: "echo \"Generating deployment manifest...\"\ncat > deployment-manifest.yaml\
        \ << EOF\napiVersion: governance.machinenativeops.io/v2\nkind: DeploymentManifest\n\
        metadata:\n  name: governance-deployment\n  version: \"2.0.0\"\n  generated_at:\
        \ \"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\"\n  commit: \"${{ github.sha }}\"\n\
        spec:\n  dimensions:\n    count: 81\n    status: deployed\n  policies:\n \
        \   status: active\n  schemas:\n    status: validated\n  compliance:\n   \
        \ validated: true\nstatus: success\nEOF\ncat deployment-manifest.yaml\n"
    - name: Notify Deployment
      run: 'echo "Governance framework deployed successfully!"

        echo "Commit: ${{ github.sha }}"

        echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

        '
    timeout-minutes: 5
  integration-test:
    name: Integration Tests
    needs: policy-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install Dependencies
      run: 'pip install pyyaml jsonschema pytest

        '
    - name: Test Dimension Dependencies
      run: "echo \"Testing dimension dependencies...\"\npython -c \"\nimport yaml\n\
        import os\n\ndimensions = {}\nfor root, dirs, files in os.walk('governance/dimensions'):\n\
        \    if 'dimension.yaml' in files:\n        path = os.path.join(root, 'dimension.yaml')\n\
        \        with open(path) as f:\n            dim = yaml.safe_load(f)\n    \
        \        dim_id = dim['metadata']['id']\n            dimensions[dim_id] =\
        \ dim\n\n# Check all dependencies exist\nerrors = []\nfor dim_id, dim in dimensions.items():\n\
        \    deps = dim.get('spec', {}).get('dependencies', {}).get('required', [])\n\
        \    for dep in deps:\n        if dep not in dimensions:\n            errors.append(f'{dim_id}\
        \ depends on missing dimension: {dep}')\n\nif errors:\n    for e in errors:\n\
        \        print(f'ERROR: {e}')\n    exit(1)\nelse:\n    print(f'All dependencies\
        \ satisfied for {len(dimensions)} dimensions')\n\"\n"
    - name: Test Schema Consistency
      run: "echo \"Testing schema consistency...\"\npython -c \"\nimport json\nimport\
        \ os\nfrom jsonschema import Draft7Validator\n\n# Load dimension schema\n\
        with open('governance/schemas/dimension-schema.json') as f:\n    schema =\
        \ json.load(f)\n\nvalidator = Draft7Validator(schema)\nerrors = list(validator.check_schema())\n\
        \nif errors:\n    for e in errors:\n        print(f'Schema error: {e}')\n\
        \    exit(1)\nelse:\n    print('Dimension schema is valid')\n\"\n"
    timeout-minutes: 10
  policy-lint:
    name: Lint OPA Policies
    needs: validate
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    - name: Install OPA
      run: 'curl -L -o opa https://openpolicyagent.org/downloads/v${{ env.OPA_VERSION
        }}/opa_linux_amd64_static

        chmod 755 opa

        sudo mv opa /usr/local/bin/opa

        '
    - name: Lint Global Policies
      run: 'echo "Linting global policies..."

        find governance/policies -name "*.rego" -exec opa fmt --diff {} \;

        '
    - name: Lint Dimension Policies
      run: 'echo "Linting dimension policies..."

        find governance/dimensions -name "*.rego" -exec opa fmt --diff {} \;

        '
    - name: Check Policy Syntax
      run: "echo \"Checking policy syntax...\"\nfind governance -name \"*.rego\" |\
        \ while read file; do\n  opa check \"$file\" || exit 1\ndone\necho \"All policies\
        \ have valid syntax\"\n"
    timeout-minutes: 5
  policy-test:
    name: Test OPA Policies
    needs: policy-lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    - name: Install OPA
      run: 'curl -L -o opa https://openpolicyagent.org/downloads/v${{ env.OPA_VERSION
        }}/opa_linux_amd64_static

        chmod 755 opa

        sudo mv opa /usr/local/bin/opa

        '
    - name: Run Policy Tests
      run: "echo \"Running policy tests...\"\n# Test global policies\nif [ -d \"governance/policies/tests\"\
        \ ]; then\n  opa test governance/policies/ -v\nfi\n\n# Test dimension policies\n\
        for dir in governance/dimensions/*/; do\n  if [ -d \"${dir}tests\" ]; then\n\
        \    echo \"Testing: $dir\"\n    opa test \"$dir\" -v || true\n  fi\ndone\n"
    - name: Generate Coverage Report
      run: 'echo "Generating policy coverage report..."

        opa test governance/ --coverage --format=json > coverage.json || true

        cat coverage.json

        '
    - name: Upload Coverage
      uses: actions/upload-artifact@v4
      with:
        name: policy-coverage
        path: coverage.json
    timeout-minutes: 10
  validate:
    name: Validate Governance Assets
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        cache: pip
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    - name: Install OPA
      run: 'curl -L -o opa https://openpolicyagent.org/downloads/v${{ env.OPA_VERSION
        }}/opa_linux_amd64_static

        chmod 755 opa

        sudo mv opa /usr/local/bin/opa

        opa version

        '
    - name: Install Dependencies
      run: 'pip install pyyaml jsonschema

        npm install -g ajv-cli

        '
    - name: Validate YAML Syntax
      run: "echo \"Validating YAML files...\"\nfind governance -name \"*.yaml\" -o\
        \ -name \"*.yml\" | while read file; do\n  python -c \"import yaml; yaml.safe_load(open('$file'))\"\
        \ || exit 1\ndone\necho \"All YAML files are valid\"\n"
    - name: Validate JSON Schema
      run: "echo \"Validating JSON Schema files...\"\nfind governance -name \"*.json\"\
        \ | while read file; do\n  python -c \"import json; json.load(open('$file'))\"\
        \ || exit 1\ndone\necho \"All JSON files are valid\"\n"
    - name: Validate Governance Schema
      run: "echo \"Validating governance.yaml against schema...\"\najv validate \\\
        \n  -s governance/schemas/governance-schema.json \\\n  -d governance/governance.yaml\
        \ \\\n  --strict=false || true\n"
    - name: Validate Dimension Schemas
      run: "echo \"Validating dimension modules...\"\nfor dir in governance/dimensions/*/;\
        \ do\n  if [ -f \"$dir/dimension.yaml\" ] && [ -f \"$dir/schema.json\" ];\
        \ then\n    echo \"Validating: $dir\"\n    python -c \"import yaml; yaml.safe_load(open('${dir}dimension.yaml'))\"\
        \n  fi\ndone\n"
    timeout-minutes: 5
