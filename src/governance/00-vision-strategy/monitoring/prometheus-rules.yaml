apiVersion: machinenativeops.io/v2
kind: PrometheusRule
metadata:
  annotations:
    machinenativeops.io/gac-phase: 3-monitoring
  labels:
    machinenativeops.io/prometheus: kube-prometheus
    machinenativeops.io/role: alert-rules
  name: governance-compliance-rules
  namespace: machinenativenops
spec:
  groups:
  - interval: 30s
    name: governance.compliance
    rules:
    - alert: GovernanceResourceMissing
      annotations:
        description: Expected 9 governance resources, found {{ $value }}
        summary: Governance resources missing
      expr: 'count(kube_customresource_version{customresource_group="governance.kai"})
        < 9

        '
      for: 5m
      labels:
        component: governance
        severity: critical
    - alert: GovernanceCRDUnhealthy
      annotations:
        description: CRD {{ $labels.customresourcedefinition }} is not established
        summary: Governance CRD not established
      expr: 'kube_customresourcedefinition_status_condition{condition="Established",status="false",customresourcedefinition=~".*governance.kai"}
        == 1

        '
      for: 2m
      labels:
        component: governance-crd
        severity: warning
    - alert: GovernancePolicyViolation
      annotations:
        description: '{{ $value }} policy violations in the last 5 minutes'
        summary: Governance policy violations detected
      expr: 'increase(gatekeeper_violations{enforcement_action="deny"}[5m]) > 0

        '
      labels:
        component: governance-policy
        severity: warning
    - alert: GovernanceGitOpsSyncFailed
      annotations:
        description: 'Application {{ $labels.name }} sync status: {{ $labels.sync_status
          }}'
        summary: GitOps sync failed for governance resources
      expr: 'argocd_app_sync_status{name=~"gac-.*",sync_status!="Synced"} == 1

        '
      for: 10m
      labels:
        component: gitops
        severity: critical
    - alert: GovernanceResourceStale
      annotations:
        description: Resource {{ $labels.customresource_kind }}/{{ $labels.name }}
          hasn't been updated in 90 days
        summary: Governance resource not updated recently
      expr: 'time() - kube_customresource_created{customresource_group="governance.kai"}
        > 86400 * 90

        '
      labels:
        component: governance
        severity: info
  - interval: 1m
    name: governance.metrics
    rules:
    - expr: count(kube_customresource_version{customresource_group="governance.kai"})
      record: governance:resources:total
    - expr: "(\n  count(kube_customresource_version{customresource_group=\"governance.kai\"\
        })\n  /\n  9\n) * 100\n"
      record: governance:compliance:rate
    - expr: 'rate(gatekeeper_constraints_enforced_total[5m])

        '
      record: governance:policy:enforcement_rate
    - expr: "(\n  count(argocd_app_sync_status{name=~\"gac-.*\",sync_status=\"Synced\"\
        })\n  /\n  count(argocd_app_sync_status{name=~\"gac-.*\"})\n) * 100\n"
      record: governance:gitops:sync_success_rate
