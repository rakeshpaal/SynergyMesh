$schema: https://schema.superroot.kn/mndoc/mapping-rules/v1
description: Rules for Markdown → Machine-Native Knowledge Layer transformation
entity_type_mappings:
  component:
    default_values:
      entity: Component
      status: active
    extract:
      path: relative_path
      provides: module_exports_or_docstring
      title: filename_to_title
    patterns:
    - core/**/*.py
    - mcp-servers/**/*.ts
    source: code_paths
  configuration:
    default_values:
      entity: Configuration
      environment: all
      validated: false
    extract:
      key: yaml_key_path
      source_file: file_path
      value: yaml_value
    source: config/**/*.yaml
  governance:
    default_values:
      entity: Governance
      status: active
      type: pipeline
    extract:
      stages: table_rows_to_stages
    source: tables_with_stage_columns
  subsystem:
    default_values:
      entity: Subsystem
      status: active
    extract:
      capabilities: yaml_code_block_or_list
      description: first_paragraph
      title: section_heading
    keywords:
    - Engine
    - System
    - Framework
    - Platform
    source: h2_sections_with_keywords
  system:
    default_values:
      criticality: high
      domain: automation
      entity: System
      layer: control-plane
      owner: platform-team
      status: active
    extract:
      description: first_paragraph_after_badges
      title: first_h1
      version: badge_pattern('version-([0-9.]+)')
    source: README.md
id: mnr-v1
list_to_capabilities_rules:
- description: 無序列表項目轉換為能力陣列
  example:
    input: '- AI 決策引擎

      - 服務註冊表

      '
    output:
      capabilities:
      - ai-decision-engine
      - service-registry
  id: rule-list-capabilities
  name: List to Capabilities
  transform:
    item_transform: slugify(item_text)
    target_field: capabilities
  trigger:
    context_pattern: (?:能力|capabilities|功能|features)
    element_type: unordered_list
- description: YAML 程式碼區塊直接解析為結構化資料
  id: rule-codeblock-yaml
  name: YAML Code Block to Structure
  transform:
    merge_strategy: deep_merge_to_parent
    parse_mode: yaml
  trigger:
    element_type: code_block
    language: yaml
output_formats:
- extension: .mndoc.yaml
  format: yaml
  schema: https://schema.superroot.kn/mndoc/v1
- extension: .mndoc.json
  format: json
  schema: https://schema.superroot.kn/mndoc/v1
path_to_component_rules:
- description: Python 檔案路徑自動轉成元件
  example:
    input: core/unified_integration/cognitive_processor.py
    output:
      id: cognitive-processor
      language: python
      namespace: core.unified_integration.cognitive_processor
      type: processor
  id: rule-path-python
  name: Python Path to Component
  transform:
    entity_type: component
    id_generation: basename_without_extension(path).replace('_', '-')
    language: python
    namespace_generation: path.replace('/', '.').removesuffix('.py')
    type_inference:
      patterns:
      - match: _processor\.py$
        type: processor
      - match: _engine\.py$
        type: engine
      - match: _registry\.py$
        type: registry
      - match: _detector\.py$
        type: detector
      - match: _validator\.py$
        type: validator
      - match: _handler\.py$
        type: handler
      - match: _hub\.py$
        type: hub
      - match: _optimizer\.py$
        type: optimizer
      - match: _orchestrator\.py$
        type: orchestrator
      - match: _controller\.py$
        type: controller
      - match: _manager\.py$
        type: manager
      - default: module
  trigger:
    path_pattern: ^(core|automation)/.*\.py$
- description: TypeScript 檔案路徑自動轉成服務元件
  id: rule-path-typescript
  name: TypeScript Path to Component
  transform:
    entity_type: component
    id_generation: basename_without_extension(path).replace('_', '-')
    language_inference:
    - language: typescript
      match: \.ts$
    - language: javascript
      match: \.js$
    type: service
  trigger:
    path_pattern: ^(mcp-servers|services)/.*\.(ts|js)$
reference_to_provenance_rules:
- conditional:
  - if: path.startswith('governance/')
    then:
      generate_policy_ref: true
  - if: path.endswith('.py') or path.endswith('.ts')
    then:
      generate_sbom: true
  description: 檔案路徑引用自動產生溯源觸發器
  id: rule-ref-provenance
  name: Reference to Provenance Hook
  transform:
    evidence_ref:
      sbom: governance/sbom/{subsystem}.yaml
      signature: governance/signature/{subsystem}.sig
      slsa_ref: .slsa/provenance/{component_id}.json
  trigger:
    path_pattern: ^(core|governance|automation)/.*$
rule_categories:
- description: Rules for converting Markdown sections to machine entities
  id: section-to-entity
  name: Section to Entity Rules
- description: Rules for converting code paths to component entities
  id: path-to-component
  name: Path to Component Rules
- description: Rules for converting Markdown lists/tables to capabilities
  id: list-to-capabilities
  name: List to Capabilities Rules
- description: Rules for generating provenance hooks from file references
  id: reference-to-provenance
  name: Reference to Provenance Rules
section_to_entity_rules:
- description: 每個包含特定關鍵字的 H2 章節對應一個子系統實體
  example:
    input: '## SynergyMesh Core Engine'
    output:
      entity_type: subsystem
      id: machinenativeops-core-engine
      layer: control-plane
  id: rule-section-subsystem
  name: Section to Subsystem
  transform:
    entity_type: subsystem
    fields:
      owner: infer_from_parent_or_default('platform-team')
      status: active
      type: subsystem
    id_generation: slug(section_title)
    layer_inference:
      patterns:
      - layer: control-plane
        match: Engine|Core|Platform
      - layer: governance
        match: Governance|Policy|Schema
      - layer: automation
        match: Autonomous|Framework
      - layer: infrastructure
        match: Infrastructure|Deployment
  trigger:
    heading_level: 2
    markdown_pattern: ^## .*(?:Engine|System|Framework|Platform|Core).*$
- description: 子系統下的 H3 章節對應元件實體
  id: rule-section-component
  name: Section to Component
  transform:
    entity_type: component
    fields:
      subsystem_ref: parent_subsystem_id
      type: module
    id_generation: slug(item_name)
  trigger:
    heading_level: 3
    markdown_pattern: ^### (?:主要模組|核心能力|Components|Modules).*$
- description: 表格轉換為能力列表
  id: rule-table-capabilities
  name: Table to Capabilities
  transform:
    entity_type: governance
    id_generation: slug(table_context) + '-pipeline'
    type: pipeline
  trigger:
    element_type: table
    markdown_pattern: \|.*階段.*\|.*名稱.*\|
title: Machine-Native Mapping Rules v1
transformation_functions:
- description: Convert string to slug format
  example: slug('SynergyMesh Core Engine') → 'machinenativeops-core-engine'
  name: slug
- description: Get filename without extension
  example: basename_without_extension('core/ai_engine.py') → 'ai_engine'
  name: basename_without_extension
- description: Convert any text to slug
  example: slugify('AI 決策引擎') → 'ai-decision-engine'
  name: slugify
- description: Inherit from parent entity or use default
  example: infer_from_parent_or_default('platform-team')
  name: infer_from_parent_or_default
- description: Merge parsed content into parent entity
  name: deep_merge_to_parent
validation:
  consistency_checks:
  - Component IDs must be unique
  - Subsystem references must be valid
  - All capabilities must be defined
  provenance_requirements:
  - Critical components must have SBOM
  - All components should have signature references
  required_mappings:
  - Every H2 section must map to an entity
  - Every code path must have a component
  - Every component must have provenance hooks
version: 1.0.0
