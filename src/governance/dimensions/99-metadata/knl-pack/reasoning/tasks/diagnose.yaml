description: 偵測結構/語意/治理問題 - Detect structural, semantic, and governance issues
metadata:
  auto_trigger: true
  estimated_duration: < 5 minutes
  priority: P0
name: Diagnose Governance Issues
notifications:
  on_completion:
    level: info
    method: log
  on_critical_issues:
    method: github_issue
    template: Critical governance issues detected. See diagnosis report.
output:
  issues: '{{ prioritized_issues }}'
  report: '{{ diagnosis_report }}'
  summary:
    critical: '{{ prioritized_issues | filter(severity=''critical'') | length }}'
    high: '{{ prioritized_issues | filter(severity=''high'') | length }}'
    low: '{{ prioritized_issues | filter(severity=''low'') | length }}'
    medium: '{{ prioritized_issues | filter(severity=''medium'') | length }}'
    total_issues: '{{ prioritized_issues | length }}'
steps:
- action: load_file
  description: 載入全局治理索引
  file: ../governance/index.json
  name: Load Governance Index
  output_var: governance_index
  step: 1
- action: load_file
  description: 載入治理 DAG
  file: ../governance/dag.graphml
  name: Load DAG
  output_var: governance_dag
  step: 2
- action: dag_analyzer
  description: 檢測循環依賴
  name: Check Circular Dependencies
  output_var: cycle_issues
  parameters:
    check_type: cycles
    dag: '{{ governance_dag }}'
  step: 3
- action: dag_analyzer
  description: 檢測孤兒資源
  name: Check Orphan Artifacts
  output_var: orphan_issues
  parameters:
    check_type: orphans
    dag: '{{ governance_dag }}'
    index: '{{ governance_index }}'
  step: 4
- action: vector_search
  description: 查找命名不一致的候選
  name: Check Naming Consistency
  output_var: naming_candidates
  parameters:
    dimensions:
    - structure
    - governance
    query: Find artifacts with inconsistent naming
    top_k: 20
  step: 5
- action: policy_checker
  description: 分析命名問題
  name: Analyze Naming Issues
  output_var: naming_issues
  parameters:
    artifacts: '{{ naming_candidates }}'
    policies:
    - naming-convention
  step: 6
- action: policy_checker
  description: 檢查元數據完整性
  name: Check Metadata Completeness
  output_var: metadata_issues
  parameters:
    artifacts: '{{ governance_index.artifacts }}'
    policies:
    - metadata-completeness
  step: 7
- action: aggregate
  description: 聚合所有問題
  inputs:
  - '{{ cycle_issues }}'
  - '{{ orphan_issues }}'
  - '{{ naming_issues }}'
  - '{{ metadata_issues }}'
  name: Aggregate Issues
  output_var: all_issues
  step: 8
- action: prioritize
  description: 優先級排序
  name: Prioritize Issues
  output_var: prioritized_issues
  parameters:
    criteria:
    - severity
    - impact_radius
    - compliance_risk
    issues: '{{ all_issues }}'
  step: 9
- action: format_output
  name: Generate Report
  output_var: diagnosis_report
  step: 10
  template: '# Governance Diagnosis Report


    **Timestamp**: {{ now() }}

    **Total Issues Found**: {{ prioritized_issues | length }}


    ## Critical Issues ({{ prioritized_issues | filter(severity=''critical'') | length
    }})

    {{ prioritized_issues | filter(severity=''critical'') | format_list }}


    ## High Priority Issues ({{ prioritized_issues | filter(severity=''high'') | length
    }})

    {{ prioritized_issues | filter(severity=''high'') | format_list }}


    ## Medium Priority Issues ({{ prioritized_issues | filter(severity=''medium'')
    | length }})

    {{ prioritized_issues | filter(severity=''medium'') | format_list }}


    ## Recommendations

    {{ prioritized_issues | generate_recommendations }}

    '
task_type: diagnose
triggers:
- condition: 'true'
  event: artifact_changed
- event: scheduled_audit
  schedule: 0 2 * * *
- condition: 'true'
  event: manual_request
version: 1.0.0
