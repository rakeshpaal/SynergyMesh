description: åµæ¸¬å€‰åº«è®Šå‹• â†’ é‡æ–°ç”ŸæˆçŸ¥è­˜åœ–è­œ â†’ æ›´æ–°æ²»ç†ç´¢å¼• â†’ åŒæ­¥ç›¸é—œå…§å®¹
metadata:
  auto_trigger: true
  estimated_duration: < 3 minutes
  priority: P0
  ç‰¹è‰²: ç´€éŒ„åŠŸèƒ½ - åªè¦å€‰åº«ä¸€æœ‰è®Šå‹•ï¼Œç«‹åˆ»æ‰¾åˆ°æ­¤æ¬¡è®Šå‹•çš„å…§å®¹ã€ç›¸é—œå…§å®¹ã€é«˜åº¦ç›¸é—œå…§å®¹
name: Sync Living Knowledge Base with Repository Changes
notifications:
  on_broken_refs:
    condition: broken_refs | length > 0
    method: github_issue
    template: '## ğŸ”— Broken References Detected


      The knowledge sync detected {{ broken_refs | length }} broken reference(s):


      {{ broken_refs | format_issues }}


      **Commit**: {{ change_metadata.commit_sha }}

      **Full Report**: {{ record_stored.path }}

      '
  on_completion:
    level: info
    message: Knowledge base synchronized. {{ impact_analysis.affected_count }} artifacts
      affected.
    method: log
output:
  artifacts_affected: '{{ impact_analysis.affected_count }}'
  changes_processed: '{{ classified_changes | length }}'
  commit_sha: '{{ change_metadata.commit_sha }}'
  highly_related: '{{ highly_related_content | length }}'
  knowledge_synced: true
  record_path: '{{ record_stored.path }}'
  related_artifacts: '{{ related_artifacts | length }}'
  success: true
  summary: '{{ change_summary }}'
steps:
- action: git_diff_analysis
  description: åµæ¸¬å€‰åº«è®Šå‹•ï¼šæ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤çš„æª”æ¡ˆ
  name: Detect Repository Changes
  output_var: changes
  parameters:
    base: HEAD~1
    include_untracked: false
    target: HEAD
  step: 1
- action: classify_changes
  description: åˆ†é¡è®Šå‹•çš„æª”æ¡ˆé¡å‹
  name: Classify Changed Files
  output_var: classified_changes
  parameters:
    categories:
    - governance
    - schema
    - config
    - code
    - documentation
    - workflow
    changes: '{{ changes }}'
  step: 2
- action: extract_metadata
  description: æå–è®Šå‹•çš„å…ƒæ•¸æ“š
  name: Extract Change Metadata
  output_var: change_metadata
  parameters:
    changes: '{{ classified_changes }}'
    extract:
    - commit_message
    - commit_author
    - commit_timestamp
    - file_paths
    - change_type
    - line_count
  step: 3
- action: run_command
  description: é‡æ–°ç”Ÿæˆ MN-DOC (generated-mndoc.yaml)
  name: Generate MN-DOC
  output_var: mndoc_result
  parameters:
    command: make mndoc
    timeout: 60
    working_dir: '{{ repo_root }}'
  step: 4
- action: run_command
  description: é‡æ–°ç”ŸæˆçŸ¥è­˜åœ–è­œ (knowledge-graph.yaml)
  name: Generate Knowledge Graph
  output_var: kg_result
  parameters:
    command: make kg
    timeout: 120
    working_dir: '{{ repo_root }}'
  step: 5
- action: run_command
  description: æŠ•å½±åˆ° SuperRoot å¯¦é«”æ ¼å¼ (superroot-entities.yaml)
  name: Generate SuperRoot Entities
  output_var: superroot_result
  parameters:
    command: make superroot
    timeout: 60
    working_dir: '{{ repo_root }}'
  step: 6
- action: vector_search
  description: æ‰¾åˆ°èˆ‡è®Šå‹•ç›¸é—œçš„ artifacts
  name: Find Related Artifacts
  output_var: related_artifacts
  parameters:
    dimensions:
    - content
    - structure
    - governance
    query_template: 'Find artifacts related to: {{ change_metadata.file_paths }}'
    similarity_threshold: 0.7
    top_k: 20
  step: 7
- action: vector_search
  description: æ‰¾åˆ°é«˜åº¦ç›¸é—œçš„å…§å®¹
  name: Find Highly Related Content
  output_var: highly_related_content
  parameters:
    boost_same_category: true
    dimensions:
    - content
    - structure
    query_template: 'Find highly similar content to: {{ change_metadata }}'
    similarity_threshold: 0.85
    top_k: 10
  step: 8
- action: impact_analysis
  description: åˆ†æè®Šå‹•å½±éŸ¿ï¼šå“ªäº› artifacts å—å½±éŸ¿ã€ä¾è³´é—œä¿‚
  name: Analyze Change Impact
  output_var: impact_analysis
  parameters:
    changes: '{{ classified_changes }}'
    governance_index: ../governance/index.json
    knowledge_graph: '{{ kg_result.output_file }}'
  step: 9
- action: reference_check
  description: æª¢æŸ¥æ˜¯å¦æœ‰æ–·æ‰çš„å¼•ç”¨æˆ–é€£çµ
  name: Check for Broken References
  output_var: broken_refs
  parameters:
    changes: '{{ classified_changes }}'
    check_types:
    - imports
    - links
    - dependencies
    - governance_refs
    knowledge_graph: '{{ kg_result.output_file }}'
  step: 10
- action: update_index
  description: æ›´æ–°å…¨å±€æ²»ç†ç´¢å¼•
  name: Update Governance Index
  output_var: index_update_result
  parameters:
    index_file: ../governance/index.json
    updates:
      deleted_artifacts: '{{ impact_analysis.deleted_artifacts }}'
      modified_artifacts: '{{ impact_analysis.modified_artifacts }}'
      new_artifacts: '{{ impact_analysis.new_artifacts }}'
      timestamp: '{{ now() }}'
  step: 11
- action: update_dag
  description: åŒæ­¥æ›´æ–°æ²»ç† DAG
  name: Update DAG
  output_var: dag_update_result
  parameters:
    dag_file: ../governance/dag.graphml
    knowledge_graph: '{{ kg_result.output_file }}'
    preserve_manual_edges: true
  step: 12
- action: update_vectors
  description: æ›´æ–°å‘é‡ç´¢å¼•
  name: Update Vector Indices
  output_var: vector_update_result
  parameters:
    artifacts: '{{ impact_analysis.affected_artifacts }}'
    batch_size: 50
    dimensions:
    - content
    - structure
    - governance
    embedding_model: text-embedding-ada-002
  step: 13
- action: generate_report
  description: ç”Ÿæˆè®Šå‹•æ‘˜è¦å ±å‘Š
  name: Generate Change Summary
  output_var: change_summary
  parameters:
    template: '# Repository Change Summary


      **Timestamp**: {{ change_metadata.commit_timestamp }}

      **Commit**: {{ change_metadata.commit_sha }}

      **Author**: {{ change_metadata.commit_author }}

      **Message**: {{ change_metadata.commit_message }}


      ## Changes Detected


      {{ classified_changes | format_table }}


      ## Impact Analysis


      - **Affected Artifacts**: {{ impact_analysis.affected_count }}

      - **New Artifacts**: {{ impact_analysis.new_artifacts | length }}

      - **Modified Artifacts**: {{ impact_analysis.modified_artifacts | length }}

      - **Deleted Artifacts**: {{ impact_analysis.deleted_artifacts | length }}


      ## Related Content


      ### Related Artifacts ({{ related_artifacts | length }})

      {{ related_artifacts | format_list }}


      ### Highly Related Content ({{ highly_related_content | length }})

      {{ highly_related_content | format_list }}


      ## Broken References


      {{ broken_refs | format_issues }}


      ## Knowledge Graph Status


      - **MN-DOC**: {{ mndoc_result.status }}

      - **Knowledge Graph**: {{ kg_result.status }}

      - **SuperRoot Entities**: {{ superroot_result.status }}

      - **Governance Index**: {{ index_update_result.status }}

      - **Vector Indices**: {{ vector_update_result.status }}

      '
  step: 14
- action: log_to_trust_chain
  description: è¨˜éŒ„åˆ°è­‰æ“šéˆ
  name: Log to Trust Chain
  output_var: trust_chain_entry
  parameters:
    artifact_ids: '{{ impact_analysis.affected_artifacts | map(''id'') }}'
    event: knowledge_sync_completed
    metadata:
      affected_artifacts_count: '{{ impact_analysis.affected_count }}'
      broken_refs_count: '{{ broken_refs | length }}'
      changes_count: '{{ classified_changes | length }}'
      commit_sha: '{{ change_metadata.commit_sha }}'
      highly_related_count: '{{ highly_related_content | length }}'
      related_artifacts_count: '{{ related_artifacts | length }}'
      timestamp: '{{ now() }}'
  step: 15
- action: store_record
  description: å„²å­˜å®Œæ•´çš„è®Šå‹•è¨˜éŒ„ä¾›æœªä¾†æŸ¥è©¢
  name: Store Change Record
  output_var: record_stored
  parameters:
    content:
      broken_refs: '{{ broken_refs }}'
      changes: '{{ classified_changes }}'
      commit: '{{ change_metadata }}'
      governance_updates:
        dag: '{{ dag_update_result }}'
        index: '{{ index_update_result }}'
        vectors: '{{ vector_update_result }}'
      highly_related: '{{ highly_related_content }}'
      impact: '{{ impact_analysis }}'
      knowledge_artifacts:
        knowledge_graph: '{{ kg_result }}'
        mndoc: '{{ mndoc_result }}'
        superroot: '{{ superroot_result }}'
      related: '{{ related_artifacts }}'
      summary: '{{ change_summary }}'
    filename: change-{{ change_metadata.commit_sha }}.yaml
    storage_path: ../state/change-records/
  step: 16
task_type: sync_knowledge
triggers:
- condition: 'true'
  event: git.push
  priority: high
- condition: 'true'
  event: git.commit
  priority: high
- condition: 'true'
  event: workflow.completed
  priority: medium
- event: scheduled.knowledge_sync
  priority: low
  schedule: 0 */6 * * *
version: 1.0.0
