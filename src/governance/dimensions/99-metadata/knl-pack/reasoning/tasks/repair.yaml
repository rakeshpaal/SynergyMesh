task_type: repair
name: "Auto-Repair Governance Artifacts"
description: "åµæ¸¬å•é¡Œ â†’ ç”Ÿæˆ patch â†’ æäº¤ PR"
version: "1.0.0"

metadata:
  priority: P1
  estimated_duration: "< 10 minutes"
  auto_trigger: false  # Requires manual approval or diagnosis output

steps:
  - step: 1
    name: "Load Diagnosis Results"
    action: "load_input"
    input_var: "issues"
    output_var: "diagnosis_issues"
    description: "è¼‰å…¥è¨ºæ–·çµæœ"
    validation:
      required: true
      min_issues: 1

  - step: 2
    name: "Filter Repairable Issues"
    action: "filter"
    parameters:
      issues: "{{ diagnosis_issues }}"
      criteria:
        repairable: true
        severity: ["critical", "high", "medium"]
    output_var: "repairable_issues"
    description: "ç¯©é¸å¯ä¿®å¾©çš„å•é¡Œ"

  - step: 3
    name: "Retrieve Context for Each Issue"
    action: "vector_search"
    parameters:
      query_template: "For issue '{{ issue.type }}' on '{{ issue.affected_artifacts }}', find similar artifacts and best practices"
      issues: "{{ repairable_issues }}"
      dimensions: ["content", "structure", "governance"]
      top_k: 5
    output_var: "repair_context"
    description: "ç‚ºæ¯å€‹å•é¡Œæª¢ç´¢ç›¸é—œä¸Šä¸‹æ–‡"

  - step: 4
    name: "Generate Repair Plans"
    action: "rag_answer"
    parameters:
      style: "patch"
      prompt_template: |
        You are a governance repair assistant. Generate minimal, precise patches.
        
        **Issue Details:**
        Type: {{ issue.type }}
        Severity: {{ issue.severity }}
        Affected Artifacts: {{ issue.affected_artifacts }}
        Evidence: {{ issue.evidence }}
        
        **Context from Similar Artifacts:**
        {{ context }}
        
        **Task:**
        Generate a JSON patch for each affected artifact to fix the issue.
        Format: {
          "file": "path/to/file",
          "operation": "create|update|delete",
          "changes": {...},
          "rationale": "why this fix is correct"
        }
      issues: "{{ repairable_issues }}"
      context: "{{ repair_context }}"
    output_var: "repair_plans"
    description: "ç”Ÿæˆä¿®å¾©è¨ˆåŠƒ"

  - step: 5
    name: "Generate Patches"
    action: "git_patch"
    parameters:
      plans: "{{ repair_plans }}"
      format: "unified_diff"
    output_var: "patches"
    description: "ç”Ÿæˆ Git patches"

  - step: 6
    name: "Pre-flight Check - Guardian Validation"
    action: "guardian_check"
    parameters:
      patches: "{{ patches }}"
      checks:
        - name: "no_breaking_changes"
          description: "ç¢ºä¿è®Šæ›´ä¸æœƒç ´å£ç¾æœ‰ä¾è³´"
          max_affected: 50
        - name: "all_policies_compliant"
          description: "æ‰€æœ‰ç­–ç•¥å¿…é ˆåˆè¦"
          policies: ["naming-convention", "metadata-completeness"]
        - name: "impact_radius"
          description: "è®Šæ›´å½±éŸ¿ç¯„åœé™åˆ¶"
          max_artifacts: 50
          max_depth: 3
    output_var: "guardian_result"
    description: "å®ˆè­·æ¬„æª¢æŸ¥"

  - step: 7
    name: "Apply Patches Locally"
    action: "apply_patch"
    if: "guardian_result.passed == true"
    parameters:
      patches: "{{ patches }}"
      mode: "dry_run"
    output_var: "patch_result"
    description: "æœ¬åœ°æ‡‰ç”¨ patchesï¼ˆdry runï¼‰"

  - step: 8
    name: "Validate After Patch"
    action: "run_validators"
    if: "patch_result.success == true"
    parameters:
      validators:
        - "yaml_syntax"
        - "json_syntax"
        - "opa_policy"
    output_var: "validation_result"
    description: "é©—è­‰ patch å¾Œçš„æª”æ¡ˆ"

  - step: 9
    name: "Create Pull Request"
    action: "create_pr"
    if: "validation_result.passed == true"
    parameters:
      branch_name: "auto-repair/{{ timestamp }}"
      title: "ğŸ¤– Auto-Repair: {{ repairable_issues | map('type') | join(', ') }}"
      body_template: |
        ## Auto-Repair: Governance Issues Fixed
        
        This PR automatically fixes {{ repairable_issues | length }} governance issue(s).
        
        ### Issues Fixed
        
        {{ repairable_issues | format_list }}
        
        ### Changes
        
        {{ patches | format_diff }}
        
        ### Evidence & Context
        
        {{ repair_context | format_evidence }}
        
        ### Guardian Checks
        
        {{ guardian_result | format_checks }}
        
        ### Validation Results
        
        {{ validation_result | format_results }}
        
        ---
        
        **Generated by**: DAR Auto-Repair System  
        **Timestamp**: {{ timestamp }}  
        **Task ID**: {{ task_id }}
      patches: "{{ patches }}"
      labels: ["auto-repair", "governance", "dar-generated"]
    output_var: "pr_info"
    description: "å‰µå»º Pull Request"

  - step: 10
    name: "Log to Trust Chain"
    action: "log_to_trust_chain"
    parameters:
      event: "repair_task_completed"
      artifact_ids: "{{ repairable_issues | map('affected_artifacts') | flatten }}"
      metadata:
        issues_fixed: "{{ repairable_issues | length }}"
        pr_url: "{{ pr_info.url }}"
        pr_number: "{{ pr_info.number }}"
        patches_applied: "{{ patches | length }}"
        guardian_passed: "{{ guardian_result.passed }}"
        timestamp: "{{ now() }}"
    output_var: "trust_chain_entry"
    description: "è¨˜éŒ„åˆ°è­‰æ“šéˆ"

output:
  success: "{{ pr_info is defined }}"
  pr_url: "{{ pr_info.url if pr_info is defined else null }}"
  pr_number: "{{ pr_info.number if pr_info is defined else null }}"
  issues_fixed: "{{ repairable_issues | length }}"
  patches_applied: "{{ patches | length }}"
  guardian_result: "{{ guardian_result }}"
  validation_result: "{{ validation_result }}"

error_handling:
  on_guardian_failure:
    action: "notify"
    method: "github_issue"
    template: "Guardian checks failed for auto-repair. Manual review required."
  on_validation_failure:
    action: "rollback"
    notify: true

triggers:
  - event: "diagnosis_completed"
    condition: "critical_issues_found == true && auto_fix_enabled == true"
  - event: "manual_request"
    condition: "true"

notifications:
  on_pr_created:
    method: "github_comment"
    template: "Auto-repair PR created: {{ pr_info.url }}"
  on_failure:
    method: "github_issue"
    template: "Auto-repair failed. Issues: {{ repairable_issues | length }}"
