description: åµæ¸¬å•é¡Œ â†’ ç”Ÿæˆ patch â†’ æäº¤ PR
error_handling:
  on_guardian_failure:
    action: notify
    method: github_issue
    template: Guardian checks failed for auto-repair. Manual review required.
  on_validation_failure:
    action: rollback
    notify: true
metadata:
  auto_trigger: false
  estimated_duration: < 10 minutes
  priority: P1
name: Auto-Repair Governance Artifacts
notifications:
  on_failure:
    method: github_issue
    template: 'Auto-repair failed. Issues: {{ repairable_issues | length }}'
  on_pr_created:
    method: github_comment
    template: 'Auto-repair PR created: {{ pr_info.url }}'
output:
  guardian_result: '{{ guardian_result }}'
  issues_fixed: '{{ repairable_issues | length }}'
  patches_applied: '{{ patches | length }}'
  pr_number: '{{ pr_info.number if pr_info is defined else null }}'
  pr_url: '{{ pr_info.url if pr_info is defined else null }}'
  success: '{{ pr_info is defined }}'
  validation_result: '{{ validation_result }}'
steps:
- action: load_input
  description: è¼‰å…¥è¨ºæ–·çµæœ
  input_var: issues
  name: Load Diagnosis Results
  output_var: diagnosis_issues
  step: 1
  validation:
    min_issues: 1
    required: true
- action: filter
  description: ç¯©é¸å¯ä¿®å¾©çš„å•é¡Œ
  name: Filter Repairable Issues
  output_var: repairable_issues
  parameters:
    criteria:
      repairable: true
      severity:
      - critical
      - high
      - medium
    issues: '{{ diagnosis_issues }}'
  step: 2
- action: vector_search
  description: ç‚ºæ¯å€‹å•é¡Œæª¢ç´¢ç›¸é—œä¸Šä¸‹æ–‡
  name: Retrieve Context for Each Issue
  output_var: repair_context
  parameters:
    dimensions:
    - content
    - structure
    - governance
    issues: '{{ repairable_issues }}'
    query_template: For issue '{{ issue.type }}' on '{{ issue.affected_artifacts }}',
      find similar artifacts and best practices
    top_k: 5
  step: 3
- action: rag_answer
  description: ç”Ÿæˆä¿®å¾©è¨ˆåŠƒ
  name: Generate Repair Plans
  output_var: repair_plans
  parameters:
    context: '{{ repair_context }}'
    issues: '{{ repairable_issues }}'
    prompt_template: "You are a governance repair assistant. Generate minimal, precise\
      \ patches.\n\n**Issue Details:**\nType: {{ issue.type }}\nSeverity: {{ issue.severity\
      \ }}\nAffected Artifacts: {{ issue.affected_artifacts }}\nEvidence: {{ issue.evidence\
      \ }}\n\n**Context from Similar Artifacts:**\n{{ context }}\n\n**Task:**\nGenerate\
      \ a JSON patch for each affected artifact to fix the issue.\nFormat: {\n  \"\
      file\": \"path/to/file\",\n  \"operation\": \"create|update|delete\",\n  \"\
      changes\": {...},\n  \"rationale\": \"why this fix is correct\"\n}\n"
    style: patch
  step: 4
- action: git_patch
  description: ç”Ÿæˆ Git patches
  name: Generate Patches
  output_var: patches
  parameters:
    format: unified_diff
    plans: '{{ repair_plans }}'
  step: 5
- action: guardian_check
  description: å®ˆè­·æ¬„æª¢æŸ¥
  name: Pre-flight Check - Guardian Validation
  output_var: guardian_result
  parameters:
    checks:
    - description: ç¢ºä¿è®Šæ›´ä¸æœƒç ´å£ç¾æœ‰ä¾è³´
      max_affected: 50
      name: no_breaking_changes
    - description: æ‰€æœ‰ç­–ç•¥å¿…é ˆåˆè¦
      name: all_policies_compliant
      policies:
      - naming-convention
      - metadata-completeness
    - description: è®Šæ›´å½±éŸ¿ç¯„åœé™åˆ¶
      max_artifacts: 50
      max_depth: 3
      name: impact_radius
    patches: '{{ patches }}'
  step: 6
- action: apply_patch
  description: æœ¬åœ°æ‡‰ç”¨ patchesï¼ˆdry runï¼‰
  if: guardian_result.passed == true
  name: Apply Patches Locally
  output_var: patch_result
  parameters:
    mode: dry_run
    patches: '{{ patches }}'
  step: 7
- action: run_validators
  description: é©—è­‰ patch å¾Œçš„æª”æ¡ˆ
  if: patch_result.success == true
  name: Validate After Patch
  output_var: validation_result
  parameters:
    validators:
    - yaml_syntax
    - json_syntax
    - opa_policy
  step: 8
- action: create_pr
  description: å‰µå»º Pull Request
  if: validation_result.passed == true
  name: Create Pull Request
  output_var: pr_info
  parameters:
    body_template: "## Auto-Repair: Governance Issues Fixed\n\nThis PR automatically\
      \ fixes {{ repairable_issues | length }} governance issue(s).\n\n### Issues\
      \ Fixed\n\n{{ repairable_issues | format_list }}\n\n### Changes\n\n{{ patches\
      \ | format_diff }}\n\n### Evidence & Context\n\n{{ repair_context | format_evidence\
      \ }}\n\n### Guardian Checks\n\n{{ guardian_result | format_checks }}\n\n###\
      \ Validation Results\n\n{{ validation_result | format_results }}\n\n---\n\n\
      **Generated by**: DAR Auto-Repair System  \n**Timestamp**: {{ timestamp }} \
      \ \n**Task ID**: {{ task_id }}\n"
    branch_name: auto-repair/{{ timestamp }}
    labels:
    - auto-repair
    - governance
    - dar-generated
    patches: '{{ patches }}'
    title: 'ğŸ¤– Auto-Repair: {{ repairable_issues | map(''type'') | join('', '') }}'
  step: 9
- action: log_to_trust_chain
  description: è¨˜éŒ„åˆ°è­‰æ“šéˆ
  name: Log to Trust Chain
  output_var: trust_chain_entry
  parameters:
    artifact_ids: '{{ repairable_issues | map(''affected_artifacts'') | flatten }}'
    event: repair_task_completed
    metadata:
      guardian_passed: '{{ guardian_result.passed }}'
      issues_fixed: '{{ repairable_issues | length }}'
      patches_applied: '{{ patches | length }}'
      pr_number: '{{ pr_info.number }}'
      pr_url: '{{ pr_info.url }}'
      timestamp: '{{ now() }}'
  step: 10
task_type: repair
triggers:
- condition: critical_issues_found == true && auto_fix_enabled == true
  event: diagnosis_completed
- condition: 'true'
  event: manual_request
version: 1.0.0
