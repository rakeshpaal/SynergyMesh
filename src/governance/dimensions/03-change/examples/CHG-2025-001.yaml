apiVersion: machinenativeops.io/v2
kind: ChangeRequest
metadata:
  createdAt: '2025-12-17T10:00:00Z'
  id: CHG-2025-001
  labels:
    machinenativeops.io/priority: P1
    machinenativeops.io/service: payment
    machinenativeops.io/team: backend
  title: 升级 Payment Service 到 v2.0.0
spec:
  approval:
    approvedAt: '2025-12-17T14:00:00Z'
    approver: tech-lead@example.com
    comments: 批准。测试覆盖充分，风险可控。建议在周二维护窗口执行。
    method: CAB
    status: Approved
  communication:
    notificationChannels:
    - slack:#engineering
    - slack:#operations
    - email:all-engineering@example.com
    stakeholders:
    - backend-team@example.com
    - product-manager@example.com
    - customer-support@example.com
    statusPageUpdate: true
  impactAssessment:
    dataImpact: none
    dependencies:
    - Database schema v2.0 已部署
    - API Gateway 配置已更新
    downtimeExpected: 5 min
    servicesAffected:
    - payment-service
    - order-service
    - billing-service
    usersImpacted: 5000
  implementationPlan:
    postChecks:
    - 检查服务健康状态
    - 验证关键业务流程
    - 确认无错误告警
    - 检查错误率和响应时间
    - 验证数据一致性
    - 更新文档
    - 通知变更完成
    preChecks:
    - 确认测试环境已验证
    - 确认备份已完成
    - 验证回滚方案可用
    - 确认监控和告警正常
    - 通知所有相关团队
    - 更新状态页
    steps:
    - assignee: john.doe
      description: 通知相关团队和利益相关者
      estimatedDuration: 5 min
      order: 1
      validationCriteria: 确认所有团队收到通知
    - assignee: ops-team
      description: 备份当前配置和数据库
      estimatedDuration: 10 min
      order: 2
      validationCriteria: 备份文件存在且可恢复
    - assignee: john.doe
      description: 更新 Kubernetes Deployment 为新版本
      estimatedDuration: 5 min
      order: 3
      validationCriteria: kubectl apply 成功
    - assignee: ops-team
      description: 等待新 Pod 启动并通过健康检查
      estimatedDuration: 10 min
      order: 4
      validationCriteria: 所有 Pod Running 且 Ready
    - assignee: qa-team
      description: 执行烟雾测试
      estimatedDuration: 10 min
      order: 5
      validationCriteria: 关键业务流程正常
    - assignee: ops-team
      description: 监控服务指标和日志
      estimatedDuration: 15 min
      order: 6
      validationCriteria: 无异常告警，错误率正常
  metrics:
    audit:
      logEnabled: true
      reviewer: audit-team@example.com
    kpi:
    - baseline: 120ms
      name: response_time
      target: <150ms
    - baseline: 0.08%
      name: error_rate
      target: <0.1%
    - baseline: 800 req/s
      name: throughput
      target: '>900 req/s'
  priority: P1
  requester:
    email: john.doe@example.com
    name: John Doe
    team: backend-team
    userId: john.doe
  riskLevel: 中
  rollbackPlan:
    estimatedTime: 10 min
    steps:
    - description: 停止新版本 Deployment
      order: 1
    - description: 回滚到 v1.3.0
      order: 2
    - description: 验证回滚成功
      order: 3
    - description: 恢复配置（如有必要）
      order: 4
    triggers:
    - 健康检查连续失败 3 次
    - 错误率超过 1%
    - 响应时间超过基线 200%
    - 关键业务流程验证失败
    - 数据一致性问题
  scheduledWindow:
    endTime: '2025-12-20T03:00:00Z'
    startTime: '2025-12-20T02:00:00Z'
    timezone: UTC
  testing:
    environment: staging
    testCases:
    - '功能测试: 支付创建、查询、退款'
    - '性能测试: 响应时间 < 200ms, TPS > 1000'
    - '集成测试: 与订单服务、账单服务集成'
    - '回归测试: 现有功能无影响'
    testResults: https://testresults.example.com/payment-v2.0.0
  type: 常规变更
status:
  lastUpdate: '2025-12-17T14:30:00Z'
  notes:
  - author: john.doe
    message: 变更请求已创建
    timestamp: '2025-12-17T10:00:00Z'
  - author: tech-lead
    message: CAB 批准。测试覆盖充分，风险可控。
    timestamp: '2025-12-17T14:00:00Z'
  - author: john.doe
    message: 已安排在 2025-12-20 02:00 UTC 执行
    timestamp: '2025-12-17T14:30:00Z'
  phase: Scheduled
