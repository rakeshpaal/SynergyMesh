data_types:
  component_id:
    example: user-service
    format: kebab-case
    pattern: ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$
  file_path:
    example: services/agents/notification-agent/
    format: relative path from repo root
  responsibility:
    format: natural language
    language: Traditional Chinese
    max_length: 200
  service_id:
    example: notification-svc
    format: kebab-case
    pattern: ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$
error_codes:
  ARCH_001:
    message: 服務 ID 已存在
    solution: 使用不同的服務 ID
  ARCH_002:
    message: 檢測到循環依賴
    solution: 重新設計服務邊界以打破循環
  ARCH_003:
    message: 邊界衝突
    solution: 檢查現有服務邊界定義
  ARCH_004:
    message: 缺少必填欄位
    solution: 根據 schema 提供所有必填欄位
input:
  description: AI 向此骨架提交的架構設計或修改請求
  examples:
  - action_type: design_service
    affected_components:
    - component_id: user-service
      path: services/agents/...
    context:
      constraints:
      - 必須與現有 User Service 整合
      - 需要異步處理隊列
      description: 設計新的通知服務，支援多通道
      project_name: notification-service
      scope: microservice
    success_criteria:
    - 服務邊界清晰
    - 依賴無衝突
    - 可測試性良好
  schema:
    $schema: http://json-schema.org/draft-07/schema#
    properties:
      action_type:
        description: 請求的操作類型
        enum:
        - design_service
        - define_boundary
        - analyze_dependencies
        - refactor_architecture
        - validate_design
        - propose_change
        type: string
      affected_components:
        description: 涉及的現有元件
        items:
          properties:
            component_id:
              type: string
            current_responsibility:
              type: string
            path:
              type: string
          type: object
        type: array
      change_proposal:
        description: 架構變更提案（當 action_type = 'propose_change' 時必填）
        properties:
          changes:
            description: 具體變更項目
            items:
              properties:
                action:
                  description: 變更動作
                  enum:
                  - add_module
                  - remove_module
                  - change_dependency
                  - modify_interface
                  - refactor_layer
                  type: string
                details:
                  description: 與 action 相關的額外欄位（例如新增依賴的 from/to）
                  type: object
                target_module:
                  description: 受影響模組 ID
                  type: string
              required:
              - action
              - target_module
              type: object
            type: array
          description:
            description: 用人類可讀文字描述變更目的（例如：新增 reporting-service）
            type: string
          id:
            description: 提案唯一識別碼
            example: PROP-2025-001
            type: string
        required:
        - id
        - description
        - changes
        type: object
      context:
        description: 操作上下文
        properties:
          constraints:
            description: 設計約束條件
            items:
              type: string
            type: array
          description:
            description: 需求或設計說明
            type: string
          project_name:
            description: 專案或服務名稱
            type: string
          scope:
            description: 設計範圍
            enum:
            - microservice
            - module
            - layer
            - system
            type: string
        type: object
      success_criteria:
        description: 成功標準
        items:
          type: string
        type: array
    required:
    - action_type
    - context
    type: object
optional_fields:
  for_input:
  - affected_components
  - success_criteria
  - context.constraints
  for_output:
  - recommended_changes
  - dependency_analysis
output:
  description: 此骨架返回給 AI 的架構設計結果
  examples:
  - design:
      architecture_diagram: "[User Service] -> [Notification Service] -> [Message\
        \ Queue]\n                            |\n                            +-> [Email\
        \ Provider]\n                            +-> [SMS Provider]\n"
      boundaries:
        external_dependencies:
        - direction: inbound
          interface_type: REST
          service_id: user-svc
        - direction: outbound
          interface_type: Queue
          service_id: message-queue
        responsibilities:
        - 管理通知模板
        - 發送多通道通知
        - 追蹤通知狀態
      service_id: notification-svc
      service_name: Notification Service
    status: success
    validation_result:
      issues: []
      valid: true
  schema:
    $schema: http://json-schema.org/draft-07/schema#
    properties:
      dependency_analysis:
        description: 依賴分析結果
        properties:
          circular_dependencies:
            description: 檢測到的循環依賴
            items:
              type: string
            type: array
          dependency_graph:
            items:
              properties:
                from:
                  type: string
                to:
                  type: string
                type:
                  enum:
                  - direct
                  - transitive
              type: object
            type: array
          severity_level:
            enum:
            - none
            - warning
            - error
            type: string
        type: object
      design:
        description: 設計結果
        properties:
          architecture_diagram:
            description: ASCII 或 PlantUML 架構圖
            type: string
          boundaries:
            description: 服務邊界定義
            properties:
              external_dependencies:
                items:
                  properties:
                    direction:
                      enum:
                      - inbound
                      - outbound
                    interface_type:
                      type: string
                    service_id:
                      type: string
                  type: object
                type: array
              internal_modules:
                items:
                  properties:
                    module_id:
                      type: string
                    responsibility:
                      type: string
                  type: object
                type: array
              responsibilities:
                items:
                  type: string
                type: array
            type: object
          service_id:
            type: string
          service_name:
            type: string
        type: object
      recommended_changes:
        description: 建議的變更
        items:
          properties:
            change_type:
              enum:
              - add
              - modify
              - remove
              type: string
            description:
              type: string
            target_file:
              type: string
          type: object
        type: array
      stability_report:
        description: 對某個 dependency_graph + change_proposal 的架構穩定性檢查報告
        properties:
          overall_status:
            description: 整體結果：通過 / 不通過 / 有警告
            enum:
            - pass
            - fail
            - warning
            type: string
          proposal_id:
            description: 對應的 change_proposal.id
            type: string
          suggested_changes:
            description: AI 建議的修正方案（可選）
            items:
              properties:
                description:
                  description: 建議如何調整架構以消除違規
                  type: string
              required:
              - description
              type: object
            type: array
          violations:
            description: 違反架構規則的清單
            items:
              properties:
                explanation:
                  description: 用自然語言說明為何違規
                  type: string
                related_modules:
                  description: 受此違規影響的模組 ID 列表
                  items:
                    type: string
                  type: array
                rule_id:
                  description: 對應到 invariants/layering-rules 中的規則 ID
                  type: string
                severity:
                  description: 嚴重程度
                  enum:
                  - critical
                  - high
                  - medium
                  - low
                  type: string
              required:
              - rule_id
              - severity
              - explanation
              - related_modules
              type: object
            type: array
        required:
        - proposal_id
        - overall_status
        - violations
        type: object
      status:
        description: 操作狀態
        enum:
        - success
        - needs_revision
        - conflict_detected
        type: string
      validation_result:
        properties:
          issues:
            items:
              properties:
                description:
                  type: string
                issue_type:
                  enum:
                  - boundary_violation
                  - circular_dependency
                  - missing_interface
                  type: string
                recommendation:
                  type: string
                severity:
                  enum:
                  - error
                  - warning
                  - info
                  type: string
              type: object
            type: array
          valid:
            type: boolean
        type: object
    required:
    - status
    - design
    - validation_result
    type: object
required_fields:
  for_input:
  - action_type
  - context
  - context.project_name
  - context.description
  - context.scope
  for_output:
  - status
  - design
  - design.service_id
  - design.boundaries
  - validation_result
  - validation_result.valid
skeleton_id: architecture-stability
validation_rules:
- check: 在 config/unified-config-index.yaml 中查詢
  description: 服務 ID 在系統中必須唯一
  rule: service_id_unique
- check: 運行依賴分析工具
  description: 不允許循環依賴
  rule: no_circular_dependencies
- check: 檢查責任矩陣
  description: 服務邊界不應重疊
  rule: boundary_non_overlapping
- check: 檢查 API 版本
  description: 服務介面必須一致
  rule: interface_consistency
version: 1.0.0
