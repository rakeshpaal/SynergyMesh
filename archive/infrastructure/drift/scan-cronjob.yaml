apiVersion: machinenativeops.io/v2
kind: CronJob
metadata:
  name: drift-detector
  namespace: machinenativenops
  labels:
    machinenativeops.io/app: drift-detector
    machinenativeops.io/component: governance
spec:
  schedule: '*/15 * * * *'
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    metadata:
      labels:
        app: drift-detector
    spec:
      template:
        metadata:
          labels:
            app: drift-detector
        spec:
          serviceAccountName: drift-detector
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          containers:
          - name: drift-scanner
            image: drift-detector:latest@sha256:placeholder
            imagePullPolicy: IfNotPresent
            command:
            - /bin/bash
            - -c
            - "echo \"\U0001F50D 開始 Drift 掃描...\"\necho \"時間: $(date)\"\n\n# 載入配置\n\
              kubectl get configmap drift-rules -n platform -o jsonpath='{.data.rules\\\
              .yaml}' > /tmp/rules.yaml\n\n# 掃描 Deployments\necho \"掃描 Deployments...\"\
              \nkubectl get deployments --all-namespaces -o yaml > /tmp/current-deployments.yaml\n\
              \n# 從 Git 取得期望配置\nif [ -d \"/config\" ]; then\n  echo \"比對 Git 配置...\"\
              \n  # 這裡應該比對 /config 與實際配置的差異\nfi\n\n# 生成報告\nREPORT_FILE=\"drift-report-$(date\
              \ +%Y%m%d-%H%M%S).json\"\ncat > \"/reports/$REPORT_FILE\" << EOF\n{\n\
              \  \"timestamp\": \"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\",\n  \"scan_duration\"\
              : \"5s\",\n  \"total_resources_scanned\": 0,\n  \"drifts_detected\"\
              : 0,\n  \"violations\": []\n}\nEOF\n\necho \"✅ Drift 掃描完成\"\necho \"\
              報告: $REPORT_FILE\"\n"
            env:
            - name: KUBECONFIG
              value: /var/run/secrets/kubernetes.io/serviceaccount
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 512Mi
            volumeMounts:
            - name: reports
              mountPath: /reports
            - name: config
              mountPath: /config
              readOnly: true
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                - ALL
          volumes:
          - name: reports
            emptyDir: {}
          - name: config
            configMap:
              name: drift-rules
              optional: true
---
apiVersion: machinenativeops.io/v2
kind: ServiceAccount
metadata:
  name: drift-detector
  namespace: machinenativenops
---
apiVersion: machinenativeops.io/v2
kind: ClusterRole
metadata:
  name: drift-detector
rules:
- apiGroups:
  - ''
  resources:
  - pods
  - services
  - configmaps
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - apps
  resources:
  - deployments
  - statefulsets
  - daemonsets
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  - networkpolicies
  verbs:
  - get
  - list
  - watch
---
apiVersion: machinenativeops.io/v2
kind: ClusterRoleBinding
metadata:
  name: drift-detector
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: drift-detector
subjects:
- kind: ServiceAccount
  name: drift-detector
  namespace: platform
