apiVersion: machinenativeops.io/v2
kind: CronJob
metadata:
  labels:
    machinenativeops.io/app: postgres
    machinenativeops.io/component: backup
  name: postgres-backup
  namespace: machinenativenops
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: postgres-backup
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - 'BACKUP_FILE="/backup/postgres-$(date +%Y%m%d-%H%M%S).sql.gz"

              pg_dump -h postgres -U $POSTGRES_USER -d $POSTGRES_DB | gzip > $BACKUP_FILE

              echo "Backup completed: $BACKUP_FILE"


              # 清理 7 天前的備份

              find /backup -name "postgres-*.sql.gz" -mtime +7 -delete

              '
            env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  key: DATABASE_USER
                  name: autofix-secrets
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: DATABASE_PASSWORD
                  name: autofix-secrets
            - name: POSTGRES_DB
              value: autofix
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  key: DATABASE_PASSWORD
                  name: autofix-secrets
            image: postgres:15-alpine
            name: backup
            resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 256Mi
            securityContext:
              allowPrivilegeEscalation: false
            volumeMounts:
            - mountPath: /backup
              name: backup
          restartPolicy: OnFailure
          volumes:
          - name: backup
            persistentVolumeClaim:
              claimName: postgres-backup-pvc
  schedule: 0 2 * * *
  successfulJobsHistoryLimit: 3
