apiVersion: machinenativeops.io/v2
kind: ServiceMonitor
metadata:
  name: hlp-executor-metrics
  namespace: machinenativenops
  labels:
    machinenativeops.io/app: hlp-executor-core
    machinenativeops.io/component: monitoring
    machinenativeops.io/prometheus: kube-prometheus
  annotations:
    machinenativeops.io/description: ServiceMonitor for HLP Executor Core metrics
    machinenativeops.io/docs: https://docs.unmanned-island.io/hlp-executor/monitoring
spec:
  selector:
    matchLabels:
      app: hlp-executor-core
      component: metrics
  namespaceSelector:
    matchNames:
    - unmanned-island-system
  endpoints:
  - port: metrics
    interval: 30s
    scrapeTimeout: 10s
    path: /metrics
    scheme: http
    relabelings:
    - sourceLabels:
      - __meta_kubernetes_namespace
      targetLabel: namespace
      action: replace
    - sourceLabels:
      - __meta_kubernetes_pod_name
      targetLabel: pod
      action: replace
    - sourceLabels:
      - __meta_kubernetes_service_name
      targetLabel: service
      action: replace
    - sourceLabels:
      - __meta_kubernetes_pod_ip
      targetLabel: instance
      action: replace
    metricRelabelings:
    - sourceLabels:
      - __name__
      regex: go_gc_.*
      action: drop
    - targetLabel: component
      replacement: hlp-executor-core
      action: replace
    - targetLabel: system
      replacement: unmanned-island
      action: replace
---
apiVersion: machinenativeops.io/v2
kind: PrometheusRule
metadata:
  name: hlp-executor-alerts
  namespace: machinenativenops
  labels:
    machinenativeops.io/app: hlp-executor-core
    machinenativeops.io/prometheus: kube-prometheus
    machinenativeops.io/role: alert-rules
spec:
  groups:
  - name: hlp-executor-core
    interval: 30s
    rules:
    - alert: HLPExecutorHighErrorRate
      expr: 'rate(hlp_executor_errors_total[5m]) > 0.01

        '
      for: 5m
      labels:
        severity: warning
        component: hlp-executor-core
      annotations:
        summary: HLP Executor has high error rate
        description: 'HLP Executor error rate is {{ $value }} errors/sec (threshold:
          0.01)'
    - alert: HLPExecutorHighQueueDepth
      expr: 'hlp_executor_queue_depth > 1000

        '
      for: 5m
      labels:
        severity: warning
        component: hlp-executor-core
      annotations:
        summary: HLP Executor queue depth is high
        description: 'HLP Executor queue depth is {{ $value }} (threshold: 1000)'
    - alert: HLPExecutorHighLatency
      expr: 'histogram_quantile(0.95, rate(hlp_executor_execution_latency_seconds_bucket[5m]))
        > 1.0

        '
      for: 5m
      labels:
        severity: warning
        component: hlp-executor-core
      annotations:
        summary: HLP Executor P95 latency is high
        description: 'HLP Executor P95 latency is {{ $value }}s (threshold: 1s)'
    - alert: HLPExecutorDown
      expr: 'up{job="hlp-executor-core"} == 0

        '
      for: 1m
      labels:
        severity: critical
        component: hlp-executor-core
      annotations:
        summary: HLP Executor is down
        description: HLP Executor instance {{ $labels.instance }} is down
    - alert: HLPExecutorHighRollbackRate
      expr: 'rate(hlp_executor_rollbacks_total[5m]) > 0.5

        '
      for: 10m
      labels:
        severity: warning
        component: hlp-executor-core
      annotations:
        summary: HLP Executor has high rollback rate
        description: 'HLP Executor rollback rate is {{ $value }} rollbacks/sec (threshold:
          0.5)'
    - alert: HLPExecutorCircuitBreakerOpen
      expr: 'hlp_executor_circuit_breaker_state{state="open"} == 1

        '
      for: 5m
      labels:
        severity: warning
        component: hlp-executor-core
      annotations:
        summary: HLP Executor circuit breaker is open
        description: HLP Executor circuit breaker for {{ $labels.circuit }} is open
    - alert: HLPExecutorResourceExhaustion
      expr: 'hlp_executor_resource_utilization_percent > 90

        '
      for: 5m
      labels:
        severity: critical
        component: hlp-executor-core
      annotations:
        summary: HLP Executor resource utilization is high
        description: 'HLP Executor {{ $labels.resource }} utilization is {{ $value
          }}% (threshold: 90%)'
    - alert: HLPExecutorCheckpointFailure
      expr: 'rate(hlp_executor_checkpoint_failures_total[5m]) > 0.1

        '
      for: 5m
      labels:
        severity: warning
        component: hlp-executor-core
      annotations:
        summary: HLP Executor checkpoint failures detected
        description: HLP Executor checkpoint failure rate is {{ $value }} failures/sec
