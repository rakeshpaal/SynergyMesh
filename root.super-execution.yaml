# ⚡ Root 超級執行/流程定義配置
# MachineNativeOps Root Layer Super Execution Configuration
# Version: 1.0.0

apiVersion: machinenativeops.io/v1
kind: RootSuperExecutionConfig
metadata:
  name: super-execution-config
  namespace: machinenativenops-execution
  labels:
    machinenativeops.io/tier: "execution"
    machinenativeops.io/version: "v1.0.0"
    machinenativeops.io/component: "super-execution"
  annotations:
    machinenativeops.io/description: "Root layer super execution and workflow orchestration configuration"
    machinenativeops.io/last-modified: "2025-12-20T22:00:00Z"

spec:
  # === 執行流程定義 ===
  execution_flows:
    - name: "system-bootstrap-flow"
      description: "System bootstrap and initialization flow"
      version: "1.0.0"
      enabled: true
      criticality: "critical"
      triggers:
        - type: "system_startup"
          condition: "system.state = 'starting'"
        - type: "manual"
          condition: "user.role in ['system-administrator', 'operator'] AND manual_trigger = true"
      steps:
        - name: "validate_environment"
          module: "config-manager"
          action: "validate_configuration"
          timeout: "60s"
          retry_policy:
            max_attempts: 3
            backoff: "exponential"
            initial_delay: "5s"
          on_failure: "abort_flow"
          
        - name: "initialize_logging"
          module: "logging-service"
          action: "initialize"
          timeout: "30s"
          retry_policy:
            max_attempts: 2
            backoff: "fixed"
            delay: "10s"
          on_failure: "continue_with_warning"
          
        - name: "setup_trust_chain"
          module: "trust-manager"
          action: "initialize_trust"
          timeout: "120s"
          retry_policy:
            max_attempts: 3
            backoff: "exponential"
            initial_delay: "10s"
          on_failure: "abort_flow"
          
        - name: "load_governance_policies"
          module: "governance-engine"
          action: "load_policies"
          timeout: "90s"
          retry_policy:
            max_attempts: 3
            backoff: "exponential"
            initial_delay: "5s"
          on_failure: "abort_flow"
          
        - name: "register_modules"
          module: "super-execution-engine"
          action: "register_all_modules"
          timeout: "180s"
          retry_policy:
            max_attempts: 2
            backoff: "fixed"
            delay: "15s"
          on_failure: "continue_with_partial"
          
        - name: "initialize_provenance"
          module: "provenance-tracker"
          action: "initialize_tracking"
          timeout: "60s"
          retry_policy:
            max_attempts: 2
            backoff: "fixed"
            delay: "10s"
          on_failure: "continue_with_warning"
          
        - name: "validate_integrity"
          module: "integrity-validator"
          action: "baseline_validation"
          timeout: "300s"
          retry_policy:
            max_attempts: 1
            backoff: "none"
          on_failure: "create_incident"
          
      success_actions:
        - type: "notification"
          target: "system-administrator"
          message: "System bootstrap completed successfully"
        - type: "log_event"
          level: "INFO"
          message: "Super execution bootstrap flow completed"
          
      failure_actions:
        - type: "notification"
          target: "system-administrator"
          message: "System bootstrap failed - immediate attention required"
          priority: "high"
        - type: "create_incident"
          severity: "critical"
          title: "System Bootstrap Failure"
        - type: "rollback"
          target: "previous_stable_state"

    - name: "security-incident-response-flow"
      description: "Automated security incident response workflow"
      version: "1.0.0"
      enabled: true
      criticality: "critical"
      triggers:
        - type: "security_event"
          condition: "security.severity >= 'high' AND security.confirmed = true"
        - type: "manual"
          condition: "user.role in ['security-administrator', 'system-administrator'] AND incident_declared = true"
      steps:
        - name: "assess_incident"
          module: "trust-manager"
          action: "assess_security_incident"
          timeout: "300s"
          retry_policy:
            max_attempts: 1
            backoff: "none"
          on_failure: "escalate_to_human"
          
        - name: "contain_threat"
          module: "governance-engine"
          action: "apply_containment_policy"
          timeout: "60s"
          retry_policy:
            max_attempts: 3
            backoff: "fixed"
            delay: "5s"
          on_failure: "emergency_shutdown"
          
        - name: "isolate_affected_systems"
          module: "super-execution-engine"
          action: "isolate_modules"
          parameters:
            modules: "{{ incident.affected_modules }}"
            isolation_level: "quarantine"
          timeout: "120s"
          retry_policy:
            max_attempts: 2
            backoff: "fixed"
            delay: "10s"
          on_failure: "full_isolation"
          
        - name: "create_evidence_snapshot"
          module: "provenance-tracker"
          action: "create_snapshot"
          parameters:
            snapshot_type: "forensic"
            include_memory: true
            include_logs: true
          timeout: "180s"
          retry_policy:
            max_attempts: 3
            backoff: "exponential"
            initial_delay: "10s"
          on_failure: "partial_snapshot"
          
        - name: "notify_stakeholders"
          module: "notification-service"
          action: "send_security_alert"
          parameters:
            recipients: "{{ incident.stakeholders }}"
            severity: "{{ incident.severity }}"
            details: "{{ incident.summary }}"
          timeout: "60s"
          retry_policy:
            max_attempts: 3
            backoff: "exponential"
            initial_delay: "5s"
          on_failure: "emergency_broadcast"
          
      success_actions:
        - type: "update_incident_status"
          status: "contained"
        - type: "schedule_followup"
          interval: "1h"
          
      failure_actions:
        - type: "emergency_shutdown"
          scope: "affected_modules"
        - type: "escalate_to_executive"
        - type: "activate_disaster_recovery"

    - name: "configuration-update-flow"
      description: "Configuration change deployment workflow"
      version: "1.0.0"
      enabled: true
      criticality: "high"
      triggers:
        - type: "configuration_change"
          condition: "config.change_approved = true AND config.environment in ['staging', 'production']"
        - type: "scheduled"
          condition: "schedule.maintenance_window = true AND schedule.config_pending = true"
      steps:
        - name: "validate_configuration"
          module: "config-manager"
          action: "validate_configuration_change"
          parameters:
            config_file: "{{ change.config_file }}"
            schema_file: "{{ change.schema_file }}"
          timeout: "120s"
          retry_policy:
            max_attempts: 3
            backoff: "exponential"
            initial_delay: "5s"
          on_failure: "reject_change"
          
        - name: "backup_current_config"
          module: "storage-backend"
          action: "create_backup"
          parameters:
            source: "/etc/machinenativenops/config"
            destination: "{{ backup.destination }}"
            compression: true
          timeout: "300s"
          retry_policy:
            max_attempts: 2
            backoff: "fixed"
            delay: "15s"
          on_failure: "abort_change"
          
        - name: "apply_configuration"
          module: "config-manager"
          action: "apply_configuration_change"
          parameters:
            config_file: "{{ change.config_file }}"
            rollout_strategy: "canary"
            canary_percentage: 10
          timeout: "600s"
          retry_policy:
            max_attempts: 1
            backoff: "none"
          on_failure: "rollback_to_backup"
          
        - name: "validate_deployment"
          module: "integrity-validator"
          action: "validate_configuration_deployment"
          parameters:
            validation_level: "comprehensive"
            health_check_timeout: "300s"
          timeout: "600s"
          retry_policy:
            max_attempts: 3
            backoff: "exponential"
            initial_delay: "30s"
          on_failure: "rollback_and_investigate"
          
        - name: "update_provenance"
          module: "provenance-tracker"
          action: "record_configuration_change"
          parameters:
            change_id: "{{ change.id }}"
            approver: "{{ change.approver }}"
            timestamp: "{{ change.timestamp }}"
            rollback_available: true
          timeout: "60s"
          retry_policy:
            max_attempts: 2
            backoff: "fixed"
            delay: "5s"
          on_failure: "async_update"
          
      success_actions:
        - type: "notification"
          target: "change.requester"
          message: "Configuration update completed successfully"
        - type: "update_change_status"
          status: "completed"
          
      failure_actions:
        - type: "notification"
          target: "change.requester"
          message: "Configuration update failed - rollback initiated"
          priority: "high"
        - type: "update_change_status"
          status: "failed"

  # === 觸發器定義 ===
  triggers:
    - name: "system_startup"
      type: "event"
      description: "Triggered when system starts up"
      event_source: "system_monitor"
      event_type: "system.start"
      filters:
        - "system.state = 'starting'"
        - "system.environment != 'test'"
        
    - name: "security_event"
      type: "event"
      description: "Triggered by security events"
      event_source: "security_monitor"
      event_type: "security.incident"
      filters:
        - "security.severity in ['medium', 'high', 'critical']"
        - "security.verified = true"
        
    - name: "configuration_change"
      type: "event"
      description: "Triggered by approved configuration changes"
      event_source: "config_manager"
      event_type: "config.change_approved"
      filters:
        - "config.environment in ['staging', 'production']"
        - "config.risk_level in ['low', 'medium']"
        
    - name: "scheduled"
      type: "time"
      description: "Time-based triggers"
      schedule_format: "cron"
      examples:
        - "0 2 * * *"  # Daily at 2 AM
        - "0 0 * * 0"  # Weekly on Sunday
        - "0 0 1 * *"  # Monthly on 1st

  # === 故障處理器 ===
  fallback_handlers:
    - name: "emergency_shutdown"
      description: "Emergency system shutdown"
      module: "super-execution-engine"
      action: "emergency_shutdown"
      parameters:
        shutdown_timeout: "30s"
        preserve_critical_data: true
        notify_administrators: true
      conditions:
        - "system.critical_failure = true"
        - "safety.threat_detected = true"
        
    - name: "rollback_to_backup"
      description: "Rollback to last known good configuration"
      module: "config-manager"
      action: "rollback_configuration"
      parameters:
        backup_source: "last_known_good"
        validate_after_rollback: true
        notify_on_failure: true
      conditions:
        - "config.deployment_failed = true"
        - "backup.available = true"
        
    - name: "isolate_affected_systems"
      description: "Isolate affected modules to prevent spread"
      module: "super-execution-engine"
      action: "isolate_modules"
      parameters:
        isolation_mode: "quarantine"
        preserve_state: true
        allow_monitoring: true
      conditions:
        - "security.breach_detected = true"
        - "system.stability_compromised = true"
        
    - name: "activate_disaster_recovery"
      description: "Activate disaster recovery procedures"
      module: "disaster-recovery"
      action: "activate_recovery_plan"
      parameters:
        recovery_type: "full"
        prioritize_critical_services: true
        estimated_recovery_time: "4h"
      conditions:
        - "system.catastrophic_failure = true"
        - "multiple_critical_modules_failed = true"

  # === 執行策略 ===
  execution_strategies:
    - name: "sequential_execution"
      description: "Execute steps one after another"
      parallelism: 1
      failure_strategy: "stop_on_first_failure"
      timeout_strategy: "per_step_timeout"
      
    - name: "parallel_execution"
      description: "Execute steps in parallel where possible"
      parallelism: "unlimited"
      failure_strategy: "continue_on_failure"
      timeout_strategy: "overall_timeout"
      dependencies: "respect_step_dependencies"
      
    - name: "pipeline_execution"
      description: "Execute as a pipeline with stages"
      parallelism: "per_stage"
      failure_strategy: "stop_stage_on_failure"
      timeout_strategy: "stage_timeout"
      stage_gates: true

  # === 資源管理 ===
  resource_management:
    cpu_limits:
      default: "1000m"
      critical_flows: "2000m"
      background_flows: "200m"
    memory_limits:
      default: "1Gi"
      critical_flows: "2Gi"
      background_flows: "256Mi"
    concurrency_limits:
      total_concurrent_flows: 50
      critical_concurrent_flows: 5
      user_concurrent_flows: 3
    queue_management:
      max_queue_size: 1000
      queue_timeout: "1h"
      priority_levels: ["critical", "high", "medium", "low"]

  # === 監控與可觀測性 ===
  observability:
    metrics:
      - name: "flow_execution_duration"
        type: "histogram"
        description: "Time taken to execute flows"
        labels: ["flow_name", "status"]
      - name: "flow_success_rate"
        type: "gauge"
        description: "Success rate of flow executions"
        labels: ["flow_name"]
      - name: "active_flows_count"
        type: "gauge"
        description: "Number of currently active flows"
      - name: "flow_queue_size"
        type: "gauge"
        description: "Number of flows waiting in queue"
        
    tracing:
      enabled: true
      sampling_rate: 0.1
      span_attributes:
        - "flow.name"
        - "flow.version"
        - "flow.step"
        - "flow.status"
        - "flow.trigger"
        
    logging:
      level: "INFO"
      structured_logging: true
      log_fields:
        - "flow_id"
        - "flow_name"
        - "step_name"
        - "execution_id"
        - "user_id"
        - "status"
        - "duration"
        - "error_message"

status:
  phase: "Active"
  conditions:
    - type: "ExecutionFlowsConfigured"
      status: "True"
      lastTransitionTime: "2025-12-20T22:00:00Z"
      reason: "FlowsConfigured"
      message: "All execution flows configured successfully"
    - type: "TriggersEnabled"
      status: "True"
      lastTransitionTime: "2025-12-20T22:00:00Z"
      reason: "TriggersActive"
      message: "All triggers are enabled and monitoring"
    - type: "FallbackHandlersReady"
      status: "True"
      lastTransitionTime: "2025-12-20T22:00:00Z"
      reason: "HandlersConfigured"
      message: "Fallback handlers configured and ready"

---
# Super Execution Schema 定義
apiVersion: v1
kind: ConfigMap
metadata:
  name: super-execution-schema
  namespace: machinenativenops-execution
data:
  schema.yaml: |
    # Root Super Execution Configuration Schema
    type: object
    properties:
      execution_flows:
        type: array
        items:
          type: object
          properties:
            name:
              type: string
            description:
              type: string
            version:
              type: string
            enabled:
              type: boolean
            criticality:
              type: string
              enum: ["critical", "high", "medium", "low"]
            triggers:
              type: array
            steps:
              type: array
            success_actions:
              type: array
            failure_actions:
              type: array
          required: ["name", "description", "version", "enabled", "criticality", "triggers", "steps"]
      triggers:
        type: array
        items:
          type: object
          properties:
            name:
              type: string
            type:
              type: string
              enum: ["event", "time", "manual"]
            description:
              type: string
          required: ["name", "type", "description"]
      fallback_handlers:
        type: array
        items:
          type: object
          properties:
            name:
              type: string
            description:
              type: string
            module:
              type: string
            action:
              type: string
            parameters:
              type: object
            conditions:
              type: array
          required: ["name", "description", "module", "action", "conditions"]
    required: ["execution_flows", "triggers", "fallback_handlers"]